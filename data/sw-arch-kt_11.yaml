- en: '11'
  id: totrans-0
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: '11'
- en: Auditing and Monitoring Models
  id: totrans-1
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 审计和监控模型
- en: This chapter is dedicated to covering the auditing and monitoring aspects of
    software systems. Implementing a robust auditing and monitoring strategy is key
    for an organization to improve the overall reliability, security, and performance
    of its systems while also gaining valuable insights to support data-driven decision-making
    and continuous improvement.
  id: totrans-2
  prefs: []
  type: TYPE_NORMAL
  zh: 本章致力于涵盖软件系统的审计和监控方面。实施强大的审计和监控策略对于组织提高其系统的整体可靠性、安全性和性能至关重要，同时还能获得有价值的见解，以支持数据驱动的决策和持续改进。
- en: This is particularly crucial for distributed systems, where the increased complexity
    and inter-dependencies introduce additional challenges compared to traditional
    monolithic applications.
  id: totrans-3
  prefs: []
  type: TYPE_NORMAL
  zh: 这对于分布式系统尤为重要，因为与传统的单体应用相比，分布式系统的增加复杂性和相互依赖性引入了额外的挑战。
- en: 'In this chapter, we’ll explore the following topics:'
  id: totrans-4
  prefs: []
  type: TYPE_NORMAL
  zh: 本章将探讨以下主题：
- en: The importance of auditing and monitoring
  id: totrans-5
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 审计和监控的重要性
- en: The challenges of distributed system auditing and monitoring
  id: totrans-6
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 分布式系统审计和监控的挑战
- en: Key aspects of auditing and monitoring
  id: totrans-7
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 审计和监控的关键方面
- en: Basic elements of meaningful audit trails
  id: totrans-8
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 有意义审计跟踪的基本要素
- en: By the end of this chapter, you’ll have a solid understanding of how to establish
    robust auditing and monitoring capabilities for your systems, enabling you to
    proactively identify and resolve issues, ensure compliance, and maintain overall
    system health.
  id: totrans-9
  prefs: []
  type: TYPE_NORMAL
  zh: 到本章结束时，你将牢固地理解如何为你的系统建立强大的审计和监控能力，使你能够主动识别和解决问题，确保合规性，并维护整体系统健康。
- en: Technical requirements
  id: totrans-10
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 技术要求
- en: 'You can find the code files used in this chapter on GitHub: [https://github.com/Packt
    Publishing/Software-Architecture-with-Kotlin/tree/main/chapter-11](https://github.com/PacktPublishing/Software-Architecture-with-Kotlin/tree/main/chapter-11%0D)'
  id: totrans-11
  prefs: []
  type: TYPE_NORMAL
  zh: 你可以在GitHub上找到本章使用的代码文件：[https://github.com/Packt Publishing/Software-Architecture-with-Kotlin/tree/main/chapter-11](https://github.com/PacktPublishing/Software-Architecture-with-Kotlin/tree/main/chapter-11%0D)
- en: The importance of auditing and monitoring
  id: totrans-12
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 审计和监控的重要性
- en: Auditing and monitoring are two distinct but closely related concepts that are
    critical for the effective management and oversight of a system.
  id: totrans-13
  prefs: []
  type: TYPE_NORMAL
  zh: 审计和监控是两个不同但又紧密相关的概念，对于系统的有效管理和监督至关重要。
- en: Auditing
  id: totrans-14
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 审计
- en: '**Auditing** is the systematic approach of reviewing, examining, and verifying
    the various aspects of a system to ensure its compliance, security, and overall
    integrity. Auditing covers the following key areas:'
  id: totrans-15
  prefs: []
  type: TYPE_NORMAL
  zh: '**审计**是一种系统性的方法，用于审查、检查和验证系统的各个方面，以确保其合规性、安全性和整体完整性。审计涵盖以下关键领域：'
- en: '**Compliance**: Inspecting the system’s conformity to relevant laws, regulations
    from authority, industry standards, and company policies.'
  id: totrans-16
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '**合规性**：检查系统是否符合相关法律、权威机构的规定、行业标准和企业政策。'
- en: '**Security**: Assessing the system’s security infrastructure, policies, and
    procedures. This includes vulnerability assessments, penetration testing, data
    protection mechanisms, and access controls.'
  id: totrans-17
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '**安全**：评估系统的安全基础设施、政策和程序。这包括漏洞评估、渗透测试、数据保护机制和访问控制。'
- en: '**Change management**: Reviewing the processes and documentation associated
    with system changes and updates.'
  id: totrans-18
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '**变更管理**：审查与系统更改和更新相关的流程和文档。'
- en: '**Incident management**: Examining the effectiveness of responses to the system
    incident and disaster recovery procedures.'
  id: totrans-19
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '**事件管理**：检查对系统事件和灾难恢复程序的响应的有效性。'
- en: '**Performance**: Evaluating the efficiency of the system’s operations, resource
    utilization, and overall performance.'
  id: totrans-20
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '**性能**：评估系统操作的效率、资源利用和整体性能。'
- en: The auditing process typically involves collecting and analyzing various system
    logs, configuration files, user activities, documentation, and other relevant
    data to identify potential issues, vulnerabilities, and areas for improvement.
  id: totrans-21
  prefs: []
  type: TYPE_NORMAL
  zh: 审计过程通常涉及收集和分析各种系统日志、配置文件、用户活动、文档和其他相关数据，以识别潜在问题、漏洞和改进领域。
- en: The auditing process is typically done at regular intervals. It’s common for
    organizations to have quarterly, semi-quarterly, and annual audits. The cadence
    is usually determined by factors such as the regulatory requirements, the system’s
    complexity, criticality, risk profile, and the organization’s overall risk management
    strategy.
  id: totrans-22
  prefs: []
  type: TYPE_NORMAL
  zh: 审计过程通常定期进行。组织通常会有季度、半年和年度审计。周期通常由监管要求、系统的复杂性、关键性、风险概况以及组织的整体风险管理策略等因素决定。
- en: A system of higher risk would suggest a more frequent auditing cadence, and
    some organizations may even exercise a continuous auditing process.
  id: totrans-23
  prefs: []
  type: TYPE_NORMAL
  zh: 高风险系统可能需要更频繁的审计周期，某些组织甚至可能实施持续的审计过程。
- en: An ad hoc auditing process may be required in the face of certain events, such
    as a significant system change, security incident, major industry change, or regulatory
    update.
  id: totrans-24
  prefs: []
  type: TYPE_NORMAL
  zh: 在面对某些事件时，例如重大的系统变更、安全事件、主要行业变化或监管更新，可能需要临时审计过程。
- en: Monitoring
  id: totrans-25
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 监控
- en: '**Monitoring**, on the other hand, involves continuously observing and tracking
    a system’s operational state, performance, and behaviors. The following are some
    monitoring activities:'
  id: totrans-26
  prefs: []
  type: TYPE_NORMAL
  zh: '**监控**，另一方面，涉及持续观察和跟踪系统的运行状态、性能和行为。以下是一些监控活动：'
- en: '**Real-time monitoring**: Continuously collecting and analyzing system metrics,
    such as system availability, resource utilization, network traffic, and error
    rates, to detect and respond to issues promptly'
  id: totrans-27
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '**实时监控**：持续收集和分析系统指标，如系统可用性、资源利用率、网络流量和错误率，以便及时检测和响应问题'
- en: '**Anomaly detection**: Identifying unusual or unexpected system behavior that
    may indicate potential problems or security threats'
  id: totrans-28
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '**异常检测**：识别不寻常或意外的系统行为，这可能会表明潜在的问题或安全威胁'
- en: '**Trend analysis**: Examining historical data to identify patterns, trends,
    and changes in the system’s performance and usage over time'
  id: totrans-29
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '**趋势分析**：通过检查历史数据来识别系统性能和使用的模式、趋势和变化'
- en: '**Alerting and notifications**: Triggering alerts and notifications when predefined
    thresholds or conditions are met, enabling proactive issue resolution'
  id: totrans-30
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '**警报和通知**：当达到预定义的阈值或条件时触发警报和通知，使问题能够得到主动解决'
- en: '**Dashboards and reporting**: Providing visual representations of system health,
    performance, and key metrics to support data-driven decision-making'
  id: totrans-31
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '**仪表板和报告**：提供系统健康、性能和关键指标的可视化表示，以支持数据驱动的决策'
- en: Monitoring typically involves deploying various monitoring middleware components,
    agents, and frameworks that collect, aggregate, and analyze data from different
    components of the system.
  id: totrans-32
  prefs: []
  type: TYPE_NORMAL
  zh: 监控通常涉及部署各种监控中间件组件、代理和框架，它们从系统的不同组件收集、汇总和分析数据。
- en: Why are auditing and monitoring important?
  id: totrans-33
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 为什么审计和监控很重要？
- en: 'Auditing and monitoring are critical for the effective management and operation
    of any system. Here are some of the key reasons why auditing and monitoring are
    so important:'
  id: totrans-34
  prefs: []
  type: TYPE_NORMAL
  zh: 审计和监控对于任何系统的有效管理和运营至关重要。以下是审计和监控之所以如此重要的几个关键原因：
- en: '**Ensuring reliability and availability**: Proactive monitoring helps identify
    and address issues before they escalate into system failures or downtime. Real-time
    alerts and incident management enable rapid response and resolution of problems,
    minimizing the impact on end users. Comprehensive audit trails provide the necessary
    information to troubleshoot the root causes of system failures, improving the
    system’s reliability and availability.'
  id: totrans-35
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '**确保可靠性和可用性**：主动监控有助于在问题升级为系统故障或停机之前识别和解决问题。实时警报和事件管理能够快速响应和解决问题，最小化对最终用户的影响。全面的审计跟踪提供了必要的有关系统故障根本原因的信息，从而提高了系统的可靠性和可用性。'
- en: '**Maintaining security and compliance**: Audit logs and data monitoring can
    be used to detect and investigate security breaches, unauthorized access attempts,
    and other malicious activities. Compliance regulations often mandate the implementation
    of robust audit and monitoring capabilities to ensure the integrity and confidentiality
    of sensitive data and systems. Audit reports and monitoring dashboards can demonstrate
    an organization’s adherence to compliance requirements, reducing the risk of penalties
    and reputational damage.'
  id: totrans-36
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '**维护安全和合规性**：审计日志和数据监控可以用来检测和调查安全漏洞、未经授权的访问尝试和其他恶意活动。合规法规通常要求实施强大的审计和监控能力，以确保敏感数据和系统的完整性和机密性。审计报告和监控仪表板可以证明组织遵守合规要求，降低处罚和声誉损害的风险。'
- en: '**Optimizing performance and efficiency**: Monitoring system metrics and resource
    utilization can help with identifying bottlenecks, optimizing resource allocation,
    and improving overall system performance. Audit data can provide insights into
    usage patterns, workload trends, and areas for potential optimization.'
  id: totrans-37
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '**优化性能和效率**：监控系统指标和资源利用率可以帮助识别瓶颈、优化资源分配并提高整体系统性能。审计数据可以提供对使用模式、工作负载趋势和潜在优化领域的见解。'
- en: '**Enabling data-driven decision-making**: Auditing and monitoring data can
    be leveraged to identify patterns and generate valuable business intelligence,
    supporting strategic planning and decision-making. Detailed reports and visualizations
    can provide stakeholders with a comprehensive understanding of the system’s health,
    performance, and overall status. Historical data and trend analysis can help with
    predicting future resource requirements, planning for capacity expansions, and
    identifying opportunities for process improvements.'
  id: totrans-38
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '**启用数据驱动决策**：审计和监控数据可以用来识别模式并生成有价值的商业智能，支持战略规划和决策。详细的报告和可视化可以给利益相关者提供一个对系统健康状况、性能和整体状况的全面理解。历史数据和趋势分析有助于预测未来的资源需求，规划容量扩展，并识别流程改进的机会。'
- en: '**Facilitating troubleshooting and root cause analysis**: Comprehensive audit
    trails and monitoring data can help engineers and support teams quickly identify
    the root causes of problems, reducing the time required for issue resolution.
    Detailed event logs and contextual information can aid in reconstructing system
    behaviors and recreating problematic scenarios. Auditing and monitoring data can
    be used to validate the effectiveness of implemented fixes and ensure that issues
    don’t recur.'
  id: totrans-39
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '**促进故障排除和根本原因分析**：全面的审计轨迹和监控数据可以帮助工程师和支持团队快速识别问题的根本原因，减少问题解决所需的时间。详细的事件日志和上下文信息有助于重建系统行为和重现问题场景。审计和监控数据可以用来验证实施的修复措施的有效性，并确保问题不会再次发生。'
- en: By investing in robust audit and monitoring capabilities, organizations can
    ensure the reliability, security, and optimization of their distributed systems,
    ultimately delivering better experiences for their end users and stakeholders.
  id: totrans-40
  prefs: []
  type: TYPE_NORMAL
  zh: 通过投资于强大的审计和监控能力，组织可以确保其分布式系统的可靠性、安全性和优化，最终为最终用户和利益相关者提供更好的体验。
- en: Auditing, monitoring, and measuring systems
  id: totrans-41
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 审计、监控和测量系统
- en: “*You can’t improve what you don’t measure*” is a statement from the management
    consultant and writer *Peter Drucker*.
  id: totrans-42
  prefs: []
  type: TYPE_NORMAL
  zh: “*你不能改进你没有测量的东西*”是管理顾问和作家**彼得·德鲁克**的一句话。
- en: 'Without measurement, the organization could fall into the following scenarios:'
  id: totrans-43
  prefs: []
  type: TYPE_NORMAL
  zh: 没有测量，组织可能会陷入以下情况：
- en: '**Opinion-based decision-making**: Without quantitative evidence, people can
    only express opinions they have little ground to base on. This leads to ineffective
    communication among stakeholders and engineers and a fragmented understanding
    of the problem.'
  id: totrans-44
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '**基于意见的决策制定**：没有定量证据，人们只能表达基于很少依据的意见。这会导致利益相关者和工程师之间沟通无效，以及对问题的理解碎片化。'
- en: '**Hit-and-miss improvement**: Any attempt to improve the system features or
    quality attributes becomes hit and miss. Some of them may work, and some of them
    may not, due to the lack of understanding of the problem. Even worse, there is
    little way to objectively reflect the effect of the improvement. The organization
    would then carry on the opinion-based decision-making in a vicious cycle.'
  id: totrans-45
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '**试错改进**：任何试图改进系统功能或质量属性的努力都可能成为试错。由于对问题的理解不足，其中一些可能有效，而另一些可能无效。更糟糕的是，几乎没有客观反映改进效果的方法。因此，组织可能会陷入基于意见的决策的恶性循环。'
- en: 'On the contrary, measuring the system via monitoring benefits the organization
    in the following ways:'
  id: totrans-46
  prefs: []
  type: TYPE_NORMAL
  zh: 相反，通过监控来衡量系统对组织有以下好处：
- en: '**Establishing baselines**: Measuring the current state of a system, whether
    it’s performance metrics, security integrity, or compliance conformity, provides
    the necessary baseline against which future improvements can be assessed and compared.'
  id: totrans-47
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '**建立基线**：衡量系统的当前状态，无论是性能指标、安全完整性还是合规性，为未来改进提供了必要的基线，以便评估和比较未来的改进。'
- en: '**Identifying opportunities**: Measurement and monitoring data can uncover
    problems, bottlenecks, or inefficiencies within a system that may not be apparent
    without quantifiable evidence.'
  id: totrans-48
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '**识别机会**：测量和监控数据可以揭示系统内部可能没有量化证据就难以显现的问题、瓶颈或低效。'
- en: '**Tracking progress**: Once improvements or changes are implemented, continuous
    measurement and monitoring allow organizations to track the impact and effectiveness
    of those changes, ensuring that they make a positive impact and that desired outcomes
    are being achieved. If not, the organizations can decide to pivot from the original
    changes to avoid further deterioration.'
  id: totrans-49
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '**跟踪进度**：一旦实施改进或变更，持续的测量和监控使组织能够跟踪这些变更的影响和有效性，确保它们产生积极影响，并实现预期结果。如果没有，组织可以决定从原始变更中转向，以避免进一步恶化。'
- en: '**Informed decision-making**: Reliable data and metrics enable data-driven
    decision-making, allowing organizations to prioritize and allocate resources more
    effectively toward the areas that will yield the greatest improvements. This is
    also an antidote to opinion-based decision-making. Quantitative evidence is one
    of the best ways to align people’s understanding and to effectively drive consensus
    on the improvement required.'
  id: totrans-50
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '**基于信息的决策**：可靠的数据和指标能够支持数据驱动的决策，使组织能够更有效地优先排序和分配资源，以实现最大的改进。这也有助于对抗基于意见的决策。定量证据是使人们理解一致并有效推动对所需改进达成共识的最好方式之一。'
- en: '**Continuous optimization**: By establishing a culture of measurement and monitoring,
    organizations can continuously identify new opportunities for improvement, creating
    a cycle of ongoing optimization and refinement.'
  id: totrans-51
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '**持续优化**：通过建立一个测量和监控的文化，组织可以持续识别新的改进机会，创造一个持续优化和精炼的循环。'
- en: When are auditing and monitoring not necessary?
  id: totrans-52
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 何时审计和监控不是必需的？
- en: There are a few exceptions where auditing and monitoring may not be necessary.
  id: totrans-53
  prefs: []
  type: TYPE_NORMAL
  zh: 有一些例外情况，在这些情况下，审计和监控可能不是必需的。
- en: If the system is extremely simple, with very few components and minimal dependencies,
    the need for comprehensive audit and monitoring may be reduced.
  id: totrans-54
  prefs: []
  type: TYPE_NORMAL
  zh: 如果系统极其简单，组件非常少，依赖性最小，那么对全面审计和监控的需求可能会减少。
- en: In experimental, low fidelity, or proof-of-concept systems, where the primary
    focus is on validating a specific concept, hypothesis, or functionality, the investment
    in audit and monitoring may not be a top priority. However, if the system turns
    out to be a viable ongoing business later, it’s worth investing more in auditing
    and monitoring.
  id: totrans-55
  prefs: []
  type: TYPE_NORMAL
  zh: 在实验性、低保真度或概念验证系统中，当主要关注验证特定概念、假设或功能时，对审计和监控的投资可能不是首要任务。然而，如果该系统后来证明是一个可行的持续业务，那么在审计和监控上投入更多是值得的。
- en: Systems that are used for testing, personal experimentation, or other low-impact
    use cases may not warrant the same level of auditing and monitoring as mission-critical
    production systems.
  id: totrans-56
  prefs: []
  type: TYPE_NORMAL
  zh: 用于测试、个人实验或其他低影响用例的系统可能不需要与关键任务生产系统相同级别的审计和监控。
- en: Note that some systems or organizations may not be subject to strict regulatory
    or compliance requirements that mandate comprehensive audit and monitoring capabilities.
  id: totrans-57
  prefs: []
  type: TYPE_NORMAL
  zh: 注意，某些系统或组织可能不受严格的监管或合规要求约束，这些要求强制实施全面的审计和监控功能。
- en: Also, some systems are isolated and even disconnected from the internet. If
    they have strict control access, it may be less critical to have extensive audits
    and monitoring.
  id: totrans-58
  prefs: []
  type: TYPE_NORMAL
  zh: 此外，一些系统是隔离的，甚至与互联网断开连接。如果它们有严格的安全控制，那么广泛的审计和监控可能就不那么关键了。
- en: If the system is designed to be temporary or short-lived, with a well-defined
    lifespan, the investment in comprehensive audit and monitoring may not be justified.
    This applies to one-off data processing tasks or systems with a predetermined
    sunset date.
  id: totrans-59
  prefs: []
  type: TYPE_NORMAL
  zh: 如果系统设计为临时或短期使用，具有明确的生命周期，那么在全面的审计和监控上的投资可能是不合理的。这适用于一次性数据处理任务或具有预定停用日期的系统。
- en: The combination of auditing and monitoring provides a comprehensive approach
    to managing the integrity, security, and performance of a system, especially in
    complex distributed environments. Audit findings can help inform and enhance monitoring
    strategies while monitoring data can provide valuable inputs for the audit process.
    It’s most beneficial if auditing and monitoring go hand in hand for any organization.
  id: totrans-60
  prefs: []
  type: TYPE_NORMAL
  zh: 审计和监控的结合为管理系统的完整性、安全性和性能提供了一个全面的方法，尤其是在复杂的分布式环境中。审计发现可以帮助指导和增强监控策略，而监控数据可以为审计过程提供宝贵的输入。对于任何组织来说，审计和监控相辅相成是最有益的。
- en: Implementing auditing and monitoring isn’t trivial in modern systems, where
    they’re usually distributed to multiple components. We’re going to discover these
    challenges in the next section.
  id: totrans-61
  prefs: []
  type: TYPE_NORMAL
  zh: 在现代系统中实施审计和监控并不简单，因为它们通常被分布到多个组件中。我们将在下一节中探讨这些挑战。
- en: The challenges of distributed system auditing and monitoring
  id: totrans-62
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 分布式系统审计和监控的挑战
- en: 'Distributed systems pose several unique challenges that make their auditing
    and monitoring more complex than traditional monolithic architectures:'
  id: totrans-63
  prefs: []
  type: TYPE_NORMAL
  zh: 分布式系统提出了几个独特的挑战，使得它们的审计和监控比传统的单体架构更为复杂：
- en: '**Distributed data sources**: In a distributed system, the relevant data and
    logs are scattered across multiple nodes, services, and communication channels.
    Collecting, aggregating, and correlating this information is a crucial but challenging
    task.'
  id: totrans-64
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '**分布式数据源**：在分布式系统中，相关的数据和日志分散在多个节点、服务和通信渠道中。收集、汇总和关联这些信息是一项关键但具有挑战性的任务。'
- en: '**Dynamic infrastructure**: Distributed systems often involve highly dynamic
    infrastructure, with nodes and services being added, removed, or scaled on demand.
    Keeping track of the constantly evolving topology and resource utilization is
    essential for effective monitoring.'
  id: totrans-65
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '**动态基础设施**：分布式系统通常涉及高度动态的基础设施，节点和服务可以根据需求添加、删除或扩展。跟踪不断演变的拓扑结构和资源利用率对于有效的监控至关重要。'
- en: '**Interdependencies and cascading failures**: The intricate interdependencies
    between components in a distributed system can lead to cascading failures, where
    a failure in one part of the system triggers issues in other areas. Identifying
    and tracing these complex relationships is crucial for root cause analysis and
    recovery.'
  id: totrans-66
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '**相互依赖和级联故障**：分布式系统中组件之间的复杂相互依赖可能导致级联故障，即系统某一部分的故障会触发其他区域的故障。识别和追踪这些复杂关系对于根本原因分析和恢复至关重要。'
- en: '**A mixture of various technologies**: Distributed systems often incorporate
    a diverse set of technologies, including various programming languages, data stores,
    and middleware components. Developing a unified approach to auditing and monitoring
    that can handle this heterogeneity is a significant challenge.'
  id: totrans-67
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '**各种技术的混合**：分布式系统通常包含各种技术，包括各种编程语言、数据存储和中间件组件。开发一种可以处理这种异质性的统一审计和监控方法是一个重大挑战。'
- en: '**Real-time responsiveness**: Distributed systems are often expected to provide
    real-time responsiveness, requiring auditing and monitoring solutions to process
    and analyze data at high speeds without introducing significant latency or performance
    overhead.'
  id: totrans-68
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '**实时响应性**：分布式系统通常需要提供实时响应，这要求审计和监控解决方案能够以高速处理和分析数据，同时不引入显著的延迟或性能开销。'
- en: '**Compliance and regulatory requirements**: Many industries and organizations
    have strict compliance regulations that mandate comprehensive audit trails and
    monitoring capabilities. Ensuring that the distributed system meets these requirements
    is a critical responsibility.'
  id: totrans-69
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '**合规性和监管要求**：许多行业和组织都有严格的合规性规定，要求有全面的审计轨迹和监控能力。确保分布式系统满足这些要求是一项关键责任。'
- en: To overcome these challenges, we’ll explore the key aspects of auditing and
    monitoring with concrete examples.
  id: totrans-70
  prefs: []
  type: TYPE_NORMAL
  zh: 为了克服这些挑战，我们将通过具体示例探讨审计和监控的关键方面。
- en: Capturing the appropriate data
  id: totrans-71
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 捕获适当的数据
- en: To address these challenges and establish effective auditing and monitoring
    practices for distributed systems, we need to capture the most appropriate, basic
    building blocks.
  id: totrans-72
  prefs: []
  type: TYPE_NORMAL
  zh: 为了解决这些挑战并为分布式系统建立有效的审计和监控实践，我们需要捕获最合适的、基本的构建块。
- en: Audit trails
  id: totrans-73
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 审计跟踪
- en: 'The following are essential fields that are typically captured in audit trails:'
  id: totrans-74
  prefs: []
  type: TYPE_NORMAL
  zh: 以下是在审计跟踪中通常捕获的基本字段：
- en: '**Timestamp**: The date and time when the event occurred. It’s important to
    have a universal time zone for all audit trails. **Coordinated Universal Time**
    (**UTC**) is a sensible choice as it’s atomic and doesn’t tie to any time zone.
    There’s no daylight saving or clock change complication. It can easily be converted
    into any local time zone. It’s also a global standard for timekeeping. This is
    valuable information for correlating different actions that happened around the
    same time to reflect a pattern.'
  id: totrans-75
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '**时间戳**：事件发生时的日期和时间。对于所有审计跟踪来说，拥有一个通用时区非常重要。**协调世界时**（**UTC**）是一个明智的选择，因为它是一致的，不依赖于任何时区。没有夏令时或时钟变化的复杂性。它可以轻松转换为任何本地时区。它也是全球时间标准。这对于关联在相同时间发生的不同操作以反映模式非常有价值。'
- en: '**User IDs**: The identifier of the user who performed or was affected by the
    action. The user’s identity must be tokenized and not contain any PII. This is
    often regulated by local laws and regulations, particularly on data protection
    and privacy. Therefore, using a tokenized user ID reduces most of the legal hassle
    of exposing user details. Accessing user information by user ID is restricted
    to only authorized individuals and local authorities.'
  id: totrans-76
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '**用户ID**：执行或受该操作影响用户的标识符。用户的身份必须被标记化，且不得包含任何PII（个人身份信息）。这通常受到当地法律和法规的规范，尤其是在数据保护和隐私方面。因此，使用标记化用户ID可以减少暴露用户详细信息的大部分法律麻烦。通过用户ID访问用户信息仅限于授权个人和当地当局。'
- en: '**Event or action type**: The type of event or action that’s been performed
    (for example, login, logout, data access, or data modification).'
  id: totrans-77
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '**事件或操作类型**：已执行的事件或操作类型（例如，登录、注销、数据访问或数据修改）。'
- en: '**Details of the action performed**: The specific details of the action, which
    are usually the input parameters for the action. Different actions usually have
    different structures of data. Please note that the details may contain sensitive
    information that needs to be protected. The protection techniques for sensitive
    information will be covered in [*Chapter 14*](B21737_14.xhtml#_idTextAnchor442).'
  id: totrans-78
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '**执行操作的详细信息**：操作的特定细节，通常是操作的输入参数。不同的操作通常具有不同的数据结构。请注意，细节可能包含需要保护敏感信息。敏感信息的保护技术将在[*第14章*](B21737_14.xhtml#_idTextAnchor442)中介绍。'
- en: '**Resource accessed**: The resource involved in the action that’s been performed.
    It’s typically linked to an aggregate, an entity, or a value object. Often, it
    involves multiple of them.'
  id: totrans-79
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '**访问的资源**：涉及已执行操作的资源。它通常与聚合、实体或值对象相关联。通常涉及多个对象。'
- en: '**Outcome**: The result or consequence of the action. It’s worth noting that
    success and failure outcomes are equally important in terms of capturing audit
    trails. For success, it’s essential to capture what will happen next. For failure,
    any error message or invocation stack trace should be included. Also, it’s important
    to capture any side effects so that further investigation can be performed on
    them.'
  id: totrans-80
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '**结果**：操作的结果或后果。值得注意的是，成功和失败的结果在捕获审计跟踪方面同等重要。对于成功，重要的是要捕获接下来会发生什么。对于失败，应包括任何错误消息或调用堆栈跟踪。此外，捕获任何副作用也很重要，以便可以进一步调查它们。'
- en: '**Session ID**: The identifier of the session during which the event occurred.
    Having the session ID helps any correlation investigation figure out what other
    actions may have been performed in the same session.'
  id: totrans-81
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '**会话ID**：发生事件时的会话标识符。拥有会话ID有助于任何关联调查确定在相同会话中可能执行的其他操作。'
- en: '**Application ID**: The identifier of the application where the event occurred.
    This information helps engineers pinpoint where an issue may have occurred so
    that the situation can be improved.'
  id: totrans-82
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '**应用程序ID**：发生事件的程序的标识符。此信息有助于工程师确定问题可能发生的位置，以便改进情况。'
- en: Monitoring data
  id: totrans-83
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 监控数据
- en: 'The data that’s captured for monitoring can look remarkably similar to audit
    trails. However, monitoring has a unique focus on metrics, availability, and the
    non-functional properties of a system. Here are the essential fields:'
  id: totrans-84
  prefs: []
  type: TYPE_NORMAL
  zh: 用于监控捕获的数据可能看起来与审计跟踪非常相似。然而，监控的独特焦点在于指标、可用性和系统的非功能性属性。以下是基本字段：
- en: '**Timestamp**: The date and time of the event. Most of the modern systems use
    UTC over other time zones.'
  id: totrans-85
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '**时间戳**：事件的日期和时间。大多数现代系统使用协调世界时（UTC）而不是其他时区。'
- en: '**System metrics**: CPU usage, memory usage, disk I/O, network traffic, messaging
    infrastructure, databases, and caches.'
  id: totrans-86
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '**系统指标**：CPU 使用率、内存使用率、磁盘 I/O、网络流量、消息基础设施、数据库和缓存。'
- en: '**Application metrics**: The number of API calls, background job executions,
    response times, request rates, and error rates.'
  id: totrans-87
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '**应用程序指标**：API 调用次数、后台作业执行次数、响应时间、请求速率和错误率。'
- en: '**Service health**: Status of services (for example, up, down, or degraded).'
  id: totrans-88
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '**服务健康**：服务状态（例如，运行中、已关闭或降级）。'
- en: '**Performance metrics**: The latency and throughput of operations.'
  id: totrans-89
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '**性能指标**：操作的延迟和吞吐量。'
- en: '**Logs**: Application logs and system logs.'
  id: totrans-90
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '**日志**：应用程序日志和系统日志。'
- en: '**Alerts**: Notifications under predefined criteria.'
  id: totrans-91
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '**警报**：符合预定义标准的通知。'
- en: '**User activities or business metrics**: General user activity patterns, not
    specific actions. This usually covers business-related patterns, such as “how
    many new users have signed up in the last 2 hours” or “how many transactions were
    created in the last 30 minutes.”'
  id: totrans-92
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '**用户活动或业务指标**：一般用户活动模式，而不是具体动作。这通常涵盖与业务相关的模式，例如“在过去 2 小时内有多少新用户注册”或“在过去 30
    分钟内创建了多少交易。”'
- en: Application log messages
  id: totrans-93
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 应用程序日志消息
- en: Application-level log messages are generated by code written by engineers with
    the aid of logging frameworks. Therefore, the quality of the log messages depends
    on engineers.
  id: totrans-94
  prefs: []
  type: TYPE_NORMAL
  zh: 应用程序级别的日志消息是由工程师编写并使用日志框架辅助生成的代码生成的。因此，日志消息的质量取决于工程师。
- en: Each organization should define its conventions and best practices for logging
    messages. Several aspects need standardization.
  id: totrans-95
  prefs: []
  type: TYPE_NORMAL
  zh: 每个组织都应该为其日志消息定义其惯例和最佳实践。有几个方面需要标准化。
- en: Logging levels
  id: totrans-96
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: 日志级别
- en: 'Organizing logging messages by hierarchical levels provides perspectives of
    the system at multiple levels of abstraction. It’s like a map of the system that
    can be zoomed in and out. Additionally, it defines the level of responses required
    for what happens in the system. Typically, there are six levels:'
  id: totrans-97
  prefs: []
  type: TYPE_NORMAL
  zh: 通过分层级别组织日志消息提供了系统在多个抽象层次上的视角。它就像一个可以放大和缩小的系统地图。此外，它还定义了系统发生事件所需的响应级别。通常，有六个级别：
- en: '**TRACE**: The most detailed and fine-grained level of information. The message
    is very verbose and full of technical data that can be referenced to the source
    code. TRACE logging is usually only turned on in local development environments
    and exceptionally for troubleshooting critical problems in higher environments'
  id: totrans-98
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: '**TRACE**：信息最详细和粒度最细的级别。消息非常冗长，充满了可以参考源代码的技术数据。TRACE 日志通常仅在本地开发环境中开启，或者在更高环境中解决关键问题时例外。'
- en: '**DEBUG**: Less verbose than the trace level, the DEBUG log message provides
    information that may be needed for diagnosing and troubleshooting issues. The
    debug level is usually switched off in production environments but switched on
    in lower environments for testing purposes.'
  id: totrans-99
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: '**DEBUG**：比 trace 级别更简洁，DEBUG 日志消息提供可能需要用于诊断和解决问题的信息。DEBUG 级别通常在生产环境中关闭，但在较低环境中开启以进行测试目的。'
- en: '**INFO**: A standard-level log message that announces the change in application
    state or that something has happened. In the context of the real-life example
    we previously used for villagers, an info log message could be an announcement
    of a new household record being created, together with some essential information
    such as household name. INFO log messages intend to capture only the result of
    successful cases, and they require no corrective action. This is also the lowest
    level of log messages to be shown in a production environment.'
  id: totrans-100
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: '**INFO**：标准级别的日志消息，宣布应用程序状态的变化或发生了某事。在之前用于村民的实际情况中，INFO 日志消息可能是一个新家庭记录创建的公告，以及一些基本信息，如家庭名称。INFO
    日志消息旨在仅捕获成功案例的结果，并且不需要采取纠正措施。这也是在生产环境中显示的最低级别的日志消息。'
- en: '**WARN**: An unexpected situation has happened in the application. There may
    be a problem within this instance in the process, but the application can continue
    to work. For example, there may be a request to delete a household that didn’t
    exist. It could indicate a data-consistent issue for that household record, but
    the application can carry on handling other requests. A WARN log message may require
    investigation by engineers, but not as an emergency.'
  id: totrans-101
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: '**WARN**：应用程序中发生了意外情况。在此实例的流程中可能存在问题，但应用程序可以继续工作。例如，可能有一个请求删除不存在的家庭。这可能表明该家庭记录存在数据一致性问题的迹象，但应用程序可以继续处理其他请求。WARN日志消息可能需要工程师进行调查，但不是紧急情况。'
- en: '**ERROR**: One or more functionalities can’t be completed. This isn’t a single
    instance of a failure but a consistent failure of a part of the system. The system
    has degraded, and corrective actions may be required to recover the failed functionality.'
  id: totrans-102
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: '**ERROR**：一个或多个功能无法完成。这不是失败的单一实例，而是系统一部分的持续失败。系统已经降级，可能需要采取纠正措施来恢复失败的功能。'
- en: '**FATAL**: A fundamental error in the crucial functionality no longer works.
    An example would be losing connection to a database so that none of the persistence
    functions can be completed. An urgent corrective action or even manual intervention
    is required to recover the situation.'
  id: totrans-103
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: '**FATAL**：关键功能中的基本错误不再工作。一个例子是失去与数据库的连接，以至于无法完成任何持久性功能。需要采取紧急纠正措施甚至人工干预来恢复情况。'
- en: Log message formats
  id: totrans-104
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: 日志消息格式
- en: Having a consistent format in log messages helps engineers to quickly triage
    and identify issues. A good log message should contain a timestamp, the name of
    the logger, the log level, the thread name, the class name where the message was
    logged, and the message itself.
  id: totrans-105
  prefs: []
  type: TYPE_NORMAL
  zh: 在日志消息中保持一致的格式有助于工程师快速分类和识别问题。一个好的日志消息应包含时间戳、记录器的名称、日志级别、线程名称、记录消息的类名以及消息本身。
- en: Luckily, most of this information is provided by the logging framework. However,
    engineers will still need to code the content of the logging message.
  id: totrans-106
  prefs: []
  type: TYPE_NORMAL
  zh: 幸运的是，大部分这些信息都是由日志框架提供的。然而，工程师仍然需要编写日志消息的内容。
- en: 'A good log message should have the following characteristics:'
  id: totrans-107
  prefs: []
  type: TYPE_NORMAL
  zh: 一个好的日志消息应具备以下特点：
- en: '**Concise**: The message should be short and ideally in one sentence.'
  id: totrans-108
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: '**简洁**：消息应简短，最好是一句话。'
- en: '**Mindful use of tenses**: Two major tenses should be used. The past tense
    is used to describe what happened. Continuous tense is used for logging processes
    that are still running and should be concluded with a log message announcing the
    process has been completed.'
  id: totrans-109
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: '**注意时态的使用**：应使用两种主要时态。过去时用于描述发生的事情。进行时用于记录仍在运行的流程，并且应以宣布流程完成的日志消息结束。'
- en: '**Key information**: The message should contain the essential IDs so that engineers
    who read the message can troubleshoot the related issue. Engineers who wrote the
    log message can read the content from the console and run a drill troubleshooting
    session.'
  id: totrans-110
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: '**关键信息**：消息应包含必要的ID，以便阅读消息的工程师可以排除相关故障。编写日志消息的工程师可以从控制台读取内容并运行故障排除会话。'
- en: '**Incite an action**: Engineers can act on the log message, either as an investigation
    or confirmation of the outcome of a process as this would be valuable.'
  id: totrans-111
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: '**激发行动**：工程师可以针对日志消息采取行动，无论是作为调查还是确认流程的结果，因为这将是宝贵的。'
- en: '**Consistent style**: A consistent style promotes easier understanding and
    faster response to a log message.'
  id: totrans-112
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: '**一致的样式**：一致的样式有助于更容易地理解日志消息，并更快地响应。'
- en: Logging frameworks
  id: totrans-113
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: 日志框架
- en: Despite that different components may use different technologies and languages,
    the same logging framework should be used whenever possible. This would reduce
    the inconsistencies of log messages in the system, and thus reduce the cognitive
    load of engineers using the log messages for troubleshooting purposes.
  id: totrans-114
  prefs: []
  type: TYPE_NORMAL
  zh: 尽管不同的组件可能使用不同的技术和语言，但在可能的情况下，应尽可能使用相同的日志框架。这将减少系统中日志消息的不一致性，从而减少工程师在故障排除目的下使用日志消息时的认知负荷。
- en: Structured versus unstructured logging
  id: totrans-115
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: 结构化日志与非结构化日志
- en: 'An **unstructured log** message is a plain string with some formatting, as
    shown here:'
  id: totrans-116
  prefs: []
  type: TYPE_NORMAL
  zh: 一个**非结构化日志**消息是一个带有一些格式的普通字符串，如下所示：
- en: '[PRE0]'
  id: totrans-117
  prefs: []
  type: TYPE_PRE
  zh: '[PRE0]'
- en: Given that the format is consistent, it isn’t too bad and can be read by humans.
    However, when it comes to log aggregation, alert triggering, and analysis, it’s
    hard to extract the exact information accurately and consistently.
  id: totrans-118
  prefs: []
  type: TYPE_NORMAL
  zh: 由于格式一致，它并不太糟糕，并且可以被人阅读。然而，当涉及到日志聚合、警报触发和分析时，很难准确和一致地提取确切信息。
- en: '**Structured logging**, however, promotes well-defined fields and structures
    so that data can easily be extracted. The previous plain unstructured text log
    message can be expressed as a JSON object:'
  id: totrans-119
  prefs: []
  type: TYPE_NORMAL
  zh: 然而，**结构化日志**提倡定义良好的字段和结构，以便数据可以轻松提取。之前的普通非结构化文本日志消息可以表示为一个 JSON 对象：
- en: '[PRE1]'
  id: totrans-120
  prefs: []
  type: TYPE_PRE
  zh: '[PRE1]'
- en: Structured logging allows for custom fields that provide even more value to
    the log messages for further monitoring and analysis. This feature is powered
    by most logging frameworks.
  id: totrans-121
  prefs: []
  type: TYPE_NORMAL
  zh: 结构化日志允许自定义字段，这为日志消息提供了更多的价值，以便进行进一步的监控和分析。这个特性由大多数日志框架提供支持。
- en: 'The preceding logging message is supported by the `build.gradlde.kts`:'
  id: totrans-122
  prefs: []
  type: TYPE_NORMAL
  zh: 上述日志消息由 `build.gradle.kts` 支持：
- en: '[PRE2]'
  id: totrans-123
  prefs: []
  type: TYPE_PRE
  zh: '[PRE2]'
- en: 'In the Logback configuration file, `logback.xml`, the Logstash encoder is used
    to format log messages as JSON strings:'
  id: totrans-124
  prefs: []
  type: TYPE_NORMAL
  zh: 在 Logback 配置文件 `logback.xml` 中，使用 Logstash 编码器将日志消息格式化为 JSON 字符串：
- en: '[PRE3]'
  id: totrans-125
  prefs: []
  type: TYPE_PRE
  zh: '[PRE3]'
- en: 'Then, `structuredAppender` is attached to the root as a log appender. The code
    to log a structured message is as follows:'
  id: totrans-126
  prefs: []
  type: TYPE_NORMAL
  zh: 然后，`structuredAppender` 被附加到根节点作为日志追加器。记录结构化消息的代码如下：
- en: '[PRE4]'
  id: totrans-127
  prefs: []
  type: TYPE_PRE
  zh: '[PRE4]'
- en: Apart from the main message, the `payload` field supports custom fields in key-value
    pair format.
  id: totrans-128
  prefs: []
  type: TYPE_NORMAL
  zh: 除了主要消息外，`payload` 字段支持键值对格式的自定义字段。
- en: It should be emphasized that the log message content is created in a Lambda
    expression, not as parameters. It’s optimal because the logging framework can
    choose not to execute the Lambda expression if this message has a lower log level
    than the configuration.
  id: totrans-129
  prefs: []
  type: TYPE_NORMAL
  zh: 应该强调的是，日志消息内容是在 Lambda 表达式中创建的，而不是作为参数。这是最优的，因为日志框架可以选择不执行 Lambda 表达式，如果此消息的日志级别低于配置。
- en: On the contrary, values that are passed in the log function as parameters are
    evaluated before the logging framework decides to use them. This may have a performance
    impact if we were to log very detailed information in a low log level such as
    TRACE.
  id: totrans-130
  prefs: []
  type: TYPE_NORMAL
  zh: 相反，作为日志函数参数传递的值在日志框架决定使用它们之前会被评估。如果我们要在低日志级别（如 TRACE）中记录非常详细的信息，这可能会对性能产生影响。
- en: Contextual logging, or Mapped Diagnostic Context (MDC)
  id: totrans-131
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: 上下文日志，或称为映射诊断上下文（MDC）
- en: '**Contextual logging**, also known as **Mapper Diagnostic Context** (**MDC**),
    aims to group or correlate log messages with the use of IDs (for example user
    ID, request ID, session ID, and so on). It highlights the fact that these log
    messages belong to the wider business context or process. This helps engineers
    identify and diagnose issues by going through a small set of log messages under
    the same context.'
  id: totrans-132
  prefs: []
  type: TYPE_NORMAL
  zh: '**上下文日志**，也称为 **映射诊断上下文**（**MDC**），旨在通过使用 ID（例如用户ID、请求ID、会话ID等）来分组或关联日志消息。它强调了这些日志消息属于更广泛的业务上下文或过程的事实。这有助于工程师通过查看同一上下文下的一小部分日志消息来识别和诊断问题。'
- en: This contextual data can also be used for monitoring and alerting. For example,
    it’s possible to monitor user activities by session ID to understand actions that
    are also performed together in a session.
  id: totrans-133
  prefs: []
  type: TYPE_NORMAL
  zh: 这些上下文数据也可以用于监控和警报。例如，可以通过会话ID监控用户活动，以了解在会话中一起执行的操作。
- en: Contextual logging can also cut through layers of abstraction in the log messages.
    There might be logging in the service layer, and the repository layer can be grouped
    by the contextual data.
  id: totrans-134
  prefs: []
  type: TYPE_NORMAL
  zh: 上下文日志也可以穿透日志消息中的抽象层。服务层可能有日志记录，而存储层可以根据上下文数据分组。
- en: Contextual logging is also compatible with structured logging. Contextual data
    is added as custom fields to the log messages within the scope so that these log
    messages can be grouped and analyzed.
  id: totrans-135
  prefs: []
  type: TYPE_NORMAL
  zh: 上下文日志也与结构化日志兼容。上下文数据作为自定义字段添加到作用域内的日志消息中，以便这些日志消息可以分组和分析。
- en: 'Extending from the example provided for structured logging, Kotlin Logging
    provides a `withLoggingContext` function to facilitate MDC:'
  id: totrans-136
  prefs: []
  type: TYPE_NORMAL
  zh: 从提供的结构化日志示例扩展，Kotlin Logging 提供了一个 `withLoggingContext` 函数来简化 MDC 的使用：
- en: '[PRE5]'
  id: totrans-137
  prefs: []
  type: TYPE_PRE
  zh: '[PRE5]'
- en: The `withLoggingContext` function accepts multiple key-value pairs as the contextual
    data. In this example, `session` is added as the contextual data. The Lambda expression
    that follows defines the scope of the context, so all the function invocations
    in the Lambda expression will automatically have the contextual data added as
    custom fields to the structured log messages.
  id: totrans-138
  prefs: []
  type: TYPE_NORMAL
  zh: '`withLoggingContext`函数接受多个键值对作为上下文数据。在这个例子中，`session`被添加为上下文数据。随后的Lambda表达式定义了上下文的范围，因此Lambda表达式中的所有函数调用都将自动将上下文数据添加为自定义字段到结构化日志消息中。'
- en: 'Optionally, the contextual data can be surfaced in the content of log messages
    by adding the contextual field in the log format:'
  id: totrans-139
  prefs: []
  type: TYPE_NORMAL
  zh: 可选地，可以通过在日志格式中添加上下文字段来在日志消息的内容中展示上下文数据：
- en: '[PRE6]'
  id: totrans-140
  prefs: []
  type: TYPE_PRE
  zh: '[PRE6]'
- en: 'As a result, the JSON string log message is enhanced with contextual data:'
  id: totrans-141
  prefs: []
  type: TYPE_NORMAL
  zh: 因此，JSON字符串日志消息通过添加上下文字段得到了增强：
- en: '[PRE7]'
  id: totrans-142
  prefs: []
  type: TYPE_PRE
  zh: '[PRE7]'
- en: The `session` field is automatically added to all messages that are logged inside
    the scope by the `withLoggingContext` function. This approach also separates the
    concern of logging contextual data from the main application logic. This contextual
    data doesn’t need to be passed into any function that’s invoked inside the scope.
  id: totrans-143
  prefs: []
  type: TYPE_NORMAL
  zh: '`session`字段由`withLoggingContext`函数自动添加到所有在范围内记录的消息中。这种方法也将记录上下文数据的问题与主要应用程序逻辑分离。这些上下文数据不需要传递到任何在范围内调用的函数中。'
- en: There are wider scopes on how to centralize and aggregate data for monitoring
    and auditing purposes. We’re going to cover these next.
  id: totrans-144
  prefs: []
  type: TYPE_NORMAL
  zh: 在如何集中和汇总数据以进行监控和审计方面有更广泛的范围。我们将在下一部分讨论这些内容。
- en: Centralizing and aggregating data
  id: totrans-145
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 集中和汇总数据
- en: Previously, we discussed the challenges of auditing and monitoring distributed
    systems, one of which is the data that’s scattered across multiple places. It’s
    common to have a business process perceived as a unit but executed in multiple
    services and devices in distributed systems.
  id: totrans-146
  prefs: []
  type: TYPE_NORMAL
  zh: 之前，我们讨论了审计和监控分布式系统所面临的挑战，其中之一是分散在多个地方的数据。在分布式系统中，一个业务流程通常被视为一个单元，但在多个服务和设备上执行。
- en: In this scenario, the auditing and monitoring data only makes sense when we
    can aggregate it into a centralized place for consolidation and analysis.
  id: totrans-147
  prefs: []
  type: TYPE_NORMAL
  zh: 在这种情况下，审计和监控数据只有在我们可以将其汇总到一个集中的地方进行合并和分析时才有意义。
- en: Centralized audit trail aggregation
  id: totrans-148
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 集中审计日志汇总
- en: 'Let’s revisit the real-life example of villagers exchanging services and imagine
    that we need to aggregate auditing and monitoring data from numerous services.
    There are three services: **Household service**, **Contract service**, and **Notification
    service**. The need to aggregate audit trails would warrant a new generic subdomain
    service that collects all events that happened in other services. The new service,
    **Audit service**, and its interactions with other services are depicted in *Figure
    11**.1*:'
  id: totrans-149
  prefs: []
  type: TYPE_NORMAL
  zh: 让我们重新审视村民交换服务的真实生活例子，并想象我们需要从众多服务中汇总审计和监控数据。这里有三种服务：**家庭服务**、**合同服务**和**通知服务**。汇总审计日志的需求将需要一个新的通用子域服务，该服务收集在其他服务中发生的所有事件。新的服务，**审计服务**，以及它与其他服务的交互，在*图11.1*中展示：
- en: '![Figure 11.1 – An example of Audit service interactions](img/B21737_11_1.jpg)'
  id: totrans-150
  prefs: []
  type: TYPE_IMG
  zh: '![图11.1 – 审计服务交互的示例](img/B21737_11_1.jpg)'
- en: Figure 11.1 – An example of Audit service interactions
  id: totrans-151
  prefs: []
  type: TYPE_NORMAL
  zh: 图11.1 – 审计服务交互的示例
- en: '**Audit service** consumes all events generated by the four other services.
    It’sresponsible for understanding these events, transforming them into standard
    data structures, and persisting them into permanent storage for queries in the
    future.'
  id: totrans-152
  prefs: []
  type: TYPE_NORMAL
  zh: '**审计服务**消费由其他四个服务生成的所有事件。它负责理解这些事件，将它们转换为标准数据结构，并将它们持久化到永久存储中，以便将来查询。'
- en: This interaction pattern doesn’t require other services to know the existence
    of **Audit service**, reducing coupling or dependencies. Other services may need
    to change code just to inform consumers of what’s happened in their domain but
    without the burden of auditing requirements.
  id: totrans-153
  prefs: []
  type: TYPE_NORMAL
  zh: 这种交互模式不需要其他服务知道**审计服务**的存在，减少了耦合或依赖。其他服务可能只需要更改代码来通知消费者在其领域内发生了什么，但无需承担审计要求的重担。
- en: Alternative approach
  id: totrans-154
  prefs: []
  type: TYPE_NORMAL
  zh: 替代方法
- en: The alternative approach would be to have other services imperatively inform
    **Audit service**, usually by calling a **REST endpoint**. This would make other
    services depend on **Audit service**. It’s also more complex for synchronous REST
    communication to provide the same reliability guarantees compared to asynchronous
    events. Now, all other services are aware of auditing requirements, which is considered
    a leak in the bounded context of auditing. So, this isn’t a recommended approach.
  id: totrans-155
  prefs: []
  type: TYPE_NORMAL
  zh: 另一种方法是让其他服务强制通知**审计服务**，通常是通过调用**REST端点**。这将使其他服务依赖于**审计服务**。与异步事件相比，同步REST通信提供相同的可靠性保证也更加复杂。现在，所有其他服务都意识到了审计要求，这在审计的边界上下文中被认为是一个泄露。因此，这不是一个推荐的方法。
- en: Audit data structure unification
  id: totrans-156
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: 审计数据结构统一
- en: The downside of this approach is that **Audit service** must know the schema
    of all auditable events of all services. There are a lot of dependencies to manage
    in **Audit service**.
  id: totrans-157
  prefs: []
  type: TYPE_NORMAL
  zh: 这种方法的缺点是**审计服务**必须知道所有服务中所有可审计事件的模式。在**审计服务**中需要管理很多依赖关系。
- en: There’s a workaround for this problem. If the system can be aligned to adopt
    a standard envelope of all events, then the auditing fields are defined at the
    envelope level, while domain-specific fields are defined at the content level.
  id: totrans-158
  prefs: []
  type: TYPE_NORMAL
  zh: 对于这个问题有一个解决方案。如果系统能够调整以采用所有事件的标准化信封，那么审计字段在信封级别定义，而特定领域的字段在内容级别定义。
- en: Having said that, it’s still essential to capture the domain-specific fields
    as part of the audit trail. These fields can be stored in their native formats
    without transformation. This transformation will only be needed when retrieving
    the data.
  id: totrans-159
  prefs: []
  type: TYPE_NORMAL
  zh: 话虽如此，仍然有必要将特定领域的字段作为审计跟踪的一部分进行捕获。这些字段可以以它们的原生格式存储，无需转换。这种转换仅在检索数据时才需要。
- en: Linking related audit trails using IDs
  id: totrans-160
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: 使用ID链接相关的审计跟踪
- en: The ability to link related audit trails is paramount in reporting a complete
    business journey. This is typically implemented by generating a **correlation
    ID** for the entry point service or any other component that the distributed system
    needs to associate with related audit events. The events may not necessarily be
    part of the same request or transaction.
  id: totrans-161
  prefs: []
  type: TYPE_NORMAL
  zh: 在报告完整的业务旅程时，能够链接相关的审计跟踪至关重要。这通常是通过为入口服务或分布式系统需要关联的任何其他组件生成一个**关联ID**来实现的。这些事件不一定属于同一个请求或事务。
- en: Correlation IDs are useful for troubleshooting and understanding the relationships
    between different components in a distributed system within a business journey,
    even if they’re not directly part of the same request flow.
  id: totrans-162
  prefs: []
  type: TYPE_NORMAL
  zh: 关联ID对于故障排除和理解业务旅程中不同组件之间的关系非常有用，即使它们不是同一个请求流的一部分。
- en: Discoverability of event topics
  id: totrans-163
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: 事件主题的可发现性
- en: 'In a large distributed system, having to keep track of new event topics to
    be consumed by **Audit service** could be an exhausting effort. Ideally, **Audit
    service** should be able to discover and dynamically consume event topics. There
    are several ways to achieve this:'
  id: totrans-164
  prefs: []
  type: TYPE_NORMAL
  zh: 在一个大型分布式系统中，需要跟踪**审计服务**将要消费的新事件主题可能会是一项耗时的任务。理想情况下，**审计服务**应该能够发现并动态消费事件主题。有几种方法可以实现这一点：
- en: Use service discovery mechanisms, such as service registries or service meshes,
    to discover the available event topics or event streams.
  id: totrans-165
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 使用服务发现机制，如服务注册表或服务网格，来发现可用的事件主题或事件流。
- en: Use a centralized event catalog, which can be in the form of a standalone service,
    or just a resource such as a last-value queue that can be accessed by **Audit
    service**.
  id: totrans-166
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 使用集中式事件目录，它可以是一个独立的服务，或者只是一个可以被**审计服务**访问的资源，例如最后一个值队列。
- en: Use messaging brokers. Some (for example, RabbitMQ and Kafka) provide APIs to
    discover event topics.
  id: totrans-167
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 使用消息代理。一些（例如，RabbitMQ和Kafka）提供API来发现事件主题。
- en: Use configuration management tools such as Spring Cloud Config or Kubernetes
    as they provide APIs that can be used to look up event topics.
  id: totrans-168
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 使用配置管理工具，如Spring Cloud Config或Kubernetes，因为它们提供API，可以用来查找事件主题。
- en: Once event topics have been looked up dynamically, as well as the standard envelope,
    **Audit service** can automatically consume and persist events in a dedicated
    database for audit reporting.
  id: totrans-169
  prefs: []
  type: TYPE_NORMAL
  zh: 一旦动态查找了事件主题以及标准信封，**审计服务**就可以自动消费并将事件持久化到用于审计报告的专用数据库中。
- en: Example of an audit trail event
  id: totrans-170
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: 审计跟踪事件示例
- en: 'Combining all the key aspects of audit trails that we discussed previously,
    we can come up with an example of the audit trail as a Kotlin data class. The
    most important element of an audit trail is the actor involved in the event:'
  id: totrans-171
  prefs: []
  type: TYPE_NORMAL
  zh: 结合我们之前讨论的审计跟踪的关键方面，我们可以给出一个审计跟踪作为 Kotlin 数据类的示例。审计跟踪最重要的元素是参与事件的参与者：
- en: '[PRE8]'
  id: totrans-172
  prefs: []
  type: TYPE_PRE
  zh: '[PRE8]'
- en: The `Actor` class uses a UUID as the tokenized identifier. While it typically
    represents a human user, it can sometimes be a scheduled trigger or an external
    system that kicks off a business journey. The type of actors (for example, user,
    external system, or scheduler) is captured by the `type` field. The involvement
    of the actor is captured by the `involvement` field – for example, “executed by,”
    “on behalf of,” and so on.
  id: totrans-173
  prefs: []
  type: TYPE_NORMAL
  zh: '`Actor` 类使用 UUID 作为标记化标识符。虽然它通常代表人类用户，但有时可能是一个计划触发器或启动业务旅程的外部系统。参与者的类型（例如，用户、外部系统或调度器）由
    `type` 字段捕获。参与者的参与由 `involvement` 字段捕获——例如，“由...执行”、“代表...”等等。'
- en: 'They use the `String` type in contrast to enumeration for two reasons:'
  id: totrans-174
  prefs: []
  type: TYPE_NORMAL
  zh: 他们使用 `String` 类型而不是枚举有两个原因：
- en: Adding a new enum value isn’t backward compatible
  id: totrans-175
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 添加新的枚举值不具有向后兼容性
- en: Removing an existing enum value isn’t forward compatible
  id: totrans-176
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 移除现有的枚举值不具有向前兼容性
- en: Having it as a plain string ensures it can always be parsed to construct a full
    audit trail from the beginning of time, knowing that changes in values might be
    introduced in the future.
  id: totrans-177
  prefs: []
  type: TYPE_NORMAL
  zh: 将其作为普通字符串可以确保它始终可以被解析，从而从时间的开始构建完整的审计跟踪，考虑到未来可能会引入值的变化。
- en: 'Another important element is the resources involved:'
  id: totrans-178
  prefs: []
  type: TYPE_NORMAL
  zh: 另一个重要元素是涉及的资源：
- en: '[PRE9]'
  id: totrans-179
  prefs: []
  type: TYPE_PRE
  zh: '[PRE9]'
- en: Each resource is identified by a UUID, but it can just be a plain string. The
    resource also comes up as a `type` field, which can be the name of an aggregate,
    entity, or value object (for example, “household,” “contract,” and so on). It’s
    also useful to capture to which application the resource belongs. This information
    is captured as `application ID` (for example, “household service”). If the resource
    is versioned, then that’s also captured.
  id: totrans-180
  prefs: []
  type: TYPE_NORMAL
  zh: 每个资源都由一个 UUID 标识，但它也可以是一个普通字符串。资源还作为一个 `type` 字段出现，这可以是聚合、实体或值对象（例如，“家庭”、“合同”等）的名称。捕获资源所属的应用程序也很有用。此信息作为
    `application ID`（例如，“家庭服务”）捕获。如果资源是版本化的，那么这也被捕获。
- en: 'From these two data classes, the event envelope data class can be defined as
    follows:'
  id: totrans-181
  prefs: []
  type: TYPE_NORMAL
  zh: 从这两个数据类中，可以定义事件信封数据类如下：
- en: '[PRE10]'
  id: totrans-182
  prefs: []
  type: TYPE_PRE
  zh: '[PRE10]'
- en: It starts with an event ID as a UUID type and unique identifier. The session
    ID is captured to correlate activities that happened in the same login session.
    There’s a correlation ID that links multiple business activities together. The
    timestamp of the event is captured as the `happenedAt` field. The `action` field
    captures what initiates the business journey, while the `outcome` field captures
    the result as the event occurs.
  id: totrans-183
  prefs: []
  type: TYPE_NORMAL
  zh: 它以一个作为 UUID 类型的事件 ID 作为唯一标识符开始。会话 ID 被捕获以关联同一登录会话中发生的活动。有一个关联 ID 将多个业务活动链接在一起。事件的时间戳作为
    `happenedAt` 字段捕获。`action` 字段捕获启动业务旅程的内容，而 `outcome` 字段捕获事件发生时的结果。
- en: 'The envelope uses the `Actor` class in two ways: it initiates the business
    journey and sets other actors that are involved in this event. A null set is treated
    the same as an empty set. The `Resource` class follows the same pattern in that
    there’s a main resource and other resources.'
  id: totrans-184
  prefs: []
  type: TYPE_NORMAL
  zh: 信封以两种方式使用 `Actor` 类：它启动业务旅程并设置参与此事件的其它参与者。空集合被视为与空集合相同。`Resource` 类遵循相同的模式，即有一个主要资源和其他资源。
- en: The content of the event makes use of the generic `E` type as there will be
    many forms of events under the envelope.
  id: totrans-185
  prefs: []
  type: TYPE_NORMAL
  zh: 事件的内容使用了通用的 `E` 类型，因为信封下将会有许多形式的事件。
- en: 'Finally, there’s a generic list of differences between the main resources before
    and after the event. A Kotlin data class can be expressed as a JSON object, and
    there are open source libraries that can generate a list in JSON Patch format
    given two JSON objects. Then, the list of differences can be represented by a
    data class – that is, `Difference`:'
  id: totrans-186
  prefs: []
  type: TYPE_NORMAL
  zh: 最后，有一个事件前后主要资源差异的通用列表。Kotlin 数据类可以表示为 JSON 对象，并且有开源库可以根据两个 JSON 对象生成 JSON Patch
    格式的列表。然后，差异列表可以通过数据类表示——即 `Difference`：
- en: '[PRE11]'
  id: totrans-187
  prefs: []
  type: TYPE_PRE
  zh: '[PRE11]'
- en: This class has four fields. The `op` field represents the data operation types
    such as “add,” “replace,” or “delete.”
  id: totrans-188
  prefs: []
  type: TYPE_NORMAL
  zh: 此类有四个字段。`op` 字段表示数据操作类型，如“添加”、“替换”或“删除”。
- en: The `path` field is the path of the field as if it were a JSON object – for
    example, */party/0/householdName*. The values that are changed before and after
    the event are captured as `fromValue` and `toValue`, respectively.
  id: totrans-189
  prefs: []
  type: TYPE_NORMAL
  zh: '`path`字段是字段路径，就像它是一个JSON对象一样——例如，*/party/0/householdName*。事件前后更改的值分别捕获为`fromValue`和`toValue`。'
- en: This audit trail envelope is just one example, and each organization should
    have an envelope that suits its needs. Next, we’ll turn our attention to monitoring
    data collection and aggregation.
  id: totrans-190
  prefs: []
  type: TYPE_NORMAL
  zh: 这个审计跟踪信封只是一个例子，每个组织都应该有一个适合其需求的信封。接下来，我们将关注监控数据收集和聚合。
- en: Monitoring data collection and aggregation
  id: totrans-191
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 监控数据收集和聚合
- en: 'Monitoring tools use a hugely different approach to collect their data. They
    use multiple methods to collect data from various sources, such as the following:'
  id: totrans-192
  prefs: []
  type: TYPE_NORMAL
  zh: 监控工具使用多种不同的方法来收集其数据。它们使用多种方法从各种来源收集数据，如下所示：
- en: '**Agents or daemons**: Small software components called agents are installed
    on the systems being monitored. These agents collect data and send it to a central
    monitoring server.'
  id: totrans-193
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '**代理或守护进程**：在要监控的系统中安装了称为代理的小型软件组件。这些代理收集数据并将其发送到中央监控服务器。'
- en: '**System-level metrics**: These agents can collect various metrics, such as
    CPU usage, memory usage, disk I/O, network traffic, and more.'
  id: totrans-194
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '**系统级指标**：这些代理可以收集各种指标，例如CPU使用率、内存使用率、磁盘I/O、网络流量等等。'
- en: '**Application-level metrics**: Applications can log messages in the format
    so that they can be accounted for as a metric, or applications can submit the
    metric numbers directly to the monitoring tool. For example, a Kotlin/JVM application
    can use **Java Management Extensions** (**JMX**) to expose resource usage, application
    data, configuration, and performance metrics. JMX can be accessed as **Managed
    Beans** (**MBeans**) and can also be integrated with third-party monitoring tools
    for visualization and alert purposes.'
  id: totrans-195
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '**应用级指标**：应用可以以这种格式记录消息，以便它们可以作为指标进行记录，或者应用可以直接将指标数值提交给监控工具。例如，一个Kotlin/JVM应用可以使用**Java管理扩展**（**JMX**）来公开资源使用情况、应用数据、配置和性能指标。JMX可以通过**管理Bean**（**MBeans**）访问，也可以与第三方监控工具集成，用于可视化和警报目的。'
- en: '**Log file collection**: These agents can listen to the system standard output
    and system error output. These agents can also tail the log files and send them
    to the monitoring data source. The log messages can also be directly submitted
    to a data source, such as Elastic Store, for aggregation purposes.'
  id: totrans-196
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '**日志文件收集**：这些代理可以监听系统标准输出和系统错误输出。这些代理还可以跟踪日志文件并将它们发送到监控数据源。日志消息也可以直接提交到数据源，例如Elastic
    Store，用于聚合目的。'
- en: '**Agentless**: By using standard network protocols, it’s possible to collect
    monitoring data, particularly network monitoring data, without installing an agent.
    For example, **Window Management Instrumentation** (**WMI**) provides an operating
    system interface where notifications and device-related information from the nodes
    are enabled. Another example is an extra node in a multicast UDP network that
    captures network metrics to be sent to the monitoring tool.'
  id: totrans-197
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '**无代理**：通过使用标准网络协议，可以收集监控数据，尤其是网络监控数据，而无需安装代理。例如，**Windows管理规范**（**WMI**）提供了一个操作系统接口，其中启用了来自节点的通知和设备相关信息。另一个例子是在多播UDP网络中的一个额外节点，它捕获要发送到监控工具的网络指标。'
- en: '**API integration**: Some monitoring middleware software uses direct API integrations
    with services, applications, and cloud platforms. It can go both ways: either
    the node being monitored provides an API to expose monitoring data, such as Spring
    Actuator, or the monitoring tool provides an API for nodes to submit monitoring
    data.'
  id: totrans-198
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '**API集成**：一些监控中间件软件使用与服务、应用和云平台的直接API集成。它可以双向进行：要么被监控的节点提供一个API来公开监控数据，例如Spring
    Actuator，要么监控工具提供一个API供节点提交监控数据。'
- en: '`measureTimeMillis`) and another for nanosecond precision (`measureNanoTime`):'
  id: totrans-199
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '`measureTimeMillis`）和一个用于纳秒精度（`measureNanoTime`）的另一个：'
- en: '[PRE12]'
  id: totrans-200
  prefs:
  - PREF_IND
  type: TYPE_PRE
  zh: '[PRE12]'
- en: '**Trace IDs and span IDs**: A **trace ID** is a unique identifier that represents
    an end-to-end business process or request as it flows through a distributed system.
    It’s used to group all the individual spans (see the following paragraph) that
    are part of the distributed transaction or request. Trace IDs allow us to understand
    the complete journey of a request as it moves across multiple services, components,
    and systems.'
  id: totrans-201
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '**跟踪ID和跨度ID**：一个**跟踪ID**是一个唯一的标识符，它代表一个端到端业务流程或请求，在它通过分布式系统流动时。它用于将所有属于分布式事务或请求的各个单独的跨度（见下一段）分组在一起。跟踪ID使我们能够理解请求在跨越多个服务、组件和系统时的完整旅程。'
- en: 'A **span ID** is a unique identifier for a single operation or unit of work
    within a distributed transaction or request. Spans represent individual steps
    or operations that are performed as part of a larger trace, such as an HTTP request,
    a database query, or a function call. Spans are hierarchical and can be nested
    within a trace to represent the different components, services, or processes involved
    in handling a single request. The relationship between trace IDs and span IDs
    is shown in *Figure 11**.2*:'
  id: totrans-202
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: '**跨度ID**是一个用于分布式事务或请求中单个操作或工作单元的唯一标识符。跨度代表作为更大跟踪（如HTTP请求、数据库查询或函数调用）一部分执行的单个步骤或操作。跨度是分层的，可以在跟踪内部嵌套以表示处理单个请求涉及的不同组件、服务或进程。跟踪ID和跨度ID之间的关系如图*11.2*所示：'
- en: '![Figure 11.2 – Trace IDs and span IDs in a real-world example](img/B21737_11_2.jpg)'
  id: totrans-203
  prefs:
  - PREF_IND
  type: TYPE_IMG
  zh: '![图11.2 – 实际示例中的跟踪ID和跨度ID](img/B21737_11_2.jpg)'
- en: Figure 11.2 – Trace IDs and span IDs in a real-world example
  id: totrans-204
  prefs: []
  type: TYPE_NORMAL
  zh: 图11.2 – 实际示例中的跟踪ID和跨度ID
- en: Here, one request is coming from the mobile application through **Contract Service**
    to amend a contract, while **Trace ID 215** and **Span ID 12** are assigned to
    this request. **Contract Service** requests household information from **Household
    Service** while processing the request. This means that **Household Service**
    is involved in processing this request, as indicated by **Trace ID 215** but a
    different span value – that is, **Span ID 13**. **Contract Service** notifies
    **Notification Service** to send emails to the affected households, so **Notification
    Service** is also involved in this request, using the same trace – that is, **Trace
    ID 215** – but a new span – that is, **Span** **ID 14**.
  id: totrans-205
  prefs: []
  type: TYPE_NORMAL
  zh: 在这里，一个请求从移动应用程序通过**Contract Service**来修改合同，同时为这个请求分配了**跟踪ID 215**和**跨度ID 12**。**Contract
    Service**在处理请求时请求家庭信息从**Household Service**。这意味着**Household Service**参与了处理这个请求，如**跟踪ID
    215**所示，但具有不同的跨度值——即**跨度ID 13**。**Contract Service**通知**Notification Service**向受影响的家庭发送电子邮件，因此**Notification
    Service**也参与了此请求，使用相同的跟踪——即**跟踪ID 215**——但一个新的跨度——即**跨度ID 14**。
- en: With many third-party monitoring tools on the market (for example, **Elastic
    Slack** (**ELK**), Splunk, Datadog, Kibana, Prometheus, Grafana, New Relic, Jaeger,
    and others) and various methods in collecting data, it’s recommended to avoid
    the vendor lock-in issue. It may become too expensive to consider other monitoring
    tools if the system is integrated with the monitoring tools using proprietary
    methods.
  id: totrans-206
  prefs: []
  type: TYPE_NORMAL
  zh: 由于市场上存在许多第三方监控工具（例如，**Elastic Slack**（**ELK**）、Splunk、Datadog、Kibana、Prometheus、Grafana、New
    Relic、Jaeger等）以及各种收集数据的方法，建议避免供应商锁定问题。如果系统使用专有方法与监控工具集成，考虑其他监控工具可能会变得过于昂贵。
- en: OpenTelemetry (OTel)
  id: totrans-207
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: OpenTelemetry (OTel)
- en: '**OpenTelemetry** (**OTel**) is a community-driven open source framework that
    aims to standardize the way we collect, process, and export observability data
    from applications. It provides a set of APIs, libraries, agents, and instrumentation
    tools that can support various programming languages and frameworks. This interoperability
    makes it possible to trace and monitor applications that use different technologies,
    and we can monitor the system holistically.'
  id: totrans-208
  prefs: []
  type: TYPE_NORMAL
  zh: '**OpenTelemetry**（**OTel**）是一个由社区驱动的开源框架，旨在标准化我们从应用程序收集、处理和导出可观察数据的方式。它提供了一套API、库、代理和仪器工具，可以支持各种编程语言和框架。这种互操作性使得能够跟踪和监控使用不同技术的应用程序，我们可以全面地监控系统。'
- en: Moreover, it’s cheaper to migrate from one monitoring tool to another given
    they all use OTel as a standard, and thus we aren’t locked into using only one
    vendor.
  id: totrans-209
  prefs: []
  type: TYPE_NORMAL
  zh: 此外，由于它们都使用OTel作为标准，因此从一种监控工具迁移到另一种监控工具的成本更低，因此我们不会局限于只使用一个供应商。
- en: 'Setting up OTel begins with using its libraries. This is shown in the following
    code, which uses the Gradle Kotlin DSL:'
  id: totrans-210
  prefs: []
  type: TYPE_NORMAL
  zh: 设置OTel从使用其库开始。以下代码展示了这一点，它使用了Gradle Kotlin DSL：
- en: '[PRE13]'
  id: totrans-211
  prefs: []
  type: TYPE_PRE
  zh: '[PRE13]'
- en: 'The next step is to configure the `tracer` and `span` processors:'
  id: totrans-212
  prefs: []
  type: TYPE_NORMAL
  zh: 下一步是配置`tracer`和`span`处理器：
- en: '[PRE14]'
  id: totrans-213
  prefs: []
  type: TYPE_PRE
  zh: '[PRE14]'
- en: 'The preceding code defines an endpoint to export telemetric data to an `Tracer`
    object is created to be used in the traceable process. Let’s look at how this
    object is used in starting and ending a span:'
  id: totrans-214
  prefs: []
  type: TYPE_NORMAL
  zh: 上述代码定义了一个端点，用于将遥测数据导出到`Tracer`对象，该对象被创建用于在可追踪过程中使用。让我们看看这个对象是如何在开始和结束span时使用的：
- en: '[PRE15]'
  id: totrans-215
  prefs: []
  type: TYPE_PRE
  zh: '[PRE15]'
- en: This example `main()` function starts a span with a custom attribute added to
    provide contextual information. If the process succeeds, the span is acknowledged
    and ended. Otherwise, the span records the exception that has been captured.
  id: totrans-216
  prefs: []
  type: TYPE_NORMAL
  zh: 这个示例`main()`函数通过添加自定义属性来启动一个span，以提供上下文信息。如果过程成功，span将被确认并结束。否则，span将记录已捕获的异常。
- en: It’s important to note that the monitoring APIs are designed to not throw errors
    that would otherwise interfere with the actual process. In this example, the code
    will run even if the OTLP server can’t be reached.
  id: totrans-217
  prefs: []
  type: TYPE_NORMAL
  zh: 需要注意的是，监控API的设计是为了不抛出会干扰实际过程的错误。在这个例子中，即使无法连接到OTLP服务器，代码也会运行。
- en: This data will be exported to a monitoring tool for further usage, something
    we’re going to cover in the next section.
  id: totrans-218
  prefs: []
  type: TYPE_NORMAL
  zh: 这些数据将被导出到监控工具以供进一步使用，我们将在下一节中介绍这一点。
- en: Metrics, visualization, and dashboards
  id: totrans-219
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 指标、可视化和仪表板
- en: Since monitoring data is centralized and aggregated, a monitoring tool can start
    using this data for many purposes. For example, heartbeat messages and regular
    health checks of applications provide an uptime ratio per application as a metric.
    This metric can be visualized in a dashboard that operators and engineers can
    observe.
  id: totrans-220
  prefs: []
  type: TYPE_NORMAL
  zh: 由于监控数据是集中和汇总的，监控工具可以开始将此数据用于许多目的。例如，心跳消息和应用程序的常规健康检查提供每个应用程序的运行时间比作为指标。这个指标可以在仪表板上可视化，供操作员和工程师观察。
- en: We must create intuitive visualizations and dashboards that provide a clear,
    at-a-glance understanding of the distributed system’s health, performance, and
    overall status.
  id: totrans-221
  prefs: []
  type: TYPE_NORMAL
  zh: 我们必须创建直观的可视化和仪表板，以便提供对分布式系统健康、性能和整体状态的清晰、一目了然的理解。
- en: The metrics that are measured and visualized on dashboards can be grouped into
    two categories.
  id: totrans-222
  prefs: []
  type: TYPE_NORMAL
  zh: 在仪表板上测量和可视化的指标可以分为两类。
- en: '**Service-level metrics**: Known as **service-level indicators** (**SLIs**),
    these metrics measure the reliability, availability, latency, and performance
    of a system at the service level. It focuses on the **Quality of Service** (**QoS**)
    provided to users and external systems.'
  id: totrans-223
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '**服务级指标**：被称为**服务级指标**（**SLIs**），这些指标衡量系统在服务级别的可靠性、可用性、延迟和性能。它侧重于向用户和外部系统提供的**服务质量**（**QoS**）。'
- en: Apart from the common metrics, such as CPU utilization, network latency, memory
    used, and disk space utilization, metrics that are part of the **service-level
    objective** (**SLO**) and **service-level agreement** (**SLA**) should be highlighted
    in the dashboard. These are sensitive metrics that could affect customer satisfaction,
    relationships with external entities, and the reputation of the organization.
  id: totrans-224
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: 除了常见的指标，如CPU利用率、网络延迟、内存使用和磁盘空间利用率之外，还应突出显示作为**服务级目标**（**SLO**）和**服务级协议**（**SLA**）一部分的指标。这些是可能影响客户满意度、与外部实体的关系以及组织声誉的敏感指标。
- en: A typical service-level metric is the response time to a frequently used feature.
    Application response time is likely part of the SLO or SLA and should be measured
    and visualized continuously.
  id: totrans-225
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: 一个典型的服务级指标是对常用功能的响应时间。应用程序的响应时间很可能是SLO或SLA的一部分，应该持续进行测量和可视化。
- en: SLA versus SLO versus SLI
  id: totrans-226
  prefs: []
  type: TYPE_NORMAL
  zh: SLA与SLO与SLI的比较
- en: A SLA is a formal contract between a service provider and a customer that defines
    the expected level of service, including the specific performance metrics that
    are guaranteed and penalties for not meeting the agreement.
  id: totrans-227
  prefs: []
  type: TYPE_NORMAL
  zh: SLA是服务提供商和客户之间的一项正式合同，它定义了预期的服务水平，包括保证的具体性能指标以及未达到协议的处罚。
- en: A SLO is a specific and measurable goal that defines the target level of the
    service. It sets the performance standards that the service provider aims to achieve.
  id: totrans-228
  prefs: []
  type: TYPE_NORMAL
  zh: SLO是一个具体且可衡量的目标，它定义了服务的目标水平。它设定了服务提供商旨在实现的服务性能标准。
- en: A SLI is a metric that’s used to measure the performance of a service, in particular
    against SLOs. It provides the data needed to determine whether the SLOs are being
    met.
  id: totrans-229
  prefs: []
  type: TYPE_NORMAL
  zh: SLI是用于衡量服务性能的指标，特别是针对SLO。它提供了确定SLO是否得到满足所需的数据。
- en: '**Business-level metrics**: Business-level metrics focus on patterns and usage
    that should bring awareness to the business. For example, an e-commerce system
    would be interested in monitoring how many new users have signed up in the system.'
  id: totrans-230
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '**业务级指标**：业务级指标关注的是应该引起业务关注的模式和用法。例如，电子商务系统可能会对监控系统中注册了多少新用户感兴趣。'
- en: Business-level metrics are often compared against the defined **key performance
    indicators** (**KPIs**), which are used to demonstrate how effectively an organization
    achieves its **objectives and key** **results** (**OKRs**).
  id: totrans-231
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: 业务级指标通常与定义的**关键绩效指标**（KPIs）进行比较，这些指标用于展示组织如何有效地实现其**目标和关键结果**（OKRs）。
- en: The **objective** part of OKR is a qualitative and visionary goal that may not
    be measurable. However, the **key results** are measurable and usually set up
    regularly.
  id: totrans-232
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: OKR的**目标**部分是一个定性和具有前瞻性的目标，可能不可衡量。然而，**关键结果**是可衡量的，并且通常定期设定。
- en: 'In this example of users signing up for the e-commerce system, the objective
    can be to “*sign up as many active purchasing users as possible.*” This objective
    can be translated into the following key results:'
  id: totrans-233
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: 在这个用户注册电子商务系统的例子中，目标可以是“*尽可能多地注册活跃的购买用户*”。这个目标可以转化为以下关键结果：
- en: Sign up 30% of new users in the **third** **quarter** (**Q3**)
  id: totrans-234
  prefs:
  - PREF_IND
  - PREF_OL
  type: TYPE_NORMAL
  zh: 在第三季度（Q3）注册30%的新用户
- en: Ensure 80% of new users stay active in the last 30 days in Q3
  id: totrans-235
  prefs:
  - PREF_IND
  - PREF_OL
  type: TYPE_NORMAL
  zh: 确保在第三季度（Q3）有80%的新用户保持活跃
- en: Ensure 50% of new users purchase at least one item in the system in the last
    30 days in Q3
  id: totrans-236
  prefs:
  - PREF_IND
  - PREF_OL
  type: TYPE_NORMAL
  zh: 确保在第三季度（Q3）有50%的新用户在过去30天内至少购买了一件系统内的商品
- en: These key results are missions within the boundary of time. They’re measurable
    goals that aim to inspire bold goals.
  id: totrans-237
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: 这些关键结果是在时间边界内的任务。它们是可衡量的目标，旨在激发大胆的目标。
- en: 'On the other hand, KPIs continuously measure performance. To support the aforementioned
    OKRs, the following KPIs need to be measured:'
  id: totrans-238
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: 另一方面，关键绩效指标（KPIs）持续衡量绩效。为了支持上述OKR，需要衡量以下KPIs：
- en: The number of users signed up in the last 3 months (that is, new users)
  id: totrans-239
  prefs:
  - PREF_IND
  - PREF_OL
  type: TYPE_NORMAL
  zh: 在过去3个月内注册的用户数量（即新用户）
- en: The number of new users that logged in to the system in the last 30 days
  id: totrans-240
  prefs:
  - PREF_IND
  - PREF_OL
  type: TYPE_NORMAL
  zh: 在过去30天内登录系统的新的用户数量
- en: The number of new users who bought at least one item in the last 30 days
  id: totrans-241
  prefs:
  - PREF_IND
  - PREF_OL
  type: TYPE_NORMAL
  zh: 在过去30天内至少购买了一件商品的新的用户数量
- en: The number can be collected and aggregated from either application log messages
    or from persistent databases directly.
  id: totrans-242
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: 这些数据可以从应用程序日志消息或直接从持久数据库中收集和汇总。
- en: An example of comprehensive metrics – DORA
  id: totrans-243
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: 全面指标的示例 – DORA
- en: Measuring metrics can be an anti-pattern if there’s a way to game the numbers
    but not improve anything. For example, if the metrics are only about service uptime,
    then it’s possible to have 100% uptime for services that can’t perform any operation
    other than answering health checks.
  id: totrans-244
  prefs: []
  type: TYPE_NORMAL
  zh: 如果有操纵数字的方法但无法改善任何东西，衡量指标可能成为一种反模式。例如，如果指标仅关于服务正常运行时间，那么对于只能执行健康检查之外的操作的服务，可能实现100%的正常运行时间。
- en: It’s important to have a comprehensive suite of metrics to close this loophole.
    If multiple metrics measure various aspects of the subject, gaming one metric
    would skew the others and therefore be impossible to hide. In this section, we’re
    going to run through an example of comprehensive metrics and how they avoid cheating.
  id: totrans-245
  prefs: []
  type: TYPE_NORMAL
  zh: 拥有一个全面的指标套件来填补这个漏洞是很重要的。如果多个指标衡量主题的各个方面，操纵一个指标就会扭曲其他指标，因此不可能隐藏。在本节中，我们将通过一个全面指标示例以及它们如何避免作弊来进行分析。
- en: '**DevOps Research and Assessment** (**DORA**) metrics are a set of KPIs to
    ensure the effectiveness and efficiency of software development and delivery processes.
    These metrics help organizations understand their DevOps performance and identify
    areas for improvement. The four primary DORA metrics are as follows:'
  id: totrans-246
  prefs: []
  type: TYPE_NORMAL
  zh: '**DevOps研究和评估**（DORA）指标是一组KPIs，以确保软件开发和交付过程的有效性和效率。这些指标帮助组织了解其DevOps绩效并确定改进领域。四个主要的DORA指标如下：'
- en: '**Deployment frequency**: How often a production release has succeeded. A higher
    frequency indicates a higher velocity and responsive development process.'
  id: totrans-247
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '**部署频率**：生产发布成功发生的频率。更高的频率表明更高的速度和响应式开发过程。'
- en: '**Lead time for changes**: The time taken between committing code to production.
    Shorter lead times represent a more efficient development pipeline.'
  id: totrans-248
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '**变更的领先时间**：将代码提交到生产所需的时间。较短的领先时间代表更高效的开发流程。'
- en: '**Change failure rate**: The percentage of deployments that cause a failure
    in production. Lower rates indicate more stable and reliable releases.'
  id: totrans-249
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '**变更失败率**：导致生产中失败的部署的百分比。较低的比率表明发布更稳定、更可靠。'
- en: '**Mean time to recovery (MTTR)**: The average time taken to recover from a
    failure in production. Faster recovery times indicate better incident response
    and resilience.'
  id: totrans-250
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '**平均恢复时间（MTTR）**：从生产中的故障恢复的平均时间。更快的恢复时间表明更好的事件响应和弹性。'
- en: Any attempt to game one of these metrics would be detected by another. For instance,
    if development skips running tests, the lead time for change will decrease, but
    the change failure rate will increase due to lack of testing.
  id: totrans-251
  prefs: []
  type: TYPE_NORMAL
  zh: 任何试图操纵这些指标的行为都会被其他指标检测到。例如，如果开发跳过运行测试，变更的领先时间会减少，但由于缺乏测试，变更失败率会增加。
- en: 'The DORA team has also developed **SPACE** metrics, which provide a holistic
    perspective of engineering productivity in addition to software delivery efficiency.
    Let’s see what SPACE stands for:'
  id: totrans-252
  prefs: []
  type: TYPE_NORMAL
  zh: DORA团队还开发了**SPACE**指标，除了软件交付效率外，还提供了对工程生产力的全面视角。让我们看看SPACE代表什么：
- en: '**Satisfaction**: This is a quantitative and qualitative measurement of how
    satisfied engineers are with their work, work-life balance, and tools'
  id: totrans-253
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '**满意度**：这是对工程师对其工作、工作与生活平衡和工具满意度的定量和定性测量'
- en: '**Performance**: This specifies the quality, effectiveness, and impact of the
    software that’s been delivered'
  id: totrans-254
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '**性能**：这指定了已交付软件的质量、有效性和影响'
- en: '**Activity**: The volume of activities that have contributed to the completion
    of work – for example, the number of commits and pull requests'
  id: totrans-255
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '**活动量**：对工作完成有贡献的活动量——例如，提交和拉取请求的数量'
- en: '**Communication and collaboration**: This involves evaluating the effectiveness
    of team meetings, cross-team cooperation, and collaborative tools'
  id: totrans-256
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '**沟通与协作**：这涉及到评估团队会议、跨团队合作和协作工具的有效性'
- en: '**Efficiency**: This measures how time, effort, and tools are effectively utilized
    for desired outcomes, delivery, and waste reduction'
  id: totrans-257
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '**效率**：这衡量了时间、努力和工具如何有效利用以达到预期结果、交付和减少浪费'
- en: SPACE metrics are designed to cover many angles of team productivity, as well
    as to avoid any metric from being manipulated by having other metrics detect it.
    For instance, having excessive meetings might have boosted the volume of activity,
    but the lack of effectiveness will be caught by evaluating communication and collaboration.
  id: totrans-258
  prefs: []
  type: TYPE_NORMAL
  zh: SPACE指标旨在涵盖团队生产力的多个角度，以及避免任何指标被其他指标操纵。例如，过多的会议可能会增加活动量，但缺乏有效性将通过评估沟通和协作而被捕捉到。
- en: DORA and SPACE are complementary and can be measured at the same time to provide
    an all-rounded insight into the health of the team and its delivery of software
    products.
  id: totrans-259
  prefs: []
  type: TYPE_NORMAL
  zh: DORA和SPACE是互补的，可以同时测量，以提供对团队健康及其软件产品交付的全面洞察。
- en: Good metrics should come as a comprehensive suite to provide a greater perspective
    of the organization’s performance.
  id: totrans-260
  prefs: []
  type: TYPE_NORMAL
  zh: 良好的指标应该作为一个综合套件提供，以提供对组织绩效的更全面视角。
- en: Automated alerting and incident management
  id: totrans-261
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 自动警报和事件管理
- en: Having a visual dashboard that shows metrics is nice, but when it comes to detecting
    system faults and raising alerts, an organization can’t rely on human eyes. There
    should be automated alerts and a well-defined workflow of incident management
    so that the organization can recover the system as quickly as possible.
  id: totrans-262
  prefs: []
  type: TYPE_NORMAL
  zh: 拥有一个显示指标的视觉仪表板是好的，但当涉及到检测系统故障和发出警报时，组织不能依赖于人类的眼睛。应该有自动警报和定义良好的事件管理流程，以便组织能够尽快恢复系统。
- en: We must establish mechanisms for real-time alerting and incident management
    so that we can rapidly respond and resolve problems that arise in the distributed
    system.
  id: totrans-263
  prefs: []
  type: TYPE_NORMAL
  zh: 我们必须建立实时警报和事件管理的机制，以便我们能够快速响应并解决分布式系统中出现的问题。
- en: 'Monitoring tools allow the organization to trigger alerts under various conditions:'
  id: totrans-264
  prefs: []
  type: TYPE_NORMAL
  zh: 监控工具允许组织在多种条件下触发警报：
- en: Resource utilization is too high (for example, more than 90% CPU usage over
    10 minutes)
  id: totrans-265
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 资源利用率过高（例如，10分钟内CPU使用率超过90%）
- en: The given metric has exceeded the threshold (for example, there were more than
    20 HTTP responses with status code `400` in the last 5 minutes)
  id: totrans-266
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 给定的指标已超过阈值（例如，在过去的5分钟内有超过20个状态码为`400`的HTTP响应）
- en: When security threats or anomalies are detected, such as unauthorized access
    attempts
  id: totrans-267
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 当检测到安全威胁或异常，例如未经授权的访问尝试
- en: A bespoke error log pattern is detected (for example, an error log message such
    as “Unable to authorize payment” has been detected)
  id: totrans-268
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 检测到定制的错误日志模式（例如，检测到错误日志消息“无法授权支付”）
- en: The workflow for incident management varies in every organization. Some organizations
    have dedicated round-the-clock support teams that respond to incidents, while
    others have engineers to act as support persons on a rotational basis. Additionally,
    some organizations have three levels of escalation in case a major incident can’t
    be solved immediately.
  id: totrans-269
  prefs: []
  type: TYPE_NORMAL
  zh: 事件管理流程在每个组织中都不同。一些组织有专门的24小时支持团队来响应事件，而其他组织则有工程师轮流担任支持人员。此外，一些组织在重大事件无法立即解决的情况下设有三个级别的升级。
- en: There are no golden incident management procedures, but there are principles
    of incident management that should be considered.
  id: totrans-270
  prefs: []
  type: TYPE_NORMAL
  zh: 没有黄金事件管理程序，但有一些事件管理原则应该考虑。
- en: '**Establish and document the incident management workflow**: The workflow needs
    to be defined and documented so that the people involved in incident management
    have a process to follow.'
  id: totrans-271
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '**建立并记录事件管理流程**：该流程需要被定义和记录，以便参与事件管理的人员有一个遵循的过程。'
- en: '**Implement communication channels**: It’s recommended to have a dedicated
    instant messaging channel for each incident so that you have relevant and focused
    collaboration among people. Emails and phone calls should be used for notification
    purposes because they don’t have a well-structured conversation format. Other
    people joining later in the investigation process will find it difficult to follow.'
  id: totrans-272
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '**实施沟通渠道**：建议为每个事件设立一个专门的即时通讯渠道，以便在人员之间进行相关且专注的协作。电子邮件和电话应用于通知目的，因为它们没有良好的结构化对话格式。后来加入调查过程的其他人员会发现很难跟进。'
- en: Moreover, the instant messaging channel has built-in timestamps and participant
    identifications, which are useful for compiling the communication section of an
    incident report.
  id: totrans-273
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: 此外，即时通讯渠道内置了时间戳和参与者识别，这对于编制事件报告的沟通部分很有用。
- en: '**Document the journey for each incident**: It’s important to document each
    incident to capture the findings of the problem, the troubleshooting journey,
    the resolution of the problem, and the communication during the incident. This
    is useful for internal improvement, audit, and regulatory requirements. The incident
    report should also be standardized to allow for comparisons and further analysis.'
  id: totrans-274
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '**记录每个事件的过程**：记录每个事件很重要，以捕捉问题的发现、故障排除过程、问题的解决以及事件期间的沟通。这对于内部改进、审计和监管要求很有用。事件报告也应标准化，以便进行比较和进一步分析。'
- en: '**Conduct follow-up meetings**: There are three other known names for this
    type of meeting: **after-action review** (**AAR**), post-mortem, and autopsy meeting.
    The purpose of this meeting is to review and replay the incident, identify what
    was learned from this incident, and discuss preventative measures and any potential
    improvements (processes, communication, tooling, and so on).'
  id: totrans-275
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '**进行后续会议**：这种类型的会议还有三个其他已知名称：**事后审查**（AAR）、尸检和尸检会议。这次会议的目的是回顾和重放事件，确定从这次事件中学到了什么，并讨论预防措施和任何潜在的改进（流程、沟通、工具等）。'
- en: The action items from this meeting are prioritized in the backlog of the responsible
    teams and are linked to the incident to motivate the change.
  id: totrans-276
  prefs: []
  type: TYPE_NORMAL
  zh: 这次会议的行动项目被优先考虑并纳入负责团队的待办事项列表中，并与事件相关联，以激励变革。
- en: 'An example workflow for incident management is shown in *Figure 11**.3*:'
  id: totrans-277
  prefs: []
  type: TYPE_NORMAL
  zh: 事件管理的示例工作流程展示在*图11.3*中：
- en: '![Figure 11.3 – An example workflow for incident management](img/B21737_11_3.jpg)'
  id: totrans-278
  prefs: []
  type: TYPE_IMG
  zh: '![图11.3 – 事件管理示例工作流程](img/B21737_11_3.jpg)'
- en: Figure 11.3 – An example workflow for incident management
  id: totrans-279
  prefs: []
  type: TYPE_NORMAL
  zh: 图11.3 – 事件管理示例工作流程
- en: 'In this diagram, multiple sources can report an incident that occurred. The
    support person is informed by the incident management tool via email, phone, instant
    message, or a phone application. The support person triages the incident by finding
    the answers to the following questions:'
  id: totrans-280
  prefs: []
  type: TYPE_NORMAL
  zh: 在这个图中，多个来源可以报告发生的事件。支持人员通过电子邮件、电话、即时消息或电话应用程序由事件管理工具通知。支持人员通过回答以下问题对事件进行分类：
- en: Is it an actual incident or just a false alarm?
  id: totrans-281
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 这是不是一个实际的事件，还是只是一个误报？
- en: Which business area is impacted?
  id: totrans-282
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 哪个业务区域受到影响？
- en: Who’s impacted by this incident?
  id: totrans-283
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 哪些人受到这次事件的影响？
- en: How severely is the business area impacted?
  id: totrans-284
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 业务区域受到的影响有多严重？
- en: Which team is responsible for the impacted business area?
  id: totrans-285
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 哪个团队负责受影响的业务领域？
- en: Does it need to be fixed immediately?
  id: totrans-286
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 是否需要立即修复？
- en: If the incident turns out to be a false alarm, the incident is resolved. If
    it’s an actual incident but doesn’t require an immediate fix, then the incident
    will be picked up by the responsible team the next working day.
  id: totrans-287
  prefs: []
  type: TYPE_NORMAL
  zh: 如果事件最终证明是误报，则事件得到解决。如果它是实际事件但不需要立即修复，则事件将在下一个工作日由负责团队处理。
- en: If the incident is major or substantial, then a second-level support person
    from the responsible team is involved to start the investigation immediately.
    During this stage, the investigation could escalate, depending on the progress
    of the investigation. Sometimes, another team needs to be involved, or a big decision
    needs to be made by upper management. Once the fix has been applied and verified,
    the incident is resolved.
  id: totrans-288
  prefs: []
  type: TYPE_NORMAL
  zh: 如果事件重大或严重，那么负责团队的第二级支持人员将介入，立即开始调查。在此阶段，调查可能会根据调查进展而升级。有时，需要另一支团队介入，或者需要上级管理层做出重大决策。一旦修复方案被应用并验证，事件即得到解决。
- en: If the system is mission-critical, it’s worth considering an enterprise incident
    management system that supports escalation policies, rotational support management,
    communication channels, automatic reporting, and backlog ticket integration.
  id: totrans-289
  prefs: []
  type: TYPE_NORMAL
  zh: 如果系统是关键任务系统，那么考虑一个支持升级策略、轮换支持管理、通信渠道、自动报告和待办事项票证集成的企业级事件管理系统是值得的。
- en: Improvements in incident management are often made after an incident has occurred.
    It’s important for an organization to continuously learn and improve its incident
    management process.
  id: totrans-290
  prefs: []
  type: TYPE_NORMAL
  zh: 事件管理改进通常是在事件发生后进行的。对于组织来说，持续学习和改进其事件管理流程非常重要。
- en: Summary
  id: totrans-291
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 摘要
- en: In this chapter, we walked through the importance of auditing and monitoring.
    We emphasized the importance of measuring systems to avoid organizations going
    into the vicious cycle of opinion-based decision-making. A few exceptions of not
    needing auditing and monitoring were mentioned.
  id: totrans-292
  prefs: []
  type: TYPE_NORMAL
  zh: 在本章中，我们探讨了审计和监控的重要性。我们强调了测量系统的重要性，以避免组织陷入基于意见的决策的恶性循环。提到了一些不需要审计和监控的例外情况。
- en: We also identified a few challenges when auditing and monitoring distributed
    systems. After highlighting the challenges we faced, we started to cover the key
    aspects of auditing and monitoring.
  id: totrans-293
  prefs: []
  type: TYPE_NORMAL
  zh: 我们还确定了在审计和监控分布式系统时遇到的几个挑战。在突出我们面临的挑战后，我们开始涵盖审计和监控的关键方面。
- en: The data that’s captured for auditing and monitoring is different. A sample
    of the audit trail was demonstrated by Kotlin code so that we could cover the
    various types of data available for monitoring.
  id: totrans-294
  prefs: []
  type: TYPE_NORMAL
  zh: 用于审计和监控的数据是不同的。我们通过Kotlin代码演示了审计跟踪的样本，以便我们能够涵盖可用于监控的各种类型的数据。
- en: Next, the best practices for application-level logging were demonstrated through
    the use of sample code and a few logging frameworks. The techniques of structured
    logging and contextual logging were covered.
  id: totrans-295
  prefs: []
  type: TYPE_NORMAL
  zh: 接着，我们通过示例代码和一些日志框架展示了应用级日志的最佳实践。我们涵盖了结构化日志和上下文日志的技术。
- en: Afterward, we moved on to the aspect of centralizing and aggregating auditing
    and monitoring data. The approach of the standard envelope and discoverable topics
    for audit trails were presented. We also mentioned multiple approaches for collecting
    monitoring data.
  id: totrans-296
  prefs: []
  type: TYPE_NORMAL
  zh: 之后，我们转向集中和汇总审计和监控数据方面。我们提出了标准封套和可发现主题的审计跟踪方法。我们还提到了收集监控数据的多种方法。
- en: 'Then, we identified two levels of metrics: the service level and the business
    level. We covered how a qualitative goal can be translated into quantitative measurable
    metrics and used **DORA** metrics as an example of a comprehensive suite of metrics
    to prevent the gaming of metrics.'
  id: totrans-297
  prefs: []
  type: TYPE_NORMAL
  zh: 然后，我们确定了两个级别的指标：服务级别和业务级别。我们介绍了如何将定性目标转化为可量化的指标，并以**DORA**指标作为一个综合指标套件的例子，以防止指标游戏化。
- en: Finally, we discussed the aspects of automated alerting and incident management.
    We presented a sample workflow of incident management to illustrate the importance
    of appropriate tooling, effective communication, and documentation.
  id: totrans-298
  prefs: []
  type: TYPE_NORMAL
  zh: 最后，我们讨论了自动化警报和事件管理的方面。我们展示了事件管理的一个示例工作流程，以说明适当工具、有效沟通和文档的重要性。
- en: The next chapter will cover the performance and scalability aspects of software
    systems.
  id: totrans-299
  prefs: []
  type: TYPE_NORMAL
  zh: 下一章将涵盖软件系统的性能和可扩展性方面。
