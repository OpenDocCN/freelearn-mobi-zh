# 第二章：*第二章*：理解测试驱动开发

现在我们已经了解了单元测试是什么以及它们如何有助于开发，我们将学习**测试驱动开发**（**TDD**）。

在向您介绍 TDD 的起源和目标之后，我们将继续前进，看看它的利弊。到本章结束时，你将清楚地了解 TDD 的相关性以及可以使用它测试什么。

本章我们将涵盖的主要内容包括：

+   TDD 的起源

+   TDD 工作流程

+   TDD 的优势

+   TDD 的缺点

+   要测试什么

# TDD 的起源

1996 年，Kent Beck、Ward Cunningham 和 Ron Jeffries 在克莱斯勒公司进行*综合薪酬系统*项目时，引入了一种新的软件开发方法论，称为**极限编程**。单词*极限*表明，极限编程背后的概念与当时软件开发的观念完全不同。对于许多人来说，这些概念即使在今天听起来也有些极端。

该方法论基于 12 条规则或实践。其中一条规则指出，开发者必须编写单元测试，并且软件的所有部分都必须经过彻底的测试。在软件（或新功能）可以发布给客户之前，所有测试都必须通过。测试应该在它们所测试的生产代码之前编写。

这种所谓的“测试驱动编程”导致了 TDD。正如其名所示，在 TDD 中，测试驱动开发。这意味着开发者只有在有失败的测试时才会编写代码。测试决定了代码是否需要编写，它们还提供了一个衡量标准，以确定一个功能是否“完成”——当所有该功能的测试都通过时，它就算完成了。

如果你之前没有做过任何 TDD，这可能会让你觉得有些荒谬。你必须尝试并坚持一段时间，以看到其优势，并认识到它并不荒谬，而是一种相当聪明的做法。在 TDD 中，你总是专注于你正在构建的产品的一个功能。由于你有所有之前构建的功能的测试，你不必记住其余代码的细节。你可以信任现有的测试，并且不会破坏之前已经工作的东西。

由于每次只关注一个功能，你几乎总是会有一个可以工作的软件片段。所以，当你的老板走进你的办公室并要求你展示项目的当前状态时，你只需几分钟就能展示一个可展示的（即编译的）并且经过彻底测试的软件片段。

现在我们已经知道了 TDD 的含义，让我们来看看其工作流程。

# TDD 工作流程 – 红色、绿色、重构

TDD 的正常工作流程包括三个步骤 – *红色*、*绿色*、*重构*。以下各节将详细描述这些步骤。

## 红色

你从编写一个失败的测试开始。它需要测试软件产品中尚未实现的功能或你想要确保覆盖的边缘情况。红色这个名字来源于大多数 IDE 指示失败测试的方式。Xcode 使用带有白色 x 的红色菱形，如下图所示：

![图 2.1 – Xcode 在红色菱形中用白色叉号标记失败测试](img/Figure_2.01_B18127.jpg)

图 2.1 – Xcode 在红色菱形中用白色叉号标记失败测试

在这个步骤中编写的测试最初失败非常重要。否则，你无法确保测试正常工作并真正测试你想要实现的功能。可能你编写了一个总是通过且因此无用的测试。或者，可能该功能已经实现。无论如何，你都能对你的代码有更深入的了解。

## 绿色

在绿色步骤中，你编写最简单的代码以使测试通过。你编写的代码是否良好和整洁并不重要。代码也可以很愚蠢，甚至错误。只要所有测试都通过就足够了。绿色这个名字指的是大多数 IDE 如何指示通过测试。Xcode 使用带有白色勾号的绿色菱形。

![图 2.2 – Xcode 在绿色菱形中用白色勾号标记通过测试](img/Figure_2.02_B18127.jpg)

图 2.2 – Xcode 在绿色菱形中用白色勾号标记通过测试

尝试编写最简单的代码以使测试通过非常重要。通过这样做，你只编写你真正需要的代码，这是可能的最简单实现。当我提到简单时，我的意思是它应该易于阅读、理解和修改。测试代码应该始终易于理解。尝试编写你的测试，即使你已经几个月没有工作过，你也能理解它们。当测试失败时，通常是在你做完全不同的事情时。清晰易懂的测试帮助你快速找到问题并回到你正在工作的上下文中。

通常，最简单的实现可能不足以实现你试图实现的功能，但仍然足以使所有测试通过。这仅仅意味着你需要另一个失败的测试来进一步推动该功能的开发。

## 重构

在绿色步骤中，你只需编写足够的代码再次使所有测试通过。正如我刚才提到的，绿色步骤中的代码看起来如何并不重要。在重构步骤中，你改进代码。你移除重复，提取公共值，等等。做你需要做的事情，使代码尽可能好。测试帮助你避免在重构过程中破坏已实现的功能。

重要提示

不要跳过这个步骤。始终尝试思考在实现功能后如何改进代码。这样做有助于保持代码的整洁和可维护性。这确保了它始终保持良好的状态。

由于自上次重构步骤以来你只编写了几行代码，因此使代码变得整洁所需的变化不应花费太多时间。

# TDD 的优点

TDD 具有优点和缺点。以下是主要优点：

+   **只编写所需的代码**：当所有测试通过且你无法再想出另一个测试来编写时，你应该停止编写生产代码。如果你的项目需要另一个功能，你需要一个测试来驱动该功能的实现。你编写的代码是最简单的代码。因此，最终产品中的所有代码实际上都是实现功能所需的。

+   **更模块化的设计**：在 TDD 中，你一次专注于一个微功能。由于你首先编写测试，代码自然会变得易于测试。易于测试的代码具有清晰的接口。这导致你的应用程序具有模块化设计。

+   **更容易维护**：由于你的应用程序的不同部分彼此解耦并且具有清晰的接口，代码变得更容易维护。你可以用更好的实现来替换微功能的实现，而不会影响另一个模块。你甚至可以保留测试并重写整个应用程序。当所有测试通过时，你就完成了。

+   **更容易重构**：每个功能都经过彻底测试。你不必害怕做出重大改变，因为如果所有测试仍然通过，一切都会好。这一点非常重要，因为作为开发者，你每天都在提高自己的技能。如果你在六个月后重新打开项目，你很可能会有很多改进代码的想法。但你对所有不同部分以及它们如何组合的记忆可能已经不再新鲜。因此，做出改变可能是危险的。有了完整的测试套件，你可以轻松地改进代码，而不用担心破坏你的应用程序。

+   **高测试覆盖率**：每个功能都有一个测试。这导致高测试覆盖率。高测试覆盖率有助于你对自己的代码建立信心。

+   **测试记录了代码**：测试代码显示了你的代码应该如何使用。因此，它记录了你的代码。测试代码是示例代码，显示了代码的功能以及接口应该如何使用。

+   **更少的调试**：你有多少次浪费一整天来寻找一个讨厌的虫子？你有多少次从 Xcode 复制错误信息并在互联网上搜索它？在 TDD 中，你编写的错误更少，因为测试会尽早告诉你是否犯了错误。你编写的错误发现得也早。当你的记忆仍然清晰关于代码应该做什么以及它是如何做的时，你可以专注于修复错误。

在下一节中，我们将讨论 TDD 的缺点。

# TDD 的缺点

正如世界上的一切事物一样，TDD 也有一些缺点。主要缺点如下：

+   **没有银弹**：测试有助于发现错误，但它们不能发现你在测试代码和实现代码中引入的所有错误。如果你没有理解你需要解决的问题，编写测试很可能会帮不上忙。

+   **一开始似乎更慢**：当你开始使用 TDD 时，你会感觉到实现简单的功能需要更长的时间。在最终开始编写代码之前，你需要思考接口、编写测试代码并运行测试。

+   **团队中的所有成员都需要这样做**：由于 TDD 影响代码的设计，建议团队的所有成员都使用 TDD，或者根本不使用。此外，有时很难向管理层证明 TDD 的合理性，因为他们常常有一种感觉，即如果开发者编写的代码有一半的时间不会最终进入产品，那么实现新功能会花费更长的时间。如果整个团队都同意单元测试的重要性，这会有所帮助。

+   **当需求变化时，测试需要维护**：可能反对 TDD 的最有力的论据是，测试的维护工作就像代码的维护工作一样。每当需求发生变化时，你需要更改代码和测试。但是你正在使用 TDD。这意味着你需要首先更改测试，然后让测试通过。所以，实际上，测试帮助你理解新的需求，并在不破坏其他功能的情况下实现代码。

初学者经常询问他们应该为代码的哪一部分编写测试。接下来的部分试图找到这个问题的答案。

# 要测试什么

应该测试什么？在使用 TDD 并遵循其理念时，答案很简单——一切。你只编写生产代码，因为有一个失败的测试。

在实践中，这并不那么容易。例如，按钮的位置和颜色是否需要测试？视图层次结构是否需要测试？可能不需要；按钮的颜色和确切位置对于应用程序的功能并不重要。在开发的早期阶段，这类事情往往会发生变化。随着自动布局、不同的屏幕尺寸和应用程序的不同本地化，按钮和标签的确切位置取决于许多参数。

通常，你应该测试那些使应用程序对用户有用的功能和那些需要工作的功能。用户并不关心按钮是否正好位于屏幕最右侧边缘 20 点处。用户寻求的是易于理解且使用愉快的应用程序。

除了这个之外，你不应该一次性使用单元测试来测试整个应用。单元测试的目的是测试计算的小单元。它们需要快速且可靠。像数据库访问和网络这样的东西应该使用集成测试来测试，在集成测试中，测试驱动着真正的完成应用。集成测试可以允许运行得慢，因为它们比单元测试运行得少得多。通常，它们会在服务器上每晚通过持续集成系统运行，而完整的测试套件需要几分钟（甚至几个小时）来执行并不重要。

# 摘要

在本章中，我们初步涉入了 TDD 的新领域。本章展示了 TDD 的工作流程——红、绿、重构——我们将在这本书中用它来构建应用。此外，我们还看到了 TDD 的优点和缺点。

在接下来的章节中，我们将探讨在 Xcode 中如何进行 TDD，这是我们大多数人用来构建 iOS 应用的工具。
