<html><head></head><body><div class="chapter" title="Chapter&#xA0;4.&#xA0;Data Management"><div class="titlepage"><div><div><h1 class="title"><a id="ch04"/>Chapter 4. Data Management</h1></div></div></div><p>In this chapter, we will cover the following topics:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">Creating files</li><li class="listitem" style="list-style-type: disc">Creating an SQLite database</li><li class="listitem" style="list-style-type: disc">Inserting and updating data</li><li class="listitem" style="list-style-type: disc">Querying an SQLite database</li><li class="listitem" style="list-style-type: disc">Using an already existing SQLite database</li><li class="listitem" style="list-style-type: disc">Storing data with serialization</li><li class="listitem" style="list-style-type: disc">Storing data with XML</li><li class="listitem" style="list-style-type: disc">Managing XML data with LINQ to XML</li></ul></div><div class="section" title="Introduction"><div class="titlepage"><div><div><h1 class="title"><a id="ch04lvl1sec01"/>Introduction</h1></div></div></div><p>Almost every application needs to have permanent data storage on the filesystem. In this chapter, we will discuss different ways of storing data. We will see how to create an SQLite database and manage data with it from within an iPhone application. Also, we will learn how to use an already existing database in a project.</p><p>SQLite (<a class="ulink" href="http://www.sqlite.org">http://www.sqlite.org
</a>) is a self-contained transactional database system. Each database is saved in a standalone file, and there is no database server. In iOS, SQLite support is native.<a id="id347" class="indexterm"/>
</p><p>Next, we will see how to serialize and save objects to the filesystem and how to use XML files with LINQ to XML.</p></div></div>
<div class="section" title="Creating files"><div class="titlepage"><div><div><h1 class="title"><a id="ch04lvl1sec02"/>Creating files</h1></div></div></div><p>In this recipe, we will learn how to create files on the filesystem of iOS devices.<a id="id348" class="indexterm"/>
</p><div class="section" title="Getting ready"><div class="titlepage"><div><div><h2 class="title"><a id="ch04lvl2sec01"/>Getting ready</h2></div></div></div><p>Create a new<span class="strong"><strong> iPhone Single View Application</strong></span> project in MonoDevelop. Name it<code class="literal"> FileCreationApp</code>. Open the<code class="literal"> FileCreationAppViewController.xib</code> file, and add a<code class="literal"> UILabel</code> and a<code class="literal"> UIButton</code> on its view.<a id="id349" class="indexterm"/>
</p></div><div class="section" title="How to do it..."><div class="titlepage"><div><div><h2 class="title"><a id="ch04lvl2sec02"/>How to do it...</h2></div></div></div><p>Enter the following code in the<code class="literal"> FileCreationAppViewController</code> class:<a id="id350" class="indexterm"/>
</p><div class="informalexample"><pre class="programlisting">public override void ViewDidLoad(){
string filePath = Path.Combine (Environment.GetFolderPath (Environment.SpecialFolder.Personal), "MyFile.txt");
using (StreamWriter sw = new StreamWriter (filePath)){
sw.WriteLine ("Some text in file!");
}
this.btnShow.TouchUpInside += delegate {
using (StreamReader sr = new StreamReader (filePath)){
this.labelMessage.Text = sr.ReadToEnd ();
}
}
};
</pre></div></div><div class="section" title="How it works..."><div class="titlepage"><div><div><h2 class="title"><a id="ch04lvl2sec03"/>How it works...</h2></div></div></div><p>As one can see from this code, we can use standard classes from the<code class="literal"> System.IO</code> namespace, just like in desktop applications. The first thing we do is to set a path for the file we will save. We do this in the following line:</p><div class="informalexample"><pre class="programlisting">string filePath = Path.Combine (Environment.GetFolderPath (Environment.SpecialFolder.Personal), "MyFile.txt");
</pre></div><p>In iOS, we do not have access to the whole filesystem, not even inside the application bundle. An exception will occur if we try to write inside a folder we do not have access to. So, we use the static<code class="literal"> Environment.GetFolderPath(SpecialFolder)</code> method and retrieve the<code class="literal"> Personal</code> special folder, which corresponds to our application's<code class="literal"> Documents</code> folder. Note the use of<code class="literal"> Path.Combine(string, string)</code>, which combines two strings and returns a path. After that, we create a new instance of the<code class="literal"> StreamWriter</code> class and write some text in the file with its<code class="literal"> WriteLine(string)</code> method.<a id="id351" class="indexterm"/>
</p><div class="informalexample"><pre class="programlisting">using (StreamWriter sw = new StreamWriter (filePath)){
sw.WriteLine ("Some text in file!");
}
</pre></div><p>To retrieve the text from the file, we create a new instance of the<code class="literal"> StreamReader</code> class and read the text with its<code class="literal"> ReadLine</code> method:<a id="id352" class="indexterm"/>
</p><div class="informalexample"><pre class="programlisting">using (StreamReader sr = new StreamReader (filePath)){
this.labelMessage.Text = sr.ReadToEnd ();
}
</pre></div></div><div class="section" title="There's more..."><div class="titlepage"><div><div><h2 class="title"><a id="ch04lvl2sec04"/>There's more...</h2></div></div></div><p>If we want to write or read binary data, we can use the<code class="literal"> FileStream</code> class.<a id="id353" class="indexterm"/>
</p><div class="section" title="Documents Folder"><div class="titlepage"><div><div><h3 class="title"><a id="ch04lvl3sec01"/>Documents Folder</h3></div></div></div><p>An application's<code class="literal"> Documents</code> folder is relevant to the application alone. If the application is uninstalled from the device, its contents are also removed. We have both read and write access in this folder.<a id="id354" class="indexterm"/>
</p></div></div><div class="section" title="See also"><div class="titlepage"><div><div><h2 class="title"><a id="ch04lvl2sec05"/>See also</h2></div></div></div><p>In this chapter:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><span class="emphasis"><em>Storing data with serialization</em></span></li></ul></div></div></div>
<div class="section" title="Creating an SQLite database"><div class="titlepage"><div><div><h1 class="title"><a id="ch04lvl1sec03"/>Creating an SQLite database</h1></div></div></div><p>In this recipe, we will learn how to create an SQLite database file.<a id="id355" class="indexterm"/>
</p><div class="section" title="Getting ready"><div class="titlepage"><div><div><h2 class="title"><a id="ch04lvl2sec06"/>Getting ready</h2></div></div></div><p>Create a new<span class="strong"><strong> iPhone Single View Application</strong></span> in MonoDevelop, and name it<code class="literal"> CreateSQLiteApp</code>. Add a<code class="literal"> UILabel</code> and a<code class="literal"> UIButton</code> on its view.<a id="id356" class="indexterm"/>
</p></div><div class="section" title="How to do it..."><div class="titlepage"><div><div><h2 class="title"><a id="ch04lvl2sec07"/>How to do it...</h2></div></div></div><div class="orderedlist"><ol class="orderedlist"><li class="listitem"> Add a reference to the project to the assembly<code class="literal"> Mono.Data.Sqlite</code> and the corresponding<code class="literal"> using</code> directive on the namespace:<div class="informalexample"><pre class="programlisting">using Mono.Data.Sqlite;
</pre></div></li><li class="listitem"> Enter the following method in the<code class="literal"> CreateSQLiteAppViewController</code> class:<a id="id357" class="indexterm"/><div class="informalexample"><pre class="programlisting">private void CreateSQLiteDatabase (string databaseFile){
try{
if (!File.Exists (databaseFile)){
SqliteConnection.CreateFile (databaseFile);
using (SqliteConnection sqlCon = new SqliteConnection (String.Format ("Data Source = {0};", databaseFile))){
sqlCon.Open ();
using (SqliteCommand sqlCom = new SqliteCommand (sqlCon)){
sqlCom.CommandText = "CREATE TABLE Customers (ID INTEGER PRIMARY KEY, FirstName VARCHAR(20), LastName VARCHAR(20))";
sqlCom.ExecuteNonQuery ();
}
sqlCon.Close ();
}
this.lblMessage.Text = "Database created!";
} else {
this.lblMessage.Text = "Database already exists!";
}
} catch (Exception ex) {
this.lblMessage.Text = String.Format ("Sqlite error: {0}", ex.Message);
}
}
</pre></div></li><li class="listitem"> And add the following code in the<code class="literal"> ViewDidLoad</code> method:<a id="id358" class="indexterm"/><div class="informalexample"><pre class="programlisting">string sqlitePath = Path.Combine (Environment.GetFolderPath (Environment.SpecialFolder.Personal), "MyDB.db3");
this.btnCreate.TouchUpInside += delegate {
this.CreateSQLiteDatabase (sqlitePath);
};
</pre></div></li></ol></div><div class="section" title="How it works..."><div class="titlepage"><div><div><h3 class="title"><a id="ch04lvl2sec08"/>How it works...</h3></div></div></div><p>iOS provides native support for SQLite databases.</p><div class="orderedlist"><ol class="orderedlist"><li class="listitem"> We can access SQLite databases with Mono's<code class="literal"> Mono.Data.Sqlite</code> namespace, as follows:<div class="informalexample"><pre class="programlisting">using Mono.Data.Sqlite;
</pre></div></li><li class="listitem"> Inside the<code class="literal"> CreateSQLiteDatabase</code> method, we first check if the file already exists:<a id="id359" class="indexterm"/><div class="informalexample"><pre class="programlisting">if (!File.Exists (databaseFile))
</pre></div></li><li class="listitem"> Then, we can continue with the creation of the database. We first create the file with the<code class="literal"> SqliteConnection.CreateFile(string)</code> static method, as follows:<a id="id360" class="indexterm"/><div class="informalexample"><pre class="programlisting">SqliteConnection.CreateFile (databaseFile);
</pre></div></li><li class="listitem"> We connect to the newly created file by initializing an<code class="literal"> SqliteConnection</code> object and calling its<code class="literal"> Open()</code> method. The connection string for an SQLite database is<code class="literal"> Data Source =</code>, followed by the filename of the database:<a id="id361" class="indexterm"/><div class="informalexample"><pre class="programlisting">using (SqliteConnection sqlCon = new SqliteConnection (String.Format ("Data Source = {0};", databaseFile)))
sqlCon.Open();
</pre></div></li><li class="listitem"> To create a table in the database, an<code class="literal"> SqliteCommand</code> object is initialized. We pass a standard SQL string to its<code class="literal"> CommandText</code> property, and call the<code class="literal"> ExecuteNonQuery()</code> method to execute the SQL:<a id="id362" class="indexterm"/><div class="informalexample"><pre class="programlisting">sqlCom.CommandText = "CREATE TABLE Customers (ID INTEGER PRIMARY KEY, FirstName VARCHAR(20), LastName VARCHAR(20))";
sqlCom.ExecuteNonQuery ();
</pre></div></li></ol></div><div class="section" title="There's more..."><div class="titlepage"><div><div><h4 class="title"><a id="ch04lvl2sec09"/>There's more...</h4></div></div></div><p>Note the usage of a try-catch block. It is provided to display a message to the user if something goes wrong with the creation of the database.<a id="id363" class="indexterm"/>
</p><div class="section" title="SQL table creation"><div class="titlepage"><div><div><h5 class="title"><a id="ch04lvl3sec02"/>SQL table creation</h5></div></div></div><p>In this task, we have created a simple table for our database, with the name<code class="literal"> Customers</code>. It contains three fields.<code class="literal"> FirstName</code> and<code class="literal"> LastName</code> are of type<code class="literal"> VARCHAR(20)</code>, while<code class="literal"> ID</code> is of type<code class="literal"> INTEGER</code> and is also the<code class="literal"> PRIMARY KEY</code> of the table.<a id="id364" class="indexterm"/>
</p><p>Apart from using SQL commands for creating tables, we can create an SQLite database with various commercial or free GUI tools. A simple search on the Internet will yield various results.</p></div></div><div class="section" title="See also"><div class="titlepage"><div><div><h4 class="title"><a id="ch04lvl2sec10"/>See also</h4></div></div></div><p>In this chapter:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><span class="emphasis"><em>Querying an SQLite database</em></span></li><li class="listitem" style="list-style-type: disc"><span class="emphasis"><em>Inserting and updating data</em></span></li><li class="listitem" style="list-style-type: disc"><span class="emphasis"><em>Using an already existing database</em></span></li></ul></div></div></div></div></div>
<div class="section" title="Inserting and updating data"><div class="titlepage"><div><div><h1 class="title"><a id="ch04lvl1sec04"/>Inserting and updating data</h1></div></div></div><p>In this recipe, we will learn how to write data to the database.<a id="id365" class="indexterm"/>
</p><div class="section" title="Getting ready"><div class="titlepage"><div><div><h2 class="title"><a id="ch04lvl2sec11"/>Getting ready</h2></div></div></div><p>For this task, we will extend the project<code class="literal"> CreateSQLiteApp</code> that we created in the previous task.<a id="id366" class="indexterm"/>
</p></div><div class="section" title="How to do it..."><div class="titlepage"><div><div><h2 class="title"><a id="ch04lvl2sec12"/>How to do it...</h2></div></div></div><div class="orderedlist"><ol class="orderedlist"><li class="listitem"> Add two more buttons on the view.</li><li class="listitem"> Inside the<code class="literal"> CreateSQLiteAppViewController</code> class, create two methods that will connect to the database file using the code from the previous task. The difference here lies in the usage of the<code class="literal"> SqliteCommand</code> object:<a id="id367" class="indexterm"/><div class="informalexample"><pre class="programlisting">using (SqliteCommand sqlCom = new SqliteCommand (sqlCon)){
// INSERT statement
sqlCom.CommandText = "INSERT INTO Customers (FirstName, LastName) VALUES (@firstName, @lastName)";

<span class="strong"><strong>sqlCom.Parameters.Add (new SqliteParameter ("@firstName", "John"))</strong></span>;
<span class="strong"><strong>sqlCom.Parameters.Add (new SqliteParameter ("@lastName", "Smith"));</strong></span>
//UPDATE statement
//sqlCom.CommandText = "UPDATE Customers SET FirstName = 'James' WHERE LastName = @lastName";

<span class="strong"><strong>//sqlCom.Parameters.Add (new SqliteParameter ("@lastName", "Smith"));</strong></span>
sqlCom.ExecuteNonQuery ();
}
</pre></div></li></ol></div><div class="section" title="How it works..."><div class="titlepage"><div><div><h3 class="title"><a id="ch04lvl2sec13"/>How it works...</h3></div></div></div><p>To insert and update data in an SQLite table, we use the common<code class="literal"> INSERT</code> and<code class="literal"> UPDATE</code> statements respectively. The highlighted parts of the code indicate the usage of SQLite parameters. Both statements are executed on the database at the<code class="literal"> sqlCom.ExecuteNonQuery()</code>; line. The<code class="literal"> ExecuteNonQuery</code> has a return value of type<code class="literal"> int</code> that indicates the number of rows in the table that were affected. So, if we called the method like the following in our example, we would get the output<code class="literal"> 1</code>, indicating that one row was affected:<a id="id368" class="indexterm"/>
</p><div class="informalexample"><pre class="programlisting">Console.WriteLine(sqlCom.ExecuteNonQuery());
</pre></div></div><div class="section" title="There's more..."><div class="titlepage"><div><div><h3 class="title"><a id="ch04lvl2sec14"/>There's more...</h3></div></div></div><p>Since we have used the project from the previous task, where we provided code for creating the database file, we should add the following code on the beginning of each of our methods that perform the data operations:</p><div class="informalexample"><pre class="programlisting">if (!File.Exists (databaseFile)) {
this.lblMessage.Text = "Database file does not exist. Tap the appropriate button to create it.";
return;
}
</pre></div><p>This is to make sure that we will not have an exception if the user taps on the<span class="strong"><strong> insert</strong></span> or<span class="strong"><strong> update</strong></span> button while there is no database file.</p><div class="section" title="SQLite performance"><div class="titlepage"><div><div><h4 class="title"><a id="ch04lvl3sec03"/>SQLite performance</h4></div></div></div><p>Although SQLite offers great performance and portability, it relies to a great extent on its host filesystem, regardless of which platform it is stored on. If you want to perform multiple concurrent<code class="literal"> INSERT</code> or<code class="literal"> UPDATE</code> statements, consider using an<code class="literal"> SqliteTransaction</code>. Apart from the benefit in performance, by batching multiple statements together, a transaction provides a way of rolling back the operation if a problem occurs.<a id="id369" class="indexterm"/>
</p></div></div><div class="section" title="See also"><div class="titlepage"><div><div><h3 class="title"><a id="ch04lvl2sec15"/>See also</h3></div></div></div><p>In this chapter:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><span class="emphasis"><em>Creating files</em></span></li><li class="listitem" style="list-style-type: disc"><span class="emphasis"><em>Creating an SQLite database</em></span></li><li class="listitem" style="list-style-type: disc"><span class="emphasis"><em>Querying an SQLite database</em></span></li></ul></div></div></div></div>
<div class="section" title="Querying an SQLite database"><div class="titlepage"><div><div><h1 class="title"><a id="ch04lvl1sec05"/>Querying an SQLite database</h1></div></div></div><p>In this recipe, we will learn how to retrieve data from an SQLite database.<a id="id370" class="indexterm"/>
</p><div class="section" title="Getting ready"><div class="titlepage"><div><div><h2 class="title"><a id="ch04lvl2sec16"/>Getting ready</h2></div></div></div><p>Once again, we will use the<code class="literal"> CreateSQLiteApp</code> project. Upon completion of this task, the project will be a full SQLite management application.<a id="id371" class="indexterm"/>
</p></div><div class="section" title="How to do it..."><div class="titlepage"><div><div><h2 class="title"><a id="ch04lvl2sec17"/>How to do it...</h2></div></div></div><div class="orderedlist"><ol class="orderedlist"><li class="listitem"> Add another button on the view.</li><li class="listitem"> Inside the<code class="literal"> CreateSQLiteAppViewController</code> class, add a method that will handle the query. The part that performs the query is the following:<a id="id372" class="indexterm"/><div class="informalexample"><pre class="programlisting">using (SqliteCommand sqlCom = new SqliteCommand (sqlCon)){
sqlCom.CommandText = "SELECT * FROM Customers WHERE LastName = @lastName";
sqlCom.Parameters.Add (new SqliteParameter ("@lastName", "Smith"));
using (SqliteDataReader dbReader = sqlCom.ExecuteReader ()){
if (dbReader.HasRows){
while (dbReader.Read ()){
this.lblMessage.Text += String.Format ("ID: {0}\n", Convert.ToString (dbReader["ID"]));
this.lblMessage.Text += String.Format ("First name: {0}\n", Convert.ToString (dbReader["FirstName"]));
this.lblMessage.Text += String.Format ("Last name: {0}\n", Convert.ToString (dbReader["LastName"]));
}
}
}
}
</pre></div></li></ol></div><div class="section" title="How it works..."><div class="titlepage"><div><div><h3 class="title"><a id="ch04lvl2sec18"/>How it works...</h3></div></div></div><p>To perform a query on an SQLite database, we create a simple<code class="literal"> SELECT</code> statement and assign it to the<code class="literal"> CommandText</code> property of the<code class="literal"> SqliteCommand</code> object:<a id="id373" class="indexterm"/>
</p><div class="informalexample"><pre class="programlisting">sqlCom.CommandText = "SELECT * FROM Customers WHERE LastName = @lastName";
</pre></div><p>The asterisk (*) after the<code class="literal"> SELECT</code> word indicates that we want to retrieve all the fields of the table. The simplest way to execute the SQL query is by using the<code class="literal"> SqliteDataReader</code> class:<a id="id374" class="indexterm"/>
</p><div class="informalexample"><pre class="programlisting">using (SqliteDataReader dbReader = sqlCom.ExecuteReader ())
</pre></div><p>The<code class="literal"> SqliteCommand.ExecuteReader()</code> method performs the query on the table and creates an<code class="literal"> SqliteDataReader</code> object. Now that we have our object, we first check if the table contains any rows:<a id="id375" class="indexterm"/>
</p><div class="informalexample"><pre class="programlisting">if (dbReader.HasRows)
</pre></div><p>If the above returns<code class="literal"> true</code>, we begin advancing through each row by passing the<code class="literal"> SqliteDataReader.Read()</code> method in a<code class="literal"> while</code> loop:<a id="id376" class="indexterm"/>
</p><div class="informalexample"><pre class="programlisting">while (dbReader.Read ())
</pre></div><p>We can now retrieve each field's value by passing the name of each field as an index on the<code class="literal"> SqliteDataReader</code> instance:<a id="id377" class="indexterm"/>
</p><div class="informalexample"><pre class="programlisting">this.lblMessage.Text += String.Format ("ID: {0}\n", Convert.ToString (dbReader["ID"]));
//...
</pre></div><p>Since the indexed<code class="literal"> dbReader</code> variable returns an object of the type<code class="literal"> System.Object</code>, we use the<code class="literal"> Convert.ToString(object)</code> static method to convert it to a string.<a id="id378" class="indexterm"/>
</p></div><div class="section" title="There's more..."><div class="titlepage"><div><div><h3 class="title"><a id="ch04lvl2sec19"/>There's more...</h3></div></div></div><p>The SQLite database is not thread-safe. If we want to perform queries on a database while another thread might be executing<code class="literal"> INSERT</code> or<code class="literal"> UPDATE</code> statements, it would be better to provide some sort of synchronization mechanism.<a id="id379" class="indexterm"/>
</p><div class="section" title="Query performance"><div class="titlepage"><div><div><h4 class="title"><a id="ch04lvl3sec04"/>Query performance</h4></div></div></div><p>Although devices running the iOS platform are performing better than some older desktop computers, their resources are still limited in comparison. When querying data from large databases, consider narrowing the results to the data that is needed at that particular time with the SQL<code class="literal"> WHERE</code> statement. Also, if no sorting is required, avoid using<code class="literal"> ORDER BY</code> statements.<a id="id380" class="indexterm"/>
</p></div></div><div class="section" title="See also"><div class="titlepage"><div><div><h3 class="title"><a id="ch04lvl2sec20"/>See also</h3></div></div></div><p>In this chapter:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><span class="emphasis"><em>Creating an SQLite database</em></span></li><li class="listitem" style="list-style-type: disc"><span class="emphasis"><em>Inserting and updating data</em></span></li><li class="listitem" style="list-style-type: disc"><span class="emphasis"><em>Using an already existing SQLite database</em></span></li></ul></div></div></div></div>
<div class="section" title="Using an already existing SQLite database"><div class="titlepage"><div><div><h1 class="title"><a id="ch04lvl1sec06"/>Using an already existing SQLite database</h1></div></div></div><p>In this recipe, we will discuss how to include an already existing SQLite database file in our project.<a id="id381" class="indexterm"/>
</p><div class="section" title="Getting ready"><div class="titlepage"><div><div><h2 class="title"><a id="ch04lvl2sec21"/>Getting ready</h2></div></div></div><p>It is always easier to create databases with some kind of frontend. In this task, we will see how to integrate an existing SQLite database with an iPhone project. Create a new<span class="strong"><strong> iPhone Single View Application</strong></span> project, and name it<code class="literal"> SqliteIntegrationApp</code>.<a id="id382" class="indexterm"/>
</p></div><div class="section" title="How to do it..."><div class="titlepage"><div><div><h2 class="title"><a id="ch04lvl2sec22"/>How to do it...</h2></div></div></div><div class="orderedlist"><ol class="orderedlist"><li class="listitem"> Add a<code class="literal"> UIButton</code> and a<code class="literal"> UILabel</code> on the view in Interface Builder. Connect them with the appropriate outlets. Make sure the label is tall enough for six lines, and set its<span class="strong"><strong> # Lines</strong></span> field in the<span class="strong"><strong> Inspector</strong></span> tab.</li><li class="listitem"> In MonoDevelop, right-click on the project in the<span class="strong"><strong> Solution</strong></span> pad, and click<span class="strong"><strong> Add Files...</strong></span>.</li><li class="listitem"> On the dialog box that will be shown, navigate to the path where the database file resides and select it. The file will be added in the project.</li><li class="listitem"> Right-click on it and select<span class="strong"><strong> Build Action | Content</strong></span>.</li><li class="listitem"> Enter the following methods in the<code class="literal"> SqliteIntegrationAppViewController</code> class:<a id="id383" class="indexterm"/><div class="informalexample"><pre class="programlisting">private string CopyDatabase (){
string docPath = Environment.GetFolderPath (Environment.SpecialFolder.Personal);
string databaseFile = "CustomersDB.db3";
string databasePath = Path.Combine (docPath, databaseFile);
if (!File.Exists (databasePath)){
File.Copy (databaseFile, databasePath);
}
return databasePath;
}
private void QueryData (object sender, EventArgs e)
{ //... }
</pre></div></li><li class="listitem">The functionality of the <code class="literal">QueryData
</code> method is the same as the method that performs the query in the previous task. The main difference is that in this project, it will act as the button's TouchUpInside event handler.<a id="id384" class="indexterm"/></li><li class="listitem"> Add a field of type<code class="literal"> string</code> that will hold the database path:<div class="informalexample"><pre class="programlisting">private string database;
</pre></div></li><li class="listitem"> And, finally, in the<code class="literal"> ViewDidLoad</code> method:<a id="id385" class="indexterm"/><div class="informalexample"><pre class="programlisting">this.database = this.CopyDatabase ();
this.buttonQuery.TouchUpInside += this.QueryData;
</pre></div></li><li class="listitem"> Compile and run the application. Tap on the button, and watch the contents of the database being displayed in the label.</li></ol></div></div><div class="section" title="How it works..."><div class="titlepage"><div><div><h2 class="title"><a id="ch04lvl2sec23"/>How it works...</h2></div></div></div><p>What we have done here is a combination of various practices discussed in previous tasks. When we want to add various files in a project, it is important that we set their<span class="strong"><strong> Build Action</strong></span> to<span class="strong"><strong> Content</strong></span>. Any file that is marked as<span class="strong"><strong> Content</strong></span> is being copied as-is in the application bundle. In this case, the file is an SQLite database, hence we will need write access to it at runtime. We need to copy it in the application's<span class="strong"><strong> Documents</strong></span> folder. This is what the<code class="literal"> CopyDatabase()</code> method does, at this point:<a id="id386" class="indexterm"/>
</p><div class="informalexample"><pre class="programlisting">if (!File.Exists (databasePath)){
File.Copy (databaseFile, databasePath);
}
</pre></div><p>It is important to check if the file already exists so that it will not be overwritten the next time the application is executed.</p></div><div class="section" title="There's more..."><div class="titlepage"><div><div><h2 class="title"><a id="ch04lvl2sec24"/>There's more...</h2></div></div></div><p>If you get an<code class="literal"> SqliteException</code>, the first thing to check is if for some reason the database file was not copied to the correct folder.<a id="id387" class="indexterm"/>
</p></div><div class="section" title="See also"><div class="titlepage"><div><div><h2 class="title"><a id="ch04lvl2sec25"/>See also</h2></div></div></div><p>In this chapter:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><span class="emphasis"><em>Creating files</em></span></li><li class="listitem" style="list-style-type: disc"><span class="emphasis"><em>Creating an SQLite database</em></span></li></ul></div></div></div>
<div class="section" title="Storing data with serialization"><div class="titlepage"><div><div><h1 class="title"><a id="ch04lvl1sec07"/>Storing data with serialization</h1></div></div></div><p>In this recipe, we will discuss using .NET serialization to store C# objects.<a id="id388" class="indexterm"/>
</p><div class="section" title="Getting ready"><div class="titlepage"><div><div><h2 class="title"><a id="ch04lvl2sec26"/>Getting ready</h2></div></div></div><p>Create a new<span class="strong"><strong> iPhone Single View Application</strong></span> project in MonoDevelop. Name it<code class="literal"> SerializationApp</code>.<a id="id389" class="indexterm"/>
</p></div><div class="section" title="How to do it..."><div class="titlepage"><div><div><h2 class="title"><a id="ch04lvl2sec27"/>How to do it...</h2></div></div></div><div class="orderedlist"><ol class="orderedlist"><li class="listitem"> Add two buttons and a label on the view in Interface Builder. Add the following using directives in the<code class="literal"> SerializationAppViewController.cs</code> file:<div class="informalexample"><pre class="programlisting">using System.IO;
using System.Runtime.Serialization.Formatters.Binary;
</pre></div></li><li class="listitem"> Add the following methods in the<code class="literal"> AppDelegate</code> class:<div class="informalexample"><pre class="programlisting">private void Serialize (){

<span class="strong"><strong>CustomerData custData = new CustomerData ()</strong></span>;
<span class="strong"><strong>custData.ID = 1</strong></span>;
<span class="strong"><strong>custData.FirstName = "John"</strong></span>;<span class="strong"><strong>custData.LastName = "Smith";</strong></span>
using (MemoryStream ms = new MemoryStream ()){
BinaryFormatter bf = new BinaryFormatter ();
bf.Serialize (ms, custData);
ms.Seek (0, SeekOrigin.Begin);
this.objBuffer = new byte[ms.Length];
ms.Read (this.objBuffer, 0, this.objBuffer.Length);
}
this.labelOutput.Text = "Customer data serialized.\n";
}
private void DeserializeAndDisplay (){
if (null != this.objBuffer){
CustomerData custData = null;
using (MemoryStream ms = new MemoryStream (this.objBuffer)){
ms.Seek (0, SeekOrigin.Begin);
BinaryFormatter bf = new BinaryFormatter ();
custData = (CustomerData)bf.Deserialize (ms);
}
this.labelOutput.Text += String.Format ("ID: {0}\n \tFirst name: {1}\n\tLast name: {2}", custData.ID, custData.FirstName, custData.LastName);
} else {
this.labelOutput.Text = "Buffer is null!";
}
}
</pre></div></li></ol></div><p>The complete code can be found in the<code class="literal"> SerializationApp</code> project.<a id="id390" class="indexterm"/>
</p><div class="section" title="How it works..."><div class="titlepage"><div><div><h3 class="title"><a id="ch04lvl2sec28"/>How it works...</h3></div></div></div><p>Serialization with MonoTouch works the same as in desktop C# applications. The<code class="literal"> CustomerData</code> class indicated in the highlighted code is a simple object that contains one integer and two string properties.<a id="id391" class="indexterm"/>
</p><div class="orderedlist"><ol class="orderedlist"><li class="listitem"> To serialize the object, we first initialize a<code class="literal"> MemoryStream:</code><div class="informalexample"><pre class="programlisting">using (MemoryStream ms = new MemoryStream ())
</pre></div></li><li class="listitem"> We then use the<code class="literal"> BinaryFormatter</code> class to serialize the object and store it into the stream:<a id="id392" class="indexterm"/><div class="informalexample"><pre class="programlisting">BinaryFormatter bf = new BinaryFormatter ();
bf.Serialize (ms, custData);
</pre></div></li><li class="listitem"> After the serialization, we reset the stream's position to its beginning, and read the data from it into a byte array:<div class="informalexample"><pre class="programlisting">ms.Seek (0, SeekOrigin.Begin);
this.objBuffer = new byte[ms.Length];
ms.Read (this.objBuffer, 0, this.objBuffer.Length);
</pre></div></li><li class="listitem"> To deserialize the object from the buffer, the process is similar, but in the reverse order. After the<code class="literal"> MemoryStream</code> initialization, we reset the stream's position to its beginning and use the<code class="literal"> Deserialize</code> method of the<code class="literal"> BinaryFormatter</code>. It returns an object of type<code class="literal"> System.Object</code>, so we need to cast it to the type of our object:<a id="id393" class="indexterm"/><div class="informalexample"><pre class="programlisting">ms.Seek (0, SeekOrigin.Begin);
BinaryFormatter bf = new BinaryFormatter ();
custData = (CustomerData)bf.Deserialize (ms);
</pre></div></li></ol></div><div class="section" title="There's more..."><div class="titlepage"><div><div><h4 class="title"><a id="ch04lvl2sec29"/>There's more...</h4></div></div></div><p>One important thing to remember when serializing objects with MonoTouch is to decorate the objects that will be serialized with the<code class="literal"> PreserveAttribute</code>. This attribute instructs the linker to avoid stripping the object of unused members, keeping it intact. The<code class="literal"> CustomerData</code> class in this task is declared as follows:<a id="id394" class="indexterm"/>
</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>[Preserve()]</strong></span>
[Serializable()]
public class CustomerData
</pre></div><div class="section" title="Serializable objects"><div class="titlepage"><div><div><h5 class="title"><a id="ch04lvl3sec05"/>Serializable objects</h5></div></div></div><p>This is a simple example to display the use of binary serialization in an iOS application. Objects can be customized for serialization by inheriting the<code class="literal"> ISerializable</code> C# interface.</p><p>When creating an object that will be used for serialization, do not forget to mark it with the<code class="literal"> SerializableAttribute</code>. An exception will occur when trying to serialize objects that are not marked with this attribute.<a id="id395" class="indexterm"/>
</p></div></div><div class="section" title="See also"><div class="titlepage"><div><div><h4 class="title"><a id="ch04lvl2sec30"/>See also</h4></div></div></div><p>In this chapter:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><span class="emphasis"><em>Storing data with XML</em></span></li></ul></div><p>In this book:</p><p>
<a class="link" href="ch01.html" title="Chapter 1. Development Tools">Chapter 1</a>,Development Tools:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><span class="emphasis"><em>Compiling</em></span></li></ul></div></div></div></div><div class="section" title="Storing data with XML"><div class="titlepage"><div><div><h2 class="title"><a id="ch04lvl1sec08"/>Storing data with XML</h2></div></div></div><p>In this recipe, we will discuss how to store data with XML serialization.<a id="id396" class="indexterm"/>
</p><div class="section" title="Getting ready"><div class="titlepage"><div><div><h3 class="title"><a id="ch04lvl2sec31"/>Getting ready</h3></div></div></div><p>Create a new<span class="strong"><strong> iPhone Single View Application</strong></span> project in MonoDevelop, and name it<code class="literal"> XMLDataApp</code>.<a id="id397" class="indexterm"/>
</p></div><div class="section" title="How to do it..."><div class="titlepage"><div><div><h3 class="title"><a id="ch04lvl2sec32"/>How to do it...</h3></div></div></div><div class="orderedlist"><ol class="orderedlist"><li class="listitem"> Add a<code class="literal"> UIButton</code> and a<code class="literal"> UILabel</code> on the view. Add the class<code class="literal"> CustomerData</code> from the previous task to the project. Add the following<code class="literal"> using</code> directives in the<code class="literal"> XMLDataAppViewController.cs</code> file:<div class="informalexample"><pre class="programlisting">using System.Xml.Serialization;
using System.Xml;
using System.Text;
</pre></div></li><li class="listitem"> Add the following method in the<code class="literal"> XMLDataAppViewController</code> class:<a id="id398" class="indexterm"/><div class="informalexample"><pre class="programlisting">private void CreateXML (){
CustomerData custData = new CustomerData ();
custData.ID = 1;
custData.FirstName = "John";
custData.LastName = "Smith";
this.sb = new StringBuilder ();
XmlSerializer xmlSer = new XmlSerializer (typeof(CustomerData));
xmlSer.Serialize (XmlWriter.Create (sb), custData);
this.labelOutput.Text = sb.ToString ();
}
</pre></div></li></ol></div><p>The complete solution can be found in the<code class="literal"> XMLDataApp</code> project.</p></div><div class="section" title="How it works..."><div class="titlepage"><div><div><h3 class="title"><a id="ch04lvl2sec33"/>How it works...</h3></div></div></div><p>In this example, we are using the<code class="literal"> XmlSerializer</code> class to serialize an object to XML. The<code class="literal"> StringBuilder</code> object will hold the XML data:<a id="id399" class="indexterm"/>
</p><div class="informalexample"><pre class="programlisting">this.sb = new StringBuilder ();
XmlSerializer xmlSer = new XmlSerializer (typeof(CustomerData));
</pre></div><p>To initialize the<code class="literal"> XmlSerializer</code>, we use its<code class="literal"> XmlSerializer(System.Type)</code> constructor, passing as a parameter the type of the object we want to serialize:<code class="literal"> (typeof(CustomerData))</code>. We than call its<code class="literal"> Serialize(XmlWriter, object)</code> method, which will perform the actual serialization and store the output XML to the<code class="literal"> StringBuilder</code>, through the<code class="literal"> XmlWriter</code> class, as follows:<a id="id400" class="indexterm"/>
</p><div class="informalexample"><pre class="programlisting">xmlSer.Serialize (XmlWriter.Create (sb), custData);
</pre></div><p>When you compile and run the application, you will see the output XML in the label.<a id="id401" class="indexterm"/>
</p></div><div class="section" title="There's more..."><div class="titlepage"><div><div><h3 class="title"><a id="ch04lvl2sec34"/>There's more...</h3></div></div></div><p>There are two main advantages in using XML to store data:</p><div class="orderedlist"><ol class="orderedlist"><li class="listitem"> The output is pure text, as opposed to binary serialization, which makes it human readable.</li><li class="listitem"> Data can be transmitted or received to and from different types of applications, websites, and so on that are not necessarily written in C#.</li></ol></div><div class="section" title="Deserialization"><div class="titlepage"><div><div><h4 class="title"><a id="ch04lvl3sec06"/>Deserialization</h4></div></div></div><p>To deserialize our object from XML, we would use the following line:<a id="id402" class="indexterm"/>
</p><div class="informalexample"><pre class="programlisting">custData = (CustomerData)xmlSer.Deserialize (new StringReader (sb.ToString ()));
</pre></div></div></div><div class="section" title="See also"><div class="titlepage"><div><div><h3 class="title"><a id="ch04lvl2sec35"/>See also</h3></div></div></div><p>In this chapter:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><span class="emphasis"><em>Storing data with serialization</em></span></li><li class="listitem" style="list-style-type: disc"><span class="emphasis"><em>Managing XML data with LINQ to XML</em></span></li></ul></div></div></div><div class="section" title="Managing XML data with LINQ to XML"><div class="titlepage"><div><div><h2 class="title"><a id="ch04lvl1sec09"/>Managing XML data with LINQ to XML</h2></div></div></div><p>In this recipe, we will learn how to manage XML data using<span class="strong"><strong> Language INtegrated Query (LINQ)</strong></span> .<a id="id403" class="indexterm"/>
</p><div class="section" title="Getting ready"><div class="titlepage"><div><div><h3 class="title"><a id="ch04lvl2sec36"/>Getting ready</h3></div></div></div><p>In this task, we are going to use the project<code class="literal"> XMLDataApp</code> from the previous task. Open it in MonoDevelop.<a id="id404" class="indexterm"/>
</p></div><div class="section" title="How to do it..."><div class="titlepage"><div><div><h3 class="title"><a id="ch04lvl2sec37"/>How to do it...</h3></div></div></div><div class="orderedlist"><ol class="orderedlist"><li class="listitem"> Add another<code class="literal"> UIButton</code> on the view. Add a reference to the<code class="literal"> System.Xml.Linq</code> assembly and the following<code class="literal"> using</code> directive in the<code class="literal"> XMLDataAppViewController.cs</code> file:<a id="id405" class="indexterm"/><div class="informalexample"><pre class="programlisting">using System.Linq.Xml;
</pre></div></li><li class="listitem"> Enter the following method in the<code class="literal"> XMLDataAppViewController</code> class:<a id="id406" class="indexterm"/><div class="informalexample"><pre class="programlisting">private void ReadXML (){
if (null != sb){
XDocument xDoc = XDocument.Parse (this.sb.ToString ());
var query = from s in xDoc.Descendants()
select new CustomerData() {
ID = Convert.ToInt32(s.Element("ID").Value),
FirstName = s.Element("FirstName").Value,
LastName = s.Element("LastName").Value
};
CustomerData custData = query.FirstOrDefault();
if (null != custData){
this.labelOutput.Text = String.Format("ID: {0}\n\t FirstName: {1}\n\tLastName: {2}", custData.ID, custData.FirstName, custData.LastName);
}
}
}
</pre></div></li></ol></div><div class="section" title="How it works..."><div class="titlepage"><div><div><h4 class="title"><a id="ch04lvl2sec38"/>How it works...</h4></div></div></div><p>LINQ is very versatile and straightforward in querying XML data.</p><div class="orderedlist"><ol class="orderedlist"><li class="listitem"> The first thing we do is create an<code class="literal"> XDocument</code> from our XML data:<div class="informalexample"><pre class="programlisting">XDocument xDoc = XDocument.Parse (this.sb.ToString ());
</pre></div></li><li class="listitem"> After this, we create a query on its<code class="literal"> Descendants()</code> method, which returns an<code class="literal"> IEnumerable&lt;XElement&gt;</code> object. Each<code class="literal"> XElement</code> object corresponds to an XML element.<a id="id407" class="indexterm"/></li><li class="listitem"> Using the information of each<code class="literal"> XElement</code> returned, we construct our<code class="literal"> CustomerData</code> object in the<code class="literal"> select</code> statement:<a id="id408" class="indexterm"/><div class="informalexample"><pre class="programlisting">var query = from s in xDoc.Descendants()
select new CustomerData() {
ID = Convert.ToInt32(s.Element("ID").Value),
FirstName = s.Element("FirstName").Value,
LastName = s.Element("LastName").Value
};
</pre></div></li><li class="listitem"> To retrieve the created object, we call the extension method<code class="literal"> FirstOrDefault()</code> on the query:<a id="id409" class="indexterm"/><div class="informalexample"><pre class="programlisting">CustomerData custData = query.FirstOrDefault();
</pre></div></li></ol></div><div class="section" title="There's more..."><div class="titlepage"><div><div><h5 class="title"><a id="ch04lvl2sec39"/>There's more...</h5></div></div></div><p>The XML in this example contains only one object of the type<code class="literal"> CustomerData</code>. If there were more, we could narrow down the results, providing a<code class="literal"> where</code> statement:<a id="id410" class="indexterm"/>
</p><div class="informalexample"><pre class="programlisting">var query = from s in xDoc.Descendants() where s.Element("FirstName").Value == "John" select new CustomerData() {
ID = Convert.ToInt32(s.Element("ID").Value),
FirstName = s.Element("FirstName").Value,
LastName = s.Element("LastName").Value
};
</pre></div><div class="section" title="Anonymous types in LINQ"><div class="titlepage"><div><div><h6 class="title"><a id="ch04lvl3sec07"/>Anonymous types in LINQ</h6></div></div></div><p>In MonoTouch, we can also use C#'s powerful feature of anonymous types in queries, for example,<code class="literal"> select new { ID = … }</code>
</p></div></div><div class="section" title="See also"><div class="titlepage"><div><div><h5 class="title"><a id="ch04lvl2sec40"/>See also</h5></div></div></div><p>In this chapter:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><span class="emphasis"><em>Storing data with serialization</em></span></li><li class="listitem" style="list-style-type: disc"><span class="emphasis"><em>Storing data</em></span></li></ul></div></div></div></div></div></div></body></html>