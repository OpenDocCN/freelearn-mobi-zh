<html><head></head><body><div class="chapter" title="Chapter&#xA0;5.&#xA0;Android Testing Environment"><div class="titlepage"><div><div><h1 class="title"><a id="ch05"/>Chapter 5. Android Testing Environment</h1></div></div></div><p>We built our application and a decent set of tests that we run to verify the basic aspect and behavior of the Temperature Converter application. Now it is time to provide different conditions to run these tests, other tests, or even run the application manually to understand what the user experience would be while using it.</p><p>In this chapter, we will cover:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">Creating<span class="strong"><strong> Android Virtual Devices</strong></span> (<span class="strong"><strong>AVD</strong></span>) to provide different conditions and configurations for the application</li><li class="listitem" style="list-style-type: disc">Understanding the different configurations we can specify while creating AVDs</li><li class="listitem" style="list-style-type: disc">How to run AVDs</li><li class="listitem" style="list-style-type: disc">How to detach an AVD from its window to create headless emulators</li><li class="listitem" style="list-style-type: disc">Unlocking the screen to be able to run all the tests</li><li class="listitem" style="list-style-type: disc">Simulating real-life network conditions</li><li class="listitem" style="list-style-type: disc">Running<code class="literal"> monkey</code> to generate events to send to the application</li></ul></div><div class="section" title="Creating Android Virtual Devices"><div class="titlepage"><div><div><h1 class="title"><a id="ch05lvl1sec01"/>Creating Android Virtual Devices</h1></div></div></div><p>To get the best opportunity of detecting problems related with the device where the application is running, you need the widest possible coverage of features and configurations.<a class="indexterm" id="id270"/>
</p><p>While final and conclusive tests should always be run on real devices with the everyday increasing number of devices, it is virtually impossible that you will have one device of each to test your application. There are also device farms in the cloud to test on a variety of devices but its cost sometimes is above the average developer budget. Hopefully, Android provides a way of simulating, more or less verbatim, a great variety of features and configuration just from the convenience of the emulator and AVD configurations.</p><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;" title="Note"><h3 class="title"><a id="note11"/>Note</h3><p>All the examples in this chapter are run from a Ubuntu 10.04 (Lucid Lynx) 64bit using<span class="strong"><strong> Android SDK and AVD Manager</strong></span> Revision 10 and<span class="strong"><strong> Android SDK</strong></span> with platform 2.3 (API 9) installed.</p></div><p>To create AVD you use<code class="literal"> android</code> from the command line or even from inside Eclipse using<span class="strong"><strong> Window | Android SDK and AVD Manager</strong></span> or its shortcut icon.<a class="indexterm" id="id271"/>
</p><p>Running the command you access the<span class="strong"><strong> Android SDK and AVD Manager</strong></span> where you press the<span class="strong"><strong> New..</strong></span>. button to create a new AVD, and this dialog box is presented:</p><div class="mediaobject"><img alt="Creating Android Virtual Devices" src="graphics/3500_05_01.jpg"/></div><p>If you press<span class="strong"><strong> Create AVD</strong></span> you finish the creation of the AVD using the default values. However if you need to support different configurations, you can specify different hardware properties by using the<span class="strong"><strong> New..</strong></span>. button.<a class="indexterm" id="id272"/>
</p><p>The properties that can be set are:</p><div class="informaltable"><table border="1"><colgroup><col style="text-align: left"/><col style="text-align: left"/><col style="text-align: left"/></colgroup><thead><tr><th style="text-align: left" valign="bottom">
<p>Property</p>
</th><th style="text-align: left" valign="bottom">
<p>Type</p>
</th><th style="text-align: left" valign="bottom">
<p>Description</p>
</th></tr></thead><tbody><tr><td style="text-align: left" valign="top">
<p>Camera support</p>
</td><td style="text-align: left" valign="top">
<p>boolean</p>
</td><td style="text-align: left" valign="top">
<p>Whether the device has a camera or not.</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>Cache partition size</p>
</td><td style="text-align: left" valign="top">
<p>integer</p>
</td><td style="text-align: left" valign="top">
<p>The size of the cache partition.</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>SD Card support</p>
</td><td style="text-align: left" valign="top">
<p>boolean</p>
</td><td style="text-align: left" valign="top">
<p>Whether the device supports insertion and removal of virtual SD Cards.</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>Cache partition support</p>
</td><td style="text-align: left" valign="top">
<p>boolean</p>
</td><td style="text-align: left" valign="top">
<p>Whether the cache partition is supported. Usually this partition is mounted in<code class="literal"> /cache</code>.</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>Keyboard support</p>
</td><td style="text-align: left" valign="top">
<p>boolean</p>
</td><td style="text-align: left" valign="top">
<p>Whether the device has a physical QWERTY keyboard.</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>Audio playback support</p>
</td><td style="text-align: left" valign="top">
<p>boolean</p>
</td><td style="text-align: left" valign="top">
<p>Whether the device can play audio</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>Audio recording support</p>
</td><td style="text-align: left" valign="top">
<p>boolean</p>
</td><td style="text-align: left" valign="top">
<p>Whether the device can record audio.</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>DPAD support</p>
</td><td style="text-align: left" valign="top">
<p>boolean</p>
</td><td style="text-align: left" valign="top">
<p>Whether the device has DPAD keys.</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>Maximum vertical camera pixels</p>
</td><td style="text-align: left" valign="top">
<p>integer</p>
</td><td style="text-align: left" valign="top">
<p>The maximum vertical dimension in pixels of the virtual camera.</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>Accelerometer</p>
</td><td style="text-align: left" valign="top">
<p>boolean</p>
</td><td style="text-align: left" valign="top">
<p>Whether the device has an accelerometer.</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>GPS support</p>
</td><td style="text-align: left" valign="top">
<p>boolean</p>
</td><td style="text-align: left" valign="top">
<p>Whether the device has a GPS.</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>Device RAM size</p>
</td><td style="text-align: left" valign="top">
<p>integer</p>
</td><td style="text-align: left" valign="top">
<p>The amount of physical RAM on the device. This is expressed in megabytes.</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>Touch-screen support</p>
</td><td style="text-align: left" valign="top">
<p>boolean</p>
</td><td style="text-align: left" valign="top">
<p>Whether there is a touch screen on the device.</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>Battery support</p>
</td><td style="text-align: left" valign="top">
<p>boolean</p>
</td><td style="text-align: left" valign="top">
<p>Whether the device can run on battery.</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>GSM modem support</p>
</td><td style="text-align: left" valign="top">
<p>boolean</p>
</td><td style="text-align: left" valign="top">
<p>Whether there is a GSM modem in the device.</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>Track-ball support</p>
</td><td style="text-align: left" valign="top">
<p>boolean</p>
</td><td style="text-align: left" valign="top">
<p>Whether there is a trackball on the device.</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>Maximum horizontal camera pixels</p>
</td><td style="text-align: left" valign="top">
<p>integer</p>
</td><td style="text-align: left" valign="top">
<p>The maximum horizontal dimension in pixels of the virtual camera.</p>
</td></tr></tbody></table></div><p>After pressing<span class="strong"><strong> Start..</strong></span>. to start the AVD you can select other properties:</p><div class="mediaobject"><img alt="Creating Android Virtual Devices" src="graphics/3500_05_02.jpg"/></div><p>Setting the scale is also very useful to test your application in a window that resembles the size of a real device. It is a very common mistake to test your application in an AVD with a window size that is at least twice the size of a real device, and using a mouse pointer believing that everything is fine, to later realize on a physical device with a screen of 5 or 6 inches that some items on the UI are impossible to touch with your finger.</p><p>To scale the AVD screen you should also set the<span class="strong"><strong> Monitor dpi</strong></span> to a value that corresponds to the monitor you are using.<a class="indexterm" id="id273"/>
</p><p>Finally, it is also helpful to test your application under the same conditions repeatedly. To be able to test under the same conditions again and again, it is sometimes helpful to delete all the information that was entered in previous sessions. If this is the case, check<span class="strong"><strong> Wipe user data</strong></span> to start afresh every time.</p></div></div>
<div class="section" title="Running AVDs from the command line"><div class="titlepage"><div><div><h1 class="title"><a id="ch05lvl1sec02"/>Running AVDs from the command line</h1></div></div></div><p>Wouldn't it be nice if we could run different AVDs from the command line and perhaps automate the way we run our tests or script them?<a class="indexterm" id="id274"/>
</p><p>By freeing the AVD from its windows, open a whole new world of automation and scripting possibilities.</p><p>Well, let's explore these alternatives.</p><div class="section" title="Headless emulator"><div class="titlepage"><div><div><h2 class="title"><a id="ch05lvl2sec01"/>Headless emulator</h2></div></div></div><p>A headless emulator (its window is not displayed) comes in very handy when we run automated tests and nobody is looking at the window, or the interaction between the test runner and the application is so fast that we hardly see anything.<a class="indexterm" id="id275"/>
</p><p>Anyway, it is also worth mentioning that sometimes you can't understand why some tests fail until you see the interaction on the screen, so use both alternatives with a bit of judgment.</p><p>One thing that we may have noticed running AVDs is that their communication ports are assigned at runtime, incrementing the last used port by 2 and starting with 5554. This is used to name the emulator and set its serial number, for example, the emulator using port 5554 becomes<code class="literal"> emulator-5554</code>. This is very useful when we run AVDs during the development process because we don't have to pay attention to port assignment. But it can be very confusing and difficult to track which test runs on which emulator if we are running more than one simultaneously.</p><p>In those cases, we will be assigning known ports to the communication ports to keep the specific AVD under our control.</p><p>Usually, when we are running tests on more than one emulator at the same time, not only do we want to detach the window, but also avoid sound output. We will add options for this as well:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem"> The command line to launch the test AVD we just created would be:<div class="informalexample"><pre class="programlisting"><span class="strong"><strong>$ emulator -avd test -no-window -no-audio -no-boot-anim -port 5580 &amp;</strong></span>
</pre></div></li><li class="listitem"> The port must be an integer between 5554 and 5584:<div class="informalexample"><pre class="programlisting"><span class="strong"><strong>$ adb devices
List of devices attached
emulator-5580 device</strong></span>
</pre></div><p>This shows the device in the device list.
</p></li><li class="listitem"> The next step is to install the application and the tests:<div class="informalexample"><pre class="programlisting"><span class="strong"><strong>$ adb -s emulator-5580 install\ TemperatureConverter/bin/TemperatureConverter.apk
347 KB/s (16632 bytes in 0.046s)
pkg: /data/local/tmp/TemperatureConverter.apk
Success
$ adb -s emulator-5580 install\ TemperatureConverterTest/bin/TemperatureConverterTest.apk
222 KB/s (16632 bytes in 0.072s)
pkg: /data/local/tmp/TemperatureConverterTest.apk
Success</strong></span>
</pre></div></li><li class="listitem"> Then we can use the specified serial number to run the tests on it:<div class="informalexample"><pre class="programlisting"><span class="strong"><strong>$ adb -s emulator-5580 shell am instrument -w\ com.example.aatg.tc.test/android.test.InstrumentationTestRunner
com.example.aatg.tc.test.EditNumberTests:......
com.example.aatg.tc.test.TemperatureConverterActivityTests:..........
com.example.aatg.tc.test.TemperatureConverterTests:....
Test results for InstrumentationTestRunner=....................
Time: 25.295
OK (20 tests)</strong></span>
</pre></div></li></ol></div></div><div class="section" title="Disabling the keyguard"><div class="titlepage"><div><div><h2 class="title"><a id="ch05lvl2sec02"/>Disabling the keyguard</h2></div></div></div><p>We can see the tests being run with no intervention and not requiring access to the emulator GUI.<a class="indexterm" id="id276"/>
</p><p>But sometimes you may receive some errors for tests that are not failing if you run in a more standard approach, like in a standard emulator launched from Eclipse. In such cases one of the reasons is that the emulator may be locked at the first screen and we need to unlock it to be able to run tests involving the UI.</p><p>To unlock the screen you can use:</p><div class="informalexample"><pre class="programlisting"><span class="strong"><strong>$ adb -s emulator-5580 emu event send EV_KEY:KEY_MENU:1 EV_KEY:KEY_MENU:0</strong></span>
</pre></div><p>The lock screen can also be disabled programmatically; however this has the disadvantage of including testing-related code in your application. This code should be removed or disabled once the application is ready to ship.</p><p>To do this, the following permission should be added to the manifest file (<code class="literal">AndroidManifest.xml</code>), and then disable the screen lock in your application under test.</p><p>To add the permission, add this element to the manifest:</p><div class="informalexample"><pre class="programlisting"><span class="strong"><strong>&lt;manifest&gt;
...
&lt;uses-permission android:name="android.permission.DISABLE_KEYGUARD"/&gt;
...
&lt;/manifest&gt;</strong></span>
</pre></div><p>Then in the<code class="literal"> Activity</code> under test you should add the following code, preferably in<code class="literal"> onResume():</code>
</p><div class="informalexample"><pre class="programlisting"><span class="strong"><strong>mKeyGuardManager = (KeyguardManager) getSystemService(KEYGUARD_SERVICE);
mLock = mKeyGuardManager.newKeyguardLock("com.example.aatg.tc");
mLock.disableKeyguard();</strong></span>
</pre></div><p>That is, get the<code class="literal"> KeyguardManager</code>, then obtain the<code class="literal"> KeyguardLock</code> specifying a tag, customize the package name to be able to debug who is disabling the keyguard.<a class="indexterm" id="id277"/>
</p><p>Then disable the keyguard from showing using<code class="literal"> disableKeyguard()</code>. If the keyguard is currently showing, it is hidden. The keyguard will be prevented from showing again until<code class="literal"> reenableKeyguard()</code> is called.<a class="indexterm" id="id278"/>
</p></div><div class="section" title="Cleaning up"><div class="titlepage"><div><div><h2 class="title"><a id="ch05lvl2sec03"/>Cleaning up</h2></div></div></div><p>On certain occasions you also need to clean up services and processes started after running some tests to prevent the results of the latter from being influenced by the ending conditions of the previous tests. In these cases, it is always better to start from a known condition freeing all the used memory, stopping services, reloading resources, and restarting processes, which is achievable by warm-booting the emulator.<a class="indexterm" id="id279"/>
</p><div class="informalexample"><pre class="programlisting"><span class="strong"><strong>$ adb -s emulator-5580 shell 'stop; sleep 5; start'</strong></span>
</pre></div><p>This command line opens the emulator shell for our emulator and runs the stop and start commands.</p><p>The evolution of these commands can be monitored using the<code class="literal"> logcat</code> command:</p><div class="informalexample"><pre class="programlisting"><span class="strong"><strong>$ adb -s emulator-5580 logcat</strong></span>
</pre></div><p>You will see messages like these:</p><p>
<span class="strong"><strong>D/AndroidRuntime( 241):</strong></span>
</p><p>
<span class="strong"><strong>D/AndroidRuntime( 241): &gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; AndroidRuntime START &lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;</strong></span>
</p><p>
<span class="strong"><strong>D/AndroidRuntime( 241): CheckJNI is ON</strong></span>
</p><p>
<span class="strong"><strong>D/AndroidRuntime( 241): --- registering native functions ---</strong></span>
</p><p>
<span class="strong"><strong>I/SamplingProfilerIntegration( 241): Profiler is disabled</strong></span>.</p><p>
<span class="strong"><strong>I/Zygote ( 241): Preloading classes..</strong></span>.</p><p>
<span class="strong"><strong>D/dalvikvm( 241): GC_EXPLICIT freed 816 objects / 47208 bytes in 7ms</strong></span>
</p><p>
<span class="strong"><strong>I/ServiceManager( 28): service 'connectivity' died</strong></span>
</p><p>
<span class="strong"><strong>I/ServiceManager( 28): service 'throttle' died</strong></span>
</p><p>
<span class="strong"><strong>I/ServiceManager( 28): service 'accessibility' died</strong></span>
</p><p>
<span class="strong"><strong>…</strong></span>
</p><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;" title="Note"><h3 class="title"><a id="note12"/>Note</h3><p>This warm boot doesn't work well on Android 2.2 Froyo emulator but works perfectly on Android devices. A bug has been reported and you can follow its evolution at<a class="ulink" href="http://code.google.com/p/android/issues/detail?id=9814"> http://code.google.com/p/android/issues/detail?id=9814</a>.</p></div></div><div class="section" title="Terminating the emulator"><div class="titlepage"><div><div><h2 class="title"><a id="ch05lvl2sec04"/>Terminating the emulator</h2></div></div></div><p>Once we have finished working with one of the headless emulator instances, we started using the command mentioned before. We use the following command line to kill it:<a class="indexterm" id="id280"/>
</p><div class="informalexample"><pre class="programlisting"><span class="strong"><strong>$ adb -s emulator-5580 emu kill</strong></span>
</pre></div><p>This will stop the emulator and free the used resources and terminate the emulator process on the host computer.</p></div></div>
<div class="section" title="Additional emulator configurations"><div class="titlepage"><div><div><h1 class="title"><a id="ch05lvl1sec03"/>Additional emulator configurations</h1></div></div></div><p>Sometimes what we need to test is outside the reach of the options that can be set when the AVD is created or configured.<a class="indexterm" id="id281"/>
</p><p>One of the cases could be the need to test our application under different locales. Let's say we want to test our application on a Japanese phone—an emulator with the language and country set to Japanese and Japan respectively.</p><p>We have the ability to pass these properties in the emulator command line.</p><p>The<code class="literal"> -prop</code> command line option allows us to set any of the properties we could set:</p><div class="informalexample"><pre class="programlisting"><span class="strong"><strong>$ emulator -avd test -no-window -no-audio -no-boot-anim -port 5580 -prop persist.sys.language=ja -prop persist.sys.country=JP &amp;</strong></span>
</pre></div><p>To verify that our settings were successful, we can use the<code class="literal"> getprop</code> command to verify them, for example:</p><div class="informalexample"><pre class="programlisting"><span class="strong"><strong>$ adb s emulator-5580 shell "getprop persist.sys.language"</strong></span>
</pre></div><p>
<span class="strong"><strong>ja</strong></span>
</p><div class="informalexample"><pre class="programlisting"><span class="strong"><strong>$ adb s emulator-5580 shell "getprop persist.sys.country"</strong></span>
</pre></div><p>
<span class="strong"><strong>JP</strong></span>
</p><p>If you want to clear all the user data after playing with the persistent settings, you can use the following command:</p><div class="informalexample"><pre class="programlisting"><span class="strong"><strong>$ adb -s emulator-5580 emu kill
$ emulator -avd test -no-window -no-audio -no-boot-anim -port 5580\ -wipe-data</strong></span>
</pre></div><p>And the emulator will start afresh.</p><div class="section" title="Simulating network conditions"><div class="titlepage"><div><div><h2 class="title"><a id="ch05lvl2sec05"/>Simulating network conditions</h2></div></div></div><p>It is extremely important to test under different network conditions but it is neglected more often than not. This would lead to misconceptions and to believe that the application behaves differently because we use the host network which presents a different speed and latency.<a class="indexterm" id="id282"/>
</p><p>The Android emulator supports network throttling, for example to support slower network speeds and higher connection latencies. This can be done in the emulator command line using the options<code class="literal"> -netspeed &lt;speed&gt;</code> and<code class="literal"> -netdelay &lt;delay&gt;</code>.</p><p>The complete list of supporting options is as follows:</p><p>For network speed:<a class="indexterm" id="id283"/>
</p><div class="informaltable"><table border="1"><colgroup><col style="text-align: left"/><col style="text-align: left"/><col style="text-align: left"/></colgroup><tbody><tr><td style="text-align: left" valign="bottom">
<p><span class="strong"><strong>Option</strong></span></p>
</td><td style="text-align: left" valign="bottom">
<p><span class="strong"><strong>Description</strong></span></p>
</td><td style="text-align: left" valign="bottom">
<p><span class="strong"><strong>Speeds [kbits/s]</strong></span></p>
</td></tr><tr><td style="text-align: left" valign="bottom">
<p>
<code class="literal">-netspeed gsm</code>
</p>
</td><td style="text-align: left" valign="top">
<p>GSM/CSD</p>
</td><td style="text-align: left" valign="top">
<p>up: 14.4, down: 14.4</p>
</td></tr><tr><td style="text-align: left" valign="bottom">
<p>
<code class="literal">-netspeed hscsd</code>
</p>
</td><td style="text-align: left" valign="top">
<p>HSCSD</p>
</td><td style="text-align: left" valign="top">
<p>up: 14.4, down: 43.2</p>
</td></tr><tr><td style="text-align: left" valign="bottom">
<p>
<code class="literal">-netspeed gprs</code>
</p>
</td><td style="text-align: left" valign="top">
<p>GPRS</p>
</td><td style="text-align: left" valign="top">
<p>up: 40.0, down: 80.0</p>
</td></tr><tr><td style="text-align: left" valign="bottom">
<p>
<code class="literal">-netspeed edge</code>
</p>
</td><td style="text-align: left" valign="top">
<p>EDGE/EGPRS</p>
</td><td style="text-align: left" valign="top">
<p>up: 118.4, down: 236.8</p>
</td></tr><tr><td style="text-align: left" valign="bottom">
<p>
<code class="literal">-netspeed umts</code>
</p>
</td><td style="text-align: left" valign="top">
<p>UMTS/3G</p>
</td><td style="text-align: left" valign="top">
<p>up: 128.0, down: 1920.0</p>
</td></tr><tr><td style="text-align: left" valign="bottom">
<p>
<code class="literal">-netspeed hsdpa</code>
</p>
</td><td style="text-align: left" valign="top">
<p>HSDPA</p>
</td><td style="text-align: left" valign="top">
<p>up: 348.0, down: 14400.0</p>
</td></tr><tr><td style="text-align: left" valign="bottom">
<p>
<code class="literal">-netspeed full</code>
</p>
</td><td style="text-align: left" valign="top">
<p>no limit</p>
</td><td style="text-align: left" valign="top">
<p>up: 0.0, down: 0.0</p>
</td></tr><tr><td style="text-align: left" valign="bottom">
<p>
<code class="literal">-netspeed &lt;num&gt;</code>
</p>
</td><td style="text-align: left" valign="top">
<p>select both upload and download speed</p>
</td><td style="text-align: left" valign="top">
<p>up: as specified, down: as specified</p>
</td></tr><tr><td style="text-align: left" valign="bottom">
<p>
<code class="literal">-netspeed &lt;up&gt;:&lt;down&gt;</code>
</p>
</td><td style="text-align: left" valign="top">
<p>select individual up and down speed</p>
</td><td style="text-align: left" valign="top">
<p>up: as specified, down: as specified</p>
</td></tr></tbody></table></div><p>For latency:<a class="indexterm" id="id284"/>
</p><div class="informaltable"><table border="1"><colgroup><col style="text-align: left"/><col style="text-align: left"/><col style="text-align: left"/></colgroup><thead><tr><th style="text-align: left" valign="bottom">
<p>Option</p>
</th><th style="text-align: left" valign="bottom">
<p>Description</p>
</th><th style="text-align: left" valign="bottom">
<p>Delay [msec]</p>
</th></tr></thead><tbody><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">-netdelay gprs</code>
</p>
</td><td style="text-align: left" valign="top">
<p>GPRS</p>
</td><td style="text-align: left" valign="top">
<p>min 150, max 550</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">-netdelay edge</code>
</p>
</td><td style="text-align: left" valign="top">
<p>EDGE/EGPRS</p>
</td><td style="text-align: left" valign="top">
<p>min 80, max 400</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">-netdelay umts</code>
</p>
</td><td style="text-align: left" valign="top">
<p>UMTS/3G</p>
</td><td style="text-align: left" valign="top">
<p>min 35, max 200</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">-netdelay none</code>
</p>
</td><td style="text-align: left" valign="top">
<p>no latency</p>
</td><td style="text-align: left" valign="top">
<p>min 0, max 0</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">-netdelay &lt;num&gt;</code>
</p>
</td><td style="text-align: left" valign="top">
<p>select exact latency</p>
</td><td style="text-align: left" valign="top">
<p>latency as specified</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">-netdelay &lt;min&gt;:&lt;max&gt;</code>
</p>
</td><td style="text-align: left" valign="top">
<p>select min and max latencies</p>
</td><td style="text-align: left" valign="top">
<p>minimum and maximum latencies as specified</p>
</td></tr></tbody></table></div><p>The emulator, if values are not specified, uses the following default values:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">Default network speed is 'full'</li><li class="listitem" style="list-style-type: disc">Default network latency is 'none'</li></ul></div><p>This is an example of an emulator using these options to select the GSM network speed of 14.4 kbits/sec and a GPRS latency of 150 to 500 msec.<a class="indexterm" id="id285"/>
</p><div class="informalexample"><pre class="programlisting"><span class="strong"><strong>$ emulator -avd test -port 5580 -netspeed gsm -netdelay gprs</strong></span>
</pre></div><p>Once the emulator is running, you can verify these network settings or change them interactively using the Android console using a TELNET client:</p><div class="informalexample"><pre class="programlisting"><span class="strong"><strong>$ telnet localhost 5580</strong></span>
</pre></div><p>
<span class="strong"><strong>Trying ::1..</strong></span>.</p><p>
<span class="strong"><strong>Trying 127.0.0.1..</strong></span>.</p><p>
<span class="strong"><strong>Connected to localhost</strong></span>.</p><p>
<span class="strong"><strong>Escape character is '^]'</strong></span>.</p><p>
<span class="strong"><strong>Android Console: type 'help' for a list of commands</strong></span>
</p><p>
<span class="strong"><strong>OK</strong></span>
</p><p>After we are connected we can type the following command:</p><div class="informalexample"><pre class="programlisting"><span class="strong"><strong>network status</strong></span>
</pre></div><p>
<span class="strong"><strong>Current network status:</strong></span>
</p><p>
<span class="strong"><strong>download speed: 14400 bits/s (1.8 KB/s)</strong></span>
</p><p>
<span class="strong"><strong>upload speed: 14400 bits/s (1.8 KB/s)</strong></span>
</p><p>
<span class="strong"><strong>minimum latency: 150 ms</strong></span>
</p><p>
<span class="strong"><strong>maximum latency: 550 ms</strong></span>
</p><p>
<span class="strong"><strong>OK</strong></span>
</p><p>You can use the emulator to test applications using network services either manually or in an automated way.</p><p>In some cases this not only involves throttling the network speed but also changing the state of the GPRS connection to investigate how the application behaves and copes with these situations. To change this status we can also use the Android console in a running emulator.</p><p>For example to unregister the emulator from the network we can use:</p><div class="informalexample"><pre class="programlisting"><span class="strong"><strong>$ telnet localhost 5580</strong></span>
</pre></div><p>
<span class="strong"><strong>Trying ::1..</strong></span>.</p><p>
<span class="strong"><strong>Trying 127.0.0.1..</strong></span>.</p><p>
<span class="strong"><strong>Connected to localhost</strong></span>.</p><p>
<span class="strong"><strong>Escape character is '^]'</strong></span>.</p><p>
<span class="strong"><strong>Android Console: type 'help' for a list of commands</strong></span>
</p><p>
<span class="strong"><strong>OK</strong></span>
</p><p>Next to receiving the<span class="strong"><strong> OK</strong></span> subprompt, we can set the data network mode as unregistered by issuing the following command:<a class="indexterm" id="id286"/>
</p><div class="informalexample"><pre class="programlisting"><span class="strong"><strong>gsm data unregistered</strong></span>
</pre></div><p>
<span class="strong"><strong>OK</strong></span>
</p><p>
<span class="strong"><strong>quit</strong></span>
</p><p>After testing the application under this condition you can return to a connected state by using:</p><div class="informalexample"><pre class="programlisting"><span class="strong"><strong>gsm data home</strong></span>
</pre></div><p>
<span class="strong"><strong>OK</strong></span>
</p><p>To verify the status you can use:</p><div class="informalexample"><pre class="programlisting"><span class="strong"><strong>gsm status
gsm voice state: home
gsm data state: home</strong></span>
</pre></div><p>
<span class="strong"><strong>OK</strong></span>
</p></div><div class="section" title="Additional qemu options"><div class="titlepage"><div><div><h2 class="title"><a id="ch05lvl2sec06"/>Additional qemu options</h2></div></div></div><p>You may know that the Android emulator is based on an Open Source project named Qemu (<a class="ulink" href="http://qemu.org">http://qemu.org</a>).<a class="indexterm" id="id287"/>
</p><p>Qemu is a generic emulator and virtualizer. Android uses its emulator capabilities to run an OS that is made for a different architecture on a different machine as your PC or Mac. It uses dynamic translation achieving very good performance, so good that to resemble real Android devices the emulation is throttled in some cases.<a class="indexterm" id="id288"/>
</p><p>Because of this you can add some qemu-specific options when you run the emulator.</p><p>For example, we may want to open the qemu console which is accessible via VNC [Virtual Network Computing], another Open Source project providing remote frame-buffer capabilities (<a class="ulink" href="http://en.wikipedia.org/wiki/Virtual_Network_Computing">http://en.wikipedia.org/wiki/Virtual_Network_Computing</a>). In this console, we can issue some qemu-specific commands.<a class="indexterm" id="id289"/>
</p><p>To do this, let's add the following options:<a class="indexterm" id="id290"/>
</p><div class="informalexample"><pre class="programlisting"><span class="strong"><strong>$ emulator -avd test -no-window -no-audio -no-boot-anim -port 5580\ -qemu -vnc :2 &amp;</strong></span>
</pre></div><p>All the options following<code class="literal"> -qemu</code> are passed verbatim to qemu. In this case we pass<code class="literal"> -vnc :2</code>, to open the virtual display 2, which is at the port 5902 as VNC starts counting from 5900.</p><p>Using some VNC client, like Vinagre—Remote Desktop Viewer, which is provided under the GNOME desktop in most of the distributions we can open the connection to the console. Vinagre can be launched from the GNOME desktop by<span class="strong"><strong> Applications | Internet | Remote Desktop Viewer</strong></span>.</p><p>In Microsoft Windows RealVNC can be used as the client.</p><p>Then we should open the connection to the VNC server in qemu:</p><div class="mediaobject"><img alt="Additional qemu options" src="graphics/3500_05_03.jpg"/></div><p>We will then be presented with the qemu console:</p><div class="mediaobject"><img alt="Additional qemu options" src="graphics/3500_05_04.jpg"/></div><p>The list of internal commands can be obtained by entering the following command on the prompt:<a class="indexterm" id="id291"/>
</p><div class="informalexample"><pre class="programlisting"><span class="strong"><strong>(qemu) help</strong></span>
</pre></div><p>The analysis of these commands is outside the scope of this book but you can find some information online on the Qemu website.<a class="indexterm" id="id292"/>
</p><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;" title="Note"><h3 class="title"><a id="note13"/>Note</h3><p>Latest versions of the emulator, starting with Android 2.2 (Froyo), have a bug that prevents qemu options from being specified in the command line (even the help option (<code class="literal">-qemu -h</code>) is not working), even though they are listed in the emulator help (<code class="literal">emulator -help</code>) as the following:</p><p>
<code class="literal">-qemu args... pass arguments to qemu</code>
</p><p>
<code class="literal">-qemu -h display qemu help</code>
</p></div></div></div>
<div class="section" title="Running monkey"><div class="titlepage"><div><div><h1 class="title"><a id="ch05lvl1sec04"/>Running monkey</h1></div></div></div><p>You may know about the infinite monkey theorem. This theorem states that a monkey hitting keys at random on a typewriter keyboard for an infinite amount of time will almost surely type a given text, such as the complete works of William Shakespeare.<a class="indexterm" id="id293"/>
</p><p>The Android version of this theorem states that a monkey producing random touches on a device could crash your application in, well... much less than an infinite amount of time.<a class="indexterm" id="id294"/>
</p><p>In this line, Android features a monkey application (<a class="ulink" href="http://developer.android.com/guide/developing/tools/monkey.html">http://developer.android.com/guide/developing/tools/monkey.html</a>) that would generate the random events instead of a real monkey.</p><p>The simplest way to run monkey against our application to generate random events is:</p><div class="informalexample"><pre class="programlisting"><span class="strong"><strong>$ adb -e shell monkey -p com.example.aatg.tc -v -v 1000</strong></span>
</pre></div><p>And you will be receiving this output:</p><p>
<span class="strong"><strong>Events injected: 1000</strong></span>
</p><p>
<span class="strong"><strong>:Dropped: keys=0 pointers=0 trackballs=0 flips=0</strong></span>
</p><p>
<span class="strong"><strong>## Network stats: elapsed time=100914ms (0ms mobile, 0ms wifi, 100914ms not connected)</strong></span>
</p><p>
<span class="strong"><strong>// Monkey finished</strong></span>
</p><p>
<span class="strong"><strong>This displays the details of the events injected through monkey</strong></span>.</p><p>The monkey will send events only to the specified package (<code class="literal">-p</code>), in this case<code class="literal"> com.example.aatg.tc</code>, in a very verbose manner (<code class="literal">-v -v</code>). The count of events sent will be 1000.</p><div class="section" title="Client-server monkey"><div class="titlepage"><div><div><h2 class="title"><a id="ch05lvl2sec07"/>Client-server monkey</h2></div></div></div><p>There is another way of running monkey. It also presents a client-server model that ultimately allows for the creation of scripts controlling what events are sent and not relying only on random generation.<a class="indexterm" id="id295"/>
</p><p>Usually the port used by monkey is 1080 but you can use another one if it better suits your preferences.</p><div class="informalexample"><pre class="programlisting"><span class="strong"><strong>$ adb -e shell monkey -p com.example.aatg.tc --port 1080 &amp;</strong></span>
</pre></div><p>Then we need to redirect the emulator port:</p><div class="informalexample"><pre class="programlisting"><span class="strong"><strong>$ adb -e forward tcp:1080 tcp:1080</strong></span>
</pre></div><p>Now we are ready to send events. To do it manually we can use a TELNET client:</p><div class="informalexample"><pre class="programlisting"><span class="strong"><strong>$ telnet localhost 1080</strong></span>
</pre></div><p>
<span class="strong"><strong>Trying ::1..</strong></span>.</p><p>
<span class="strong"><strong>Trying 127.0.0.1..</strong></span>.</p><p>
<span class="strong"><strong>Connected to localhost</strong></span>.</p><p>
<span class="strong"><strong>Escape character is '^]'</strong></span>.</p><p>After the connection is established we can type the specific monkey command:</p><div class="informalexample"><pre class="programlisting"><span class="strong"><strong>tap 150 200</strong></span>
</pre></div><p>
<span class="strong"><strong>OK</strong></span>
</p><p>To finish this exit the telnet command.<a class="indexterm" id="id296"/>
</p><p>If we need to exercise the application repeatedly, it is much more convenient to create a script with the commands we want to send. A monkey script could look like this:</p><div class="informalexample"><pre class="programlisting"># monkey
tap 100 180
type 123
tap 100 280
press DEL
press DEL
press DEL
press DEL
press DEL
press DEL
press DEL
press DEL
type -460.3
</pre></div><p>The events and its parameters are defined here.</p><p>After having started the Temperature Converter application we can run this script to exercise the user interface. To start the application you can use the emulator window and click on its launcher icon or use the command line, which is the only alternative if the emulator is headless, as follows:</p><div class="informalexample"><pre class="programlisting"><span class="strong"><strong>$ adb shell am start -n com.example.aatg.tc/.TemperatureConverterActivity</strong></span>
</pre></div><p>This is informed in the log by this line:</p><p>
<span class="strong"><strong>Starting: Intent { cmp=com.example.aatg.tc/.TemperatureConverterActivity }</strong></span>
</p><p>Once the application has started you can send the events using the script and the<code class="literal"> netcat</code> utility:</p><div class="informalexample"><pre class="programlisting"><span class="strong"><strong>$ nc localhost 1080 &lt; monkey.txt</strong></span>
</pre></div><p>This will send the events contained in the script file to the emulator. These are the following events:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">touch and select the Celsius field</li><li class="listitem" style="list-style-type: disc">type 123</li><li class="listitem" style="list-style-type: disc">touch and select the Fahrenheit field</li><li class="listitem" style="list-style-type: disc">delete its content</li><li class="listitem" style="list-style-type: disc">type -460.3</li></ul></div><p>In this manner simple scripts consisting of touch events and key presses can be created.</p></div></div>
<div class="section" title="Test scripting with monkeyrunner"><div class="titlepage"><div><div><h1 class="title"><a id="ch05lvl1sec05"/>Test scripting with monkeyrunner</h1></div></div></div><p>The possibilities of monkey are fairly limited and the lack of flow control restricts its use to very simple cases.<a class="indexterm" id="id297"/>
</p><p>To circumvent these limitations a new project was created, named monkeyrunner (<a class="ulink" href="http://developer.android.com/guide/developing/tools/monkeyrunner_concepts.html">http://developer.android.com/guide/developing/tools/monkeyrunner_concepts.html</a>). Notwithstanding that the name is almost the same and leads to not a small amount of confusion, they are not related in any way.<a class="indexterm" id="id298"/>
</p><p>Monkeyrunner, which is already included in the latest versions of the Android SDK, is in its initial stages and nowadays its use is quite limited but its future could be bright. It is a tool providing an API for writing scripts that externally control an Android device or emulator.</p><p>Monkeyrunner is built on top of Jython (<a class="ulink" href="http://www.jython.org/">http://www.jython.org/</a>), a version of Python (<a class="ulink" href="http://www.python.org/">http://www.python.org/</a>) programming language which is designed to run on the Java(tm) Platform.<a class="indexterm" id="id299"/>
</p><p>According to its documentation, monkeyrunner tool provides these unique features for Android testing. These are just the highlights of the complete list of features, examples and reference documentation that can be obtained from the monkeyrunner home page (<a class="ulink" href="http://developer.android.com/guide/developing/tools/monkeyrunner_concepts.html">http://developer.android.com/guide/developing/tools/monkeyrunner_concepts.html</a>):<a class="indexterm" id="id300"/>
</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>Multiple device control:</strong></span> The<code class="literal"> monkeyrunner</code> API can apply one or more test suites across multiple devices or emulators. You can physically attach all the devices or start up all the emulators (or both) at once, connect to each one in turn programmatically, and then run one or more tests. You can also start up an emulator configuration programmatically, run one or more tests, and then shut down the emulator.</li><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>Functional testing:</strong></span><code class="literal"> monkeyrunner</code> can run an automated start-to-finish test of an Android application. You provide input values with keystrokes or touch events, and view the results as screenshots.</li><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>Regression testing:</strong></span><code class="literal"> monkeyrunner</code> can test application stability by running an application and comparing its output screenshots to a set of screenshots that are known to be correct.</li><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>Extensible automation:</strong></span> Since<code class="literal"> monkeyrunner</code> is an API toolkit, you can develop an entire system of Python-based modules and programs for controlling Android devices. Besides using the<code class="literal"> monkeyrunner</code> API itself, you can use the standard Python OS and subprocess modules to call Android tools such as Android Debug Bridge.</li><li class="listitem" style="list-style-type: disc">You can also add your own classes to the<code class="literal"> monkeyrunner</code> API. This is described in more detail in the online documentation under Extending monkeyrunner with plugins.<a class="indexterm" id="id301"/></li></ul></div><div class="section" title="Getting test screenshots"><div class="titlepage"><div><div><h2 class="title"><a id="ch05lvl2sec08"/>Getting test screenshots</h2></div></div></div><p>Currently, one of the most evident uses of monkeyrunner is getting screenshots of the application under test to be further analyzed or compared.<a class="indexterm" id="id302"/>
</p><p>These screenshots can be obtained with the help of the following steps:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem"> Importing the needed modules.</li><li class="listitem"> Creating the connection with the device.</li><li class="listitem"> Checking for errors.</li><li class="listitem"> Starting the<code class="literal"> TemperatureConverter</code> activity.</li><li class="listitem"> Adding some delay.</li><li class="listitem"> Typing '123'</li><li class="listitem"> Adding some delay to allow for the events to be processed.</li><li class="listitem"> Obtaining the screenshots and saving it to a file.</li><li class="listitem"> Pressing<span class="strong"><strong> BACK</strong></span> to exit the Activity.</li></ol></div><p>The following is the code for the script needed to perform the above mentioned steps:</p><div class="informalexample"><pre class="programlisting">#! /usr/bin/env monkeyrunner
'''
Created on 2011-03-12
@author: diego
'''
import sys
# Imports the monkeyrunner modules used by this program
from com.android.monkeyrunner import MonkeyRunner, MonkeyDevice, MonkeyImage
# Connects to the current device, returning a MonkeyDevice object
device = MonkeyRunner.waitForConnection()
if not device:
print &gt;&gt; sys.stderr, "Couldn't get connection"
sys.exit(1)
device.startActivity(component='com.example.aatg.tc/.TemperatureConverterActivity')
MonkeyRunner.sleep(3.0)
device.type("123")
# Takes a screenshot
MonkeyRunner.sleep(3.0)
result = device.takeSnapshot()
# Writes the screenshot to a file
result.writeToFile('/tmp/device.png','png')
device.press('KEYCODE_BACK', 'DOWN_AND_UP')
</pre></div><p>Once this script runs, you will find the screenshot of<code class="literal"> TemperatureConverter</code> in<code class="literal"> /tmp/device.png</code>.<a class="indexterm" id="id303"/>
</p></div><div class="section" title="Record and playback"><div class="titlepage"><div><div><h2 class="title"><a id="ch05lvl2sec09"/>Record and playback</h2></div></div></div><p>If you need something simpler probably there is no need to manually create these scripts. To simplify the process, the script<code class="literal"> monkey_recorder.py</code>, which is included in the Android source repository in the sdk project (<a class="ulink" href="http://android.git.kernel.org/?p=platform/sdk.git;a=summary">http://android.git.kernel.org/?p=platform/sdk.git;a=summary</a>), can be used to record event descriptions that are later interpreted by another script called<code class="literal"> monkey_playback.py</code>.<a class="indexterm" id="id304"/>
</p><p>Run<code class="literal"> monkey_recorder.py</code> from the command line and you will be presented with this UI:</p><div class="mediaobject"><img alt="Record and playback" src="graphics/3500_05_05.jpg"/></div><p>This interface has a toolbar with buttons to insert different commands in the recorded script:<a class="indexterm" id="id305"/>
</p><div class="informaltable"><table border="1"><colgroup><col style="text-align: left"/><col style="text-align: left"/></colgroup><thead><tr><th style="text-align: left" valign="bottom">
<p>Button</p>
</th><th style="text-align: left" valign="bottom">
<p>Description</p>
</th></tr></thead><tbody><tr><td style="text-align: left" valign="top">
<p>
<span class="strong"><strong>Wait</strong></span>
</p>
</td><td style="text-align: left" valign="top">
<p>How many seconds to wait. This number is requested by a dialog box.</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<span class="strong"><strong>Press a Button</strong></span>
</p>
</td><td style="text-align: left" valign="top">
<p>Sends a MENU, HOME, or SEARCH button. Press, Down, or Up event.</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<span class="strong"><strong>Type Something</strong></span>
</p>
</td><td style="text-align: left" valign="top">
<p>Sends a string.</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<span class="strong"><strong>Fling</strong></span>
</p>
</td><td style="text-align: left" valign="top">
<p>Sends a fling event in the specified direction, distance, and number of steps.</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<span class="strong"><strong>Export Actions</strong></span>
</p>
</td><td style="text-align: left" valign="top">
<p>Saves the script.</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<span class="strong"><strong>Refresh Display</strong></span>
</p>
</td><td style="text-align: left" valign="top">
<p>Refreshes the copy of the screenshot that is displayed.</p>
</td></tr></tbody></table></div><p>Once the script is completed, save it, let's say as<code class="literal"> script.mr</code> and then you can re-run it by using this command line:</p><div class="informalexample"><pre class="programlisting"><span class="strong"><strong>$ monkey_playback.py script.mr</strong></span>
</pre></div><p>Now all the events will be replayed.</p></div></div>
<div class="section" title="Summary"><div class="titlepage"><div><div><h1 class="title"><a id="ch05lvl1sec06"/>Summary</h1></div></div></div><p>In this chapter we covered all the alternatives we have to expose our application and its tests to a wide range of conditions and configurations, ranging from different screen sizes, the availability of devices such as cameras or keyboards, to simulating real life network conditions to detect problems in our application.</p><p>We also analyzed all of the options we have to be able to control emulators remotely when they are detached from its windows. This prepares the foundation for Continuous Integration that we will be visiting in<a class="link" href="ch08.html" title="Chapter 8. Continuous Integration"> Chapter 8</a>,<span class="emphasis"><em> Continuous Integration</em></span>, and relies on the ability to automatically run all the test suites and having the ability to configure, start, and stop the emulator will be necessary.</p><p>At the end, some scripting alternatives were introduced and examples to get you started were provided.</p><p>The next chapter will introduce Behavior Driven Development—a technique that makes use of a common vocabulary to express the tests permitting the inclusion of business people in the software development project.</p></div></body></html>