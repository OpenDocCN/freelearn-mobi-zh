<html><head></head><body><h1 id="e-WNEP">Chapter 3. Connecting to a Facebook User Account</h1>
<p id="e-YeqO">In the previous chapter we created our first project with a single view where users could provide book information. In this chapter we will be working on extending the previous application prototype.</p>
<p id="e-uFGB">In this chapter we are going to build our first Facebook user interaction experience, such as login and logout flows. We are going to build a new view controller to handle the logic and user interface in our social application. This controller's name will be <code>LBFacebookViewController</code>.</p>
<p id="e-R0cb">There are two ways to handle the Facebook authentication flow:</p>
<ul id="e-hZFt">
<li id="e-hij3">
<code>FBLoginView</code>: By using the user interface component that also contains logic to handle the authentication flow</li>
<li id="e-i1zc">
<code>FBSession</code>: By building our custom interface to let the user interact with their social life on Facebook Platform</li>
</ul>
<p id="e-ph3G">We will learn how to use the <code>FBLoginView</code> component in order to authenticate the user against Facebook Platform.</p>
<p id="e-DPtd">We will only need to provide the <code>LBFacebookViewController</code> of the <code>FBLoginView</code>delegates to allow users to log in and log out using the Platform. As part of our UI view, we are going to display some Facebook user account information, such as the username and profile picture.</p>
<p id="e-YDVf">We will use <code>FBSession</code> later in the book to retrieve more information about a user's social life.</p>
<h1 id="e-dc1q">Login flow</h1>
<p id="e-DLyR">Before the new Facebook SDK 3, handling Facebook sessions was tedious and could take a lot of our time in code maintenance and debugging.</p>
<p id="e-O5EA">The <code>FBSession</code> component (<a href="https://developers.facebook.com/docs/reference/ios/3.2/class/FBSession/">https://developers.facebook.com/docs/reference/ios/3.2/class/FBSession/</a>) was introduced with Version 3 of the Facebook SDK. It is a component that keeps track and ensures that the Facebook session information is up-to-date. The <strong>authentication token</strong> is the most important property of the <code>FBSession</code> information. All communication security with the Platform is based on the authentication token. In fact, it will be part of every single request we perform on the Facebook Platform. The previous SDK version onwards, developers hold responsibility for extending the token after it has expired.</p>
<p id="e-sZw1"><code>FBLoginView</code>  is a UI component provided by the Facebook SDK and will enable any iOS application to authenticate users against Facebook Platform without having to write the code to handle requests/responses to/from the Platform.</p>
<p id="e-XPVk"><code>FBLoginView</code> handles user interactions and also keeps the <code>FBSession</code> state constantly updated. As previously mentioned, Apple has been providing Facebook integration since iOS 6. <code>FBLoginView</code> is able to use the native UI component to let users accept that the application they are currently using can have access to their Facebook profiles. This can only happen when the current iOS device has a Facebook account associated with it. When no Facebook account is set, <code>FBLoginView</code> will authenticate users using Safari.</p>
<p id="e-hedU"><code>FBLoginView</code> provides four callbacks to handle Facebook Platform's response after authentication using <code>FBLoginViewDelegate</code>, as follows:</p>
<ul id="e-T3Of">
<li id="e-pM8H"><code>loginView:handleError:</code></li>
<li id="e-EVi2"><code>loginViewFetchedUserInfo:user:</code></li>
<li id="e-hPhw"><code>loginViewShowingLoggedInUser:</code></li>
<li id="e-CjfG"><code>loginViewShowingLoggedOutUser:</code></li>
</ul>
<p id="e-jpjD">For our social application, we are going to use the <code>FBLoginView</code> component. We are going to talk about these methods later, during the login/logout flow implementation.</p>
<p id="e-vt2X"><code>FBLoginView</code> handles the login flow, and we will only need to set our application state after a successful login process.</p>

<h1 id="e-lcy3">Creating the Login interface</h1>
<p id="e-fsKD">In this section we are going to create a new view controller that will enable the application to authenticate users against the Facebook Platform.</p>
<h2 id="e-qBfO">Creating the Facebook view controller</h2>
<p id="e-whY3">Starting from our previous project, we are going to add a new view controller that will contain UI elements and logic to handle the authentication flow.</p>
<p id="e-mRfS">Select the <code>LBViewController</code> of the application, add a new button on the right-bottom position, and set the label as <code>Go Social,</code> as displayed in the following screenshot. This button will prompt the Facebook view controller and will enable users to use the Platform.</p>
<img data-width="353" data-height="500" src="IVyBxDdh.jpg"/><p id="e-bexr">The Go Social button</p>
<p id="e-lszd">Now, create a new view controller. From the <strong>Object Library</strong> list view, drag-and-drop a view controller into a Storyboard as shown in the following screenshot. The Storyboard now has a new a scene that we will refer to as Facebook Scene.</p>
<img data-width="500" data-height="401" src="IDd4U54r.jpg"/><p id="e-Hxro">The new Storyboard view controller</p>
<p id="e-Pafm">The new scene will contain the <code>FBLoginView</code> component. We will need to segue between the first scene and the Facebook Scene. Select the <strong>Go Social</strong> button, hold the <em>Ctrl</em> button,  and select the <strong>Go Social</strong> button again to create a connection between the two scenes.</p>
<p id="e-XNiZ">The following screenshot shows how to create the new segue:</p>
<img data-width="550" data-height="438" src="ttVPTGu0.jpg"/><p id="e-umD8">The Go Social segue</p>
<p id="e-aRJc">Select <strong>push</strong> under <strong>Action Segue</strong>.</p>
<img data-width="267" data-height="137" src="KQFyrRT9.jpg"/><p id="e-FKcr">Push selected as Action Segue</p>
<p id="e-Z0Db">For those of you who are already familiar with Storyboard, you will notice that defining a Push segue within a view controller that does not belong to the Navigation Controller will throw an exception because, without the Navigation Controller, the application is not able to keep track of the user's path through our views. In order to avoid the exception, we need to create a Navigation Controller that will wrap the two scenes.</p>
<p id="e-wFqe">The following screenshot shows how to create a Navigation Controller to define the user's interaction. Select the first scene and go to Editor | Embed In | Navigation Controller.</p>
<img data-width="426" data-height="650" src="VQV8g55a.jpg"/><p id="e-MDNS">Creating the Navigation Controller</p>
<p id="e-DJLz">The Navigation View Controller will now enable Push segues inside the application.</p>
<img data-width="800" data-height="441" src="jyg0gkar.jpg"/><p id="e-xqx4">Navigation Controller</p>
<p id="e-bzco">The preceding screenshot shows the result after creating the Navigation Controller.</p>
<p id="e-lIOb">Now that we have the navigation fixed, we need to create a class that will bind the Facebook view scene with the logic that we will implement. To create a new <code>ViewController</code> class, right-click on the <code>iLikeBook</code> folder and go to <strong>New File</strong> | <strong>Object-C Class</strong>. Provide a class name, <code>LBFacebookVIewController</code>, and as a subclass define <code>UIVIewController</code>. Deselect the <strong>With XIB for user interface</strong> option.</p>
<img data-width="700" data-height="474" src="GdfyvWcz.jpg"/><p id="e-cymq">LBFacebookViewController</p>
<p id="e-IHqg">The new class will appear under the <code>iLikeBook</code> folder. We need to bind the Facebook Scene in the Storyboard with the <code>LBFacebookVIewController</code>. Select Storyboard and the Facebook Scene. Open the <strong>Utilities</strong> dashboard and, on the <strong>View</strong> pane at the top-right position on XCode, select the last button to the right. Open <strong>Identity Inspector</strong> under <strong>Custom Class</strong> and set the <strong>Class</strong> field to <code>LBFacebookVIewController</code>. The application will load the code from the <code>LBFacebookVIewController</code> class when users access the Facebook Scene.</p>
<p id="e-lbtn">Open <code>LBFacebookVIewController.m</code> and add the @interface statement to the code as follows:</p>
<pre id="e-JLsa">@interface LBFacebookViewController ()
 @end</pre>
<p id="e-FEi2">While the Facebook Scene is still selected, drag-and-drop it into a new <code>UIView</code>. The background color for the new view is white and it could be difficult to identify the view when it is not selected. Change the background color of the view to light gray by going to <strong>Attributes Inspector</strong> | <strong>Background</strong>. Set the new size view component to <code>100 x 50</code> and the position to <code>(70, 45)</code> using the Size Inspector. Set <strong>Custom Class</strong> for the new <code>UIView</code> as <code>FBLoginView</code>.</p>
<img data-width="800" data-height="508" src="ElbfbtnE.jpg"/><p id="e-D8Xw">FBLoginView</p>
<p id="e-DT8i">Now we need to create a reference to <code>FBLoginView</code> within <code>LBFacebookViewController</code>. After selecting the Facebook Scene, open up the Assistant Editor and use the <strong>Show the Assistant Editor</strong> button on the top-right spot of XCode.</p>
<img data-width="800" data-height="523" src="d3BnK90I.jpg"/><p id="e-Oz6F">FBLoginView versus LBFacebookViewController</p>
<p id="e-m7F6">Ensure that <code>LBFacebookViewController.m</code> is accessible on the left side.</p>
<p id="e-DigW">Select <code>FBLoginView</code>, hold the <em>Ctrl</em> button, and drag the view into the class file within the @interface statement. XCode will ask for the reference name, as displayed in the following screenshot:</p>
<img data-width="800" data-height="306" src="UcZUqAfh.jpg"/><p id="e-mWnL">The FBLoginView reference creation</p>
<p id="e-gEuH">Leave the <strong>Storage</strong> field with the <code>Weak</code> value. The resulting code statement should look something like the one shown in the following screenshot:</p>
<img data-width="800" data-height="261" src="DrCjVTzh.jpg"/><p id="e-tHag">The FBLoginView reference</p>
<p id="e-Nn83">The Facebook Scene now contains <code>FBLoginView</code>, but we would like to give users some feedback after they have performed the login correctly. Drag-and-drop a new <code>UIView</code> within Facebook Scene. Resize it to 200 x 200 px and place it on the center of the scene. Set <strong>Custom Class</strong> for <code>UIView</code> as <code>FBProfilePictureView</code>. The <code>FBProfilePictureView</code> will allow the application to display the user's Facebook profile information after a successful login.</p>
<img data-width="344" data-height="500" src="QysCXufk.jpg"/><p id="e-kFF8">FBProfilePictureView</p>
<p id="e-VKyk">The preceding screenshot shows the result after adding <code>FBProfilePictureView</code>.</p>
<p id="e-xzJu"><code>FBProfilePictureView</code> needs to be updated for all logins and logouts; therefore, the application needs to have a reference of the UI object within the <code>LBFacebookViewController</code>.</p>
<p id="e-MtP9">As we did for <code>FBLoginView</code>, we need to create a reference of <code>FBProfilePictureView</code> within the <code>LBFacebookViewController</code> class. The result should look like the following screenshot:</p>
<img data-width="800" data-height="369" src="QCGqUPcj.jpg"/><p id="e-moEL">FBProfilePictureView Reference</p>
<p id="e-DOpb">Before moving on with <code>FBLoginView</code> delegates, we need to set the way the application is going to handle external URLs within the <code>AppDelegate</code> class. We want the Facebook SDK to handle the communication between our app and the Social platform.</p>
<p id="e-NJol">Import the Facebook SDK within the <code>AppDelegate</code> file using the following command:</p>
<pre id="e-u9D8">#import &amp;lt;FacebookSDK/FacebookSDK.h&amp;gt;</pre>
<p id="e-Bp7V">Open the <strong>Live Blogger</strong> (<strong>LB</strong>) <code>AppDelegate</code> file and append the following code:</p>
<pre id="e-AdNO">- (BOOL)application:(UIApplication *)application
openURL:(NSURL *)url
sourceApplication:(NSString *)sourceApplication
annotation:(id)annotation
{
return [FBSession.activeSessionhandleOpenURL:url];
}</pre>
<p id="e-cqa7">The preceding code will handle each single request toward the Facebook Platform.</p>
<p id="e-Nxad">Due to a bug in <code>FBProfilePictureView</code>, the application could throw an exception at runtime if the <code>FBProfilePictureView</code> class was not previously loaded. To resolve this, we need to change the following highlighted <code>AppDelegate</code> method:</p>
<pre id="e-xuZH">- (BOOL)application:(UIApplication *)application &lt;span class="strong"&gt;&lt;strong&gt;didFinishLaunchingWithOptions:(NSDictionary *)launchOptions&lt;/strong&gt;&lt;/span&gt;
{ 
    [FBProfilePictureView class];
 return YES;
}</pre>
<p id="e-thSp">The next step is to set <code>FBLoginView</code>. Open <code>LBFacebookViewController</code> and customize the (void) <code>viewDidLoad</code> method as follows:</p>
<pre id="e-P3tf">- (void)viewDidLoad
{
    [superviewDidLoad];
     [self.fbLoginViewsetDelegate:self];
 }</pre>
<p id="e-MQuh">The self.fbLoginViewsetDelegate:self method sets the current class as the delegate for <code>FBLoginView</code>.</p>
<img data-width="382" data-height="800" src="Ta8QNnVi.jpg"/><p id="e-Pjyp">The login UI</p>

<h1 id="e-MfEO">Login delegates</h1>
<p id="e-KOc7">Now that the <code>FBLoginView</code> component is in place, we need to focus on its delegates to handle responses and/or errors.</p>
<p id="e-vhrW">Open <code>LBFacebookViewController.m</code>. As we did in the previous section, we need to import the Facebook SDK.</p>
<p id="e-khga">We also need to extend <code>LBFacebookViewController</code> with <code>FBLoginViewDelegate</code> using the following code:</p>
<pre id="e-NhJP">@interface LBFacebookViewController () &amp;lt;FBLoginViewDelegate&amp;gt;
 @end</pre>
<p id="e-EHiK">Using the preceding code, we will allow the setting of the current class as the delegate of <code>FBLoginView</code> to catch callbacks.</p>
<p id="e-j5NO">The first delegate that we should implement is as follows:</p>
<pre id="e-jtHA">//delegate method to handle communication errors
- (void)loginView:(FBLoginView *)loginViewhandleError:(NSError *)error {
if (error) {
    NSLog(@"%@", error);
    }
}</pre>
<p id="e-ulR3">The preceding code snippet shows the delegate code that will be called in case <code>FBLoginView</code> will throw any errors and will print the errors in the debug window.</p>
<p id="e-c3bh">The following code block shows instructions to handle the callbacks after the user has logged in; the application still has no information about the user's Facebook account. In the upcoming chapters, the following method will be used to enable buttons to provide more functionalities.</p>
<pre id="e-bgxb">// delegate to handle the logged in mode
- (void)loginViewShowingLoggedInUser:(FBLoginView *)loginView {
 }</pre>
<p id="e-Y5Iz">The following method is the one that will provide us with information about the user's Facebook account. The following code is the callback method to handle user-fetched information:</p>
<pre id="e-RNRZ">// delegate called after the application has received
// the user information from Facebook platform
- (void)loginViewFetchedUserInfo:(FBLoginView *)loginView user:(id&amp;lt;FBGraphUser&amp;gt;)user
{
    [self.profilePictureViewsetProfileID:user.id];
}</pre>
<p id="e-bDXR">The <code>user</code> object contains the Facebook account information. <code>FBGraphUser</code> provides an easy interface to access the account data. The method <code>setProfileId</code> sets the <code>FBProfilePictureView</code> ID and will automatically retrieve the account picture through an API call to Facebook Platform.</p>
<p id="e-Li1I">Dealing with Facebook sessions is really easy now due to the new updates to the Framework SDK.</p>
<img data-width="311" data-height="650" src="t4OKFV1M.jpg"/><p id="e-jLAq">Successful user login</p>

<h1 id="e-Ilth">Logout flow</h1>
<p id="e-q5d3">The logout flow is nothing but using a new delegate method for <code>FBLoginView</code>. Again, in <code>LBFacebookViewController</code>, create the new delegate method as follows:</p>
<pre id="e-ab1r">// delegate to handle the logged out mode
- (void)loginViewShowingLoggedOutUser:(FBLoginView *)loginView
{
    [self.profilePictureViewsetProfileID:nil];
}</pre>
<p id="e-OodW">The preceding method will be called after users are successfully logged out. Since the UI so far is still a work-in-progress, we only need to update <code>FBProfilePictureView</code>  with a null value for the profile ID as no user is logged in.</p>
<p id="e-cALZ">This is everything we need to do to handle the logout flow.</p>

<h1 id="e-FNUd">Summary</h1>
<p id="e-PjO4">This chapter covers all the points required for implementing the Facebook login and logout flows. We initially created a view controller to use as the interface for the users.</p>
<p id="e-e3S0">In order to handle authentication logic and communication with the Social Platform, we are relying on <code>FBLoginView</code>. In order to provide some feedback to users, we have used the <code>FBProfilePictureView</code> to display a user's picture profile by setting one of the object properties.</p>
</body></html>