# 第5章：虫子消除——测试和调试

我还在努力从上一章中恢复过来！哎呀，我们做了多少工作！现在是我们稍微放慢一点节奏的时候了。毕竟，编码之后，我们将讨论测试和调试。调试是整个开发过程中的关键步骤，因为虫子的出现可能会破坏你的应用体验。你花费了无数小时在上面，如果有虫子，人们会认为这是不专业的。这当然不是理想的。让我们看看本章我们将讨论什么：

+   在模拟器上测试我们的代码

+   在各种设备上测试我们的项目

+   为测试人员设置TestFlight

+   消除那些虫子

我们将在这个章节中放慢节奏，很快就会继续编码！所以，让我们放松一下，把这个章节当作一个休息。但别以为这会轻松过关！不，不！虽然这并不像我们上一章那样充满动作，正如我提到的，这个主题在所有项目中都非常关键，所以我们非常重视这一点。

嘣！

接下来！

# 测试我们的项目

毫无疑问，你已经对iOS模拟器（一个实际上非常有用，而且我发现比Android SDK模拟器更容易访问的功能）进行了操作，这很棒，但实际上你可以用它做很多事情，而无需在物理设备上安装任何东西。

让我们打开我们的设备模拟器。为此，在Xcode中，点击顶部栏上的**Xcode**，然后点击**打开开发者工具**，最后点击**iOS模拟器**。

现在，你将看到一个像素级的任何你选择的iOS设备的模拟：

![测试我们的项目](img/B03553_05_01.jpg)

如我之前提到的，我喜欢使用iPhone 4S模拟器，因为它足够小，可以适合我的屏幕，但你完全可以选择你喜欢的设备。你的模拟器设置的是你不想用的设备吗？想换成其他设备，比如闪亮的iPhone 6+？没问题！

简单地点击顶部栏上的**硬件**。然后，在**设备**下，你可以选择任何你喜欢的酷炫苹果移动设备！当你选择一个新设备时，你需要给新设备一些时间来启动。

让我们探索！

如果你点击**文件**，你可以截图或至少看到你可以按什么键组合来创建设备屏幕的截图（这对于上传到Facebook或iTunes来说很棒）。

当你点击**编辑**时，你可以复制文本，复制屏幕，粘贴，开始录音，并查看表情符号。

回到**硬件**，再次你可以选择你的设备，你可以旋转设备向左或向右，触发设备摇晃手势，触发主页和锁定按钮，或者强制重启。

你还可以模拟内存警告，触发通话状态栏，以及选择你的键盘设置以及外部设备。

在**调试**设置下，你可以选择减慢动画，例如打开和关闭等UI动画。

你还可以在屏幕上做一些有趣的彩色处理！

什么？

是的！您可以着色混合层、复制的图像、错位的图像和离屏渲染的项目。换句话说，您可以突出显示它们，使它们看起来如图所示。有点酷，对吧？

那么，为什么有人会使用这个功能呢？简单来说；有时候在调试时精灵可能会丢失，而你又想跟踪它们。使用这个功能，你可以轻松跟踪它们的移动。如果你屏幕上有许多精灵在飞舞，这是一个很棒的功能可以利用。如图所示，所有图像和精灵都被跟踪，并且清晰地标出：

![测试我们的项目](img/B03553_05_02.jpg)

接下来，您还可以打开系统日志，这对于调试来说非常棒。您还可以触发iCloud同步，并设置设备模拟位置。

您可以稍微探索一下设备，但您会注意到一些设置和应用程序缺失。例如，您无法为设备选择背景、打电话或发送消息。您有手机来处理这类事情！

接下来，我们将构建并运行我们的项目（再次，通过点击**Xcode**中的**播放**按钮）。我们仍然应该有SpriteKit帧率标签，但这并不像我们希望的那样深入。

要获取更多技术统计信息，点击返回到**Xcode**，然后在顶部的栏上点击**调试**。将鼠标悬停在**附加到进程**上，以找到我们正在工作的项目名称。它将显示在**可能的目标**下。当您点击您的项目时，Xcode将显示一些技术信息，如图所示：

![测试我们的项目](img/B03553_05_03.jpg)

在其他细节中，Xcode会告诉我们应用程序的**进程标识符**（**PID**）、**CPU**、**内存**、**磁盘**和**网络**的使用情况，如图所示：

![测试我们的项目](img/B03553_05_04.jpg)

是的，这些功能相当不错，但再次强调，仍然没有达到开发者希望看到的那么深入。想要获得一些真正酷的深入监控吗？

回到**Xcode**，在顶部的栏上点击**Xcode**，向下滚动到**打开开发者工具**，并选择**Instruments**。

现在是时候疯狂一下，做一些深入测试了：

![测试我们的项目](img/B03553_05_05.jpg)

看看所有这些令人惊叹的选择！让我们逐一了解这里所有的选项，以帮助您进行调试：

+   **活动监视器**：类似于我们之前看到的性能数据，我们对应用程序内部发生的事情有更多的了解，同时能够记录发生的事情，并回溯我们的日志以查看性能下降的点。

+   **分配**：这一部分跟踪应用程序的虚拟内存，并将其分解为类名。

+   **自动化**：这个功能执行一个简单的脚本，将模拟与用户界面的交互，当然，所有操作都会被记录。

+   **Cocoa 布局**: 这一节监控在 Xcode 的 Storyboard 编辑器中通过布局 UI 创建的 `NSLayoutConstraints`，以查看哪些东西位置不正确。

+   **核心动画**: 这项指标衡量的是应用图形性能和 CPU 使用情况。

+   **核心数据**: 这项指标衡量的是核心数据系统的活动。换句话说，就是磁盘或内存的使用情况。

接下来，让我们看看一些更重要的事项：

+   **能量诊断**: 这是一个优秀的工具，用于监控电池使用情况

+   **内存泄漏**: 这项指标衡量内存使用情况，并检查是否有内存泄漏

+   **OpenGL ES 分析**: 这项指标和分析我们的项目渲染，并检测**OGLES**（我喜欢这样称呼它）的正确性以及性能问题

真的很酷，不是吗？在下一章中，当我们讨论如何使我们的游戏更高效时，我们将更深入地探讨这一点。

现在我们已经了解了模拟器，并且查看了一些苹果提供的出色工具，让我们继续安装我们的应用到实际设备上，这实际上非常简单。

您只需使用闪电线缆或 30 针连接器（如果您有较旧的设备）通过 USB 将您的设备连接到您的开发计算机。

在 Xcode 中，在您选择要使用的 iOS 模拟器的地方，点击方案工具栏，然后从菜单中选择您的设备。

Xcode 将自动为您注册设备，以便用作开发设备。与过去您必须手动通过 [developer.apple.com](http://developer.apple.com) 添加设备的 UUID 号码的方式相比，苹果已经真正简化了这一过程。

您的设备可能在方案编辑器中被禁用，这意味着它不是一个合格的设备。例如，假设您在撰写这本书的时候安装了刚刚发布的 iOS 9 测试版。如果您安装了它，并且安装了较旧的 Xcode 版本，那么您的设备将不符合条件。您将不得不安装 Xcode 的最新版本。

现在，只需简单地点击**运行**按钮，Xcode 就会将您的应用安装到设备上。就这么简单！

您可能会遇到 Xcode 询问是否允许在您的密钥链中执行 codesign。点击**始终允许**。您不希望每次点击**运行**按钮时都弹出这个提示。通过点击**始终允许**，Xcode 将获得在您的设备上自动运行项目的权限，而无需询问。

就像我们将调试器和日志连接到我们的 iOS 模拟器一样，您可以将它们链接到运行在您的设备上的项目。

实际上，由于你在模拟器上运行，你可能会得到不同的结果。设备可能会根据设备类型以及你安装的 flappy 克隆数量、存储的消息数量、剩余的存储空间等因素，运行得更好或更差。通常情况下（如果可能的话），最好有一个只安装了你的项目的开发专用设备。这样，你就知道你的应用程序每次都会以 100% 的性能运行。

现在我们已经了解了如何将调试与我们的项目链接起来，并且我们知道如何在设备上安装我们的应用程序，是时候讨论如何获取测试人员来帮助你了。

# 设置 TestFlight 用户

你可能会问，为什么我要设置 TestFlight 用户？简单来说，你可能可以连续测试你的代码数小时，却仍然找不到某些错误。相信我，我以前就做过，结果在数千人安装了应用程序之后，才发现有一个可能通过让其他人以破坏性的方式玩游戏就能发现的破坏游戏错误的bug。

测试人员，或 TestFlight 用户可以是想要帮助你测试你的游戏的你的朋友，甚至是将测试你的游戏并提供真实反馈的焦点小组中的成员。让我们讨论如何设置 TestFlight 用户。

## 什么是 TestFlight 用户？

你可以将 TestFlight 用户定义为测试人员。当你准备好让用户开始测试时，你可以设置 TestFlight 用户，当您推送新版本进行测试时，他们将在设备上收到通知。从那里，他们可以记录他们看到的任何问题，这样你就会知道是否需要修复。

我们将首先使用您的开发者 Apple ID 登录到 [itunesconnect.apple.com](http://itunesconnect.apple.com)，然后你会看到以下页面：

![什么是 TestFlight 用户？](img/B03553_05_06.jpg)

从主屏幕，只需点击**用户和角色**按钮。在下一页的顶部栏上，你会看到一个**TestFlight 测试人员**按钮。点击它开始添加测试人员！

现在，你将处于 TestFlight 测试人员页面。从这里，你可以看到您的内部测试人员（包括你以及你的团队中的其他人）以及您的外部测试人员。

要添加人员来为你进行测试，点击**外部**按钮。在下一页，你将看到旁边有一个蓝色加号按钮的文本**外部测试者**，正如你在以下截图中所见：

![什么是 TestFlight 用户？](img/B03553_05_07.jpg)

## 内部测试者

通过与您在 iTunes Connect 中分配了技术或管理员角色的最多 25 名团队成员共享您的测试版构建，快速获取反馈。每位成员最多可以在 10 台设备上进行测试。

## 外部测试者

一旦您准备好，您可以邀请最多1,000名不属于您开发组织的用户测试您打算在App Store上公开发布的应用。提供给外部测试人员的应用需要**Beta App Review**，并且在测试开始之前必须遵守完整的**App Store审查指南**。对于包含重大更改的新版本的应用，需要进行审查。一次可以测试最多10个应用，无论是内部还是外部。

然后，您将能够添加所需数量的测试人员。除了输入他们的电子邮件地址，以及可选的他们的名字和姓氏，您还可以将这些人员添加到组中，这有助于保持多个测试人员的组织，如下面的截图所示：

![外部测试人员](img/B03553_05_08.jpg)

然后，用户将收到一封电子邮件，要求他们设置账户。从那里，他们可以在他们的设备上设置TestFlight。我们现在将讨论TestFlight用户如何开始测试您的杰作。

## 使用TestFlight作为测试人员

### 安装

您可以在最多10台设备上使用TestFlight测试多个开发者的多个应用；您可以测试的应用数量没有限制。

TestFlight（如以下图标所示），只能用于在运行iOS 8或更高版本的iPhone、iPad和iPod touch上测试iOS应用，而不是Mac应用。

![安装](img/B03553_05_09.jpg)

### 测试

一旦测试人员接受了邀请，他们就能下载应用的测试版本。

如果他们已经在设备上安装了实时应用，则测试版应用将替换实时版本。

当他们下载了测试版应用后，他们将在其名称旁边看到一个橙色圆点，以标识其为测试版。

TestFlight应用将在每次有新版本可用时通知测试人员，并提供关于他们应该关注应用哪些部分的说明。

测试人员可以通过在TestFlight的**应用详情**视图中的**提供反馈**按钮轻松提供反馈。将自动打开一封带有应用和设备详情的电子邮件，测试人员可以在其中添加更多详细信息并附上截图。

测试版应用是有有效期的。测试期从发布给测试人员的当天开始，为期30天。在TestFlight中，每个应用的剩余天数显示在**打开**按钮下方。

如果测试版应用有**内购项目**，您不需要购买它们，因为使用测试构建进行的内购是免费的。

### 拒绝测试

如果测试人员不接受您的电子邮件邀请，则测试版应用将不会被安装，他们也不会被列为测试人员。

此外，测试人员可以通过邀请电子邮件底部的链接取消测试，通知您（开发者）他们希望从TestFlight中移除。

如果测试人员接受了邀请但他们不想测试应用，他们可以在TestFlight的**应用详情**页面中删除自己作为测试人员。因为，你知道，人们都是自私的。

所以实际上，苹果已经创建了一个很棒的系统，允许你轻松快速地测试你的应用。

请记住，每次你想测试你应用的最新版本时，你都需要上传新版本，并将新版本提交进行审核（虽然这听起来有些奇怪，我知道）。这确实看起来有些重复，但嘿，这是苹果，他们知道自己在做什么。

现在，让我们来谈谈如何消灭虫子！

# 消灭那些虫子！

这是一件很繁琐的事情。说实话，调试会花费你很多小时来解决问题，尤其是当你刚开始并且对代码不是很熟悉的时候。相信我，这需要一些时间，但不用担心；这是值得的。

让我们拿我们创建的应用来说，我把它发送给一个朋友去测试，以下是他在测试后发送给我的设备日志片段：

[PRE0]

他在测试时没有发现任何问题。他注意到的只是当游戏刚开始时，设备（iPhone 5S）似乎变慢了，而且他的手机同时显示了雨和火焰。这是我们将在下一章考虑的事情。

在调试时，还有一些其他的事情需要记住。正如我们之前讨论的，当你点击工作区工具栏中的**运行**按钮并且你的应用成功构建后，Xcode会运行你的应用并开始一个调试会话。你可以使用图形工具，如数据提示和快速查看，直接在源编辑器中调试你的应用，以查看变量的值。

调试区域和调试导航器让你可以检查运行中的应用的当前状态并控制其执行。

创建一个高质量的应用（比如，拜托，你已经创建并将会创建更多优秀质量的应用……但让我们继续……）需要你尽量减少应用对用户设备的冲击。使用我们在之前讨论过的调试仪表，在调试导航器中获取你对应用资源消耗的洞察，当你发现问题时，使用工具来测量和分析你应用的性能。我们将在下一章中进一步讨论这一点。

如果你正在开发iOS应用，请在设计和早期测试阶段使用iOS模拟器来查找主要问题。

你可以配置Xcode以帮助你专注于调试任务。例如，当你的代码遇到断点时，你可以让Xcode自动播放一个警报声音，并创建一个名为**调试**的窗口标签，Xcode在这里显示调试区域、调试导航器和你的断点处的代码。

Xcode允许你逐行执行你的代码，以查看程序在执行特定阶段的程序状态，这是一个真正棒的功能，可以帮助你找出问题代码。

您还可以使用调试区域来控制代码的执行，查看程序变量和寄存器，查看其控制台输出，并与调试器交互。此外，您还可以使用调试区域导航到渲染帧的OpenGL调用，并查看特定调用处的渲染状态信息。以下图像分解了用户界面以及每一项的功能。别担心，我会在图像之后解释一切：

![挤压那些虫子！](img/B03553_05_10.jpg)

您可以通过点击调试区域工具栏中的暂停按钮（在“暂停”和“继续”之间切换）来挂起应用的执行。

要设置断点，打开源代码文件，并点击您希望执行暂停的行旁边的**空白处**。**空白处**中的蓝色箭头（再次）表示断点。

当您的应用暂停时，当前正在执行的代码行将以绿色突出显示。

您可以使用位于**调试**区域顶部的栏中的**Step Over**、**Step Into**和**Step Out**按钮来逐步执行您的代码。点击**Step Over**将执行当前代码行，包括任何方法。

如果当前代码行调用一个方法，**Step Into**将从当前行开始执行，并在达到被调用方法的第1行时停止。**Step Out**按钮将执行当前方法或函数的其余部分。

当执行暂停时，调试导航器打开以显示堆栈跟踪（报告应用执行过程中某一时间点的活动堆栈帧）。在调试导航器中选择一个项目，以在编辑区域和调试区域查看有关该项目的信息。在继续调试时，展开或折叠线程以显示或隐藏堆栈帧。

在源代码编辑器中的任何变量上悬停，以查看显示变量值的提示信息。点击变量旁边的检查器图标，将打印对象的Objective-C描述到调试区域控制台，并在额外的弹出窗口中显示该描述。

点击**快速查看**图标以查看变量的图形显示。您可以为您的对象实现自定义的快速查看显示。

当你在连接的设备上构建和运行OpenGL ES应用时，调试区域工具栏包括一个**帧捕获**按钮。点击此按钮以捕获一个帧。您可以使用OpenGL ES帧捕获执行以下操作：

+   检查OpenGL ES状态信息

+   反射OpenGL ES对象，如视图纹理和着色器

+   步骤遍历每个绘制调用之前的调用状态（当前调试状态信息），并观察每次调用时的变化

+   步骤遍历绘制调用（应用当前渲染状态）以查看图像是如何构建的

+   通过检查辅助编辑器查看每个绘制调用使用的对象

+   编辑着色器（如图像的渲染方式，例如颜色信息、光晕、镜头光晕等特殊效果），以查看对应用程序的影响。

左侧的调试导航器显示了渲染树的部分，而主调试视图显示了渲染帧的颜色和深度来源，以及其他图像来源。

点击调试区域顶部的工具栏中的**调试视图层次结构**按钮，以检查暂停应用的视图层次结构的 3D 渲染。您可以执行以下操作：

+   通过在画布上点击和拖动来旋转渲染。什么是画布？那是在 Xcode 中看到应用渲染的地方。

+   使用左下角的滑块来增加或减少视图层之间的间距。

+   使用右下角的滑块来更改可见视图的范围。将左侧的手柄移动到最底部的可见视图。将右侧的手柄移动到最顶部的可见视图，以获得所需的视图。毕竟，场景中还有更多的事情在进行，某些视图不会显示出来！

+   通过点击**显示剪裁内容**按钮来揭示所选视图的任何剪裁内容。

+   您还可以通过点击**显示剪裁内容**按钮来揭示所选视图的任何剪裁内容。如果您的视图由于屏幕尺寸较小而被剪裁，您可以这样做。

+   使用**放大 (+)**和**缩小 (-)**按钮来增加和减少放大倍数。

如本书中所述，iOS 模拟器可以帮助你在设计和早期测试阶段发现应用中的主要问题，因为它正是这样一个模拟器。并不是每个人都能负担得起每一款新的苹果设备！

当我坐在我的 27 英寸 iMac、13 英寸 MacBook Pro 前面，用我的 5S 发短信，给我的 iPad 充电，目前正在考虑购买苹果手表并穿着我的苹果商店衬衫时……嗯……难怪我没有钱。

接下来！

在 iOS 模拟器的每个模拟环境中，主屏幕提供了访问包含在 iOS 设备上的应用（如 Safari、联系人、地图和 Passbook）的途径。

您可以在 iOS 模拟器中通过这些应用对您应用的交互进行初步测试。例如，就像我们做的那样，如果您正在测试一个游戏，请使用 iOS 模拟器来测试该游戏是否正确使用 Game Center。

iOS 模拟器中的**无障碍检查器**可以帮助您测试您应用的可用性，无论个人的限制或残疾如何。

无障碍检查器显示您应用中每个可访问元素的信息，并允许您模拟与这些元素的 VoiceOver 交互。要启动无障碍检查器，请点击 iOS 模拟器上的**主**按钮。点击**设置**，然后转到**通用** | **辅助功能**。将**无障碍检查器**开关设置为**开启**。

您可以通过更改语言在 iOS 模拟器中测试您应用的本地化。在**设置**中，导航到**通用** | **国际** | **语言**。

现在，这些显然是一些相当超前的步骤，你可以采取。我认为并不是每个游戏都需要无障碍功能（或者每个开发者都会将其包含在他们的应用中），但如果你的应用将在全球范围内被看到，并且你希望每个人都能使用它，那么这些都是需要记住的好事情。

虽然你可以在 iOS 模拟器中测试你应用的基本行为，但模拟器作为一个测试平台在多个方面都是有限的。为什么是这样？考虑以下因素：

+   iOS 模拟器是一个在 Mac 上运行的应用，它可以访问计算机的内存，这比设备上的内存大得多。

+   iOS 模拟器在 Mac CPU 上运行，而不是在 iOS 设备的处理器上。

+   iOS 模拟器不会运行设备上运行的所有线程。

+   iOS 模拟器无法模拟硬件功能，例如加速度计、陀螺仪、摄像头或接近传感器。*所以不要把你的电脑扔来模拟加速度计控制！*请不要……请不要问……我保证我没有这么做。

在开发你的应用时，确保你在你打算支持的所有的 iOS 设备和 iOS 版本上运行和测试它。这样做是常识，因为你可以为每个设备调整性能。

我知道这需要记住很多东西，而且你可能每次测试应用或构建新应用时都不会考虑这些。如果在你自己的开发中遇到问题，这些信息是很好的背景知识。

我们确实讨论了一些性能问题，比如在 iPhone 4S 上渲染大量粒子会降低性能，几乎会导致设备完全崩溃。这就是我们将在下一章讨论的内容——如何管理性能并尽量减少电池消耗！

# 摘要

让我们看看本章我们讨论了什么。嗯，我们没讨论什么？！我们讨论了所有关于调试的事情。我们一开始就谈到了在 iOS 模拟器上安装和测试我们的应用。鉴于它的局限性，我们接着在物理设备上进行测试，因为嘿，当你试图测试一个像我们创建的平台游戏时，同时点击两个区域是非常困难的。

我们接着讨论了设置 TestFlight，以便我们可以让测试者帮助我们找到隐藏在我们代码深处的贪婪的虫子。再次强调，一个七岁的孩子猛击屏幕肯定比一个20岁以上的尊重设备的开发者更快地找到虫子。

我们接着讨论了调试的乐趣以及调试的所有优秀技巧和窍门。我们还涵盖了需要注意的事项，以及各种方式来逐行测试我们的代码，以及减慢动画速度，以便我们可以看到事情发生的过程。

这章的内容需要阅读很多，我们将在下一章中进一步探讨。

别担心；我们离最好的部分只有两章的距离：盈利。此外，我们还将回到创建游戏。我没有忘记这一点！

我将在下一章见到你！
