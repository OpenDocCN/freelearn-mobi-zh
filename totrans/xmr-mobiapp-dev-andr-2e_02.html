<html><head></head><body><h1 id="e-NkQB">Chapter 2. The Xamarin.Android Architecture</h1>
<p id="e-fg4l">Now that we have an understanding of the Android platform, let's talk about Xamarin. In this chapter, we will take a look at the architecture of Xamarin.Android and how it facilitates the development of Android apps using C# and .NET. This chapter covers the following topics:</p>
<ul id="e-JKmg">
<li id="e-FQfN">The benefits and drawbacks of adopting Xamarin.Android</li>
<li id="e-cOck">What is Mono?</li>
<li id="e-Wrha">Mono and Android Runtime side by side (peer objects)</li>
<li id="e-bTIu">The Xamarin.Android binding libraries</li>
<li id="e-LHSR">Development of IDE choices</li>
</ul>
<h1 id="e-yq1N">Getting started with Xamarin</h1>
<p id="e-h947">Xamarin is a San Francisco, California-based software company, which provides commercial software development tools, that leverage the Mono open source project in order to allow you to develop applications for Android, iOS, and Mac using C# and the .NET framework.</p>
<p id="e-XZsU">Xamarin brings a wide range of products to simplify the mobile application development in a cross-platform way. The following are some of the products offered by Xamarin:</p>
<ul id="e-IBPO">
<li id="e-Lv5Y">
<strong>The Xamarin platform</strong>: Xamarin uses the open source implementation of the.NET framework called Mono. The Xamarin framework implementation includes its own compiler written in C# and the .NET libraries. The Xamarin platform includes the following products:<ul id="e-dP5g">
<li id="e-rDFi">
<strong>Xamarin.iOS</strong>: This is also known as MonoTouch. This is used for building native iOS applications using C# and .NET.</li>
<li id="e-AIEH">
<strong>Xamarin.Android</strong>: This is also known as Mono for Android or formally known as MonoDroid. This is used for building native Android applications using C# and .NET.</li>
<li id="e-dwi7">
<strong>Xamarin.Forms</strong>: In both Xamarin.Android and Xamarin.iOS, we cannot build a pure cross-platform application. The part of the application that is platform-independent can then be isolated and reused across the platform; however, you still need to write platform-specific code for designing the application's interface. This is where Xamarin.Forms comes into picture. Xamarin.Forms allows you to write the user-interface code that can be compiled for the iPhone, Android, and Windows Phone.</li>
<li id="e-Ym5J">
<strong>Xamarin.Mac</strong>: This is also known as Mono for Mac. Xamarin.Mac allows you to develop fully native Mac applications in C# and .NET.</li>
<li id="e-sheg">
<strong>Xmarin.Windows</strong>: This is also known as Mono for Windows. Xamarin.Windows allows you to develop a fully Windows App in C# and .NET.</li>
</ul>
<p id="e-fbf9">The product we will use in this book for developing the Android application is Xamarin.Android.</p>
</li>
<li id="e-uBBe">
<strong>Development IDEs</strong>: Along with frameworks, it also brings the required development IDEs, such as Xamarin Studio and the Visual Studio plugin. Xamarin Studio is a fully integrated IDE, which comes handy with the Xamarin package. Xamarin Studio can be used for both Windows and Mac operating systems. Xamarin Studio includes some of the rich features, including code completion, a debugging interface, an Android layout builder, and integration with Xcode Interface Builder for iOS app design. However, if you're familiar with Visual Studio, you can continue to take almost all the benefits mentioned earlier from Visual Studio using the Visual Studio support plugin.</li>
<li id="e-PzxL">
<strong>Xamarin Test Cloud:</strong> Mobile application testing is quite challenging, as we have to consider the various form factors, device densities, connectivity types, and different OS versions. It is nearly impossible to test your application on all the targeted devices. Xamarin Test Cloud is an answer to this problem. Xamarin Test Cloud makes it possible to test mobile apps written in any language on collection of real devices from around the world. You can write your test scripts using the Xamarin testing framework and automate your app testing from CI Systems.</li>
</ul>

<h1 id="e-IYba">Why Xamarin.Android?</h1>
<p id="e-oBuL">Before we take a dive into the architecture of Xamarin.Android, let's first discuss the question of why Xamarin.Android is our choice. Like any significant platform decision, one size does not fit all, and there are a number of things that should be considered. The following two lists identify some of the key benefits and drawbacks of using Xamarin.Android.</p>
<h2 id="e-SCMy">The benefits of using Xamarin.Android</h2>
<ul id="e-dGPr">
<li id="e-Di1L">
<strong>It leverages existing C# and .NET skills</strong>: Developers invest a great deal of time and energy in mastering the many features of the C# language and the effective use of the .NET framework. Yes, Java and all object-oriented languages have many similarities, but there is a real cost associated with going from being proficient in C# and .NET to making the same claim in Java. Individuals and groups that have made a significant investment in C# and .NET and need to develop Android apps would be well served to at least consider Xamarin.Android.</li>
<li id="e-aFl3">
<strong>It can be reused in cross-platform development</strong>: While Xamarin will not allow you to build a single app that can be deployed to Android, iOS, and Windows, it does give you the capability to reuse large portions of your code base across all of these platforms. In general, the user interface code and the code that deals with the device capabilities tend to be written for each platform, while things such as service client logic, client-side validation, data caching, and client-side data storage can potentially be shared across multiple platforms. This can save a significant amount of time and cost.</li>
</ul>
<h2 id="e-Rikn">The drawbacks of using Xamarin.Android</h2>
<ul id="e-tzlH">
<li id="e-IKZ6">
<strong>The licensing requirement</strong>: Xamarin.Android as well as Xamarin.iOS and Xamarin.Mac are all commercial tools and must be licensed, so there is a tangible cost of entry. Check the Xamarin website for current pricing.</li>
<li id="e-t9uj">
<strong>Waiting for updates</strong>: There is some lag time between a new release of the Android platform and the corresponding release of Xamarin.Android. However, Xamarin is aiming for zero day support for the new version of Android and iOS.</li>
<li id="e-WQCH">
<strong>Distribution size</strong>: There are a number of runtime libraries that must be distributed with a Xamarin.Android application. We will discuss the actual size and strategies for minimizing the distribution size in the last chapter.</li>
</ul>
<p id="e-qAaT">While the list of drawbacks may seem extensive; in most cases, the impact of each can be minimized. If you are a group or individual that places a high value on the benefits, you should seriously consider Xamarin.Android.</p>

<h1 id="e-KJ1c">What is Mono?</h1>
<p id="e-zkgd">Mono is an open source, cross-platform implementation of a C# compiler, and a <strong>Common Language Runtime</strong> (<strong>CLR</strong>) that is binary compatible with Microsoft .NET. The Mono CLR has been ported to many platforms, including Android, most Linux distributions, BSD, OS X, Windows, Solaris, and even some game consoles, such as Wii and Xbox 360. In addition, Mono provides a static compiler that allows apps to be compiled for environments, such as iOS and PS3.</p>
<p id="e-CRmc">Mono for Android runs natively and provides almost all the capabilities that a typical native Android app can have. It allows developers to reuse a larger portion of the code without a major performance trade-off.</p>

<h1 id="e-Gzjl">Mono and Dalvik side by side</h1>
<p id="e-sTnR">As you can recall from, Chapter 1, <em>The Anatomy of an Android App</em>, Android apps run within the Dalvik VM, and we now know that Mono apps run within the Mono CLR. So how does a Xamarin.Android app run? A simple answer is that it uses both the Mono CLR and the Dalvik VM. The following diagram depicts how the runtimes coexist:</p>
<img data-width="500" data-height="363" src="img/UKyr5JC5.jpg"/><p id="e-O4Ki">Xamarin.Android applications use both Mono CLR and the Dalvik VM side by side and run on top of the Linux kernel. The .Net API resides as a part of the Mono CLR and provides a set of classes (for example, System.Data, System.Net, System.IO, and so on.) to access various device OS features. However, with .Net APIs, you cannot directly access most of the device-specific features, such as Audio, Telephony, OpenGL, and so on. They are made available as a part of the Android SDK or as Java API and can be accessed using the Android binding libraries. The following section covers more on the Android binding libraries.</p>
<p id="e-NrNd">Since Android 5.0 (Lollipop) release, the Dalvik VM was replaced by its successor, Android Runtime (ART). This means that now Xamarin.Android applications run with the Mono VM alongside ART. Both the runtimes work on top of the Linux kernel and expose a set of classes to access the device features.</p>
<p id="e-fsXb">So, how do the Mono CLR and <strong>Android Runtime</strong> (<strong>ART</strong>) work together in a Xamarin.Android app? The magic is accomplished through a concept called and a framework called the JNI.</p>
<h2 id="e-cJnU">The Java Native Interface</h2>
<p id="e-MQsf">The <strong>Java Native Interface</strong> (<strong>JNI</strong>) is a framework that allows a non-Java code (such as C++ or C#) to call or be called by a Java code running inside a JVM. As you can see from the preceding diagram, JNI is a critical component in the overall Xamarin.Android architecture.</p>
<h2 id="e-isg2">Peer objects</h2>
<p id="e-zcEB">Peer objects are a pair of objects consisting of a managed object residing in the Mono CLR and a Java object residing in the Dalvik VM, which work together to perform the functions of a Xamarin.Android app.</p>
<p id="e-B7va">Xamarin.Android is delivered with a set of assemblies called the Android binding libraries. Classes in the Android binding libraries correspond to the Java classes in the Android application framework, and the methods in the binding classes act as wrappers to call corresponding methods on Java classes. Binding classes are referred to as <strong>Managed Callable Wrappers</strong> (<strong>MCW</strong>). Anytime you create a C# class that inherits from one of these binding classes, a corresponding Java proxy class is generated at build time. The Java proxy contains a generated override for each overridden method in your C# class and acts as a wrapper to call the corresponding method on the C# class.</p>
<p id="e-Pu7z">The creation of peer objects can be initiated from within the Dalvik VM by the Android application framework or from within the Mono CLR by the code you write in the overridden methods. A reference between the two peer objects is kept by each instance of a MCW and can be accessed through the <code>Android.Runtime.IJavaObject.Handle</code> property.</p>
<p id="e-j1dH">The following diagram depicts how peer objects collaborate:</p>
<img data-width="600" data-height="350" src="img/BtSojYUm.jpg"/><h2 id="e-IXMw">Xamarin.Android application packaging</h2>
<p id="e-oWDH">In Chapter 1, <em>The Anatomy of an Android App</em>, we discussed Android packages (<code>.apk</code> files). Xamarin.Android creates the <code>.apk</code> files but also includes the following additional types of files:</p>
<ul id="e-LWjK">
<li id="e-ZAVs">The C# code is stored as assemblies (containing IL) in the assembly folder of the archive.</li>
<li id="e-ncN8">The Mono runtime is packaged as native libraries within the apk. The Xamarin.Android application must contain the native libraries for the desired Android architectures. If it doesn't contain the required libraries, the application will fail to run for those architectures.</li>
</ul>

<h1 id="e-yi54">The Android bindings design</h1>
<p id="e-EhQo">The core parts of Xamarin.Android are the bindings for the Android APIs. The Xamarin team focused a great deal in developing a consistent approach to create the bindings so that a C# .NET developer would feel at home when using them. This has resulted in a number of key benefits as follows:</p>
<ul id="e-PB5K">
<li id="e-DCVM">The Android API feels natural to a C# .NET developer and allows the developer to explore the API using the code completion and pop-up documentation from within the IDE</li>
<li id="e-sI8c">C# developers can leverage the vast array of Java/Android examples and documentation that can be easily transformed for use with C# and Xamarin.Android</li>
</ul>
<h2 id="e-URfF">Design principles</h2>
<p id="e-tM9p">The following are some of the key design principles for the Xamarin.Android binding. A complete set of design principles can be found on the Xamarin website:</p>
<ul id="e-bkTL">
<li id="e-T5OT">Allowing developers to subclass Java classes from the Android application framework</li>
<li id="e-Haqy">Exposing a strongly typed API</li>
<li id="e-mAbn">Exposing JavaBean properties as C# properties</li>
<li id="e-Wnq1">Exposing Java event listeners as C# delegates</li>
</ul>
<h2 id="e-wLFg">C# properties</h2>
<p id="e-rtxa">The JavaBean properties, the getter and setter methods, are transformed to C# properties, when appropriate. The following rules are used to determine when properties should be created:</p>
<ul id="e-Y3GP">
<li id="e-HqsV">Read/write properties are created for the getter and setter method pairs</li>
<li id="e-c1aY">Read-only properties are created for getters without corresponding setter methods</li>
<li id="e-CM7b">No write-only properties are created in the rare case that only a setter exists</li>
<li id="e-Mc38">Properties are not created when the type would be an array<h3 id="e-UraR">Note</h3>
<p id="e-pY3e">As you may be aware, Java does not have a property construct but instead follows a design pattern defined in the JavaBean specification. In order to define a property, a developer simply creates the public getter and setter methods with read-only properties that only provide a getter method.</p>
</li>
</ul>
<h2 id="e-ocpO">Delegates</h2>
<p id="e-hYpz">The Android APIs follow the Java pattern for defining and hooking up event listeners. The C# developers are more familiar with using delegates and events, so the Android bindings attempt to facilitate this using the following rules:</p>
<ul id="e-dUk8">
<li id="e-pY8J">When a <code>listener</code> callback has a <code>void</code> return, an event is generated based on the <code>EventHandler</code> delegate</li>
<li id="e-Hb2H">When a <code>listener</code> callback does not have a <code>void</code> return, a specific delegate is generated that supports the appropriate signature</li>
</ul>
<p id="e-TTrP">These events or properties are only created under the following conditions:</p>
<ul id="e-tIEB">
<li id="e-F3Lh">The Android event handling method has a prefix, for example, <code>setOnClickListener</code>
</li>
<li id="e-UMdk">The Android event handler has a <code>void</code> return type</li>
<li id="e-lnbV">The Android event handler has a single parameter</li>
</ul>
<h2 id="e-WzDW">Constants to enumerations</h2>
<p id="e-pKkW">It is common in the Android APIs to see methods that accept or return an <code>int</code> type that must be mapped to a constant to determine its meaning. When possible, the Xamarin team creates a .NET enumeration to replace the constants and adjusts the appropriate methods to work with the enumerations. This provides a significant productivity gain by being able to use IntelliSense from within the IDE as well as enhance the type safety of the methods.</p>

<h1 id="e-rPp8">Development environments</h1>
<p id="e-xyob">The choice of an appropriate IDE for development is absolutely mandatory, as it can greatly ease and speed up your development, if you choose the right one. There are two choices when it comes to IDEs: Xamarin Studio or Visual Studio.</p>
<p id="e-L1rb">For developing an iOS application, you can use either use Xamarin Studio or the Xamarin iOS Visual Studio plugin on Windows machines. However, you cannot build and run an iOS application on Windows OS. You must have a Mac computer.</p>
<p id="e-QCUi">Windows users have two IDE choices for developing the Android application. You can either use Xamarin Studio or Visual Studio. If you're on Mac OS, then you have to use the Android Studio IDE. All the examples in this book are developed using Xamarin Studio on Mac.</p>
<p id="e-yHtF">The following section lists some of the unique features that come handy with both Xamarin Studio and the Visual Studio IDE.</p>
<h2 id="e-GuOX">Xamarin Studio</h2>
<p id="e-Pbmc">Xamarin Studio is a customized version of the MonoDevelop IDE, which can be used to develop Android, iOS, and OS X applications. Xamarin Studio is available on both OS X and Windows and has many advanced features as follows:</p>
<ul id="e-mPci">
<li id="e-sDYt">Code completion</li>
<li id="e-bTFR">Smart syntax highlighting</li>
<li id="e-HvqR">Code navigation</li>
<li id="e-eQI0">Code tooltips</li>
<li id="e-LTjO">Integrated debugging for mobile apps running on emulators or on devices</li>
<li id="e-SGSS">Source control integration with Git and subversion built-in</li>
<li id="e-lCfj">The Xamarin component store</li>
<li id="e-PYvW">The NuGet package browser</li>
</ul>
<p id="e-hz04">The following screenshot shows Xamarin Studio on Mac OS with the Android user interface designer opened:</p>
<img data-width="800" data-height="454" src="img/VHxdSxnb.jpg"/><h2 id="e-Ei35">Xamarin for Visual Studio</h2>
<p id="e-uDxv">Xamarin for Visual Studio is an add-in that supports the development of the Xamarin.Android and Xamarin.iOS apps. The Visual Studio add-in for Xamarin requires at least a business or enterprise license. It is not available for basic Indie lenience users. If you already have a license for Visual Studio and are comfortable with the environment, the add-in will likely be more appealing than Xamarin Studio because of the simplicity of adoption. Apart from the basic features, such as code completion, syntax highlighter, smart navigation and tooltip, the Xamarin Visual Studio add-in extends the IDE capabilities to make the mobile development painless. The following are some of the specialized features from Xamarin for Visual Studio that are add-ins:</p>
<ul id="e-VLi3">
<li id="e-fAlC">
<strong>IntelliSense</strong>: This helps developers take a quick look up at the language reference for both iOS and Android APIs.</li>
<li id="e-qHfT">
<strong>Visual Designer</strong>: With Visual Designers, you don't necessarily need to remember all the properties of a view, while building UI layouts for multiple resolutions. This also integrates with a property editor that enables easy property configurations such as color, font, size, margin, view ID, and so on.</li>
</ul>
<p id="e-Llxd">The following screenshot shows Visual Studio 2012 with the Android user interface designer opened:</p>
<img data-width="800" data-height="565" src="img/gZd3WcOH.jpg"/><h2 id="e-ZVX4">IDE comparison</h2>
<p id="e-rNu8">It is not a surprise that every IDE provides the basic core functionalities for developers and some of the unique features of its own. The following table depicts the pros and cons of two different IDE choices available for the Xamarin.Android development:</p>
<p id="e-bfpz">IDE</p>
<p id="e-wPXY">Pros</p>
<p id="e-UwtK">Cons</p>
<p id="e-fZA1">Xamarin Studio</p>
<ul id="e-DCjY"><li id="e-LXmw">It comes with Xamarin.Android and no additional license is required. It runs on Windows and OS X.</li></ul>
<ul id="e-IbMP">
<li id="e-juGZ">It runs on both Windows and Mac OS for the Xamairn.Android license.</li>
<li id="e-swyP">By default, it does not support the use of TFS for source control.</li>
</ul>
<p id="e-Ciji">Visual Studio</p>
<ul id="e-ql3j">
<li id="e-ZiuV">Most of the C# developers are already familiar and comfortable with Visual Studio.</li>
<li id="e-hc3Y">This comes in handy when using TFS for source control, which is used in many .NET shops. No additional third-party tool or configuration is required while using TFS in Visual Studio.</li>
</ul>
<ul id="e-SF9J">
<li id="e-ZhVg">It requires the Xamarin Android business or enterprise licenses for using Visual Studio.</li>
<li id="e-a0cL">It runs on Windows only.</li>
</ul>
<h2 id="e-lYZY">Compatibility</h2>
<p id="e-BSWo">The solution and project files created and updated by Xamarin Studio are compatible with Visual Studio, making it easy to switch between the two environments throughout the duration of a project. This also allows the team members to adopt the tool that they are most comfortable with or that runs on their platform of choice.</p>

<h1 id="e-lZmf">Summary</h1>
<p id="e-HJzx">In this chapter, we discussed the architecture of Xamarin.Android and the magic of how it facilitates the creation of Android apps using C# and .NET. We also reviewed a set of benefits and drawbacks of adopting Xamarin.Android. In the next chapter, we will install Xamain.Android and create a project that we will build for the remainder of the book.</p>
</body></html>