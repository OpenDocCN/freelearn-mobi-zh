<html><head></head><body>
		<div id="_idContainer461">
			<h1 id="_idParaDest-267"><em class="italic"><a id="_idTextAnchor319"/>Chapter 19</em>: Getting Started with Custom UIControls</h1>
			<p>At this point, your app has data in all of its screens, but the <strong class="bold">Restaurant Detail</strong> screen is incomplete. You can't set a star rating for a restaurant, and you can't add photos or reviews.</p>
			<p>You have been using Apple's standard UI elements so far. In this chapter, you'll create a custom subclass of the <strong class="source-inline">UIControl</strong> class that displays restaurant ratings in the form of stars. You'll modify this subclass so users can set a rating for a restaurant by tapping it. After that, you'll implement a review form that allows users to submit restaurant reviews.</p>
			<p>By the end of this chapter, you'll have learned how to create custom <strong class="source-inline">UIControl</strong> classes, handle touch events, and implement review forms for your own apps.</p>
			<p>The following topics will be covered in this chapter:</p>
			<ul>
				<li>Creating a custom <strong class="source-inline">UIControl</strong> subclass</li>
				<li>Displaying stars in your custom <strong class="source-inline">UIControl</strong> subclass</li>
				<li>Adding support for touch events</li>
				<li>Implementing an unwind method for the <strong class="bold">Cancel</strong> button</li>
				<li>Creating the <strong class="source-inline">ReviewFormViewController</strong> class</li>
			</ul>
			<h1 id="_idParaDest-268"><a id="_idTextAnchor320"/>Technical requirements</h1>
			<p>You will continue working on the <strong class="source-inline">LetsEat</strong> project that you modified in the previous chapter.</p>
			<p>The completed Xcode project for this chapter is in the <strong class="source-inline">Chapter19</strong> folder of the code bundle for this book, which can be downloaded here: <a href="https://github.com/PacktPublishing/iOS-15-Programming-for-Beginners-Sixth-Edition"/></p>
			<p><a href="https://github.com/PacktPublishing/iOS-15-Programming-for-Beginners-Sixth-Edition">https://github.com/PacktPublishing/iOS-15-Programming-for-Beginners-Sixth-Edition</a><a href="https://github.com/PacktPublishing/iOS-15-Programming-for-Beginners-Sixth-Edition&#13;"/></p>
			<p>Check out the following video to see the code in action:</p>
			<p><a href="https://bit.ly/3cRFcXa">https://bit.ly/3cRFcXa</a></p>
			<p>Let's start by learning how to create a custom <strong class="source-inline">UIControl</strong> subclass that will display a star rating on the screen.</p>
			<h1 id="_idParaDest-269"><a id="_idTextAnchor321"/>Creating a custom UIControl subclass</h1>
			<p>You've only <a id="_idIndexMarker1010"/>used Apple's predefined UI elements so far, such as labels and buttons. All you had to do was click the Library button, search for the object you want, and drag it into the storyboard. However, there will be cases where the objects provided by Apple are either unsuitable or don't exist. In such cases, you will need to build your own. Let's review the <strong class="bold">Restaurant Detail</strong> screen that you saw in the app tour:</p>
			<div>
				<div id="_idContainer441" class="IMG---Figure">
					<img src="image/Figure_19.01_B17469.jpg" alt="Figure 19.1: Restaurant Detail screen showing the star rating&#13;&#10;"/>
				</div>
			</div>
			<p class="figure-caption">Figure 19.1: Restaurant Detail screen showing the star rating</p>
			<p>You can see a <a id="_idIndexMarker1011"/>group of five stars just above the <strong class="bold">Add Review</strong> button. Currently, the <strong class="bold">Restaurant Detail View Controller Scene</strong> in the <strong class="source-inline">RestaurantDetail</strong> storyboard file and the <strong class="bold">Table View Controller Scene</strong> in the <strong class="source-inline">ReviewForm</strong> storyboard file have blank view objects where the stars should be. You will create the <strong class="source-inline">RatingsView</strong> class, a custom subclass of the <strong class="source-inline">UIControl</strong> class, that you will use in both scenes. The <strong class="source-inline">UIControl</strong> class is a subclass of the <strong class="source-inline">UIView</strong> class, and it is used as the superclass for the <strong class="source-inline">RatingsView</strong> class because <strong class="source-inline">RatingsView</strong> instances have to respond when the user taps on them.</p>
			<p class="callout-heading">Important Information</p>
			<p class="callout">You can learn more about <strong class="source-inline">UIControl</strong> at <a href="https://developer.apple.com/documentation/uikit/uicontrol">https://developer.apple.com/documentation/uikit/uicontrol</a>.</p>
			<p>A <strong class="source-inline">RatingsView</strong> instance will display ratings as stars. The user will also be able to select half-stars. Let's begin by creating a subclass of the <strong class="source-inline">UIControl</strong> class. Follow these steps:</p>
			<ol>
				<li>Right-click<a id="_idIndexMarker1012"/> the <strong class="source-inline">Review Form</strong> folder and select <strong class="bold">New File</strong>.</li>
				<li><strong class="bold">iOS</strong> should already be selected. Choose <strong class="bold">Cocoa Touch Class</strong> and then click <strong class="bold">Next</strong>.</li>
				<li>Configure the file as follows:<p><strong class="bold">Class</strong>: <strong class="source-inline">RatingsView</strong></p><p><strong class="bold">Subclass</strong>: <strong class="source-inline">UIControl </strong></p><p><strong class="bold">Language</strong>: <strong class="source-inline">Swift </strong></p><p>Click <strong class="bold">Next</strong>.</p></li>
				<li>Click <strong class="bold">Create</strong>. The <strong class="source-inline">RatingsView</strong> file will appear in the Project navigator.</li>
			</ol>
			<p>Now you need to set the identity of the view object next to the <strong class="bold">0.0</strong> label in the <strong class="bold">Restaurant Detail View Controller Scene</strong> to <strong class="source-inline">RatingsView</strong>. Follow these steps:</p>
			<ol>
				<li value="1">Expand the <strong class="source-inline">RestaurantDetail</strong> folder in the Project navigator. Click the <strong class="source-inline">RestaurantDetail</strong> storyboard file and select the <strong class="bold">View</strong> object next to the <strong class="bold">0.0</strong> <strong class="bold">Label</strong> as shown:<div id="_idContainer442" class="IMG---Figure"><img src="image/Figure_19.02_B17469.jpg" alt="Figure 19.2: Editor area showing View object next to the 0.0 Label&#13;&#10;"/></div><p class="figure-caption">Figure 19.2: Editor area showing View object next to the 0.0 Label</p></li>
				<li>Click the <a id="_idIndexMarker1013"/>Identity inspector button. Under <strong class="bold">Custom Class</strong>, set <strong class="bold">Class</strong> to <strong class="source-inline">RatingsView</strong>:</li>
			</ol>
			<div>
				<div id="_idContainer443" class="IMG---Figure">
					<img src="image/Figure_19.03_B17469.jpg" alt="Figure 19.3: Identity inspector with Class set to RatingsView&#13;&#10;"/>
				</div>
			</div>
			<p class="figure-caption">Figure 19.3: Identity inspector with Class set to RatingsView</p>
			<p>Now let's modify the <strong class="source-inline">RatingsView</strong> class to make it display stars. You'll use the graphic assets <a id="_idIndexMarker1014"/>inside the <strong class="source-inline">Assets.xcassets</strong> file to do this in the next section.</p>
			<h2 id="_idParaDest-270"><a id="_idTextAnchor322"/>Displaying stars in your custom UIControl subclass</h2>
			<p>So far, you <a id="_idIndexMarker1015"/>have created a new <strong class="source-inline">UIControl</strong> subclass <a id="_idIndexMarker1016"/>named <strong class="source-inline">RatingsView</strong> in your project. You have also assigned the class of the view object next to the <strong class="bold">0.0</strong> label in the <strong class="source-inline">Restaurant </strong><strong class="source-inline">Detail</strong> screen to the <strong class="source-inline">RatingsView</strong> class. For the rest of this chapter, an instance of the <strong class="source-inline">RatingsView</strong> class will be referred to as a ratings view (the same way an instance of the <strong class="source-inline">UIButton</strong> class is referred to as a button). In this section, you will add some code to the <strong class="source-inline">RatingsView</strong> class to make a ratings view display stars. Follow these steps:</p>
			<ol>
				<li value="1">Click the <strong class="source-inline">RatingsView</strong> file in the Project navigator and remove all the commented code.</li>
				<li>Type the following after the <strong class="source-inline">RatingsView</strong> class declaration to declare the properties for the class:<p class="source-code">private let filledStarImage = UIImage(named: </p><p class="source-code">"filled-star")</p><p class="source-code">private let halfStarImage = UIImage(named: </p><p class="source-code">"half-star")</p><p class="source-code">private let emptyStarImage = UIImage(named: </p><p class="source-code">"empty-star")</p><p class="source-code">private var totalStars = 5</p><p class="source-code">var rating = 0.0</p><p>The first three properties, <strong class="source-inline">filledStarImage</strong>, <strong class="source-inline">halfStarImage</strong>, and <strong class="source-inline">emptyStarImage</strong>, are assigned the star images stored in the <strong class="source-inline">Assets.xcassets</strong> file.</p><p>The <strong class="source-inline">totalStars</strong> property determines the total number of stars to be drawn.</p><p>The <strong class="source-inline">rating</strong> property is used to store a restaurant rating. The types of stars drawn will be determined by the value of <strong class="source-inline">rating</strong>. For instance, if <strong class="source-inline">rating</strong> is <strong class="source-inline">3.5</strong>, the ratings view will display three filled stars, one half-filled star, and one empty star.</p></li>
			</ol>
			<p>Next, let's create <a id="_idIndexMarker1017"/>the method that will draw the ratings<a id="_idIndexMarker1018"/> view on the screen. All <strong class="source-inline">UIView</strong> subclasses have a <strong class="source-inline">draw(_:)</strong> method, which is responsible for drawing their views on the screen. You'll override the superclass implementation of this method for the <strong class="source-inline">RatingsView</strong> class. Follow these s<a id="_idTextAnchor323"/><a id="_idTextAnchor324"/>teps:</p>
			<ol>
				<li value="1">Add the following code in the class declaration after the property declarat<a id="_idTextAnchor325"/><a id="_idTextAnchor326"/>ions:<p class="source-code">override func draw(_ rect: CGRect) {</p><p class="source-code">   let context = UIGraphicsGetCurrentContext()</p><p class="source-code">   context!.setFillColor(UIColor.systemBackground.</p><p class="source-code">   cgColor)</p><p class="source-code">   context!.fill(rect)</p><p class="source-code">   let ratingsViewWidth = rect.size.width</p><p class="source-code">   let availableWidthForStar = ratingsViewWidth /</p><p class="source-code">   Double(totalStars)</p><p class="source-code">   let starSidelength = (availableWidthForStar &lt;= </p><p class="source-code">   rect.size.height) ? availableWidthForStar : </p><p class="source-code">   rect.size.height</p><p class="source-code">   for index in 0..&lt;totalStars {</p><p class="source-code">      let starOriginX = (availableWidthForStar * </p><p class="source-code">      Double(index)) + ((availableWidthForStar - </p><p class="source-code">      starSidelength) / 2)</p><p class="source-code">      let starOriginY = ((rect.size.height - </p><p class="source-code">      starSidelength) / 2)</p><p class="source-code">      let frame = CGRect(x: starOriginX, </p><p class="source-code">      y: starOriginY, width: starSidelength,</p><p class="source-code">      height: starSidelength)</p><p class="source-code">      var starToDraw: UIImage!</p><p class="source-code">      if (Double(index + 1) &lt;= self.rating) {</p><p class="source-code">         starToDraw = filledStarImage</p><p class="source-code">      } else if (Double(index + 1) &lt;= </p><p class="source-code">      self.rating.rounded()) {</p><p class="source-code">         starToDraw = halfStarImage</p><p class="source-code">      } else {</p><p class="source-code">         starToDraw = emptyStarImage</p><p class="source-code">      }</p><p class="source-code">      starToDraw.draw(in: frame)</p><p class="source-code">   }</p><p class="source-code">}</p><p>Let's break this down:</p><p class="source-code">let context = UIGraphicsGetCurrentContext()</p><p>Creates an<a id="_idIndexMarker1019"/> instance of <strong class="source-inline">UIGraphicsGetCurrentContext</strong> and assigns it to <strong class="source-inline">context</strong>. You can think of it as a <a id="_idIndexMarker1020"/>sketchpad, where you will compose UI elements together.</p><p class="source-code">context!.setFillColor(UIColor.systemBackground.</p><p class="source-code">cgColor)</p><p>Sets the fill color of <strong class="source-inline">context</strong> to the default system background color.</p><p class="source-code">context!.fill(rect)</p><p>Fills the rectangular area specified by <strong class="source-inline">rect</strong> with the fill color.</p><p class="source-code">let ratingsViewWidth = rect.size.width</p><p class="source-code">let availableWidthForStar = ratingsViewWidth / </p><p class="source-code">Double(totalStars)</p><p class="source-code">let starSidelength = (availableWidthForStar &lt;= </p><p class="source-code">rect.size.height) ? availableWidthForStar : </p><p class="source-code">rect.size.height</p><p>These statements determine how big each star should be. The first statement gets the width of the ratings view and assigns it to <strong class="source-inline">ratingsViewWidth</strong>. The next statement gets the width available for each star by dividing the width of the ratings view by the number of stars that need to be drawn. This value is assigned to <strong class="source-inline">availableWidthForStar</strong>. For the third statement, imagine that each <a id="_idIndexMarker1021"/>star is enclosed in a rectangle. This <a id="_idIndexMarker1022"/>statement calculates how long each side of this rectangle should be in order to fit within the ratings view. If <strong class="source-inline">availableWidthForStar</strong> is less than or equal to the ratings view's height, <strong class="source-inline">starSideLength</strong> is set to <strong class="source-inline">availableWidthForStar</strong>; otherwise, it's set to be the same as the ratings view's height.</p><p class="callout-heading">Important Information</p><p class="callout">The third statement makes use of a <strong class="bold">ternary operator</strong>. More information can be found at this link: <a href="https://docs.swift.org/swift-book/LanguageGuide/BasicOperators.html">https://docs.swift.org/swift-book/LanguageGuide/BasicOperators.html</a>.</p></li>
			</ol>
			<p>For example, let's assume the ratings view is 200 points wide and 50 points high. <strong class="source-inline">availableWidthForStar</strong> would be 200/5 = 40. Since 40 &lt;= 50 evaluates to <strong class="source-inline">true</strong>, <strong class="source-inline">starSideLength</strong> will be set to <strong class="source-inline">40</strong>.</p>
			<p class="source-code">for index in 0..&lt;totalStars {</p>
			<p>Since <strong class="source-inline">totalStars</strong> is set to <strong class="source-inline">5</strong>, this <strong class="source-inline">for</strong> loop repeats five times.</p>
			<p class="source-code">let starOriginX = (availableWidthForStar * </p>
			<p class="source-code">Double(index)) +  ((availableWidthForStar – </p>
			<p class="source-code">starSidelength) / 2</p>
			<p class="source-code">let starOriginY = ((rect.size.height - starSidelength)</p>
			<p class="source-code">/ 2)</p>
			<p class="source-code">let frame = CGRect(x: starOriginX, y: starOriginY, </p>
			<p class="source-code">width: starSidelength, height: starSidelength)</p>
			<p>These statements calculate the origin and size of the rectangle where each star should be drawn within the ratings view. This is then assigned to <strong class="source-inline">frame</strong>. The origin values are offset from the top-left corner of the ratings view, and the width and height are set to <strong class="source-inline">starSidelength</strong>. </p>
			<p>For<a id="_idIndexMarker1023"/> example, for <a id="_idIndexMarker1024"/>the first star, <strong class="source-inline">starOriginX</strong> is (40*0.0) + (40-40)/2 = <strong class="source-inline">0</strong>. <strong class="source-inline">starOriginY </strong>is (50 – 40)/2 = <strong class="source-inline">5</strong>. <strong class="source-inline">frame</strong> would thus be a <strong class="source-inline">CGRect</strong> where <strong class="source-inline">x</strong> is <strong class="source-inline">0</strong>, <strong class="source-inline">y</strong> is <strong class="source-inline">5</strong>, <strong class="source-inline">width</strong> is <strong class="source-inline">40</strong>, and <strong class="source-inline">height</strong> is <strong class="source-inline">40</strong>.</p>
			<p class="source-code">var starToDraw: UIImage!</p>
			<p class="source-code">if (Double(index + 1) &lt;= self.rating) {</p>
			<p class="source-code">   starToDraw = filledStarImage</p>
			<p class="source-code">} else if (Double(index + 1) &lt;= self.rating.rounded())</p>
			<p class="source-code">{ </p>
			<p class="source-code">   starToDraw = halfStarImage</p>
			<p class="source-code">} else {</p>
			<p class="source-code">   starToDraw = emptyStarImage</p>
			<p class="source-code">}</p>
			<p>Depending on the value of the ratings view's <strong class="source-inline">rating</strong> property, these statements determine whether the star to be drawn is filled, half-filled, or empty.</p>
			<p>For example, let's assume <strong class="source-inline">rating</strong> is <strong class="source-inline">3.5</strong>.</p>
			<p>The first star has an index of <strong class="source-inline">0</strong>. This means <strong class="source-inline">Double</strong>(0 + 1) &lt;= 3.5 will be 1.0 &lt;= 3.5, which evaluates to <strong class="source-inline">true</strong>. This means the first star that's drawn will be a filled star. The same is true for the second and third stars.</p>
			<p>The fourth star has an index of <strong class="source-inline">3</strong>. This means <strong class="source-inline">Double</strong>(3 + 1) &lt;= 3.5 will be 4.0 &lt;= 3.5, which evaluates to <strong class="source-inline">false</strong>. The <strong class="source-inline">else</strong> clause evaluates <strong class="source-inline">Double</strong>(3 + 1) &lt;= 4.0, which evaluates to <strong class="source-inline">true</strong>, so the fourth star drawn will be a half-filled star.</p>
			<p>The fifth star has an index of <strong class="source-inline">4</strong>. This means <strong class="source-inline">Double</strong>(4 + 1) &lt;= 3.5 will be 5.0 &lt;= 3.5, which evaluates to <strong class="source-inline">false</strong>. The <strong class="source-inline">else</strong> clause evaluates <strong class="source-inline">Double</strong>(4 + 1) &lt;= 4.0, which also evaluates to <strong class="source-inline">false</strong>, so the fifth star drawn will be an empty star.</p>
			<p class="source-code">starToDraw.draw(in: frame)</p>
			<p>This <a id="_idIndexMarker1025"/>statement draws the star in the specified <strong class="source-inline">frame</strong>.</p>
			<p>That's all<a id="_idIndexMarker1026"/> the code that's needed for the <strong class="source-inline">RatingsView</strong> class. Now, let's add an outlet to the <strong class="source-inline">RestaurantDetailViewController</strong> class so that it can manage what the ratings view displays. Follow these steps:</p>
			<ol>
				<li value="1">Click the <strong class="source-inline">RestaurantDetailViewController</strong> file in the Project navigator.</li>
				<li>Type in the following code after the <strong class="source-inline">overallRating<a id="_idTextAnchor327"/><a id="_idTextAnchor328"/>Label</strong> outlet:<p class="source-code">@IBOutlet var ratingsView: RatingsView!</p><p>This creates an outlet in the <strong class="source-inline">RestaurantDetailViewController</strong> class for the ratings view. You now have an outlet named <strong class="source-inline">ratingsView</strong> of type <strong class="source-inline">RatingsView</strong> that you will connect to the ratings view in the storyboard later.</p></li>
				<li>Add a method to assign <strong class="source-inline">3.5</strong> to a <strong class="source-inline">ratingsView</strong> instance's <strong class="source-inline">rating</strong> property. Type the following in your <strong class="source-inline">private</strong> extension after the <strong class="source-inline">initial<a id="_idTextAnchor329"/><a id="_idTextAnchor330"/><a id="_idTextAnchor331"/>ize()</strong> method:<p class="source-code">func createRating() {</p><p class="source-code">   ratingsView.rating = 3.5</p><p class="source-code">}</p></li>
				<li>Modify the <strong class="source-inline">initalize()</strong> method to call the <strong class="source-inline">createRating()</strong> method:<p class="source-code">func initialize() { </p><p class="source-code">   setupLabels() </p><p class="source-code">   createMap() </p><p class="source-code">   <strong class="bold">createRating()</strong></p><p class="source-code">}</p></li>
				<li>Open the <strong class="source-inline">RestaurantDetail</strong> storyboard file and select <strong class="bold">Restaurant Detail View Controller</strong> in the document outline. Click the Connections inspector <a id="_idIndexMarker1027"/>button. Drag from the <strong class="source-inline">ratingsView</strong> outlet<a id="_idIndexMarker1028"/> to the ratings view:</li>
			</ol>
			<div>
				<div id="_idContainer444" class="IMG---Figure">
					<img src="image/Figure_19.04_B17469.jpg" alt="Figure 19.4: Connections inspector showing the ratingsView outlet&#13;&#10;"/>
				</div>
			</div>
			<p class="figure-caption">Figure 19.4: Connections inspector showing the ratingsView outlet</p>
			<p>Build and run your project and go to the <strong class="bold">Restaurant Detail</strong> screen for any restaurant. The ratings view should display three and a half stars:</p>
			<div>
				<div id="_idContainer445" class="IMG---Figure">
					<img src="image/Figure_19.05_B17469.jpg" alt="Figure 19.5: iOS Simulator showing ratings view displaying 3.5 stars&#13;&#10;"/>
				</div>
			</div>
			<p class="figure-caption">Figure 19.5: iOS Simulator showing ratings view displaying 3.5 stars</p>
			<p>You have <a id="_idIndexMarker1029"/>created and implemented the ratings <a id="_idIndexMarker1030"/>view for the <strong class="bold">Restaurant Detail</strong> screen. It looks great, but at the moment, the ratings view does not respond when you tap on it. You will make it respond to touch events in the next section so the user can select a rating.</p>
			<h1 id="_idParaDest-271"><a id="_idTextAnchor332"/>Adding support for touch events</h1>
			<p>At <a id="_idIndexMarker1031"/>present, the <strong class="source-inline">RestaurantDetailViewController</strong> class has an outlet, <strong class="source-inline">ratingsView</strong>, connected to a ratings view in the <strong class="bold">Restaurant Detail</strong> screen. It displays a rating of three and a half stars, but you can't change the rating. You will need to support touch events to make the ratings view respond to taps.</p>
			<p class="callout-heading">Important Information</p>
			<p class="callout">You can learn more about handling touches at <a href="https://developer.apple.com/documentation/uikit/touches_presses_and_gestures/handling_touches_in_your_view">https://developer.apple.com/documentation/uikit/touches_presses_and_gestures/handling_touches_in_your_view</a>.</p>
			<p>To support touch events, you'll modify the <strong class="source-inline">RatingsView</strong> class to track the user's touches on the screen and use them to determine the rating. Follow these steps:</p>
			<ol>
				<li value="1">Click the <strong class="source-inline">RatingsView</strong> file in the Project navigator and add the following property after the <strong class="source-inline">draw(_:)</strong> method:<p class="source-code">override var canBecomeFirstResponder: Bool {</p><p class="source-code">   true</p><p class="source-code">}</p><p><strong class="source-inline">canBecomeFirstResponder</strong> is a <strong class="source-inline">UIControl</strong> property that determines whether an object can become the first responder. The ratings view needs to become the first responder to respond to touch events. This method returns <strong class="source-inline">false</strong> by default, as not all user interface elements need to respond to touches. You override this method to make it return <strong class="source-inline">true</strong> so the ratings view can become the first responder.</p></li>
				<li>To track <a id="_idIndexMarker1032"/>the user's touches on the screen, add the following code after the <strong class="source-inline">canBecomeFirstResponder</strong> propert<a id="_idTextAnchor333"/><a id="_idTextAnchor334"/>y you just added:<p class="source-code">override func beginTracking(_ touch: UITouch, with </p><p class="source-code">event: UIEvent?) -&gt; Bool {</p><p class="source-code">   guard self.isEnabled else { </p><p class="source-code">      return false</p><p class="source-code">   } </p><p class="source-code">   super.beginTracking(touch, with: event)</p><p class="source-code">   handle(with: touch)</p><p class="source-code">   return true</p><p class="source-code">}</p><p>Let's break this down:</p><p class="source-code">override func beginTracking(_ touch: UITouch, with event: UIEvent?) -&gt; Bool {</p><p>This method is one of the methods declared in the <strong class="source-inline">UIControl</strong> class. It is called when the user's touch is within the bounds of a <strong class="source-inline">UIControl</strong> instance. The location, size, movement, and force of a touch on the screen are stored in a <strong class="source-inline">UITouch</strong> instance. This method needs to return <strong class="source-inline">true</strong> if you want to track the user's touches. You override this method so you can define custom behavior when the user touches the ratings view.</p><p class="source-code">guard self.isEnabled else { </p><p class="source-code">   return false</p><p class="source-code">}</p><p>The <strong class="source-inline">isEnabled</strong> property is checked in this <strong class="source-inline">guard</strong> statement to see if the ratings view is enabled. If<a id="_idIndexMarker1033"/> the ratings view is not enabled, the user's touches will not be tracked. </p><p class="source-code">super.beginTracking(touch, with: event)</p><p>Calls the superclass implementation of this method. This will take care of any initialization required by the parent class. </p><p class="source-code">handle(with: touch) </p><p>You'll pass the <strong class="source-inline">UITouch</strong> instance to this method, which will be executed for every touch. You'll declare and define this method in the next step.</p><p class="source-code">return true</p><p>Tracks the user's touches when the ratings view is enabled.</p></li>
				<li>You'll see an error because you haven't implemented <strong class="source-inline">handle(with:)</strong> yet, so create a <strong class="source-inline">private</strong> extension for <strong class="source-inline">RatingsView</strong> after all other code in the file and type the follo<a id="_idTextAnchor335"/><a id="_idTextAnchor336"/>wing code into it:<p class="source-code">private extension RatingsView {</p><p class="source-code">   func handle(with touch: UITouch) {</p><p class="source-code">      let starRectWidth = self.bounds.size.width / </p><p class="source-code">      Double(totalStars)</p><p class="source-code">      let location = touch.location(in: self)</p><p class="source-code">      var value = location.x / starRectWidth</p><p class="source-code">      if (value + 0.5) &lt; value.rounded(.up) {</p><p class="source-code">         value = floor(value) + 0.5</p><p class="source-code">      } else {</p><p class="source-code">         value = value.rounded(.up)</p><p class="source-code">      }</p><p class="source-code">      updateRating(with: value)</p><p class="source-code">   }</p><p class="source-code">}</p><p><strong class="source-inline">handle(with:)</strong> will calculate the rating value based on the location of the user's touch. It takes a <strong class="source-inline">UITouch</strong> instance as a parameter. First, <strong class="source-inline">starRectWidth</strong> is assigned the ratings view's <strong class="source-inline">width</strong>, divided by <strong class="source-inline">5</strong>. Next, the <strong class="source-inline">UITouch</strong> instance's location within the ratings view is assigned to <strong class="source-inline">location</strong>. Then, <strong class="source-inline">value</strong> is assigned the <strong class="source-inline">x</strong> position of <strong class="source-inline">location</strong> divided by <strong class="source-inline">starRectWidth</strong>. This means <strong class="source-inline">value</strong> will contain a range of values between 0 and 5. Next, the <strong class="source-inline">if</strong> statement <a id="_idIndexMarker1034"/>calculates the rating corresponding to the position of the touch and calls <strong class="source-inline">updateRating(with:)</strong>, passing <strong class="source-inline">value</strong> to it. You'll implement <strong class="source-inline">updateRating(with:)</strong> in the next step.</p><p>To understand how the if statement works, let's say the ratings view's <strong class="source-inline">width</strong> is <strong class="source-inline">200</strong>. <strong class="source-inline">starRectWidth</strong> would be set to 200/5 = <strong class="source-inline">40</strong>. Let's assume the user touched the screen at position <strong class="source-inline">x</strong> = <strong class="source-inline">130</strong>, <strong class="source-inline">y</strong> = <strong class="source-inline">17</strong>, which corresponds to a point between the third and fourth stars. <strong class="source-inline">value</strong> would be assigned 130/40 = <strong class="source-inline">3.25</strong>. So, the <strong class="source-inline">if</strong> statement would evaluate <strong class="source-inline">(3.25 + 0.5 &lt; 3.25.rounded(.up)</strong>, which becomes (3.75 &lt; 4.0), which returns <strong class="source-inline">true</strong>, thus <strong class="source-inline">value</strong> would be set to <strong class="source-inline">floor(3.25)</strong> + 0.5, which becomes 3.0 + 0.5, which is <strong class="source-inline">3.5</strong>. So, <strong class="source-inline">updateRating(with:)</strong> would be passed a value of <strong class="source-inline">3.5</strong>.</p></li>
				<li>You'll see an error because you haven't implemented <strong class="source-inline">updateRating(with:)</strong> yet, so type the following code into the <strong class="source-inline">private</strong> extension after the <strong class="source-inline">ha<a id="_idTextAnchor337"/><a id="_idTextAnchor338"/>ndle(with:)</strong> method:<p class="source-code">func updateRating(with newValue: Double) {</p><p class="source-code">   if (self.rating != newValue &amp;&amp; newValue &gt;= 0 &amp;&amp; </p><p class="source-code">   newValue &lt;= Double(totalStars)) { </p><p class="source-code">      self.rating = newValue </p><p class="source-code">   }</p><p class="source-code">}</p><p><strong class="source-inline">updateRating(with:)</strong> checks to see if <strong class="source-inline">value</strong> is not equal to the current rating and between 0 and 5. If it is, <strong class="source-inline">value</strong> is assigned to <strong class="source-inline">rating</strong>.</p><p>Following on from <a id="_idIndexMarker1035"/>the preceding example, since <strong class="source-inline">3.5</strong> is between 0 and 5, it will be assigned to <strong class="source-inline">rating</strong> if it's not equal to the current value of <strong class="source-inline">rating</strong>.</p></li>
				<li>The ratings view will have to be redrawn once the rating has changed to display the correct state of the stars. Modify the <strong class="source-inline">rating</strong> property declaration as follows:<p class="source-code">var rating = 0.0 {</p><p class="source-code">   didSet {</p><p class="source-code">      setNeedsDisplay()</p><p class="source-code">   }</p><p class="source-code">}</p><p>Here, you have defined a <strong class="bold">property observer</strong> to monitor changes in the <strong class="source-inline">rating</strong> property's value. Every time <strong class="source-inline">rating</strong> changes, <strong class="source-inline">setNeedsDisplay()</strong> is called and the ratings view is redrawn. Since the screen is redrawn only if the rating changes, there is a small performance benefit.</p></li>
			</ol>
			<p>You've added all the code that's necessary for the ratings view to respond to touches. Now, you'll need to update the <strong class="source-inline">RestaurantDetailViewController</strong> class to set the <strong class="source-inline">isEnabled</strong> property for the ratings view. Click the <strong class="source-inline">RestaurantDetailViewController</strong> file in the Project navigator and modify the <strong class="source-inline">createRating()</strong> method, as follows:</p>
			<p class="source-code">func createRating() { </p>
			<p class="source-code">   ratingsView.rating = 3.5 </p>
			<p class="source-code"><strong class="bold">   ratingsView.isEnabled = true</strong></p>
			<p class="source-code">}</p>
			<p>Setting the <strong class="source-inline">isEnabled</strong> property to <strong class="source-inline">true</strong> allows the ratings view to become the first responder and begin tracking touches, which will trigger <strong class="source-inline">handle(with:)</strong> to calculate the rating based on the position of the touch, which in turn calls <strong class="source-inline">updateRating(with:)</strong> to update the ratings view.</p>
			<p>Build and run your project. Tapping on the ratings view now changes the rating, depending on where you tapped. Tap between the first and second stars, as shown:</p>
			<div>
				<div id="_idContainer446" class="IMG---Figure">
					<img src="image/Figure_19.06_B17469.jpg" alt="Figure 19.6: iOS Simulator showing ratings view tap location&#13;&#10;"/>
				</div>
			</div>
			<p class="figure-caption">Figure 19.6: iOS Simulator showing ratings view tap location</p>
			<p>The rating will <a id="_idIndexMarker1036"/>change to one and a half stars.</p>
			<p>Eventually, you'll calculate the overall rating by aggregating all the ratings submitted by users in the <strong class="bold">Review Form</strong> screen. If you tap the <strong class="bold">Add Review</strong> button, the <strong class="bold">Review Form </strong>screen is displayed but you can't dismiss it or set a rating. In the next section, you'll configure the <strong class="bold">Cancel</strong> button to dismiss the <strong class="bold">Review Form</strong> screen when tapped.</p>
			<h1 id="_idParaDest-272"><a id="_idTextAnchor339"/>Implementing an unwind method for the Cancel button</h1>
			<p>Let's <a id="_idIndexMarker1037"/>take a look at the <strong class="bold">Review Form</strong> screen. The <a id="_idIndexMarker1038"/>segue between the <strong class="bold">Add Review</strong> button and the <strong class="bold">Review Form</strong> screen has already been made for you. Build and run your project, go to the <strong class="bold">Restaurant Detail</strong> screen, and tap the <strong class="bold">Add Review</strong> button:</p>
			<div>
				<div id="_idContainer447" class="IMG---Figure">
					<img src="image/Figure_19.07_B17469.jpg" alt="Figure 19.7: iOS Simulator showing Add Review button&#13;&#10;"/>
				</div>
			</div>
			<p class="figure-caption">Figure 19.7: iOS Simulator showing Add Review button</p>
			<p>The <strong class="bold">Review Form</strong> screen <a id="_idIndexMarker1039"/>is displayed (note that the top<a id="_idIndexMarker1040"/> table view cell has a blank space where a ratings view should be, which you will add later):</p>
			<div>
				<div id="_idContainer448" class="IMG---Figure">
					<img src="image/Figure_19.08_B17469.jpg" alt="Figure 19.8: iOS Simulator showing Review Form screen&#13;&#10;"/>
				</div>
			</div>
			<p class="figure-caption">Figure 19.8: iOS Simulator showing Review Form screen</p>
			<p>Once<a id="_idIndexMarker1041"/> the <strong class="bold">Review Form</strong> screen appears<a id="_idIndexMarker1042"/> on the screen, you can't dismiss it, as the button actions for the <strong class="bold">Save</strong> and <strong class="bold">Cancel</strong> buttons have not been configured. Just as you did with the <strong class="bold">Locations</strong> screen, you need to implement an unwind method to dismiss the <strong class="bold">Review Form</strong> screen. Follow these steps:</p>
			<ol>
				<li value="1">Click the <strong class="source-inline">RestaurantDetailViewController</strong> file in the Project navigator.</li>
				<li>Implement the unwind method as follows in the <strong class="source-inline">private</strong> extension, before th<a id="_idTextAnchor340"/><a id="_idTextAnchor341"/>e <strong class="source-inline">createRating()</strong> method:<p class="source-code">@IBAction func unwindReviewCancel(segue:</p><p class="source-code">UIStoryboardSegue) {</p><p class="source-code">}</p><p>This method will be called when the <strong class="bold">Review Form</strong> screen transitions to the <strong class="bold">Restaurant Detail</strong> screen.</p></li>
				<li>Open the <strong class="source-inline">ReviewForm</strong> storyboard file and <em class="italic">Ctrl + Drag</em> from the <strong class="bold">Cancel</strong> button to the Exit icon in the Scene Dock, as shown:<div id="_idContainer449" class="IMG---Figure"><img src="image/Figure_19.09_B17469.jpg" alt="Figure 19.9: Table View Controller Scene showing Cancel button action being set&#13;&#10;"/></div><p class="figure-caption">Figure 19.9: Table View Controller Scene showing Cancel button action being set</p></li>
				<li>Choose <strong class="source-inline">unwindReviewCancelWithSegue</strong> in the popup menu:</li>
			</ol>
			<div>
				<div id="_idContainer450" class="IMG---Figure">
					<img src="image/Figure_19.10_B17469.jpg" alt="Figure 19.10: Pop-up menu with unwindReviewCancelWithSegue: selected&#13;&#10;"/>
				</div>
			</div>
			<p class="figure-caption">Figure 19.10: Pop-up menu with unwindReviewCancelWithSegue: selected</p>
			<p>Build and run<a id="_idIndexMarker1043"/> your project. You can now dismiss <a id="_idIndexMarker1044"/>the <strong class="bold">Review Form</strong> screen by tapping the <strong class="bold">Cancel</strong> button.</p>
			<p>Next, let's look at the <strong class="bold">Save</strong> button. You'll create a view controller for the <strong class="bold">Review Form </strong>screen to process the data inside the <strong class="bold">Review Form</strong> screen's fields when the <strong class="bold">Save</strong> button is tapped. You'll do this in the next section.</p>
			<h1 id="_idParaDest-273"><a id="_idTextAnchor342"/>Creating the ReviewFormViewController class</h1>
			<p>To process<a id="_idIndexMarker1045"/> user input, you'll create the <strong class="source-inline">ReviewFormViewController</strong> class to be the view controller for the <strong class="bold">Review Form</strong> screen. For the time being, you'll configure this class to grab all the values from the <strong class="bold">Review Form</strong> screen's fields and print them in the Debug area. You will learn how to store reviews later in <a href="B17469_21_Final_VK_ePub.xhtml#_idTextAnchor362"><em class="italic">Chapter 21</em></a><em class="italic">, Understanding Core Data</em>. Follow these steps:</p>
			<ol>
				<li value="1">Right-click the <strong class="source-inline">ReviewForm</strong> folder and select <strong class="bold">New File</strong>.</li>
				<li><strong class="bold">iOS</strong> should already be selected. Choose <strong class="bold">Cocoa Touch Class</strong> and then click <strong class="bold">Next</strong>.</li>
				<li>Configure the file as follows:<p><strong class="bold">Class</strong>: <strong class="source-inline">ReviewFor<a id="_idTextAnchor343"/><a id="_idTextAnchor344"/>mViewController</strong></p><p><strong class="bold">Subclass</strong>: <strong class="source-inline">UITableViewController </strong></p><p><strong class="bold">Also create XIB</strong>: Unchecked </p><p><strong class="bold">Language</strong>: <strong class="source-inline">Swift</strong></p><p>Click <strong class="bold">Next</strong>.</p></li>
				<li>Click <strong class="bold">Create</strong>. The <strong class="source-inline">ReviewFormViewController</strong> file will appear in the Project navigator.</li>
				<li>Delete <a id="_idIndexMarker1046"/>everything after the <strong class="source-inline">viewDidLoad()</strong> method and all the commented code. Add the following outlets after the class declaration. They correspond to the fields insi<a id="_idTextAnchor345"/><a id="_idTextAnchor346"/>de the <strong class="bold">Review Form</strong> screen:<p class="source-code">@IBOutlet var ratingsView: RatingsView!</p><p class="source-code">@IBOutlet var titleTextField: UITextField!</p><p class="source-code">@IBOutlet var nameTextField: UITextField!</p><p class="source-code">@IBOutlet var reviewTextView: UITextView!</p></li>
				<li>You also need to configure the action for the <strong class="bold">Save</strong> button. Add the following code after<a id="_idTextAnchor347"/><a id="_idTextAnchor348"/> the <strong class="source-inline">viewDidLoad()</strong> method:<p class="source-code">@IBAction func onSaveTapped(_ sender: Any) { </p><p class="source-code">   print(ratingsView.rating) </p><p class="source-code">   print(titleTextField.text as Any) </p><p class="source-code">   print(nameTextField.text as Any) </p><p class="source-code">   print(reviewTextView.text as Any) </p><p class="source-code">   dismiss(animated: true, completion: nil)</p><p class="source-code">}</p><p>This method prints the contents of the <strong class="bold">Review Form</strong> screen's fields to the Debug area and dismisses it.</p></li>
			</ol>
			<p>Now let's<a id="_idIndexMarker1047"/> connect the outlets in the <strong class="bold">ReviewFormViewController</strong> class to the user interface elements in the <strong class="bold">Table View Controller Scene</strong> in the <strong class="source-inline">ReviewForm</strong> storyboard file, as follows:</p>
			<ol>
				<li value="1">Click the <strong class="source-inline">ReviewForm</strong> storyboard file in the Project navigator and click the <strong class="bold">Table View Controller</strong> icon inside the <strong class="bold">Table View Controller Scene</strong>. Click the Identity inspector button. Under <strong class="bold">Custom Class</strong>, set <strong class="bold">Class</strong> to <strong class="source-inline">ReviewFormViewController</strong>:<div id="_idContainer451" class="IMG---Figure"><img src="image/Figure_19.11_B17469.jpg" alt="Figure 19.11: Identity inspector with Class set to ReviewFormViewController&#13;&#10;"/></div><p class="figure-caption">Figure 19.11: Identity inspector with Class set to ReviewFormViewController</p><p>Note that the name <strong class="bold">Table View Controller Scene</strong> will change to <strong class="bold">Review Form View Controller Scene</strong>.</p></li>
				<li>Click the <strong class="bold">View</strong> inside the <strong class="bold">Content View</strong> of the first <strong class="bold">Table View Cell</strong> as shown, click the Identity inspector button, and under <strong class="bold">Custom Class</strong>, set <strong class="bold">Class</strong> to <strong class="source-inline">RatingsView</strong>. The view's name will change to <strong class="bold">Ratings View</strong>:<div id="_idContainer452" class="IMG---Figure"><img src="image/Figure_19.12_B17469.jpg" alt="Figure 19.12: Identity inspector with Class set to RatingsView&#13;&#10;"/></div><p class="figure-caption">Figure 19.12: Identity inspector with Class set to RatingsView</p></li>
				<li>Next, you<a id="_idIndexMarker1048"/> will connect the outlets. Click the <strong class="bold">Review Form View Controller</strong> icon in the document outline and click the Connections inspector button:<div id="_idContainer453" class="IMG---Figure"><img src="image/Figure_19.13_B17469.jpg" alt="Figure 19.13: Connections Inspector button&#13;&#10;"/></div><p class="figure-caption">Figure 19.13: Connections Inspector button</p></li>
				<li>Connect the <strong class="source-inline">ratingsView</strong> outlet to the <strong class="bold">Ratings View</strong>:<div id="_idContainer454" class="IMG---Figure"><img src="image/Figure_19.14_B17469.jpg" alt="Figure 19.14: Connections inspector showing ratingsView outlet&#13;&#10;"/></div><p class="figure-caption">Figure 19.14: Connections inspector showing ratingsView outlet</p></li>
				<li>Connect the <strong class="source-inline">titleTextField</strong> outlet to the first <strong class="bold">Text Field</strong>:<div id="_idContainer455" class="IMG---Figure"><img src="image/Figure_19.15_B17469.jpg" alt="Figure 19.15: Connections inspector showing titleTextField outlet&#13;&#10;"/></div><p class="figure-caption">Figure 19.15: Connections inspector showing titleTextField outlet</p></li>
				<li>Connect the <strong class="source-inline">nameTextField</strong> outlet to the second <strong class="bold">Text Field</strong>:<div id="_idContainer456" class="IMG---Figure"><img src="image/Figure_19.16_B17469.jpg" alt="Figure 19.16: Connections inspector showing nameTextField outlet&#13;&#10;"/></div><p class="figure-caption">Figure 19.16: Connections inspector showing nameTextField outlet</p></li>
				<li>Connect <a id="_idIndexMarker1049"/>the <strong class="source-inline">reviewTextView</strong> outlet to the <strong class="bold">Text View</strong>:<div id="_idContainer457" class="IMG---Figure"><img src="image/Figure_19.17_B17469.jpg" alt="Figure 19.17: Connections inspector showing reviewTextView outlet&#13;&#10;"/></div><p class="figure-caption">Figure 19.17: Connections inspector showing reviewTextView outlet</p></li>
				<li>Finally, connect the <strong class="source-inline">onSaveTapped:</strong> action to the <strong class="bold">Save</strong> button:</li>
			</ol>
			<div>
				<div id="_idContainer458" class="IMG---Figure">
					<img src="image/Figure_19.18_B17469.jpg" alt="Figure 19.18: Connections inspector showing Save button action being set&#13;&#10;"/>
				</div>
			</div>
			<p class="figure-caption">Figure 19.18: Connections inspector showing Save button action being set</p>
			<p>Build and<a id="_idIndexMarker1050"/> run your app. Go to the <strong class="bold">Review Form</strong> screen, set a rating, add some sample text to the fields, and tap the <strong class="bold">Save</strong> button:</p>
			<div>
				<div id="_idContainer459" class="IMG---Figure">
					<img src="image/Figure_19.19_B17469.jpg" alt="Figure 19.19: iOS Simulator showing Review Form screen&#13;&#10;"/>
				</div>
			</div>
			<p class="figure-caption">Figure 19.19: iOS Simulator showing Review Form screen</p>
			<p>You'll see the data you entered appear in the Debug area:</p>
			<div>
				<div id="_idContainer460" class="IMG---Figure">
					<img src="image/Figure_19.20_B17469.jpg" alt="Figure 19.20: Debug area showing contents of Review Form screen text fields&#13;&#10;"/>
				</div>
			</div>
			<p class="figure-caption">Figure 19.20: Debug area showing contents of Review Form screen text fields</p>
			<p>Congratulations! The <strong class="bold">Review Form</strong> screen is<a id="_idIndexMarker1051"/> now able to accept user input. You'll learn how to save and present the review data in <a href="B17469_21_Final_VK_ePub.xhtml#_idTextAnchor362"><em class="italic">Chapter 21</em></a><em class="italic">, Understanding Core Data</em>.</p>
			<h1 id="_idParaDest-274"><a id="_idTextAnchor349"/>Summary</h1>
			<p>In this chapter, you created a new custom <strong class="source-inline">UIControl</strong> subclass, <strong class="source-inline">RatingsView</strong>, from scratch and added it to the <strong class="bold">Restaurant Detail</strong> and <strong class="bold">Review Form</strong> screens. You configured it to respond to touches so that a user can set a restaurant rating in the <strong class="bold">Review Form</strong> screen. Finally, you implemented the <strong class="source-inline">ReviewFormViewController</strong> class, a view controller for the <strong class="bold">Review Form</strong> screen, and configured the <strong class="bold">Cancel</strong> and <strong class="bold">Save</strong> button actions so that the user can dismiss the Review Form screen or submit a review.</p>
			<p>You now have a good grasp of how to create custom <strong class="source-inline">UIControl</strong> classes, how to make them respond to user interaction, and how to implement a review form that can accept user input. This will be useful when you write your own apps.</p>
			<p>In the next chapter, you'll learn how to work with photos from the camera or Photo Library, as well as how to apply photo filters to the photos that you have.</p>
		</div>
	</body></html>