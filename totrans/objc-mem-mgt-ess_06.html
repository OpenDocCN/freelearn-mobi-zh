<html><head></head><body>
<div id="page" style="height:0pt"/><div class="book" title="Chapter&#xA0;6.&#xA0;Using Core Data for Persistence"><div class="book"><div class="book"><div class="book"><h1 class="title" id="calibre_pb_0"><a id="ch06" class="calibre1"/>Chapter 6. Using Core Data for Persistence</h1></div></div></div><p class="calibre8">If you do any serious form of iOS development, data persistence is something that you are bound to come across sooner rather than later. After all, what good is an app when it does not save your user data and requires you to fill it in again when you start the app again subsequently?</p><p class="calibre8">This is where data persistence<a id="id156" class="calibre1"/> comes into the scene. As it is, iOS developers have a few options for data persistence ranging from property list, binary format to SQLite, and so on.</p><p class="calibre8">As with these options, each has its good and bad points, and when to use each particular method of persistence will depend on your use case. You will also have to write specific code to handle data persistence for SQLite and binary data. Core Data can be used to store data in <a id="id157" class="calibre1"/><span class="strong"><strong class="calibre2">plist</strong></span>, SQLite, and other formats, which makes it a pretty powerful framework in itself as we will see in this chapter.</p><p class="calibre8">In this chapter, we will cover the following topics:</p><div class="book"><ul class="itemizedlist"><li class="listitem">Why use Core Data?</li><li class="listitem">Core Data concepts</li><li class="listitem">Putting Core Data into practice</li><li class="listitem">Getting into the code</li><li class="listitem">Saving data into the persistent store</li><li class="listitem">Deleting data from the persistent store</li></ul></div></div>

<div class="book" title="Chapter&#xA0;6.&#xA0;Using Core Data for Persistence">
<div class="book" title="Why use Core Data?"><div class="book"><div class="book"><div class="book"><h1 class="title" id="calibre_pb_1"><a id="ch06lvl1sec44" class="calibre1"/>Why use Core Data?</h1></div></div></div><p class="calibre8">You <a id="id158" class="calibre1"/>might be thinking to yourself, "Why do I have to learn another method when there are so many ways already available to us?" So, in this section and on the following pages, we will see why Core Data is the preferred way to store data on iOS and the Mac OS platform.</p><p class="calibre8">The first <a id="id159" class="calibre1"/>thing you need to know is that Core Data is not another method of data persistence per se; it is actually an abstraction over SQLite, plists, and so on. This means that you can actually use Apple's Core Data API to save your data into the persistent store just by using the Core Data API without needing to write plist-specific or SQLite-specific code if you choose to store your data as plists or SQLite respectively. This abstraction layer illustrates the basic concept of why Core Data is so powerful.</p><p class="calibre8">Now that you have your mind blown, the abstraction layer means that you can just use the Core Data APIs, and the abstraction layer will handle all the storage-specific code for you as all this high-level stuff will help you get away from writing low-level stuff, specific for each different data persistent format such as SQLite, property list, and so on.</p><p class="calibre8">Core Data integrates very tightly with iCloud and provides a host of benefits related to iCloud, such as data synching. It also allows you to do entity modeling with the benefits of querying while making it very fast in terms of access speed plus giving you the freedom to choose the storage type that can be SQLite, XML, or NSDate. With all the benefits that Core Data provides, it comes with a trade-off in which you need to write a bit more code compared to NSCoding. However, as we will see later, the amount of code is not a lot, and the Core Data framework is not complex to understand too.</p><p class="calibre8">A few more things that I would like to mention about Core Data is that since it is so tightly integrated into the Apple platforms, you can have access to a lot of related classes such as <code class="email">NSFetchedResultsController</code> that make it easy for you to get your entities into <code class="email">UITableViews</code>. It also has a nice graphical object model editor that allows you to easily think about your object/entity design and conceptualize it easily using Core Data's visual tools. With all these benefits, let's dig into Core Data now.</p></div></div>
<div class="book" title="Understanding Core Data concepts"><div class="book"><div class="book"><div class="book"><h1 class="title" id="calibre_pb_0"><a id="ch06lvl1sec45" class="calibre1"/>Understanding Core Data concepts</h1></div></div></div><p class="calibre8">Core Data <a id="id160" class="calibre1"/>allows you to store your data in a variety of storage types. So, if you want to use other types of memory store, such as XML or binary store, you can use the following store types:</p><div class="book"><ul class="itemizedlist"><li class="listitem"><code class="email">NSSQLiteStoreType</code>: This is the<a id="id161" class="calibre1"/> option you most commonly use as it just <a id="id162" class="calibre1"/>stores your database in a SQLite database.</li><li class="listitem"><code class="email">NSXMLStoreType</code>: This will<a id="id163" class="calibre1"/> store your data in an XML file, which is slower, but <a id="id164" class="calibre1"/>you can open the XML file and it will be human readable. This has the option of helping you debug errors relating to storage of data. However, do note that this storage type is only available for Mac OS X.</li><li class="listitem"><code class="email">NSBinaryStoreType</code>: This <a id="id165" class="calibre1"/>occupies the least amount of space and also produces the<a id="id166" class="calibre1"/> fastest speed as it stores all data as a binary file, but the entire database binary need to be able to fit into memory in order to work properly.</li><li class="listitem"><code class="email">NSInMemoryStoreType</code>: This <a id="id167" class="calibre1"/>stores all data in memory and provides the<a id="id168" class="calibre1"/> fastest access speed. However, the size of your database to be saved cannot exceed the available free space in memory since the data is stored in memory. However, do note that memory storage is ephemeral and is not stored permanently to disk.</li></ul></div><p class="calibre8">Next, there are two<a id="id169" class="calibre1"/> concepts that you need to know, and they are:</p><div class="book"><ul class="itemizedlist"><li class="listitem">Entity</li><li class="listitem">Attributes</li></ul></div><p class="calibre8">Now, these terms may be foreign to you. However, for those of you who have knowledge of databases, you will know it as tables and columns. So, to put it in an easy-to-understand picture, think of Core Data entities as your database tables and Core Data attributes as your database columns.</p><p class="calibre8">So, Core Data handles data persistence using the concepts of entity and attributes, which are abstract data types, and actually saves the data into plists, SQLite databases, or even XML files (applicable only to the Mac OS). Going back a bit in time, Core Data is a descendant of Apple's <a id="id170" class="calibre1"/><span class="strong"><strong class="calibre2">Enterprise Objects Framework</strong></span> (<span class="strong"><strong class="calibre2">EOF</strong></span>), which was introduced by NeXT, Inc in 1994, and EOF is an <a id="id171" class="calibre1"/><span class="strong"><strong class="calibre2">Object-relational mapper</strong></span> (<span class="strong"><strong class="calibre2">ORM</strong></span>), but Core Data itself is not an ORM. Core Data is a framework for managing the object graph, and one of its powerful capabilities is that it allows you to work with extremely large datasets and object instances that normally would not fit into memory by putting objects in and out of memory when necessary. Core Data will map the Objective-C data type to the related data types, such as string, date, and integer, which will be represented by <code class="email">NSString</code>, <code class="email">NSDate</code>, and <code class="email">NSNumber</code> respectively. So, as you can see, Core Data is not a radically new concept that you need to learn as it is grounded in the simple database concepts that we all know. Since entity and attributes are abstract data types, you cannot access them directly as they do not exist in physical terms. So to access them, you need to use the Core Data classes and methods provided by Apple.</p><p class="calibre8">The number of classes for <a id="id172" class="calibre1"/>Core Data is actually pretty long, and you won't be using all of them regularly. So, here is a list of the more commonly used classes:</p><div class="informalexample"><table border="1" class="calibre13"><colgroup class="calibre14"><col class="calibre15"/><col class="calibre15"/></colgroup><thead class="calibre16"><tr class="calibre17"><th valign="bottom" class="calibre18">
<p class="calibre19">Class name</p>
</th><th valign="bottom" class="calibre18">
<p class="calibre19">Example use case</p>
</th></tr></thead><tbody class="calibre20"><tr class="calibre17"><td valign="top" class="calibre21">
<p class="calibre19">
<code class="literal">NSManagedObject</code>
</p>
</td><td valign="top" class="calibre21">
<p class="calibre19">Accessing attributes and rows of data</p>
</td></tr><tr class="calibre17"><td valign="top" class="calibre21">
<p class="calibre19">
<code class="literal">NSManagedObjectContext</code>
</p>
</td><td valign="top" class="calibre21">
<p class="calibre19">Fetching data and saving data</p>
</td></tr><tr class="calibre17"><td valign="top" class="calibre21">
<p class="calibre19">
<code class="literal">NSManagedObjectModel</code>
</p>
</td><td valign="top" class="calibre21">
<p class="calibre19">Storage</p>
</td></tr><tr class="calibre17"><td valign="top" class="calibre21">
<p class="calibre19">
<code class="literal">NSFetchRequest</code>
</p>
</td><td valign="top" class="calibre21">
<p class="calibre19">Requesting data</p>
</td></tr><tr class="calibre17"><td valign="top" class="calibre21">
<p class="calibre19">
<code class="literal">NSPersistentStoreCoordinator</code>
</p>
</td><td valign="top" class="calibre21">
<p class="calibre19">Persisting data</p>
</td></tr><tr class="calibre17"><td valign="top" class="calibre21">
<p class="calibre19">
<code class="literal">NSPredicate</code>
</p>
</td><td valign="top" class="calibre21">
<p class="calibre19">Data query</p>
</td></tr></tbody></table></div><p class="calibre8">Now, explore each of these classes in depth:</p><div class="book"><ul class="itemizedlist"><li class="listitem"><code class="email">NSManagedObject</code>: This is a<a id="id173" class="calibre1"/> record that you will use and perform <a id="id174" class="calibre1"/>operations on and all entities will extend this class.</li><li class="listitem"><code class="email">NSManagedObjectContext</code>: This can<a id="id175" class="calibre1"/> be thought <a id="id176" class="calibre1"/>of as an intelligent scratchpad where temporary copies are brought into it after you fetch objects from the persistent store. So, any modifications done in this intelligent scratchpad are not saved until you save those changes into the persistent store, <code class="email">NSManagedObjectModel</code>. Think of this as a collection of entities or a database schema, if you will.</li><li class="listitem"><code class="email">NSFetchRequest</code>: This is an <a id="id177" class="calibre1"/>operation that describes the search criteria, which<a id="id178" class="calibre1"/> you will use to retrieve data from the persistent store, a kind of the common SQL query that most developers are familiar with.</li><li class="listitem"><code class="email">NSPersistentStoreCoordinator</code>: This is like the glue that associates your managed object context and persistent.</li><li class="listitem"><code class="email">NSPersistentStoreCoordinator</code>: Without<a id="id179" class="calibre1"/> this, your <a id="id180" class="calibre1"/>modifications will not be saved to the persistent store.</li><li class="listitem"><code class="email">NSPredicate</code>: This is used to<a id="id181" class="calibre1"/> define logical conditions used in a search or for<a id="id182" class="calibre1"/> filtering in-memory. Basically, it means that <code class="email">NSPredicate</code> is used to specify how data is to be <a id="id183" class="calibre1"/>fetched or filtered and you can use it together with <code class="email">NSFetchRequest</code> as <code class="email">NSFetchRequest</code> has a predicate property.</li></ul></div></div>
<div class="book" title="Putting it into practice"><div class="book"><div class="book"><div class="book"><h1 class="title" id="calibre_pb_0"><a id="ch06lvl1sec46" class="calibre1"/>Putting it into practice</h1></div></div></div><p class="calibre8">Now that we have covered the basics of Core Data, let's proceed with some code examples of how to use Core Data, where<a id="id184" class="calibre1"/> we use Core Data to store customer details in a <code class="email">Customer</code> table. The information we want to store is:</p><div class="book"><ul class="itemizedlist"><li class="listitem"><code class="email">name</code></li><li class="listitem"><code class="email">email</code></li><li class="listitem"><code class="email">phone_number</code></li><li class="listitem"><code class="email">address</code></li><li class="listitem"><code class="email">age</code></li></ul></div><div class="informalexample" title="Note"><h3 class="title2"><a id="note05" class="calibre1"/>Note</h3><p class="calibre8">Do note that all attribute names must be in lowercase and should not have spaces in them. For example, we will use Core Data to store customer details mentioned earlier as well as retrieve, update, and delete the customer records using the Core Data framework and methods.</p></div><div class="book"><ol class="orderedlist"><li class="listitem" value="1">First, we will select <span class="strong"><strong class="calibre2">File</strong></span> | <span class="strong"><strong class="calibre2">New</strong></span> | <span class="strong"><strong class="calibre2">File</strong></span> and then select <span class="strong"><strong class="calibre2">iOS</strong></span> | <span class="strong"><strong class="calibre2">Core Data</strong></span>:<div class="mediaobject"><img src="../images/00026.jpeg" alt="Putting it into practice" class="calibre10"/></div><p class="calibre23"> </p></li><li class="listitem" value="2">Then, we will proceed to create a <a id="id185" class="calibre1"/>new <span class="strong"><strong class="calibre2">Entity</strong></span> called <span class="strong"><strong class="calibre2">Customer</strong></span> by clicking on the <span class="strong"><strong class="calibre2">Add Entity</strong></span> button in the bottom left of the screen, as shown here:<div class="mediaobject"><img src="../images/00027.jpeg" alt="Putting it into practice" class="calibre10"/></div><p class="calibre23"> </p></li><li class="listitem" value="3">Then, we will proceed to add in the<a id="id186" class="calibre1"/> attributes for our <span class="strong"><strong class="calibre2">Customer</strong></span> entity and give them the appropriate <span class="strong"><strong class="calibre2">Type</strong></span>, which can be <span class="strong"><strong class="calibre2">String</strong></span> for attributes such as <span class="strong"><strong class="calibre2">name</strong></span> or <span class="strong"><strong class="calibre2">address</strong></span> and <span class="strong"><strong class="calibre2">Integer 16</strong></span> for <span class="strong"><strong class="calibre2">age</strong></span>:<div class="mediaobject"><img src="../images/00028.jpeg" alt="Putting it into practice" class="calibre10"/></div><p class="calibre23"> </p></li><li class="listitem" value="4">Lastly, we need to add<a id="id187" class="calibre1"/> <span class="strong"><strong class="calibre2">CoreData.framework</strong></span>, as shown in the following screenshot:<div class="mediaobject"><img src="../images/00029.jpeg" alt="Putting it into practice" class="calibre10"/></div><p class="calibre23"> </p></li><li class="listitem" value="5">So with this, we have <a id="id188" class="calibre1"/>created a Core Data model class consisting of a <code class="email">Customer</code> entity and some attributes. Do note that all core model classes have the <code class="email">.xcdatamodeld</code> file extension and for us, we can save our Core Data model as <code class="email">Model.xcdatamodeld</code>.</li><li class="listitem" value="6">Next, we will create a sample application that uses Core Data in the following ways:<div class="book"><ul class="itemizedlist1"><li class="listitem">Saving a record</li><li class="listitem">Searching for a record</li><li class="listitem">Deleting a record</li><li class="listitem">Loading records</li></ul></div></li></ol><div class="calibre22"/></div><p class="calibre8">Now, I won't cover the usage of UIKit and storyboard, but instead focus on the core code needed to give you an example of Core Data works. So, to start things off, here are a few screenshots of the application for you to have a look at to see what we'll do:</p><div class="book"><ul class="itemizedlist"><li class="listitem">This is the main screen <a id="id189" class="calibre1"/>when you start the app:<div class="mediaobject"><img src="../images/00030.jpeg" alt="Putting it into practice" class="calibre10"/></div><p class="calibre23"> </p></li><li class="listitem">The screen to insert a record is shown here:<div class="mediaobject"><img src="../images/00031.jpeg" alt="Putting it into practice" class="calibre10"/></div><p class="calibre23"> </p></li><li class="listitem">The screen to list all records<a id="id190" class="calibre1"/> from our persistent store is as follows:<div class="mediaobject"><img src="../images/00032.jpeg" alt="Putting it into practice" class="calibre10"/></div><p class="calibre23"> </p></li><li class="listitem">By deleting a record from the <a id="id191" class="calibre1"/>persistent store, you will get the following output:<div class="mediaobject"><img src="../images/00033.jpeg" alt="Putting it into practice" class="calibre10"/></div><p class="calibre23"> </p></li></ul></div></div>
<div class="book" title="Getting into the code"><div class="book"><div class="book"><div class="book"><h1 class="title" id="calibre_pb_0"><a id="ch06lvl1sec47" class="calibre1"/>Getting into the code</h1></div></div></div><p class="calibre8">Let's get started with our <a id="id192" class="calibre1"/>code examples:</p><div class="book"><ol class="orderedlist"><li class="listitem" value="1">For our code, we will first declare some Core Data objects in our <code class="email">AppDelegate</code> class inside our <code class="email">AppDelegate.h</code> file such as:<div class="informalexample"><pre class="programlisting">@property (readonly, strong, nonatomic) NSManagedObjectContext
*managedObjectContext;
@property (readonly, strong, nonatomic) NSManagedObjectModel
*managedObjectModel;
@property (readonly, strong, nonatomic) NSPersistentStoreCoordinator
*persistentStoreCoordinator;</pre></div><p class="calibre25">These are declared here so that we can access them easily from any screen.</p></li><li class="listitem" value="2">Next, we will declare the<a id="id193" class="calibre1"/> code for each of the objects in <code class="email">AppDelegate.m</code> such as the following lines of code that will create an instance of <code class="email">NSManagedObjectContext</code> and return an existing instance if the instance already exists. This is important as you want only one instance of the context to be present to avoid conflicting access to the context:<div class="informalexample"><pre class="programlisting">- (NSManagedObjectContext *)managedObjectContext
{
    if (_managedObjectContext != nil) {
        return _managedObjectContext;
    }
    NSPersistentStoreCoordinator *coordinator = [self persistentStoreCoordinator];
    if (coordinator != nil) {
        _managedObjectContext = [[NSManagedObjectContext alloc] init];
        [_managedObjectContext setPersistentStoreCoordinator:coordinator];
    }
    
    if (_managedObjectContext == nil)
        NSLog(@"_managedObjectContext is nil");
    return _managedObjectContext;
}</pre></div><p class="calibre25">This method will create the <code class="email">NSManagedObjectModel</code> instance and then return the instance, but it will return an existing <code class="email">NSManagedObjectModel</code> instance if it already exists:</p><div class="informalexample"><pre class="programlisting">// Returns the managed object model for the application.
- (NSManagedObjectModel *)managedObjectModel
{
    if (_managedObjectModel != nil) {
        return _managedObjectModel;//return model since it already exists
    }
    
    //else create the model and return it
    //CustomerModel is the filename of your *.xcdatamodeld file
    NSURL *modelURL = [[NSBundle mainBundle] URLForResource:@"CustomerModel" withExtension:@"momd"];
    _managedObjectModel = [[NSManagedObjectModel alloc] initWithContentsOfURL:modelURL];
    
    if (_managedObjectModel == nil)
        NSLog(@"_managedObjectModel is nil");
    return _managedObjectModel;
}</pre></div><p class="calibre25">This method will <a id="id194" class="calibre1"/>create an instance of the <code class="email">NSPersistentStoreCoordinator</code> class if it does not exist, and also return an existing instance if it already exists. We will also make some logs appear in our Xcode console using the <code class="email">NSLog</code> method to tell the user if the instance of <code class="email">NSPersistentStoreCoordinator</code> is nil and use the <code class="email">NSSQLiteStoreType</code> keyword to signify to the system that we intend to store the data in a SQLite database:</p><div class="informalexample"><pre class="programlisting">// Returns the persistent store coordinator for the application.
- (NSPersistentStoreCoordinator *)persistentStoreCoordinator
{ NSPersistentStoreCoordinator
    if (_persistentStoreCoordinator != nil) {
        return _persistentStoreCoordinator;//return persistent store
    }//coordinator since it already exists
        
    NSURL *storeURL = [[self applicationDocumentsDirectory] URLByAppendingPathComponent:@"CustomerModel.sqlite"];
    
    NSError *error = nil;
    _persistentStoreCoordinator = [[NSPersistentStoreCoordinator alloc] initWithManagedObjectModel:[self managedObjectModel]];
    
    if (_persistentStoreCoordinator == nil)
        NSLog(@"_persistentStoreCoordinator is nil");
    
    if (![_persistentStoreCoordinator addPersistentStoreWithType:NSSQLiteStoreType configuration:nil URL:storeURL options:nil error:&amp;error]) {
        NSLog(@"Error %@, %@", error, [error userInfo]);
        abort();
    }
    
    return _persistentStoreCoordinator;
}</pre></div><p class="calibre25">The following lines of code will <a id="id195" class="calibre1"/>return a URL of the location to store your data on the device:</p><div class="informalexample"><pre class="programlisting">#pragma mark - Application's Documents directory// Returns the URL to the application's Documents directory.
- (NSURL *)applicationDocumentsDirectory
{
    return [[[NSFileManager defaultManager] URLsForDirectory:NSDocumentDirectory inDomains:NSUserDomainMask] lastObject];
}</pre></div><p class="calibre25">As you can see, what we have done is to check whether the objects such as <code class="email">_managedObjectModel</code> are nil and if they are not nil, then we return the object, or we will create the object and then return it. This concept is exactly the same concept of lazy loading, which we covered in <a class="calibre1" title="Chapter 5. Managing Your Application Data" href="part0044_split_000.html#page">Chapter 5</a>, <span class="strong"><em class="calibre9">Managing Your Application Data</em></span>. We apply the same methodology to <code class="email">managedObjectContext</code> and <code class="email">persistentStoreCoordinator</code>. We did this so that we know that we only have one instance of <code class="email">managedObjectModel</code>, <code class="email">managedObjectContext</code>, and <code class="email">persistentStoreCoordinator</code> created and present at any given time. This is to help us avoid having multiple copies of these objects, which will increase the chance of a memory leak.</p></li></ol><div class="calibre22"/></div><div class="informalexample" title="Note"><h3 class="title2"><a id="note06" class="calibre1"/>Note</h3><p class="calibre8">Note that memory management is still a real issue in the post-ARC world. So what we have done is follow best practices that will help us avoid memory leaks.</p></div><p class="calibre8">In the example code that<a id="id196" class="calibre1"/> was shown, we adopted a structure so that only one instance of <code class="email">managedObjectModel</code>, <code class="email">managedObjectContext</code>, and <code class="email">persistentStoreCoordinator</code> is available at any given time.</p><p class="calibre8">Next, let's move on to showing you how to store data in our persistent store. As you can see in the preceding screenshot, we have fields such as <code class="email">name</code>, <code class="email">age</code>, <code class="email">address</code>, <code class="email">email</code>, and <code class="email">phone_number</code>, which correspond to the appropriate fields in our <code class="email">Customer</code> entity.</p><div class="informalexample" title="Note"><h3 class="title2"><a id="note07" class="calibre1"/>Note</h3><p class="calibre8">The example code in this chapter will be provided in its entirety on the Packt Publishing website, and you can download it and run the Xcode project directly.</p></div></div>
<div class="book" title="Saving data into the persistent store"><div class="book"><div class="book"><div class="book"><h1 class="title" id="calibre_pb_0"><a id="ch06lvl1sec48" class="calibre1"/>Saving data into the persistent store</h1></div></div></div><p class="calibre8">To do a <a id="id197" class="calibre1"/>successful <a id="id198" class="calibre1"/>save using Core Data, you require:</p><div class="book"><ul class="itemizedlist"><li class="listitem"><code class="email">NSManagedObject</code></li><li class="listitem"><code class="email">NSManagedObjectContext</code></li><li class="listitem"><code class="email">NSPersistentStoreCoordinator</code></li><li class="listitem"><code class="email">NSManagedObjectModel</code></li></ul></div><p class="calibre8">So, in our screen that saves these variables into our <code class="email">Customer</code> entity, the following code fragment does all the magic for the <code class="email">(IBAction)save:(id)sender</code> method. This will <a id="id199" class="calibre1"/>enable us to save our data from a new customer or update an <a id="id200" class="calibre1"/>existing customer's information:</p><div class="informalexample"><pre class="programlisting">- (IBAction)save:(id)sender {
    if ([nameTxtField text].length == 0)
    {
        UIAlertView *alert = [[UIAlertView alloc] initWithTitle:@"Error"
                message:@"Name must not be empty" delegate:self
                        cancelButtonTitle:@"OK" otherButtonTitles:nil];
        [alert show];
        return;
    }
    NSString *name = [nameTxtField text];
    NSString *phone = [phoneTxtField text];
    NSString *email = [emailTxtField text];
    NSString *address = [addressTxtField text];
    int age = [[ageTxtField text] intValue];
    
    //save using core data
    NSManagedObjectContext *context = nil;
    id delegate = [[UIApplication sharedApplication] delegate];
    if ([delegate performSelector:@selector(managedObjectContext)]) {
        context = [delegate managedObjectContext];
    }//prepare the context for saving
    
    if (customer)//if we are showing existing customer data
    {
        NSNumber *age = [NSNumber numberWithInt:[[ageTxtField text] intValue]];
        [customer setValue:[nameTxtField text] forKey:@"name"];
        [customer setValue:age forKey:@"age"];
        [customer setValue:[addressTxtField text] forKey:@"address"];
        [customer setValue:[emailTxtField text] forKey:@"email"];
        [customer setValue:[phoneTxtField text] forKey:@"phone_number"];
    }
    else
    {
        // Insert new object into the context
        NSManagedObject *newCustomer = [NSEntityDescription insertNewObjectForEntityForName:@"Customer" inManagedObjectContext:context];
        [newCustomer setValue:name forKey:@"name"];
        [newCustomer setValue:phone forKey:@"phone_number"];
        [newCustomer setValue:email forKey:@"email"];
        [newCustomer setValue:address forKey:@"address"];
        [newCustomer setValue:[NSNumber numberWithInteger:age] forKey:@"age"];
    }
    
    NSError *error = nil;
    // Save the object to persistent store
    NSString *str;
    if (![context save:&amp;error]) {
        str = [NSString stringWithFormat:@"Error saving %@ with localized description %@", error, [error localizedDescription]];
        NSLog(@"%@", str);
    }
    else
    {
        str = @"Customer record saved to persistent store";
        if (customer)
            str = @"Customer record updated to persistent store";
        NSLog(@"%@", str);
    }

    UIAlertView *alert = [[UIAlertView alloc] initWithTitle:@"Alert"
                                        message:str delegate:self
                                cancelButtonTitle:@"OK" otherButtonTitles:nil];
    
    [alert show];
}</pre></div><p class="calibre8">So, the steps<a id="id201" class="calibre1"/> we need to remember are:</p><div class="book"><ol class="orderedlist"><li class="listitem" value="1">Get the<a id="id202" class="calibre1"/> instance of <code class="email">NSManagedObjectContext</code>, which sets <code class="email">persistentStoreCoordinator</code> using <code class="email">managedObjectModel</code>.</li><li class="listitem" value="2">Create an instance of <code class="email">NSManagedObject</code> and set the values you want to save.</li><li class="listitem" value="3">Use an object of the <code class="email">NSManagedObjectContext</code> type and call the <code class="email">save</code> method since the context will represent all changes that you have done and you need to call the <code class="email">save</code> method in order to save the changes from the context to disk.</li></ol><div class="calibre22"/></div></div>
<div class="book" title="Deleting data from the persistent store"><div class="book"><div class="book"><div class="book"><h1 class="title" id="calibre_pb_0"><a id="ch06lvl1sec49" class="calibre1"/>Deleting data from the persistent store</h1></div></div></div><p class="calibre8">We will now move on to <a id="id203" class="calibre1"/>delete a record from the persistent store. In our table view, we<a id="id204" class="calibre1"/> will load the customers using an instance of <code class="email">NSFetchRequest</code>, as shown:</p><div class="informalexample"><pre class="programlisting">- (void)viewDidAppear:(BOOL)animated
{
    [super viewDidAppear:animated];
    
    //Get the context first
    NSManagedObjectContext *managedObjectContext = [self managedObjectContext];
    
    //load data from Customer entity
    NSFetchRequest *fetchRequest = [[NSFetchRequest alloc] initWithEntityName:@"Customer"];
    self.customers = [[managedObjectContext executeFetchRequest:fetchRequest error:nil] mutableCopy];
    
    [tblView reloadData];
}</pre></div><p class="calibre8">Here, we will declare <code class="email">customers</code> as a mutable array to store our records from the <code class="email">Customer</code> entity:</p><div class="informalexample"><pre class="programlisting">@property (strong) NSMutableArray *customers;</pre></div><p class="calibre8">To delete a record, we just <a id="id205" class="calibre1"/>need to get our <code class="email">Customer</code> record, which is<a id="id206" class="calibre1"/> an instance of <code class="email">NSManagedObject</code> from the <code class="email">customers</code> array, then use an instance of <code class="email">managedObjectContext</code> to call the <code class="email">deleteObject</code> method on it, and finally, call the <code class="email">save</code> method to save our updated records:</p><div class="informalexample"><pre class="programlisting">- (void)tableView:(UITableView *)tableView commitEditingStyle:(UITableViewCellEditingStyle)editingStyle forRowAtIndexPath:(NSIndexPath *)indexPath
{
    NSManagedObjectContext *context = [self managedObjectContext];
    
    if (editingStyle == UITableViewCellEditingStyleDelete) {
        
        NSManagedObject *obj = [self.customers objectAtIndex:indexPath.row];
        [context deleteObject: obj];
        
        NSError *error = nil;
        NSString *str;
        // Attempt to delete record from database
        if (![context save:&amp;error]) {
            str = @"Cannot delete record! %@", [error localizedDescription];
            NSLog(@"%@", str);
        }
        else
        {
            // Remove customer from table view
            [self.customers removeObject:obj];
            
            //update tableview
            [tblView deleteRowsAtIndexPaths:[NSArray arrayWithObject:indexPath]
                           withRowAnimation:UITableViewRowAnimationNone];
            str = @"Record removed";
            NSLog(@"%@", str);
        }
    
        UIAlertView *alert = [[UIAlertView alloc] initWithTitle:@"Alert"
                                        message:str delegate:self
                                cancelButtonTitle:@"OK" otherButtonTitles:nil];
        
        [alert show];
    }
}</pre></div></div>
<div class="book" title="Updating data"><div class="book"><div class="book"><div class="book"><h1 class="title" id="calibre_pb_0"><a id="ch06lvl1sec50" class="calibre1"/>Updating data</h1></div></div></div><p class="calibre8">Finally, to update a record, it is much<a id="id207" class="calibre1"/> simpler than you think, thanks to the abstraction layer. To update data, we just assign the values to our <code class="email">customer</code> object in the <code class="email">(IBAction)save:(id)sender</code> method, which you saw earlier:</p><div class="informalexample"><pre class="programlisting">if (customer)//if we showing existing customer data
{
        NSNumber *age = [NSNumber numberWithInt:[[ageTxtField text] intValue]];
        [customer setValue:[nameTxtField text] forKey:@"name"];
        [customer setValue:age forKey:@"age"];
        [customer setValue:[addressTxtField text] forKey:@"address"];
        [customer setValue:[emailTxtField text] forKey:@"email"];
        [customer setValue:[phoneTxtField text] forKey:@"phone_number"];
    }</pre></div><p class="calibre8">We will add the following code after we set the values of our <code class="email">customer</code> object:</p><div class="informalexample"><pre class="programlisting">NSError *error = nil;
    // Save the object to persistent store
    NSString *str;
    if (![context save:&amp;error]) {
        str = [NSString stringWithFormat:@"Error saving %@ with localized description %@", error, [error localizedDescription]];
        NSLog(@"%@", str);
    }</pre></div><p class="calibre8">Here, <code class="email">customer</code> is an instance of <code class="email">NSManagedObject</code>:</p><div class="informalexample"><pre class="programlisting">@property (strong) NSManagedObject *customer;</pre></div><p class="calibre8">The code for updating<a id="id208" class="calibre1"/> data is to be added after the following code fragment, inside the – <code class="email">(IBAction)save:(id)sender</code> method:</p><div class="informalexample"><pre class="programlisting">if ([delegate performSelector:@selector(managedObjectContext)]) {
        context = [delegate managedObjectContext];
    }//prepare the context for saving</pre></div></div>
<div class="book" title="Summary"><div class="book"><div class="book"><div class="book"><h1 class="title" id="calibre_pb_0"><a id="ch06lvl1sec51" class="calibre1"/>Summary</h1></div></div></div><p class="calibre8">So, to wrap it all up, Core Data is not something that is overly complex and the code to use Core Data is pretty straightforward as we have seen in our code examples shown earlier. The Core Data framework is a relatively easy framework to use to handle data storage abstraction without worrying about different data storage formats.</p><p class="calibre8">The concepts that you have to know are the Core Data classes such as <code class="email">NSManagedObject</code>, <code class="email">NSManagedObjectContext</code>, <code class="email">NSPersistentStoreCoordinator</code>, and so on and the related methods such as <code class="email">save</code> and <code class="email">deleteObject</code>. With these simple lines of code, you can leverage the power of the Core Data framework to do data persistence on a high-level abstraction without concerning yourself with the low-level data format specifications.</p><p class="calibre8">In the next chapter, we will be introduced to key-value programming and how it can be used to allow us to be notified of state changes. So, I hope you enjoyed this chapter on Core Data!</p></div></body></html>