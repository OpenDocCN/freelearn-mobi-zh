<html><head></head><body><div class="chapter" title="Chapter&#xA0;5.&#xA0;Working with the Location Services and the MapKit Frameworks"><div class="titlepage"><div><div><h1 class="title"><a id="ch05"/>Chapter 5. Working with the Location Services and the MapKit Frameworks</h1></div></div></div><p>In this chapter we will cover:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">Adding the CoreLocation and MapKit frameworks</li><li class="listitem" style="list-style-type: disc">Building a simple CoreLocation application</li><li class="listitem" style="list-style-type: disc">Determining the current GPS location</li><li class="listitem" style="list-style-type: disc">Adding and working with the MapView control</li><li class="listitem" style="list-style-type: disc">Adding overlay regions to the map</li><li class="listitem" style="list-style-type: disc">Adding annotation placeholders to the map</li><li class="listitem" style="list-style-type: disc">Reversing geocode address information</li><li class="listitem" style="list-style-type: disc">Working with the different map types</li></ul></div><div class="section" title="Introduction"><div class="titlepage"><div><div><h1 class="title"><a id="ch05lvl1sec52"/>Introduction</h1></div></div></div><p>In this chapter we will be taking a closer look at how we can use the CoreLocation and MapKit frameworks to determine the location of the user. The <a id="id421" class="indexterm"/>
<a id="id422" class="indexterm"/>MapKit framework is based on both the Google Earth and Google Maps data, as well as the APIs that provide developers with a simple mechanism of integrating detailed and interactive mapping capabilities into their own applications.</p><p>The core element of the MapKit framework is the <code class="literal">MKMapView</code> class. This class is a subclass of <code class="literal">UIView</code> that provides a canvas onto which map and/or satellite information is presented to the user. We will also learn how we can add placeholders directly onto the map and create annotations for these.</p><p>Finally, we will learn how we can use the <code class="literal">CLGeoLocation</code> class to apply reverse geocoding of the map coordinates to display location information, as well as applying the different types of map views.</p></div></div>
<div class="section" title="Adding the CoreLocation and MapKit frameworks"><div class="titlepage"><div><div><h1 class="title"><a id="ch05lvl1sec53"/>Adding the CoreLocation and MapKit frameworks</h1></div></div></div><p>In this recipe we will <a id="id423" class="indexterm"/>
<a id="id424" class="indexterm"/>learn how to include the CoreLocation and MapKit frameworks to our project.</p><div class="section" title="Getting ready"><div class="titlepage"><div><div><h2 class="title"><a id="ch05lvl2sec184"/>Getting ready</h2></div></div></div><p>In this section we will learn how to create a new application and add the frameworks to our project.</p></div><div class="section" title="How to do it..."><div class="titlepage"><div><div><h2 class="title"><a id="ch05lvl2sec185"/>How to do it...</h2></div></div></div><p>To begin, follow these simple steps as outlined in the following order:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Launch Xcode from the <code class="literal">/Xcode4/Applications</code> folder.</li><li class="listitem">Choose <span class="strong"><strong>Create a new Xcode project</strong></span>, or go to <span class="strong"><strong>File</strong></span> | <span class="strong"><strong>New Project</strong></span>.</li><li class="listitem">Select the <span class="strong"><strong>Single View Application</strong></span> template from the list of available templates.</li><li class="listitem">Click on the <span class="strong"><strong>Next</strong></span> button to proceed to the next step in the wizard.</li><li class="listitem">Next, enter in <code class="literal">CoreLocation</code> as the name for your project.</li><li class="listitem">Choose <span class="strong"><strong>iPhone</strong></span> from under the <span class="strong"><strong>Devices</strong></span> drop-down list.</li><li class="listitem">Ensure that the <span class="strong"><strong>Use Storyboards</strong></span> checkbox has not been selected.</li><li class="listitem">Ensure that the <span class="strong"><strong>Use Automatic Reference Counting</strong></span> checkbox is selected.</li><li class="listitem">Ensure that the <span class="strong"><strong>Include Unit Tests</strong></span> checkbox has not been ticked.</li><li class="listitem">Click on the <span class="strong"><strong>Next</strong></span> button to proceed to the next step in the wizard.</li><li class="listitem">Specify the location where you would like to save your project.</li><li class="listitem">Then, click on the <span class="strong"><strong>Create</strong></span> button to continue and display the Xcode workspace.</li></ol></div><p>Our next step is to add the <a id="id425" class="indexterm"/>CoreLocation framework to our project. This can be achieved by performing these simple steps outlined as follows:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Select the <span class="strong"><strong>CoreLocation</strong></span> project from the <span class="strong"><strong>Project Navigator</strong></span> section.</li><li class="listitem">Then, select your project from under the <span class="strong"><strong>TARGETS</strong></span> group.</li><li class="listitem">Select the <span class="strong"><strong>Build Phases</strong></span> tab and expand the <span class="strong"><strong>Link Binaries With Libraries</strong></span> disclosure triangle.</li><li class="listitem">Click on the <span class="strong"><strong>+</strong></span> button and select the <span class="strong"><strong>CoreLocation.framework</strong></span> from the list.</li><li class="listitem">Then, click on the <span class="strong"><strong>Add</strong></span> button to add the framework to your project as shown in the following screenshot:<div class="mediaobject"><img src="graphics/3349_05_01.jpg" alt="How to do it..."/></div></li><li class="listitem">Repeat steps 4 and 5 to <a id="id426" class="indexterm"/>add the <code class="literal">MapKit.framework</code> to your project.<div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="note30"/>Note</h3><p>If you cant find the framework you are looking for, there is also the added ability to search for this directly right from within the list of available frameworks.</p></div></div></li></ol></div></div><div class="section" title="How it works..."><div class="titlepage"><div><div><h2 class="title"><a id="ch05lvl2sec186"/>How it works...</h2></div></div></div><p>In this recipe we learned how to add both the CoreLocation and MapKit frameworks to our project so that we can use these to determine our current location and handle geocoding information to add placeholders to the map.</p></div><div class="section" title="See also"><div class="titlepage"><div><div><h2 class="title"><a id="ch05lvl2sec187"/>See also</h2></div></div></div><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">The <span class="emphasis"><em>Building a simple CoreLocation application</em></span> recipe</li></ul></div></div></div>
<div class="section" title="Building a simple CoreLocation application"><div class="titlepage"><div><div><h1 class="title"><a id="ch05lvl1sec54"/>Building a simple CoreLocation application</h1></div></div></div><p>In this recipe we will learn how to build the user interface for our Core Location project.</p><div class="section" title="Getting ready"><div class="titlepage"><div><div><h2 class="title"><a id="ch05lvl2sec188"/>Getting ready</h2></div></div></div><p>In this section we will start by building the components that will comprise of our user interface for our CoreLocation application.</p></div><div class="section" title="How to do it..."><div class="titlepage"><div><div><h2 class="title"><a id="ch05lvl2sec189"/>How to do it...</h2></div></div></div><p>To begin, follow <a id="id427" class="indexterm"/>these simple steps as outlined in the following order:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Select <code class="literal">ViewController.xib</code> file from the <span class="strong"><strong>Project Navigator</strong></span> section.</li><li class="listitem">From <span class="strong"><strong>Object Library</strong></span>, select and drag a (<span class="strong"><strong>UIToolbar</strong></span>) toolbar control, and add this to the top of the view and select the <span class="strong"><strong>Item</strong></span> button located within our toolbar that we previously added.</li><li class="listitem">From the <span class="strong"><strong>Attributes Inspector</strong></span> section, change the value of <span class="strong"><strong>Title</strong></span> to <span class="strong"><strong>Change Map</strong></span>.</li><li class="listitem">Next, from <span class="strong"><strong>Object Library</strong></span>, select and drag a (<span class="strong"><strong>MKMapView</strong></span>) map view control to the center of our <span class="strong"><strong>View Controller</strong></span>, and adjust the size of the <span class="strong"><strong>Map View</strong></span> section to fill the entire area of the screen:<div class="mediaobject"><img src="graphics/3349_05_02.jpg" alt="How to do it..."/></div></li></ol></div><p>The following screenshot <a id="id428" class="indexterm"/>shows the completed user interface with the added UIToolbar and button, as well as the <code class="literal">MapView</code> control:</p><div class="mediaobject"><img src="graphics/3349_05_03.jpg" alt="How to do it..."/></div><p>Our next step is to create the <code class="literal">Outlet</code> and <a id="id429" class="indexterm"/>
<code class="literal">property</code> events for the <span class="strong"><strong>Change Map</strong></span> button and <span class="strong"><strong>MKMapView</strong></span> control. Creating these will allow us to access the associated methods and control properties directly within our code. To create an <code class="literal">Outlet</code> event, follow these simple steps:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Open the <span class="strong"><strong>Assistant Editor</strong></span> by choosing <span class="strong"><strong>Navigate</strong></span> | <span class="strong"><strong>Open in Assistant Editor</strong></span>, or by pressing the <span class="emphasis"><em>Option</em></span> + <span class="emphasis"><em>Command</em></span> buttons.</li><li class="listitem">Ensure that the <code class="literal">ViewController.h</code> interface file is displayed within the <span class="strong"><strong>Assistant Editor</strong></span> window.</li><li class="listitem">Select the <span class="strong"><strong>Change Map</strong></span> (<code class="literal">UIBarButtonItem</code>) control, hold down the <span class="emphasis"><em>Ctrl</em></span> key, and drag it into the <code class="literal">ViewController.h</code> interface file.<div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="note31"/>Note</h3><p>In order to create the <code class="literal">IBOutlet</code> outlets, these will need to be created inside the curly braces under the <code class="literal">@interface</code> directive as these are not created by default.</p></div></div></li><li class="listitem">Choose <span class="strong"><strong>Outlet</strong></span> from the <span class="strong"><strong>Connection</strong></span> drop-down menu for the connection to be created.</li><li class="listitem">Enter in <code class="literal">changeMap</code> for the name of the <span class="strong"><strong>Outlet</strong></span> event to create.</li><li class="listitem">Choose <span class="strong"><strong>Strong</strong></span> from the <span class="strong"><strong>Storage</strong></span> drop-down menu.</li><li class="listitem">Repeat steps 4 to 6 to create the <a id="id430" class="indexterm"/><code class="literal">Outlet</code> property for the <code class="literal">MKMapView</code> control, using the name <code class="literal">mapView</code>.</li></ol></div><p>Now that we have created the <a id="id431" class="indexterm"/>instance variable outlets for our controls, we need to create the associated actions for the <code class="literal">changeMap</code> button. Creating these actions allows an event to be fired when the button is pressed. To create an action, follow these simple steps:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">With the <code class="literal">ViewController.h</code> interface file still displayed within the <span class="strong"><strong>Assistant Editor</strong></span> window, select the <span class="strong"><strong>Change Map</strong></span> (<code class="literal">UIBarButtonItem</code>) control, and hold down the <span class="emphasis"><em>Ctrl</em></span> key and drag it into the <code class="literal">ViewController.h</code> interface file.</li><li class="listitem">Choose <span class="strong"><strong>Action</strong></span> from the <span class="strong"><strong>Connection</strong></span> drop-down list for the connection to be created.</li><li class="listitem">Enter in <code class="literal">changeMapType</code> for the <span class="strong"><strong>Name</strong></span> of the method to be created.<p>In order to make our application correctly display the map to our view, we will need to import the <code class="literal">&lt;MapKit/MapKit.h&gt;</code> interface header file so that we can utilize its methods.</p></li><li class="listitem">Open the <code class="literal">ViewController.h</code> interface file located within the <code class="literal">Classes</code> folder, and add the following highlighted code:<div class="informalexample"><pre class="programlisting">//  ViewController.h
//  CoreLocation
//  Created by Steven F Daniel on 23/10/12.
//  Copyright (c) 2012 GenieSoft Studios. All rights reserved.
#import  &lt;UIKit/UIKit.h&gt;
<span class="strong"><strong>#import &lt;MapKit/MapKit.h&gt;</strong></span>
</pre></div></li></ol></div><p>The following code snippet shows the completed <code class="literal">ViewController.h</code> interface file, as follows:</p><div class="informalexample"><pre class="programlisting">//  ViewController.h
//  CoreLocation
//  Created by Steven F Daniel on 23/10/12.
//  Copyright (c) 2012 GenieSoft Studios. All rights reserved.

#import &lt;UIKit/UIKit.h&gt;
#import &lt;MapKit/MapKit.h&gt;

@interface ViewController : UIViewController 
{
  IBOutlet UIBarButtonItem *changeMap;
}

@property (strong, nonatomic) IBOutlet MKMapView *mapView;

// Declare our class instance methods
-(IBAction)changeMapType:(id)sender;

@end</pre></div></div><div class="section" title="How it works..."><div class="titlepage"><div><div><h2 class="title"><a id="ch05lvl2sec190"/>How it works...</h2></div></div></div><p>In this recipe we started by <a id="id432" class="indexterm"/>building our user interface by adding a <code class="literal">UIToolbar</code> and <code class="literal">MKMapView</code> control to our view controller. We then created the necessary outlets and actions event methods that need to be executed when the <code class="literal">changeMapType</code> <a id="id433" class="indexterm"/>button is pressed. We then imported the <code class="literal">MapKit.h</code> interface files into our <code class="literal">ViewController.h</code> interface file so that we can access their class methods for the <code class="literal">MKMapView</code> class.</p><p>In our next recipe we will look at how we can use the <code class="literal">MKMapView</code> class to determine our current geographic GPS location using the <code class="literal">CLLocationManager</code> class.</p></div><div class="section" title="See also"><div class="titlepage"><div><div><h2 class="title"><a id="ch05lvl2sec191"/>See also</h2></div></div></div><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">The <span class="emphasis"><em>Determining the current GPS location</em></span> recipe</li><li class="listitem" style="list-style-type: disc">The <span class="emphasis"><em>Displaying and using maps</em></span> recipe</li><li class="listitem" style="list-style-type: disc">The <span class="emphasis"><em>Using Xcode to create an iOS project</em></span> and <span class="emphasis"><em>Creating outlets to Interface Builder objects</em></span> recipes in <a class="link" href="ch01.html" title="Chapter 1. Getting and Installing the iOS SDK Development Tools">Chapter 1</a>, <span class="emphasis"><em>Getting and Installing the iOS SDK Development Tools</em></span></li></ul></div></div></div>
<div class="section" title="Determining the current GPS location"><div class="titlepage"><div><div><h1 class="title"><a id="ch05lvl1sec55"/>Determining the current GPS location</h1></div></div></div><p>In this recipe we will <a id="id434" class="indexterm"/>
<a id="id435" class="indexterm"/>learn how to determine the current GPS location of our iOS device.</p><div class="section" title="Getting ready"><div class="titlepage"><div><div><h2 class="title"><a id="ch05lvl2sec192"/>Getting ready</h2></div></div></div><p>In this section we will see how we can use the CoreLocation framework to determine our latitude and longitude GPS location and output this information within an <code class="literal">alertView</code> dialog.</p></div><div class="section" title="How to do it..."><div class="titlepage"><div><div><h2 class="title"><a id="ch05lvl2sec193"/>How to do it...</h2></div></div></div><p>To begin, follow <a id="id436" class="indexterm"/>
<a id="id437" class="indexterm"/>these simple steps as outlined in the following order:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Open the <code class="literal">ViewController.h</code> interface file from the <span class="strong"><strong>Project Navigator</strong></span> section.</li><li class="listitem">Next, modify the interface file as shown by the highlighted code sections in the following code snippet:<div class="informalexample"><pre class="programlisting">//  ViewController.h
//  CoreLocation
//  Created by Steven F Daniel on 23/10/12.
//  Copyright (c) 2012 GenieSoft Studios. All rights reserved.

#import &lt;UIKit/UIKit.h&gt;
#import &lt;MapKit/MapKit.h&gt;
<span class="strong"><strong>#import &lt;CoreLocation/CoreLocation.h&gt;</strong></span>

<span class="strong"><strong>@interface ViewController : UIViewController &lt; MKMapViewDelegate, CLLocationManagerDelegate&gt;</strong></span>
{
<span class="strong"><strong>   CLLocationManager     *locationManager;</strong></span>
  IBOutlet UIBarButtonItem *changeMap;
<span class="strong"><strong>   BOOL                  foundLocation;</strong></span>

   // Obtain the user's current Longitude/Latitude
<span class="strong"><strong>   float                 curLat;</strong></span>
<span class="strong"><strong>   float                 curLong;</strong></span>
}

@property (strong, nonatomic) IBOutlet MKMapView *mapView;
<span class="strong"><strong>@property float curLat;</strong></span>
<span class="strong"><strong>@property float curLong;</strong></span>
// Declare our class instance methods
-(IBAction)changeMapType:(id)sender;

@end</pre></div></li><li class="listitem">Open the <code class="literal">ViewController.m</code> implementation file from the <span class="strong"><strong>Project Navigator</strong></span> section, and add the following highlighted code statement underneath the <code class="literal">@implementation</code> <a id="id438" class="indexterm"/>directive statement:<div class="informalexample"><pre class="programlisting">//
//  ViewController.m
//  CoreLocation
//
//  Created by Steven F Daniel on 23/10/12.
//  Copyright (c) 2012 GenieSoft Studios. All rights reserved.
//

<span class="strong"><strong>#import "ViewController.h"</strong></span>

<span class="strong"><strong>@implementation ViewController</strong></span>

<span class="strong"><strong>@synthesize mapView, curLat, curLong;</strong></span>
</pre></div></li><li class="listitem">Next, <a id="id439" class="indexterm"/><a id="id440" class="indexterm"/>modify the <code class="literal">viewDidLoad</code> method as shown by the highlighted code sections in the following code snippet:<div class="informalexample"><pre class="programlisting">- (void)viewDidLoad {

[super viewDidLoad];
  
// Do any additional setup after loading the view, 
 // typically from a nib.
foundLocation= NO;

// Make this controller the delegate for the map view.
self.mapView.delegate = self;
    
// Instantiate a new location object.
locationManager = [[CLLocationManager alloc] init];
  
// Make this controller the delegate for the location
// manager.
[locationManager setDelegate:self];
// Set some parameters for the location object.
[locationManager setDistanceFilter:kCLDistanceFilterNone];
[locationManager setDesiredAccuracy:kCLLocationAccuracyBest];

// Determine the current geographic location coordinates
 // of the user on the map
[locationManager startUpdatingLocation];
}</pre></div></li><li class="listitem">Next, <a id="id441" class="indexterm"/><a id="id442" class="indexterm"/>create the <code class="literal">didUpdateToLocation:</code> <a id="id443" class="indexterm"/>method as shown in the following code snippet:<div class="informalexample"><pre class="programlisting">#pragma mark Work out the current user location on the map 
- (void)locationManager:(CLLocationManager *)manager didUpdateToLocation:(CLLocation *)newLocation fromLocation:(CLLocation *)oldLocation
{
// If this is the first launch of the app, then set the 
  // center point of the map to the user's location.
if (!foundLocation) {
// Determine the current geographic location coordinates
self.curLat  = mapView.userLocation.coordinate.latitude;
self.curLong = mapView.userLocation.coordinate.longitude;
    
// Show the current user location within an Alert dialog
  UIAlertView *alert = [[UIAlertView alloc] 
             initWithTitle:@"You are located at"
             message:[NSString stringWithFormat:@"Latitude: %f 
             and Longitude: %f", self.curLat, self.curLong]
             delegate:nil
             cancelButtonTitle:@"OK"
             otherButtonTitles:nil];

    // Display the alert view dialog 
    [alert show];

    // Reset so that this does not get called again.
    foundLocation = YES;
  }
}  

#pragma mark If an error occurred, we need to tell our location Manager to stop updating location
- (void)locationManager:(CLLocationManager *)manager 
   didFailWithError:(NSError *)error {
  [locationManager stopUpdatingLocation];
}</pre></div></li><li class="listitem">Then, build and run the application by choosing <span class="strong"><strong>Product</strong></span> | <span class="strong"><strong>Run</strong></span> from the <span class="strong"><strong>Product</strong></span> menu, or alternatively pressing <span class="emphasis"><em>Command</em></span> + <span class="emphasis"><em>R</em></span>.</li></ol></div><p>You will notice that once the program executes, core location will communicate with the iOS device to make a determination where you are located, and display this information within a <code class="literal">UIAlertview</code> dialog.</p></div><div class="section" title="How it works..."><div class="titlepage"><div><div><h2 class="title"><a id="ch05lvl2sec194"/>How it works...</h2></div></div></div><p>In this recipe we imported the <code class="literal">MapView.h</code> header file information for our <code class="literal">CoreLocation.h</code> interface file so that we can access its class methods. We then need to extend our class to include the class protocol for the <code class="literal">CLLocationManagerDelegate</code> so that we can access the protocol's respective methods. We then initialized our superclass's inherited members and then set the <code class="literal">foundLocation</code> to <code class="literal">NO</code> the first time round and set the view controller to be the <code class="literal">mapView</code> delegate so we can pass on the notifications whenever the map moves.</p><p>Next, we <a id="id444" class="indexterm"/>
<a id="id445" class="indexterm"/>instantiate the <code class="literal">locationManager</code> class and set its delegate property to our <code class="literal">mapView</code>, and set the <code class="literal">desiredAccuracy</code> property of the object of the <code class="literal">locationManager</code> class to <code class="literal">kCLLocationAccuracyBest</code>, which specifies the location and heading information provided by the <code class="literal">loctionManager</code> class should be as accurate as the iOS device's hardware can provide, and as a test, it would be better to test this on an actual iOS device.</p><p>Finally, we declare the <a id="id446" class="indexterm"/>
<code class="literal">didUpdateToLocation</code> method to handle whenever the <code class="literal">CLLocationManger</code> class changes the current location of the iOS device. From here, we then obtain the current latitude and longitude coordinates and display this within an <code class="literal">UIAlertview</code> dialog, before finally setting the <code class="literal">foundLocation</code> variable to <code class="literal">YES</code>.</p><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="note32"/>Note</h3><p>For more information on the <code class="literal">CLLocationManager</code> class, you can refer to the Apple Developer Documentation located at the following URL:</p><p>
<a class="ulink" href="https://developer.apple.com/library/ios/#documentation/CoreLocation/Reference/CLLocationManager_Class/CLLocationManager/CLLocationManager.html">https://developer.apple.com/library/ios/#documentation/CoreLocation/Reference/CLLocationManager_Class/CLLocationManager/CLLocationManager.html</a>
</p></div></div></div><div class="section" title="There's more…"><div class="titlepage"><div><div><h2 class="title"><a id="ch05lvl2sec195"/>There's more…</h2></div></div></div><p>We implemented the <a id="id447" class="indexterm"/>
<code class="literal">locationManager:didFailWithError</code> class, which gets called, whenever the use of location services is unavailable or unable to retrieve a location straight away. We use the <code class="literal">error</code> property to determine the type of error that occurred and then call the <code class="literal">stopUpdatingLocation</code> method of the <code class="literal">locationManager</code> object.</p><p>The following table shows each of the valid error codes and their descriptions, as returned by the <a id="id448" class="indexterm"/>
<code class="literal">locationManager:didFailWithError</code> method:</p><div class="informaltable"><table border="1"><colgroup><col style="text-align: left"/><col style="text-align: left"/></colgroup><thead><tr><th style="text-align: left" valign="bottom">
<p>Core location error code</p>
</th><th style="text-align: left" valign="bottom">
<p>Location manager error description</p>
</th></tr></thead><tbody><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">kCLErrorLocationUnknown</code>
</p>
</td><td style="text-align: left" valign="top">
<p>This <a id="id449" class="indexterm"/>error tells you that the location manager was unable to obtain a location at the moment.</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">kCLErrorDenied</code>
</p>
</td><td style="text-align: left" valign="top">
<p>This error lets you <a id="id450" class="indexterm"/>know that the user denied the access to the location service.</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">kCLErrorNetwork</code>
</p>
</td><td style="text-align: left" valign="top">
<p>This error tells <a id="id451" class="indexterm"/>you that the network was unavailable or a network error occurred.</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">kCLErrorHeadingFailure</code>
</p>
</td><td style="text-align: left" valign="top">
<p>This error tells <a id="id452" class="indexterm"/>you that the heading location travelled could not be determined.</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">kCLErrorRegionMonitoringDenied</code>
</p>
</td><td style="text-align: left" valign="top">
<p>This error tells you <a id="id453" class="indexterm"/>that the user denied the access to the region monitoring service.</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">kCLErrorRegionMonitoringFailure</code>
</p>
</td><td style="text-align: left" valign="top">
<p>This error <a id="id454" class="indexterm"/>tells you that a registered region could not be monitored.</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">kCLErrorRegionMonitoringSetupDelayed</code>
</p>
</td><td style="text-align: left" valign="top">
<p>This error tells you <a id="id455" class="indexterm"/>that core location could not initialize the region monitoring service immediately.</p>
</td></tr></tbody></table></div><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="note33"/>Note</h3><p>For more information on the <code class="literal">didFailWithError</code> error codes of the core location class, you can refer to the <a id="id456" class="indexterm"/>Apple Developer Documentation located at <a class="ulink" href="https://developer.apple.com/library/ios/#documentation/CoreLocation/Reference/CLLocationManagerDelegate_Protocol/CLLocationManagerDelegate/CLLocationManagerDelegate.html">https://developer.apple.com/library/ios/#documentation/CoreLocation/Reference/CLLocationManagerDelegate_Protocol/CLLocationManagerDelegate/CLLocationManagerDelegate.html</a>
</p></div></div></div><div class="section" title="See also"><div class="titlepage"><div><div><h2 class="title"><a id="ch05lvl2sec196"/>See also</h2></div></div></div><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">The <span class="emphasis"><em>Adding and working with the MapView control</em></span> recipe</li><li class="listitem" style="list-style-type: disc">The <span class="emphasis"><em>Reversing geocode address information</em></span> recipe</li></ul></div></div></div>
<div class="section" title="Adding and working with the MapView control"><div class="titlepage"><div><div><h1 class="title"><a id="ch05lvl1sec56"/>Adding and working with the MapView control</h1></div></div></div><p>In this recipe we will learn how to use the location simulator to provide you with the ability to test your location-based features in your application without leaving your desk.</p><div class="section" title="Getting ready"><div class="titlepage"><div><div><h2 class="title"><a id="ch05lvl2sec197"/>Getting ready</h2></div></div></div><p>In this section we will see how we can use the location simulator to allow you to select from preset locations and routes <a id="id457" class="indexterm"/>within the iOS Simulator and pick a custom latitude and longitude with accuracy.</p></div><div class="section" title="How to do it..."><div class="titlepage"><div><div><h2 class="title"><a id="ch05lvl2sec198"/>How to do it...</h2></div></div></div><p>To begin, follow these simple steps as outlined in the following order:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Open the <code class="literal">ViewController.m</code> implementation file from the <span class="strong"><strong>Project Navigator</strong></span> section.</li><li class="listitem">Next, modify the <code class="literal">viewDidLoad</code> <a id="id458" class="indexterm"/>method as shown by the highlighted code sections in the following code snippet:<div class="informalexample"><pre class="programlisting">- (void)viewDidLoad {

   [super viewDidLoad];
    
  // Do any additional setup after loading the view, 
  // typically from a nib.
  foundLocation = NO;

  // Ensure that you can view your own location 
  // in the map view.
<span class="strong"><strong> [self.mapView setShowsUserLocation:YES];</strong></span>
  
  // Instantiate a location object.
 locationManager = [[CLLocationManager alloc] init];
 // Make this controller the delegate for 
 // the location manager.
 [locationManager setDelegate:self];
  
 // Set some parameters for the location object.
 [locationManager setDistanceFilter:kCLDistanceFilterNone];
  [locationManager 
  setDesiredAccuracy:kCLLocationAccuracyBest];

  // Determine the current geographic location 
  // coordinates of the user on the map
  [locationManager startUpdatingLocation];
}</pre></div></li><li class="listitem">Then, build and run the application by choosing <span class="strong"><strong>Product</strong></span> | <span class="strong"><strong>Run</strong></span> from the <span class="strong"><strong>Product</strong></span> menu, or alternatively pressing <span class="emphasis"><em>Command</em></span> + <span class="emphasis"><em>R</em></span>.</li></ol></div><p>You will notice that once the program executes, core location communicates with the iOS device to make a determination where you are located, and displays this using a blue flashing marker.</p><p>You can also choose to navigate to a <a id="id459" class="indexterm"/>different location using Xcode while the application is being run on the iOS device. To do this, follow these simple steps:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">From the Xcode debug console, click on the <span class="strong"><strong>Simulate Location</strong></span> icon as shown in the following screenshot. This will display a list of available locations:<div class="mediaobject"><img src="graphics/3349_05_04.jpg" alt="How to do it..."/></div></li><li class="listitem">Select <span class="strong"><strong>Hong Kong, China</strong></span>, or a similar option from the list of displayed locations.</li><li class="listitem">The iOS device will then be updated to reflect the chosen location. You will need to zoom out and manually scroll to the location to see the change, as shown in the following screenshot:<div class="mediaobject"><img src="graphics/3349_05_05.jpg" alt="How to do it..."/></div></li></ol></div></div><div class="section" title="How it works..."><div class="titlepage"><div><div><h2 class="title"><a id="ch05lvl2sec199"/>How it works...</h2></div></div></div><p>In this recipe we learned how we can set the <code class="literal">MapView</code> control to show our current location on the map by using the <a id="id460" class="indexterm"/>
<code class="literal">setShowsUserLocation</code> <a id="id461" class="indexterm"/>
<a id="id462" class="indexterm"/>property of the map view control, as well as how we can use Xcode to allow our iOS device to simulate the different locations, using the <span class="strong"><strong>Simulate Location</strong></span> feature.</p></div><div class="section" title="See also"><div class="titlepage"><div><div><h2 class="title"><a id="ch05lvl2sec200"/>See also</h2></div></div></div><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">The <span class="emphasis"><em>Determining the current GPS location</em></span> recipe</li><li class="listitem" style="list-style-type: disc">The <span class="emphasis"><em>Adding overlay regions to maps</em></span> recipe</li></ul></div></div></div>
<div class="section" title="Adding overlay regions to maps"><div class="titlepage"><div><div><h1 class="title"><a id="ch05lvl1sec57"/>Adding overlay regions to maps</h1></div></div></div><p>In this recipe we will <a id="id463" class="indexterm"/>learn how to create an overlay to mark <a id="id464" class="indexterm"/>an area on our map view control object. These overlay objects are essentially data objects that contain the geographic data needed to represent the map area. For example, overlays can take the form of common shapes such as rectangles and circles.</p><div class="section" title="Getting ready"><div class="titlepage"><div><div><h2 class="title"><a id="ch05lvl2sec201"/>Getting ready</h2></div></div></div><p>In this section we will see how we can use the <code class="literal">MKOverlayView</code> class and the <code class="literal">MKOverlay</code> protocol to allow us to represent both a point and an area on the map.</p></div><div class="section" title="How to do it..."><div class="titlepage"><div><div><h2 class="title"><a id="ch05lvl2sec202"/>How to do it...</h2></div></div></div><p>To begin, follow these <a id="id465" class="indexterm"/>simple steps as outlined in the following order:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Open the <code class="literal">ViewController.m</code> <a id="id466" class="indexterm"/>implementation file from the <span class="strong"><strong>Project Navigator</strong></span> section.</li><li class="listitem">Next, create the <code class="literal">overlayCurrentUserLocation</code> function as shown in the following code snippet:<div class="informalexample"><pre class="programlisting">#pragma mark draws an overlay showing the current user's location
-(void)createOverlayArea
{
  // Show the current user location with 100km radius
  MKCircle *circle = [MKCircle 
   circleWithCenterCoordinate:mapView.userLocation.coordinate 
   radius:100];
  circle.title = @"Current Location";
  [self.mapView addOverlay:circle];

  // Zoom into the current user's location using a 2 km span
  MKCoordinateRegion mapRegion;
   mapRegion.center = mapView.userLocation.coordinate;
  mapRegion.span = MKCoordinateSpanMake(0.2, 0.2);

   [mapView setRegion:mapRegion animated: YES];
}</pre></div></li><li class="listitem">Next, create the <code class="literal">mapView:viewForOverlay:</code> method as shown in the following code snippet:<div class="informalexample"><pre class="programlisting">-(MKOverlayView *)mapView:(MKMapView *)mapView viewForOverlay:(id)overlay
{
    MKCircleView* circleView = [[MKCircleView alloc] 
    initWithOverlay:overlay];
    circleView.strokeColor = [UIColor redColor];
    circleView.lineWidth = 1.0;
    circleView.fillColor = [UIColor colorWithRed:0.0 
    green:255.0 blue:0.0 alpha:0.1];

    return circleView;
}</pre></div></li><li class="listitem">Modify the <code class="literal">locationManager:didUpdateToLocation:</code> method and enter in the following <a id="id467" class="indexterm"/>highlighted code sections as shown in the code snippet:<div class="informalexample"><pre class="programlisting">#pragma mark Work out the current user location on the map 
- (void)locationManager:(CLLocationManager *)manager didUpdateToLocation:(CLLocation *)newLocation fromLocation:(CLLocation *)oldLocation
{
   // If this is the first launch of the app, then set the 
   // center point of the map to the user's location.
   if (!foundLocation)
   {
      // Determine the current geographic location coordinates
     self.curLat  = mapView.userLocation.coordinate.latitude;
     self.curLong = mapView.userLocation.coordinate.longitude;
    
    // Show the current user location within an Alert dialog
   UIAlertView *alert = [[UIAlertView alloc] 
         initWithTitle:@"You are located at"
         message:[NSString stringWithFormat:@"Latitude: %f and 
         Longitude: %f", self.curLat, self.curLong]
         delegate:nil
         cancelButtonTitle:@"OK"
         otherButtonTitles:nil];
  
     // Display the alert view dialog
     [alert show];
    
    // Display our overlaid area on the map
<span class="strong"><strong>    [self createOverlayArea];</strong></span>
     // Reset so that this does not get called again.
      foundLocation = YES;
  }
}</pre></div></li><li class="listitem">Then, build and run the application by choosing <span class="strong"><strong>Product</strong></span> | <span class="strong"><strong>Run</strong></span> from the <span class="strong"><strong>Product</strong></span> menu, or alternatively pressing <span class="emphasis"><em>Command</em></span> + <span class="emphasis"><em>R</em></span>.</li></ol></div><p>You will notice that once the program executes, core location communicates with the iOS device to determine where you are <a id="id468" class="indexterm"/>located and then zooms in and displays a circle showing the radius of the area to which we specified:</p><div class="mediaobject"><img src="graphics/3349_05_06.jpg" alt="How to do it..."/></div></div><div class="section" title="How it works..."><div class="titlepage"><div><div><h2 class="title"><a id="ch05lvl2sec203"/>How it works...</h2></div></div></div><p>In this recipe we created a function called <code class="literal">createOverlayArea</code> which created a circle with a 100 km. radius based on the current user location, and then created a title for this location using the title property of the <code class="literal">MKCircle</code> class and used the <code class="literal">addOverlay</code> method to overlay and add our circle to our <code class="literal">mapView</code> control.</p><p>In our next step, we <a id="id469" class="indexterm"/>used <code class="literal">MKCoordinateRegion</code> to create a 2 km. area span and then zoom in to the area allocated by the radius using the <code class="literal">setRegion</code> setter method. We then created the <code class="literal">mapView:viewForOverlay:</code> method which gets called whenever a object gets overlaid onto the map view control and fills the circle for the overlaid region using the <code class="literal">MKCircleView</code> class and then setting the look and feel of the circle, by setting the <code class="literal">strokeColor</code>, <code class="literal">lineWidth</code>, and <code class="literal">fillColor</code> properties of the circle. In our final section, we modified the <code class="literal">locationManager:didUpdateToLocation:</code> method to include a call to our <code class="literal">ceateOverlayArea</code> function.</p><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="note34"/>Note</h3><p>For more information on the <code class="literal">MKOverlayView</code> class, you can refer to the Apple Developer Documentation located at the following URL:</p><p>
<a class="ulink" href="https://developer.apple.com/library/ios/documentation/MapKit/Reference/MKOverlayView_class/Reference/Reference.html">https://developer.apple.com/library/ios/documentation/MapKit/Reference/MKOverlayView_class/Reference/Reference.html</a>
</p></div></div></div><div class="section" title="See also"><div class="titlepage"><div><div><h2 class="title"><a id="ch05lvl2sec204"/>See also</h2></div></div></div><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">The <span class="emphasis"><em>Adding annotation placeholders to the map</em></span> recipe</li><li class="listitem" style="list-style-type: disc">The <span class="emphasis"><em>Reversing geocode address information</em></span> recipe</li></ul></div></div></div>
<div class="section" title="Adding annotation placeholders to the map"><div class="titlepage"><div><div><h1 class="title"><a id="ch05lvl1sec58"/>Adding annotation placeholders to the map</h1></div></div></div><p>In this recipe we will <a id="id470" class="indexterm"/>
<a id="id471" class="indexterm"/>learn how to create our own custom class that will enable us to add annotations to our map view control.</p><div class="section" title="Getting ready"><div class="titlepage"><div><div><h2 class="title"><a id="ch05lvl2sec205"/>Getting ready</h2></div></div></div><p>In this section we will see how we can use the <code class="literal">MKAnnotation</code> and <code class="literal">MKAnnotationView</code> classes to enable us to apply a series of annotation pins based on the geographic latitude and longitude values to our <code class="literal">mapView</code> control.</p></div><div class="section" title="How to do it…"><div class="titlepage"><div><div><h2 class="title"><a id="ch05lvl2sec206"/>How to do it…</h2></div></div></div><p>To begin, follow these simple steps as outlined in the following order:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Select the <span class="strong"><strong>CoreLocation</strong></span> group, choose <span class="strong"><strong>File</strong></span> | <span class="strong"><strong>New</strong></span> | <span class="strong"><strong>File…</strong></span> or press <span class="emphasis"><em>Command</em></span> + <span class="emphasis"><em>N</em></span>.</li><li class="listitem">Select the <code class="literal">Objective-C</code> class template from the list of available templates.</li><li class="listitem">Click on the <span class="strong"><strong>Next</strong></span> button to proceed to the next step in the wizard.</li><li class="listitem">Enter in <code class="literal">MapViewAnnotation</code> as the name of the class to be created.</li><li class="listitem">Ensure that you have selected <span class="strong"><strong>NSObject</strong></span> as the type of subclass to create from the <span class="strong"><strong>Subclass of</strong></span> drop-down list:<div class="mediaobject"><img src="graphics/3349_05_07.jpg" alt="How to do it…"/></div></li><li class="listitem">Click on the <span class="strong"><strong>Next</strong></span> button to proceed with the next step of the wizard.</li><li class="listitem">Then, click on the <span class="strong"><strong>Create</strong></span> button to save the file to the folder location specified.</li></ol></div><p>Our next step is to <a id="id472" class="indexterm"/>
<a id="id473" class="indexterm"/>implement the functionality and methods used by this class.</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Open the <code class="literal">MapViewAnnotation.h</code> interface file from the <span class="strong"><strong>Project Navigator</strong></span> section, and enter in the following code snippet:<div class="informalexample"><pre class="programlisting">//  MapViewAnnotation.h
//  CoreLocation
//  Created by Steven F Daniel on 23/10/12.
//  Copyright (c) 2012 GenieSoft Studios. All rights reserved.

#import &lt;Foundation/Foundation.h&gt;
#import &lt;MapKit/MapKit.h&gt;

@interface MapViewAnnotation : NSObject &lt;MKAnnotation&gt; {
  NSString *title;
   NSString *subtitle;
  CLLocationCoordinate2D coordinate;  
}

@property (nonatomic, copy) NSString *title;
@property (nonatomic, copy) NSString *subtitle;
@property (nonatomic, readonly) CLLocationCoordinate2D coordinate;

- (id)initWithTitle:(NSString *)header subtitle:(NSString *)subtitle andCoordinate:(CLLocationCoordinate2D)coord2D;

@end</pre></div></li><li class="listitem">Open the <code class="literal">MapViewAnnotation.m</code> <a id="id474" class="indexterm"/><a id="id475" class="indexterm"/>implementation file from the <span class="strong"><strong>Project Navigator</strong></span> section, and enter in the following code snippet:<div class="informalexample"><pre class="programlisting">//  MapViewAnnotation.m
//  CoreLocation
//  Created by Steven F Daniel on 23/10/12.
//  Copyright (c) 2012 GenieSoft Studios. All rights reserved.

#import "MapViewAnnotation.h"

@implementation MapViewAnnotation

@synthesize title, subtitle, coordinate;

- (id)initWithTitle:(NSString *)header subtitle:(NSString *)subtitles andCoordinate:(CLLocationCoordinate2D)coord2D {

  title = header;
   subtitle = subtitles;
  coordinate = coord2D;
  return self;
}

@end</pre></div></li><li class="listitem">Next, open the <code class="literal">ViewController.m</code> implementation file from the <span class="strong"><strong>Project Navigator</strong></span> section, and enter in the highlighted code sections in the following code snippet:<div class="informalexample"><pre class="programlisting">//  ViewController.m
//  CoreLocation
//  Created by Steven F Daniel on 23/10/12.
//  Copyright (c) 2012 GenieSoft Studios. All rights reserved.

#import  "ViewController.h"
<span class="strong"><strong>#import "MapViewAnnotation.h"</strong></span>

@interface ViewController ()
@end

@implementation ViewController

<span class="strong"><strong>@synthesize mapView, curLat, curLong;</strong></span>
</pre></div></li><li class="listitem">Next, <a id="id476" class="indexterm"/><a id="id477" class="indexterm"/>create the <code class="literal">plotGeographicalData</code> method as shown in the following code snippet:<div class="informalexample"><pre class="programlisting">#pragma mark Plots the geographic locations onto the Map
-(void)plotGeographicalData
{
  // Remove any existing custom annotations but not the user 
  // location blue dot.
  for (id &lt;MKAnnotation&gt; annotation in mapView.annotations) {
   if ([annotation isKindOfClass:[MapViewAnnotation class]]) {
       [mapView removeAnnotation:annotation];
   }
  }
  // Add the annotation to our map view
  NSString          *pinName;
  MapViewAnnotation *newAnnotation;
  
  pinName = @"Kuala Lumpur";
  newAnnotation = [[MapViewAnnotation alloc] 
  initWithTitle:pinName
        subtitle:@"Malaysia"
  andCoordinate:
  CLLocationCoordinate2DMake(3.13900,101.68685)];

  [self.mapView addAnnotation:newAnnotation];

  // Add the annotation to our map view
  pinName = @"Western Australia";
  newAnnotation = [[MapViewAnnotation alloc] 
  initWithTitle:pinName
        subtitle:@"Perth, WA"
            andCoordinate:
            CLLocationCoordinate2DMake(-31.93285, 115.86194)];
  [self.mapView addAnnotation:newAnnotation];

  // Zoom in so that all pins fit within the map region
  [self zoomToFitMapAnnotations];
}</pre></div></li><li class="listitem">Then, create <a id="id478" class="indexterm"/>the <a id="id479" class="indexterm"/><code class="literal">mapView:viewForAnnotation:</code> method as shown in the following code snippet:<div class="informalexample"><pre class="programlisting">#pragma mark sets up the properties for each of the annotations on the map
-(MKAnnotationView *)mapView:(MKMapView *)mapView viewForAnnotation:(id &lt;MKAnnotation&gt;)annotation {

// Define the identifier for the MapViewAnnotation Class.
static NSString *identifier = @"MapViewAnnotation";

// Place the current user location onto the Map at the 
// location determined using the MKUserLocation class.
if ([annotation isKindOfClass:[MKUserLocation class]]) {
     MKPinAnnotationView *annotationView = 
    (MKPinAnnotationView *) [self.mapView 
    dequeueReusableAnnotationViewWithIdentifier:identifier];
    if (annotationView == nil) {
      annotationView = [[MKPinAnnotationView alloc] 
      initWithAnnotation:annotation 
      reuseIdentifier:identifier];
} 
else {
   annotationView.annotation = annotation;
}
annotationView.enabled = YES;
annotationView.canShowCallout = YES;
annotationView.animatesDrop = NO;
annotationView.pinColor = MKPinAnnotationColorGreen;
return annotationView;
}

return nil;
}</pre></div></li><li class="listitem">Then, build and run the application by choosing <span class="strong"><strong>Product</strong></span> | <span class="strong"><strong>Run</strong></span> from the <span class="strong"><strong>Product</strong></span> menu, or alternatively pressing <span class="emphasis"><em>Command</em></span> + <span class="emphasis"><em>R</em></span>.</li></ol></div></div><div class="section" title="How it works..."><div class="titlepage"><div><div><h2 class="title"><a id="ch05lvl2sec207"/>How it works...</h2></div></div></div><p>In this recipe we created a new custom <a id="id480" class="indexterm"/>
<code class="literal">MapViewAnnotation</code> class and then extend this class to make use of the <code class="literal">MKAnnotation</code> protocol so that we can access its associated class methods. Next, we created a method <code class="literal">initWithTitle:</code> within our <code class="literal">MapViewAnnotation.m</code> implementation file that will be used to store our header and coordinates for the pin placement.</p><p>In our next step, we modified our <code class="literal">ViewController.m</code> implementation file and created a new function called <code class="literal">plotGeographicalData</code> that is used to create a number of different geographic locations using <code class="literal">CLLocationCoordinate2DMake</code> to create the latitude and longitude values for each geographic location in the array.</p><p>We then pass the geographic locations to the <a id="id481" class="indexterm"/>
<code class="literal">addAnnotation</code> method of the <code class="literal">MapViewAnnotation</code> class to <a id="id482" class="indexterm"/>add the annotation to the map. Finally, we create the <code class="literal">mapView:viewForAnnotation</code> method to place the annotation object onto the map by using our <code class="literal">MapViewAnnotation</code> class instance.</p><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="note35"/>Note</h3><p>For more information on the <code class="literal">MKAnnotationView</code> class, you can refer to the Apple Developer Documentation located at the following URL:</p><p>
<a class="ulink" href="https://developer.apple.com/library/ios/#documentation/MapKit/Reference/MKAnnotationView_Class/Reference/Reference.html">https://developer.apple.com/library/ios/#documentation/MapKit/Reference/MKAnnotationView_Class/Reference/Reference.html</a><code class="literal">#//apple_ref/occ/cl/MKAnnotationView</code>
</p></div></div></div><div class="section" title="There's more…"><div class="titlepage"><div><div><h2 class="title"><a id="ch05lvl2sec208"/>There's more…</h2></div></div></div><p>In order to ensure that the map annotations happen, we need to modify the <code class="literal">locationManager:didUpdateToLocation</code> method. This method is called after the iOS device has found the <a id="id483" class="indexterm"/>users' current location on the map or whenever the map location changes.</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Modify the <code class="literal">locationManager:didUpdateToLocation:</code> method and enter in the following highlighted code sections as shown in the code snippet:<div class="informalexample"><pre class="programlisting">#pragma mark Work out the current user location on the map 
- (void)locationManager:(CLLocationManager *)manager didUpdateToLocation:(CLLocation *)newLocation fromLocation:(CLLocation *)oldLocation
{
   // If this is the first launch of the app, then set the 
   // center point of the map to the user's location.
if (!foundLocation)
{
// Determine the current geographic location coordinates
self.curLat  = mapView.userLocation.coordinate.latitude;
self.curLong = mapView.userLocation.coordinate.longitude;
    
// Show the current user location within an Alert dialog
  UIAlertView *alert = [[UIAlertView alloc] 
   initWithTitle:@"You are located at"
   message:[NSString stringWithFormat:@"Latitude: %f and 
   Longitude: %f", self.curLat, self.curLong]
   delegate:nil
   cancelButtonTitle:@"OK"
   otherButtonTitles:nil];
  
   // Display the alert view dialog
   [alert show];
    
  // Display our overlaid area on the map
<span class="strong"><strong>  [self createOverlayArea];</strong></span>

  // Plot the geographic positions on the map
<span class="strong"><strong>  [self plotGeographicalData];</strong></span>
    
  // Reset so that this does not get called again.
   foundLocation = YES;
  }
}</pre></div></li><li class="listitem">Next, create <a id="id484" class="indexterm"/>the <code class="literal">zoomToFitMapAnnotations</code> function as shown in the following code snippet:<div class="informalexample"><pre class="programlisting">#pragma mark Zooms in to the map so that all visible annotations are displayed
- (void)zoomToFitMapAnnotations 
{
if ([self.mapView.annotations count] == 0) return;

int i = 0;
MKMapPoint points[[self.mapView.annotations count]];

  // Cycle through all annotations on the map and 
  // build array of annotation points
  for (id&lt;MKAnnotation&gt; annotation in [self.mapView 
       annotations]) {
       points[i++] = 
       MKMapPointForCoordinate(annotation.coordinate);
  }  
  // Create a rectangle view around the visible region 
  // that the user can move around in.
  MKPolygon *pv= [MKPolygon polygonWithPoints:points count:i];
  [self.mapView setRegion:MKCoordinateRegionForMapRect([pv
  boundingMapRect]) animated:YES];
}</pre></div><p>In the previous code snippet, the <code class="literal">zoomToFitMapAnnotations</code> method is used to create a scrollable area around the visible region that the user can move around in. This is accomplished by using the <code class="literal">MKPolygon</code> class to create a series of points around each of the annotations on the map.</p></li><li class="listitem">Then, build and run the <a id="id485" class="indexterm"/>application by choosing <span class="strong"><strong>Product</strong></span> | <span class="strong"><strong>Run</strong></span> from the <span class="strong"><strong>Product</strong></span> menu, or alternatively pressing <span class="emphasis"><em>Command</em></span> + <span class="emphasis"><em>R</em></span>.<div class="mediaobject"><img src="graphics/3349_05_08.jpg" alt="There's more…"/></div><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="note36"/>Note</h3><p>For more information on the <code class="literal">MKPolygon</code> class, you can refer to the Apple Developer Documentation located at the following URL:</p><p>
<a class="ulink" href="https://developer.apple.com/library/ios/#documentation/MapKit/Reference/MKPolygon_class/Reference/Reference.html">https://developer.apple.com/library/ios/#documentation/MapKit/Reference/MKPolygon_class/Reference/Reference.html</a>
</p></div></div></li></ol></div></div><div class="section" title="See also"><div class="titlepage"><div><div><h2 class="title"><a id="ch05lvl2sec209"/>See also</h2></div></div></div><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">The <span class="emphasis"><em>Adding overlay regions to the map</em></span> recipe</li><li class="listitem" style="list-style-type: disc">The <span class="emphasis"><em>Reversing geocode address information</em></span> recipe</li></ul></div></div></div>
<div class="section" title="Reversing geocode address information"><div class="titlepage"><div><div><h1 class="title"><a id="ch05lvl1sec59"/>Reversing geocode address information</h1></div></div></div><p>In this recipe we will <a id="id486" class="indexterm"/>learn about reverse geocoding address information into human readable information.</p><div class="section" title="Getting ready"><div class="titlepage"><div><div><h2 class="title"><a id="ch05lvl2sec210"/>Getting ready</h2></div></div></div><p>In this section we will gain an understanding of the phrase reverse geocoding, and how this can be used to transform latitude and longitude information into human-recognizable address information.</p></div><div class="section" title="How to do it..."><div class="titlepage"><div><div><h2 class="title"><a id="ch05lvl2sec211"/>How to do it...</h2></div></div></div><p>To begin, follow these simple steps as outlined in the following order:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Open the <code class="literal">ViewController.m</code> implementation file from the <span class="strong"><strong>Project Navigator</strong></span> section.</li><li class="listitem">Modify the <code class="literal">viewDidLoad</code> method as shown by the highlighted code sections in the following code snippet:<div class="informalexample"><pre class="programlisting">- (void)viewDidLoad {

[super viewDidLoad];
  
// Do any additional setup after loading the view, 
 // typically from a nib.
foundLocation= NO;

// Make this controller the delegate for the map view.
self.mapView.delegate = self;
  
// Ensure that you can view your own location 
 // in the map view.
[self.mapView setShowsUserLocation:YES];
  
// Instantiate a new location object.
locationManager = [[CLLocationManager alloc] init];
  
// Make this controller the delegate for the location
 // manager.
[locationManager setDelegate:self];
  
// Set some parameters for the location object.
[locationManager setDistanceFilter:kCLDistanceFilterNone];
[locationManager setDesiredAccuracy:kCLLocationAccuracyBest];

  
// Determine the current geographic location coordinates
 // of the user on the map
[locationManager startUpdatingLocation];
<span class="strong"><strong>[self getGeocodingInformation];</strong></span>
}</pre></div></li><li class="listitem">Next, create the <a id="id487" class="indexterm"/><code class="literal">getGeocodingInformation</code> <a id="id488" class="indexterm"/>method as shown in the following code snippet:<div class="informalexample"><pre class="programlisting">#pragma mark Reverse Geocoding location details
-(void)getGeocodingInformation
{
// Declare the coordinates to reverse geocode
  CLGeocoder *geoCoder = [[CLGeocoder alloc] init];
  CLLocationCoordinate2D placeCoord =  
CLLocationCoordinate2DMake(3.13900, 101.68685);

  CLLocation *location = [[CLLocation alloc] 
initWithLatitude:placeCoord.latitude 
longitude:placeCoord.longitude];
  
[geoCoder reverseGeocodeLocation:location 
completionHandler: ^(NSArray *placemarks, NSError *error) 
{
    // Get nearby address and print it out to the Console
    CLPlacemark *placemark = [placemarks objectAtIndex:0];
    
    // Show the placemark information within an Alert dialog
    UIAlertView *alert = [[UIAlertView alloc] 
initWithTitle:@"Placemark Information"
message:[placemark.addressDictionary description]
delegate:nil
cancelButtonTitle:@"OK"
otherButtonTitles:nil];
    
// Display the alert view dialog
[alert show];
  }];

  return;
}</pre></div></li><li class="listitem">Then, build and run the application by choosing <span class="strong"><strong>Product</strong></span> | <span class="strong"><strong>Run</strong></span> from the <span class="strong"><strong>Product</strong></span> menu, or alternatively pressing <span class="emphasis"><em>Command</em></span> + <span class="emphasis"><em>R</em></span>.</li></ol></div><p>You will notice that once the <a id="id489" class="indexterm"/>program executes, the provided latitude and longitude information has been transformed into human recognizable address information.</p><div class="mediaobject"><img src="graphics/3349_05_09.jpg" alt="How to do it..."/></div></div><div class="section" title="How it works..."><div class="titlepage"><div><div><h2 class="title"><a id="ch05lvl2sec212"/>How it works...</h2></div></div></div><p>In this recipe we added a new method call, <code class="literal">getGeocodingInformation</code>, to our <code class="literal">viewDidLoad</code> method that will be responsible for displaying our geographical location information within an <code class="literal">UIAlertView</code> dialog window. We then create a new object variable <code class="literal">geoCoder</code> of the <a id="id490" class="indexterm"/>
<code class="literal">CLGeoCoder</code> class and then pass a set of latitude and longitude values to the <code class="literal">CLLocation</code> class, which then gets passed to the <code class="literal">reverseGeocodeLocation</code> <a id="id491" class="indexterm"/>method of the <code class="literal">CLGeoCode</code> class to work out the geographic location details of the coordinates.</p><p>Once a determination has been <a id="id492" class="indexterm"/>made by the <code class="literal">reverseGeocodeLocation</code> method, the result is returned into an NSArray object <code class="literal">placemarks</code> that hold the actual data. Finally, we make a call to the <code class="literal">CLPlacemark</code> class to retrieve the location information <a id="id493" class="indexterm"/>
<a id="id494" class="indexterm"/>using the <code class="literal">addressDictionary</code> of the <code class="literal">placemark</code> object.</p><p>The following table provides a brief description of some of the different types of information returned by the <code class="literal">CLPlacemark</code> class:</p><div class="informaltable"><table border="1"><colgroup><col style="text-align: left"/><col style="text-align: left"/></colgroup><thead><tr><th style="text-align: left" valign="bottom">
<p>Placemark properties</p>
</th><th style="text-align: left" valign="bottom">
<p>Description</p>
</th></tr></thead><tbody><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">Name</code>
</p>
</td><td style="text-align: left" valign="top">
<p>This property <a id="id495" class="indexterm"/>
<a id="id496" class="indexterm"/>contains the name of the placemark.</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">Country</code>
</p>
</td><td style="text-align: left" valign="top">
<p>This property is <a id="id497" class="indexterm"/>
<a id="id498" class="indexterm"/>self-explanatory and simply stores the country's name.</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">CountryCode</code>
</p>
</td><td style="text-align: left" valign="top">
<p>This property <a id="id499" class="indexterm"/>
<a id="id500" class="indexterm"/>provides you with the abbreviated country name.</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">Thoroughfare</code>
</p>
</td><td style="text-align: left" valign="top">
<p>This contains the street <a id="id501" class="indexterm"/>
<a id="id502" class="indexterm"/>address associated with the placemark.</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">Sublocality</code>
</p>
</td><td style="text-align: left" valign="top">
<p>This property provides you <a id="id503" class="indexterm"/>
<a id="id504" class="indexterm"/>with additional city-level information for the placemark.</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">SubAdministrativeArea</code>
</p>
</td><td style="text-align: left" valign="top">
<p>This property provides you <a id="id505" class="indexterm"/>
<a id="id506" class="indexterm"/>with additional information for the landmark.</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">ZIP</code>
</p>
</td><td style="text-align: left" valign="top">
<p>This is typically the <a id="id507" class="indexterm"/>
<a id="id508" class="indexterm"/>postal code for the placemark.</p>
</td></tr></tbody></table></div><p>In addition to these properties shown previously, the address dictionary provides you with a <code class="literal">FormattedAddressLines</code> entry that stores an array of preformatted strings for the address in question.</p><p>You can use these strings to display an address, for example: "Taman Batu Metropolitan, Jalan Damansara, 50470 Kuala Lumpur KL, Malaysia", the following code snippet shows you how this can be achieved:</p><div class="informalexample"><pre class="programlisting">NSLog(@"Location: %@",[[placemark.addressDictionary valueForKey:@"FormattedAddressLines"] componentsJoinedByString:@", "]);</pre></div></div><div class="section" title="There's more…"><div class="titlepage"><div><div><h2 class="title"><a id="ch05lvl2sec213"/>There's more…</h2></div></div></div><p>A <code class="literal">CLPlacemark</code> object <a id="id509" class="indexterm"/>stores information relating to the placemark data for a given latitude and longitude and contains<a id="id510" class="indexterm"/> information such as the country, state, city, as well as the street address information that is associated with the specified coordinates. This class also includes points of interest and geographically related data. Placemarks are typically generated using the <code class="literal">CLGeocoder</code> object.</p><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="note37"/>Note</h3><p>For more information on the <code class="literal">CLGeoCoderand CLPlacemark</code> class, you can refer to the Apple Developer Documentation located at the following URLs:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><a class="ulink" href="https://developer.apple.com/library/ios/#documentation/CoreLocation/Reference/CLGeocoder_class/Reference/Reference.html">https://developer.apple.com/library/ios/#documentation/CoreLocation/Reference/CLGeocoder_class/Reference/Reference.html</a></li><li class="listitem" style="list-style-type: disc"><a class="ulink" href="https://developer.apple.com/library/ios/#documentation/CoreLocation/Reference/CLPlacemark_class/Reference/Reference.html">https://developer.apple.com/library/ios/#documentation/CoreLocation/Reference/CLPlacemark_class/Reference/Reference.html</a><code class="literal">#//apple_ref/occ/cl/CLPlacemark</code></li></ul></div></div></div></div><div class="section" title="See also"><div class="titlepage"><div><div><h2 class="title"><a id="ch05lvl2sec214"/>See also</h2></div></div></div><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">The <span class="emphasis"><em>Determining the current GPS location</em></span> recipe</li></ul></div></div></div>
<div class="section" title="Working with the different map types"><div class="titlepage"><div><div><h1 class="title"><a id="ch05lvl1sec60"/>Working with the different map types</h1></div></div></div><p>In this recipe we will learn <a id="id511" class="indexterm"/>
<a id="id512" class="indexterm"/>how to change between the different map views.</p><div class="section" title="Getting ready"><div class="titlepage"><div><div><h2 class="title"><a id="ch05lvl2sec215"/>Getting ready</h2></div></div></div><p>In this section we will start by implementing the method that will be responsible for handling changing of the different map views that the MapKit framework provides.</p></div><div class="section" title="How to do it..."><div class="titlepage"><div><div><h2 class="title"><a id="ch05lvl2sec216"/>How to do it...</h2></div></div></div><p>To begin, follow these simple steps as outlined in the following order:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Open the <code class="literal">ViewController.h</code> interface file from the <span class="strong"><strong>Project Navigator</strong></span> section.</li><li class="listitem">Next, modify the interface file as shown by the highlighted code sections in the following code snippet:<div class="informalexample"><pre class="programlisting">//  ViewController.h
//  CoreLocation
//  Created by Steven F Daniel on 23/10/12.
//  Copyright (c) 2012 GenieSoft Studios. All rights reserved.

#import &lt;UIKit/UIKit.h&gt;
#import &lt;MapKit/MapKit.h&gt;
#import &lt;CoreLocation/CoreLocation.h&gt;
<span class="strong"><strong>@interface ViewController : UIViewController &lt;UIActionSheetDelegate, MKMapViewDelegate, CLLocationManagerDelegate&gt;</strong></span>
{
CLLocationManager        *locationManager;
  IBOutlet UIBarButtonItem *changeMap;
BOOL                   foundLocation;

    // Obtain the user's current Longitude/Latitude
    float                  curlatitude;
    float                  curlongitude;
}

@property (strong, nonatomic) IBOutlet MKMapView *mapView;

@property float curlatitude;
@property float curlongitude;

// Declare our class instance methods
-(IBAction)changeMapType:(id)sender;

@end</pre></div></li><li class="listitem">Open the <code class="literal">ViewController.m</code> <a id="id513" class="indexterm"/><a id="id514" class="indexterm"/>implementation file from the <span class="strong"><strong>Project Navigator</strong></span> section.</li><li class="listitem">Next, modify the <code class="literal">changeMapType:</code> method as shown in the following code snippet:<div class="informalexample"><pre class="programlisting">// Called when the user presses the Map Type button
- (IBAction)changeMapType:(id)sender{

// Define an instance of our action sheet
UIActionSheet *actionSheet;

// Initialize our action sheet with the 
 // differen't mapping types
actionSheet = [[UIActionSheet alloc]
initWithTitle:@"Select a Map Type from the list below"
delegate:self
cancelButtonTitle:@"Cancel"
destructiveButtonTitle:@"Close"
otherButtonTitles:@"Map View",@"Satellite View",
@"Hybrid View", nil];
// Set our ActionSheet style and display it to the user
    actionSheet.actionSheetStyle =  
UIBarStyleBlackTranslucent;
    [actionSheet showInView:self.view];
}</pre></div></li><li class="listitem">Next, create the following <a id="id515" class="indexterm"/><a id="id516" class="indexterm"/><code class="literal">clickedButtonAtIndex:</code> method as shown in the following <a id="id517" class="indexterm"/>code snippet:<div class="informalexample"><pre class="programlisting">// Delegate that handles the chosen action sheet options
-(void)actionSheet:(UIActionSheet *)actionSheet clickedButtonAtIndex:(NSInteger)buttonIndex
{
    // Determine the chosen item
    switch (buttonIndex) {
        case 1:  mapView.mapType = MKMapTypeStandard;  break;
        case 2:  mapView.mapType = MKMapTypeSatellite; break;
        case 3:  mapView.mapType = MKMapTypeHybrid;    break;
        default: break;  // Catch the Close button and exit.
    }
}</pre></div></li><li class="listitem">Build and run the application by choosing <span class="strong"><strong>Product</strong></span> | <span class="strong"><strong>Run</strong></span> from the <span class="strong"><strong>Product</strong></span> menu, or alternatively pressing <span class="emphasis"><em>Command</em></span> + <span class="emphasis"><em>R</em></span>.</li></ol></div></div><div class="section" title="How it works..."><div class="titlepage"><div><div><h2 class="title"><a id="ch05lvl2sec217"/>How it works...</h2></div></div></div><p>In this recipe we started by extending our interface file class so that we can include the protocol for our <code class="literal">UIActionSheetDelegate</code> so that we can gain access to the respective methods. We then declared and instantiated an <code class="literal">actionSheet</code> object that is based on the <code class="literal">UIActionSheet</code> class, and then initialized our <code class="literal">actionSheet</code> object to display the different map types to choose from. We then proceed to set the style for <code class="literal">actionSheet</code> using the <code class="literal">actionSheetStyle</code> <a id="id518" class="indexterm"/>property of the <a id="id519" class="indexterm"/>
<code class="literal">UIActionSheet</code> class, and then display the <code class="literal">actionSheet</code> into the <a id="id520" class="indexterm"/>current view using the <code class="literal">showInView:self.view</code> method.</p><p>In our next part, we declared a delegate method to determine the button that was pressed from the <code class="literal">actionSheet</code> object, using the <code class="literal">clickedButtonIndex</code> method of the <code class="literal">acionSheet</code> property. Finally, we check the value of the <code class="literal">buttonIndex</code> variable to determine the index of the button that was pressed. When using the <code class="literal">buttonIndex</code> variable, keep in mind that the starting value is always 0.</p><p>The following table provides a brief description of each of the different map views:</p><div class="informaltable"><table border="1"><colgroup><col style="text-align: left"/><col style="text-align: left"/></colgroup><thead><tr><th style="text-align: left" valign="bottom">
<p>Map type</p>
</th><th style="text-align: left" valign="bottom">
<p>Description</p>
</th></tr></thead><tbody><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">MKMapTypeStandard</code>
</p>
</td><td style="text-align: left" valign="top">
<p>This is the default map type to <a id="id521" class="indexterm"/>
<a id="id522" class="indexterm"/>be displayed, if none is specified. This setting will display a normal map containing the street and road names.</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">MKMapTypeSatellite</code>
</p>
</td><td style="text-align: left" valign="top">
<p>This type of map will display the <a id="id523" class="indexterm"/>
<a id="id524" class="indexterm"/>satellite view information.</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">MKMapTypeHybrid</code>
</p>
</td><td style="text-align: left" valign="top">
<p>This type of map will show a <a id="id525" class="indexterm"/>
<a id="id526" class="indexterm"/>combination of a satellite view with road and street information that is overlaid onto the map.</p>
</td></tr></tbody></table></div><p>The following screenshot <a id="id527" class="indexterm"/>
<a id="id528" class="indexterm"/>shows the CoreLocation application running on an iOS device, showing the current location and the different geographic locations plotted to the map, as well as the selection of map types available when the <span class="strong"><strong>Map Type</strong></span> button is pressed.</p><div class="mediaobject"><img src="graphics/3349_05_10.jpg" alt="How it works..."/></div><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="note38"/>Note</h3><p>For more <a id="id529" class="indexterm"/>
<a id="id530" class="indexterm"/>information on the <code class="literal">MapKit</code> class, you can refer to the Apple Developer <a id="id531" class="indexterm"/>Documentation located at the following URL:</p><p>
<a class="ulink" href="https://developer.apple.com/library/ios/#documentation/MapKit/Reference/MKMapView_Class/MKMapView/MKMapView.html">https://developer.apple.com/library/ios/#documentation/MapKit/Reference/MKMapView_Class/MKMapView/MKMapView.html</a>
</p></div></div></div><div class="section" title="See also"><div class="titlepage"><div><div><h2 class="title"><a id="ch05lvl2sec218"/>See also</h2></div></div></div><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">The <span class="emphasis"><em>Adding annotation placeholders to the map</em></span> recipe</li><li class="listitem" style="list-style-type: disc">The <span class="emphasis"><em>Determining the current GPS location</em></span> recipe</li></ul></div></div></div></body></html>