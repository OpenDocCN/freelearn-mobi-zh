<html><head></head><body><div class="chapter" title="Chapter&#xA0;6.&#xA0;Storing Documents within the Cloud"><div class="titlepage"><div><div><h1 class="title"><a id="ch06"/>Chapter 6. Storing Documents within the Cloud</h1></div></div></div><p>In this chapter, we will cover:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">Storing and using documents within iCloud</li><li class="listitem" style="list-style-type: disc">Working with the iCloud storage APIs</li><li class="listitem" style="list-style-type: disc">Using iCloud document storage</li><li class="listitem" style="list-style-type: disc">Storing key-value data in iCloud</li><li class="listitem" style="list-style-type: disc">Detecting file version conflicts within iCloud</li><li class="listitem" style="list-style-type: disc">Building the <code class="literal">iCloud</code> application</li><li class="listitem" style="list-style-type: disc">Requesting entitlements for iCloud storage</li><li class="listitem" style="list-style-type: disc">Configuring iOS devices to use iCloud</li></ul></div><div class="section" title="Introduction"><div class="titlepage"><div><div><h1 class="title"><a id="ch06lvl1sec61"/>Introduction</h1></div></div></div><p>The iCloudExample application <a id="id532" class="indexterm"/>allows you to keep a visual record for simple reminders for your everyday needs. This application records this information, and then adds this information into your iCloud account repository, using the <a id="id533" class="indexterm"/>
<span class="strong"><strong>iCloud storage APIs</strong></span>.</p><p>In this chapter, we will take a look at the features of iCloud and the storage APIs, and see how we can incorporate these into our applications, so that it can interact with the iCloud servers to read, write, and edit documents, and provide us with the ability to access these items from all our iOS devices, without the need of having to synchronize or transfer these files.</p><p>Storing documents within the user's iCloud account provides us with an additional layer of security, so even if the user loses their device, these documents can easily be retrieved, and provide the ability to sync data between devices, provided that they are contained within iCloud storage.</p></div></div>
<div class="section" title="Storing and using documents within iCloud"><div class="titlepage"><div><div><h1 class="title"><a id="ch06lvl1sec62"/>Storing and using documents within iCloud</h1></div></div></div><p>In this recipe, we will <a id="id534" class="indexterm"/>
<a id="id535" class="indexterm"/>
<a id="id536" class="indexterm"/>
<a id="id537" class="indexterm"/>learn about the different methods that can be used to store and use documents within iCloud.</p><div class="section" title="Getting ready"><div class="titlepage"><div><div><h2 class="title"><a id="ch06lvl2sec219"/>Getting ready</h2></div></div></div><p>In this section, we will learn about the file coordinator and the file presenter classes and how the <code class="literal">UIDocument</code> class<a id="id538" class="indexterm"/> can be registered to receive updates whenever the iCloud data gets updated.</p></div><div class="section" title="How to do it..."><div class="titlepage"><div><div><h2 class="title"><a id="ch06lvl2sec220"/>How to do it...</h2></div></div></div><p>The following example shows how to use the <a id="id539" class="indexterm"/>
<code class="literal">NSFileCoordinator</code> class:</p><div class="informalexample"><pre class="programlisting">myDocument = [[myDocument alloc] initWithFileURL:ubiquityURL];
myDocument.delegate = self;
coordinator = [[NSFileCoordinator alloc]    
               initWithFilePresenter:myDocument];    
               [NSFileCoordinator addFilePresenter:myDocument];</pre></div><p>The job of a file coordinator is to coordinate the reads and writes performed by your application and the <span class="strong"><strong>sync </strong></span>
<a id="id540" class="indexterm"/>
<span class="strong"><strong>daemon</strong></span> on the same document. For example, your application and the daemon may both read the document at the same time, but only one may write to the file at any single time.</p><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="note39"/>Note</h3><p>For more information on the <a id="id541" class="indexterm"/>
<code class="literal">NSFileCoordinator </code>class, you can refer to the Apple Developer Documentation located at the following link location: <a class="ulink" href="https://developer.apple.com/library/mac/#documentation/Foundation/Reference/NSFileCoordinator_class/Reference/Reference.html">https://developer.apple.com/library/mac/#documentation/Foundation/Reference/NSFileCoordinator_class/Reference/Reference.html</a>
</p></div></div><p>The following example shows how to move a document from local storage to iCloud:</p><div class="informalexample"><pre class="programlisting">if (![[NSFileManager defaultManager] setUbiquitous:YES
    itemAtURL:localURL destinationURL:ubiquityURL error:&amp;error]){
    NSLog(@"Error making local file ubiquitous. %@",    
           [error localizedFailureReason]);    
    return;    
}</pre></div><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="note40"/>Note</h3><p>For more information on the <code class="literal">NSFilePresenter</code> protocol reference, you can refer to the Apple developer documentation located at the following link location:</p><p>
<a class="ulink" href="https://developer.apple.com/library/mac/#documentation/Foundation/Reference/NSFilePresenter_protocol/Reference/Reference.html">https://developer.apple.com/library/mac/#documentation/Foundation/Reference/NSFilePresenter_protocol/Reference/Reference.html</a>
</p></div></div><p>As you can see from the following screenshot, it shows the process when changes are made on one device, and having <a id="id542" class="indexterm"/>
<a id="id543" class="indexterm"/>
<a id="id544" class="indexterm"/>
<a id="id545" class="indexterm"/>those changes stored locally before being pushed back out to the iCloud service, using a local daemon process. We will learn about the <code class="literal">NSFileCoordinator</code> class and storing documents in the cloud when we look at building our example application for this chapter.</p><div class="mediaobject"><img src="graphics/3349OT_06_01.jpg" alt="How to do it..."/></div><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="note41"/>Note</h3><p>Whenever your application <a id="id546" class="indexterm"/>
<a id="id547" class="indexterm"/>
<a id="id548" class="indexterm"/>
<a id="id549" class="indexterm"/>stores documents to iCloud, it must specify one or more containers in which those documents contents will be stored, by including the <code class="literal">com.apple.developer.ubiquity-container-identifiers</code> key value entry within your application's <code class="literal">entitlements</code> file.</p></div></div></div><div class="section" title="How it works..."><div class="titlepage"><div><div><h2 class="title"><a id="ch06lvl2sec221"/>How it works...</h2></div></div></div><p>In this recipe, we learned how to establish a <a id="id550" class="indexterm"/>
<code class="literal">UIDocument</code> document as a file presenter so that you can register the class to receive updates whenever its cloud data gets updated by telling <code class="literal">NSFileCoordinator</code> to add the document as <span class="emphasis"><em>presenter</em></span>. This means that a presenter class is one that takes a strong interest in knowing when outside changes happen to a given file.</p><p>Whenever you register for changes, you start by creating a document and a coordinator and then initialize the coordinator with the document as its performer, as shown in the first code snippet. Handling it this way, means that, the new document or presenter using the <code class="literal">NSFileCoordinator</code> class allows it to receive alerts about these changes and allows you to update your applications UI to handle when these changes occur.</p><p>Next, we use the <a id="id551" class="indexterm"/>
<code class="literal">NSFileManager</code> class that allows you to move local files to and from the cloud using the <code class="literal">setUbiquitous:itemAtURL:destinationURL:error:</code> method. This method does nothing <a id="id552" class="indexterm"/>more, except moves the file safely from your sandbox into the central iCloud folder and back.</p><p>The method takes three arguments. <a id="id553" class="indexterm"/>
<a id="id554" class="indexterm"/>
<a id="id555" class="indexterm"/>
<a id="id556" class="indexterm"/>The first establishes the direction of movement. <code class="literal">YES</code> brings items from the sandbox to the cloud. The second argument must always be the source URL, and the third its destination. If all three arguments are placed in the wrong order, the method will fail. The local sandbox URL takes on the following form as can be seen in the following URL:</p><p>
<code class="literal">file://localhost/private/var/mobile/Library/Mobile%20Documents/TEAMID~com~geniesoftstudios~iCloudExample/Document.doc;</code>
</p></div><div class="section" title="See also"><div class="titlepage"><div><div><h2 class="title"><a id="ch06lvl2sec222"/>See also</h2></div></div></div><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">The <span class="emphasis"><em>Working with the iCloud storage APIs</em></span> recipe</li><li class="listitem" style="list-style-type: disc">The <span class="emphasis"><em>Requesting entitlements for iCloud storage</em></span> recipe</li></ul></div></div></div>
<div class="section" title="Working with the iCloud storage APIs"><div class="titlepage"><div><div><h1 class="title"><a id="ch06lvl1sec63"/>Working with the iCloud storage APIs</h1></div></div></div><p>In this recipe, we will <a id="id557" class="indexterm"/>take a look at the different types of storage methods available to us when using iCloud, and how these can be incorporated into your own applications.</p><div class="section" title="Getting ready"><div class="titlepage"><div><div><h2 class="title"><a id="ch06lvl2sec223"/>Getting ready</h2></div></div></div><p>Storing documents within iCloud lets your applications write documents and data to a common central location. This also provides the ability to sync and access items and recover documents from all of your other iOS devices and Mac OS X computers, should the user lose their iOS device.</p></div><div class="section" title="How to do it..."><div class="titlepage"><div><div><h2 class="title"><a id="ch06lvl2sec224"/>How to do it...</h2></div></div></div><p>To fully utilize iCloud storage, there is a need to fully understand one of the two ways in which this can happen and how information <a id="id558" class="indexterm"/>can be accessed. The following table explains the various storage types and their descriptions:</p><div class="informaltable"><table border="1"><colgroup><col style="text-align: left"/><col style="text-align: left"/></colgroup><thead><tr><th style="text-align: left" valign="bottom">
<p>Storage type</p>
</th><th style="text-align: left" valign="bottom">
<p>Description</p>
</th></tr></thead><tbody><tr><td style="text-align: left" valign="top">
<p>iCloud document <a id="id559" class="indexterm"/>
<a id="id560" class="indexterm"/>storage</p>
</td><td style="text-align: left" valign="top">
<p>Use this feature to store and share user documents and data in the user's iCloud account.</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>iCloud key-value <a id="id561" class="indexterm"/>
<a id="id562" class="indexterm"/>data storage</p>
</td><td style="text-align: left" valign="top">
<p>Use this feature to store and share small amounts of data among instances of your application.</p>
</td></tr></tbody></table></div><div class="mediaobject"><img src="graphics/3349OT_06_02.jpg" alt="How to do it..."/></div><p>As you can see from the previous screenshot, this shows you the overall process involved whenever information is created within local iCloud storage within your application's sandbox.</p><div class="section" title="Using iCloud document storage"><div class="titlepage"><div><div><h3 class="title"><a id="ch06lvl3sec08"/>Using iCloud document storage</h3></div></div></div><p>Storing documents within <a id="id563" class="indexterm"/>iCloud is easiest to implement and can be achieved by subclassing a class called the <code class="literal">UIDocument</code> class. This class handles everything that is required to read and write files, coordinating with the iCloud daemon, and more.</p><div class="informalexample"><pre class="programlisting">// Point to our iCloud Documents container.
  NSURL *ubiq = [[NSFileManager defaultManager] 
  URLForUbiquityContainerIdentifier:nil];
  NSURL *ubiquitousPackage = [[ubiq
  URLByAppendingPathComponent:@"Documents"]
  URLByAppendingPathComponent:@"/Document.doc"];
  Document *doc = [[Document alloc]    
  initWithFileURL:ubiquitousPackage];
  doc.docContent = @"Welcome to iCloud Programming.";
  // Check to see if we are editing a currently opened note
  [doc saveToURL[doc fileURL] forSaveOperation:UIDocumentSaveForCreatingcompletionHandler:^(BOOL success) {
    if (success) {
      NSLog(@"Saved Successfully.");
    }
  }];</pre></div><p>We will be taking a more in depth look at how to create a sub-class of the <code class="literal">UIDocument</code> class when we start building our iCloud application to store and retrieve document content within the cloud.</p></div><div class="section" title="Storing key-value data in iCloud"><div class="titlepage"><div><div><h3 class="title"><a id="ch06lvl3sec09"/>Storing key-value data in iCloud</h3></div></div></div><p>Storing data within iCloud <a id="id564" class="indexterm"/>provides you with a means of making your applications <a id="id565" class="indexterm"/>share data between other copies of the application running on other Mac OS X computers and other iOS devices.</p><p>The following code snippet shows how to set up the cloud so that you are able to write data to the user's iCloud using the key-value approach:</p><div class="informalexample"><pre class="programlisting">  NSFileManager *fileManager = [NSFileManager defaultManager];
  NSURL *iCloudURL = [fileManager
  URLForUbiquityContainerIdentifier:
  @"TEAMID.com.yourcompany.applicationname"];
  // Log the iCloud URL to the console window
  NSLog(@"%@", [iCloudURL absoluteString]);
  // If iCloud is supported or enabled
  if(iCloudURL)
  {
    NSUbiquitousKeyValueStore *iCloudStore = 
    [NSUbiquitousKeyValueStore defaultStore];      
    [iCloudStore setString:@"Success" 
    forKey:@"iCloudStatus"];
    // For Synchronizing with iCloud Server
    [iCloudStore synchronize]; 
    // Retrieve our stored status from the iCloud Server
    NSLog(@"iCloud status : %@", [iCloudStore
    stringForKey:@"iCloudStatus"]);
}</pre></div><p>When your application uses the iCloud <code class="literal">key-value</code> data store approach, the user will never see this happening as your application will be using this to share very small amounts of information that is only used by your application. </p><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="note42"/>Note</h3><p>When using the <a id="id566" class="indexterm"/>
<code class="literal">NSUbiquitousKeyValueStore</code> class, you must ensure that you have ticked the <code class="literal">Key-Value Store</code> checkbox within your project preferences.</p></div></div><p>The amount of space available for a <code class="literal">single key-value store</code> is limited to 64 kilobytes and any data that is <a id="id567" class="indexterm"/>written to a single key-value within your container must not exceed 4 kilobytes in size. This is suitable for storing small amounts of data <a id="id568" class="indexterm"/>about your application, but it is not advisable to use it to store documents or large amounts of data.</p><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="note43"/>Note</h3><p>For more information about iCloud, refer to the Apple developer documentation at <a class="ulink" href="https://developer.apple.com/library/ios/#documentation/iPhone/Conceptual/iPhoneOSProgrammingGuide/iCloud/iCloud.html">https://developer.apple.com/library/ios/#documentation/iPhone/Conceptual/iPhoneOSProgrammingGuide/iCloud/iCloud.html</a><code class="literal">#//apple_ref/doc/uid/TP40007072-CH5-SW1</code>.</p></div></div></div></div><div class="section" title="How it works..."><div class="titlepage"><div><div><h2 class="title"><a id="ch06lvl2sec225"/>How it works...</h2></div></div></div><p>In this recipe, we learned about the different methods that can be used to store information within the iCloud. When working with document storage, we need to set up "a ubiq" (short for ubiquitous), variable to point to our current documents container within our iCloud account, and then use the <code class="literal">ubiquitousPackage</code> class, and then append our filename to the location of the iCloud documents container. We then initialize our <code class="literal">UIDocument</code> class document with some default contents, and then use the <code class="literal">UIDocumentSaveForCreating</code> property of our <code class="literal">forSaveOperation</code> method to create a brand new document.</p><p>Alternatively, when working with <code class="literal">key-value</code> data, you will need to use the <code class="literal">NSUbiquitousKeyValueStore</code> <a id="id569" class="indexterm"/>class that gives you the ability to share small amounts of data between each of your devices. We then use the <code class="literal">NSUserDefaults</code> <a id="id570" class="indexterm"/>class to programmatically interact with the system defaults, so that we can use the <a id="id571" class="indexterm"/>
<code class="literal">setString:</code> method to store the string <code class="literal">Success</code> for the <code class="literal">iCloudStatus</code> <a id="id572" class="indexterm"/>key determined by the <code class="literal">forKey:</code> <a id="id573" class="indexterm"/>method. Finally, we call the <code class="literal">synchronize</code> <a id="id574" class="indexterm"/>method to store the values that we specified back to the iCloud server, and then use the <code class="literal">stringForKey:</code> method <a id="id575" class="indexterm"/>and retrieve the value for our key <a id="id576" class="indexterm"/>and <a id="id577" class="indexterm"/>display this value to the console window.</p></div><div class="section" title="See also"><div class="titlepage"><div><div><h2 class="title"><a id="ch06lvl2sec226"/>See also</h2></div></div></div><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">The <span class="emphasis"><em>Building the iCloud application</em></span> recipe</li><li class="listitem" style="list-style-type: disc">The <span class="emphasis"><em>Storing and using documents within iCloud</em></span> recipe</li><li class="listitem" style="list-style-type: disc">The <span class="emphasis"><em>Requesting entitlements for iCloud storage</em></span> recipe</li></ul></div></div></div>
<div class="section" title="Detecting file version conflicts within iCloud"><div class="titlepage"><div><div><h1 class="title"><a id="ch06lvl1sec64"/>Detecting file version conflicts within iCloud</h1></div></div></div><p>In this recipe, we <a id="id578" class="indexterm"/>
<a id="id579" class="indexterm"/>
<a id="id580" class="indexterm"/>will take a look at how easy it is to implement and handle file version conflicts within your own applications.</p><div class="section" title="Getting ready"><div class="titlepage"><div><div><h2 class="title"><a id="ch06lvl2sec227"/>Getting ready</h2></div></div></div><p>Handling version conflicts of files is a common issue in software development. With iCloud, this needs to be handled effectively and efficiently when multiple instances of your applications are running on multiple devices, and both try to modify the same document. This will result in a conflict when both devices try to upload the changes made to the document at the same time. At this point, iCloud will end up with two different versions of the same file, and has to decide what to do with them.</p></div><div class="section" title="How to do it..."><div class="titlepage"><div><div><h2 class="title"><a id="ch06lvl2sec228"/>How to do it...</h2></div></div></div><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">In order to determine when a document file conflict has occurred, you will need to register an observer object to periodically check the <code class="literal">documentState</code> property for the <code class="literal">UIDocumentStateChangedNotification</code> notification object whenever changes have been made to the document to check for the presence of a conflict and act accordingly:<div class="informalexample"><pre class="programlisting">-(void)viewDidAppear:(BOOL)animated
{
  [super viewDidAppear:animated];
  // Add observer calls to monitor document state changes
  [[NSNotificationCenter defaultCenter] 
   addObserver:self
   selector:@selector(documentChanged:)
   name:UIDocumentStateChangedNotification
   object:self.document];
}</pre></div></li><li class="listitem">Next, we need to create the <a id="id581" class="indexterm"/><code class="literal">documentChanged:</code> method. This method runs as a notification handler and waits for the <code class="literal">UIDocumentStateChangedNotification</code> notification to occur in order to be able to check the <code class="literal">documentState</code> of the object when processing completes.<div class="informalexample"><pre class="programlisting">#pragma mark routine is called whenever a change to the document is encountered
- (void)documentChanged:(NSNotification *)notification {
   if ([notification.object documentState] &amp;
       UIDocumentStateInConflict) {
       NSURL *ubiq = [[NSFileManager defaultManager] 
       URLForUbiquityContainerIdentifier:nil];
     NSURL *ubiquitousPackage = [[ubiq 
       URLByAppendingPathComponent:@"Documents"]
       URLByAppendingPathComponent:@"/Snippet.doc"];
       SnippetDocument *doc = [[SnippetDocument alloc] 
       initWithFileURL:ubiquitousPackage];
      NSURL *documentURL = [doc fileURL];
      NSArray *conflictVersions = [NSFileVersion
       unresolvedConflictVersionsOfItemAtURL:documentURL];
      for (NSFileVersion *fileVersion in conflictVersions) {
      [fileVersion setResolved:YES];
     }
     [NSFileVersionremoveOtherVersionsOfItemAtURL:documentURL error:nil];
   }
}</pre></div></li></ol></div></div><div class="section" title="How it works..."><div class="titlepage"><div><div><h2 class="title"><a id="ch06lvl2sec229"/>How it works...</h2></div></div></div><p>In this recipe, we learned how to <a id="id582" class="indexterm"/>
<a id="id583" class="indexterm"/>
<a id="id584" class="indexterm"/>register and use a notification handler to notify us when changes in document state occur by the <code class="literal">UIDocumentStateChangedNotification</code> notification object.</p><p>We then use the <a id="id585" class="indexterm"/>
<code class="literal">URLForUbiquityContainerIdentifier</code> method of the <code class="literal">NSFileManager</code> object while passing through <code class="literal">nil</code> as an argument in order to default to the first container listed in the entitlements file. The recommended approach is that all documents are required to be stored within the <code class="literal">Documents</code> subdirectory and need to be appended to the URL path as well.</p><p>Finally, we use the <code class="literal">NSFileVersion</code> <a id="id586" class="indexterm"/>object to replace all unresolved versions of the document with the current document. Next, we enumerate through our array containing the <code class="literal">NSFileVersion</code> object representing the conflicted versions of the document and set the <code class="literal">resolved</code> property for each object to <code class="literal">YES</code> to remove all conflict versions associated with the document file.</p><p>The following table provides you with a <a id="id587" class="indexterm"/>
<a id="id588" class="indexterm"/>
<a id="id589" class="indexterm"/>description of the different document states:</p><div class="informaltable"><table border="1"><colgroup><col style="text-align: left"/><col style="text-align: left"/></colgroup><thead><tr><th style="text-align: left" valign="bottom">
<p>Document state</p>
</th><th style="text-align: left" valign="bottom">
<p>Description</p>
</th></tr></thead><tbody><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">UIDocumentStateNormal</code>
</p>
</td><td style="text-align: left" valign="top">
<p>Indicated <a id="id590" class="indexterm"/>
<a id="id591" class="indexterm"/>that the document is open and enabled for user editing.</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">UIDocumentStateClosed</code>
</p>
</td><td style="text-align: left" valign="top">
<p>Indicates that the <a id="id592" class="indexterm"/>
<a id="id593" class="indexterm"/>document is currently closed, or an error occurred while reading of the document.</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">UIDocumentStateConflict</code>
</p>
</td><td style="text-align: left" valign="top">
<p>Indicates that conflicts <a id="id594" class="indexterm"/>
<a id="id595" class="indexterm"/>have been detected for the current document.</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">UIDocumentStateSavingError</code>
</p>
</td><td style="text-align: left" valign="top">
<p>Indicates that an error <a id="id596" class="indexterm"/>
<a id="id597" class="indexterm"/>occurred during an attempt to save the document.</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">UIDocumentStateEditingDisabled</code>
</p>
</td><td style="text-align: left" valign="top">
<p>Indicates that the <a id="id598" class="indexterm"/>
<a id="id599" class="indexterm"/>document is busy, and is not currently safe for editing.</p>
</td></tr></tbody></table></div><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="note44"/>Note</h3><p>For more information on the <code class="literal">UIDocumentStateChangedNotification </code>framework, refer to the Apple developer documentation located at the following URL:</p><p>
<a class="ulink" href="https://developer.apple.com/library/ios/#documentation/DataManagement/Conceptual/DocumentBasedAppPGiOS/Introduction/Introduction.html">https://developer.apple.com/library/ios/#documentation/DataManagement/Conceptual/DocumentBasedAppPGiOS/Introduction/Introduction.html</a>
</p></div></div></div><div class="section" title="See also"><div class="titlepage"><div><div><h2 class="title"><a id="ch06lvl2sec230"/>See also</h2></div></div></div><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">The <span class="emphasis"><em>Working with the iCloud storage APIs</em></span> recipe</li><li class="listitem" style="list-style-type: disc">The <span class="emphasis"><em>Detecting file version conflicts within iCloud</em></span> recipe</li></ul></div></div></div>
<div class="section" title="Building the iCloud application"><div class="titlepage"><div><div><h1 class="title"><a id="ch06lvl1sec65"/>Building the iCloud application</h1></div></div></div><p>In this recipe, we will learn <a id="id600" class="indexterm"/>how to build an iCloud-aware application using the iCloud storage APIs.</p><div class="section" title="Getting ready"><div class="titlepage"><div><div><h2 class="title"><a id="ch06lvl2sec231"/>Getting ready</h2></div></div></div><p>In this section, we will learn how to create an application that will enable us to create new documents within our iCloud repository. To begin, follow the following simple steps as outlined:</p></div><div class="section" title="How to do it..."><div class="titlepage"><div><div><h2 class="title"><a id="ch06lvl2sec232"/>How to do it...</h2></div></div></div><p>To begin, follow these simple steps as outlined in the following order:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Launch Xcode from the <code class="literal">/Xcode4/Applications</code> folder.</li><li class="listitem">Choose <span class="strong"><strong>Create a new Xcode project</strong></span>, or navigate to <span class="strong"><strong>File</strong></span> | <span class="strong"><strong>New Project</strong></span>.</li><li class="listitem">Select the <span class="strong"><strong>Single View Application</strong></span> option from the list of available templates.</li><li class="listitem">Click on the <span class="strong"><strong>Next</strong></span> button to proceed to the next step in the wizard.</li><li class="listitem">Next, enter in <code class="literal">iCloudExample</code><span class="strong"><strong> </strong></span>as the name for your project.</li><li class="listitem">Choose <span class="strong"><strong>iPhone</strong></span> from under the <span class="strong"><strong>Devices</strong></span> drop-down list.</li><li class="listitem">Ensure that the <span class="strong"><strong>Use Storyboards</strong></span> checkbox has not been selected.</li><li class="listitem">Ensure that the <span class="strong"><strong>Use Automatic Reference Counting</strong></span> checkbox is selected.</li><li class="listitem">Ensure that the <span class="strong"><strong>Include Unit Tests</strong></span> checkbox has not been ticked.</li><li class="listitem">Click on the <span class="strong"><strong>Next</strong></span> button to proceed to the next step in the wizard.</li><li class="listitem">Specify the location where you would like to save your project.</li><li class="listitem">Then, click on the <span class="strong"><strong>Create</strong></span> button to continue and display the Xcode workspace.<p>Now that we have created our <code class="literal">iCloudExample</code> project, we can start building our user interface that will allow us to create and modify documents and then having these saved back to iCloud.</p></li><li class="listitem">Select the <code class="literal">ViewController.xib</code> file from the <span class="strong"><strong>Project Navigator</strong></span> window.</li><li class="listitem">From the <span class="strong"><strong>Object Library</strong></span> window, select-and-drag a toolbar, add this to the top of the view.</li><li class="listitem">Select the <span class="strong"><strong>Item</strong></span> button located within our toolbar that we previously added.</li><li class="listitem">From the <span class="strong"><strong>Attributes Inspector</strong></span> section, change the value of the <span class="strong"><strong>Identifier</strong></span> property to <span class="strong"><strong>Save</strong></span> and change the value of the <span class="strong"><strong>Style</strong></span> property to <span class="strong"><strong>Bordered.</strong></span> </li><li class="listitem">From the <span class="strong"><strong>Object Library</strong></span>, select and drag a <code class="literal">Bar Button Item </code>object, and add this next to the <span class="strong"><strong>Save</strong></span> button that we added previously.</li><li class="listitem">From the <span class="strong"><strong>Attributes Inspector</strong></span> section, change the value of the <span class="strong"><strong>Identifier</strong></span> property to <span class="strong"><strong>Custom</strong></span> and change the value of the <span class="strong"><strong>Title</strong></span> property to <span class="strong"><strong>Load</strong></span>.</li><li class="listitem">Finally, from the <span class="strong"><strong>Object Library</strong></span>, select and drag a <code class="literal">Text View </code>object to the center of our view controller, and adjust the size so that it fills the entire area of the screen.<p>The following screenshot shows the completed user interface with the added toolbar, buttons, <a id="id601" class="indexterm"/>and the <code class="literal">Text View</code> control.</p><div class="mediaobject"><img src="graphics/3349OT_06_03.jpg" alt="How to do it..."/></div><p>Our next step is to create the outlet and property events for each of our buttons, as well as the <code class="literal">Text View</code> control. Creating these will allow us to access the associated methods and control properties directly within our code. To create an outlet, follow these simple steps:</p></li><li class="listitem">Open the <span class="strong"><strong>Assistant Editor</strong></span> page by navigating to <span class="strong"><strong>Navigate</strong></span> | <span class="strong"><strong>Open in Assistant Editor</strong></span>, or by pressing the <span class="emphasis"><em>option</em></span> + <span class="emphasis"><em>command</em></span> + keys.</li><li class="listitem">Ensure that the <code class="literal">ViewController.h</code> interface file is displayed within the <span class="strong"><strong>Assistant Editor</strong></span> window.</li><li class="listitem">Select the <span class="strong"><strong>Save</strong></span> (<code class="literal">Bar Button Item</code>) control, then hold down the <span class="emphasis"><em>Control</em></span> key, and drag it into the <code class="literal">ViewController.h</code> interface file.</li><li class="listitem">Choose <span class="strong"><strong>Outlet</strong></span> from the <span class="strong"><strong>Connection</strong></span> dropdown for the connection to be created.</li><li class="listitem">Enter in <code class="literal">btnSave</code> for the name of the <span class="strong"><strong>Outlet</strong></span> property to create.</li><li class="listitem">Choose <span class="strong"><strong>strong</strong></span> from the <span class="strong"><strong>Storage</strong></span> drop-down menu.</li><li class="listitem">Repeat steps 3 to 6 to create the outlet properties for the <span class="strong"><strong>Load</strong></span> bar button item and the <span class="strong"><strong>Text View</strong></span> control, <a id="id602" class="indexterm"/>while providing the following naming <code class="literal">btnLoad </code>and <code class="literal">docContents</code>.<p>Now that we have created the instance variable outlets for our controls, we need to create the associated actions for the <span class="strong"><strong>Save</strong></span> button. Creating these actions allows an event to be fired when the button is pressed. To create an action, follow these simple steps:</p></li><li class="listitem">With the <code class="literal">ViewController.h</code> interface file still displayed within the <span class="strong"><strong>Assistant Editor</strong></span> window, select the <span class="strong"><strong>Save</strong></span> (<code class="literal">Bar Button Item</code>) control, and hold down the <span class="emphasis"><em>control</em></span> key and drag it into the <code class="literal">ViewController.h</code> interface file.</li><li class="listitem">Choose <span class="strong"><strong>Action</strong></span> from the <span class="strong"><strong>Connection</strong></span> drop-down list for the connection to be created.</li><li class="listitem">Enter in <code class="literal">btnSave</code> for the <span class="strong"><strong>Name</strong></span> value of the method to be created.</li><li class="listitem">Repeat steps 1 to 3 to create the outlet properties for the <span class="strong"><strong>Load</strong></span> and <span class="strong"><strong>Text View</strong></span> controls, while providing the following naming <code class="literal">btnLoad</code> and <code class="literal">docContents</code>.<p>The following code snippet shows the completed <code class="literal">ViewController.h</code> interface file:</p><div class="informalexample"><pre class="programlisting">//  ViewController.h
//  iCloudExample
//  Created by Steven F Daniel on 8/11/12.
//  Copyright (c) 2012 GenieSoft Studios. All rights reserved.
#import &lt;UIKit/UIKit.h&gt;
@interface ViewController : UIViewController
// Declare the properties for each of our objects.
@property (strong,nonatomic) IBOutlet UIBarButtonItem *btnSave;
@property (strong,nonatomic) IBOutlet UIBarButtonItem *btnLoad;
@property (strong,nonatomic) IBOutlet UITextView      *docContents;
@end</pre></div><p>Our next step is to use the <code class="literal">UIDocument</code> class that comes with iOS 5 to make it much easier for us to work with iCloud documents. This class acts as the middleware between the file and the actual data that it contains, and implements the <code class="literal">NSFilePresenter</code> protocol to handle the entire document processing in the background, so that the application is not blocked when files <a id="id603" class="indexterm"/>are opened or saved.</p></li><li class="listitem">From the <span class="strong"><strong>Xcode</strong></span> menu bar, navigate to <span class="strong"><strong>File</strong></span> | <span class="strong"><strong>New</strong></span> | <span class="strong"><strong>File...</strong></span> or press <span class="emphasis"><em>Command</em></span> + <span class="emphasis"><em>N</em></span>.</li><li class="listitem">Select the <span class="strong"><strong>Objective-C class</strong></span> template from the list of templates.</li><li class="listitem">Click on the <span class="strong"><strong>Next</strong></span> button to proceed to the next step within the wizard.</li><li class="listitem">Enter in <code class="literal">Snippet</code> as the name of the file to be created.</li><li class="listitem">Ensure that you have selected <code class="literal">UIDocument</code> as the type to create from the <span class="strong"><strong>Subclass of</strong></span> dropdown.<div class="mediaobject"><img src="graphics/3349OT_06_04.jpg" alt="How to do it..."/></div><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="note45"/>Note</h3><p>If you don't see the <code class="literal">UIDocument</code> class shown within your drop-down list, simply type it in manually.</p></div></div></li><li class="listitem">Click on the <span class="strong"><strong>Next</strong></span> button to proceed with the next step of the wizard.</li><li class="listitem">Click on the <span class="strong"><strong>Create</strong></span> <a id="id604" class="indexterm"/>button to save the file to the folder location specified.</li><li class="listitem">Open the <code class="literal">Snippet.h</code> interface file, located within the <code class="literal">iCloudExample</code> folder and enter in the following code snippet:<div class="informalexample"><pre class="programlisting">//  Snippet.h
//  iCloudExample
//  Created by Steven Daniel on 08/11/12.
//  Copyright (c) 2012 GenieSoft Studios. All rights reserved.
#import &lt;UIKit/UIKit.h&gt;
@interface Snippet : UIDocument
@property (nonatomic, strong) NSString  *docContent;
@end</pre></div></li><li class="listitem">Open the <code class="literal">Snippet.m</code> implementation file, located within the <code class="literal">iCloudExample</code> folder, and enter in the following code snippet:<div class="informalexample"><pre class="programlisting">//  Snippet.m
//  iCloudExample
//  Created by Steven Daniel on 08/11/12.
//  Copyright (c) 2012 GenieSoft Studios. All rights reserved.
#import "Snippet.h"

@implementation Snippet

@synthesize docContent;

// Called whenever the application reads data from the file.

- (BOOL)loadFromContents:(id)contents ofType:(NSString *)typeName error:(NSError **)outError{
  // Initialize our document content
  self.docContent = @"";
  // Check to see if any text associated for the document.
  if ([contents length] &gt; 0) {
      self.docContent = [[NSString alloc] 
                        initWithBytes:[contents bytes] 
                        length:[contents length] 
                        encoding:NSUTF8StringEncoding];
  }
  return YES;    
}
// Called whenever the application saves the content.
- (id)contentsForType:(NSString *)typeName error:(NSError **)outError {
    // Ensure we have content to save for our document.
    if ([self.docContent length] == 0) {
         self.docContent = @"";
    }
    // Save the document contents and return back the data.
    return [NSData dataWithBytes:[self.docContent UTF8String] 
           length:[self.docContent length]];    
}
@end</pre></div><p>Now that we have <a id="id605" class="indexterm"/>finished created our <code class="literal">UIDocument</code> subclass, we can start to implement the methods that will be responsible for saving our content to the Cloud.</p></li><li class="listitem">Modify the <code class="literal">ViewController.h</code> interface file located within the <code class="literal">iCloudExample</code> folder; enter in the following highlighted code sections as shown in the snippet:<div class="informalexample"><pre class="programlisting">//  ViewController.h
//  iCloudExample
//  Created by Steven F Daniel on 8/11/12.
//  Copyright (c) 2012 GenieSoft Studios. All rights reserved.
#import  &lt;UIKit/UIKit.h&gt;
<span class="strong"><strong>#import "Snippet.h"</strong></span>
@interface ViewController : UIViewController
// Declare the Getters and Setters for each of our objects.
@property (strong,nonatomic) IBOutlet UIBarButtonItem *btnSave;
@property (strong,nonatomic) IBOutlet UIBarButtonItem *btnLoad;
@property (strong,nonatomic) IBOutlet UITextView      *docContents;
<span class="strong"><strong>@property (strong, nonatomic) Snippet         *document;</strong></span>
<span class="strong"><strong>@property (strong, nonatomic) NSMetadataQuery *docQuery;</strong></span>
@end</pre></div></li><li class="listitem">Modify the <code class="literal">ViewController.m</code> implementation file located within the <code class="literal">iCloudExample</code> folder and add <a id="id606" class="indexterm"/>the following <code class="literal">synthesize</code> methods:<div class="informalexample"><pre class="programlisting">//  ViewController.m
//  iCloudExample
//  Created by Steven F Daniel on 8/11/12.
//  Copyright (c) 2012 GenieSoft Studios. All rights reserved.
#import "ViewController.h"

@interface ViewController()
@end

@implementation ViewController

<span class="strong"><strong>@synthesize document;</strong></span>
<span class="strong"><strong>@synthesize docQuery;</strong></span>
<span class="strong"><strong>@synthesize docContents = m_docContents;</strong></span>
<span class="strong"><strong>@synthesize btnSave = m_btnSave;</strong></span>
<span class="strong"><strong>@synthesize btnLoad = m_btnLoad;</strong></span>
</pre></div></li><li class="listitem">Next, modify the <a id="id607" class="indexterm"/><code class="literal">ViewDidLoad</code> method as shown in the following code snippet:<div class="informalexample"><pre class="programlisting">- (void)viewDidLoad
{
    [super viewDidLoad];
  // Do any additional setup after loading the view.
  NSURL *ubiq = [[NSFileManager defaultManager] 
   URLForUbiquityContainerIdentifier:nil];
  if (!ubiq) {
    NSLog(@"iCloud not currently available");
    self.btnSave.enabled = NO;
    self.btnLoad.enabled = NO;
  }
  // Set the background color and font attributes for our note.
   UIFont * font = [UIFont fontWithName:@"Helvetica-Bold" 
                   size:[UIFont systemFontSize]];
   [self.docContents setFont:font];
   [self.docContents setBackgroundColor:[UIColor
             colorWithRed:1.0f green:1.0f blue:0.6f alpha:1.0f]];
   // Initialize control and button attributes
  [self btnLoad:nil];
}</pre></div></li><li class="listitem">Next, modify the <code class="literal">viewDidUnload</code> <a id="id608" class="indexterm"/>method as shown by the highlighted code sections in the following code snippet:<div class="informalexample"><pre class="programlisting">- (void)viewDidUnload
{
    [super viewDidUnload];
  
    // Release any retained subviews of the main view.
    self.btnSave = nil;
    self.btnLoad = nil;
  
  // Turn off our notifications
<span class="strong"><strong>  [docQuery disableUpdates];</strong></span>
<span class="strong"><strong>  [[NSNotificationCenter defaultCenter] </strong></span>
<span class="strong"><strong>     removeObserver:self];</strong></span>
}</pre></div></li><li class="listitem">Next, modify the <code class="literal">viewDidAppear</code> method as shown by the highlighted code sections in the following code snippet:<div class="informalexample"><pre class="programlisting">-(void)viewDidAppear:(BOOL)animated
{
  [super viewDidAppear:animated];
  
  // Add observer calls to monitor document and 
   // document state changes
<span class="strong"><strong>  [[NSNotificationCenter defaultCenter] addObserver:self</strong></span>
<span class="strong"><strong>     selector:@selector(documentChanged:)</strong></span>
<span class="strong"><strong>     name:UIDocumentStateChangedNotification</strong></span>
<span class="strong"><strong>     object:self.document];</strong></span>
}</pre></div><p>Next, we need to implement the method that will be responsible for saving the document to the iCloud when the user presses the <span class="strong"><strong>Save</strong></span> button.</p></li><li class="listitem">Open the <code class="literal">viewController.m</code> <a id="id609" class="indexterm"/>implementation file, locate the <code class="literal">btnSave</code> method, and enter in the following code snippet:<div class="informalexample"><pre class="programlisting">#pragma mark Saves the document to our iCloud repository
- (IBAction)btnSave:(UIBarButtonItem *)sender {
  // Points to our iCloud Documents container.
  NSURL *ubiq = [[NSFileManager defaultManager] 
                   URLForUbiquityContainerIdentifier:nil];
  NSURL *ubiquitousPackage = [[ubiq
   URLByAppendingPathComponent:@"Documents"]
  URLByAppendingPathComponent:@"/Snippet.doc"];
   Snippet *doc = [[Snippet alloc] 
   initWithFileURL:ubiquitousPackage];
   doc.docContent = self.docContents.text;
   // Check to see if we are editing a currently opened note
  [doc saveToURL:[doc fileURL] 
         forSaveOperation:UIDocumentSaveForCreating
         completionHandler:^(BOOL success) {
            if (success) {
               NSLog(@"Document saved successfully");
            }
  }];
}</pre></div></li><li class="listitem">Next, locate the <code class="literal">btnLoad</code> method, and enter in the following code snippet:<div class="informalexample"><pre class="programlisting">#pragma mark Reloads our document from cloud Storage
- (IBAction)btnLoad:(UIBarButtonItem *)sender {
  NSURL *ubiq = [[NSFileManager defaultManager] 
   URLForUbiquityContainerIdentifier:nil];
  if (ubiq) {
    docQuery = [[NSMetadataQuery alloc] init];
    [docQuerysetSearchScopes:[NSArray
      arrayWithObject:NSMetadataQueryUbiquitousDocumentsScope]];
    NSPredicate *pred = [NSPredicate
          predicateWithFormat: @"%K Like 'Snippet.doc'", 
               NSMetadataItemFSNameKey];
    [docQuerysetPredicate:pred];
    NSNotificationCenter *center = [NSNotificationCenter
      defaultCenter];
      [center addObserver:self selector:@selector(processQuery:)
      name:NSMetadataQueryDidFinishGatheringNotification
    object:docQuery];
    [center addObserver:self selector:@selector(processQuery:)	
      name:NSMetadataQueryDidUpdateNotification
   object:docQuery];
    if (![self.docQuery isStarted]) [self.docQuery startQuery];
    [self.docQuery enableUpdates];
    }
  else {
    self.btnSave.enabled = NO;
    self.btnLoad.enabled = NO;
   }
}</pre></div></li><li class="listitem">Next, create the <code class="literal">processQuery:</code> method <a id="id610" class="indexterm"/>as shown in the following code snippet:<div class="informalexample"><pre class="programlisting">#pragma mark Retrieve the contents of our document stored within iCloud and update our UITextView Control
- (void)processQuery:(NSNotification *)notification {

  [docQuery disableUpdates];

   if ([[docQuery results] count] == 1) {
     NSURL *url = [[[docQuery results] objectAtIndex:0] 
       valueForAttribute:NSMetadataItemURLKey];
       Snippet *contents = [[Snippet alloc] initWithFileURL:url];
       [contentsopenWithCompletionHandler:^(BOOL success) {
             if (success) {
               [self.docContents setText:contents.docContent];
             }
       }];
  }
  [docQuery enableUpdates];
}</pre></div></li><li class="listitem">Next, finally, create the <a id="id611" class="indexterm"/><code class="literal">documentChanged:</code> method as shown in the following code snippet:<div class="informalexample"><pre class="programlisting">#pragma mark routine is called whenever a change to the document is encountered
- (void)documentChanged:(NSNotification *)notification {
  if ([notification.object documentState] &amp;
        UIDocumentStateInConflict) {
    // Wait to find out what user wants first
    UIAlertView *alertView = [[UIAlertView alloc]
      initWithTitle:@"Conflict Detected"		
         message:@"Document modified on another iOS device."
      delegate:self
      cancelButtonTitle:nil
      otherButtonTitles:@"OK", nil];
      [alertView show];
    // Point to our iCloud Documents container.
    NSURL *documentURL = [notification.objectfileURL];
    NSArray *conflictVersions = [NSFileVersion
      unresolvedConflictVersionsOfItemAtURL:documentURL];
    for (NSFileVersion *fileVersion in conflictVersions) {
      [fileVersion setResolved:YES];
    }
    [NSFileVersion
      removeOtherVersionsOfItemAtURL:documentURL error:nil];
    // Trigger an Auto-Save and re-enable our Query Updates
    [document updateChangeCount:UIDocumentChangeDone];
  }
}</pre></div></li><li class="listitem">Then, Build and Run the <a id="id612" class="indexterm"/>application by choosing <span class="strong"><strong>Product | Run</strong></span> from the <span class="strong"><strong>Product</strong></span> menu, or alternatively pressing <span class="emphasis"><em>Command + R</em></span>.<div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="note46"/>Note</h3><p>For more information about the <code class="literal">NSMetadataQuery </code>object, refer to the following link:</p><p>
<a class="ulink" href="http://developer.apple.com/library/ios/#documentation/Cocoa/Reference/Foundation/Classes/NSMetadataQuery_Class/Reference/Reference.html">http://developer.apple.com/library/ios/#documentation/Cocoa/Reference/Foundation/Classes/NSMetadataQuery_Class/Reference/Reference.html</a>
</p></div></div></li></ol></div><p>The following screenshot shows our <code class="literal">iCloudExample</code> application running on two different iOS devices. When a change is made on the second device, and then the <span class="strong"><strong>Save</strong></span> button is pressed, the iCloud daemon service detects this change. The first device displays an <code class="literal">alertview</code> dialog notifying that the document has been modified on another device.</p><div class="mediaobject"><img src="graphics/3349OT_06_05.jpg" alt="How to do it..."/></div><p>The following screenshot shows our snippet document existing within our application's container within iCloud:</p><div class="mediaobject"><img src="graphics/3349OT_06_06.jpg" alt="How to do it..."/></div><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="note47"/>Note</h3><p>The previous screen can be accessed using the <span class="strong"><strong>Settings</strong></span> application and then navigating to <span class="strong"><strong>Settings</strong></span> | <span class="strong"><strong>iCloud</strong></span> | <span class="strong"><strong>Storage &amp; Backup</strong></span> | <span class="strong"><strong>Manage Storage</strong></span>.</p></div></div></div><div class="section" title="How it works..."><div class="titlepage"><div><div><h2 class="title"><a id="ch06lvl2sec233"/>How it works...</h2></div></div></div><p>In this recipe, we learned how to build and create the user interface for our <code class="literal">iCloudExample</code> application to store and <a id="id613" class="indexterm"/>retrieve documents within iCloud. We then created the outlet properties for each of our buttons to have the ability of saving and loading the document when pressed. In our next step, we create a <code class="literal">UIDocument</code> <a id="id614" class="indexterm"/>subclass and declare an <code class="literal">NSString</code> property variable <code class="literal">docContent</code> that will be used to store the contents of our document when it gets created or modified. We then proceed to synthesize our document content property so that our class can access those objects associated with it. We then proceed to override the <code class="literal">loadFromContents:</code> method <a id="id615" class="indexterm"/>to read the data from the file into our <code class="literal">UIDocument</code> subclass. The most important parameter to note here is contents; this is an <code class="literal">NSData</code> object containing the actual data that was entered when you created or updated your document model. </p><p>The background queue <code class="literal">NSFilePresenter</code> calls this method whenever a read operation has completed. If the document was saved without entering any data, we assign a default value of empty string. We then proceed to override the <a id="id616" class="indexterm"/>
<code class="literal">contentsForType:</code> method that is used when the background queue of the <code class="literal">NSFilePresenter</code> requests a snapshot of the contents of the <a id="id617" class="indexterm"/>
<code class="literal">UIDocument</code> subclass. Here we check to ensure that the document contains contents, and if so, we convert our documents data to an <code class="literal">NSData</code> object, and return this as an <code class="literal">NSData</code> instance. Next, we declare our <code class="literal">Snippet</code> object that will be used to hold the document that <a id="id618" class="indexterm"/>gets created, as well as our <code class="literal">NSMetadataQuery</code> object that will be used to query and look up the document within our application's iCloud repository and access the relevant object properties of each file. In our next steps, we first check to ensure that we can access our application's iCloud repository, and then proceed to set the background color and font name and size for our <code class="literal">docContents</code> control, before finally calling the <code class="literal">reload:</code> method to pull the document from our iCloud repository.</p><p>We then proceed to register an observer object to enable us to periodically check for changes in document state using the <code class="literal">UIDocumentStateChangedNotification</code> notification object. Next, we declare our <code class="literal">btnSave:</code> method and set up an <code class="literal">ubiq</code> variable to point to our document container within our iCloud account. We then use the <code class="literal">ubiquitousPackage</code> class, and then append our filename to the location of the iCloud documents container. We then initialize our <code class="literal">UIDocument</code> class document with some default contents and then use the <a id="id619" class="indexterm"/>
<code class="literal">UIDocumentSaveForCreating</code> property of our <a id="id620" class="indexterm"/>
<code class="literal">forSaveOperation</code> method to create a brand new document.</p><p>For the <code class="literal">btnLoad:</code> method, we start by ensuring that we can connect it to the iCloud data store, and then set up and initialize our <code class="literal">docQuery</code> query predicate to look for our document using the predicate class method <code class="literal">NSMetadataQueryUbiquitousDocumentScope</code> and then set up an observer <code class="literal">queryDidFinishGathering</code> notification that gets called when the metadata search finishes gathering all items. Next, in our <a id="id621" class="indexterm"/>
<code class="literal">processQuery:</code> method, we grab our document item from our results query and write the contents of the extracted document to our <a id="id622" class="indexterm"/>
<code class="literal">docContent</code> object. Finally, in our <code class="literal">documentChanged:</code> method, we use the <a id="id623" class="indexterm"/>
<code class="literal">documentState</code> property of our notification object to determine if any file conflicts have been detected, and if so, we display an alert message using the <code class="literal">UIAlertView</code> <a id="id624" class="indexterm"/>class; we then point to our iCloud documents container to bring back the URL of the file and we use the <a id="id625" class="indexterm"/>
<code class="literal">NSFileVersion</code> object to replace all unresolved versions of the document with the current document and then enumerate through our array containing the <code class="literal">NSFileVersion</code> object representing all conflicted versions of the document and then set the <code class="literal">resolved</code> property for each object to <code class="literal">YES</code> and remove all conflict versions associated with the document file URL.</p></div><div class="section" title="See also"><div class="titlepage"><div><div><h2 class="title"><a id="ch06lvl2sec234"/>See also</h2></div></div></div><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">The <span class="emphasis"><em>Requesting entitlements for iCloud storage</em></span> recipe</li><li class="listitem" style="list-style-type: disc">The <span class="emphasis"><em>Storing and using documents within iCloud</em></span> recipe</li><li class="listitem" style="list-style-type: disc">The <span class="emphasis"><em>Working with the iCloud storage APIs</em></span> recipe</li></ul></div></div></div>
<div class="section" title="Requesting entitlements for iCloud storage"><div class="titlepage"><div><div><h1 class="title"><a id="ch06lvl1sec66"/>Requesting entitlements for iCloud storage</h1></div></div></div><p>In this recipe, we will take a <a id="id626" class="indexterm"/>look at how easy it is to add and configure <a id="id627" class="indexterm"/>entitlements using Xcode to enable your applications to communicate with the iCloud service.</p><div class="section" title="Getting ready"><div class="titlepage"><div><div><h2 class="title"><a id="ch06lvl2sec235"/>Getting ready</h2></div></div></div><p>In order to protect the data your application creates, a number of specific entitlements need to be created at build-time, in order to use iCloud storage. You will need to ensure that you have selected the option to enable iCloud for your application's app ID.</p></div><div class="section" title="How to do it..."><div class="titlepage"><div><div><h2 class="title"><a id="ch06lvl2sec236"/>How to do it...</h2></div></div></div><p>Before your application can communicate with the iCloud service, you will need to create a new app ID from within the iOS provisioning portal, which can be located at <a class="ulink" href="https://developer.apple.com/ios/manage/bundles/index.action/">https://developer.apple.com/ios/manage/bundles/index.action/</a>.</p><p>If you are using an existing app ID, this cannot consist of a wild card ID, and must contain the full name of the application that you will be creating, for example, <code class="literal">com.yourcompany.*</code>.To enable your app ID to communicate with the iCloud service, follow the following simple steps:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Create a <code class="literal">new App ID</code> value or edit the one that you have created previously.</li><li class="listitem">Set up your provisioning profile for use with iCloud, by simply checking the <span class="strong"><strong>Enable for iCloud</strong></span> checkbox from the <span class="strong"><strong>Configure App ID</strong></span> screen:<div class="mediaobject"><img src="graphics/3349OT_06_07.jpg" alt="How to do it..."/></div></li><li class="listitem">Next, you will be presented with a pop-up dialog box, explaining that any new provisioning profiles <a id="id628" class="indexterm"/>that you create using the <a id="id629" class="indexterm"/>chosen App ID will be enabled for iCloud services:<div class="mediaobject"><img src="graphics/3349OT_06_08.jpg" alt="How to do it..."/></div></li><li class="listitem">Once you have clicked on the <span class="strong"><strong>OK</strong></span> button, you will be returned back to the <span class="strong"><strong>Configure App ID</strong></span> screen, and the <span class="strong"><strong>Enable for iCloud</strong></span> button will be set to green, as shown in the following screenshot:<div class="mediaobject"><img src="graphics/3349OT_06_09.jpg" alt="How to do it..."/></div></li><li class="listitem">Click on the <span class="strong"><strong>Done</strong></span> button to close this screen.</li><li class="listitem">Next, click on the <span class="strong"><strong>Provisioning</strong></span> <a id="id630" class="indexterm"/>tab, and then click on the <span class="strong"><strong>Development</strong></span> tab to download your <span class="strong"><strong>Development Provisioning </strong></span><a id="id631" class="indexterm"/><span class="strong"><strong>Profiles</strong></span> as shown in the following screenshot:<div class="mediaobject"><img src="graphics/3349OT_06_10.jpg" alt="How to do it..."/></div></li><li class="listitem">Next, from the <span class="strong"><strong>Provisioning</strong></span> tab, and click on the <span class="strong"><strong>Distribution</strong></span> tab to download <span class="strong"><strong>Distribution Provisioning Profiles</strong></span> as shown in the following screenshot:<div class="mediaobject"><img src="graphics/3349OT_06_11.jpg" alt="How to do it..."/></div></li><li class="listitem">Next, from the <span class="strong"><strong>Project Navigator</strong></span> window, click on your project, in the <span class="strong"><strong>Targets</strong></span> section, and then on the <span class="strong"><strong>Summary</strong></span> page and scroll down till you get to the <span class="strong"><strong>Entitlements</strong></span> section.</li><li class="listitem">Check the <span class="strong"><strong>Enable Entitlements</strong></span> and the <span class="strong"><strong>Enabled iCloud</strong></span> checkboxes. This will add a file called <code class="literal">iCloudExample.entitlements</code> to your project.<div class="mediaobject"><img src="graphics/3349OT_06_12.jpg" alt="How to do it..."/></div></li><li class="listitem">Next, click on the <span class="strong"><strong>+</strong></span> button to autofill the <span class="strong"><strong>Ubiquity Containers</strong></span> and <span class="strong"><strong>Keychain Groups</strong></span> sections.<div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="note48"/>Note</h3><p>Whenever you add entitlements to your projects, these are bound directly to your application's provisioning profiles that are used to separate your application's documents and data <a id="id632" class="indexterm"/>repositories from that of other applications that you create. </p></div></div></li></ol></div><p>There are two entitlements that an <a id="id633" class="indexterm"/>application can request, depending on which iCloud features it is required to use. These are explained in the following table:</p><div class="informaltable"><table border="1"><colgroup><col style="text-align: left"/><col style="text-align: left"/></colgroup><thead><tr><th style="text-align: left" valign="bottom">
<p>Entitlement</p>
</th><th style="text-align: left" valign="bottom">
<p>Description</p>
</th></tr></thead><tbody><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">com.apple.developer.ubiquity-container-identifiers</code>
</p>
</td><td style="text-align: left" valign="top">
<p>Use this to <a id="id634" class="indexterm"/>
<a id="id635" class="indexterm"/>request the iCloud document storage entitlement.</p>
<p>The value of this key is an array of container-identifier strings. (The first string in the array must not contain any wildcard characters.)</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">com.apple.developer.ubiquity-kvstore-identifier</code>
</p>
</td><td style="text-align: left" valign="top">
<p>Use this to <a id="id636" class="indexterm"/>
<a id="id637" class="indexterm"/>request the iCloud key-value data store entitlement. The value of this key is a single container identifier string.</p>
</td></tr></tbody></table></div><p>When working with the <code class="literal">Key-Value</code> store data, you will need to <a id="id638" class="indexterm"/>ensure that the <span class="strong"><strong>Use Store with Identifier</strong></span> option has been ticked. This must be consistent and take on the form <code class="literal">&lt;TEAMID&gt;.&lt;CUSTOM_STRING&gt;</code>, where <code class="literal">&lt;TEAMID&gt;</code> is the unique 10 character identifier that is associated with your development team. The <code class="literal">&lt;CUSTOM_STRING&gt;</code> identifier is the reverse DNS string that identifies the container for storing your applications documents.</p><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="note49"/>Note</h3><p>To locate your unique identifier associated with your development team, log in to the Apple developer connection website, and then go to the <span class="strong"><strong>Member Center</strong></span> page which can be found at <a class="ulink" href="http://developer.apple.com/membercenter">http://developer.apple.com/membercenter</a>.</p><p>Select the <span class="strong"><strong>Your Account</strong></span> tab, and then select <span class="strong"><strong>Organization Profile</strong></span> (if you have set up your profile to be used as an organization) from the column on the left of the tab. Your team's identifier is in the <span class="strong"><strong>Company / Organization ID </strong></span>field.</p></div></div><p>Applications using iCloud document <a id="id639" class="indexterm"/>storage can <a id="id640" class="indexterm"/>specify multiple containers for storing documents and data. The <code class="literal">com.apple.developer.ubiquity-container-identifiers</code> key is an array of strings.</p><p>The following screenshot displays the property list view within the project navigator of the <code class="literal">iCloudExample.Entitlements</code> entitlements file:</p><div class="mediaobject"><img src="graphics/3349OT_06_13.jpg" alt="How to do it..."/></div><p>The <code class="literal">TEAMID</code> value (as shown in the previous screenshot), can be obtained from the <code class="literal">Account Summary</code> page of your developer account, and using the <code class="literal">Individual ID</code> value, as shown in the following screenshot:</p><div class="mediaobject"><img src="graphics/3349OT_06_14.jpg" alt="How to do it..."/></div><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="note50"/>Note</h3><p>The strings specified in your entitlements file are also the strings you pass to the <code class="literal">URLForUbiquityContainerIdentifier:</code> method, when requesting the location of a <a id="id641" class="indexterm"/>directory in the user's iCloud storage.</p></div></div></div><div class="section" title="How it works..."><div class="titlepage"><div><div><h2 class="title"><a id="ch06lvl2sec237"/>How it works...</h2></div></div></div><p>In this recipe, we learned how to set up and configure an app ID so that it has the ability to communicate with the iCloud service. Whenever a new or existing application ID is created and/or modified, this will be directly bound to your provisioning profiles for both development and distribution, and will need to be downloaded and reinstalled on your computer to avoid issues when you deploy this on your iOS devices.</p><p>You can also choose to do this using the <a id="id642" class="indexterm"/>Xcode development environment using the Organizer interface. In our next steps, we need to set up the entitlements that will give our application access to the iCloud directory by enabling the <span class="strong"><strong>Enable iCloud</strong></span> checkbox and auto-filling the <span class="strong"><strong>Ubiquity Contrainers</strong></span> and <span class="strong"><strong>Keychain Group</strong></span> sections.</p><p>When these have been set, it sets up the directory location on the device where you can find and create the iCloud files. The <a id="id643" class="indexterm"/>
<code class="literal">iCloud daemon</code> service will then automatically fetch new files to this directory, as they become available, update files that are currently there, and watch for any changes to file states that you put there.</p></div></div>
<div class="section" title="Configuring iOS devices to use iCloud"><div class="titlepage"><div><div><h1 class="title"><a id="ch06lvl1sec67"/>Configuring iOS devices to use iCloud</h1></div></div></div><p>In this recipe, we will take a <a id="id644" class="indexterm"/>
<a id="id645" class="indexterm"/>look at how easy it is to configure your iOS devices to use iCloud so that it has the ability to store documents.</p><div class="section" title="Getting ready"><div class="titlepage"><div><div><h2 class="title"><a id="ch06lvl2sec238"/>Getting ready</h2></div></div></div><p>Before any application can start to store data within iCloud, we will need to properly configure and set up our application to use iCloud, and store documents onto an iOS device. For this to happen, the device must be running iOS 5 or later. This will not work within the iOS Simulator.</p></div><div class="section" title="How to do it..."><div class="titlepage"><div><div><h2 class="title"><a id="ch06lvl2sec239"/>How to do it...</h2></div></div></div><p>The following steps show you how easy it is to set up an iCloud account:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">From the <span class="strong"><strong>Settings</strong></span> pane within your iOS device, select <span class="strong"><strong>iCloud</strong></span>. This is shown in the following screenshot:<div class="mediaobject"><img src="graphics/3349OT_06_15.jpg" alt="How to do it..."/></div></li><li class="listitem">Next, sign in with <a id="id646" class="indexterm"/><a id="id647" class="indexterm"/>your Apple ID and password, and then click on the <span class="strong"><strong>Sign In</strong></span> button as shown in the following screenshot.</li><li class="listitem">You will have to agree to the iCloud terms and conditions, and then click on the <span class="strong"><strong>Agree</strong></span> button to close the pop-up dialog box.</li><li class="listitem">Next, click on the <span class="strong"><strong>Storage &amp; Backup</strong></span> option to proceed to the next screen.<div class="mediaobject"><img src="graphics/3349OT_06_16.jpg" alt="How to do it..."/></div></li><li class="listitem">Next set the <span class="strong"><strong>Backup to iCloud</strong></span> option to <span class="strong"><strong>ON</strong></span> from under the <span class="strong"><strong>Backup sections</strong></span> pane. This will <a id="id648" class="indexterm"/><a id="id649" class="indexterm"/>automatically start synching your <span class="strong"><strong>Mail</strong></span>, <span class="strong"><strong>Contacts</strong></span>, <span class="strong"><strong>Calendars</strong></span>, <span class="strong"><strong>Reminders</strong></span>, <span class="strong"><strong>Bookmarks</strong></span>, or <span class="strong"><strong>Notes</strong></span> and start pushing or pulling your account information to iCloud.<div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="note51"/>Note</h3><p>If you prefer, you can also log in to <a id="id650" class="indexterm"/>your iCloud account by using any web browser at <a class="ulink" href="http://www.iCloud.com/">http://www.iCloud.com/</a>, using the same information you entered into your iOS device. Once you are successfully logged in, you can choose <span class="strong"><strong>Contacts</strong></span> or <span class="strong"><strong>Calendar</strong></span> to see your data already pulled into the cloud. Making edits via the web interface will push them directly back to your iOS device.</p></div></div></li></ol></div></div><div class="section" title="How it works..."><div class="titlepage"><div><div><h2 class="title"><a id="ch06lvl2sec240"/>How it works...</h2></div></div></div><p>In this recipe, we learned how easy it is to set up and configure iCloud on the iOS device. iCloud is a free service that comes with an initial 5 GB of free storage space, upon successful signup. This then allows <a id="id651" class="indexterm"/>
<a id="id652" class="indexterm"/>you to synchronize all of your contact information, e-mails, and documents.</p><p>Should you require additional storage space, Apple provides this to you through the <span class="strong"><strong>iCloud Settings</strong></span> menu under <span class="strong"><strong>Storage &amp; Backup</strong></span>.</p><p>When using the iCloud storage APIs from within your applications, any documents that your application stores explicitly in iCloud are not backed up with your application, as these will already be stored within your iCloud account, and therefore do not need to be backed up separately.</p></div></div></body></html>