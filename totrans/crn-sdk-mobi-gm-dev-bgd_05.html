<html><head></head><body><div class="chapter" title="Chapter&#xA0;5.&#xA0;Animating our Game"><div class="titlepage"><div><div><h1 class="title"><a id="ch05"/>Chapter 5. Animating our Game</h1></div></div></div><div class="blockquote"><blockquote class="blockquote"><p>We're off to a great start in our mobile game development journey. We have already gone through a great deal of programming, from displaying objects on screen to writing game logic that is displayed to the user. One of the most powerful things about the Corona SDK is that any display object can be animated. This is a testament to the flexible graphics model that Corona offers.</p></blockquote></div><p>Animation adds a lot of character to the user experience in a game. This is accomplished by generating a sequence of frames that evolve smoothly from frame to frame. We'll be learning this first hand and applying it to the new game that we're going to create.<a id="id321" class="indexterm"/>
</p><p>In this chapter we will:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">Work with motion and transitions</li><li class="listitem" style="list-style-type: disc">Animate with movieclips</li><li class="listitem" style="list-style-type: disc">Animate with sprite sheets</li><li class="listitem" style="list-style-type: disc">Create a game loop for display objects</li><li class="listitem" style="list-style-type: disc">Build our next game framework</li></ul></div><p>Let's animate!</p><div class="section" title="Panda star catcher"><div class="titlepage"><div><div><h1 class="title"><a id="ch05lvl1sec01"/>Panda star catcher</h1></div></div></div><p>This section involves creating our second game called Panda Star Catcher. The main premise is a panda named Ling Ling who needs to launch toward the skies and catch as many stars as possible before the timer runs out. The panda will be animated and have separate movements for every course of action that is applied such as the set up before launch and while it's in the air. The slingshot mechanics will also be applied to launch Ling Ling into the air. You may have seen similar features in games such as Angry Birds and Crush the Castle.<a id="id322" class="indexterm"/>
</p></div></div>
<div class="section" title="Let's get everything moving"><div class="titlepage"><div><div><h1 class="title"><a id="ch05lvl1sec02"/>Let's get everything moving</h1></div></div></div><p>We have introduced transitions in<a class="link" href="ch03.html" title="Chapter 3. Building our First Game: Breakout"> Chapter 3</a>,<span class="emphasis"><em> Building our First Game: Breakout</em></span> and briefly touched base with it. Let's go into more detail with them.</p><div class="section" title="Transitions"><div class="titlepage"><div><div><h2 class="title"><a id="ch05lvl2sec01"/>Transitions</h2></div></div></div><p>The transition library allows you to create animations with only a single line of code by allowing you to tween one or more properties of a display object. We discussed the basics of transitions back in<a class="link" href="ch03.html" title="Chapter 3. Building our First Game: Breakout"> Chapter 3</a>,<a id="id323" class="indexterm"/>
</p><p>This can be done through the <code class="literal">transition.to</code> method, which takes a display object and a table containing the control parameters. The control parameters specify the duration of the animation and the final values of properties for the display object. The intermediate values for a property are determined by an easing function that is also specified as a control parameter.</p><p>
<code class="literal">transition.to():</code> Animates a display object's properties over time using the <code class="literal">easing</code> transitions.</p><p>Syntax: <code class="literal">handle = transition.to( target, params )</code>
<a id="id324" class="indexterm"/>
</p><p>Parameters used are as follows:<a id="id325" class="indexterm"/>
</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><code class="literal">target:</code> A display object that will be the target of the transition.</li><li class="listitem" style="list-style-type: disc"><code class="literal">params:</code> A table that specifies the properties of the display object, which will be animated, and one or more of the following optional non-animated properties:<div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><code class="literal">params.time:</code> It specifies the duration of the transition in milliseconds. By default, the duration is 500 ms (0.5 seconds).</li><li class="listitem" style="list-style-type: disc"><code class="literal">params.transition:</code> It is by default <code class="literal">easing.linear</code>.</li><li class="listitem" style="list-style-type: disc"><code class="literal">params.delay:</code> Specifies the delay, in milliseconds, (none by default) before the tween begins.</li><li class="listitem" style="list-style-type: disc"><code class="literal">params.delta:</code> It is a boolean specifying whether non-control parameters are interpreted as final ending values or as changes in values. The default is <code class="literal">nil</code> meaning false.</li><li class="listitem" style="list-style-type: disc"><code class="literal">params.onStart:</code> It is a function or table listener called before the tween begins.</li><li class="listitem" style="list-style-type: disc"><code class="literal">params.onComplete:</code> It is a function or table listener called after the tween completes.</li></ul></div></li></ul></div></div><div class="section" title="Easing"><div class="titlepage"><div><div><h2 class="title"><a id="ch05lvl2sec02"/>Easing</h2></div></div></div><p>The <code class="literal">easing</code> library is a collection of interpolation functions used by the transition library:<a id="id326" class="indexterm"/>
</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><code class="literal">easing.linear( t, tMax, start, delta ):</code> This function defines a constant motion with no acceleration.<a id="id327" class="indexterm"/></li><li class="listitem" style="list-style-type: disc"><code class="literal">easing.inQuad( t, tMax, start, delta ):</code> This function performs a quadratic interpolation of animated property values in a transition.<a id="id328" class="indexterm"/></li><li class="listitem" style="list-style-type: disc"><code class="literal">easing.outQuad( t, tMax, start, delta ):</code> This function starts motion fast and then decelerates motion to a zero velocity as it executes.<a id="id329" class="indexterm"/></li><li class="listitem" style="list-style-type: disc"><code class="literal">easing.inOutQuad( t, tMax, start, delta ):</code> This function starts animation from a zero velocity, accelerates, then decelerate to a zero velocity.<a id="id330" class="indexterm"/></li><li class="listitem" style="list-style-type: disc"><code class="literal">easing.inExpo( t, tMax, start, delta ):</code> This function starts motion from a zero velocity and then accelerates motion as it executes.<a id="id331" class="indexterm"/></li><li class="listitem" style="list-style-type: disc"><code class="literal">easing.outExpo( t, tMax, start, delta ):</code> This function starts motion fast and then decelerates motion to a zero velocity as it executes.<a id="id332" class="indexterm"/></li><li class="listitem" style="list-style-type: disc"><code class="literal">easing.inOutExpo( t, tMax, start, delta ):</code> This function starts motion from a zero velocity, accelerates, then decelerates to a zero velocity using an exponential easing equation.<a id="id333" class="indexterm"/></li></ul></div><p>You can create your own easing function to interpolate between a start and a final value. The arguments of the function are defined as:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><code class="literal">t:</code> Is the time in milliseconds since the transition started</li><li class="listitem" style="list-style-type: disc"><code class="literal">tMax:</code> Is the duration of the transition</li><li class="listitem" style="list-style-type: disc"><code class="literal">start:</code> Is the starting value</li><li class="listitem" style="list-style-type: disc"><code class="literal">delta:</code> Is the change in value (final value = start + delta)</li></ul></div><p>For example:</p><div class="informalexample"><pre class="programlisting">local square = display.newRect( 0, 0, 50, 50 )
square:setFillColor( 255,255,255 )
square.x = 50; square.y = 100
local square2 = display.newRect( 0, 0, 50, 50 )
square2:setFillColor( 255,255,255 )
square2.x = 50; square2.y = 300
transition.to( square, { time=1500, x=250, y=0 } )
transition.from( square2, { time=1500, x=250, y=0, transition = easing.outExpo } )
</pre></div></div></div>
<div class="section" title="The value of timed functions"><div class="titlepage"><div><div><h1 class="title"><a id="ch05lvl1sec03"/>The value of timed functions</h1></div></div></div><p>Using a function that can be called at a later time can be helpful when organizing the timing of the appearance of your game objects in an application. The timer library will allow us to handle our functions in a timely manner.<a id="id335" class="indexterm"/>
</p><div class="section" title="Timers"><div class="titlepage"><div><div><h2 class="title"><a id="ch05lvl2sec03"/>Timers</h2></div></div></div><p>The <code class="literal">timer</code> function enables you to trigger events at a specific delay (in milliseconds) of your choosing.</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><code class="literal">timer.performWithDelay( delay, listener [, iterations] )</code><a id="id336" class="indexterm"/><p>Invokes the listener after a delay in milliseconds and returns a handle you can pass to <code class="literal">timer.cancel()</code> to cancel the timer before it invokes the listener.
</p><p>Example:
</p><div class="informalexample"><pre class="programlisting">local function myEvent()
print( "myEvent called" )
end
timer.performWithDelay( 1000, myEvent )
</pre></div></li><li class="listitem" style="list-style-type: disc"><code class="literal">timer.cancel( timerId )</code><p>Cancels a timer operation initiated with <code class="literal">timer.performWithDelay().</code>
</p><p>Parameters:
<a id="id337" class="indexterm"/>
</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><code class="literal">timerId:</code> Handle returned by the call to <code class="literal">timer.performWithDelay()</code>.</li></ul></div><p>Example:
</p><div class="informalexample"><pre class="programlisting">local count = 0
local function myEvent()
count = count + 1
print( count )
if count &gt;= 3 then
timer.cancel( myTimerID ) -- Cancels myTimerID
end
end
myTimerID = timer.performWithDelay( 1000, myEvent, 0 )
<a id="id338" class="indexterm"/>
</pre></div></li><li class="listitem" style="list-style-type: disc"><code class="literal">timer.pause( timerId )</code><p>Pauses a timer started with <code class="literal">timer.performWithDelay().</code>
</p><p>Parameters:
<a id="id339" class="indexterm"/>
</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><code class="literal">timerId:</code> The Timer ID from <code class="literal">timer.performWithDelay()</code>.</li></ul></div><p>Example:
</p><div class="informalexample"><pre class="programlisting">local count = 0
local function myEvent()
count = count + 1
print( count )
if count &gt;= 5 then
timer.pause( myTimerID ) -- Pauses myTimerID
end
end
myTimerID = timer.performWithDelay( 1000, myEvent, 0 )
</pre></div></li><li class="listitem" style="list-style-type: disc"><code class="literal">timer.resume( timerId )</code><p>Resumes a timer that was paused with <code class="literal">timer.pause( timerId ).</code>
<a id="id340" class="indexterm"/>
</p><p>Parameters:
</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><code class="literal">timerID:</code> The Timer ID from <code class="literal">timer.performWithDelay()</code>.</li></ul></div><p>Example:
</p><div class="informalexample"><pre class="programlisting">local function myEvent()
print( "myEvent called" )
end
myTimerID = timer.performWithDelay( 3000, myEvent ) -- wait 3 seconds
result = timer.pause( myTimerID ) -- Pauses myTimerID
print( "Time paused at " .. result )
result = timer.resume( myTimerID ) -- Resumes myTimerID
print( "Time resumed at " .. result )
<a id="id341" class="indexterm"/>
</pre></div></li></ul></div></div></div>
<div class="section" title="Movieclips or sprite sheets. What's the difference?"><div class="titlepage"><div><div><h1 class="title"><a id="ch05lvl1sec04"/>Movieclips or sprite sheets. What's the difference?</h1></div></div></div><p>Corona SDK includes a<span class="emphasis"><em> sprite sheet</em></span> feature for constructing animated sprites. Refer to the following link for more information on sprite sheets at:<a class="ulink" href="http://developer.anscamobile.com/reference/sprite-sheets"> http://developer.anscamobile.com/reference/sprite-sheets</a>.<a id="id342" class="indexterm"/>
</p><p>
<span class="strong"><strong>Sprite sheets</strong></span> are an efficient way to save texture memory. They are recommended for complex character animation or when numerous types of animations are involved.<a id="id343" class="indexterm"/>
</p><p>Sprite sheets will require more coding and have more of an advanced setup. They require the construction of a large sheet of animation frames. The movieclip library is easier to get started with, and can be more rapidly used to port Flash content, since movieclip frames can be exported from Flash as PNG sequences.</p></div>
<div class="section" title="Movieclips"><div class="titlepage"><div><div><h1 class="title"><a id="ch05lvl1sec05"/>Movieclips</h1></div></div></div><p>The external movieclip library allows you to create animated sprites from sequences of images, which can be moved around the screen using the same techniques as any other Corona display object.<a id="id344" class="indexterm"/>
</p><p>The movieclip library is an external module, <code class="literal">movieclip.lua</code>, that can be included with your projects and loaded using the <code class="literal">require</code> command.</p><p>The movieclip library can be found in the <code class="literal">Movieclip</code> sample project in the <code class="literal">SampleCode/Graphics</code> folder inside of the Corona SDK.</p><div class="section" title="Movieclip functions"><div class="titlepage"><div><div><h2 class="title"><a id="ch05lvl2sec04"/>Movieclip functions</h2></div></div></div><p>An animation object is returned using a list of images. You can use methods of the returned animation object to control its playback such as <code class="literal">play(), stop()</code>, and <code class="literal">reverse()</code>.<a id="id345" class="indexterm"/>
</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><code class="literal">movieclip.newAnim( frames ):</code> Creates an animated sprite using an array of image filenames provided in the frames table:<a id="id346" class="indexterm"/><div class="informalexample"><pre class="programlisting">myAnimation = movieclip.newAnim{ "1.png", "2.png", "3.png", "4.png", "5.png"}
</pre></div></li><li class="listitem" style="list-style-type: disc"><code class="literal">object:play():</code> Starts the animated sprite playing in the forward direction. When the end of the sequence is reached, it repeats from the beginning.<a id="id347" class="indexterm"/></li><li class="listitem" style="list-style-type: disc"><code class="literal">object:play{ startFrame=a, endFrame=b, loop=c, remove=shouldRemove }:</code> Starts the animated sprite in forward motion. When the frame number given by <code class="literal">endFrame</code> is reached, it will cycle back to the frame number given by <code class="literal">startFrame</code> and continue playing:<div class="informalexample"><pre class="programlisting">myAnimation:play{ startFrame=1, endFrame=4, loop=5, remove=true }
</pre></div><p>An animation can loop as many times based on the number you indicate. Using <code class="literal">0</code> will loop the animation forever.
</p><p>The remove parameter is a boolean flag, and if set to true, the movieclip will automatically delete itself when the given sequence is completed. The default value is <code class="literal">false</code>.
</p></li><li class="listitem" style="list-style-type: disc"><code class="literal">object:reverse():</code> Plays the animated sprite in reverse direction. When the beginning of the image set is reached, it will cycle back to the last image and continue playing backwards.<a id="id348" class="indexterm"/></li><li class="listitem" style="list-style-type: disc"><code class="literal">object:reverse{ startFrame=a, endFrame=b, loop=c, remove=shouldRemove }:</code> Starts the animated sprite in reverse order. When the frame number given by <code class="literal">endFrame</code> is reached, it will cycle back to the frame number given by <code class="literal">startFrame</code> and continue playing.<p>An animation can loop as many times based on the number you indicate. Using <code class="literal">0</code> will loop the animation forever.
</p><p>The remove parameter is a boolean flag, and if set to true, the movieclip will automatically delete itself when the given sequence is completed. The default value is <code class="literal">false</code>.
</p></li><li class="listitem" style="list-style-type: disc"><code class="literal">object:nextFrame():</code> Resets any animation sequence in progress, moves the animation to the next image in the total sequence, and stops.<a id="id349" class="indexterm"/></li><li class="listitem" style="list-style-type: disc"><code class="literal">object:previousFrame():</code> Resets any animation sequence in progress, moves the animation to the previous image in the total sequence, and stops.<a id="id350" class="indexterm"/></li><li class="listitem" style="list-style-type: disc"><code class="literal">object:setLabels( labels ):</code> Adds optional labels to an object previously created, using a table to assign label names to selected frame numbers:<p>Syntax: <code class="literal">object:setLabels{ frameLabel1=num1, frameLabel2=num2, ..., frameLabelN = numN }</code>
</p><p>Example:
</p><div class="informalexample"><pre class="programlisting">myAnimation:setLabels{ main=1, end=30 }
</pre></div></li><li class="listitem" style="list-style-type: disc"><code class="literal">object:stop():</code> Stops the animation of the sprite at its current frame.<a id="id351" class="indexterm"/></li><li class="listitem" style="list-style-type: disc"><code class="literal">object:stopAtFrame( frame ):</code> Jumps the animation to the specified frame, given either as a frame number or by an optional frame label.<a id="id352" class="indexterm"/><div class="informalexample"><pre class="programlisting">myAnimation:stopAtFrame(2)
myAnimation:play()
myAnimation:stopAtFrame("label")
myAnimation:reverse()
</pre></div></li><li class="listitem" style="list-style-type: disc"><code class="literal">object:setDrag:</code> Turns any movieclip into a draggable object when drag is set as true. <code class="literal">limitX</code> and <code class="literal">limitY</code> parameters limit the dragging to either the x or y axis, and the bounds parameter can be used to specify drag boundaries for the object as <code class="literal">{left, top, width, height}</code>.<a id="id353" class="indexterm"/><p>The <code class="literal">onPress, onDrag</code>, and <code class="literal">onRelease</code> parameters take the names of functions to be called when those events occur. All parameters are optional.
</p><div class="informalexample"><pre class="programlisting">myAnimation:setDrag{ drag=true, limitX=false, limitY=false, onPress=myPressFunction, onDrag=myDragFunction,
onRelease=myReleaseFunction, bounds={ 20, 20, 100, 25 }}
</pre></div><p>To turn off the draggable property again, set drag to false:
</p><div class="informalexample"><pre class="programlisting">myAnimation:setDrag{ drag=false }
</pre></div><p>
</p></li></ul></div></div></div>
<div class="section" title="It's sprite mania!"><div class="titlepage"><div><div><h1 class="title"><a id="ch05lvl1sec06"/>It's sprite mania!</h1></div></div></div><p>Sprite sheets are 2D animations compiled to multiple frames into a single texture image. This is an efficient way to save on texture memory. It is beneficial for mobile devices and minimizes loading time.<a id="id354" class="indexterm"/>
</p><div class="section" title="Sprite API"><div class="titlepage"><div><div><h2 class="title"><a id="ch05lvl2sec05"/>Sprite API</h2></div></div></div><p>The following line makes the sprite features available under the sprite namespace:<a id="id355" class="indexterm"/>
</p><div class="informalexample"><pre class="programlisting">require "sprite"
</pre></div><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><code class="literal">sprite.newSpriteSheet:</code> The function creates a new sprite sheet.<div class="informalexample"><pre class="programlisting">spriteSheet = sprite.newSpriteSheet("myImage.png", frameWidth, frameHeight) -- the width/height of each animation in the sprite sheet
<a id="id356" class="indexterm"/>
</pre></div><p>For example, the number of frames in the sprite sheet is assumed to be <code class="literal">floor(imageWidth/frameWidth) * floor(imageHeight/frameHeight)</code>. The first frame is placed at the top-left position and reads left to right and follows the next row if applicable. The following sprite sheet has 5 frames that are 128 x 128 pixels each. The sprite sheet image altogether is 384 x 256 pixels. If it were to be integrated in Corona, a sample method would be displayed as follows:
</p><div class="informalexample"><pre class="programlisting">spriteSheet = sprite.newSpriteSheet("pandaSheet.png", 128, 128)
</pre><div class="mediaobject"><img src="graphics/1888_05_01.jpg" alt="Sprite API"/></div></div></li><li class="listitem" style="list-style-type: disc"><code class="literal">spriteSet = sprite.newSpriteSet(spriteSheet, startFrame, frameCount):</code> Creates a new sprite set from a sprite sheet. A sprite set defines the collection of frames that belong to the same character or another moving asset, which may then be subdivided into different animation sequences for playback. A sprite set is a Lua table containing keys to one or more animation sequences for a given character.<a id="id357" class="indexterm"/></li><li class="listitem" style="list-style-type: disc"><code class="literal">sprite.add( spriteSet, "sequenceName", startFrame, frameCount, time, [loopCount]):</code> Adds a sequence named "sequenceName" to the sprite set with the specified frames. The sequence has <code class="literal">frameCount</code> frames, and it will play for the time specified in milliseconds. The frame rate of each sequence can be controlled individually by altering the <code class="literal">time</code> parameter.<a id="id358" class="indexterm"/></li><li class="listitem" style="list-style-type: disc"><code class="literal">spriteSheet:dispose():</code> Disposes of a sprite sheet and releases its texture memory. It also calls <code class="literal">removeSelf()</code> on all sprite instances using the sheet, removing them from the stage. All sprites, sequences, and sets that belong to the removed sprite sheet are no longer accessible.<div class="informalexample"><pre class="programlisting">local sprite = require("sprite")
local spriteSheet = sprite.newSpriteSheet("mySprite.png")
spriteSheet:dispose()
</pre></div></li><li class="listitem" style="list-style-type: disc"><code class="literal">si = sprite.newSprite( spriteSet ):</code> Creates a new instance of a sprite.<a id="id359" class="indexterm"/></li><li class="listitem" style="list-style-type: disc"><code class="literal">si:prepare([sequence]):</code> Stops playing the current animation sequence, sets the new current sequence, and also moves to the first frame of that sequence.<a id="id360" class="indexterm"/></li><li class="listitem" style="list-style-type: disc"><code class="literal">si:play():</code> Plays animation sequence, starting at the current frame.<a id="id361" class="indexterm"/></li><li class="listitem" style="list-style-type: disc"><code class="literal">si:pause():</code> Stops the animation, but the frame remains on the last displayed frame. Playback can resume later with <code class="literal">play()</code>.<a id="id362" class="indexterm"/></li><li class="listitem" style="list-style-type: disc"><code class="literal">si:addEventListener("sprite", listener):</code> notifies the listener as to when the sprite instance animation has an event. The event, passed to the listener, has the following fields:<a id="id363" class="indexterm"/><p><code class="literal">event.sprite</code>: The sprite that fired the event; its current properties may also be accessed via the event.
</p><p><code class="literal">event.phase</code>: The phase is one of:
</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><code class="literal">"end":</code> the sprite stops playing</li><li class="listitem" style="list-style-type: disc"><code class="literal">"loop":</code> the sprite loops (from last to first, or reverses direction)</li><li class="listitem" style="list-style-type: disc"><code class="literal">"next":</code> the sprite's next frame is played</li></ul></div></li></ul></div></div></div>
<div class="section" title="Game time!"><div class="titlepage"><div><div><h1 class="title"><a id="ch05lvl1sec07"/>Game time!</h1></div></div></div><p>Now that we have learned how to set up object movement, movieclips, and sprite sheets, let's try to incorporate them into Panda Star Catcher! You can download the project files accompanying this book from the Packt website. There is a project folder called <code class="literal">Panda Star Catcher</code> in the Chapter 5 file folder. It already has the <code class="literal">config.lua</code> and <code class="literal">build.settings</code> files set up for you. The art assets are included in the folder as well. You will notice that the build and runtime configuration has a similar setup from<a class="link" href="ch03.html" title="Chapter 3. Building our First Game: Breakout"> Chapter 3</a>,<span class="emphasis"><em> Building our First Game: Breakout</em></span> and<a class="link" href="ch04.html" title="Chapter 4. Game Controls"> Chapter 4</a>,<span class="emphasis"><em> Game Controls</em></span>. This tutorial is compatible with both iOS and Android devices.<a id="id364" class="indexterm"/>
</p><p>The graphics included in the project folder have been designed to display properly on both platforms.<a id="id365" class="indexterm"/>
</p><div class="mediaobject"><img src="graphics/1888_05_02.jpg" alt="Game time!"/></div></div>
<div class="section" title="Time for action&#x2014;setting up the variables"><div class="titlepage"><div><div><h1 class="title"><a id="ch05lvl1sec08"/>Time for action—setting up the variables</h1></div></div></div><p>Let's start off with introducing all the variables needed to run the game.</p><div class="orderedlist"><ol class="orderedlist"><li class="listitem">Create a brand new <code class="literal">main.lua</code> file and add it in the <code class="literal">Panda Star Catcher</code> project folder.<a id="id366" class="indexterm"/></li><li class="listitem">Let's hide the status bar from the devices and set all the variables needed in game:<div class="informalexample"><pre class="programlisting">display.setStatusBar( display.HiddenStatusBar ) -- Hides the status bar
-- Display groups
local hudGroup = display.newGroup() -- Displays the HUD
local gameGroup = display.newGroup()
local levelGroup = display.newGroup()
local stars = display.newGroup() -- Displays the stars
-- Modules
local sprite = require("sprite")
local physics = require ("physics")
local mCeil = math.ceil
local mAtan2 = math.atan2
local mPi = math.pi
local mSqrt = math.sqrt
-- Game Objects
local background
local ground
local powerShot
local arrow
local panda
local poof
local starGone
local scoreText
local gameOverDisplay
-- Variables
local gameIsActive = false
local waitingForNewRound
local restartTimer
local counter
local timerInfo
local numSeconds = 30 -- Time the round starts at
local counterSize = 50
local gameScore = 0 -- Round starts at a score of 0
local starWidth = 30
local starHeight = 30
</pre></div></li></ol></div><div class="section" title="What just happened?"><div class="titlepage"><div><div><h2 class="title"><a id="ch05lvl2sec06"/>What just happened?</h2></div></div></div><p>We hid the status bar at the start of the application. This is only applicable for iOS devices. There are four different groups set up and they all play an important role in the game.</p><p>You will notice <code class="literal">gameIsActive = false</code>. This enables us to activate properties of the application to affect the round when the display objects need to stop animating, appear on screen, and become affected by touch events.</p><p>Elements for the timer have been set in the beginning of the code as well. <code class="literal">numSeconds = 30</code>. This is how long the round will count down from in seconds. <code class="literal">starWidth</code> and <code class="literal">starHeight</code> depicts the dimensions of the object altogether.</p></div></div>
<div class="section" title="Let's start the round"><div class="titlepage"><div><div><h1 class="title"><a id="ch05lvl1sec09"/>Let's start the round</h1></div></div></div><p>We'll need to load the panda to the game screen before it can launch. The panda will transition from the bottom of the screen and move upward on the screen before any touch event can occur.</p></div>
<div class="section" title="Time for action&#x2014;starting the game"><div class="titlepage"><div><div><h1 class="title"><a id="ch05lvl1sec10"/>Time for action—starting the game</h1></div></div></div><p>Right now we need to set the off screen position for the panda and have it transition to its starting launch location so the user can interact with it.<a id="id368" class="indexterm"/>
</p><div class="orderedlist"><ol class="orderedlist"><li class="listitem">After adding the variables, create a new local function called <code class="literal">startNewRound()</code> and add an <code class="literal">if</code> statement to initiate the <code class="literal">panda</code> object into the scene.<div class="informalexample"><pre class="programlisting">local startNewRound = function()
if panda then
</pre></div></li><li class="listitem">Add a new local function called <code class="literal">activateRound()</code> within <code class="literal">startNewRound()</code>. Set the starting position of the <code class="literal">panda</code> display object on screen and add <code class="literal">ground:toFront()</code> so that ground appears in front of the panda character.<div class="informalexample"><pre class="programlisting">local activateRound = function()
waitingForNewRound = false
if restartTimer then
timer.cancel( restartTimer )
end
ground:toFront()
panda.x = 240;
panda.y = 300;
panda.rotation = 0
panda.isVisible = true
panda.isBodyActive = true
</pre></div></li><li class="listitem">Create another local function called <code class="literal">pandaLoaded()</code>. Set <code class="literal">gameIsActive = true</code> and set the <code class="literal">panda</code> object's air and hit properties to <code class="literal">false</code>. Add <code class="literal">panda:toFront()</code> so that it appears in front of all the other game objects on screen and set the body type to<code class="literal">"static"</code>.<div class="informalexample"><pre class="programlisting">local pandaLoaded = function()
gameIsActive = true
panda.inAir = false
panda.isHit = false
panda:toFront()
panda.bodyType = "static"
end
</pre></div></li><li class="listitem">Transition the panda to <code class="literal">y=225</code> in 1000 milliseconds. When the tween is completed, call the <code class="literal">pandaLoaded()</code> function using the <code class="literal">onComplete</code> command. Close the <code class="literal">activateRound()</code> function with <code class="literal">end</code> and call out to it. Close the <code class="literal">if</code> statement for <code class="literal">panda</code> and the <code class="literal">startNewRound()</code> function with <code class="literal">end</code>.<a id="id369" class="indexterm"/><div class="informalexample"><pre class="programlisting">transition.to( panda, { time=1000, y=225, onComplete=pandaLoaded } )
end
activateRound()
end
end
</pre><div class="mediaobject"><img src="graphics/1888_05_03.jpg" alt="Time for action—starting the game"/></div></div></li></ol></div><div class="section" title="What just happened?"><div class="titlepage"><div><div><h2 class="title"><a id="ch05lvl2sec07"/>What just happened?</h2></div></div></div><p>When the level is activated, the panda is placed below the ground before it is visible to the player. For <code class="literal">pandaLoaded()</code>, the game is activated by <code class="literal">gameIsActive = true</code> and the panda is ready for launch by the player. The panda transitions from the ground level to an area on the screen where it can be accessed.<a id="id370" class="indexterm"/>
</p></div></div>
<div class="section" title="Poof begone!"><div class="titlepage"><div><div><h1 class="title"><a id="ch05lvl1sec11"/>Poof begone!</h1></div></div></div><p>The panda needs to disappear from the stage after a turn has been made. Instead of having it disappear into thin air, we'll be adding a poof effect when it collides with any object on screen.<a id="id371" class="indexterm"/>
</p></div>
<div class="section" title="Time for action&#x2014;reloading the panda on the stage"><div class="titlepage"><div><div><h1 class="title"><a id="ch05lvl1sec12"/>Time for action—reloading the panda on the stage</h1></div></div></div><p>When the panda has been in the air for a certain amount of time or has hit any out of bounds area off the screen, it will turn into a cloud of smoke. The panda will be replaced with a<span class="emphasis"><em> poof</em></span> image when a collision event occurs with the edge of the screen or the ground. The visible properties of the panda have to be turned off for the<span class="emphasis"><em> poof</em></span> effect to work. When the collision has been made, the panda needs to be reloaded back on to the screen while the game is still activated.<a id="id372" class="indexterm"/>
</p><div class="orderedlist"><ol class="orderedlist"><li class="listitem">Create a local function called <code class="literal">callNewRound()</code>. Include a local variable called <code class="literal">isGameOver</code> and set it to <code class="literal">false</code>.<div class="informalexample"><pre class="programlisting">local callNewRound = function()
local isGameOver = false
</pre></div></li><li class="listitem">Within the current function, create a new local function called <code class="literal">pandaGone()</code>. Add in new properties for the panda so it no longer displays on the game stage.<div class="informalexample"><pre class="programlisting">local pandaGone = function()
panda:setLinearVelocity( 0, 0 )
panda.bodyType = "static"
panda.isVisible = false
panda.isBodyActive = false
panda.rotation = 0
poof.x = panda.x; poof.y = panda.y
poof.alpha = 0
poof.isVisible = true
</pre></div></li><li class="listitem">Add in a new function for the <code class="literal">poof</code> object called <code class="literal">fadePoof()</code>. With the <code class="literal">onComplete</code> command, transition with <code class="literal">time=50</code> and <code class="literal">alpha=1</code>. Have the <code class="literal">poof</code> object fade out with <code class="literal">time=100</code> and <code class="literal">alpha=0</code>. Close the <code class="literal">pandaGone()</code> function and call out to it using <code class="literal">timer.peformWithDelay</code>.<div class="informalexample"><pre class="programlisting">local fadePoof = function()
transition.to( poof, { time=100, alpha=0 } )
end
transition.to( poof, { time=50, alpha=1.0, onComplete=fadePoof } )
restartTimer = timer.performWithDelay( 300, function()
waitingForNewRound = true;
end, 1)
end
local poofTimer = timer.performWithDelay( 500, pandaGone, 1 )
</pre></div></li><li class="listitem">When <code class="literal">isGameOver</code> is still <code class="literal">false</code>, add in a <code class="literal">timer.peformWithDelay</code> for <code class="literal">startNewRound()</code>. Close the <code class="literal">callNewRound()</code> function.<a id="id373" class="indexterm"/><div class="informalexample"><pre class="programlisting">if isGameOver == false then
restartTimer = timer.performWithDelay( 1500, startNewRound, 1 )
end
end
</pre></div></li></ol></div><div class="section" title="What just happened?"><div class="titlepage"><div><div><h2 class="title"><a id="ch05lvl2sec08"/>What just happened?</h2></div></div></div><p>A new round is called when the panda is no longer displayed on screen and the clock is still counting down. When <code class="literal">isGameOver</code> is still <code class="literal">false</code>, then the panda reloads by calling <code class="literal">startNewRound()</code>.</p><p>The panda collision occurs through <code class="literal">pandaGone()</code>. All physical properties become inactive by applying <code class="literal">panda.isVisible = false</code> and <code class="literal">pandaisBodyActive = false</code>.</p><p>The exact placement the panda disappears, the smoke will appear. This happens when <code class="literal">poof.x = panda.x; poof.y = panda.y. poof</code> will become visible for a short while through <code class="literal">fadePoof()</code>. Once it has faded, a new round awaits, which makes <code class="literal">waitingForNewRound = true</code>.</p></div></div>
<div class="section" title="Earn some points"><div class="titlepage"><div><div><h1 class="title"><a id="ch05lvl1sec13"/>Earn some points</h1></div></div></div><p>Points are earned when the panda catches any stars in the sky. The game is run on a timer, so it is the player's job to catch as many stars as he/she can before the time runs out. Let's rack up some points!<a id="id374" class="indexterm"/>
</p></div>
<div class="section" title="Time for action&#x2014;tracking the score"><div class="titlepage"><div><div><h1 class="title"><a id="ch05lvl1sec14"/>Time for action—tracking the score</h1></div></div></div><p>The score updates through a parameter called <code class="literal">scoreNum</code> and displays it during gameplay. The score number is received through <code class="literal">gameScore</code>.<a id="id375" class="indexterm"/>
</p><div class="orderedlist"><ol class="orderedlist"><li class="listitem">The next function that will be created is called <code class="literal">setScore()</code> with a parameter called <code class="literal">scoreNum</code>.<div class="informalexample"><pre class="programlisting">local setScore = function( scoreNum )
<a id="id376" class="indexterm"/>
</pre></div></li><li class="listitem">Use a local variable called <code class="literal">newScore</code> and set it equal to <code class="literal">scoreNum</code>. Set the <code class="literal">gameScore = newScore</code>. Provide an <code class="literal">if</code> statement for <code class="literal">gameScore</code> so that the score during gameplay is set at <code class="literal">0</code>.<div class="informalexample"><pre class="programlisting">local newScore = scoreNum
gameScore = newScore
if gameScore &lt; 0 then gameScore = 0; end
</pre></div></li><li class="listitem">Add in the <code class="literal">scoreText</code> display object and have it equal to <code class="literal">gameScore</code>. Close the function.<div class="informalexample"><pre class="programlisting">scoreText.text = gameScore
scoreText.xScale = 0.5; scoreText.yScale = 0.5
scoreText.x = (480 - (scoreText.contentWidth * 0.5)) - 15
scoreText.y = 20
end
</pre></div></li></ol></div><div class="section" title="What just happened?"><div class="titlepage"><div><div><h2 class="title"><a id="ch05lvl2sec09"/>What just happened?</h2></div></div></div><p>For <code class="literal">setScore = function(scoreNum)</code>, we set a parameter called <code class="literal">scoreNum. scoreNum</code> will update the game score continuously through <code class="literal">local newScore. newScore</code> will update through <code class="literal">gameScore</code>, which provides the base of the score keeping. At the same time, <code class="literal">scoreText</code> will display the value of <code class="literal">gameScore</code> during the game.</p></div></div>
<div class="section" title="When the game ends"><div class="titlepage"><div><div><h1 class="title"><a id="ch05lvl1sec15"/>When the game ends</h1></div></div></div><p>There are no losers in this game. Everyone wins! You'll still keep your adrenaline pumping by trying to catch as many stars as you can before the timer runs out. When it's all over we still need to be notified when the time is up.<a id="id377" class="indexterm"/>
</p></div>
<div class="section" title="Time for action&#x2014;displaying the game over screen"><div class="titlepage"><div><div><h1 class="title"><a id="ch05lvl1sec16"/>Time for action—displaying the game over screen</h1></div></div></div><p>We need to set up the game over screen and have it display the final score the player has achieved at the end of the round.</p><div class="orderedlist"><ol class="orderedlist"><li class="listitem">Create a new local function called <code class="literal">callGameOver()</code>.<div class="informalexample"><pre class="programlisting">local callGameOver = function()
</pre></div></li><li class="listitem">Set <code class="literal">gameIsActive = false</code> and pause the physics engine. Remove the <code class="literal">panda</code> and <code class="literal">stars</code> objects from the stage.<div class="informalexample"><pre class="programlisting">gameIsActive = false
physics.pause()
panda:removeSelf()
panda = nil
stars:removeSelf()
stars = nil
</pre></div></li><li class="listitem">Display the game over objects and insert them into the <code class="literal">hudGroup</code> group. Use the <code class="literal">transition.to</code> method to display the game over objects on screen.<a id="id378" class="indexterm"/><div class="informalexample"><pre class="programlisting">local shade = display.newRect( 0, 0, 480, 320 )
shade:setFillColor( 0, 0, 0, 255 )
shade.alpha = 0
gameOverDisplay = display.newImage( "gameOverScreen.png")
gameOverDisplay.x = 240; gameOverDisplay.y = 160
gameOverDisplay.alpha = 0
hudGroup:insert( shade )
hudGroup:insert( gameOverDisplay )
transition.to( shade, { time=200, alpha=0.65 } )
transition.to( gameOverDisplay, { time=500, alpha=1 } )
</pre></div></li><li class="listitem">Update the final score with a local variable called <code class="literal">newScore</code>. Set <code class="literal">isVisible = false</code> for the <code class="literal">counter</code> and <code class="literal">scoreText</code>. Introduce the <code class="literal">scoreText</code> again to display the final score in a different location on the device screen. Close the function.<div class="informalexample"><pre class="programlisting">local newScore = gameScore
setScore( newScore )
counter.isVisible = false
scoreText.isVisible = false
scoreText.text = "Score: " .. gameScore
scoreText.xScale = 0.5; scoreText.yScale = 0.5
scoreText.x = 280
scoreText.y = 160
scoreText:toFront()
timer.performWithDelay( 1000, function() scoreText.isVisible = true; end, 1 )
end
</pre><div class="mediaobject"><img src="graphics/1888_05_04.jpg" alt="Time for action—displaying the game over screen"/></div></div></li></ol></div><div class="section" title="What just happened?"><div class="titlepage"><div><div><h2 class="title"><a id="ch05lvl2sec10"/>What just happened?</h2></div></div></div><p>
<code class="literal">callGameOver()</code> displays the game over screen when time runs out or if all the stars are collected. We set <code class="literal">gameIsActive = false</code> and paused all the physics so the panda cannot be moved with any other screen touches. The panda and stars are then removed from the scene.<a id="id379" class="indexterm"/>
</p><p>
<code class="literal">shade</code> and <code class="literal">gameOverDisplay</code> are visible through <code class="literal">transition.to</code> so it notifies the player that the round is over. The final score will display at the end of the round in front of the <code class="literal">gameOverDisplay</code> object.</p></div></div>
<div class="section" title="Background display"><div class="titlepage"><div><div><h1 class="title"><a id="ch05lvl1sec17"/>Background display</h1></div></div></div><p>The panda needs a general setting of where it's located in the game. Let's set the background and ground objects.<a id="id380" class="indexterm"/>
</p></div>
<div class="section" title="Time for action&#x2014;adding the background elements"><div class="titlepage"><div><div><h1 class="title"><a id="ch05lvl1sec18"/>Time for action—adding the background elements</h1></div></div></div><div class="orderedlist"><ol class="orderedlist"><li class="listitem">Add in the <code class="literal">background</code> and <code class="literal">ground</code> display objects to the <code class="literal">drawBackground()</code> function. Insert the objects in the group called <code class="literal">gameGroup</code>.<a id="id381" class="indexterm"/><div class="informalexample"><pre class="programlisting">local drawBackground = function()
background = display.newImage( "background.png" )
background.x = 240; background.y = 160
gameGroup:insert( background )
ground = display.newImage( "ground.png" )
ground.x = 240; ground.y = 300
local groundShape = { -240,-18, 240,-18, 240,18, -240,18 }
physics.addBody( ground, "static", { density=1.0, bounce=0, friction=0.5, shape=groundShape } )
gameGroup:insert( ground )
end
</pre></div></li></ol></div><div class="section" title="What just happened?"><div class="titlepage"><div><div><h2 class="title"><a id="ch05lvl2sec11"/>What just happened?</h2></div></div></div><p>The <code class="literal">background</code> and <code class="literal">ground</code> display objects are placed in the function called <code class="literal">drawBackground(). ground</code> has a customized physical shape that is not the same size as the original display object. If the panda happens to hit the ground, it will be able to collide with it and not fall through.<a id="id382" class="indexterm"/>
</p></div></div>
<div class="section" title="Heads up!"><div class="titlepage"><div><div><h1 class="title"><a id="ch05lvl1sec19"/>Heads up!</h1></div></div></div><p>Before the game can be played, we need a general idea of how to operate the controls of the game. Luckily, we'll only be adding a help screen that explains how to play. The<span class="strong"><strong> HUD (Heads Up Display)</strong></span> needs to be displayed as well so the player can be updated on the time left on the clock and how many points have been accumulated.</p></div>
<div class="section" title="Time for action&#x2014;displaying the timer and score"><div class="titlepage"><div><div><h1 class="title"><a id="ch05lvl1sec20"/>Time for action—displaying the timer and score</h1></div></div></div><p>Let's set up the help screen and HUD elements that need to be displayed during the game.<a id="id383" class="indexterm"/>
</p><div class="orderedlist"><ol class="orderedlist"><li class="listitem">Create a new local function called <code class="literal">hud()</code>.<div class="informalexample"><pre class="programlisting">local hud = function()
</pre></div></li><li class="listitem">Display <code class="literal">helpText</code> at the start of the game for 10 seconds. Have it transition by sliding it to the left and turning visibility to <code class="literal">false</code>. Add the <code class="literal">helpText</code> to the <code class="literal">hudGroup</code> group.<div class="informalexample"><pre class="programlisting">local helpText = display.newImage("help.png")
helpText.x = 240; helpText.y = 160
helpText.isVisible = true
hudGroup:insert( helpText )
timer.performWithDelay( 10000, function() helpText.isVisible = false; end, 1 )
transition.to( helpText, { delay=9000, time=1000, x=-320, transition=easing.inOutExpo })
</pre></div></li><li class="listitem">Display <code class="literal">counter</code> and <code class="literal">scoreText</code> near the top of the screen. Add <code class="literal">scoreText</code> to the <code class="literal">hudGroup</code> group as well. Close the function with <code class="literal">end</code>.<a id="id384" class="indexterm"/><div class="informalexample"><pre class="programlisting">counter = display.newText( "Time: " .. tostring( numSeconds ), 0, 0, "Helvetica-Bold", counterSize )
counter:setTextColor( 255, 255, 255, 255 )
counter.xScale = 0.5; counter.yScale = 0.5
counter.x = 60; counter.y = 15
counter.alpha = 0
transition.to( counter, { delay=9000, time=1000, alpha=1, transition=easing.inOutExpo })
hudGroup:insert( counter )
scoreText = display.newText( "0", 470, 22, "Helvetica-Bold", 52 )
scoreText:setTextColor( 255, 255, 255, 255 ) --&gt; white
scoreText.text = gameScore
scoreText.xScale = 0.5; scoreText.yScale = 0.5
scoreText.x = (480 - (scoreText.contentWidth * 0.5)) - 15
scoreText.y = 15
scoreText.alpha = 0
transition.to( scoreText, { delay=9000, time=1000, alpha=1, transition=easing.inOutExpo })
hudGroup:insert( scoreText )
end
</pre></div></li></ol></div><div class="section" title="What just happened?"><div class="titlepage"><div><div><h2 class="title"><a id="ch05lvl2sec12"/>What just happened?</h2></div></div></div><p>
<code class="literal">helpText</code> appears before the game starts and stays on the main device display for 9 seconds and transitions to -320 in the x-direction in 1 second. This happens through <code class="literal">transition.to( helpText, { delay=9000, time=1000, x=-320, transition=easing.inOutExpo })</code>.</p><p>
<code class="literal">counter</code> displays<code class="literal">"Time: " .. tostring( numSeconds ). numSeconds</code> being the seconds that are counted down, starting from 30. It is located near the top-left corner of the screen.</p><p>
<code class="literal">scoreText</code> displays <code class="literal">gameScore</code> and is updated for every star collision made. This will be placed on the top right corner of the screen. All the objects in <code class="literal">local hud = function()</code> are inserted in <code class="literal">hudGroup</code>.<a id="id385" class="indexterm"/>
</p></div></div>
<div class="section" title="Time after time"><div class="titlepage"><div><div><h1 class="title"><a id="ch05lvl1sec21"/>Time after time</h1></div></div></div><p>This game has a timer that the player has to work against in order to catch as many stars as possible before it runs out. We're going to start the countdown as soon as the help text leaves the stage.</p></div>
<div class="section" title="Time for action&#x2014;setting up the timer"><div class="titlepage"><div><div><h1 class="title"><a id="ch05lvl1sec22"/>Time for action—setting up the timer</h1></div></div></div><p>We'll need to create a couple of functions that activate the countdown and also stops the countdown at 0 seconds when the game is over.<a id="id386" class="indexterm"/>
</p><div class="orderedlist"><ol class="orderedlist"><li class="listitem">Set up the timer countdown for the game with a local function called <code class="literal">myTimer()</code>.<div class="informalexample"><pre class="programlisting">local myTimer = function()
</pre></div></li><li class="listitem">Have the seconds for the timer countdown by an increment of 1. With the <code class="literal">counter</code> text object, display the time using <code class="literal">numSeconds</code>. Print out <code class="literal">numSeconds</code> to see the countdown in the<span class="strong"><strong> Terminal</strong></span> window.<div class="informalexample"><pre class="programlisting">numSeconds = numSeconds - 1
counter.text = "Time: " .. tostring( numSeconds )
print(numSeconds)
</pre></div></li><li class="listitem">Create an <code class="literal">if</code> statement for when the timer runs out or if all the stars are gone. Within the block, cancel the timer and call <code class="literal">callGameOver()</code> to end the round. Close the <code class="literal">myTimer()</code> function with <code class="literal">end</code>.<div class="informalexample"><pre class="programlisting">if numSeconds &lt; 1 or stars.numChildren &lt;= 0 then
timer.cancel(timerInfo)
panda:pause()
restartTimer = timer.performWithDelay( 300, function() callGameOver(); end, 1 )
end
end
</pre></div></li><li class="listitem">Initiate the <code class="literal">myTimer()</code> function with a new local function called <code class="literal">startTimer()</code>. This will start the countdown at the beginning of gameplay.<div class="informalexample"><pre class="programlisting">local startTimer = function()
print("Start Timer")
timerInfo = timer.performWithDelay( 1000, myTimer, 0 )
end
</pre></div></li></ol></div><div class="section" title="What just happened?"><div class="titlepage"><div><div><h2 class="title"><a id="ch05lvl2sec13"/>What just happened?</h2></div></div></div><p>The main timer function is within <code class="literal">myTimer()</code>. We countdown the seconds using <code class="literal">numSeconds = numSeconds -1</code>. The seconds will update in the <code class="literal">counter</code> display object. <code class="literal">print(numSeconds)</code> will be updated in the terminal window to see how fast the countdown runs inside the code.<a id="id387" class="indexterm"/>
</p><p>When time runs out or all stars have been collected, an <code class="literal">if</code> statement is created to check if any of the arguments are <code class="literal">true</code>. When any statement evaluates to <code class="literal">true</code>, the timer stops counting down, the panda animation pauses, and the <code class="literal">callGameOver()</code> function is called. This will call the function to display the game over screen.</p><p>The timer initiates the countdown through <code class="literal">local startTimer = function()</code> at a rate of 1000 milliseconds, which is equivalent to 1 second.</p></div></div>
<div class="section" title="It's so glowy"><div class="titlepage"><div><div><h1 class="title"><a id="ch05lvl1sec23"/>It's so glowy</h1></div></div></div><p>The panda needs another element that will display how much force is added before it launches into the sky. We're going to add a subtle glow-like display object that will represent that.<a id="id388" class="indexterm"/>
</p></div>
<div class="section" title="Time for action&#x2014;making the power shot"><div class="titlepage"><div><div><h1 class="title"><a id="ch05lvl1sec24"/>Time for action—making the power shot</h1></div></div></div><p>We need to create a separate function for the <code class="literal">powerShot</code> so it can be called when the panda is set for launch.<a id="id389" class="indexterm"/>
</p><div class="orderedlist"><ol class="orderedlist"><li class="listitem">Display the <code class="literal">powerShot</code> object through a new local function called <code class="literal">createPowerShot()</code>. Insert it into the <code class="literal">gameGroup</code> group.<div class="informalexample"><pre class="programlisting">local createPowerShot = function()
powerShot = display.newImage( "glow.png" )
powerShot.xScale = 1.0; powerShot.yScale = 1.0
powerShot.isVisible = false
gameGroup:insert( powerShot )
end
</pre></div></li></ol></div><div class="section" title="What just happened?"><div class="titlepage"><div><div><h2 class="title"><a id="ch05lvl2sec14"/>What just happened?</h2></div></div></div><p>The <code class="literal">powerShot</code> object is created through the <code class="literal">createPowerShot()</code> function and is called when the panda is setting up for launch.</p></div></div>
<div class="section" title="Pandas!"><div class="titlepage"><div><div><h1 class="title"><a id="ch05lvl1sec25"/>Pandas!</h1></div></div></div><p>It will be exciting to see something animated on screen for once. Our main character will have designated animations for every action applied during gameplay.<a id="id390" class="indexterm"/>
</p></div>
<div class="section" title="Time for action&#x2014;creating the panda character"><div class="titlepage"><div><div><h1 class="title"><a id="ch05lvl1sec26"/>Time for action—creating the panda character</h1></div></div></div><p>We need to set up the panda collision event and animate it with the sprite sheet accordingly.<a id="id391" class="indexterm"/>
</p><div class="orderedlist"><ol class="orderedlist"><li class="listitem">We need to create a local function that will introduce the collision and touch events for the panda. We shall call it <code class="literal">createPanda()</code>.<div class="informalexample"><pre class="programlisting">local createPanda = function()
</pre></div></li><li class="listitem">When the panda collides with the stars, use <code class="literal">onPandaCollision()</code> with the parameters <code class="literal">self</code> and <code class="literal">event</code>. Reload <code class="literal">panda</code> every time a collision occurs with the stars or the edge of the screen by using <code class="literal">callNewRound()</code>.<div class="informalexample"><pre class="programlisting">local onPandaCollision = function( self, event )
if event.phase == "began" then
if panda.isHit == false then
panda.isHit = true
if event.other.myName == "star" then
callNewRound( true, "yes" )
else
callNewRound( true, "no" )
end
if event.other.myName == "wall" then
callNewRound( true, "yes" )
else
callNewRound( true, "no" )
end
elseif panda.isHit then
return true
end
end
end
</pre></div></li><li class="listitem">Create a directional arrow to allow the user to aim for an area to launch the panda. Insert it into the <code class="literal">gameGroup</code> group.<div class="informalexample"><pre class="programlisting">arrow = display.newImage( "arrow.png" )
arrow.x = 240; arrow.y = 225
arrow.isVisible = false
gameGroup:insert( arrow )
</pre></div></li><li class="listitem">Create the sprite sheet for the <code class="literal">panda</code> display object that has three different animation sequences called<code class="literal">"set", "crouch"</code>, and<code class="literal">"air"</code>.<a id="id392" class="indexterm"/><div class="informalexample"><pre class="programlisting">local pandaSheet = sprite.newSpriteSheet( "pandaSprite.png", 128, 128 )
local spriteSet = sprite.newSpriteSet(pandaSheet, 1, 5)
sprite.add( spriteSet, "set", 1, 2, 200, 0 )
sprite.add( spriteSet, "crouch", 3, 1, 1, 0 )
sprite.add( spriteSet, "air", 4, 2, 100, 0 )
panda = sprite.newSprite( spriteSet )
panda:prepare("set")
panda:play()
</pre></div></li><li class="listitem">Add properties to <code class="literal">panda</code> before it launches into the air.<div class="informalexample"><pre class="programlisting">panda.x = 240; panda.y = 225
panda.isVisible = false
panda.isReady = false
panda.inAir = false
panda.isHit = false
panda.isBullet = true
panda.trailNum = 0
panda.radius = 12
physics.addBody( panda, "static", { density=1.0, bounce=0.4, friction=0.15, radius=panda.radius } )
panda.rotation = 0
</pre></div></li><li class="listitem">Set up collisions for <code class="literal">panda</code> using<code class="literal">"collision"</code> and apply an event listener.<div class="informalexample"><pre class="programlisting">panda.collision = onPandaCollision
panda:addEventListener( "collision", panda )
</pre></div></li><li class="listitem">Create the <code class="literal">poof</code> object.<div class="informalexample"><pre class="programlisting">poof = display.newImage( "poof.png" )
poof.alpha = 1.0
poof.isVisible = false
</pre></div></li><li class="listitem">Insert the <code class="literal">panda</code> and <code class="literal">poof</code> into the <code class="literal">gameGroup</code> group. Close the function.<div class="informalexample"><pre class="programlisting">gameGroup:insert( panda )
gameGroup:insert( poof )
end
</pre></div></li><li class="listitem">We'll need to scroll up to the <code class="literal">activateRound()</code> function and add the<code class="literal">"set"</code> animation sequence for the panda.<a id="id393" class="indexterm"/><div class="informalexample"><pre class="programlisting">panda:prepare("set")
panda:play()
</pre></div></li></ol></div><div class="section" title="What just happened?"><div class="titlepage"><div><div><h2 class="title"><a id="ch05lvl2sec15"/>What just happened?</h2></div></div></div><p>The collision events that occur for the panda start with <code class="literal">if event.phase == "began"</code>. The panda reloads on screen through several cases of <code class="literal">if</code> statements. <code class="literal">event.other.myName == "star"</code> will call a new round as well as when the panda launches off screen towards the right, left, or top sides of the stage.</p><p>The sprite sheet for the panda has three sets of animations. They are called<code class="literal">"set", "air"</code>, and<code class="literal">"crouch"</code>. There are a total of five frames in the sprite sheet.</p><p>The physical properties of the panda are set before launch. The body type is set to<code class="literal">"static"</code> and will change when it's in the air.</p><p>The collision event for the panda is called by <code class="literal">panda:addEventListener( "collision", panda )</code>.</p><p>Now that the sprite sheet is set up, the<code class="literal">"set"</code> animation needs to be added in the <code class="literal">activateRound()</code> function to initiate movement.</p></div></div>
<div class="section" title="Starry skies"><div class="titlepage"><div><div><h1 class="title"><a id="ch05lvl1sec27"/>Starry skies</h1></div></div></div><p>The stars play a big part in the game. It is the main obstacle that the panda has to get past to achieve points before the clock runs out.</p></div>
<div class="section" title="Time for action&#x2014;creating star collisions"><div class="titlepage"><div><div><h1 class="title"><a id="ch05lvl1sec28"/>Time for action—creating star collisions</h1></div></div></div><p>Star collisions need to be made and removed from the stage so points can be accumulated for the player.<a id="id394" class="indexterm"/>
</p><div class="orderedlist"><ol class="orderedlist"><li class="listitem">Create a function for the star collision called <code class="literal">onStarCollision()</code> and have a <code class="literal">self</code> and <code class="literal">event</code> parameter.<div class="informalexample"><pre class="programlisting">local onStarCollision = function( self, event )
</pre></div></li><li class="listitem">Add in <code class="literal">if</code> statements that removes the <code class="literal">stars</code> children from the game screen when a collision is made. Increment the score by 500 for each star removed on screen. Close the function with <code class="literal">end.</code><a id="id395" class="indexterm"/><div class="informalexample"><pre class="programlisting">if event.phase == "began" and self.isHit == false then
self.isHit = true
print( "star destroyed!")
self.isVisible = false
self.isBodyActive = false
stars.numChildren = stars.numChildren - 1
if stars.numChildren &lt; 0 then
stars.numChildren = 0
end
self.parent:remove( self )
self = nil
local newScore = gameScore + 500
setScore( newScore )
end
end
</pre><div class="mediaobject"><img src="graphics/1888_05_05.jpg" alt="Time for action—creating star collisions"/></div></div></li></ol></div><div class="section" title="What just happened?"><div class="titlepage"><div><div><h2 class="title"><a id="ch05lvl2sec16"/>What just happened?</h2></div></div></div><p>The star collision occurs on first contact with <code class="literal">if event.phase == "began"</code> and <code class="literal">self.isHit == false</code> assuming the star has not been touched by the panda. The stars are removed from the screen by <code class="literal">self.parent:remove( self )</code> and <code class="literal">self = nil</code>. The score is incremented by 500 through <code class="literal">gameScore</code> and updated to <code class="literal">setScore = (scoreNum)</code>.<a id="id396" class="indexterm"/>
</p></div><div class="section" title="Have a go hero—tracking the star count"><div class="titlepage"><div><div><h2 class="title"><a id="ch05lvl2sec17"/>Have a go hero—tracking the star count</h2></div></div></div><p>Try tracking how many stars the panda has caught during gameplay. The logic is similar to how the game score was created. Each star caught will have to increment by 1 as the count for every collision made. The star count is placed within the <code class="literal">onStarCollision()</code> function. A new function and method will have to be created to display the text of the star count and will have to be updated every time the count changes.</p></div></div>
<div class="section" title="Screen touches"><div class="titlepage"><div><div><h1 class="title"><a id="ch05lvl1sec29"/>Screen touches</h1></div></div></div><p>The way the panda will get across the playing field to reach the stars is by creating a launch mechanic similar to a slingshot. Force will play a big role to push the panda in an upward motion.</p></div>
<div class="section" title="Time for action&#x2014;launching the panda"><div class="titlepage"><div><div><h1 class="title"><a id="ch05lvl1sec30"/>Time for action—launching the panda</h1></div></div></div><p>Let's add a touch event for the panda so that it flings towards the stars. The <code class="literal">powerShot</code> object will play a role by helping the player visualize how much power is applied to the panda before it launches into the air.<a id="id397" class="indexterm"/>
</p><div class="orderedlist"><ol class="orderedlist"><li class="listitem">Implement touch events for the panda. Create a local function called <code class="literal">onScreenTouch()</code> with an event parameter.<div class="informalexample"><pre class="programlisting">local onScreenTouch = function( event )
</pre></div></li><li class="listitem">With <code class="literal">gameIsActive</code> initiated, add in an <code class="literal">if</code> statement for when the touch event starts by using <code class="literal">event.phase == "began"</code>. During this event, use the<code class="literal">"crouch"</code> animation set to prepare panda for launch.<div class="informalexample"><pre class="programlisting">if gameIsActive then
if event.phase == "began" and panda.inAir == false then
panda.y = 225
panda.isReady = true
powerShot.isVisible = true
powerShot.alpha = 0.75
powerShot.x = panda.x; powerShot.y = panda.y
powerShot.xScale = 0.1; powerShot.yScale = 0.1
arrow.isVisible = true
panda:prepare("crouch")
panda:play()
</pre></div></li><li class="listitem">Add an <code class="literal">elseif</code> statement for when the touch event ends by using <code class="literal">event.phase == "ended"</code>. Create a new local function called <code class="literal">fling()</code> that will hold the properties of <code class="literal">panda</code> when it is launched toward the <code class="literal">star</code> objects. Apply a force opposite of where the touch event is dragged. Scale the <code class="literal">powerShot</code> display object outward when the touch event is pulled farther from the character.<a id="id398" class="indexterm"/><div class="informalexample"><pre class="programlisting">elseif event.phase == "ended" and panda.isReady then
local fling = function()
powerShot.isVisible = false
arrow.isVisible = false
local x = event.x
local y = event.y
local xForce = (panda.x-x) * 4
local yForce = (panda.y-y) * 4
panda:prepare("air")
panda:play()
panda.bodyType = "dynamic"
panda:applyForce( xForce, yForce, panda.x, panda.y )
panda.isReady = false
panda.inAir = true
end
transition.to( powerShot, { time=175, xScale=0.1, yScale=0.1, onComplete=fling} )
end
if powerShot.isVisible == true then
local xOffset = panda.x
local yOffset = panda.y
local distanceBetween = mCeil(mSqrt( ((event.y - yOffset) ^ 2) + ((event.x - xOffset) ^ 2) ))
powerShot.xScale = -distanceBetween * 0.02
powerShot.yScale = -distanceBetween * 0.02
local angleBetween = mCeil(mAtan2( (event.y - yOffset), (event.x - xOffset) ) * 180 / mPi) + 90
panda.rotation = angleBetween + 180
arrow.rotation = panda.rotation
end
end
end
</pre><div class="mediaobject"><img src="graphics/1888_05_06.jpg" alt="Time for action—launching the panda"/></div></div></li></ol></div><div class="section" title="What just happened?"><div class="titlepage"><div><div><h2 class="title"><a id="ch05lvl2sec18"/>What just happened?</h2></div></div></div><p>Once the game is active and the panda has been loaded on the screen, a touch event to launch the panda can begin. The panda will go from a<code class="literal">"static"</code> physics state to a<code class="literal">"dynamic"</code> physics state. The <code class="literal">powerShot</code> display object size increases, the farther back the panda is pulled by an event touch.<a id="id399" class="indexterm"/>
</p><p>The force from the panda launch is applied by <code class="literal">local fling = function()</code>. Force launch is created by <code class="literal">xForce</code> and <code class="literal">yForce</code>. The panda object is propelled by <code class="literal">panda:applyForce( xForce, yForce, panda.x, panda.y )</code>. Notice that the body type changes to<code class="literal">"dynamic"</code> so gravity can affect the object.<a id="id400" class="indexterm"/>
</p></div></div>
<div class="section" title="Organizing display objects"><div class="titlepage"><div><div><h1 class="title"><a id="ch05lvl1sec31"/>Organizing display objects</h1></div></div></div><p>When the round has been set, the display hierarchy of the game objects needs to be rearranged. The objects of most importance are displayed towards the front of the screen.<a id="id401" class="indexterm"/>
</p></div>
<div class="section" title="Time for action&#x2014;reordering layers"><div class="titlepage"><div><div><h1 class="title"><a id="ch05lvl1sec32"/>Time for action—reordering layers</h1></div></div></div><div class="orderedlist"><ol class="orderedlist"><li class="listitem">A new local function, <code class="literal">reorderLayers()</code> needs to be created to organize the display hierarchy of objects on screen during gameplay.<a id="id402" class="indexterm"/><div class="informalexample"><pre class="programlisting">local reorderLayers = function()
gameGroup:insert( levelGroup )
ground:toFront()
panda:toFront()
poof:toFront()
hudGroup:toFront()
end
</pre></div></li></ol></div><div class="section" title="What just happened?"><div class="titlepage"><div><div><h2 class="title"><a id="ch05lvl2sec19"/>What just happened?</h2></div></div></div><p>The <code class="literal">gameGroup, hudGroup</code>, and other display objects are reorganized in the display hierarchy of the game screen. The most significant object is set to the front, while the least important one is towards the back.</p></div></div>
<div class="section" title="Create stars"><div class="titlepage"><div><div><h1 class="title"><a id="ch05lvl1sec33"/>Create stars</h1></div></div></div><p>The stars will fill the game so that the panda can catch as many as possible. The skies will surely be full of them.<a id="id403" class="indexterm"/>
</p></div>
<div class="section" title="Time for action&#x2014;creating stars in the level"><div class="titlepage"><div><div><h1 class="title"><a id="ch05lvl1sec34"/>Time for action—creating stars in the level</h1></div></div></div><p>We need to add the layout of the stars in the game and have them moving to add a little effect that they're active. A collision event will need to be applied so they are removed when the panda collides with them.<a id="id404" class="indexterm"/>
</p><div class="orderedlist"><ol class="orderedlist"><li class="listitem">Create a new function called <code class="literal">createStars()</code> and lay out the <code class="literal">star</code> objects in a <code class="literal">for</code> loop. Add in the<code class="literal">"collision"</code> event that will be called by <code class="literal">onStarCollision()</code> to remove the stars when they are hit by the panda. Rotate the stars forwards and backwards at 10 seconds and 1080 and -1080 degrees each. This will allow the stars to rotate three full intervals backwards and forwards. Create the walls for the left and right side of the screen.<div class="informalexample"><pre class="programlisting">local createStars = function()
starsstarscreating, in levellocal numOfRows = 4
local numOfColumns = 12
local starPlacement = {x = (display.contentWidth * 0.5) - (starWidth * numOfColumns ) / 2 + 10, y = 50}
for row = 0, numOfRows - 1 do
for column = 0, numOfColumns - 1 do
-- Create a star
local star = display.newImage("star.png")
star.name = "star"
star.isHit = false
star.x = starPlacement.x + (column * starWidth)
star.y = starPlacement.y + (row * starHeight)
physics.addBody(star, "static", {density = 1, friction = 0, bounce = 0})
stars.insert(stars, star)
star.collision = onStarCollision
star:addEventListener( "collision", star )
local function starAnimation()
local starRotation = function()
transition.to( star, { time=10000, rotation = 1080, onComplete=starAnimation })
end
transition.to( star, { time=10000, rotation = -1080, onComplete=starRotation })
end
starAnimation()
end
end
local leftWall = display.newRect (0, 0, 0, display.contentHeight)
leftWall.name = "wall"
local rightWall = display.newRect (display.contentWidth, 0, 0, display.contentHeight)
rightWall.name = "wall"
physics.addBody (leftWall, "static", {bounce = 0.0, friction = 10})
physics.addBody (rightWall, "static", {bounce = 0.0, friction = 10})
reorderLayers()
end
</pre></div></li></ol></div><div class="section" title="What just happened?"><div class="titlepage"><div><div><h2 class="title"><a id="ch05lvl2sec20"/>What just happened?</h2></div></div></div><p>The amount of stars displayed on screen is set by <code class="literal">numOfRows</code> and <code class="literal">numOfColumns</code>. A <code class="literal">for</code> loop is made to display each individual star object and placed in the <code class="literal">stars</code> group. The collision for <code class="literal">star</code> is detected by an event listener through <code class="literal">onStarCollision()</code>.<a id="id406" class="indexterm"/>
</p><p>
<code class="literal">leftWall</code> and <code class="literal">rightWall</code> have physical properties as well and will take into account the collision detection with the panda.</p><p>The stars are animated by <code class="literal">starAnimation()</code> and <code class="literal">starRotation()</code>. Each function rotates each star object for 10 seconds (10000 milliseconds), and alternates between 1080 and -1080 degrees.</p></div><div class="section" title="Have a go hero—creating a movieclip"><div class="titlepage"><div><div><h2 class="title"><a id="ch05lvl2sec21"/>Have a go hero—creating a movieclip</h2></div></div></div><p>Right now the stars have some movement by rotating simultaneously. Try adding some more characteristics to the image by having them change in a variety of sizes. This can be done by making a series of the same image and changing the size of the asset itself, not the image size. An image manipulation software program will be needed to accomplish this. Create as many images you see fit, and set them into a movieclip function. Let it run during gameplay.<a id="id407" class="indexterm"/>
</p></div></div>
<div class="section" title="Starting the game"><div class="titlepage"><div><div><h1 class="title"><a id="ch05lvl1sec35"/>Starting the game</h1></div></div></div><p>The game starts when the clock starts counting down and the panda is loaded on the screen. Once the panda is set on screen, the player needs to aim and launch it quickly so reloading of the panda can occur immediately.<a id="id408" class="indexterm"/>
</p></div>
<div class="section" title="Time for action&#x2014;initializing the game"><div class="titlepage"><div><div><h1 class="title"><a id="ch05lvl1sec36"/>Time for action—initializing the game</h1></div></div></div><p>The physics and remaining game functions need to be initialized to run the game. All game actions need to be delayed until the<span class="strong"><strong> Help</strong></span> screen has left the stage.<a id="id409" class="indexterm"/>
</p><div class="orderedlist"><ol class="orderedlist"><li class="listitem">Start the game by creating a new function called <code class="literal">gameInit()</code> that will hold the <code class="literal">physics</code> properties and activate the display objects on the stage.<div class="informalexample"><pre class="programlisting">local gameInit = function()
physics.start( true )
physics.setGravity( 0, 9.8 )
drawBackground()
createPowerShot()
createPanda()
createStars()
hud()
</pre></div></li><li class="listitem">Add in a <code class="literal">Runtime</code> event listener using<code class="literal">"touch"</code> for <code class="literal">onScreenTouch()</code>.<div class="informalexample"><pre class="programlisting">Runtime:addEventListener( "touch", onScreenTouch )
</pre></div></li><li class="listitem">Have the level and timer start 10 seconds later so the user has time to read through the help text. Close the function and start the game with <code class="literal">gameInit()</code>.<div class="informalexample"><pre class="programlisting">local gameTimer = timer.performWithDelay( 10000, function() startNewRound(); end, 1 )
local gameTimer = timer.performWithDelay( 10000, function() startTimer(); end, 1 )
end
gameInit()
</pre></div></li></ol></div><p>All the code is complete! Run the game in the simulator and see for yourself how it works.</p><div class="section" title="What just happened?"><div class="titlepage"><div><div><h2 class="title"><a id="ch05lvl2sec22"/>What just happened?</h2></div></div></div><p>The round is initialized through <code class="literal">gameInit()</code>. The physics engine and remaining functions are run at this time. The event listener for <code class="literal">onScreenTouch()</code> is added as well. The <code class="literal">startNewRound()</code> and <code class="literal">startTimer()</code> functions initiate 10 seconds after launching the application through <code class="literal">timer.performWithDelay</code>.</p></div><div class="section" title="Pop quiz—animating graphics"><div class="titlepage"><div><div><h2 class="title"><a id="ch05lvl2sec23"/>Pop quiz—animating graphics</h2></div></div></div><div class="orderedlist"><ol class="orderedlist"><li class="listitem">What is the proper way to stop the animation of a sprite sheet?<div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: none">a. <code class="literal">sprite:stop()</code></li><li class="listitem" style="list-style-type: none">b. <code class="literal">sprite:pause()</code></li><li class="listitem" style="list-style-type: none">c. <code class="literal">sprite:dispose()</code></li><li class="listitem" style="list-style-type: none">d. None of the above</li></ul></div></li><li class="listitem">How do you make a movieclip animation loop forever?<div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: none">a. <code class="literal">myAnimation:play{ startFrame=1, endFrame=4, loop=1, remove=true }</code></li><li class="listitem" style="list-style-type: none">b. <code class="literal">myAnimation:play{ startFrame=1, endFrame=4, loop=-1, remove=true }</code></li><li class="listitem" style="list-style-type: none">c. <code class="literal">myAnimation:play{ startFrame=1, endFrame=4, loop=0, remove=true }</code></li><li class="listitem" style="list-style-type: none">d. <code class="literal">myAnimation:play{ startFrame=1, endFrame=4, loop=100, remove=true }</code></li></ul></div></li><li class="listitem">How do you create a new sprite sheet?<div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: none">a. <code class="literal">spriteSheet = sprite.newSpriteSheetFromData( "myImage.png", spriteData )</code></li><li class="listitem" style="list-style-type: none">b. <code class="literal">spriteSheet = sprite.newSpriteSheetFromData( "myImage.png", spriteSet )</code></li><li class="listitem" style="list-style-type: none">c. <code class="literal">spriteSheet = sprite.newSpriteSheet("myImage.png", frameWidth, frameHeight)</code></li><li class="listitem" style="list-style-type: none">d. None of the above</li></ul></div></li></ol></div></div></div>
<div class="section" title="Summary"><div class="titlepage"><div><div><h1 class="title"><a id="ch05lvl1sec37"/>Summary</h1></div></div></div><p>Our second game, Panda Star Catcher is finally completed! We're now getting a great grasp on writing more functions and different types of game logic. Now we have animation under our belt! Way to go!</p><p>We looked at:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">Transitions and applying easing techniques in more depth</li><li class="listitem" style="list-style-type: disc">Understanding the difference between movieclips and sprite sheets</li><li class="listitem" style="list-style-type: disc">Creating a game loop for display objects that have to be reloaded continuously on screen</li><li class="listitem" style="list-style-type: disc">Applying force to a display object that propels it towards a designated direction</li><li class="listitem" style="list-style-type: disc">Adding a collision event that switches from one display object to another</li></ul></div><p>We have pushed through making another game in one whole chapter! Working in Corona SDK is so simple and fast to learn. It doesn't even require thousands of lines of code to create a simple game.</p><p>In the next chapter, we'll be learning another vital element in creating games, sound effects,and music! You're in for a treat.</p></div></body></html>