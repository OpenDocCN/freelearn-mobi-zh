<html><head></head><body><div><div><div><div><h1 class="title"><a id="ch04"/>Chapter 4. Using Remote Data and Media</h1></div></div></div><p>
<em>While creating a LiveCode application, we need to think about the structure of the stack, its code, and the data it uses. Applications can be made when all the supporting data is within the application, but quite often, we want to display data that is out in the real world somewhere and also want to save information (a high-score list perhaps) to text files that are external to the application. You may also want to share information with other people or sync between apps or devices.</em>
</p><p>In this chapter, we will:</p><div><ul class="itemizedlist"><li class="listitem">Look at the various ways a stack might be structured</li><li class="listitem">Think about where code should go</li><li class="listitem">Write to and read from external text files</li><li class="listitem">Create a scrapbook-like app to remember interesting Internet-based media files</li></ul></div><div><h3 class="title"><a id="tip08"/>Tip</h3><p>Do you want to save time typing code?</p><p>There are a lot of lines of code in this chapter. The code is shown along with explanations of each function and you could use this code to build up something that matches the corresponding sample file. However, it would be very easy to make a mistake while transcribing the scripts, both in terms of what the script says and where the script should be placed. It may be safer to study the sample files and read the overall description here. You can download the code from the Packt Publishing website at <a class="ulink" href="https://www.packtpub.com/books/content/support">https://www.packtpub.com/books/content/support</a>.</p></div><div><div><div><div><h1 class="title"><a id="ch04lvl1sec50"/>The stack structure</h1></div></div></div><p>There are <a id="id263" class="indexterm"/>two aspects to how the stack may be structured. One is about how user interface elements are organized and the other is about where in the hierarchy of a stack you should place your code. The first addresses how to make the app understandable, logical, and easy to use. The second addresses how to minimize development time, subsequent maintenance effort, and how to maximize the resulting performance of the app.</p><div><div><div><div><h2 class="title"><a id="ch04lvl2sec75"/>Code-driven and manually created layouts</h2></div></div></div><p>When you <a id="id264" class="indexterm"/>imagine how a typical mobile application appears, it would be somewhat along these lines:</p><div><img src="img/image00268.jpeg" alt="Code-driven and manually created layouts"/></div><p style="clear:both; height: 1em;"> </p><p>Sometimes, applications are entirely code-driven where every screen you see is created using code at the time <a id="id265" class="indexterm"/>that it's needed. Perhaps, it would already lay out the elements that are saved as resources and then the code would load these resources. In either case, the whole application could take place on the equivalent of one LiveCode card.</p><p>Another approach would be to lay out every possible screen combination as different cards or even stacks and to go to the card or stack that looks like how the app appears at that moment.</p><p>In the first case, you would need to run the application and go through the user actions in order to check whether the layout was correct. Then, you would need to go back and change the code or resources and try again. In the second case, you may face a lot of combinations of layout.</p><p>As we start making apps here, we'll try to find a middle ground where we'll use cards to set up the main screens we'll need and then we'll use code to show and hide other elements. Our goal is to <a id="id266" class="indexterm"/>try and be efficient and not create complex code to lay out items that could be laid out quickly by hand. We also don't want to use a lot of images when a small amount of code could get us the same results.</p></div><div><div><div><div><h2 class="title"><a id="ch04lvl2sec76"/>Locations for code</h2></div></div></div><p>LiveCode is extremely flexible in terms of how you structure things that you make with it. In addition to a dozen <a id="id267" class="indexterm"/>different kinds of controls that could contain code, you can also control front scripts, groups, the current card, a mainstack, stacks in use, back script, and LiveCode itself. The following diagram shows you only a few example controls, but gives you the sense of how many levels there are to the hierarchy of LiveCode:</p><div><img src="img/image00269.jpeg" alt="Locations for code"/></div><p style="clear:both; height: 1em;"> </p><p>You can also have sub <a id="id268" class="indexterm"/>stacks that are often used to show dialog windows, the ability to add front and back scripts, and you can put stacks in and out of use too. Overall, it can get quite confusing!</p><p>It is largely a case of personal style as to where you put your scripts and often, you may have a reasonable argument why you did it in a certain way. You could argue that all the actions that take place should be in the script of the button you clicked on. It would make it easy to edit all the handlers involved and if you need the same features in another stack, you would only have to copy the button across. However, if you had a number of those buttons on the screen and needed to make changes, you would have to do so for all of them.</p><p>Another valid argument would be to say that all handlers are at the stack level. You would then have one central place to make changes, but you would have to make lots of <code class="literal">if</code> statements to check which control has been operated on.</p><p>You might want to reuse routines that you have developed over time and would have a set of stacks that you could put into use, where each stack just handles a particular aspect of the task at hand. In the <a id="id269" class="indexterm"/>world of <strong>Object-oriented Programming</strong> (<strong>OOP</strong>), it's quite common to extend this approach to a crazy degree with <a id="id270" class="indexterm"/>hundreds or even thousands of small files where each file handles a tiny portion of the overall application.</p><p>We won't go to any of these extremes. Instead, we will try to put code at the lowest level that it needs to be without duplicating the code, as you make additional controls that need the same code. While doing this, we will try to think ahead and spot efficiencies that we can use. Let's look at an example.</p><p>Suppose you have a main menu button and its function is to take the user back to the card named <code class="literal">main</code>. Having this as the button's script would make sense:</p><div><pre class="programlisting">on mouseUp
  go card "main"
end mouseUp</pre></div><p>It would appear to be the lowest level the code can be at and we're not going to duplicate it, as there's just one main menu button. However, suppose we want to track the user's progress, the main menu button won't know anything about that. So, we could do this instead:</p><div><pre class="programlisting">on mouseUp
  navTo "main"
end mouseUp</pre></div><p>In the card script, there would be this handler:</p><div><pre class="programlisting">on navTo aCard
  saveNavState
  go card aCard
end navTo</pre></div><p>The <code class="literal">saveNavState</code> function would be somewhere, saving the user's state. The only problem is that for each of the cards we make, which includes the main menu button, we will have to have this <code class="literal">navTo</code> handler in each of their scripts. Therefore, we'll put the handler in the mainstack stack script. With it being at this level, it can handle calls from any button on any card. The help button's script could be this:</p><div><pre class="programlisting">on mouseUp
  navTo "help"
end mouseUp</pre></div><p>Going to the help card would also save the user's state. Later, we could also add a visual effect as you jump from <a id="id271" class="indexterm"/>place to place and make that change in <code class="literal">navTo</code> instead of going around the various buttons that make use of the <code class="literal">navTo</code> handler.</p></div><div><div><div><div><h2 class="title"><a id="ch04lvl2sec77"/>Pop quiz – name that structure</h2></div></div></div><p>There is a common term used to describe the LiveCode hierarchy that helps convey how information is passed up and down the hierarchy. What is that term called?</p><div><ol class="orderedlist arabic"><li class="listitem">The Event Horizon</li><li class="listitem">The Message Path</li><li class="listitem">The Call Stack</li><li class="listitem">The Home Stack</li></ol><div></div><p>Answer: 2</p><p>For further reading, RunRev <a id="id272" class="indexterm"/>has an online lesson that describes the message path, which you can find at:</p><p>
<a class="ulink" href="http://lessons.runrev.com/s/lessons/m/4603/l/44036-the-livecode-message-path">http://lessons.runrev.com/s/lessons/m/4603/l/44036-the-livecode-message-path</a>
</p></div></div></div>
<div><div><div><div><h1 class="title"><a id="ch04lvl1sec51"/>Loading and saving external data</h1></div></div></div><p>In many <a id="id273" class="indexterm"/>applications, you will want to keep track of <a id="id274" class="indexterm"/>changes that a user has made. There are <a id="id275" class="indexterm"/>several ways to do this with LiveCode, including querying a <a id="id276" class="indexterm"/>URL, reading and writing to a text file, and saving data inside a stack.</p><div><div><div><div><h2 class="title"><a id="ch04lvl2sec78"/>Querying a URL</h2></div></div></div><p>Quite often, web-based <a id="id277" class="indexterm"/>applications load and save data <a id="id278" class="indexterm"/>from server-side scripts. This can work with LiveCode apps too. Here's an example which shows the closing share price for Google yesterday:</p><div><pre class="programlisting">
<strong>put url "http://quote.yahoo.com/d/quotes.csv?s=GOOG&amp;f=p"</strong>
</pre></div><p>At the moment of writing this book, this line was tested and <code class="literal">609.46</code> appeared in the <strong>Message Box,</strong> shown as follows:</p><div><img src="img/image00270.jpeg" alt="Querying a URL"/></div><p style="clear:both; height: 1em;"> </p><p>Who knows what you'll find when you try it! In fact, while doing the second revision of this book, the number that popped up was 1172.9301. Go Google!</p><p>As with any such calls to an online service, there is a chance that it may take some time for the value to return, and in the preceding example, LiveCode would be blocked from doing anything else until the data returns. An alternate approach for this, is to load the URL in order to <a id="id279" class="indexterm"/>cache it and then display the results when <a id="id280" class="indexterm"/>it is cached. LiveCode would be able to do other actions while the data returns. A button script would look like this:</p><div><pre class="programlisting">on mouseUp
  unload url "http://quote.yahoo.com/d/quotes.csv?s=GOOG&amp;f=p"
  load url "http://quote.yahoo.com/d/quotes.csv?s=GOOG&amp;f=p" with message "gotit"
end mouseUp

on gotit addr, state
  if state is "cached" or state is "downloaded" then
    answer url addr
  else
    answer state
  end if
end gotit</pre></div><p>The <code class="literal">gotit</code> handler also checks whether the call worked fine and if it didn't, it will display the error that caused the problem. The <code class="literal">unload</code> line is used to make sure that you're not reading the previously cached value. If it's a value that only changes infrequently, as with the closing price of a stock, then you would usually only clear the cached version when it's likely to be changed. For this example, that might be the next day.</p><p>Posting data works in the same way. A game that sends your score to the server can do it this way:</p><div><pre class="programlisting">on sendscore username,score
  put url "http://www.mysite.com/hiscores/savescore.php?user=" &amp; username &amp; "&amp;score=" &amp; score into err
  if err is not "ok" then answer err
end sendscore</pre></div><p>If <code class="literal">username</code> or any other parts of the posted data contain space characters, you should use <code class="literal">URLEncode</code> in the location first. Doing so will convert spaces and other special characters into codes that will safely <a id="id281" class="indexterm"/>arrive at the destination URL. The <a id="id282" class="indexterm"/>following would be a safer variation of the preceding code:</p><div><pre class="programlisting">on sendscore username,score
  put "http://www.mysite.com/hiscores/savescore.php?user=" &amp; username &amp; "&amp;score=" &amp; score into tPostAddress
put url URLEncode(tPostAddress) into err
  if err is not "ok" then answer err
end sendscore</pre></div></div><div><div><div><div><h2 class="title"><a id="ch04lvl2sec79"/>Reading and writing to a text file</h2></div></div></div><p>Back in the days of <a id="id283" class="indexterm"/>HyperCard, the only real choice to save and load external data was to write a text file. LiveCode can of course do that too, and in <a id="id284" class="indexterm"/>some cases, it may be the simplest solution. Configuration and preference files are a couple of good examples where a small text file <a id="id285" class="indexterm"/>can be used to set up the application in the way the user wishes it to be.</p><p>As an example, say we <a id="id286" class="indexterm"/>have configuration text files named <code class="literal">englishstrings.txt</code> and <code class="literal">frenchstrings.txt</code> that were included in the <strong>Copy Files</strong> list of the <strong>Standalone Application Settings</strong> dialog box and they are going to be <a id="id287" class="indexterm"/>used to set the button's names in English or French within your application. Also, we'll want to write a preferences file to remember the user's choice. When the app is opened, we would check what the preferences file says and then load the appropriate strings file.</p><div><h3 class="title"><a id="note09"/>Note</h3><p>With mobile operating systems, iOS in particular, there are strict rules about where you are allowed to save data. As we move forward, we will use locations that are approved for such use by Apple and Google.</p></div><p>The text files that you include in a mobile app will be in the same location as the app itself, and the text files that you want to write to, should be in the <code class="literal">documents</code> folder of your app. Because these paths look quite different in iOS and Android, we should use LiveCode's <code class="literal">specialFolderPath</code> function to locate these folders. Here's how an <code class="literal">openStack</code> handler would check whether the preferences have been set and if not, would take the user to an initial language choice screen:</p><div><pre class="programlisting">on openStack
  global langstrings
  put "file:" &amp; specialFolderPath("documents") &amp; "/prefs.txt" into prefsfile
  put url prefsfile into prefstext
  if prefstext is empty then
    -- prefs have never been set, so go to the language choice card
    go card "language choice"
  else
    -- language has previously been chosen, so we load up the right file
    put "file:" &amp; specialFolderPath("engine") &amp; prefstext &amp; "strings.txt" into langfile
    put url langfile into langstrings
  end if
end openStack</pre></div><p>The special <strong>engine</strong> folder path is in the same location as the application file and the supporting files that you included in the <strong>Copy Files</strong> section of the <strong>Standalone Application Settings</strong> dialog box (as described in the <em>Copy Files</em> section of <a class="link" title="Chapter 7. Deploying to Your Device" href="part0093.xhtml#aid-2OM4A2">Chapter 7</a>, <em>Deploying to Your Device</em>) while saving the standalone application. In the preceding example, there would be <a id="id288" class="indexterm"/>files named <code class="literal">englishstrings.txt</code>, <code class="literal">frenchstrings.txt</code>, <code class="literal">spanishstrings.txt</code>, and so on. The following line of code <a id="id289" class="indexterm"/>will concatenate the path where the included <a id="id290" class="indexterm"/>files are located, the language that you <a id="id291" class="indexterm"/>wish to use (stored in the variable <code class="literal">prefstext</code>), and the ending of these filenames:</p><div><pre class="programlisting">put "file:" &amp; specialFolderPath("engine") &amp; prefstext &amp; "strings.txt" into langfile</pre></div><p>This will give you the full path to the language strings text file that matches your chosen language.</p></div><div><div><div><div><h2 class="title"><a id="ch04lvl2sec80"/>Using another stack to store data</h2></div></div></div><p>Ideally, you <a id="id292" class="indexterm"/>would just save changes in the stack you are in at the time, except that iOS doesn't permit you to save the changes in the application directory. We have to work around this by saving a stack, in the documents folder. The stack to save can either be the one that is our application stack or it could just be a stack purely used to store data. Saving data in a stack can be more convenient than saving it in text files. For example, you can have several text fields that are there to store bits of information that will be needed the next time the app is run. If you use text files, you would either need lots of them or you will have to process the text from a single file in order to extract the individual bits of information.</p><p>It's possible to try and save data in stacks without making a mobile app to check whether the basic technique works. Afterwards, you can try the same on an actual device. An advantage of <a id="id293" class="indexterm"/>trying this on your computer first is that you can browse to the <code class="literal">documents</code> folder in order to see the magic as it happens!</p></div></div>
<div><div><div><div><h1 class="title"><a id="ch04lvl1sec52"/>Time for action – creating a data save stack</h1></div></div></div><p>We're going to <a id="id294" class="indexterm"/>make a copy of a stack, but only if <a id="id295" class="indexterm"/>another copy of that stack doesn't exist. LiveCode has a nice <code class="literal">if there is a…</code> function, which was made for times like this!</p><p>First, we will create the stacks we'll need by following these steps:</p><div><ol class="orderedlist arabic"><li class="listitem">Start a new Mainstack with the name <code class="literal">LaunchStack</code>. Save it somewhere other than your computer's <code class="literal">Documents</code> folder.</li><li class="listitem">Start another new Mainstack with the name <code class="literal">AppStack</code>. Save it in the same folder as the first stack.</li><li class="listitem">Place some data on each stack's card, so that you can easily recognize when you're in that stack. For example, drag a button onto the card of the <code class="literal">LaunchStack</code> stack and name it in a way that makes it very easy to recognize. Do the same for the <code class="literal">AppStack</code> stack.</li><li class="listitem">Put the following <code class="literal">openStack</code> handler in the stack script of <code class="literal">LaunchStack</code>:<div><pre class="programlisting">on openStack
  set the defaultFolder to specialFolderPath("Documents")
  if there is not a file "AppStack.livecode" then
  put the filename of this stack into masterfile
    set the itemdelimiter to "/"
    put "AppStack.livecode" into the last item of masterfile
    --put specialFolderPath("engine") &amp; "/AppStack.livecode" into masterfile
    put specialFolderPath("Documents") &amp; "/AppStack.livecode" into appfile
    put URL ("binfile:" &amp; masterfile) into URL ("binfile:" &amp; appfile)
  end if
  go stack specialFolderPath("Documents") &amp; "/AppStack.livecode"
answer the filename of this stack
end openStack</pre></div></li><li class="listitem">Save both the stacks and quit LiveCode.</li></ol><div></div><p>Before trying the stacks on a device or in the simulator, we'll try them as desktop stacks by following these steps:</p><div><ol class="orderedlist arabic"><li class="listitem">Look in your <code class="literal">Documents</code> folder; there should <em>not</em> be an <code class="literal">AppStack.livecode</code> file in this folder at the moment.</li><li class="listitem">Launch LiveCode by double-clicking on the <code class="literal">LaunchStack.livecode</code> file. If you find that LiveCode doesn't launch this way, make sure that you have the associated <code class="literal">.livecode</code> documents to be opened with LiveCode. If you are using more than one copy of LiveCode, say you're trying the Community version and the Commercial version, you can drag the stack file onto the copy of LiveCode that you're intending to use.</li><li class="listitem">Look in your <code class="literal">Documents</code> folder; there now should be an <code class="literal">AppStack.livecode</code> file with the time when the file was created that matches the current time.</li><li class="listitem">You should <a id="id296" class="indexterm"/>also see that the path to AppStack is indeed in your <code class="literal">Documents</code> folder.</li></ol><div></div><p>Now, follow these <a id="id297" class="indexterm"/>steps to try our stacks on a mobile device or an iOS Simulator:</p><div><ol class="orderedlist arabic"><li class="listitem">Close the AppStack stack and uncomment the <code class="literal">put specialFolderPath…</code> line from the <code class="literal">LaunchStack</code> stack script that you entered in step 4.</li><li class="listitem">Go to <strong>Standalone Application Settings</strong> and choose the <strong>Copy Files</strong> section.</li><li class="listitem">Click on <strong>Add File…</strong> and locate and add the original <code class="literal">AppStack.livecode</code> stack (not the one that was created with the previous test).</li><li class="listitem">Choose either the <strong>Android</strong> or <strong>iOS</strong> section of the <strong>Standalone Application Settings</strong> and check the box to make the app available for that platform.</li><li class="listitem">From the <strong>Development</strong> menu, select your test target. That would be either one of the iOS simulators, if you choose iOS, or the connected Android device.</li><li class="listitem">Select <strong>Test</strong> from the <strong>Development</strong> menu. You should now be able to view your AppStack and an alert dialog box showing the path to the stack. The following screenshot shows the resulting dialog box in the iOS Simulator window and in an Android 4 tablet:<div><img src="img/image00271.jpeg" alt="Time for action – creating a data save stack"/></div><p style="clear:both; height: 1em;"> </p></li></ol><div></div><div><div><div><div><h2 class="title"><a id="ch04lvl2sec81"/>
<em>What just happened?</em>
</h2></div></div></div><p>We set up our app to copy the main application stack in the documents area on the device, so that we'll be able to make changes and save those successfully. If you happen to test on iOS and <a id="id298" class="indexterm"/>Android, you will see quite different <a id="id299" class="indexterm"/>looking paths for the stack. LiveCode takes care of finding these special folders for us.</p></div><div><div><div><div><h2 class="title"><a id="ch04lvl2sec82"/>Pop quiz – other special places</h2></div></div></div><p>Check whether you just happen to know this or use this question as an excuse to read the release notes and dictionary! Which of these is <em>not</em> a <code class="literal">specialFolderPath</code> type?</p><div><ol class="orderedlist arabic"><li class="listitem">Users</li><li class="listitem">Home</li><li class="listitem">Desktop</li><li class="listitem">0x000e</li></ol><div></div><p>Answer: 1</p><p>The <code class="literal">specialFolderPath</code> types <code class="literal">Home</code> and <code class="literal">Desktop</code> are not used by Android and <code class="literal">Desktop</code> is not used by iOS. <code class="literal">0x000e</code> sounds suspicious, but is actually the <code class="literal">specialFolderPath</code> entry for <code class="literal">My Videos</code> under Unix! None of the systems have a <code class="literal">Users</code> entry.</p></div></div>
<div><div><div><div><h1 class="title"><a id="ch04lvl1sec53"/>Creating a web "scraper" app</h1></div></div></div><p>As an excuse <a id="id300" class="indexterm"/>to try out various native mobile controls, we're going to make an app that can read web pages and extract links to different media on the page. The app will have a card that shows a web browser, cards to show the links, text, media from the web page, and a set of cards to remember the selected items.</p></div>
<div><div><div><div><h1 class="title"><a id="ch04lvl1sec54"/>Time for action – setting up the tab navigation</h1></div></div></div><p>Before getting <a id="id301" class="indexterm"/>into the process of making the Browser card, we need to set up the items that are shared across all the cards in the app. The <a id="id302" class="indexterm"/>following steps will help you do this:</p><div><ol class="orderedlist arabic"><li class="listitem">We'll use MobGUI again to make life easier. Select <strong>revMobGUI</strong> by navigating to the <strong>Development</strong> | <strong>Plugins</strong> submenu. Also, open the <strong>Project Browser</strong> from the LiveCode <strong>Tools</strong> menu to observe the stack structure as it develops.</li><li class="listitem">Create a new Mainstack, set its name to <code class="literal">WebScraper</code>, and save it someplace.</li><li class="listitem">In these instructions, we'll use iPhone in portrait orientation, but feel free to use iPad or an Android size for the card. Either select <strong>iOS7</strong> and <strong>320x480</strong> in the MobGUI window or your preferred options.</li><li class="listitem">As you did in the <em>Time for action – using MobGUI to remember layouts for us</em> section in <a class="link" title="Chapter 3. Building User Interfaces" href="part0038.xhtml#aid-147LC1">Chapter 3</a>, <em>Building User Interfaces</em>, use the MobGUI tools to add a <strong>Navbar</strong> and click on <strong>Snap to top</strong> of the card window, a <strong>Tab-bar</strong> with <strong>Snap to bottom</strong> of the card window, and <strong>Bg colors</strong> for both. Note that a MobGUI card and behavior controls are added to the project automatically when MobGUI controls are added to the Mainstack.</li><li class="listitem">Drag a LiveCode field control to the NavBar and label it <code class="literal">NavBar</code>. Format it as you like.</li><li class="listitem">Drag out a <strong>Button</strong> control from the MobGUI palette and duplicate it four times. Select all the five buttons and select <strong>Align Objects</strong> from the <strong>Inspector</strong>. Align their tops and distribute them across the card. Drag the five buttons to the Tab-bar that you just created and adjust their size and position as desired.</li><li class="listitem">Name the five buttons as <code class="literal">Browser</code>, <code class="literal">Links</code>, <code class="literal">Text</code>, <code class="literal">Media</code>, and <code class="literal">Keepers</code>. Do this by setting the <strong>Label</strong> entry in the Inspector palette.</li><li class="listitem">Edit the script of each button and in the <code class="literal">mouseUp</code> handler, add the following lines to leave the handler looking like this:<div><pre class="programlisting">on mouseUp
  put the short Name of me into tTabText
  set the Text of field "NavBar" to tTabText
  go card tTabText
  init
end mouseUp</pre></div></li><li class="listitem">From the <strong>Edit</strong> menu, and select <strong>Select All</strong> | <strong>Group Selected</strong> from the <strong>Object</strong> menu.</li><li class="listitem">Select the group, and <a id="id303" class="indexterm"/>in the <strong>Basic Settings</strong> menu of the regular LiveCode Object Inspector, give the group, the name <code class="literal">Common</code> and check the <strong>Behave like a background</strong> button.</li><li class="listitem">Set the name of the <a id="id304" class="indexterm"/>card to <code class="literal">Browser</code>.</li><li class="listitem">Make a new card and name it <code class="literal">Links</code>. Note that the grouped buttons appear on the new card.</li><li class="listitem">Do the same for three more cards that are to be named <code class="literal">Text</code>, <code class="literal">Media</code>, and <code class="literal">Keepers</code>.</li><li class="listitem">Go to <strong>Standalone Application Settings</strong>, choose <strong>iOS</strong> or <strong>Android</strong> as the platform you want to try, select the appropriate target from the <strong>Development</strong> menu, and perform a <strong>Test</strong>.</li><li class="listitem">Click on or touch the five tab buttons and you should see that the name of the <code class="literal">NavBar</code> field has changed.</li></ol><div></div><div><div><div><div><h2 class="title"><a id="ch04lvl2sec83"/>
<em>What just happened?</em>
</h2></div></div></div><p>By naming the buttons and cards the same, we were able to go to the five cards using the script attached to the group. Also, we used the button script to set the name of the NavBar to match the name of the card we had jumped to. The <code class="literal">init</code> line will come on its own as we write the card scripts.</p><div><h3 class="title"><a id="note10"/>Note</h3><p>Do not use the same name with the same type of control on the same card. Your script may end up operating on the wrong control.</p></div></div><div><div><div><div><h2 class="title"><a id="ch04lvl2sec84"/>The Browser card</h2></div></div></div><p>We'll now add a <a id="id305" class="indexterm"/>few controls and scripts to the first card to create the <a id="id306" class="indexterm"/>following mini web browser:</p><div><img src="img/image00272.jpeg" alt="The Browser card"/></div><p style="clear:both; height: 1em;"> </p><p>The native browser control has many properties, actions, and messages associated with it. You can view <a id="id307" class="indexterm"/>both the <strong>iOS Release Notes</strong> and the <strong>Android Release </strong>
<a id="id308" class="indexterm"/>
<strong>Notes</strong> at the following websites:</p><p>
<a class="ulink" href="http://downloads.livecode.com/livecode/5_5_5/LiveCodeNotes-5_5_5-iOS.pdf">http://downloads.livecode.com/livecode/5_5_5/LiveCodeNotes-5_5_5-iOS.pdf</a>
</p><p>
<a class="ulink" href="http://downloads.livecode.com/livecode/5_5_5/LiveCodeNotes-5_5_5-Android.pdf">http://downloads.livecode.com/livecode/5_5_5/LiveCodeNotes-5_5_5-Android.pdf</a>
</p><p>Additional updates on <a id="id309" class="indexterm"/>support documents can be found at the following :</p><p>
<a class="ulink" href="http://livecode.com/blog/2013/10/18/6-1-2-brings-ios-7-support/">http://livecode.com/blog/2013/10/18/6-1-2-brings-ios-7-support/</a>
</p><p>For our application <a id="id310" class="indexterm"/>though, we only need a few of LiveCode's abilities.</p></div></div>
<div><div><div><div><h1 class="title"><a id="ch04lvl1sec55"/>Time for action – adding the browser controls</h1></div></div></div><p>Return to the first card <a id="id311" class="indexterm"/>of the stack and find your way to the native controls part of the MobGUI window. The following steps will guide you through it:</p><div><ol class="orderedlist arabic"><li class="listitem">Drag the <strong>Browser</strong> control on the card window.</li><li class="listitem">Resize the control to fill the width of the card and resize the control so that its height fits between the tab bar and a little way below the NavBar. Give it the name <code class="literal">Page</code>.</li><li class="listitem">With the browser control selected, make sure that the box in the MobGUI window titled <strong>Auto delete</strong> is checked. This will help reduce the memory usage of the final app during the times you're not on the browser card.</li><li class="listitem">From the MobGUI window, drag an <strong>Input</strong> control into the gap between the browser control and the NavBar. Name it <code class="literal">url</code> and resize it to be nearly as wide as the card, leaving space for the <strong>Go</strong> button on the right.</li><li class="listitem">Drag a <strong>Button</strong> control into that space, set its label to <code class="literal">Go</code>, and resize it to look nice.</li><li class="listitem">Edit the script of the <strong>Go</strong> button (which as you may notice, is really a group) and add a couple of lines in the mouseUp handler, as follows:<div><pre class="programlisting">on MouseUp
  mobileControlSet "Page", "url", the mgText of group "url"
  focus on nothing
end mouseUp</pre></div></li><li class="listitem">Later, we will send an <code class="literal">init</code> message to the cards. For the Browser card, we can use this as a way to restore the previously chosen web page. Add the following to the Browser card script:<div><pre class="programlisting">on init
  global gPageURL
  if gPageURL is not empty then
    set the pURL of group "Page" to gPageURL
  else
    set the pURL of group "Page" to "http://www.google.com/"
  end if
end init</pre></div></li><li class="listitem">Edit the script of the browser (group <code class="literal">Page</code>) control. We're going to use the <code class="literal">browserFinishedLoading</code> message to know when to update some variables and URL text.</li><li class="listitem">Modify this <a id="id312" class="indexterm"/>handler of the browser control's script, shown as follows:<div><pre class="programlisting">on browserFinishedLoading pURL,pType
  global gPageURL,gPageHTML
  put pURL into gPageURL
  put url pURL into gPageHTML
  set the mgText of group "url" to pURL
  pass browserFinishedLoading
end browserFinishedLoading</pre></div></li><li class="listitem">Save and perform another <strong>Test</strong> to see the browser card in action.</li></ol><div></div><div><div><div><div><h2 class="title"><a id="ch04lvl2sec85"/>
<em>What just happened?</em>
</h2></div></div></div><p>Setting the <code class="literal">pURL</code> command of the browser control to <code class="literal">mgText</code> was enough to make the browser function, but some of what was just done was in preparation for what we'll need in the other cards. In particular, we used the regular LiveCode <code class="literal">put url</code> command to stash a copy of the web page HTML code in a global variable and this will be needed when we start extracting links and media from the page.</p></div><div><div><div><div><h2 class="title"><a id="ch04lvl2sec86"/>The Links card</h2></div></div></div><p>The Links, Text, and <a id="id313" class="indexterm"/>Media cards will take the page source that is stored in the <a id="id314" class="indexterm"/>
<code class="literal">gPageHTML</code> global variable and extract the bits of interest from it. How will they do that?</p><p>A common approach while extracting a known pattern of text is to use regular expressions, which are often referred to as <code class="literal">regex</code> or <code class="literal">regexp</code>. At it's the simplest approach, it's easy to understand, but can get quite complex.</p><div><h3 class="title"><a id="note11"/>Note</h3><p>Read the Wikipedia <a id="id315" class="indexterm"/>article if you want to understand about a regular expression in depth at:</p><p>
<a class="ulink" href="http://en.wikipedia.org/wiki/Regular_expression">http://en.wikipedia.org/wiki/Regular_expression</a>
</p><p>Another useful source of information is this Packt Publishing article on regular expressions, which you can find at <a class="ulink" href="http://www.packtpub.com/article/regular-expressions-python-26-text-processing">http://www.packtpub.com/article/regular-expressions-python-26-text-processing</a>.</p></div><p>One problem <a id="id316" class="indexterm"/>though, is that using regexp to parse HTML content is frowned upon. There are scores of articles online telling you outright NOT TO parse HTML with regexp! Here's one pithy example at</p><p>
<a class="ulink" href="http://boingboing.net/2011/11/24/why-you-shouldnt-parse-html.html">http://boingboing.net/2011/11/24/why-you-shouldnt-parse-html.html</a>.</p><p>Now, parsing an HTML source is exactly what we want to do here and one solution to the problem is to mix and match using LiveCode's other text matching and filtering abilities to do most of the work. Although it's not exactly regexp, LiveCode can use regular expressions in some of its matching and filtering functions and they are somewhat easier to understand than full-blown regexp. So, let's begin by using these.</p><p>While looking for links, we will make the assumption that the link is inside an <code class="literal">a href</code> tag, but even then, there are <a id="id317" class="indexterm"/>a lot of variations of how that can appear. The general structure of an <code class="literal">href</code> tag is like this:</p><div><pre class="programlisting">&lt;a href="http://www.runrev.com/support/forum/"&gt;Link text that the user will see&lt;/a&gt;</pre></div><p>In the text of the web page <a id="id318" class="indexterm"/>will be the phrase <code class="literal">Link text that the user will see</code>. When this is pointed at by the mouse, the user will see the pointing finger cursor, and when it's clicked on, the page will reload using the URL shown in the <code class="literal">href</code> part of the tag.</p><p>The preceding example shows the full path to the support forum; here are the ways that the very same web location might be written as in a page link:</p><p><code class="literal">http://www.runrev.com/support/forum/</code>
</p><p>
<code class="literal">/support/forum/</code>
</p><p>
<code class="literal">support/forum/</code>
</p><p>
<code class="literal">../support/forum/</code>
</p><p>The first link will take you <a id="id319" class="indexterm"/>there no matter where you are at that time. The second will take you there if you're somewhere else on the <a class="ulink" href="http://runrev.com/">http://runrev.com/</a> site. The third will be correct while you are at the root level of <a class="ulink" href="http://runrev.com/">http://runrev.com/</a>, and the last example would work from within one of the other root-level directories on the site.</p><p>With regex, you might create an extravagant expression that deals with all possible variations of how the links are contained in the page source, but even then it would not give us the full paths we need.</p><p>By taking things slowly, we <a id="id320" class="indexterm"/>can reduce the whole page source to a set of lines <a id="id321" class="indexterm"/>of "a href" entries, extract the URL part of each line, and finally, take the preceding variations and convert them into full path URLs.</p></div></div>
<div><div><div><div><h1 class="title"><a id="ch04lvl1sec56"/>Time for action – making a links extraction function</h1></div></div></div><p>Sometimes it's <a id="id322" class="indexterm"/>handy to create tests in a separate stack and then to take the function you've made into your application stack. The following points will help you in making a links extraction function:</p><div><ol class="orderedlist arabic"><li class="listitem">Create a new <strong>Mainstack</strong> and save it, just to be safe!</li><li class="listitem">Add a couple of fields and a button.</li><li class="listitem">Set the button's script to this:<div><pre class="programlisting">on mouseUp
  put url "http://www.runrev.com/" into field 1
  put getLinks(field 1) into field 2
end mouseUp</pre></div></li><li class="listitem">Edit the stack script and create a function for <code class="literal">getLinks</code>. Start with returning what it has sent:<div><pre class="programlisting">function getLinks pPageSource
  return pPageSource
end getLinks</pre></div></li><li class="listitem">If you try clicking on the button at this point, you will see that the whole page source appears in field 2.</li><li class="listitem">We're going to use the filter function, and it needs the text to be in separate lines. So, we want every link to be in a line of its own. The <code class="literal">replace</code> function can do this nicely. Add these two lines to the script (before the "return" line, of course!):<div><pre class="programlisting">  replace "/a&gt;" with "/a&gt;" &amp; return in pPageSource
  replace "&lt;a" with return &amp; "&lt;a" in pPageSource</pre></div></li><li class="listitem">Try clicking on the button now. The two fields will look much the same, but any lines that have a link in them will certainly be on a line of their own.</li><li class="listitem">Add a line to filter the list, as it stands, to reduce it so that it shows only the lines with links in them:<div><pre class="programlisting">  filter pPageSource with "*a href*/a&gt;"</pre></div></li><li class="listitem">The <code class="literal">*</code> characters are wildcards that reduces the list so that it only contains the lines that have both <code class="literal">a href</code> and <code class="literal">/a&gt;</code>. Try the button again.</li><li class="listitem">Now you'll see that there are only lines with links in them, but they still include the junk either side of the link itself. The part we need is between the first and second quote marks, and using the <code class="literal">itemdelimiter</code>, we can get at that bit. Add the <a id="id323" class="indexterm"/>following lines:<div><pre class="programlisting">set the itemdelimiter to quote
  repeat with a = 1 to the number of lines in pPageSource
    put item 2 of line a of pPageSource into line a of pPageSource
  end repeat</pre></div></li><li class="listitem">When you now click on the button, you should get a list of only the URL part of each line. However note that most of the links start with <code class="literal">/</code> and not <code class="literal">http</code>.</li><li class="listitem">Make another function in the stack script that will change the links to full path:<div><pre class="programlisting">function getPath pPageURL,pLinkURL
end getPath</pre></div></li><li class="listitem">Now, add the code needed to cope with the variations of URL (to function <code class="literal">getPath</code>), starting with it's full path:<div><pre class="programlisting">  if pLinkURL contains "://" then
    return pLinkURL
  end if</pre></div></li><li class="listitem">If you recall from earlier, we saved the URL of the main page in a global variable, <code class="literal">gPageURL</code>. For the case where the link is a root relative (it starts with a <code class="literal">/</code>), we want to combine the host location and the link URL:<div><pre class="programlisting">  set the itemdelimiter to "/"
  if char 1 of pLinkURL is "/" then
    return item 1 to 3 of pPageURL &amp; pLinkURL
  else</pre></div></li><li class="listitem">When that first character is not <code class="literal">/</code>, it may start with <code class="literal">../</code> to step up one level in the server structure. Deleting the last part of the page URL will give us what we need to combine with the link URL:<div><pre class="programlisting">if char 1 to 3 of pLinkURL is "../" then
  delete the last item of pPageURL
  delete the last item of pPageURL
  delete char 1 to 2 of pLinkURL
  return pPageURL &amp; pLinkURL
else
For other cases we combine the page URL and the link URL:
  delete the last item of pPageURL
  return pPageURL &amp; "/" &amp; pLinkURL
  end if
end if</pre></div></li><li class="listitem">Lastly, if all of these checks fail, we will return an empty string, so that this strange structured link URL doesn't go on to confuse us later:<div><pre class="programlisting">  return ""
end getPath</pre></div></li><li class="listitem">To get the <a id="id324" class="indexterm"/><code class="literal">getLinks</code> function to use the <code class="literal">getPath</code> function, we need to make a change to the script shown in step 9:<div><pre class="programlisting">  repeat with a = 1 to the number of lines in pPageSource
  put getPath(gPageURL,item 2 of line a of pPageSource) into line a of pPageSource
end repeat</pre></div></li></ol><div></div><div><div><div><div><h2 class="title"><a id="ch04lvl2sec87"/>
<em>What just happened?</em>
</h2></div></div></div><p>In stages, we developed a function that can find the links in a web page's source text ending with a set of full path URLs that we can present to the user.</p></div><div><div><div><div><h2 class="title"><a id="ch04lvl2sec88"/>The missing links</h2></div></div></div><p>The one missing <a id="id325" class="indexterm"/>piece in the test stack is the global variable that stores the page URL. In the case of the app stack, the value is provided by the browser control's <code class="literal">browserFinishedLoading</code> function, but here, we need to plug in a value for testing purposes.</p><p>Place a global declaration line in the button's script and the stack script. In the button script, fill in the variable with our test case value. The script will then be like this:</p><div><pre class="programlisting">global gPageURL

on mouseUp
  put "http://www.runrev.com/" into gPageURL
  put url gPageURL into field 1
  put getLinks(field 1) into field 2
end mouseUp</pre></div><p>Try the button now, you should see a list of full path URLs in your second field. If it works correctly, copy the two stack functions and the global declaration line and paste them into the stack script of the WebScraper stack.</p><div><div><div><div><h3 class="title"><a id="ch04lvl3sec12"/>One more thing…</h3></div></div></div><p>The tab bar script includes an init line. This will call the card script; in this case, the Links card script, but it doesn't exist yet! Let's make it.</p></div></div></div>
<div><div><div><div><h1 class="title"><a id="ch04lvl1sec57"/>Time for action – adding the links card's init handler</h1></div></div></div><p>Before proceeding, make <a id="id326" class="indexterm"/>sure that you are happy with the functions in the <a id="id327" class="indexterm"/>test stack and that you have copied them to the WebScraper stack script using the following steps:</p><div><ol class="orderedlist arabic"><li class="listitem">Go to the Links card of the WebScraper stack.</li><li class="listitem">Edit the card script and add these global variables and <code class="literal">init</code> function:<div><pre class="programlisting">global gPageHTML,gLinks

on init
if the platform is "iphone" or the platform is "android" then
  put getLinks(gPageHTML) into gLinks
  if the number of lines in gLinks = 0 then
     answer "There are no links in this page!"
  else
     mobilePick gLinks,0
     if the result &gt; 0 then
      put the result into tLinkLine
      put line tLinkLine of gLinks into tLink
      go card "Browser"
      set the mgText of group "url" to tLink
      set the Text of field "NavBar" to "Browser"
      mobileControlSet "Page", "url", the mgText of group "url"
      end if
    end if
  end if
end init</pre></div></li><li class="listitem">Do a Test of the app.</li><li class="listitem">In the iPhone Simulator or Android device, if that's what you're using, change the URL to <a class="ulink" href="http://www.runrev.com/">http://www.runrev.com/</a> and select the <strong>Go</strong> button.</li><li class="listitem">When the page is loaded, select the <strong>Links</strong> tab button.</li><li class="listitem">You should now be looking at the list of links from the RunRev page; only this time, it's presented in a native picker list.</li><li class="listitem">Select a link from the list and then <strong>Done</strong>.</li><li class="listitem">You will be taken back to the Browser card with the linked page loaded.</li></ol><div></div><div><div><div><div><h2 class="title"><a id="ch04lvl2sec89"/>
<em>What just happened?</em>
</h2></div></div></div><p>The card script we entered does the same job as the button in the test stack; in that, it calls to the stack functions to get a list of links. Here, rather than putting the list into a plain field, we used LiveCode's ability to open a native picker control using the line:</p><div><pre class="programlisting">mobilePick gLinks,1</pre></div><p>The required parameters <a id="id328" class="indexterm"/>of this function are a list of items to be shown and <a id="id329" class="indexterm"/>an index position to be the one that is selected. By entering <code class="literal">1</code>, the first item is selected by default. The result that comes back from the picker is an index of the item that was selected, and we can use this to look up the matching line in the <code class="literal">gLinks</code> variable.</p><p>The remaining lines take us back to the Browser card, set the URL to be loaded, and also change the NavBar to reflect the card name.</p></div><div><div><div><div><h2 class="title"><a id="ch04lvl2sec90"/>The Text card</h2></div></div></div><p>Making the Text <a id="id330" class="indexterm"/>card work is a lot simpler, but includes an unbelievably complex <a id="id331" class="indexterm"/>regular expression line, which can be <a id="id332" class="indexterm"/>found at:</p><p>
<a class="ulink" href="http://stackoverflow.com/questions/3951485/regex-extracting-readable-non-code-text-and-urls-from-html-documents">http://stackoverflow.com/questions/3951485/regex-extracting-readable-non-code-text-and-urls-from-html-documents</a>
</p></div></div>
<div><div><div><div><h1 class="title"><a id="ch04lvl1sec58"/>Time for action – setting up the Text card</h1></div></div></div><p>We will start off in the test stack that you made, so that we can get the function working there before adding it to the WebScraper stack.</p><div><ol class="orderedlist arabic"><li class="listitem">Duplicate the button you made when extracting links. Change the function call <code class="literal">getLinks</code> to <code class="literal">getText</code>; the rest of the script can remain the same.</li><li class="listitem">Edit the script of the test stack and add this function:<div><pre class="programlisting">function getText pPageSource
  put replaceText(pPageSource,"(?:&lt;(?P&lt;tag&gt;script|style)[\s\S]*?&lt;/(?P=tag)&gt;)|(?:&lt;!--[\s\S]*?--&gt;)|(?:&lt;[\s\S]*?&gt;)","") into pPageSource
  replace lf with "" in pPageSource
  replace tab with " " in pPageSource
  return pPageSource
end getText</pre></div></li><li class="listitem">Try clicking on the button you just made. You should see your second field filled with just the text parts of the web page.</li><li class="listitem">Copy the function and go back to the WebScraper stack script. Paste the function there.</li><li class="listitem">Go to the Text card of the stack and from the MobGUI window, drag the <strong>Multiline Text</strong> control onto the card. Set its name to <code class="literal">PageText</code>.</li><li class="listitem">Resize the control to fill the area between the NavBar and the Tab-bar. You may have to use the LiveCode Inspector to modify the size if the text does not fill the field.</li><li class="listitem">In the MobGUI window properties for the control, uncheck the box for <strong>Editable</strong>.</li><li class="listitem">Edit the card script and add this <code class="literal">init</code> function:<div><pre class="programlisting">global gPageHTML

on init
  if the platform is "iphone" or the platform is "android" then
    mobileControlSet "PageText","text",getText(gPageHTML)
  end if
end init</pre></div></li><li class="listitem">Try a <strong>Test</strong> of the app.</li><li class="listitem">In the <strong>Browser</strong> card, change the URL from <a class="ulink" href="http://google.com/">http://google.com/</a> to <a class="ulink" href="http://runrev.com/">http://runrev.com/</a> and click on <strong>Go</strong>.</li><li class="listitem">Press the <strong>Text</strong> tab <a id="id333" class="indexterm"/>button at the bottom.</li><li class="listitem">You should now be on the <strong>Text</strong> card and should be able to see the text elements from the web page displayed in a native scrolling text field.</li></ol><div></div><div><div><div><div><h2 class="title"><a id="ch04lvl2sec91"/>
<em>What just happened?</em>
</h2></div></div></div><p>This enormously long regular expression ran through the web page source and removed anything that was script, style, or just tag information, leaving the text parts alone. However, it would leave it with lots of spare line feed characters and tab characters, which we went on to remove using the LiveCode <code class="literal">replace</code> function. The final text may not be perfect, but you can use the standard mobile text features to copy parts of the text for use in other apps.</p></div><div><div><div><div><h2 class="title"><a id="ch04lvl2sec92"/>The Media card</h2></div></div></div><p>The Media card is going to <a id="id334" class="indexterm"/>start off very much like the Links card, with an <a id="id335" class="indexterm"/>
<code class="literal">init</code> function in the card script and a stack script function to extract the media links from the page.</p></div></div>
<div><div><div><div><h1 class="title"><a id="ch04lvl1sec59"/>Time for action – extracting a list of media links</h1></div></div></div><p>There probably is a <a id="id336" class="indexterm"/>regular expression that would extract all the <code class="literal">src</code> links from a page, but we're only interested in things that we know LiveCode is able to show or play. So in these steps, we'll use a more devious way to extract just the links we can handle:</p><div><ol class="orderedlist arabic"><li class="listitem">You may as well head over to the test stack!</li><li class="listitem">Make a third button by duplicating one of the other two and change the <code class="literal">getLinks</code> or <code class="literal">getText</code> part in the button script to call <code class="literal">getMedia</code> instead.</li><li class="listitem">In the stack script, enter all of this:<div><pre class="programlisting">global gPageURL

function getMedia pPageSource
  put ".jpg,.png,.gif,.jpeg,.mov,.mp4,m4v,.mp3" into tExtensions
  repeat with a = 1 to the number of items in tExtensions
    put item a of tExtensions into tExtension
    replace tExtension with tExtension &amp; "*" &amp; return in pPageSource
  end repeat
  repeat with a = the number of lines in pPageSource down to 1
    put line a of pPageSource into tLine
    if the last char of tLine is "*" then
      delete the last char of tLine
      put removeLeaders(gPageURL,tLine) into line a of pPageSource
    else
      delete line a of pPageSource
    end if
  end repeat
  return pPageSource
end getMedia

function removeLeaders pPageURL,pLinkURL
  put quote&amp;"'()" into tDelimiters
  repeat with a = 1 to the number of chars in tDelimiters
    put char a of tDelimiters into tDelimiter
    set the itemdelimiter to tDelimiter
    put the last item of pLinkURL into pLinkURL
  end repeat
  return getPath(pPageURL,pLinkURL)
end removeLeaders</pre></div></li><li class="listitem">Click on the <a id="id337" class="indexterm"/>button and you should see a list of full paths to the various images in the web page.</li></ol><div></div><div><div><div><div><h2 class="title"><a id="ch04lvl2sec93"/>
<em>What just happened?</em>
</h2></div></div></div><p>This devious approach involved the task of finding any place where the media of interest is mentioned and adding an asterisk and return character in order to make sure that the link was easily identified and at the end of a unique line. Then, each of these lines were sent to another function, <code class="literal">removeLeaders</code>, to remove any other text that was earlier in the line than at the start of the link. Finally, the same <code class="literal">getPath</code> function we used while extracting links was used to <a id="id338" class="indexterm"/>give us full paths to the media files.</p><p>Now that we have a list of media links, we need to add the card level handlers required to present the list to the user and to load their selected media item onto the card window.</p></div></div>
<div><div><div><div><h1 class="title"><a id="ch04lvl1sec60"/>Time for action – setting up the Media card scripts</h1></div></div></div><p>Copy the functions that <a id="id339" class="indexterm"/>you have proved to work, in the test stack script and paste them into the WebScraper stack script. Then, perform these steps:</p><div><ol class="orderedlist arabic"><li class="listitem">Go to the Media card. As with the Links card, we're not going to add any controls to the card, as we'll do that with the script. So, edit the card script.</li><li class="listitem">Here's the Media card's <code class="literal">init</code> function and the needed global variables:<div><pre class="programlisting">global gPageHTML,gMediaList

on init
  if the platform is "iphone" or the platform is "android" then
    put getMedia(gPageHTML) into gMediaList
    if the number of lines in gMediaList = 0 then
      answer "There is no media in this page!"
    else
      set the itemdelimiter to "/"
      put empty into tMediaNames
      repeat with a = 1 to the number of lines in gMediaList
        put the last item of line a of gMediaList into line a of tMediaNames
      end repeat
      mobilePick tMediaNames,1
      if the result &gt; 0 then
        put the result into tMediaLine
        showMedia line tMediaLine of gMediaList
      end if
    end if
  end if
end init</pre></div></li><li class="listitem">Unlike the Links case, we've built up a list of just the filename part of the URL, to be seen in a native picker, and when we've selected something we will call a <code class="literal">showMedia</code> function in the stack script.</li><li class="listitem">Edit the stack script.</li><li class="listitem">Create the <a id="id340" class="indexterm"/><code class="literal">showMedia</code> function:<div><pre class="programlisting">on showMedia pMediaFile
  if there is an image "mediaImage" then delete image "mediaImage"
  set the itemdelimiter to "."
  switch (the last item of pMediaFile)
    case "png"
    case "gif"
    case "jpg"
    case "jpeg"
      new image
      set the name of image the number of images to "mediaImage"
      set the filename of image "mediaImage" to pMediaFile
      break
    case "mp4"
    case "m4v"
    case "mov"
    case "mp3"
      set the showController of the templatePlayer to true
      play video pMediaFile
    break
  end switch
end showMedia</pre></div></li><li class="listitem">Test the app.</li><li class="listitem">You can start with the google.com page; click on the <strong>Media</strong> tab button to see a list of the images used on that page.</li><li class="listitem">Select an image from the list and click on <strong>Done</strong>.</li><li class="listitem">The image should appear on the card.</li><li class="listitem">Go back to the <strong>Browser</strong> card and change the URL to <code class="literal">http://www.apple.com/</code>.</li><li class="listitem">Apple usually includes some video link thumbnails on the main page. click on one of those, so that you see the large video player. However, don't play it!</li><li class="listitem">Click on the <strong>Media</strong> tab button to see a list of all the media on that page.</li><li class="listitem">Scroll down the list and look for one of the longer-named items that seems like it must be a video.</li><li class="listitem">Select that item and press <strong>Done</strong>. The video should load and play on the card.</li><li class="listitem">Use the video controller's <strong>Done</strong> button when you are finished watching the video to return to the <strong>Media</strong> card.</li><li class="listitem">You can then click on the <strong>Media</strong> tab button again to make the picker reappear.</li><li class="listitem">Go back to the <strong>Browser</strong> card and enter a URL that contains examples of MP3 files. <code class="literal">http://www.ntonyx.com/mp3_songs.htm</code> is one such example.</li><li class="listitem">Click on the <strong>Media</strong> tab button to return to the <strong>Media</strong> card with the list of all the media on that page, which in this case will be mainly MP3 files.</li><li class="listitem">Select one of the <a id="id341" class="indexterm"/>MP3s from the list and click on <strong>Done</strong>. The MP3 should play in the same player that the video is played in.</li></ol><div></div><div><div><div><div><h2 class="title"><a id="ch04lvl2sec94"/>
<em>What just happened?</em>
</h2></div></div></div><p>In this example, we made use of both a standard LiveCode control, the image, and also a native control, the video player. LiveCode handles the setting up of the player and with the very simple "play video videoname" syntax, we were able to invoke the native player. It was able to play both video and audio files.</p></div><div><div><div><div><h2 class="title"><a id="ch04lvl2sec95"/>The Keepers card</h2></div></div></div><p>Actually, this should be the <a id="id342" class="indexterm"/> Keepers <em>cards</em>. These cards are where you can <a id="id343" class="indexterm"/>stash media that you've found interesting. For file size reasons, we're actually just going to store the URL to the media; after all, a long video would soon use up your device's storage!</p></div></div>
<div><div><div><div><h1 class="title"><a id="ch04lvl1sec61"/>Time for action – setting up the Keepers card</h1></div></div></div><div><ol class="orderedlist arabic"><li class="listitem">Go to the <strong>Keepers</strong> card and create a MobGUI button for <strong>Prev</strong>, <strong>Next</strong>, and <strong>Play Media</strong>. Make a <a id="id344" class="indexterm"/>MobGUI <strong>Multiline</strong> field and name it <code class="literal">mediaURL</code>. Be sure to uncheck the <strong>Auto delete</strong> option, so that it keeps the URL data when we change cards. Also uncheck the <strong>Editable</strong> option. You should now have something looking like the following screenshot:<div><img src="img/image00273.jpeg" alt="Time for action – setting up the Keepers card"/></div><p style="clear:both; height: 1em;"> </p></li><li class="listitem">Add these lines to the <code class="literal">mouseUp </code>handler of the <strong>Prev</strong> button:<div><pre class="programlisting">  if the number of this card is &gt; 5 then
    go previous
  end if</pre></div></li><li class="listitem">Add these lines to <a id="id345" class="indexterm"/>the <code class="literal">mouseUp</code> handler of the <strong>Next</strong> button. Note that <code class="literal">- 1</code> is used since the last card is the MobGUI card:<div><pre class="programlisting">  if the number of this card &lt; the number of cards - 1 then
    go next
  end if</pre></div></li><li class="listitem">Add this line to the Play Media button's <code class="literal">mouseUp</code> handler:<div><pre class="programlisting">  showMedia the mgText of group "mediaURL"</pre></div></li><li class="listitem">Select the four controls and Group them. Check the box that says <strong>Behave like a background</strong>. Name the group <code class="literal">keeperbuttons</code>.</li><li class="listitem">Edit the script of the new group. Add this <code class="literal">refresh</code> handler:<div><pre class="programlisting">on refresh
  set the itemdelimiter to "."
  if char 1 of the last item of the mgText of group "mediaURL" is "m" then
    show group "Play Media"
  else
    hide group "Play Media"
    showMedia the mgText of group "mediaURL"
  end if
end refresh</pre></div></li><li class="listitem">We need to go back and add things to the <strong>Media</strong> card.</li><li class="listitem">Go to the <strong>Media</strong> card and add a MobGUI button. Set the name and label to <code class="literal">Keep Media</code>.</li><li class="listitem">One tricky thing is that media will play full screen on smaller screens and by the time you see the <strong>Keep Media</strong> button, the video has already gone away. We can work around this by storing the URL of the last shown media in a global variable.</li><li class="listitem">In the <strong>Media</strong> card <a id="id346" class="indexterm"/>script, change the <code class="literal">init</code> function, so that the later lines read like this:<div><pre class="programlisting">if the result &gt; 0 then
  put the result into tMediaLine
  put line tMediaLine of gMediaList into gLastMedia
  showMedia gLastMedia
end if</pre></div></li><li class="listitem">Change the global variable declaration line to include the <code class="literal">gLastMedia</code> variable.</li><li class="listitem">Set the <code class="literal">mouseUp</code> handler of the <strong>Keep Media</strong> button to be this:<div><pre class="programlisting">on mouseUp
  global gLastMedia
  go  card (the number of cards -1)
  if the mgText of group "mediaURL" is not empty then
  new card
  end if
  set the mgText of group "mediaURL" to gLastMedia
  save stack "WebScaper" as (specialFolderPath("documents") &amp; "/WebScraper.livecode")
  send "refresh" to group "keeperButtons"
end mouseUp</pre></div></li><li class="listitem">Now, only one last step is required for the stack to save the media. We need to create a launcher app like we did earlier in this chapter. Create a stack named <code class="literal">LaunchScraper</code> with the following stack script:<div><pre class="programlisting">on openStack
  set the defaultFolder to specialFolderPath("Documents")
  if there is not a file "WebScraper.livecode" then
    put the filename of this stack into masterfile
    set the itemdelimiter to "/"
    put "WebScraper.livecode" into the last item of masterfile
    put specialFolderPath("engine") &amp; "/WebScraper.livecode" into masterfile
    put specialFolderPath("Documents") &amp; "/WebScraper.livecode" into appfile
    put URL ("binfile:" &amp; masterfile) into URL ("binfile:" &amp; appfile)
  end if
  go stack specialFolderPath("Documents") &amp; "/WebScraper.livecode"
  answer the filename of this stack
end openStack</pre></div></li><li class="listitem">Make sure that the Launch Scraper and Web Scraper apps are in the same folder. Open only the Launch Scraper app and make sure that the Web Scraper app is included in the <strong>Copy files</strong> of the <strong>Standalone Application Settings</strong>.</li><li class="listitem">Select your <strong>Test </strong><a id="id347" class="indexterm"/><strong>Target</strong> device and then <strong>Test</strong>. Note that the last answer statement will display the path and the filename where the main app is stored on your device. This can be commented out once you are comfortable that it is working.</li><li class="listitem">Use the <strong>Browser</strong> card to load a page with plenty of images, videos, or sounds on it and go to the <strong>Media</strong> card to see those listed.</li><li class="listitem">Select any item followed by a click on <strong>Done</strong>.</li><li class="listitem">If you like the image, sound, or video, use the <strong>Keep Media</strong> button to go to the end of the stack to save the media's URL.</li><li class="listitem">Choose more bits of media and keep them.</li><li class="listitem">Go to the <strong>Keepers</strong> section and use the <strong>Next</strong> and <strong>Prev</strong> buttons to browse through the items you've kept.</li><li class="listitem">The images should appear automatically and the video and audio can be started with the <strong>Play Media</strong> button.</li></ol><div></div><div><div><div><div><h2 class="title"><a id="ch04lvl2sec96"/>
<em>What just happened?</em>
</h2></div></div></div><p>We added the last feature of our application, a set of cards where we can go to view the bits of media that we've chosen to keep.</p></div><div><div><div><div><h2 class="title"><a id="ch04lvl2sec97"/>Have a go hero – add some preset locations</h2></div></div></div><p>If you do make the Web Scraper app and start to find it useful, it's quite likely that there will be a set of web pages that you'd like to go back to again and again. To type the URL every time would be tedious. So, why not make a hidden field on the <strong>Browser</strong> card and type in a list of your favorite pages. Add a button to the card too, which will bring up a list of those pages for you to choose <a id="id348" class="indexterm"/>from. The one you choose can then load the <strong>Browser</strong> control at the desired page. All of the steps to do this were covered in the <em>The Links card</em> section.</p><p>It's pretty certain that if you've carefully followed all the steps in this chapter and indeed all the steps were perfect, you still wouldn't have an app ready to be submitted to the app stores! You would require a splash screen, a main menu, icons on the tab buttons as well and some love from a graphic designer! Feature wise, it would be nice if the images you keep could be zoomed and panned.</p></div></div>
<div><div><div><div><h1 class="title"><a id="ch04lvl1sec62"/>Summary</h1></div></div></div><p>Some of the topics that we covered here are less glamorous, mostly the ones about processing HTML text, but we did also use a few mobile features. We demonstrated how a native app can store data for subsequent usage, and how to make and control a web browser. The use of a native picker to present lists was covered. We also created a native scrolling field that had all the normal OS-specific abilities and played video and audio using the native media players.</p><p>The next chapter is almost entirely about dealing with graphics, so we'll make sure to use some image manipulating gestures and you could revisit the Web Scraper app later to add the same features to the Keepers cards.</p></div></body></html>