<html><head></head><body>
  <div><div><div><div><h1 class="title"><a class="calibre1" id="ch12"/>Chapter 12. Peripherals</h1>
        </div>
      </div>
    </div>

    <p class="calibre9">The whole point of having a smartphone is that it is not just a phone, it's a GPS, a media center, a messenger system, and a video system. In short, that little device in your pocket is the proverbial "Jack of all trades, but master of <em class="calibre15">all</em>."</p>

    <p class="calibre9">In this chapter, we will be covering the following topics:</p>

    <div><ul class="itemizedlist">
        <li class="listitem">Using the camera</li>

        <li class="listitem">Maps and GPS</li>

        <li class="listitem">Storage on the phone</li>

        <li class="listitem">Making a phone call</li>

        <li class="listitem">Sending and receiving a text message</li>

        <li class="listitem">Accessing the internet</li>

        <li class="listitem">Multimedia</li>
      </ul>
    </div>

    <div><div><div><div><h1 class="title"><a class="calibre1" id="ch12lvl1sec48"/>Using the camera</h1>
          </div>
        </div>
      </div>

      <p class="calibre9">The camera on the iPhone is <a class="calibre1" id="id902"/>capable of recording stills and video. We will be dealing with video shortly.</p>

      <p class="calibre9">The camera can be accessed in one of the two ways. Xamarin has released <code class="email">Xamarin.Mobile</code> in its <a class="calibre1" id="id903"/>component store, which gives a cross platform method to access the GPS, camera, and address book. For completeness, we will cover both the native and component versions.</p>

      <div><div><div><div><h2 class="title1"><a class="calibre1" id="ch12lvl2sec59"/>Accessing the camera (Xamarin.Mobile)</h2>
            </div>
          </div>
        </div>

        <p class="calibre9">The <code class="email">Xamarin.Mobile</code> component <a class="calibre1" id="id904"/>provides an easy way to access a camera. A <a class="calibre1" id="id905"/>simple method would look as follows:</p>

        <div><pre class="programlisting">var picker = new MediaPicker ();
if (!picker.IsCameraAvailable)
  Console.WriteLine ("No camera!");
else {
  picker.TakePhotoAsync (new StoreCameraMediaOptions {
    Name = "test.jpg",
    Directory = "MediaPickerSample"
  }).ContinueWith (t =&gt; {
    if (t.IsCanceled) {
      Console.WriteLine ("User canceled");
      return;
    }
    Console.WriteLine (t.Result.Path);
  }, TaskScheduler.FromCurrentSynchronizationContext());
}</pre>
        </div>

        <p class="calibre9">The issue with the <a class="calibre1" id="id906"/>Xamarin component is <a class="calibre1" id="id907"/>that it currently doesn't provide a method for accessing the front camera; however, the preceding code will save the clicked image.</p>
      </div>

      <div><div><div><div><h2 class="title1"><a class="calibre1" id="ch12lvl2sec60"/>Accessing the camera (Native)</h2>
            </div>
          </div>
        </div>

        <p class="calibre9">The camera is accessed <a class="calibre1" id="id908"/>using <code class="email">UIImagePickerController</code>. To use it, it's always wise to first check whether the device actually has a camera (the iPod <a class="calibre1" id="id909"/>Touch doesn't have one nor does the simulator). To do this, check the <code class="email">IsSourceTypeAvailable</code> Boolean.</p>

        <div><pre class="programlisting">var myCamera = UIImagePickerControllerSourceType.Camera;
if (UIImagePickerController.IsSourceTypeAvailable(myCamera))
{
  UIImagePickerController myCameraPicker = newUIImagePickerController();
  myCameraPicker.SourceType = myCamera;
  myCameraPicker.Delegate = new myImageDelegate(this);
  PresentModalViewController(myCameraPicker, true);
}</pre>
        </div>

        <p class="calibre9">The delegate deals with dismissing the modal window and any other process you want (such as displaying the picture or saving the image). A simple delegate would look something like the following (it can be extended if required):</p>

        <div><pre class="programlisting">public class myImageDelegate : UIImagePickerControlDelegate
{
  private UIViewController myController;
  public myImageDelegate(UIViewController control) {
    myController = control;
  }
  public override void FinishedPickingMedia (UIImagePickerController thePicker, NSDictionary I) {
    myController.DismissModalViewControllerAnimated(true);
  }
}</pre>
        </div>
      </div>

      <div><div><div><div><h2 class="title1"><a class="calibre1" id="ch12lvl2sec61"/>Saving to the Photo album (Native)</h2>
            </div>
          </div>
        </div>

        <p class="calibre9">The following code would be placed in the <code class="email">myCameraPicker.Delegate</code> code within the <code class="email">FinishedPickingMedia()</code> <a class="calibre1" id="id910"/>method, which would save images to the camera roll natively:</p>

        <div><pre class="programlisting">  UIImage myImage = UIImage.FromFile(filename);
  myImage.SaveToPhotoAlbum(delegate (UIImage image, NSError err) {
    Console.WriteLine("Image saved fine"); });</pre>
        </div>
      </div>
    </div>
  </div>


  <div><div><div><div><h1 class="title"><a class="calibre1" id="ch12lvl1sec49"/>GPS and Mapping</h1>
        </div>
      </div>
    </div>

    <p class="calibre9">This is also covered by the <code class="email">Xamarin.Mobile</code> component in part (the full functionality of <strong class="calibre2">Core Location</strong> is not <a class="calibre1" id="id911"/>replicated in the <code class="email">Xamarin.Mobile</code> component, due to there not being an equivalent method on the other platforms that the component supports). Thankfully, the component and Core Location work together seamlessly.</p>

    <div><div><div><div><h2 class="title1"><a class="calibre1" id="ch12lvl2sec62"/>GPS with Xamarin.Mobile</h2>
          </div>
        </div>
      </div>

      <p class="calibre9">The <code class="email">Xamarin.Mobile</code> <a class="calibre1" id="id912"/>component allows you to listen to the position of the <a class="calibre1" id="id913"/>device and act when the position has been changed, using the <code class="email">PositionChanged</code> event. The following code demonstrates how to use it:</p>

      <div><pre class="programlisting">var iPhoneLocationManager = new Geolocator();
iPhoneLocationManager.DesiredAccuracy = 5;
iPhoneLocationManager.StartListening(1, 10);
iPhoneLocationManager.PositionChanged += (object sender,PositionEventArgs e) =&gt; {
  double geoLocationLong = e.Position.Longitude;
  double geoLocationLat = e.Position.Latitude;
  iPhoneLocationManager.StopListening();
};</pre>
      </div>

      <p class="calibre9">While analyzing the preceding lines of code, we come across the following terms:</p>

      <div><ul class="itemizedlist">
          <li class="listitem"><code class="email">DesiredAccuracy</code>: It is the <a class="calibre1" id="id914"/>distance in meters that is needed before the event is triggered. This in itself can cause an issue. Anything under that value will mean that the event is not triggered. Too big a value, the accuracy is hit.</li>

          <li class="listitem"><code class="email">StartListening</code>: It takes two <a class="calibre1" id="id915"/>parameters: <code class="email">minimumTime</code> and <code class="email">minDistance</code>. In this case, it should either return within the first minute, or if the phone is moved more than 10 m.</li>

          <li class="listitem"><code class="email">StopListening</code>: It stops the <a class="calibre1" id="id916"/>listening service.</li>
        </ul>
      </div>

      <p class="calibre9">The <code class="email">Xamarin.Mobile</code> module also provides you with an asynchronous method—<code class="email">GetPositionAsync</code>, which retrieves your <a class="calibre1" id="id917"/>position asynchronously.</p>

      <div><pre class="programlisting">private TaskScheduler sched =TaskScheduler.FromCurrentSynchronizationContext();
private CancellationTokenSource cancel;
geolocator.GetPositionAsync (timeout: 10000,cancelToken: cancel.Token, includeHeading: true).ContinueWith (t=&gt; {
  if (t.IsFaulted)
    Console.WriteLine("Position faulted : {0}".((GeolocationException)t.Exception.InnerException).Error);
  else if (t.IsCanceled)
    Console.WriteLine("Canceled");
      else {
        Console.WriteLine("Timestamp {0}",t.Result.Timestamp.ToString("G"));
        Console.WriteLine("La: {0}", t.Result.Latitude.ToString("N4"));
        Console.WriteLine("Lo: {0}", t.Result.Longitude.ToString("N4"));}}, sched);</pre>
      </div>

      <p class="calibre9">The returned value stored in <code class="email">Result</code> also provides the speed. This is not to be relied upon. It's far more accurate to use your own method, but to do that you need to know how far you have traveled.</p>

      <div><div><div><div><h3 class="title2"><a class="calibre1" id="ch12lvl3sec109"/>Calculating your speed</h3>
            </div>
          </div>
        </div>

        <p class="calibre9">The <code class="email">CoreLocation</code> <a class="calibre1" id="id918"/>namespace has in it a <a class="calibre1" id="id919"/>method named <code class="email">DistanceFrom</code> for calculating the distance. The method works as follows:</p>

        <div><ol class="orderedlist">
            <li class="listitem" value="1">Gets the new location.</li>

            <li class="listitem" value="2">Gets the old location.</li>

            <li class="listitem" value="3">Creates two instances of <code class="email">CLManager</code>.</li>

            <li class="listitem" value="4">Puts the coordinates of both the locations into the two instances respectively.</li>

            <li class="listitem" value="5">Uses <code class="email">DistanceFrom</code>.</li>
          </ol>

          <div></div>

        <p class="calibre9">The resulting <code class="email">double</code> value gives you the distance in meters and the time in seconds, so the speed you have traveled is in meters/seconds (that is, distance/time). The issue here though is the calculation; it might consider how a bird flies rather than how you are travelling. For example, if the desired accuracy you have is too low and the timeout too high, the method with <code class="email">DistanceFrom</code> will still work; however, if the distance is not 100 m, but apparently 35 m (consider that a bird flies straight across a field, and does not walk down a road, turn left, turn right, or <a class="calibre1" id="id920"/>go roundabout and then turn left again), the distance is much shorter and therefore will also change the speed considerably.</p>
      </div>
    </div>

    <div><div><div><div><h2 class="title1"><a class="calibre1" id="ch12lvl2sec63"/>Using Core Location</h2>
          </div>
        </div>
      </div>

      <p class="calibre9">Core Location is the default <a class="calibre1" id="id921"/>framework for the GPS. It is a powerful system for determining the positioning of the device and is far reaching in what it does and how it does it. As with a number of other facilities within iOS, a delegate is required when setting up the Core Location framework. A delegate typically handles events.</p>

      <div><div><div><div><h3 class="title2"><a class="calibre1" id="ch12lvl3sec110"/>Setting up Core Location and delegate</h3>
            </div>
          </div>
        </div>

        <p class="calibre9">Core Location and <a class="calibre1" id="id922"/>delegate can be set up and used as demonstrated with the <a class="calibre1" id="id923"/>following code:</p>

        <div><pre class="programlisting">private CLLocationManager locManager;
public override void ViewDidLoad() {
  base.ViewDidLoad();
  locManager = new CLLocationManager() {
    DesiredAccuracy = CLLocation.AccuracyBest,
  };
}</pre>
        </div>

        <p class="calibre9"><code class="email">CLLocationManager</code> is set up with the desired accuracy being set to the best it can. Next, to make it useful, we need to first catch any errors with the following code:</p>

        <div><pre class="programlisting">locManager.Failed += (object sender, NSErrorEventArgs e) =&gt; {
  UIAlertView alert = new UIAlertView() {
    Title = "Location manager failed",
    Message = string.Format("The following error was encountered –{0}", e.Error.ToString())
  }.Show();
  locManager.StopMonitoring();};</pre>
        </div>

        <p class="calibre9">Once the error system has been set, monitoring the changes to the positioning needs to be handled.</p>

        <div><pre class="programlisting">locManager.LocationsUpdated += (object sender,CLLocationsUpdatedEventArgs e) =&gt; {
  CLLocation[] locs = e.Locations;
  Console.WriteLine("lat = {0},long = {1}",locs[0].Coordinate.Latitude,locs[0].Coordinate.Longitude);
};</pre>
        </div>

        <p class="calibre9">If the app is paused, this <a class="calibre1" id="id924"/>event <a class="calibre1" id="id925"/>will need to be handled:</p>

        <div><pre class="programlisting">bool paused = false;
locManager.LocationUpdatesPaused += delegate {
  if (!paused)
    locManager.StopUpdatingLocation();
  else
    locManager.StartUpdatingLocation();
  paused = !paused;
};</pre>
        </div>

        <p class="calibre9">To start the checks for update monitoring, use the following line of code:</p>

        <div><pre class="programlisting">locManager.StartUpdatingLocation();</pre>
        </div>

        <p class="calibre9">To stop the checks for update monitoring, use the following line of code:</p>

        <div><pre class="programlisting">locManager.StopUpdatingLocation();</pre>
        </div>

        <p class="calibre9">The <code class="email">CLLocationManager</code> class also allows you to monitor the direction you are moving in.</p>

        <div><pre class="programlisting">locManager.UpdatedHeading += (object sender,CLHeadingUpdatedEventArgs e) =&gt; {
  CLHeading heading = e.NewHeading.TrueHeading;Console.WriteLine("New heading : {0}", heading.ToString());
};
locManager.StartUpdatingHeading();</pre>
        </div>
      </div>

      <div><div><div><div><h3 class="title2"><a class="calibre1" id="ch12lvl3sec111"/>Finding where the user is</h3>
            </div>
          </div>
        </div>

        <p class="calibre9">Having coordinates is all well and <a class="calibre1" id="id926"/>good, but who can actually say what they mean? For example, if I were to give you the longitude/latitude coordinates of 53.431/-2.956, would you know where that was? Chances are that you wouldn't!</p>

        <p class="calibre9">This is where reverse geocoding <a class="calibre1" id="id927"/>comes into the picture. The <code class="email">MKReverseGeocoder</code> class is <a class="calibre1" id="id928"/>in the <code class="email">MonoTouch.MapKit</code> namespace.</p>

        <div><pre class="programlisting">private MKReverseGeocoder geoCoder;
geoCoder = new MKReverseGeocoder(locManager.Location.Coordinate);geoCoder.Delegate = new ReverseGeocoder(this);geoCoder.Start(); // geoCoder.Stop() stops the geoCoder</pre>
        </div>

        <p class="calibre9">Unlike <code class="email">locManager</code>, the <code class="email">ReverseGeocoder</code> class has to be placed into a delegate. <code class="email">MKReverseGeocoder</code> doesn't contain any events to latch on to.</p>

        <div><pre class="programlisting">private class ReverseGeocoder : MKReverseGeocoderDelegate {
  UIViewController view;
  public ReverseGeocoder(UIViewController myView) {
    view = myView;
  }

  public override void FoundWithPlacemark(MKReverseGeocoder geocoder, MKPlacemark placemark) {
    Console.WriteLine("Address");
    Console.WriteLine("{0}, {1}, {2}, {3}, {4}",placemark.SubThoroughfare,placemark.Thoroughfare,placemark.Locality,placemark.AdministrativeArea,placemark.Country);
  }
}</pre>
        </div>

        <p class="calibre9">The <code class="email">Xamarin.Mobile</code> component does not contain the ability to perform a <code class="email">ReverseGeocoder</code> operation. But it's not difficult to write one.</p>

        <p class="calibre9">In the original example, the <code class="email">LocationsUpdated</code> method was given as an inline example. If this is changed to point to a method, <a class="calibre1" id="id929"/>the <code class="email">ReverseGeolocation</code> method can be performed:</p>

        <div><pre class="programlisting">private void OnPositionChanged(object sender,PositionEventArgs e) {
  double lng = e.Position.Longitude;
  double lat = e.Position.Latitude;
  CLLocation clloc = new CLLocation(lat, lng);
  CLLocation oldLoc = new CLLocation(prevLat,prevLong);
  CLGeocoder geoRevGeo = new CLGeocoder();
  geoRevGeo.ReverseGeocodeLocation(clloc, GetAddressFromLoc);
}

private void GetAddressFromLoc(CLPlacemark[] place,NSError error) {
  if (place.Length == 0) {
    Console.WriteLine("Don't know where I am – help!");
    return;
  }
  else {
    Console.WriteLine("Address");
    Console.WriteLine("{0}, {1}, {2}, {3}, {4}",place.SubThoroughfare,place.Thoroughfare,placemark.Locality,placemark.AdministrativeArea,placemark.Country);}
}</pre>
        </div>
      </div>

      <div><div><div><div><h3 class="title2"><a class="calibre1" id="ch12lvl3sec112"/>Adding a map</h3>
            </div>
          </div>
        </div>

        <p class="calibre9">The final part to the GPS is to add a <a class="calibre1" id="id930"/>map. For this, a <code class="email">Map</code> view needs to be used by adding <a class="calibre1" id="id931"/>it in either Xcode or code. For my purpose, I will assume it was added via Xcode and is <a class="calibre1" id="id932"/>called <code class="email">mapViewer</code>. There are three types of maps available, so a <code class="email">UISegment</code> control is also added.</p>

        <div><img alt="Adding a map" class="calibre11" src="img/00042.jpeg"/></div>

        <p class="calibre12"/>

        <p class="calibre9">The <code class="email">mapViewer</code> object needs to be set up:</p>

        <div><pre class="programlisting">public override void ViewDidLoad() {
  base.ViewDidLoad();mapViewer.ShowsUserLocation = mapViewer.ZoomEnabled = true;
  mapViewer.MapType = MKMapType.Standard;
  mapViewer.Region = new MKCoordinateRegion(
    new CLLocationCoordinate2D(53.431, -2.956),
    new MKCoordinateSpan(0.5, 0.5)
  );mapViewer.ScrollEnabled = mapViewer.UserInteractionEnabled =true;
}</pre>
        </div>

        <p class="calibre9">The resultant location corresponding <a class="calibre1" id="id933"/>to the coordinates passed in the preceding <a class="calibre1" id="id934"/>code is shown in the following screenshot:</p>

        <div><img alt="Adding a map" class="calibre11" src="img/00043.jpeg"/></div>

        <p class="calibre12"/>

        <p class="calibre9">The next stage is to make the <code class="email">UISegment</code> control go live:</p>

        <div><pre class="programlisting">mapType.ValueChanged += delegate {
  switch (mapType.SelectedSegment) {
    case 0: mapViewer.MapType = MKMapType.Standard;
            break;
    case 1: mapViewer.MapType = MKMapType.Satellite;
            break;
    case 2: mapViewer.MapType = MKMapType.Hybrid;
            break;
  }
};</pre>
        </div>

        <div><img alt="Adding a map" class="calibre11" src="img/00044.jpeg"/></div>

        <p class="calibre12"/>

        <p class="calibre9">In case you didn't know, the geolocation is for <strong class="calibre2">Anfield</strong>, home of Liverpool FC.</p>

        <p class="calibre9">Some of the properties need to be explained in short:</p>

        <div><ul class="itemizedlist">
            <li class="listitem"><code class="email">ShowUserLocation</code>: It <a class="calibre1" id="id935"/>shows a blue dot to show where the <a class="calibre1" id="id936"/>user is</li>

            <li class="listitem"><code class="email">ZoomEnabled</code>: It <a class="calibre1" id="id937"/>allows the user to zoom in</li>

            <li class="listitem"><code class="email">ScrollEnabled</code>: It <a class="calibre1" id="id938"/>allows the user to scroll the view around</li>

            <li class="listitem"><code class="email">UserInteractionEnabled</code>: <a class="calibre1" id="id939"/>It enables a pin placed on the map to respond (or not) when clicked</li>

            <li class="listitem"><code class="email">MKCoordinateSpan(0.5,0.5)</code>: <a class="calibre1" id="id940"/>This is the zoom setting— the smaller the number, the larger the zoom on the initial view</li>
          </ul>
        </div>
      </div>

      <div><div><div><div><h3 class="title2"><a class="calibre1" id="ch12lvl3sec113"/>Adding a pin</h3>
            </div>
          </div>
        </div>

        <p class="calibre9">When it comes to maps, <em class="calibre15">pins</em> are very <a class="calibre1" id="id941"/>useful. While a little blue dot is neat, a pin really <a class="calibre1" id="id942"/>shows you where you are, and information can be added to it.</p>

        <div><pre class="programlisting">MKUserLocation loc = new MKUserLocation() {
  Title = "Anfield stadium",
  Coordinate = new CLLocationCoordinate2D(53.431, -2.956),
  Subtitle = "Home of Liverpool FC",
};mapViewer.AddAnnotationObject(loc);</pre>
        </div>

        <p class="calibre9">Finally, it is always good to center <a class="calibre1" id="id943"/>the map <a class="calibre1" id="id944"/>and pin on the screen</p>

        <div><pre class="programlisting">mapViewer.SetCenterCoordinate(loc.Coordinate, true);</pre>
        </div><img alt="Note" class="calibre10" src="img/00001.gif"/>

        <div><h3 class="title2"><a class="calibre1" id="note05"/>Note</h3>

          <p class="calibre9">The pin does not always work on the simulator.</p>
        </div><img alt="Note" class="calibre10" src="img/00001.gif"/><br class="book"/>
      </div>
    </div>
  </div>


  <div><div><div><div><h1 class="title"><a class="calibre1" id="ch12lvl1sec50"/>Storage on the phone</h1>
        </div>
      </div>
    </div>

    <p class="calibre9">.NET specifies a number of <a class="calibre1" id="id945"/>places in the <code class="email">SpecialFolders</code> enumeration (such as <code class="email">Program Files</code>, <code class="email">My Music</code>, and <code class="email">My Pictures</code>; a full list can be found on the Microsoft website). Due to security restrictions on the iOS devices, only a few of them are available. It is safest to restrict saving any user data to <code class="email">My Documents</code>. Within <code class="email">My Documents</code>, you can create directories of your own and use them the way you like.</p>
  </div>


  <div><div><div><div><h1 class="title"><a class="calibre1" id="ch12lvl1sec51"/>Making a phone call</h1>
        </div>
      </div>
    </div>

    <p class="calibre9">This may sound daft. Why would you <a class="calibre1" id="id946"/>want to write code to make a phone call? In true developer tradition, the answer is <em class="calibre15">why not?</em> It is important to note that a string number is just that. It cannot contain spaces, hyphens, brackets, or the plus sign (+); it can only contain numbers.</p>

    <div><pre class="programlisting">private void callNumber(string number) {
  string phoneURLString = string.Format("tel:{0}", number);
  NSUrl phoneURL = new NSUrl(phoneURLString);
  UIApplication.SharedApplication.OpenUrl(phoneURL);
}</pre>
    </div>

    <p class="calibre9">Moving on...</p>
  </div>


  <div><div><div><div><h1 class="title"><a class="calibre1" id="ch12lvl1sec52"/>Sending and receiving a text message</h1>
        </div>
      </div>
    </div>

    <p class="calibre9">The iPhone comes with its <a class="calibre1" id="id947"/>own built-in messaging software. However, there are some rare times when you need to code a message before sending it. Apple, in its wisdom, though, <a class="calibre1" id="id948"/>does not allow you to send a message without it going through its own message software. This is not to say you can't send a message in another way (such as through a dedicated web or message service), but for standard users, you can't.</p>

    <p class="calibre9">You cannot code in a way that would intercept or block text messages. iOS provides no publicly available method to intercept and read a text message. With that in mind, sending a text message is a relatively straightforward affair. <code class="email">MFMessageComposeViewController</code> is in the <code class="email">MonoTouch.MessageUI</code> namespace.</p>

    <div><pre class="programlisting">private void sendTextMessage(string number, double myLat,double myLong) {
  if (MFMessageComposeViewController.CanSendText) {
    MFMessageComposeViewController message = newMFMessageComposeViewController();
    message.MessageComposeDelegate = newCustomMessageComposeDelegate();
    message.Recipients = new string[] { number };
    message.Body = string.Format("Help! I am currently athttps://maps.google.com/maps?q={0},{1}&amp;z=18 and needassistance", myLat, myLong);
    NavigationController.PresentModalViewController(message,true);
  }
}
public class CustomMessageComposeDelegate :MFMessageComposeViewControllerDelegate {
  public override void  Finished(MFMessageComposeViewController controller,MessageComposeResult result) {
      if (result == MessageComposeResult.Failed ||
        result == MessageComposeResult.Cancelled) {
        UIAlertView alert = new UIAlertView() {
          Title="Message sending error",
          Message="Your message failed to send"
        }.Show();
      }
      controller.DismissViewController(true, null);
  }
}</pre>
    </div>
  </div>


  <div><div><div><div><h1 class="title"><a class="calibre1" id="ch12lvl1sec53"/>Accessing the Internet</h1>
        </div>
      </div>
    </div>

    <p class="calibre9">Access to the internet is <a class="calibre1" id="id949"/>via the <code class="email">UIWebView</code> controller. Prior to trying to access an internet site, it's a good idea to ensure there is a live network connection. This is preformed via the <code class="email">NetworkReachability</code> class.</p>

    <div><pre class="programlisting">using MonoTouch.SystemConfiguration;
NetworkReachability reach = new NetworkReachability("www.bbc.co.uk");
NetworkReachabilityFlags flags = new NetworkReachabilityFlags();
reach.TryGetFlags(out flags);
Console.WriteLine("Network flag = {0}", flags.ToString());</pre>
    </div>

    <p class="calibre9">The <code class="email">WriteLine</code> command will result in one of the following flags:</p>

    <div><table border="1" class="calibre16">
        <colgroup class="calibre17">
          <col class="calibre18"/>
          <col class="calibre18"/>
        </colgroup>

        <thead class="calibre19">
          <tr class="calibre20">
            <th class="calibre21" valign="bottom">
              <p class="calibre22">Flag</p>
            </th>

            <th class="calibre21" valign="bottom">
              <p class="calibre22">Value</p>
            </th>
          </tr>
        </thead>

        <tbody class="calibre23">
          <tr class="calibre20">
            <td class="calibre24" valign="top">
              <p class="calibre22"><code class="literal">Reachable</code> <a class="indexterm" id="id950"/></p>
            </td>

            <td class="calibre24" valign="top">
              <p class="calibre22">The host is reachable</p>
            </td>
          </tr>

          <tr class="calibre20">
            <td class="calibre24" valign="top">
              <p class="calibre22"><code class="literal">IsWWAN</code></p>
            </td>

            <td class="calibre24" valign="top">
              <p class="calibre22">Connection is <a class="indexterm" id="id951"/>made through EDGE, 3G, or 4G</p>
            </td>
          </tr>

          <tr class="calibre20">
            <td class="calibre24" valign="top">
              <p class="calibre22"><code class="literal">IsLocalDevice</code></p>
            </td>

            <td class="calibre24" valign="top">
              <p class="calibre22">Connection is <a class="indexterm" id="id952"/>made to the local device</p>
            </td>
          </tr>

          <tr class="calibre20">
            <td class="calibre24" valign="top">
              <p class="calibre22"><code class="literal">ConnectionAutomatic</code></p>
            </td>

            <td class="calibre24" valign="top">
              <p class="calibre22">Connection is made <a class="indexterm" id="id953"/>automatically. This is an alias for <code class="literal">ConnectionOnTraffic</code>.</p>
            </td>
          </tr>

          <tr class="calibre20">
            <td class="calibre24" valign="top">
              <p class="calibre22"><code class="literal">ConnectionOnTraffic</code></p>
            </td>

            <td class="calibre24" valign="top">
              <p class="calibre22">A <a class="indexterm" id="id954"/>combination of <code class="literal">Reachable</code> and when data is requested, a connection is made</p>
            </td>
          </tr>

          <tr class="calibre20">
            <td class="calibre24" valign="top">
              <p class="calibre22"><code class="literal">ConnectionOnDemand</code></p>
            </td>

            <td class="calibre24" valign="top">
              <p class="calibre22">Occurs when <a class="indexterm" id="id955"/>the connection starts. The connection occurs once the socket is connected.</p>
            </td>
          </tr>

          <tr class="calibre20">
            <td class="calibre24" valign="top">
              <p class="calibre22"><code class="literal">ConnectionRequired</code></p>
            </td>

            <td class="calibre24" valign="top">
              <p class="calibre22">The host can be <a class="indexterm" id="id956"/>reached, but the connection must be made</p>
            </td>
          </tr>

          <tr class="calibre20">
            <td class="calibre24" valign="top">
              <p class="calibre22"><code class="literal">IsDirect</code></p>
            </td>

            <td class="calibre24" valign="top">
              <p class="calibre22">The <a class="indexterm" id="id957"/>connection <a class="indexterm" id="id958"/>is made directly</p>
            </td>
          </tr>

          <tr class="calibre20">
            <td class="calibre24" valign="top">
              <p class="calibre22"><code class="literal">InterventionRequired</code></p>
            </td>

            <td class="calibre24" valign="top">
              <p class="calibre22">When <a class="indexterm" id="id959"/>connected to a host, the user must do something</p>
            </td>
          </tr>

          <tr class="calibre20">
            <td class="calibre24" valign="top">
              <p class="calibre22"><code class="literal">TransientConnection</code></p>
            </td>

            <td class="calibre24" valign="top">
              <p class="calibre22">The host can be <a class="indexterm" id="id960"/>reached, but through a system which starts and stops (such as PPP or any other nonpersistent network connection)</p>
            </td>
          </tr>
        </tbody>
      </table>
    </div>

    <p class="calibre9">Assuming there is a network connection, the next stage is to load the web page.</p>

    <p class="calibre9">I covered loading a web page and some of the settings back in <a class="calibre1" href="../Text/part0022.html#page" title="Chapter 3. Views and Layouts">Chapter 3</a>, <em class="calibre15">Views and Layouts</em>. It is also possible to load a web page from the data you have dynamically generated. This can be simply demonstrated using the following UI with the code. Firstly, set up an application structure as shown with <code class="email">UIWebview</code> in the <code class="email">.xib</code> file:</p>

    <div><img alt="Accessing the Internet" class="calibre11" src="img/00045.jpeg"/></div>

    <p class="calibre12"/>

    <p class="calibre9">The HTML directory can be named as per your wish. I've kept it simple and just called it HTML. When generating your own HTML from within your app, you can either:</p>

    <div><ul class="itemizedlist">
        <li class="listitem">Generate your own file from scratch, save, and get the output</li>

        <li class="listitem">Generate your HTML file using <code class="email">StringBuilder</code> and output that string</li>

        <li class="listitem">Mix the preceding two options</li>
      </ul>
    </div>

    <p class="calibre9">In essence, the two generation methods <a class="calibre1" id="id961"/>are the same with the difference of generating the string either using <code class="email">StringBuilder</code> or concatenate strings. Consider the following lines of code:</p>

    <div><pre class="programlisting">string html = "&lt;html&gt;\n";
html += "&lt;title&gt;Hello World&lt;/title&gt;\n";
html += "&lt;body&gt;\n";
html += "&lt;h1&gt;Hello World!&lt;/h1&gt;\n";
html += "&lt;/body&gt;\n";
html += "&lt;/html&gt;";</pre>
    </div>

    <p class="calibre9">The preceding lines of code should do what you would expect them to, once passed to <code class="email">UIWebview</code> using the following code:</p>

    <div><pre class="programlisting">webView.LoadHTMLString(string s, NSUrl baseurl);
//The baseurl here would be null.</pre>
    </div>

    <p class="calibre9">While these lines of code do their work, creating your web page based on data from within an app using these lines of code can be time consuming. A simpler method is to pull the header and footer in from some HTML fragments within the app.</p>

    <p class="calibre9">To read the files from within the app, though, a couple of steps have to be taken. The first is to set the HTML fragments to be built as <code class="email">BundleResource</code>. You will be loading a file that is part of the bundle rather than a file in the app's writable folder. The second part is to load the HTML bundles into the source:</p>

    <div><pre class="programlisting">var documents = NSBundle.MainBundle.BundlePath;
StringBuilder sb = new StringBuilder();
sb.Append(File.ReadAllText(Path.Combine(documents,"HTML/top.html")));</pre>
    </div>

    <p class="calibre9"><code class="email">NSBundle.MainBundle.BundlePath</code> is the path to the installed application. The next step is to add the data; in my example, I am adding a league table:</p>

    <div><pre class="programlisting">var leagues = (from t in teams
               from p in t.points
               orderby p
               select t).Take(4).ToList(); // takes top 4 only
sb.Append(@"&lt;table width=100%&gt;");
sb.Append(@"&lt;tr width=100%&gt;");
sb.Append(@"&lt;td width=70%&gt;Team name&lt;/td&gt;");
sb.Append(@"&lt;td width=10%&gt;Played&lt;/td&gt;");
sb.Append(@"&lt;td width=10%&gt;G Diff&lt;/td&gt;");
sb.Append(@"&lt;td width=10%&gt;Points&lt;/td&gt;");
for (int i = 0; i &lt; 4; ++i) {
  sb.Append(@"&lt;tr width=100%&gt;");
  sb.Append(@"&lt;td width=30%&gt;" + teams[i].TeamName + "&lt;/td&gt;");
  sb.Append(@"&lt;td width="10"%&gt;" + teams[i].TeamPlayed.ToString() +"&lt;/td&gt;");
  sb.Append(@"&lt;td width="10"%&gt;" + teams[i].TeamGDiff.ToString() +"&lt;/td&gt;");
  sb.Append(@"&lt;td width="10"%&gt;" + teams[i].TeamPts.ToString() +"&lt;/td&gt;");
  sb.Append(@"&lt;/tr&gt;");
}
sb.Append(@"&lt;/table&gt;");
sb.Append(File.ReadAllText(Path.Combine(documents,"HTML/bottom.html")));</pre>
    </div>

    <p class="calibre9">The top table section could as easily be <a class="calibre1" id="id962"/>its own HTML fragment. Once the final append has been made, the HTML is good to go.</p>

    <div><pre class="programlisting">webView.LoadHTMLString(sb.ToString(), null);</pre>
    </div>

    <p class="calibre9">Remember, what you're doing is creating your own web page within the application. If you want to include stylesheets, you can. If you want to include JavaScript, you can; the only caveat is that you can use mobile Safari, which has JavaScript enabled.</p>
  </div>


  <div><div><div><div><h1 class="title"><a class="calibre1" id="ch12lvl1sec54"/>Multimedia</h1>
        </div>
      </div>
    </div>

    <p class="calibre9">This is a very vast topic. Thankfully, <a class="calibre1" id="id963"/>using a camera has been covered at the start of this chapter. Just about everything you need is inside the <code class="email">MonoTouch.MediaPlayer</code> <a class="calibre1" id="id964"/>namespace. As with using a camera, it is important that you first check that the device has video capabilities in exactly the same way as you do for a camera (in fact, it uses the same <code class="email">IsSourceTypeAvailable(myCamera)</code> <a class="calibre1" id="id965"/>command as used for a camera).</p>

    <div><div><div><div><h2 class="title1"><a class="calibre1" id="ch12lvl2sec64"/>Playing a video</h2>
          </div>
        </div>
      </div>

      <p class="calibre9">As with <code class="email">webView</code>, a video can be <a class="calibre1" id="id966"/>external to the device or internal; if it is internal, it could be part of the bundle (not a good idea as video takes up a lot of space on a device, <a class="calibre1" id="id967"/>which will result in long download times), or within the <code class="email">My Document</code> area (downloaded), or in the photo reel.</p>

      <div><div><div><div><h3 class="title2"><a class="calibre1" id="ch12lvl3sec114"/>External URL</h3>
            </div>
          </div>
        </div>

        <p class="calibre9">The video that I'll use here is on <a class="calibre1" id="id968"/>YouTube (you can choose any video of your choice).</p>

        <div><pre class="programlisting">var videoPlayer = new MPMoviePlayerController(NSUrl.FromString("http://www.youtube.com/watch?v=cVikZ8Oe_XA"));
videoPlayer.Play();</pre>
        </div>
      </div>

      <div><div><div><div><h3 class="title2"><a class="calibre1" id="ch12lvl3sec115"/>Internal source</h3>
            </div>
          </div>
        </div>

        <p class="calibre9">Playing from an internal source can <a class="calibre1" id="id969"/>be performed in a way similar to that of an external video file:</p>

        <div><pre class="programlisting">var videoPlayer = new MPMoviePlayerController(NSUrl.FromFilename("myVideo.mp4"));
videoPlayer.Play();</pre>
        </div>
      </div>

      <div><div><div><div><h3 class="title2"><a class="calibre1" id="ch12lvl3sec116"/>From the photo library</h3>
            </div>
          </div>
        </div>

        <p class="calibre9">Choosing a video from the camera roll is <a class="calibre1" id="id970"/>performed in much the same way as picking an image from the photo library.</p>

        <div><pre class="programlisting">UIImagePickerController ipcPicker = new UIImagePickerController()
{
  SourceType = UIImagePickerControllerSourceType.PhotoLibrary,
  MediaTypes = new [] {"public.movie"},
  Delegate = new ImagePickerDelegate(this)
};</pre>
        </div>

        <p class="calibre9">The preceding code goes through the photo library looking for any file that returns the <code class="email">public.movie</code> type. If found, the file is <a class="calibre1" id="id971"/>added to the array and can be seen via the delegate.</p>
      </div>
    </div>

    <div><div><div><div><h2 class="title1"><a class="calibre1" id="ch12lvl2sec65"/>Recording a video</h2>
          </div>
        </div>
      </div>

      <p class="calibre9">This is not substantially different <a class="calibre1" id="id972"/>from taking a picture, except that you have a few <a class="calibre1" id="id973"/>additional parameters that can be altered, such as <code class="email">VideoQuality</code> and <code class="email">AllowEditing</code>.</p>

      <div><div><div><div><h3 class="title2"><a class="calibre1" id="ch12lvl3sec117"/>To record a video</h3>
            </div>
          </div>
        </div>

        <p class="calibre9">Recording a video is a simple task as the following code demonstrates:</p>

        <div><pre class="programlisting">var camera = UIImagePickerControllerSourceType.Camera;
UIImagePickerController ipcVideo = new UIImagePickerController()
{
    SourceType = camera,
    MediaTypes = new [] {"movies.public"},
    AllowEditing = true,
    VideoQuality = UIImagePickerControllerQualityType.Medium,
    Delegate = new ImagePickerDelegate(this)
};</pre>
        </div>

        <p class="calibre9">In the preceding example, <code class="email">AllowEditing</code> has been set to <code class="email">true</code>, which means that the user may edit this video. If that is the intention, editing should be performed using <code class="email">UIVideoEditorController</code>. This controller allows for three events: <code class="email">Failed</code> (the edit failed for some reason), <code class="email">UserCancelled</code> (speaks for itself), and <code class="email">Saved</code> (the user has selected to save the edit; the path is returned <a class="calibre1" id="id974"/>in the <code class="email">e.Path</code> event).</p>
      </div>

      <div><div><div><div><h3 class="title2"><a class="calibre1" id="ch12lvl3sec118"/>Saving the video</h3>
            </div>
          </div>
        </div>

        <p class="calibre9">Once the video has been processed, <a class="calibre1" id="id975"/>the next step is to save the video:</p>

        <div><pre class="programlisting">UIVideo.SaveToPhotoAlbum(videoPath, delegate (string path,NSError error) {
  Console.WriteLine("Video saved.");
});</pre>
        </div>
      </div>
    </div>

    <div><div><div><div><h2 class="title1"><a class="calibre1" id="ch12lvl2sec66"/>The audio system</h2>
          </div>
        </div>
      </div>

      <p class="calibre9">The iPhone and iPad range of <a class="calibre1" id="id976"/>devices is blessed (as are most Apple devices) with a fantastic audio system that allows for great playback quality and the ability to record as well. These facilities are available through the <code class="email">AVAudioPlayer</code> class or <code class="email">SystemSound</code>. If the file is held within the application bundle, it must be set to <code class="email">Content</code> when building <a class="calibre1" id="id977"/>the app.</p>

      <div><div><div><div><h3 class="title2"><a class="calibre1" id="ch12lvl3sec119"/>Playback</h3>
            </div>
          </div>
        </div>

        <p class="calibre9">Audio playback can be considered <a class="calibre1" id="id978"/>short or long if it is under or over the 30 seconds mark. In general, <code class="email">SystemSound</code> is best used for audio files with a duration of less than 30 seconds and also for uncompressed audio formats, such as <code class="email">.wav</code> and <code class="email">.caf</code> (<strong class="calibre2">Core Audio File</strong>). <a class="calibre1" id="id979"/>MP3 files are not supported in <code class="email">SystemSound</code>.</p>

        <div><div><div><div><h4 class="title3"><a class="calibre1" id="ch12lvl4sec08"/>Short files</h4>
              </div>
            </div>
          </div>

          <p class="calibre9">The <code class="email">SystemSound</code> <a class="calibre1" id="id980"/>method is a <a class="calibre1" id="id981"/>quick and easy way to play an audio file with very little overhead.</p>

          <div><pre class="programlisting">var sound = SystemSound.FromFile("myAudio.caf");
sound.PlaySystemSound();</pre>
          </div>

          <p class="calibre9">If you need an audio file to play but you are at some place requiring silence (say, a library), the device can be made to vibrate through the length of the file.</p>

          <div><pre class="programlisting">sound.Vibrate.PlaySystemSound();</pre>
          </div>
        </div>

        <div><div><div><div><h4 class="title3"><a class="calibre1" id="ch12lvl4sec09"/>Long (and compressed) files</h4>
              </div>
            </div>
          </div>

          <p class="calibre9">Here the <code class="email">AVAudioPlayer</code> <a class="calibre1" id="id982"/>class comes into its own, allowing you to alter power levels (the volume on a channel) effectively, pause, play, and stop an audio file. It also handles compressed audio formats, such as MP3.</p>
        </div>

        <div><div><div><div><h4 class="title3"><a class="calibre1" id="ch12lvl4sec10"/>Setting the power levels</h4>
              </div>
            </div>
          </div>

          <p class="calibre9">Prior to setting a power <a class="calibre1" id="id983"/>level, <a class="calibre1" id="id984"/>either or both the <code class="email">AveragePower</code> and <code class="email">PeakPower.MeteringEnabled</code> Booleans have to be set to <code class="email">true</code> and a method named <code class="email">UpdateMeters()</code> must be called. It is then just a case of setting <code class="email">AveragePower(uint)</code> or <code class="email">PeakPower(uint)</code> to the value you want (in dBs).</p>
        </div>

        <div><div><div><div><h4 class="title3"><a class="calibre1" id="ch12lvl4sec11"/>Playing the audio file</h4>
              </div>
            </div>
          </div>

          <p class="calibre9">It is not difficult to play an <a class="calibre1" id="id985"/>audio file; select the file and tell the device to play. The <a class="calibre1" id="id986"/>following code demonstrates how:</p>

          <div><pre class="programlisting">var fileToPlay = AVAudioPlayer.FromUrl(NSUrl.FromFilename("myAudio.mp3"));
fileToPlay.Play();
fileToPlay.FinishedPlaying += delegate {
  fileToPlay.Dispose(); // clean up
};</pre>
          </div>
        </div>

        <div><div><div><div><h4 class="title3"><a class="calibre1" id="ch12lvl4sec12"/>Altering the volume</h4>
              </div>
            </div>
          </div>

          <p class="calibre9">If you don't want Beethoven's <a class="calibre1" id="id987"/>ninth blasting out of your iOS device, it's a good idea to <a class="calibre1" id="id988"/>turn down the volume as follows:</p>

          <div><pre class="programlisting">using MonoTouch.MediaPlayer
var mpPlayer = new MPMusicPlayerController();
mPlayer.Volume = 0.01f; // max volume – range 0 to 1</pre>
          </div>

          <p class="calibre9">A word of caution, though, for setting a volume level: <em class="calibre15">don't set it to zero</em>. This annoys the iOS device and will then annoy the user as the device will take great pleasure in reminding you that the volume is set to <code class="email">0</code>. As the figure is a float value, <code class="email">0.01</code> will do just as well as <code class="email">0</code> to mute the device.</p>
        </div>
      </div>
    </div>

    <div><div><div><div><h2 class="title1"><a class="calibre1" id="ch12lvl2sec67"/>Recording Audio</h2>
          </div>
        </div>
      </div>

      <p class="calibre9">Recording is not as simple as playing. <a class="calibre1" id="id989"/>While a lot of the work is done by the <code class="email">AVAudioRecorder</code> class, quite a bit of work also has to be done by the programmer to record the audio. The key point to remember is that <code class="email">NSDictionary</code> needs to be set up before anything can happen. This dictionary contains important information, such as the type of audio, sample rate, quality, and so on.</p>

      <div><div><div><div><h3 class="title2"><a class="calibre1" id="ch12lvl3sec120"/>Setting up the audio NSDictionary</h3>
            </div>
          </div>
        </div>

        <p class="calibre9">The <code class="email">NSDictionary</code> (along with <a class="calibre1" id="id990"/>anything else that starts with <code class="email">NS</code>) is an interface to the <code class="email">Objective-C</code> bindings that <code class="email">Xamarin.iOS</code> utilizes to allow development with the .NET framework on iOS and, as such, can't be set up like a normal dictionary. To get around that obstacle, a generic <code class="email">NSObject</code> object can be used, one for the settings, the other for the description (which works out to be the same as the values and keys in .NET).</p>

        <div><pre class="programlisting">var settings = new NSObject[] {
  NSNumber.FromFloat(22050.0f),
  NSNumber.FromInt32((int)AudioFileType.WAVE),
  NSNumber.FromInt32(2),
  NSNumber.FromInt32((int)AVAudioQuality.Min)
};
var keysToSettings = new NSObject[] {
  AVAudioSettings.AVSampleRateKey,
  AVAudioSettings.AVFormatKey,
  AVAudioSettings.AVNumberOfChannelsKey,
  AVAudioSettings.AVEncoderAudioQualityKey
};
var dict = NSDictionary.FromObjectsAndKeys(settings,keysToSettings);</pre>
        </div>

        <div><div><div><div><h4 class="title3"><a class="calibre1" id="ch12lvl4sec13"/>Setting up to record</h4>
              </div>
            </div>
          </div>

          <p class="calibre9">The next step is to set up the <a class="calibre1" id="id991"/>recorder itself and, importantly, the location to save the audio file to.</p>

          <div><pre class="programlisting">var docs = Environment.GetFolderPath(Environment.SpecialFolder.Personal);
var audio = NSUrl.FromFilename(Path.Combine(docs,"testaudio.wav");
var error = new NSError(); // catch the errors</pre>
          </div>
        </div>

        <div><div><div><div><h4 class="title3"><a class="calibre1" id="ch12lvl4sec14"/>Recording the audio file</h4>
              </div>
            </div>
          </div>

          <p class="calibre9">Finally, it's time to record. As the file <a class="calibre1" id="id992"/>records, it's also saved to the device. Once finished with recording, the recorder object needs to be disposed. Thankfully, we can control how long a recording goes on by using the <code class="email">RecordFor("float time")</code> method.</p>

          <div><pre class="programlisting">var myRecorder = AVAudioRecorder.ToUrl(audio, dict, out error);
myRecorder.FinishedRecording += delegate {
  Console.WriteLine("Audio file created");
  myRecorder.Dispose();
};
myRecorder.RecordFor(10f);</pre>
          </div>
        </div>
      </div>
    </div>
  </div>


  <div><div><div><div><h1 class="title"><a class="calibre1" id="ch12lvl1sec55"/>Summary</h1>
        </div>
      </div>
    </div>

    <p class="calibre9">It is simple enough to use the subsystems that the iOS devices make use of, as long as you remember the limitations, such as only being able to send texts and not receive. The devices offer far more than what the average user sees and it only requires a small amount of imagination to see how to create a really good application using the facilities offered to you; from maps to web views to making calls, it's all there for you. Now play!</p>
  </div>
</body></html>