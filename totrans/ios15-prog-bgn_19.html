<html><head></head><body>
		<div id="_idContainer390">
			<h1 id="_idParaDest-218"><em class="italic"><a id="_idTextAnchor223"/>Chapter 16</em>: Getting Started with MapKit</h1>
			<p>In the previous chapter, you learned about table views and table view controllers, and completed the implementation of the <strong class="bold">Locations</strong> screen. It now displays a list of restaurant locations.</p>
			<p>In this chapter, you'll display restaurant locations on the <strong class="bold">Map</strong> screen using custom pins. When you tap on a pin, you'll see a screen that shows details of a particular restaurant. Apple provides a <strong class="source-inline">MKAnnotation</strong> protocol, which allows you to associate the classes you create with a specific map location. You'll create a new class, <strong class="source-inline">RestaurantItem</strong>, that conforms to this protocol. Next, you'll create <strong class="source-inline">MapDataManager</strong>, a data manager class that loads restaurant data from a <strong class="source-inline">.plist</strong> file and puts it into an array of <strong class="source-inline">RestaurantItem</strong> instances. You'll create a new <strong class="source-inline">DataManager</strong> protocol to read <strong class="source-inline">.plist</strong> files and update both the <strong class="source-inline">MapDataManager</strong> and <strong class="source-inline">ExploreDataManager</strong> classes to avoid redundant code (refactoring). After that, you'll create a <strong class="source-inline">MapViewController</strong> class, a view controller for the <strong class="bold">Map</strong> screen, and configure it to display custom pins. You'll configure the pins to display callouts and configure buttons in the callouts to display the <strong class="bold">Restaurant Detail</strong> screen when tapped. You'll then create the <strong class="source-inline">RestaurantDetailViewController</strong> class, a view controller for the <strong class="bold">Restaurant Detail</strong> screen, and pass restaurant data to it from the <strong class="source-inline">MapViewController</strong> instance. Finally, you'll clean up and organize your code using extensions to make it easier to read and maintain. </p>
			<p>By the end of this chapter, you'll have learned how to create custom map annotation views and add them to a map, how to use storyboard references to link storyboards together, and how to use extensions to organize your code, making it easier to read.</p>
			<p>The following topics will be covered:</p>
			<ul>
				<li>Understanding and creating annotations</li>
				<li>Adding annotations to a map view</li>
				<li>Going from the map view to the <strong class="bold">Restaurant Detail</strong> screen</li>
				<li>Organizing your code</li>
			</ul>
			<h1 id="_idParaDest-219"><a id="_idTextAnchor224"/>Technical requirements</h1>
			<p>You will continue working on the <strong class="source-inline">LetsEat</strong> project that you modified in the previous chapter.</p>
			<p>The resource files and completed Xcode project for this chapter are in the <strong class="source-inline">Chapter16 </strong>folder of the code bundle for this book, which can be downloaded here:</p>
			<p><a href="https://github.com/PacktPublishing/iOS-15-Programming-for-Beginners-Sixth-Edition">https://github.com/PacktPublishing/iOS-15-Programming-for-Beginners-Sixth-Edition</a></p>
			<p>Check out the following video to see the code in action:</p>
			<p><a href="https://bit.ly/3kEKEB7">https://bit.ly/3kEKEB7</a></p>
			<p>Now let's learn about map annotations, which are used to mark restaurant locations on the <strong class="bold">Map</strong> screen.</p>
			<h1 id="_idParaDest-220"><a id="_idTextAnchor225"/>Understanding and creating annotations</h1>
			<p>In <a href="B17469_11_Final_VK_ePub.xhtml#_idTextAnchor171"><em class="italic">Chapter 11</em></a><em class="italic">, Finishing Up Your User Interface</em>, you<a id="_idIndexMarker765"/> added a map <a id="_idIndexMarker766"/>view to the <strong class="bold">Map</strong> screen. A map view is an instance of the <strong class="source-inline">MKMapView</strong> class. You can see what it looks like in the Apple <em class="italic">Maps</em> app.</p>
			<p class="callout-heading">Important Information</p>
			<p class="callout">To learn more about <strong class="source-inline">MKMapView</strong>, see <a href="https://developer.apple.com/documentation/mapkit/mkmapview">https://developer.apple.com/documentation/mapkit/mkmapview</a>.</p>
			<p>When you build and run your app, you will see a map on the screen. The part of the map that is visible onscreen can be specified by setting the <strong class="source-inline">region</strong> property of the map.</p>
			<p class="callout-heading">Important Information</p>
			<p class="callout">To learn more about regions and how to make them, see <a href="https://developer.apple.com/documentation/mapkit/mkmapview/1452709-region">https://developer.apple.com/documentation/mapkit/mkmapview/1452709-region</a>.</p>
			<p>Pins on the <strong class="bold">Map</strong> screen are used to mark specific locations, and are instances of the <strong class="source-inline">MKAnnotationView</strong> class. To add a pin to a map view, you need an object that conforms to the <strong class="source-inline">MKAnnotation</strong> protocol. This protocol allows you to associate an object with a specific map location.</p>
			<p class="callout-heading">Important Information</p>
			<p class="callout">To learn more about the <strong class="source-inline">MKAnnotation</strong> protocol, see <a href="https://developer.apple.com/documentation/mapkit/mkannotation">https://developer.apple.com/documentation/mapkit/mkannotation</a>.</p>
			<p>Any object can conform to the <strong class="source-inline">MKAnnotation</strong> protocol by implementing a <strong class="source-inline">coordinate</strong> property, which contains a map location. Optional <strong class="source-inline">MKAnnotation</strong> protocol properties are <strong class="source-inline">title</strong>, a string containing the annotation's title, and <strong class="source-inline">subtitle</strong>, a string containing the annotation's subtitle. </p>
			<p>When an<a id="_idIndexMarker767"/> object <a id="_idIndexMarker768"/>conforming to the <strong class="source-inline">MKAnnotation</strong> protocol is in the area of the map that is visible onscreen, the map view asks its delegate (usually a view controller) to provide a corresponding instance of the <strong class="source-inline">MKAnnotationView</strong> class. This instance appears as a pin on the map. </p>
			<p class="callout-heading">Important Information</p>
			<p class="callout">To learn more about <strong class="source-inline">MKAnnotationView</strong>, see <a href="https://developer.apple.com/documentation/mapkit/mkannotationview">https://developer.apple.com/documentation/mapkit/mkannotationview</a>.</p>
			<p>If the user scrolls the map and the <strong class="source-inline">MKAnnotationView</strong> instance goes off screen, it will be put into a reuse queue and recycled later, similar to the way table view cells and collection view cells are recycled. An <strong class="source-inline">MKAnnotationView</strong> instance can be customized to display custom icons and can display callout bubbles when tapped. Callout bubbles can have buttons that perform actions, such as displaying a screen.</p>
			<p>For your app, you will create a new class, <strong class="source-inline">RestaurantItem</strong>, that conforms to the <strong class="source-inline">MKAnnotation</strong> protocol. Let's see how to create this class in the next section.</p>
			<h2 id="_idParaDest-221"><a id="_idTextAnchor226"/>Creating the RestaurantItem class</h2>
			<p>To represent <a id="_idIndexMarker769"/>restaurant locations on the <strong class="bold">Map</strong> screen, you will create a class, <strong class="source-inline">RestaurantItem</strong>, that conforms to the <strong class="source-inline">MKAnnotation</strong> protocol. This class will have a <strong class="source-inline">coordinate</strong> property to store the restaurant's location, a <strong class="source-inline">title</strong> property to store the restaurant name, and a <strong class="source-inline">subtitle</strong> property to store the cuisines it offers.</p>
			<p>You need the restaurant location to set the <strong class="source-inline">coordinate</strong> property of the <strong class="source-inline">RestaurantItem</strong> instance. The restaurant data (including its location) will be provided as a <strong class="source-inline">.plist</strong> file. Before you create the <strong class="source-inline">RestaurantItem</strong> class, you need to import this <strong class="source-inline">.plist</strong> file into your app. Follow these steps:</p>
			<ol>
				<li>Open the <strong class="source-inline">LetsEat</strong> project. In the Project navigator, right-click the <strong class="source-inline">LetsEat</strong> folder and create a new group called <strong class="source-inline">Map</strong>.</li>
				<li>Right-click the <strong class="source-inline">Map</strong> folder and create a new group called <strong class="source-inline">Model</strong>.</li>
				<li>If you have not yet done so, download the completed project and project resources from <a href="https://github.com/PacktPublishing/iOS-15-Programming-for-Beginners-Sixth-Edition">https://github.com/PacktPublishing/iOS-15-Programming-for-Beginners-Sixth-Edition</a> and find the <strong class="source-inline">Maplocations.plist</strong> file inside the <strong class="source-inline">resources</strong> folder in the <strong class="source-inline">Chapter16</strong> folder.</li>
				<li>Drag the <strong class="source-inline">Maplocations.plist</strong> file to the <strong class="source-inline">Model</strong> folder in your project, and click it to view its contents. You'll see that it is an array of dictionaries, with each dictionary containing a restaurant's details (including its location). You'll create properties in your <strong class="source-inline">RestaurantItem</strong> class for the data that you will use, which will eventually be displayed on the <strong class="bold">Restaurant Detail</strong> screen:</li>
			</ol>
			<p class="figure-caption"> </p>
			<div>
				<div id="_idContainer367" class="IMG---Figure">
					<img src="image/Figure_16.01_B17469.jpg" alt="Figure 16.1: Editor area showing the contents of MapLocations.plist&#13;&#10;"/>
				</div>
			</div>
			<p class="figure-caption">Figure 16.1: Editor area showing the contents of MapLocations.plist</p>
			<p>Let's create<a id="_idIndexMarker770"/> the <strong class="source-inline">RestaurantItem</strong> class by following these steps:</p>
			<ol>
				<li value="1">Right-click the <strong class="source-inline">Model</strong> folder and select <strong class="bold">New File</strong>.</li>
				<li><strong class="bold">iOS</strong> should already be selected. Choose <strong class="bold">Cocoa Touch Class</strong> and then click <strong class="bold">Next</strong>.</li>
				<li>Configure the file as follows:<p><strong class="bold">Class</strong>: <strong class="source-inline">RestaurantItem</strong></p><p><strong class="bold">Subclass</strong>: <strong class="source-inline">NSObject</strong></p><p><strong class="bold">Also create XIB</strong>: Greyed out</p><p><strong class="bold">Language</strong>: <strong class="source-inline">Swift</strong></p><p>Click <strong class="bold">Next</strong>.</p></li>
				<li>Click <strong class="bold">Create</strong>. The <strong class="source-inline">RestaurantItem</strong> file appears in the Project navigator.</li>
				<li>In the <strong class="source-inline">RestaurantItem</strong> file, type the following after the <strong class="source-inline">import UIKit </strong>statement to import the <strong class="source-inline">MapKit</strong> framework:<p class="source-code">import MapKit</p><p>This gives you access to protocols such as <strong class="source-inline">MKAnnotation</strong> and <strong class="source-inline">MKMapViewDelegate</strong>.</p></li>
				<li>Modify the class declaration as follows to adopt the <strong class="source-inline">MKAnnotation</strong> protocol:<p class="source-code">class RestaurantItem: NSObject<strong class="bold">, MKAnnotation</strong> {</p><p>You'll see an error, because you have not yet implemented the <strong class="source-inline">coordinate</strong> property, which is required to conform to <strong class="source-inline">MKAnnotation</strong>. You will do so shortly.</p></li>
				<li>Type the <a id="_idIndexMarker771"/>following between the curly braces:<p class="source-code">let name: String?</p><p class="source-code">let cuisines: [String]</p><p class="source-code">let lat: Double?</p><p class="source-code">let long: Double?</p><p class="source-code">let address: String?</p><p class="source-code">let postalCode: String?</p><p class="source-code">let state: String?</p><p class="source-code">let imageURL: String?</p><p class="source-code">let restaurantID: Int?</p><p>These properties will hold the data you get from the <strong class="source-inline">Maplocations.plist</strong> file. Let's see what they are for:</p><p><strong class="source-inline">name</strong> stores the name of the restaurant.</p><p><strong class="source-inline">cuisines</strong> stores the cuisines offered by the restaurant.</p><p><strong class="source-inline">lat</strong> and <strong class="source-inline">long</strong> stores the latitude and the longitude of the restaurant location.</p><p><strong class="source-inline">address</strong> stores the restaurant's address.</p><p><strong class="source-inline">postalCode</strong> stores the restaurant's postal code.</p><p><strong class="source-inline">state</strong> stores the state in which the restaurant is located.</p><p><strong class="source-inline">imageURL</strong> stores a a link to a photo of the restaurant.</p><p><strong class="source-inline">restaurantID</strong> stores a unique number used as an identifier for the restaurant.</p><p>Note that you haven't created properties to store every detail of a restaurant contained in the <strong class="source-inline">Maplocations.plist</strong> file, and that's fine. You only need to create<a id="_idIndexMarker772"/> properties for the details that will appear on the <strong class="bold">Restaurant Detail</strong> screen.</p></li>
				<li>You'll use a custom initializer to initialize <strong class="source-inline">RestaurantItem</strong> instances with data from the <strong class="source-inline">.plist</strong> file. Type the following after the last property declaration:<p class="source-code">init(dict: [String: AnyObject]) {</p><p class="source-code">   self.lat = dict["lat"] as? Double</p><p class="source-code">   self.long = dict["long"] as? Double </p><p class="source-code">   self.name = dict["name"] as? String  </p><p class="source-code">   self.cuisines = dict["cuisines"] as? [String] ?? []</p><p class="source-code">   self.address = dict["address"] as? String</p><p class="source-code">   self.postalCode = dict["postalCode"] as? String</p><p class="source-code">   self.state = dict["state"] as? String </p><p class="source-code">   self.imageURL = dict["image_url"] as? String</p><p class="source-code">   self.restaurantID = dict["id"] as? Int</p><p class="source-code">}</p><p>Even though this initializer looks complicated, it's actually quite straightforward. Each line looks for a specific dictionary item key and assigns its value to the corresponding property. For example, the first line looks for the dictionary item with a key containing <strong class="source-inline">lat</strong> and assigns the associated value to the <strong class="source-inline">lat</strong> property.</p></li>
				<li>You'll use the <strong class="source-inline">lat</strong> and <strong class="source-inline">long</strong> properties to create the value for the <strong class="source-inline">coordinate</strong> property, which is required to conform to <strong class="source-inline">MKAnnotation</strong>. Type the <a id="_idIndexMarker773"/>following after the <strong class="source-inline">init(dict:)</strong> method to implement it:<p class="source-code">var coordinate: CLLocationCoordinate2D {</p><p class="source-code">   guard let lat = lat, let long = long else { </p><p class="source-code">      return CLLocationCoordinate2D() </p><p class="source-code">   }</p><p class="source-code">   return CLLocationCoordinate2D(latitude: lat,</p><p class="source-code">   longitude: long)</p><p class="source-code">}</p><p>The <strong class="source-inline">coordinate</strong> property is of type <strong class="source-inline">CLLocationCoordinate2D</strong>, and it holds a geographical location. The value of the <strong class="source-inline">coordinate</strong> property is not assigned directly; the <strong class="source-inline">guard</strong> statement gets the latitude and longitude values from the <strong class="source-inline">lat</strong> and <strong class="source-inline">long</strong> properties, which are then used to create the value for the <strong class="source-inline">coordinate</strong> property. Such <a id="_idIndexMarker774"/>properties are called <strong class="bold">computed properties</strong>.</p></li>
				<li>Implement the <strong class="source-inline">title</strong> property by adding the following code after the <strong class="source-inline">coordinate</strong> property:<p class="source-code">var title: String? {</p><p class="source-code">   name</p><p class="source-code">}</p><p><strong class="source-inline">title</strong> is a computed property that returns the contents of the <strong class="source-inline">name</strong> property.</p></li>
				<li>Finally, implement the <strong class="source-inline">subtitle</strong> property by adding the following code after the <strong class="source-inline">title</strong> property:<p class="source-code">var subtitle: String? {</p><p class="source-code">   if cuisines.isEmpty { </p><p class="source-code">      return "" </p><p class="source-code">   } else if cuisines.count == 1 { </p><p class="source-code">      return cuisines.first </p><p class="source-code">   } else { </p><p class="source-code">      return cuisines.joined(separator: ", ") </p><p class="source-code">   }</p><p class="source-code">}</p><p><strong class="source-inline">subtitle</strong> is also <a id="_idIndexMarker775"/>a computed property. The first line checks to see whether the <strong class="source-inline">cuisines</strong> property is empty, and if so, returns an empty string. If the <strong class="source-inline">cuisines</strong> property contains a single item, that item will be returned. If the <strong class="source-inline">cuisines</strong> property has more than a single item, each item is added to a string, with a comma in between items. For example, if <strong class="source-inline">cuisines</strong> contained the <strong class="source-inline">["American", "Bistro", "Burgers"]</strong> array, the generated string would be <strong class="source-inline">"American, Bistro, Burgers"</strong>.</p><p>Your <strong class="source-inline">RestaurantItem</strong> class is now complete and free of errors and should look like this:</p><p class="source-code">import UIKit </p><p class="source-code">import MapKit</p><p class="source-code">class RestaurantItem: NSObject, MKAnnotation {</p><p class="source-code">   let name: String?</p><p class="source-code">   let cuisines: [String]</p><p class="source-code">   let lat: Double?</p><p class="source-code">   let long: Double?</p><p class="source-code">   let address: String?</p><p class="source-code">   let postalCode: String?</p><p class="source-code">   let state: String?</p><p class="source-code">   let imageURL: String?</p><p class="source-code">   let restaurantID: Int?</p><p class="source-code">   init(dict: [String: AnyObject]) {</p><p class="source-code">      self.lat = dict["lat"] as? Double</p><p class="source-code">      self.long = dict["long"] as? Double </p><p class="source-code">      self.name = dict["name"] as? String  </p><p class="source-code">      self.cuisines = dict["cuisines"] as? [String] </p><p class="source-code">      ?? []</p><p class="source-code">      self.address = dict["address"] as? String</p><p class="source-code">      self.postalCode = dict["postalCode"] as? String</p><p class="source-code">      self.state = dict["state"] as? String </p><p class="source-code">      self.imageURL = dict["image_url"] as? String</p><p class="source-code">      self.restaurantID = dict["id"] as? Int</p><p class="source-code">   }</p><p class="source-code">   var coordinate: CLLocationCoordinate2D {</p><p class="source-code">      guard let lat = lat, let long = long else {</p><p class="source-code">         return CLLocationCoordinate2D() </p><p class="source-code">      }</p><p class="source-code">      return CLLocationCoordinate2D(latitude: lat,</p><p class="source-code">      longitude: long)</p><p class="source-code">   }</p><p class="source-code">   var title: String? {</p><p class="source-code">      name</p><p class="source-code">   }</p><p class="source-code">   var subtitle: String? {</p><p class="source-code">      if cuisines.isEmpty { </p><p class="source-code">         return "" </p><p class="source-code">      } else if cuisines.count == 1 { </p><p class="source-code">         return cuisines.first </p><p class="source-code">      } else { </p><p class="source-code">         return cuisines.joined(separator: ", ") </p><p class="source-code">      }</p><p class="source-code">   }</p><p class="source-code">}</p></li>
			</ol>
			<p>At this point, you've added the <strong class="source-inline">Maplocations.plist</strong> file to your app, and you have created<a id="_idIndexMarker776"/> the <strong class="source-inline">RestaurantItem</strong> class. Next, let's create a data manager class that reads restaurant data from the <strong class="source-inline">Maplocations.plist</strong> file and puts it into an array of  <strong class="source-inline">RestaurantItem</strong> instances for use by your app.</p>
			<h2 id="_idParaDest-222"><a id="_idTextAnchor227"/>Creating the MapDataManager class</h2>
			<p>As you have done <a id="_idIndexMarker777"/>in previous chapters, you'll create a data manager class, <strong class="source-inline">MapDataManager</strong>, that will load restaurant data from the <strong class="source-inline">Maplocations.plist</strong> file and put the data into an array of <strong class="source-inline">RestaurantItem</strong> instances. Follow these steps:</p>
			<ol>
				<li value="1">Right-click the <strong class="source-inline">Model</strong> folder inside the <strong class="source-inline">Map</strong> folder and select <strong class="bold">New File</strong>.</li>
				<li><strong class="bold">iOS</strong> should already be selected. Choose <strong class="bold">Swift File</strong> and then click <strong class="bold">Next</strong>.</li>
				<li>Name this file <strong class="source-inline">MapDataManager</strong>. Click <strong class="bold">Create</strong>. The <strong class="source-inline">MapDataManager</strong> file appears in the Project navigator.</li>
				<li>In the <strong class="source-inline">MapDataManager</strong> file, add the following after the <strong class="source-inline">import</strong> statement to declare the <strong class="source-inline">MapDataManager</strong> class:<p class="source-code">class MapDataManager {</p><p class="source-code"> </p><p class="source-code">}</p></li>
				<li>Add the following properties between the curly braces to store the <strong class="source-inline">RestaurantItem</strong> instances<a id="_idIndexMarker778"/> that will be read from the <strong class="source-inline">.plist</strong> file:<p class="source-code">private var items: [RestaurantItem] = []</p><p class="source-code">var annotations: [RestaurantItem] {</p><p class="source-code">   items </p><p class="source-code">}</p><p>The <strong class="source-inline">items</strong> array will contain <strong class="source-inline">RestaurantItem</strong> instances. <strong class="source-inline">private</strong> makes the <strong class="source-inline">items</strong> array only accessible within the <strong class="source-inline">MapDataManager</strong> class, and <strong class="source-inline">annotations</strong> is a computed property that returns a copy of the <strong class="source-inline">items</strong> array when accessed. This allows the contents of the <strong class="source-inline">items</strong> array to be accessed, but not modified, by other objects.</p></li>
				<li>Add the following methods after the property declarations to load the <strong class="source-inline">.plist</strong> file, read the data inside, and store it in an array of <strong class="source-inline">RestaurantItem</strong> instances:<p class="source-code">private func loadData() -&gt; [[String: AnyObject]] {</p><p class="source-code">   guard let path = Bundle.main.path(forResource:</p><p class="source-code">   "MapLocations", ofType: "plist"), </p><p class="source-code">   let itemsData = FileManager.default.contents(</p><p class="source-code">   atPath: path),</p><p class="source-code">   let items = try! PropertyListSerialization</p><p class="source-code">   .propertyList(from: itemsData, format: nil) as? </p><p class="source-code">   [[String: AnyObject]] else {</p><p class="source-code">      return [[:]]</p><p class="source-code">   }</p><p class="source-code">   return items</p><p class="source-code">} </p><p class="source-code">func fetch(completion: (_ annotations: </p><p class="source-code">[RestaurantItem]) -&gt; ()){</p><p class="source-code">   if !items.isEmpty { </p><p class="source-code">      items.removeAll() </p><p class="source-code">   }</p><p class="source-code">   for data in loadData() {</p><p class="source-code">      items.append(RestaurantItem(dict: data))</p><p class="source-code">   }</p><p class="source-code">   completion(items)</p><p class="source-code">}</p><p>The <strong class="source-inline">loadData()</strong> and <strong class="source-inline">fetch(completion:)</strong> methods <a id="_idIndexMarker779"/>perform the same tasks as the <strong class="source-inline">loadData()</strong> and  <strong class="source-inline">fetch()</strong> methods in the <strong class="source-inline">ExploreDataManager</strong> class. </p><p class="callout-heading">Tip</p><p class="callout">You may wish to re-read <a href="B17469_14_Final_VK_ePub.xhtml#_idTextAnchor201"><em class="italic">Chapter 14</em></a><em class="italic">, Getting Data into Collection Views</em>, to refresh your memory on the <strong class="source-inline">ExploreDataManager</strong> class.</p></li>
			</ol>
			<p>However, the <strong class="source-inline">loadData()</strong> method used here is able to return an array containing dictionaries where the values are of the <strong class="source-inline">AnyObject</strong> type. This is necessary since the <strong class="source-inline">MapLocations.plist</strong> file, unlike the <strong class="source-inline">ExploreData.plist</strong> file, does not exclusively contain dictionaries of the <strong class="source-inline">[String: String</strong>] type. Also, the <strong class="source-inline">fetch(completion:)</strong> method used here has a completion closure as a parameter, which can accept any function or closure that takes an array of <strong class="source-inline">RestaurantItems</strong> as a parameter:</p>
			<p class="source-code">(_ annotations:[RestaurantItem]) -&gt; ())</p>
			<p>Sometimes, you don't know when an operation will be finished. For example, you need to do an action after you've downloaded a file from the internet, but you don't know how long it would take to download. You can specify a completion closure to be applied once the operation has been completed. In this case, the completion closure will process the <strong class="source-inline">items</strong> array once all the data from the <strong class="source-inline">.plist</strong> file has been read.</p>
			<p>Now consider<a id="_idIndexMarker780"/> the <strong class="source-inline">MapLocations.plist</strong> file once more:</p>
			<div>
				<div id="_idContainer368" class="IMG---Figure">
					<img src="image/Figure_16.02_B17469.jpg" alt="Figure 16.2: Editor area showing array and dictionaries in MapLocations.plist&#13;&#10;"/>
				</div>
			</div>
			<p class="figure-caption">Figure 16.2: Editor area showing array and dictionaries in MapLocations.plist</p>
			<p>This file has the same structure as <strong class="source-inline">ExploreData.plist</strong>. The <strong class="source-inline">Root</strong> item is an array that contains dictionaries. Since both <strong class="source-inline">ExploreData.plist</strong> and <strong class="source-inline">MapLocations.plist</strong> have an array of dictionaries, it would be more efficient if you could create a single method to load <strong class="source-inline">.plist</strong> files and use it wherever it was needed. You will do this in the next section.</p>
			<h2 id="_idParaDest-223"><a id="_idTextAnchor228"/>Creating the DataManager protocol</h2>
			<p>Instead of<a id="_idIndexMarker781"/> creating a method in each class to load a <strong class="source-inline">.plist</strong> file, you will create a new protocol, <strong class="source-inline">DataManager</strong>, to handle <strong class="source-inline">.plist</strong> file loading. This protocol will implement a method to load <strong class="source-inline">.plist</strong> files using an extension. </p>
			<p class="callout-heading">Tip</p>
			<p class="callout">You may wish to re-read <a href="B17469_08_Final_VK_ePub.xhtml#_idTextAnchor123"><em class="italic">Chapter 8</em></a><em class="italic">, Protocols, Extensions, and Error Handling</em>, which covers protocols and extensions.</p>
			<p>After you have created the <strong class="source-inline">DataManager</strong> protocol, any class that needs to load a <strong class="source-inline">.plist</strong> file can adopt it. You'll modify both <strong class="source-inline">ExploreDataManager</strong> and <strong class="source-inline">MapDataManager</strong> classes to adopt this protocol. Follow these steps:</p>
			<ol>
				<li value="1">Right-click the <strong class="source-inline">LetsEat</strong> folder and create a new group called <strong class="source-inline">Misc</strong>.</li>
				<li>Right-click on the <strong class="source-inline">Misc</strong> folder and choose <strong class="bold">New File</strong>.</li>
				<li><strong class="bold">iOS</strong> should already be selected. Choose <strong class="bold">Swift File</strong> and then click <strong class="bold">Next</strong>.</li>
				<li>Name<a id="_idIndexMarker782"/> this file <strong class="source-inline">DataManager</strong>. Click <strong class="bold">Create</strong>.</li>
				<li>Click the <strong class="source-inline">DataManager</strong> file in the Project navigator and declare the <strong class="source-inline">DataManager</strong> protocol as follows:<p class="source-code">import Foundation</p><p class="source-code"><strong class="bold">protocol DataManager {</strong></p><p class="source-code"><strong class="bold">   func loadPlist(file name: String) -&gt; </strong></p><p class="source-code"><strong class="bold">   [[String: AnyObject]]</strong></p><p class="source-code"><strong class="bold">}</strong></p><p>This protocol requires any conforming object to have a method named <strong class="source-inline">loadPlist(file:)</strong> that takes a string as a parameter and returns an array of dictionaries. The string will hold the name of the <strong class="source-inline">.plist</strong> file to be loaded.</p></li>
				<li>Add an extension containing the implementation of the <strong class="source-inline">loadPlist(file:)</strong> method after the protocol declaration:<p class="source-code">import Foundation</p><p class="source-code">protocol DataManager {</p><p class="source-code">   func loadPlist(file name: String) -&gt; </p><p class="source-code">   [[String: AnyObject]]</p><p class="source-code">}</p><p class="source-code"><strong class="bold">extension DataManager {</strong></p><p class="source-code"><strong class="bold">   func loadPlist(file name: String) -&gt; </strong></p><p class="source-code"><strong class="bold">   [[String:AnyObject]] {</strong></p><p class="source-code"><strong class="bold">      guard let path = Bundle.main.path(forResource: </strong></p><p class="source-code"><strong class="bold">      name, ofType: "plist"), </strong></p><p class="source-code"><strong class="bold">      let itemsData = FileManager.default</strong></p><p class="source-code"><strong class="bold">      .contents(atPath: path),</strong></p><p class="source-code"><strong class="bold">      let items = try! PropertyListSerialization</strong></p><p class="source-code"><strong class="bold">      .propertyList(from: itemsData, format: nil)</strong></p><p class="source-code"><strong class="bold">      as? [[String: AnyObject]] else {</strong></p><p class="source-code"><strong class="bold">         return [[:]]</strong></p><p class="source-code"><strong class="bold">      }</strong></p><p class="source-code"><strong class="bold">      return items</strong></p><p class="source-code"><strong class="bold">   }</strong></p><p class="source-code"><strong class="bold">}</strong></p><p>Any class that <a id="_idIndexMarker783"/>adopts this protocol will get the <strong class="source-inline">loadPlist(file:)</strong> method. This method looks for a <strong class="source-inline">.plist</strong> file specified in the <strong class="source-inline">name</strong> parameter inside the application bundle. If the file is not found, an empty array of dictionaries is returned. Otherwise, the contents of the <strong class="source-inline">.plist</strong> file are loaded into an array of dictionaries of type <strong class="source-inline">[String: AnyObject]</strong> and returned. </p></li>
			</ol>
			<p>Now that you have this protocol, you will modify the <strong class="source-inline">MapDataManager</strong> and <strong class="source-inline">ExploreDataManager</strong> classes to adopt it. When you take existing code and modify it to accomplish the same thing more efficiently, this process is <a id="_idIndexMarker784"/>called <strong class="bold">refactoring</strong>.</p>
			<p>You will start with refactoring the <strong class="source-inline">MapDataManager</strong> class to conform to the <strong class="source-inline">DataManager</strong> protocol<a id="_idIndexMarker785"/> in the next section.</p>
			<h2 id="_idParaDest-224"><a id="_idTextAnchor229"/>Refactoring the MapDataManager class</h2>
			<p>The <strong class="source-inline">MapDataManager</strong> class <a id="_idIndexMarker786"/>already has a <strong class="source-inline">loadData()</strong> method, which is hardcoded to read <strong class="source-inline">Maplocations.plist</strong>. Now that you have created the <strong class="source-inline">DataManager</strong> protocol, you will modify the <strong class="source-inline">MapDataManager</strong> class to use it instead. Follow these steps:</p>
			<ol>
				<li value="1">With the <strong class="source-inline">MapDataManager</strong> file selected in the Project navigator, find and delete the <strong class="source-inline">loadData()</strong> method. You'll see an error because the <strong class="source-inline">fetch()</strong> method calls the <strong class="source-inline">loadData()</strong> method, which you just removed. You'll fix this shortly.</li>
				<li>Add the <strong class="source-inline">DataManager</strong> protocol to the class declaration as follows:<p class="source-code">class MapDataManager<strong class="bold">: DataManager</strong></p><p>This makes the <strong class="source-inline">loadPlist(file:)</strong> method available to the <strong class="source-inline">MapDataManager</strong> class.</p></li>
				<li>Modify the <strong class="source-inline">for data in loadData()</strong> line in the <strong class="source-inline">fetch()</strong> method as follows to fix the error:<p class="source-code">for data in <strong class="bold">loadPlist(file: "MapLocations")</strong></p><p>Your updated <strong class="source-inline">MapDataManager</strong> class should look like this:</p><p class="source-code">import Foundation</p><p class="source-code">class MapDataManager: DataManager {</p><p class="source-code">   private var items: [RestaurantItem] = []</p><p class="source-code">   var annotations: [RestaurantItem] {</p><p class="source-code">      items</p><p class="source-code">   }</p><p class="source-code">   func fetch(completion: (_ annotations: </p><p class="source-code">   [RestaurantItem]) -&gt; ()){</p><p class="source-code">      if !items.isEmpty { </p><p class="source-code">         items.removeAll() </p><p class="source-code">      }</p><p class="source-code">      for data in loadPlist(file: "MapLocations") {</p><p class="source-code">         items.append(RestaurantItem(dict: data))</p><p class="source-code">      }</p><p class="source-code">      completion(items)</p><p class="source-code">   }</p><p class="source-code">}</p></li>
			</ol>
			<p>The error should be gone. In the next section, you will refactor the <strong class="source-inline">ExploreDataManager</strong> class<a id="_idIndexMarker787"/> as well to make it conform to the <strong class="source-inline">DataManager</strong> protocol.</p>
			<h2 id="_idParaDest-225"><a id="_idTextAnchor230"/>Refactoring the ExploreDataManager class</h2>
			<p>Like<a id="_idIndexMarker788"/> the <strong class="source-inline">MapDataManager</strong> class, the <strong class="source-inline">ExploreDataManager</strong> class has a <strong class="source-inline">loadData()</strong> method, which is hardcoded to read <strong class="source-inline">ExploreData.plist</strong>.</p>
			<p class="callout-heading">Tip</p>
			<p class="callout">You may wish to re-read <a href="B17469_14_Final_VK_ePub.xhtml#_idTextAnchor201"><em class="italic">Chapter 14</em></a><em class="italic">, Getting Data into Collection Views</em>, to refresh your memory on the <strong class="source-inline">ExploreDataManager</strong> class.</p>
			<p>You need to make the same changes to the <strong class="source-inline">ExploreDataManager</strong> class that you made to the <strong class="source-inline">MapDataManager</strong> class. Follow these steps:</p>
			<ol>
				<li value="1">With the <strong class="source-inline">ExploreDataManager</strong> file selected in the Project navigator, find and delete the <strong class="source-inline">loadData()</strong> method. Ignore the error because it will be fixed shortly.</li>
				<li>Add the <strong class="source-inline">DataManager</strong> protocol to the class declaration as follows:<p class="source-code">class ExploreDataManager<strong class="bold">: DataManager</strong></p><p>This makes the <strong class="source-inline">loadPlist(file:)</strong> method available to the <strong class="source-inline">ExploreDataManager</strong> class.</p></li>
				<li>Modify<a id="_idIndexMarker789"/> the <strong class="source-inline">fetch()</strong> method as follows to fix the error:<p class="source-code">   func fetch() {</p><p class="source-code">      for data in <strong class="bold">loadPlist(file: "ExploreData")</strong> {</p><p class="source-code">         exploreItems.append(ExploreItem(dict: data</p><p class="source-code">         <strong class="bold">as! [String: String]</strong>))</p><p class="source-code">      }</p><p class="source-code">   }</p><p>Note that <strong class="source-inline">data</strong> is cast as <strong class="source-inline">[String: String]</strong> so that it can be used to initialize instances of the <strong class="source-inline">ExploreItem</strong> class.</p><p>You can now make any class that needs to load a <strong class="source-inline">.plist</strong> file containing an array of dictionaries adopt the <strong class="source-inline">DataManager</strong> protocol, as you did here with the <strong class="source-inline">MapDataManager</strong> and <strong class="source-inline">ExploreDataManager</strong> classes. It's not always clear when you should refactor, but the more experience you have, the easier it becomes. One indication that you need to refactor is when you are writing the same code in more than one class.</p></li>
			</ol>
			<p>You have completed the implementation of the <strong class="source-inline">MapDataManager</strong> class, created the <strong class="source-inline">DataManager</strong> protocol, and refactored both the <strong class="source-inline">MapDataManager</strong> and <strong class="source-inline">ExploreDataManager</strong> classes to conform to this protocol. With the <strong class="source-inline">MapDataManager</strong> class, you can load data from the <strong class="source-inline">MapLocations.plist</strong> file and return an array of <strong class="source-inline">RestaurantItem</strong> instances. Now, let's see how to use this array to add<a id="_idIndexMarker790"/> annotations to a map view, which will be displayed as pins in the <strong class="bold">Map</strong> screen.</p>
			<h1 id="_idParaDest-226"><a id="_idTextAnchor231"/>Adding annotations to a map view</h1>
			<p>In <a href="B17469_11_Final_VK_ePub.xhtml#_idTextAnchor171"><em class="italic">Chapter 11</em></a><em class="italic">, Finishing Up Your User Interface</em>, you <a id="_idIndexMarker791"/>added <a id="_idIndexMarker792"/>a map view to the <strong class="bold">Map</strong> screen. In previous sections, you added the <strong class="source-inline">MapLocations.plist</strong> file to your project and created the <strong class="source-inline">RestaurantItem</strong> and <strong class="source-inline">MapDataManager</strong> classes. Remember the MVC design pattern? At this point, you have created the views and models for the <strong class="bold">Map</strong> screen, so all you need now is the view controller.</p>
			<p>The view controller will be responsible for the following tasks:</p>
			<ul>
				<li>Adding <strong class="source-inline">RestaurantItem</strong> instances, which conform to the <strong class="source-inline">MKAnnotation</strong> protocol, to the map view.</li>
				<li>For <strong class="source-inline">RestaurantItem</strong> instances within the region displayed in the map view, provide <strong class="source-inline">MKAnnotationView</strong> instances requested by the map view.</li>
				<li>Provide custom <strong class="source-inline">MKAnnotationView</strong> instances that display a callout bubble containing a button when tapped, and present the <strong class="bold">Restaurant Detail</strong> screen when the button is tapped.</li>
			</ul>
			<p>You'll start by creating the <strong class="source-inline">MapViewController</strong> class as the view controller for the <strong class="bold">Map</strong> screen in the next section.</p>
			<h2 id="_idParaDest-227"><a id="_idTextAnchor232"/>Creating the MapViewController class</h2>
			<p>You've created the<a id="_idIndexMarker793"/> view and model objects for the <strong class="bold">Map</strong> screen, and all that remains is to create the view controller for it. You'll create a new class, <strong class="source-inline">MapViewController</strong>, to be the view controller for the<strong class="bold"> Map</strong> screen. Follow these steps:</p>
			<ol>
				<li value="1">Right-click the <strong class="source-inline">Map</strong> folder and select <strong class="bold">New File</strong>.</li>
				<li><strong class="bold">iOS</strong> should already be selected. Choose <strong class="bold">Cocoa Touch Class</strong> and then click <strong class="bold">Next</strong>.</li>
				<li>Configure the file as follows:<p><strong class="bold">Class</strong>: <strong class="source-inline">MapViewController</strong></p><p><strong class="bold">Subclass</strong>: <strong class="source-inline">UIViewController</strong></p><p><strong class="bold">Also create XIB</strong>: Unchecked</p><p><strong class="bold">Language</strong>: <strong class="source-inline">Swift</strong></p><p>Click <strong class="bold">Next</strong>.</p></li>
				<li>Click <strong class="bold">Create</strong>. The <strong class="source-inline">MapViewController</strong> file appears in the Project navigator.</li>
				<li>In the <strong class="source-inline">MapViewController</strong> file, add the following line after <strong class="source-inline">import UIKit</strong> to import the <strong class="source-inline">MapKit</strong> framework:<p class="source-code">import MapKit</p></li>
				<li>Modify the class declaration as follows to make the <strong class="source-inline">MapViewController</strong> class adopt the <strong class="source-inline">MKMapViewDelegate</strong> protocol:<p class="source-code">class MapViewController: UIViewController<strong class="bold">, </strong></p><p class="source-code"><strong class="bold">MKMapViewDelegate </strong>{</p></li>
			</ol>
			<p>You have<a id="_idIndexMarker794"/> declared the <strong class="source-inline">MapViewController</strong> class. In the next section, you'll assign this class as the view controller for the <strong class="bold">Map</strong> screen, and create an outlet for the map view.</p>
			<h2 id="_idParaDest-228"><a id="_idTextAnchor233"/>Connecting the outlets for the map view</h2>
			<p>The view controller <a id="_idIndexMarker795"/>scene for the <strong class="bold">Map</strong> screen displays a map, but there is currently no way to set the map region to be displayed and no way to display annotations. Let's assign the <strong class="source-inline">MapViewController</strong> class to be the view controller for the <strong class="bold">Map</strong> screen and add an outlet for the map view to it. Follow these steps:</p>
			<ol>
				<li value="1">Click the <strong class="source-inline">Main</strong> storyboard file. Click the <strong class="bold">View Controller</strong> icon in the <strong class="bold">View Controller Scene</strong> for the <strong class="bold">Map</strong> screen. In the Identity inspector, under <strong class="bold">Custom Class</strong>, set <strong class="bold">Class</strong> to <strong class="source-inline">MapViewController</strong>:<div id="_idContainer369" class="IMG---Figure"><img src="image/Figure_16.03_B17469.jpg" alt="Figure 16.3: Identity inspector showing Class setting for MapViewController&#13;&#10;"/></div><p class="figure-caption">Figure 16.3: Identity inspector showing Class setting for MapViewController</p></li>
				<li>Select the <strong class="bold">Map View</strong> in<a id="_idIndexMarker796"/> the document outline:<div id="_idContainer370" class="IMG---Figure"><img src="image/Figure_16.04_B17469.jpg" alt="Figure 16.4: Document outline with Map View selected&#13;&#10;"/></div><p class="figure-caption">Figure 16.4: Document outline with Map View selected</p></li>
				<li>Click the Adjust Editor Options button.</li>
				<li>Choose Assistant in the pop-up menu.</li>
				<li>The assistant editor appears, showing the contents of the <strong class="source-inline">MapViewController</strong> file. <em class="italic">Ctrl + Drag</em> from the map view to the space just under the class declaration:<div id="_idContainer371" class="IMG---Figure"><img src="image/Figure_16.05_B17469.jpg" alt="Figure 16.5: Editor area showing MapViewController file contents&#13;&#10;"/></div><p class="figure-caption">Figure 16.5: Editor area showing MapViewController file contents</p></li>
				<li>Type <strong class="source-inline">mapView</strong> in <a id="_idIndexMarker797"/>the <strong class="bold">Name</strong> field and click <strong class="bold">Connect</strong>:<div id="_idContainer372" class="IMG---Figure"><img src="image/Figure_16.06_B17469.jpg" alt="Figure 16.6: Pop-up dialog box for mapView outlet creation&#13;&#10;"/></div><p class="figure-caption">Figure 16.6: Pop-up dialog box for mapView outlet creation</p></li>
				<li>The map view has been connected to the <strong class="source-inline">mapView</strong> outlet in the <strong class="source-inline">MapViewController</strong> class. Click the <strong class="bold">x</strong> button to close the assistant editor:</li>
			</ol>
			<div>
				<div id="_idContainer373" class="IMG---Figure">
					<img src="image/Figure_16.07_B17469.jpg" alt="Figure 16.7: Assistant editor close button &#13;&#10;"/>
				</div>
			</div>
			<p class="figure-caption">Figure 16.7: Assistant editor close button </p>
			<p>The <strong class="source-inline">MapViewController</strong> class now has an outlet, <strong class="source-inline">mapView</strong>, that is linked to the map view in the <strong class="bold">Map</strong> screen. In the next section, you'll modify the <strong class="source-inline">MapDataManager</strong> class by adding a method to generate a new region based on the restaurant's location, so it can<a id="_idIndexMarker798"/> provide a map region for the map view to display.</p>
			<h2 id="_idParaDest-229"><a id="_idTextAnchor234"/>Setting the map view region to be displayed</h2>
			<p>In a map view, the <a id="_idIndexMarker799"/>portion of the map that is visible on screen is called a region. To specify a region, you need the coordinates for the region's center point and the horizontal and vertical span representing the dimensions of the map to be displayed.</p>
			<p>The <strong class="source-inline">fetch(completion:)</strong> method in the <strong class="source-inline">MapDataManager</strong> class returns an array of <strong class="source-inline">RestaurantItem</strong> instances. You will implement a method, <strong class="source-inline">initialRegion(latDelta:longDelta:)</strong>, to get the first <strong class="source-inline">RestaurantItem</strong> instance from this array, get the restaurant's coordinates, and use them to create a region. Follow these steps:</p>
			<ol>
				<li value="1">Click the <strong class="source-inline">MapDataManager</strong> file in the Project navigator. After the <strong class="source-inline">import Foundation</strong> statement, add <strong class="source-inline">import MapKit</strong>.</li>
				<li>Just before the closing curly brace, implement the  <strong class="source-inline">initialRegion(latDelta:longDelta:)</strong> method as follows:<p class="source-code">func initialRegion(latDelta: CLLocationDegrees, </p><p class="source-code">longDelta: CLLocationDegrees) -&gt; MKCoordinateRegion {</p><p class="source-code">   guard let item = items.first else {</p><p class="source-code">      return MKCoordinateRegion()</p><p class="source-code">   }</p><p class="source-code">   let span = MKCoordinateSpan(latitudeDelta: </p><p class="source-code">   latDelta, longitudeDelta: longDelta)</p><p class="source-code">   return MKCoordinateRegion(center: item.coordinate,</p><p class="source-code">   span: span)</p><p class="source-code">}</p><p>Let's break this down:</p><p class="source-code">func initialRegion(latDelta: CLLocationDegrees, longDelta: CLLocationDegrees) -&gt; MKCoordinateRegion</p><p>This method <a id="_idIndexMarker800"/>takes two parameters and returns an <strong class="source-inline">MKCoordinateRegion</strong> instance. <strong class="source-inline">latDelta</strong> specifies the north-to-south distance (measured in degrees) to display for the map region. One degree is approximately 69 miles. <strong class="source-inline">longDelta</strong> specifies the amount of east-to-west distance (measured in degrees) to display for the map region. The <strong class="source-inline">MKCoordinateRegion</strong> instance that is returned determines the region that will appear onscreen.</p><p class="source-code">guard let item = items.first else { return MKCoordinateRegion() }</p><p>The <strong class="source-inline">guard</strong> statement gets the first item in the array of <strong class="source-inline">RestaurantItem</strong> instances and assigns it to <strong class="source-inline">item</strong>. If the array is empty, an empty <strong class="source-inline">MKCoordinateRegion</strong> instance is returned.</p><p class="source-code">let span = MKCoordinateSpan(latitudeDelta: latDelta, longitudeDelta: longDelta)</p><p><strong class="source-inline">latDelta</strong> and <strong class="source-inline">longDelta</strong> are used to make an <strong class="source-inline">MKCoordinateSpan</strong> instance, which is the horizontal and vertical span of the region to be created.</p><p class="source-code">return MKCoordinateRegion(center: item.coordinate, span: span)</p><p>An <strong class="source-inline">MKCoordinateRegion</strong> instance is created and returned using the coordinate property of <strong class="source-inline">item</strong> and the <strong class="source-inline">MKCoordinateSpan</strong> instance.</p></li>
			</ol>
			<p>Now that the map region has been determined, you can determine which <strong class="source-inline">RestaurantItem</strong> instances are in this region based on their <strong class="source-inline">coordinate</strong> property. Remember that the <strong class="source-inline">RestaurantItem</strong> class conforms to <strong class="source-inline">MKAnnotation</strong>. As the view controller for the map view, the <strong class="source-inline">MapViewController</strong> class is responsible for providing <strong class="source-inline">MKAnnotationView</strong> instances for any <strong class="source-inline">RestaurantItem</strong> instances in this region. </p>
			<p>In the next<a id="_idIndexMarker801"/> section, you'll modify the <strong class="source-inline">MapViewController</strong> class to provide <strong class="source-inline">MKAnnotationViews</strong> for the <strong class="source-inline">RestaurantItem</strong> instances in the region displayed by the map view.</p>
			<h2 id="_idParaDest-230"><a id="_idTextAnchor235"/>Displaying MKAnnotationView instances on the map view</h2>
			<p>At this <a id="_idIndexMarker802"/>point, you have the <strong class="source-inline">MapViewController</strong> class<a id="_idIndexMarker803"/> to manage the map view on the <strong class="bold">Map</strong> screen, and you can call the <strong class="source-inline">initialRegion(latDelta:longDelta:)</strong> method in the <strong class="source-inline">MapDataManager</strong> class to set the map region. You will now modify the <strong class="source-inline">MapViewController</strong> class to get an array of <strong class="source-inline">RestaurantItem</strong> instances from the <strong class="source-inline">MapDataManager</strong> class and add it to the map view. Follow these steps:</p>
			<ol>
				<li value="1">Click the <strong class="source-inline">MapViewController</strong> file in the Project navigator and remove the commented code.</li>
				<li>Just after the <strong class="source-inline">mapView</strong> property declaration, add the following to create an instance of the <strong class="source-inline">MapDataManager</strong> class and assign it to <strong class="source-inline">manager</strong>:<p class="source-code">private let manager = MapDataManager() </p></li>
				<li>Add the following method after <strong class="source-inline">viewDidLoad()</strong>. This method will add <strong class="source-inline">RestaurantItem</strong> instances (which conform to the <strong class="source-inline">MKAnnotation</strong> protocol) to the map view:<p class="source-code">func setupMap(_ annotations: [RestaurantItem]) {</p><p class="source-code">   mapView.setRegion(manager.initialRegion(</p><p class="source-code">   latDelta: 0.5, longDelta: 0.5), animated: true)</p><p class="source-code">   mapView.addAnnotations(manager.annotations)</p><p class="source-code">}</p><p>The <strong class="source-inline">setupMap(_:)</strong> method takes a parameter, <strong class="source-inline">annotations</strong>, which is an array of <strong class="source-inline">RestaurantItem</strong> instances. It sets the region of the map to be displayed in the map view using the <strong class="source-inline">initialRegion(latDelta:longDelta:)</strong> method of the <strong class="source-inline">MapDataManager</strong> class, then adds each <strong class="source-inline">RestaurantItem</strong> instance in the <strong class="source-inline">annotations</strong> array to the map view. The map view's delegate (the <strong class="source-inline">MapViewController</strong> class in this case) then automatically provides an <strong class="source-inline">MKAnnotationView</strong> instance for every <strong class="source-inline">RestaurantItem</strong> instance within the region.</p></li>
				<li>Add <a id="_idIndexMarker804"/>the <a id="_idIndexMarker805"/>following method before the <strong class="source-inline">setupMap(_:)</strong> method. This calls the <strong class="source-inline">fetch(completion:)</strong> method of the <strong class="source-inline">MapDataManager</strong> instance and passes in the <strong class="source-inline">setupMap(_:)</strong> method as a completion closure:<p class="source-code">func initialize() {</p><p class="source-code">   manager.fetch {(annotations) in</p><p class="source-code">   setupMap(annotations)}</p><p class="source-code">}</p><p>The <strong class="source-inline">fetch(completion:)</strong> method loads the <strong class="source-inline">MapLocations.plist</strong> file and creates and assigns the array of <strong class="source-inline">RestaurantItem</strong> instances to the <strong class="source-inline">items</strong> array. The <strong class="source-inline">annotations</strong> property returns a copy of the <strong class="source-inline">items</strong> array. This array is then processed by the <strong class="source-inline">setupMap(_:)</strong> method that was passed in as the completion closure.</p></li>
				<li>Call the <strong class="source-inline">initialize()</strong> method inside <strong class="source-inline">viewDidLoad()</strong> so it will be called when the map view is loaded:<p class="source-code">override func viewDidLoad() { </p><p class="source-code">   super.viewDidLoad() </p><p class="source-code">   <strong class="bold">initialize()</strong></p><p class="source-code">}</p></li>
			</ol>
			<p>Build and run the application. You should see pins (<strong class="source-inline">MKAnnotationView</strong> instances) on the <strong class="bold">Map</strong> screen:</p>
			<div>
				<div id="_idContainer374" class="IMG---Figure">
					<img src="image/Figure_16.08_B17469.jpg" alt="Figure 16.8: iOS Simulator showing standard MKAnnotationView instances&#13;&#10;"/>
				</div>
			</div>
			<p class="figure-caption">Figure 16.8: iOS Simulator showing standard MKAnnotationView instances</p>
			<p>An <strong class="source-inline">MKAnnotationView</strong> instance has been added for each <strong class="source-inline">RestaurantItem</strong> instance in the map region. Each <strong class="source-inline">MKAnnotationView</strong> instance is represented by a pin. You now<a id="_idIndexMarker806"/> have <a id="_idIndexMarker807"/>pins showing restaurant locations on your map, but you need to add code to display custom pins as shown in the app tour. You will do that in the next section.</p>
			<h2 id="_idParaDest-231"><a id="_idTextAnchor236"/>Creating custom MKAnnotationView instances</h2>
			<p>Currently, the <strong class="bold">Map</strong> screen<a id="_idIndexMarker808"/> displays standard <strong class="source-inline">MKAnnotationView</strong> instances, which look like pins. You can replace the standard pin image with a custom image. There is a custom image in the <strong class="source-inline">Assets.xcassets</strong> file, and you'll configure the <strong class="source-inline">MapViewController</strong> class to use it. This will make the pins onscreen match the ones in the app tour. You'll also configure each pin to display a callout bubble when tapped. Follow these steps:</p>
			<ol>
				<li value="1">Click the <strong class="source-inline">MapViewController</strong> file in the Project navigator.</li>
				<li>Add the following code inside the <strong class="source-inline">initialize()</strong> method after the opening curly brace. This makes the <strong class="source-inline">MapViewController</strong> class the delegate for the map view:<p class="source-code">func initialize() {</p><p class="source-code">   <strong class="bold">mapView.delegate = self</strong></p></li>
				<li>Add the following method after the <strong class="source-inline">setupMap(_:)</strong> method. This method returns a custom <strong class="source-inline">MKAnnotationView</strong> instance for every <strong class="source-inline">MKAnnotation</strong> instance in the region displayed by the map view:<p class="source-code">func mapView(_ mapView: MKMapView, viewFor annotation:</p><p class="source-code">MKAnnotation) -&gt; MKAnnotationView? {</p><p class="source-code">   let identifier = "custompin"</p><p class="source-code">   guard !annotation.isKind(of: MKUserLocation.self)</p><p class="source-code">   else { </p><p class="source-code">      return nil </p><p class="source-code">   }</p><p class="source-code">   let annotationView: MKAnnotationView</p><p class="source-code">   if let customAnnotationView = </p><p class="source-code">   mapView.dequeueReusableAnnotationView(</p><p class="source-code">   withIdentifier: identifier) {</p><p class="source-code">      annotationView = customAnnotationView </p><p class="source-code">      annotationView.annotation = annotation</p><p class="source-code">   } else {</p><p class="source-code">      let av = MKAnnotationView(annotation: </p><p class="source-code">      annotation, reuseIdentifier: identifier)</p><p class="source-code">      av.rightCalloutAccessoryView = </p><p class="source-code">      UIButton(type: .detailDisclosure)</p><p class="source-code">      annotationView = av</p><p class="source-code">   }</p><p class="source-code">   annotationView.canShowCallout = true </p><p class="source-code">   if let image = UIImage(named: </p><p class="source-code">        "custom-annotation") {</p><p class="source-code">            annotationView.image = image </p><p class="source-code">            annotationView.centerOffset = CGPoint(</p><p class="source-code">            x: -image.size.width / 2, </p><p class="source-code">            y: -image.size.height / 2)</p><p class="source-code">   }</p><p class="source-code">   return annotationView</p><p class="source-code">}</p><p>Let's break <a id="_idIndexMarker809"/>this down:</p><p class="source-code">func mapView(_ mapView: MKMapView, viewFor </p><p class="source-code">annotation: MKAnnotation) -&gt; MKAnnotationView?</p><p>This is one of the delegate methods specified in the <strong class="source-inline">MKMapViewDelegate</strong> protocol. It's triggered when an <strong class="source-inline">MKAnnotation</strong> instance is within the map region, and it returns an <strong class="source-inline">MKAnnotationView</strong> instance, which the user will see on the screen. You'll use this method to replace the default pins with custom pins.</p><p class="source-code">let identifier = "custompin"</p><p>A constant, <strong class="source-inline">identifier</strong>, is assigned the <strong class="source-inline">"custompin"</strong> string. This will be the reuse identifier.</p><p class="source-code">guard !annotation.isKind(of: MKUserLocation.self) </p><p class="source-code">else { </p><p class="source-code">   return nil </p><p class="source-code">}</p><p>In addition to the annotations that you specify, an <strong class="source-inline">MKMapView</strong> instance will also add an annotation for the user location. This <strong class="source-inline">guard</strong> statement checks to see whether<a id="_idIndexMarker810"/> the annotation is the user location. If it is, <strong class="source-inline">nil</strong> is returned, as the user location is not a restaurant location.</p><p class="source-code">let annotationView: MKAnnotationView</p><p><strong class="source-inline">annotationView</strong> is a constant of the <strong class="source-inline">MKAnnotationView</strong> type. You create this so that you can configure and return it later.</p><p class="source-code">if let customAnnotationView = </p><p class="source-code">mapView.dequeueReusableAnnotationView (withIdentifier:</p><p class="source-code">identifier) { </p><p class="source-code">   annotationView = customAnnotationView </p><p class="source-code">   annotationView.annotation = annotation</p><p class="source-code">}</p><p>The <strong class="source-inline">if</strong> statement checks to see whether there are any existing annotations that were initially visible but are no longer on the screen. If there are, the <strong class="source-inline">MKAnnotationView</strong> instance for that annotation can be reused and is assigned to the <strong class="source-inline">annotationView</strong> variable. The <strong class="source-inline">annotation</strong> parameter is assigned to the <strong class="source-inline">annotation</strong> property of <strong class="source-inline">annotationView</strong>.</p><p class="source-code">else {</p><p class="source-code">   let av = MKAnnotationView(annotation: annotation, </p><p class="source-code">   reuseIdentifier: identifier) </p><p class="source-code">   av.rightCalloutAccessoryView = </p><p class="source-code">   UIButton(type: .detailDisclosure)</p><p class="source-code">   annotationView = av</p><p class="source-code">}</p><p>The <strong class="source-inline">else</strong> clause is executed if there are no existing <strong class="source-inline">MKAnnotationView</strong> instances that can be reused. A new <strong class="source-inline">MKAnnotationView</strong> instance is created with the reuse identifier specified earlier (<strong class="source-inline">custompin</strong>). The <strong class="source-inline">MKAnnotationView</strong> instance is configured with a callout. When you tap a pin on the map, a <a id="_idIndexMarker811"/>callout bubble will appear showing the title (restaurant name), subtitle (cuisines), and a button. You'll program the button later to present the <strong class="bold">Restaurant Detail</strong> screen.</p><p class="source-code">annotationView.canShowCallout = true</p><p class="source-code">if let image = UIImage(named: "custom-annotation") {</p><p class="source-code">   annotationView.image = image </p><p class="source-code">   annotationView.centerOffset = CGPoint(</p><p class="source-code">   x: -image.size.width / 2, </p><p class="source-code">   y: -image.size.height / 2)</p><p class="source-code">}</p><p>This configures the <strong class="source-inline">MKAnnotationView</strong> instance that you just created to display extra information in a callout bubble and sets the custom image to the <strong class="source-inline">custom-annotation</strong> image stored in <strong class="source-inline">Assets.xcassets</strong>. When adding a custom image, the annotation uses the center of the image as the pin point, so the <strong class="source-inline">centerOffset</strong> property is used to set the correct location of the pin point, at the tip of the pin.</p><p class="source-code">return annotationView</p><p>The custom <strong class="source-inline">MKAnnotationView</strong> instance is returned.</p></li>
			</ol>
			<p>Build and run your app. You can see the custom pins on your map:</p>
			<div>
				<div id="_idContainer375" class="IMG---Figure">
					<img src="image/Figure_16.09_B17469.jpg" alt="Figure 16.9: iOS Simulator showing custom MKAnnotationView instances&#13;&#10;"/>
				</div>
			</div>
			<p class="figure-caption">Figure 16.9: iOS Simulator showing custom MKAnnotationView instances</p>
			<p>You have configured<a id="_idIndexMarker812"/> the <strong class="bold">Map</strong> screen to display a region containing custom <strong class="source-inline">MKAnnotationView</strong> instances using the data obtained from the <strong class="source-inline">MapDataManager</strong> class. Tapping a pin displays a callout bubble showing the restaurant name and the cuisines it offers. Tapping the button in the callout bubble doesn't do anything yet. You'll configure the button to present the <strong class="bold">Restaurant Detail</strong> screen in the next section.</p>
			<h1 id="_idParaDest-232"><a id="_idTextAnchor237"/>Going from the Map screen to the Restaurant Detail screen</h1>
			<p>The <strong class="bold">Map</strong> screen <a id="_idIndexMarker813"/>now <a id="_idIndexMarker814"/>displays your custom <strong class="source-inline">MKAnnotationView</strong> instances, and tapping one displays a callout bubble showing restaurant details. The button in the callout bubble doesn't work, though. </p>
			<p>Inside the <strong class="source-inline">resources</strong> folder that you downloaded earlier, you'll find completed storyboards named <strong class="source-inline">RestaurantDetail.Storyboard</strong>, <strong class="source-inline">PhotoFilter.Storyboard</strong>, and <strong class="source-inline">ReviewForm.Storyboard</strong>, which you'll add to your project. These storyboards contain the scenes for the <strong class="bold">Restaurant Detail</strong> screen, the <strong class="bold">Photo Filter</strong> screen and the <strong class="bold">Review Form</strong> screen.</p>
			<p>To present the <strong class="bold">Restaurant Detail</strong> screen from the callout button, you'll add a <strong class="bold">storyboard reference</strong> to your project, and link the <strong class="source-inline">RestaurantDetail</strong> storyboard <a id="_idIndexMarker815"/>file<a id="_idIndexMarker816"/> to it. You'll do this in the next section.</p>
			<h2 id="_idParaDest-233"><a id="_idTextAnchor238"/>Creating and configuring a storyboard reference</h2>
			<p>There are a<a id="_idIndexMarker817"/> lot of<a id="_idIndexMarker818"/> scenes in the <strong class="source-inline">Main</strong> storyboard file. As your project grows, you'll find it more challenging to keep track of all the scenes in your app. One way to manage this is to create additional storyboard files, and use storyboard references to link them. You will add <strong class="source-inline">RestaurantDetail</strong>, <strong class="source-inline">PhotoFilter</strong> and <strong class="source-inline">ReviewForm</strong> storyboard files to your project, and you will link the <strong class="source-inline">Main</strong> storyboard file to the <strong class="source-inline">RestaurantDetail</strong> storyboard file using a storyboard reference. Follow these steps to add a storyboard reference to your project:</p>
			<ol>
				<li value="1">Open the <strong class="source-inline">Main</strong> storyboard file, and click the Library button.</li>
				<li>Type <strong class="source-inline">story</strong> in the filter field. A <strong class="bold">Storyboard Reference</strong> object will appear in the results.</li>
				<li>Drag the <strong class="bold">Storyboard Reference</strong> object into the <strong class="source-inline">Main</strong> storyboard file next to the <strong class="bold">Map View Controller Scene</strong>:<div id="_idContainer376" class="IMG---Figure"><img src="image/Figure_16.10_B17469.jpg" alt="Figure 16.10: Library with Storyboard Reference object selected&#13;&#10;"/></div><p class="figure-caption">Figure 16.10: Library with Storyboard Reference object selected</p></li>
				<li>Open<a id="_idIndexMarker819"/> the <strong class="source-inline">resources</strong> folder that you downloaded<a id="_idIndexMarker820"/> earlier, and locate the three storyboard files that you will add to your project in it (<strong class="source-inline">RestaurantDetail.storyboard</strong>, <strong class="source-inline">PhotoFilter.storyboard</strong>, and <strong class="source-inline">ReviewForm.storyboard</strong>):<div id="_idContainer377" class="IMG---Figure"><img src="image/Figure_16.11_B17469.jpg" alt="Figure 16.11: Contents of resources folder&#13;&#10;"/></div><p class="figure-caption">Figure 16.11: Contents of resources folder</p></li>
				<li>In the Project navigator, create a new folder inside your <strong class="source-inline">LetsEat</strong> folder named <strong class="source-inline">RestaurantDetail</strong> and copy the <strong class="source-inline">RestaurantDetail</strong> storyboard file into it:<div id="_idContainer378" class="IMG---Figure"><img src="image/Figure_16.12_B17469.jpg" alt="Figure 16.12: Project navigator showing RestaurantDetail folder and contents&#13;&#10;"/></div><p class="figure-caption">Figure 16.12: Project navigator showing RestaurantDetail folder and contents</p></li>
				<li>Create a <a id="_idIndexMarker821"/>new <a id="_idIndexMarker822"/>folder inside your <strong class="source-inline">LetsEat</strong> folder named <strong class="source-inline">ReviewForm</strong> and copy the <strong class="source-inline">ReviewForm</strong> storyboard file into it, and create a new folder inside your <strong class="source-inline">LetsEat</strong> folder named <strong class="source-inline">PhotoFilter</strong> and copy the <strong class="source-inline">PhotoFilter</strong> storyboard file into it:<div id="_idContainer379" class="IMG---Figure"><img src="image/Figure_16.13_B17469.jpg" alt="Figure 16.13: Project navigator showing PhotoFilter and ReviewForm folders and contents&#13;&#10;"/></div><p class="figure-caption">Figure 16.13: Project navigator showing PhotoFilter and ReviewForm folders and contents</p></li>
				<li>Now you'll <a id="_idIndexMarker823"/>assign the <strong class="source-inline">RestaurantDetail</strong> storyboard <a id="_idIndexMarker824"/>file to the storyboard reference you added earlier to your project. Click the <strong class="source-inline">Main</strong> storyboard file, select the storyboard reference you added earlier, and click the Attributes inspector button. Under <strong class="bold">Storyboard Reference</strong>, set <strong class="bold">Storyboard</strong> to <strong class="source-inline">RestaurantDetail</strong>:<div id="_idContainer380" class="IMG---Figure"><img src="image/Figure_16.14_B17469.jpg" alt="Figure 16.14: Attributes inspector settings for RestaurantDetail storyboard reference&#13;&#10;"/></div><p class="figure-caption">Figure 16.14: Attributes inspector settings for RestaurantDetail storyboard reference</p></li>
				<li><em class="italic">Ctrl + Drag</em> from <a id="_idIndexMarker825"/>the <strong class="bold">Map View Controller</strong> icon<a id="_idIndexMarker826"/> to the storyboard reference and choose <strong class="bold">Show</strong> from the pop-up menu to add a segue between the <strong class="bold">Map View Controller Scene</strong> and the storyboard reference:<div id="_idContainer381" class="IMG---Figure"><img src="image/Figure_16.15_B17469.jpg" alt="Figure 16.15: Segue pop-up menu&#13;&#10;"/></div><p class="figure-caption">Figure 16.15: Segue pop-up menu</p><p>This is required <a id="_idIndexMarker827"/>to <a id="_idIndexMarker828"/>display the <strong class="bold">Restaurant Detail</strong> screen when you tap an <strong class="source-inline">MKAnnotationView</strong> instance's callout bubble button in the <strong class="bold">Map</strong> screen.</p></li>
				<li>You will set an identifier for this segue. Later you'll add a method that performs the segue with this identifier when the callout bubble button is tapped. Select the segue connecting the <strong class="bold">Map View Controller Scene</strong> to the storyboard reference:<div id="_idContainer382" class="IMG---Figure"><img src="image/Figure_16.16_B17469.jpg" alt="Figure 16.16: Segue between Map View Controller Scene and RestaurantDetail storyboard reference&#13;&#10;"/></div><p class="figure-caption">Figure 16.16: Segue between Map View Controller Scene and RestaurantDetail storyboard reference</p></li>
				<li>In the Attributes inspector, under <strong class="bold">Storyboard Segue</strong>, set <strong class="bold">Identifier</strong> to <strong class="source-inline">showDetail</strong>:</li>
			</ol>
			<div>
				<div id="_idContainer383" class="IMG---Figure">
					<img src="image/Figure_16.17_B17469.jpg" alt="Figure 16.17: Attributes inspector settings for showDetail segue&#13;&#10;"/>
				</div>
			</div>
			<p class="figure-caption">Figure 16.17: Attributes inspector settings for showDetail segue</p>
			<p>You have now linked the view controller scene for the <strong class="bold">Map</strong> screen with the view controller<a id="_idIndexMarker829"/> scene<a id="_idIndexMarker830"/> for the <strong class="bold">Restaurant Detail</strong> screen using a segue. In the next section, you'll implement a method to present the <strong class="bold">Restaurant Detail</strong> screen when the callout bubble button is tapped.</p>
			<h2 id="_idParaDest-234"><a id="_idTextAnchor239"/>Performing the showDetail segue</h2>
			<p>You've linked the <a id="_idIndexMarker831"/>view controller scene for the <strong class="bold">Map</strong> screen to the view controller scene for the <strong class="bold">Restaurant Detail</strong> screen using a segue. You've also set the segue identifier to <strong class="source-inline">showDetail</strong>. Now you need a method to perform that segue, but before you implement it, you'll create an enumeration that contains all the segue identifiers for this project. This reduces potential errors by enabling autocompletion when you type the segue identifiers later in your code. Follow these steps:</p>
			<ol>
				<li value="1">Right-click on the <strong class="source-inline">Misc</strong> folder inside the <strong class="source-inline">LetsEat</strong> folder and choose <strong class="bold">New File</strong>.</li>
				<li><strong class="bold">iOS</strong> should already be selected. Choose <strong class="bold">Swift File</strong> and then click <strong class="bold">Next</strong>.</li>
				<li>Name this file <strong class="source-inline">Segue</strong>. Click <strong class="bold">Create</strong>. The <strong class="source-inline">Segue</strong> file appears in the Project navigator.</li>
				<li>Add the<a id="_idIndexMarker832"/> following after the <strong class="source-inline">import</strong> statement to declare and define the <strong class="source-inline">Segue</strong> enumeration:<p class="source-code">enum Segue: String { </p><p class="source-code">   case showDetail </p><p class="source-code">   case showRating </p><p class="source-code">   case showReview</p><p class="source-code">   case showAllReviews </p><p class="source-code">   case restaurantList </p><p class="source-code">   case locationList </p><p class="source-code">   case showPhotoReview </p><p class="source-code">   case showPhotoFilter</p><p class="source-code">}</p><p>Note that the <strong class="source-inline">Segue</strong> enum's type is <strong class="source-inline">String</strong>, so the raw values for each case are strings. For example, the raw value for case <strong class="source-inline">showDetail</strong> is <strong class="source-inline">"showDetail"</strong>.</p></li>
			</ol>
			<p>Now you can add the method to perform the <strong class="source-inline">showDetail</strong> segue when the callout button is tapped. Click the <strong class="source-inline">MapViewController</strong> file in the Project navigator and add the following method after the <strong class="source-inline">setupMap(_:)</strong> method:</p>
			<p class="source-code">func mapView(_ mapView: MKMapView, annotationView view: </p>
			<p class="source-code">MKAnnotationView, calloutAccessoryControlTapped control: </p>
			<p class="source-code">UIControl) {</p>
			<p class="source-code">   self.performSegue(withIdentifier: </p>
			<p class="source-code">   Segue.showDetail.rawValue, sender: self)</p>
			<p class="source-code">}</p>
			<p><strong class="source-inline">mapView(_:annotationView:calloutAccessoryControlTapped:)</strong> is another method specified in the <strong class="source-inline">MKMapViewDelegate</strong> protocol. It is triggered when the user taps the callout bubble button.  </p>
			<p><strong class="source-inline">self.performSegue(withIdentifier: Segue.showDetail.rawValue, sender: self)</strong> performs the segue with the <strong class="source-inline">"showDetail"</strong> identifier, which presents the <strong class="bold">Restaurant Detail</strong> screen.</p>
			<p>Build and run your <a id="_idIndexMarker833"/>project. On the <strong class="bold">Map</strong> screen, tap a pin and tap the button inside the callout bubble:</p>
			<div>
				<div id="_idContainer384" class="IMG---Figure">
					<img src="image/Figure_16.18_B17469.jpg" alt="Figure 16.18: iOS Simulator showing callout bubble button&#13;&#10;"/>
				</div>
			</div>
			<p class="figure-caption">Figure 16.18: iOS Simulator showing callout bubble button</p>
			<p>The new <strong class="bold">Restaurant Detail</strong> screen appears, but it does not contain any details about the restaurant:</p>
			<div>
				<div id="_idContainer385" class="IMG---Figure">
					<img src="image/Figure_16.19_B17469.jpg" alt="Figure 16.19: iOS Simulator showing Restaurant Detail screen&#13;&#10;"/>
				</div>
			</div>
			<p class="figure-caption">Figure 16.19: iOS Simulator showing Restaurant Detail screen</p>
			<p>You will make the <strong class="bold">Restaurant Detail</strong> screen display the details of a restaurant in <a href="B17469_18_Final_VK_ePub.xhtml#_idTextAnchor299"><em class="italic">Chapter 18</em></a><em class="italic">, Displaying Data in a Static Table View</em>, but<a id="_idIndexMarker834"/> for now, let's just pass the data about the selected restaurant to the <strong class="bold">Restaurant Detail</strong> screen's view controller and print it to the Debug area. You will do this in the next section.</p>
			<h2 id="_idParaDest-235"><a id="_idTextAnchor240"/>Passing data to the Restaurant Detail screen</h2>
			<p>The <strong class="bold">Map</strong> screen<a id="_idIndexMarker835"/> now <a id="_idIndexMarker836"/>displays custom <strong class="source-inline">MKAnnotationView</strong> instances that display callout bubbles when tapped. When the button in the callout bubble is tapped, the <strong class="bold">Restaurant Detail</strong> screen appears, but it does not contain any data about the restaurant. You'll need to pass restaurant data from the associated <strong class="source-inline">RestaurantItem</strong> instance to the view controller for the <strong class="bold">Restaurant Detail</strong> screen, which has not been created yet. Follow these steps to create it now:</p>
			<ol>
				<li value="1">Right-click the <strong class="source-inline">RestaurantDetail</strong> folder and select <strong class="bold">New File</strong>.</li>
				<li><strong class="bold">iOS</strong> should<a id="_idIndexMarker837"/> already be selected. Choose <strong class="bold">Cocoa Touch Class</strong> and <a id="_idIndexMarker838"/>then click <strong class="bold">Next</strong>.</li>
				<li>Configure the file as follows:<p><strong class="bold">Class</strong>: <strong class="source-inline">RestaurantDetailViewController</strong></p><p><strong class="bold">Subclass</strong>: <strong class="source-inline">UITableViewController</strong> </p><p><strong class="bold">Also create XIB</strong>: Unchecked </p><p><strong class="bold">Language</strong>: <strong class="source-inline">Swift</strong></p><p>Click <strong class="bold">Next</strong>.</p></li>
				<li>Click <strong class="bold">Create</strong>. The <strong class="source-inline">RestaurantDetailViewController</strong> file appears in the Project navigator.</li>
				<li>Remove all the commented code. Your file should look like this:<p class="source-code">import UIKit</p><p class="source-code">class RestaurantDetailViewController: </p><p class="source-code">UITableViewController {</p><p class="source-code">   override func viewDidLoad() {</p><p class="source-code">      super.viewDidLoad()</p><p class="source-code">   }</p><p class="source-code">}</p></li>
				<li>Declare a property named <strong class="source-inline">selectedRestaurant</strong> before the <strong class="source-inline">viewDidLoad()</strong> method:<p class="source-code">var selectedRestaurant: RestaurantItem?</p><p>This property holds the <strong class="source-inline">RestaurantItem</strong> instance that will be passed to the <strong class="source-inline">RestaurantDetailViewController</strong> instance from the <strong class="source-inline">MapViewController</strong> instance:</p></li>
				<li>Add the following code inside the <strong class="source-inline">viewDidLoad()</strong> method before the closing curly brace to print the <strong class="source-inline">RestaurantItem</strong> instance contents to the Debug area:<p class="source-code">dump(selectedRestaurant as Any)</p><p>This<a id="_idIndexMarker839"/> confirms <a id="_idIndexMarker840"/>that the <strong class="source-inline">MapViewController</strong> instance has successfully passed the <strong class="source-inline">RestaurantItem</strong> instance to the <strong class="source-inline">RestaurantDetailViewController</strong> instance.</p></li>
				<li>Verify your file looks like the following:<p class="source-code">import UIKit</p><p class="source-code">class RestaurantDetailViewController: UITableViewController {</p><p class="source-code">   <strong class="bold">var selectedRestaurant: RestaurantItem?</strong></p><p class="source-code">   override func viewDidLoad() { </p><p class="source-code">      super.viewDidLoad() </p><p class="source-code">      <strong class="bold">dump(selectedRestaurant as Any)</strong></p><p class="source-code">   }</p><p class="source-code">}</p></li>
				<li>Click the <strong class="source-inline">RestaurantDetail</strong> storyboard file inside the <strong class="source-inline">RestaurantDetail</strong> folder. Select the <strong class="bold">Table View Controller Scene</strong> in the storyboard. Click the Identity inspector button. Under <strong class="bold">Custom Class</strong>, set <strong class="bold">Class</strong> to <strong class="source-inline">RestaurantDetailViewController</strong>:<div id="_idContainer386" class="IMG---Figure"><img src="image/Figure_16.20_B17469.jpg" alt="Figure 16.20: Identity inspector settings for Restaurant Detail View Controller scene&#13;&#10;"/></div><p class="figure-caption">Figure 16.20: Identity inspector settings for Restaurant Detail View Controller scene</p><p>Note the <a id="_idIndexMarker841"/>scene<a id="_idIndexMarker842"/> name will change to <strong class="bold">Restaurant Detail View Controller Scene</strong>.</p></li>
				<li>Click the <strong class="source-inline">MapViewController</strong> file in the Project navigator.</li>
				<li>Add a property to hold a <strong class="source-inline">RestaurantItem</strong> instance after the <strong class="source-inline">private let manager = MapDataManager()</strong> statement:<p class="source-code">var selectedRestaurant: RestaurantItem?</p></li>
				<li>Add the following code into the <strong class="source-inline">func mapView(_:annotationView:calloutAccessoryControlTapped:)</strong> method, before the  <strong class="source-inline">self.performSegue(withIdentifier:sender:)</strong> method call:<p class="source-code">func mapView(_ mapView: MKMapView, annotationView </p><p class="source-code">view: MKAnnotationView, calloutAccessoryControlTapped </p><p class="source-code">control: UIControl){</p><p class="source-code"><strong class="bold">   guard let annotation = </strong></p><p class="source-code"><strong class="bold">   mapView.selectedAnnotations.first else { </strong></p><p class="source-code"><strong class="bold">      return </strong></p><p class="source-code"><strong class="bold">   }</strong></p><p class="source-code"><strong class="bold">   selectedRestaurant = annotation as? RestaurantItem </strong></p><p class="source-code">   self.performSegue(withIdentifier: </p><p class="source-code">   Segue.showDetail.rawValue, sender: self)</p><p class="source-code">}</p><p>This gets the <strong class="source-inline">RestaurantItem</strong> instance associated with <strong class="source-inline">MKAnnotationView</strong> instance that was tapped and assigns it to <strong class="source-inline">selectedRestaurant</strong>.</p></li>
				<li>To pass <a id="_idIndexMarker843"/>the <strong class="source-inline">RestaurantItem</strong> instance from the <strong class="source-inline">MapViewController</strong> instance<a id="_idIndexMarker844"/> to the <strong class="source-inline">RestaurantDetailViewController</strong> instance, you'll override the <strong class="source-inline">UIViewController</strong> method named  <strong class="source-inline">prepare(for:sender:)</strong>. Type in the following code after <strong class="source-inline">viewDidLoad()</strong>:<p class="source-code">override func prepare(for segue: UIStoryboardSegue, sender: Any?){</p><p class="source-code">   switch segue.identifier! {</p><p class="source-code">      case Segue.showDetail.rawValue:</p><p class="source-code">         showRestaurantDetail(segue: segue)</p><p class="source-code">      default:</p><p class="source-code">         print("Segue not added")</p><p class="source-code">   }</p><p class="source-code">}</p><p>The <strong class="source-inline">prepare(for:sender:)</strong> method is executed by a view controller before transitioning to another view controller. In this case, this method is called before the <strong class="bold">Map</strong> screen transitions to the <strong class="bold">Restaurant Detail</strong> screen. If the segue's identifier is <strong class="source-inline">showDetail</strong>, which it is in this case, the <strong class="source-inline">showRestaurantDetail(segue:)</strong> method is called. This method will set the <strong class="source-inline">selectedRestaurant</strong> property for the <strong class="source-inline">RestaurantDetailViewController</strong> instance. You'll see an error because <strong class="source-inline">showRestaurantDetail(segue:)</strong> has not been created yet.</p></li>
				<li>Add the<a id="_idIndexMarker845"/> following<a id="_idIndexMarker846"/> code after the <strong class="source-inline">setupMap(_:)</strong> method to implement <strong class="source-inline">showRestaurantDetail(segue:)</strong>:<p class="source-code">func showRestaurantDetail(segue: UIStoryboardSegue) {</p><p class="source-code">   if let viewController = segue.destination as? </p><p class="source-code">   RestaurantDetailViewController, let restaurant = </p><p class="source-code">   selectedRestaurant {</p><p class="source-code">      viewController.selectedRestaurant = restaurant</p><p class="source-code">   }</p><p class="source-code">}</p><p>This checks to make sure the segue destination is a <strong class="source-inline">RestaurantDetailViewController</strong> instance. If it is, a temporary constant, <strong class="source-inline">restaurant</strong>, is assigned the <strong class="source-inline">selectedRestaurant</strong> property in the <strong class="source-inline">MapViewController</strong> instance. <strong class="source-inline">restaurant</strong> is then assigned to the <strong class="source-inline">selectedRestaurant</strong> property in the <strong class="source-inline">RestaurantDetailViewController</strong> instance.</p><p>In other words, the restaurant details that you get from the <strong class="source-inline">RestaurantItem </strong>instance is passed to the <strong class="source-inline">RestaurantDetailViewController</strong> instance.</p></li>
			</ol>
			<p>Build and run your app. In the <strong class="bold">Map</strong> screen, tap a pin and then tap the callout button. The <strong class="bold">Restaurant Detail</strong> screen will appear. Click the Report navigator and click the first entry as shown. You should see the restaurant details in the Editor area:</p>
			<div>
				<div id="_idContainer387" class="IMG---Figure">
					<img src="image/Figure_16.21_B17469.jpg" alt="Figure 16.21: Report navigator showing contents of first entry&#13;&#10;"/>
				</div>
			</div>
			<p class="figure-caption">Figure 16.21: Report navigator showing contents of first entry</p>
			<p>You have added the storyboard for the <strong class="bold">Restaurant Detail</strong> screen to your project, connected it to the <strong class="bold">Map</strong> screen, and have successfully passed data from a selected restaurant in the <strong class="bold">Map </strong>screen to the <strong class="bold">Restaurant Detail</strong> screen. The <strong class="source-inline">RestaurantDetailViewController</strong> instance now has the data from the <strong class="source-inline">RestaurantItem</strong> instance that was selected on the <strong class="bold">Map</strong> screen. Great! You'll configure the <strong class="bold">Restaurant Detail</strong> screen to display that data in the next chapter.</p>
			<p>You have done a lot of work in this chapter, so before you go on to the next chapter, let's organize<a id="_idIndexMarker847"/> the<a id="_idIndexMarker848"/> code that you have written to make it easier to understand. You will use extensions to do so in the next section.</p>
			<h1 id="_idParaDest-236"><a id="_idTextAnchor241"/>Organizing your code</h1>
			<p>As your <a id="_idIndexMarker849"/>programs become more complex, you will use extensions (covered in <a href="B17469_08_Final_VK_ePub.xhtml#_idTextAnchor123"><em class="italic">Chapter 8</em></a><em class="italic">, Protocols, Extensions, and Error Handling</em>) to organize your code. Extensions can help you to make code more readable and avoid clutter.</p>
			<p>You will organize four classes: <strong class="source-inline">ExploreViewController</strong>, <strong class="source-inline">RestaurantListViewController</strong>, <strong class="source-inline">LocationViewController</strong>, and <strong class="source-inline">MapViewController</strong>. You will segregate blocks of related code using extensions. Let's begin with the <strong class="source-inline">ExploreViewController</strong> class in the next section.</p>
			<h2 id="_idParaDest-237"><a id="_idTextAnchor242"/>Refactoring the ExploreViewController class</h2>
			<p>You will <a id="_idIndexMarker850"/>divide the code in the <strong class="source-inline">ExploreViewController</strong> file into distinct sections using extensions. Follow these steps:</p>
			<ol>
				<li value="1">Click the <strong class="source-inline">ExploreViewController</strong> file in the Project navigator. After the final curly brace, add the following:<p class="source-code">// MARK: Private Extension</p><p class="source-code">private extension ExploreViewController {</p><p class="source-code">   // code goes here</p><p class="source-code">}</p><p class="source-code">// MARK: UICollectionViewDataSource</p><p class="source-code">extension ExploreViewController: </p><p class="source-code">UICollectionViewDataSource {</p><p class="source-code">   // code goes here</p><p class="source-code">}</p><p>Here, you are creating two extensions. The first extension will be private, which means the contents of this extension are only accessible to the <strong class="source-inline">ExploreViewController</strong> class. The second extension will contain all of the <strong class="source-inline">UICollectionViewDataSource</strong> methods.</p></li>
				<li>You'll get an error because <strong class="source-inline">UICollectionViewDataSource</strong> appears in two places. Delete <strong class="source-inline">UICollectionViewDataSource</strong> from the class declaration at the top of the file. Your class declaration should look like this:<p class="source-code">class ExploreViewController: UIViewController, UICollectionViewDelegate {</p></li>
				<li>Move all the <strong class="source-inline">UICollectionViewDataSource</strong> methods into the second extension. It should look like this:<p class="source-code">// MARK: UICollectionViewDataSource</p><p class="source-code">extension ExploreViewController: </p><p class="source-code">UICollectionViewDataSource {</p><p class="source-code">   <strong class="bold">func collectionView(_ collectionView: </strong></p><p class="source-code"><strong class="bold">   UICollectionView, viewForSupplementaryElementOfKind</strong></p><p class="source-code"><strong class="bold">   kind: String, at indexPath: IndexPath) -&gt; </strong></p><p class="source-code"><strong class="bold">   UICollectionReusableView {</strong></p><p class="source-code"><strong class="bold">      let headerView = collectionView.</strong></p><p class="source-code"><strong class="bold">      dequeueReusableSupplementaryView( ofKind: kind,</strong></p><p class="source-code"><strong class="bold">      withReuseIdentifier: "header", for: indexPath)</strong></p><p class="source-code"><strong class="bold">      return headerView</strong></p><p class="source-code"><strong class="bold">   }</strong></p><p class="source-code"><strong class="bold">   func collectionView(_ collectionView: </strong></p><p class="source-code"><strong class="bold">   UICollectionView, numberOfItemsInSection </strong></p><p class="source-code"><strong class="bold">   section: Int) -&gt; Int {</strong></p><p class="source-code"><strong class="bold">      manager.numberOfExploreItems()</strong></p><p class="source-code"><strong class="bold">   }</strong></p><p class="source-code"><strong class="bold">   func collectionView(_ collectionView: </strong></p><p class="source-code"><strong class="bold">   UICollectionView, cellForItemAt indexPath:</strong></p><p class="source-code"><strong class="bold">   IndexPath) -&gt; UICollectionViewCell {</strong></p><p class="source-code"><strong class="bold">      let cell = collectionView.dequeueReusableCell(</strong></p><p class="source-code"><strong class="bold">      withReuseIdentifier: "exploreCell", for: </strong></p><p class="source-code"><strong class="bold">      indexPath) as! ExploreCell</strong></p><p class="source-code"><strong class="bold">      let exploreItem = manager.exploreItem(at: </strong></p><p class="source-code"><strong class="bold">      indexPath.row)</strong></p><p class="source-code"><strong class="bold">      cell.exploreNameLabel.text = exploreItem.name</strong></p><p class="source-code"><strong class="bold">      cell.exploreImageView.image = UIImage(</strong></p><p class="source-code"><strong class="bold">      named: exploreItem.image!)</strong></p><p class="source-code"><strong class="bold">      return cell</strong></p><p class="source-code"><strong class="bold">   }</strong></p><p class="source-code">}</p><p>To keep <strong class="source-inline">viewDidLoad()</strong> as clean as possible, you will create an <strong class="source-inline">initialize()</strong> method inside the <strong class="source-inline">private</strong> extension, and put everything you need to initialize the view controller in there. After that, you will call <strong class="source-inline">initialize()</strong> in <strong class="source-inline">viewDidLoad()</strong>. </p></li>
				<li>Add <a id="_idIndexMarker851"/>the <strong class="source-inline">initialize()</strong> method inside the <strong class="source-inline">private</strong> extension:<p class="source-code">func initialize() {</p><p class="source-code">   manager.fetch()</p><p class="source-code">}</p></li>
				<li>Move the <strong class="source-inline">unwindLocationCancel(segue:)</strong> method inside the <strong class="source-inline">private</strong> extension as well.</li>
				<li>Verify that the private extension looks like this:<p class="source-code">// MARK: Private Extension</p><p class="source-code">private extension ExploreViewController {</p><p class="source-code"><strong class="bold">   func initialize() {</strong></p><p class="source-code"><strong class="bold">      manager.fetch()</strong></p><p class="source-code"><strong class="bold">   }</strong></p><p class="source-code"><strong class="bold">   @IBAction func unwindLocationCancel(segue:</strong></p><p class="source-code"><strong class="bold">   UIStoryboardSegue) {</strong></p><p class="source-code"><strong class="bold">   }</strong></p><p class="source-code">}</p></li>
				<li>Finally, modify <strong class="source-inline">viewDidLoad()</strong> as follows:<p class="source-code">override func viewDidLoad() { </p><p class="source-code">   super.viewDidLoad() </p><p class="source-code">   <strong class="bold">initialize()</strong></p><p class="source-code">}</p></li>
			</ol>
			<p>The benefits of segregating your code in this way may not seem obvious now, but as your classes become more complex, you will find it is easier to look for a specific method and to <a id="_idIndexMarker852"/>maintain your code. Before you do the same to the other files, let's see how the <strong class="source-inline">// MARK:</strong> syntax is used in the next section.</p>
			<h2 id="_idParaDest-238"><a id="_idTextAnchor243"/>Using the // MARK: syntax</h2>
			<p>The <strong class="source-inline">// MARK:</strong> syntax is <a id="_idIndexMarker853"/>used to navigate easily between different parts of your code. Let's see what it does:</p>
			<ol>
				<li value="1">Look at the path that is visible just under the Toolbar and click on the last part as shown:<div id="_idContainer388" class="IMG---Figure"><img src="image/Figure_16.22_B17469.jpg" alt="Figure 16.22: Editor area showing path&#13;&#10;"/></div><p class="figure-caption">Figure 16.22: Editor area showing path</p></li>
				<li>A menu is displayed, and you will see both <strong class="bold">Private Extension</strong> and <strong class="bold">UICollectionViewDataSource</strong> in it, generated by the <strong class="source-inline">// MARK:</strong> syntax. This enables you to easily jump to these sections:</li>
			</ol>
			<div>
				<div id="_idContainer389" class="IMG---Figure">
					<img src="image/Figure_16.23_B17469.jpg" alt="Figure 16.23: Path menu with Private extension selected&#13;&#10;"/>
				</div>
			</div>
			<p class="figure-caption">Figure 16.23: Path menu with Private extension selected</p>
			<p>You have <a id="_idIndexMarker854"/>organized the <strong class="source-inline">ExploreViewController</strong> class, so let's do the <strong class="source-inline">RestaurantListViewController</strong> class next by refactoring it and adding extensions.</p>
			<h2 id="_idParaDest-239"><a id="_idTextAnchor244"/>Refactoring the RestaurantListViewController class</h2>
			<p>You will add<a id="_idIndexMarker855"/> two extensions to the <strong class="source-inline">RestaurantListViewController</strong> class, similar to those you added to the <strong class="source-inline">ExploreViewController</strong> class. Follow these steps:</p>
			<ol>
				<li value="1">Click the <strong class="source-inline">RestaurantListViewController</strong> file in the Project navigator. After the final curly brace, add the following:<p class="source-code">// MARK: Private Extension</p><p class="source-code">private extension RestaurantListViewController {</p><p class="source-code">   // code goes here</p><p class="source-code">}</p><p class="source-code">// MARK: UICollectionViewDataSource </p><p class="source-code">extension RestaurantListViewController: </p><p class="source-code">UICollectionViewDataSource {</p><p class="source-code">   // code goes here</p><p class="source-code">}</p><p>You'll put private methods for the <strong class="source-inline">RestaurantListViewController</strong> class in the first extension, and all the <strong class="source-inline">UICollectionViewDataSource</strong> methods in the second extension.</p></li>
				<li>Delete <strong class="source-inline">UICollectionViewDataSource</strong> from the class declaration at the top of the<a id="_idIndexMarker856"/> file. Your class declaration should look like this:<p class="source-code">class RestaurantListViewController: UIViewController, UICollectionViewDelegate {</p></li>
				<li>Move all the <strong class="source-inline">UICollectionViewDataSource</strong> methods into the second extension. It should look like this when done:<p class="source-code">// MARK: UICollectionViewDataSource extension </p><p class="source-code">RestaurantListViewController: </p><p class="source-code">UICollectionViewDataSource {</p><p class="source-code"><strong class="bold">   func collectionView(_ collectionView: </strong></p><p class="source-code"><strong class="bold">   UICollectionView, numberOfItemsInSection </strong></p><p class="source-code"><strong class="bold">   section: Int) -&gt; Int {</strong></p><p class="source-code"><strong class="bold">      1</strong></p><p class="source-code"><strong class="bold">   }</strong></p><p class="source-code"><strong class="bold">   func collectionView(_ collectionView: </strong></p><p class="source-code"><strong class="bold">   UICollectionView, cellForItemAt indexPath: </strong></p><p class="source-code"><strong class="bold">   IndexPath) -&gt; UICollectionViewCell {</strong></p><p class="source-code"><strong class="bold">      collectionView.dequeueReusableCell(</strong></p><p class="source-code"><strong class="bold">      withReuseIdentifier: "restaurantCell", </strong></p><p class="source-code"><strong class="bold">      for: indexPath)</strong></p><p class="source-code"><strong class="bold">   }</strong></p><p class="source-code">}</p></li>
			</ol>
			<p>You are done organizing the <strong class="source-inline">RestaurantListViewController</strong> class, so let's clean up <a id="_idIndexMarker857"/>the <strong class="source-inline">LocationViewController</strong> class in the next section.</p>
			<h2 id="_idParaDest-240"><a id="_idTextAnchor245"/>Refactoring the LocationViewController class</h2>
			<p>As you did<a id="_idIndexMarker858"/> before, you will add two extensions to the <strong class="source-inline">LocationViewController</strong> file. Follow these steps:</p>
			<ol>
				<li value="1">Click the <strong class="source-inline">LocationViewController</strong> file in the Project navigator. After the final curly brace, add the following:<p class="source-code">// MARK: Private Extension</p><p class="source-code">private extension LocationViewController {</p><p class="source-code">   // code goes here</p><p class="source-code">}</p><p class="source-code">// MARK: UITableViewDataSource</p><p class="source-code">extension LocationViewController: </p><p class="source-code">UITableViewDataSource {</p><p class="source-code">   // code goes here</p><p class="source-code">}</p><p>The first extension will contain private methods for the <strong class="source-inline">LocationViewController</strong> class. The second extension will contain all the <strong class="source-inline">UITableViewDataSource</strong> methods.</p></li>
				<li>Delete <strong class="source-inline">UITableViewDataSource</strong> from the class declaration at the top of the file. Your class declaration should look like this: <p class="source-code">class LocationViewController: UIViewController {</p></li>
				<li>Move all the <strong class="source-inline">UITableViewDataSource</strong> methods into the second extension. It should <a id="_idIndexMarker859"/>look like this:<p class="source-code">// MARK: UITableViewDataSource</p><p class="source-code">extension LocationViewController: UITableViewDataSource </p><p class="source-code">{</p><p class="source-code">   <strong class="bold">func tableView(_ tableView: UITableView, </strong></p><p class="source-code"><strong class="bold">   numberOfRowsInSection section: Int) -&gt; Int {</strong></p><p class="source-code"><strong class="bold">      manager.numberOfLocationItems()</strong></p><p class="source-code"><strong class="bold">   }</strong></p><p class="source-code">   <strong class="bold">func tableView(_ tableView: UITableView, </strong></p><p class="source-code"><strong class="bold">   cellForRowAt indexPath: IndexPath) -&gt; </strong></p><p class="source-code"><strong class="bold">   UITableViewCell {</strong></p><p class="source-code"><strong class="bold">      let cell = tableView.dequeueReusableCell(</strong></p><p class="source-code"><strong class="bold">      withIdentifier: "locationCell", for: indexPath)</strong></p><p class="source-code"><strong class="bold">      cell.textLabel?.text = </strong></p><p class="source-code"><strong class="bold">      manager.locationItem(at: indexPath.row)</strong></p><p class="source-code"><strong class="bold">      return cell</strong></p><p class="source-code"><strong class="bold">   }</strong></p><p class="source-code">}</p></li>
				<li>Just like you did in the <strong class="source-inline">ExploreViewController</strong> class, you will create an <strong class="source-inline">initialize()</strong> method inside the first extension, and put in it everything you need to initialize the <strong class="source-inline">LocationViewController</strong> class there. Add the following inside the first extension:<p class="source-code">// MARK: Private Extension</p><p class="source-code">private extension LocationViewController {</p><p class="source-code"><strong class="bold">   func initialize() {</strong></p><p class="source-code"><strong class="bold">      manager.fetch()</strong></p><p class="source-code"><strong class="bold">   }</strong></p><p class="source-code">}</p></li>
				<li>Modify <strong class="source-inline">viewDidLoad()</strong> as follows to call the <strong class="source-inline">initialize()</strong> method:<p class="source-code">override func viewDidLoad() { </p><p class="source-code">   super.viewDidLoad() </p><p class="source-code">   <strong class="bold">initialize()</strong></p><p class="source-code">}</p></li>
			</ol>
			<p>You are done <a id="_idIndexMarker860"/>organizing the <strong class="source-inline">LocationViewController</strong> class, so let's clean up the <strong class="source-inline">MapViewController</strong> class in the next section.</p>
			<h2 id="_idParaDest-241"><a id="_idTextAnchor246"/>Refactoring the MapViewController class</h2>
			<p>As you did<a id="_idIndexMarker861"/> before for the other classes, you will add two extensions to the <strong class="source-inline">MapViewController</strong> class. Follow these steps:</p>
			<ol>
				<li value="1">Click the <strong class="source-inline">MapViewController</strong> file in the Project navigator. After the final curly brace, add the following:<p class="source-code">// MARK: Private Extension</p><p class="source-code">private extension MapViewController {</p><p class="source-code">   // code goes here</p><p class="source-code">}</p><p class="source-code">// MARK: MKMapViewDelegate</p><p class="source-code">extension MapViewController: MKMapViewDelegate {</p><p class="source-code">   // code goes here</p><p class="source-code">}</p><p>The first extension will contain private methods for the <strong class="source-inline">MapViewController</strong> class. The second one will contain all the <strong class="source-inline">MKMapViewDelegate</strong> methods.</p></li>
				<li>Delete <strong class="source-inline">MKMapViewDelegate</strong> from the class declaration at the top of the file. Your class definition should look like this:<p class="source-code">class MapViewController: UIViewController {</p></li>
				<li>Move all <a id="_idIndexMarker862"/>the <strong class="source-inline">MKMapViewDelegate</strong> methods into the second extension. It should look like this:<p class="source-code">// MARK: MKMapViewDelegate</p><p class="source-code">extension MapViewController: MKMapViewDelegate {</p><p class="source-code"><strong class="bold">   func mapView(_ mapView: MKMapView, annotationView </strong></p><p class="source-code"><strong class="bold">   view: MKAnnotationView, </strong></p><p class="source-code"><strong class="bold">   calloutAccessoryControlTapped control: UIControl){</strong></p><p class="source-code"><strong class="bold">      guard let annotation = </strong></p><p class="source-code"><strong class="bold">      mapView.selectedAnnotations.first else </strong></p><p class="source-code"><strong class="bold">      { </strong></p><p class="source-code"><strong class="bold">         return </strong></p><p class="source-code"><strong class="bold">      }</strong></p><p class="source-code"><strong class="bold">      selectedRestaurant = annotation as? </strong></p><p class="source-code"><strong class="bold">      RestaurantItem </strong></p><p class="source-code"><strong class="bold">      self.performSegue(withIdentifier: </strong></p><p class="source-code"><strong class="bold">      Segue.showDetail.rawValue, sender: self)</strong></p><p class="source-code"><strong class="bold">   }</strong></p><p class="source-code"><strong class="bold">   func mapView(_ mapView: MKMapView, viewFor </strong></p><p class="source-code"><strong class="bold">   annotation:MKAnnotation) -&gt; MKAnnotationView? {</strong></p><p class="source-code"><strong class="bold">      let identifier = "custompin"</strong></p><p class="source-code"><strong class="bold">      guard !annotation.isKind(of: </strong></p><p class="source-code"><strong class="bold">      MKUserLocation.self) else { </strong></p><p class="source-code"><strong class="bold">         return nil </strong></p><p class="source-code"><strong class="bold">      }</strong></p><p class="source-code"><strong class="bold">      let annotationView: MKAnnotationView</strong></p><p class="source-code"><strong class="bold">      if let customAnnotationView = mapView.</strong></p><p class="source-code"><strong class="bold">      dequeueReusableAnnotationView(withIdentifier: </strong></p><p class="source-code"><strong class="bold">      identifier) { </strong></p><p class="source-code"><strong class="bold">         annotationView = customAnnotationView </strong></p><p class="source-code"><strong class="bold">         annotationView.annotation = annotation</strong></p><p class="source-code"><strong class="bold">      } else {</strong></p><p class="source-code"><strong class="bold">         let av = MKAnnotationView(annotation: </strong></p><p class="source-code"><strong class="bold">         annotation, reuseIdentifier: identifier)</strong></p><p class="source-code"><strong class="bold">         av.rightCalloutAccessoryView = </strong></p><p class="source-code"><strong class="bold">         UIButton(type: .detailDisclosure)</strong></p><p class="source-code"><strong class="bold">         annotationView = av</strong></p><p class="source-code"><strong class="bold">      }</strong></p><p class="source-code"><strong class="bold">      annotationView.canShowCallout = true</strong></p><p class="source-code"><strong class="bold">      if let image = UIImage(named: "custom-</strong></p><p class="source-code"><strong class="bold">      annotation") { </strong></p><p class="source-code"><strong class="bold">         annotationView.image = image</strong></p><p class="source-code"><strong class="bold">         annotationView.centerOffset = </strong></p><p class="source-code"><strong class="bold">         CGPoint(x: -image.size.width / 2, </strong></p><p class="source-code"><strong class="bold">         y: -image.size height / 2 )</strong></p><p class="source-code"><strong class="bold">      }</strong></p><p class="source-code"><strong class="bold">      return annotationView</strong></p><p class="source-code"><strong class="bold">   }</strong></p><p class="source-code">}</p></li>
				<li>Move the <strong class="source-inline">initialize()</strong>, <strong class="source-inline">setupMap(_:)</strong>, and <strong class="source-inline">showRestaurantDetail(segue:)</strong> methods into the first extension. It should look<a id="_idIndexMarker863"/> like this: <p class="source-code">// MARK: Private Extension</p><p class="source-code">private extension MapViewController {</p><p class="source-code"><strong class="bold">   func initialize() { </strong></p><p class="source-code"><strong class="bold">   mapView.delegate = self </strong></p><p class="source-code"><strong class="bold">   manager.fetch { (annotations) in </strong></p><p class="source-code"><strong class="bold">      setupMap(annotations) }</strong></p><p class="source-code"><strong class="bold">   }</strong></p><p class="source-code"><strong class="bold">   func setupMap(_ annotations: [RestaurantItem]) {</strong></p><p class="source-code"><strong class="bold">      mapView.setRegion(manager.currentRegion(</strong></p><p class="source-code"><strong class="bold">      latDelta: 0.5, longDelta: 0.5), animated: true)</strong></p><p class="source-code"><strong class="bold">      mapView.addAnnotations(manager.annotations)</strong></p><p class="source-code"><strong class="bold">   }</strong></p><p class="source-code"><strong class="bold">   func showRestaurantDetail(segue:UIStoryboardSegue){</strong></p><p class="source-code"><strong class="bold">      if let viewController = segue.destination as?</strong></p><p class="source-code"><strong class="bold">      RestaurantDetailViewController, let restaurant </strong></p><p class="source-code"><strong class="bold">      = selectedRestaurant {</strong></p><p class="source-code"><strong class="bold">         viewController.selectedRestaurant </strong></p><p class="source-code"><strong class="bold">         = restaurant</strong></p><p class="source-code"><strong class="bold">      }</strong></p><p class="source-code"><strong class="bold">   }</strong></p><p class="source-code">}</p></li>
			</ol>
			<p>You have organized all four view controllers (<strong class="source-inline">ExploreViewController</strong>, <strong class="source-inline">RestaurantListViewController</strong>, <strong class="source-inline">LocationViewController</strong>, and <strong class="source-inline">MapViewController</strong>) using<a id="_idIndexMarker864"/> extensions. Great job!</p>
			<h1 id="_idParaDest-242"><a id="_idTextAnchor247"/>Summary</h1>
			<p>In this chapter, you created a new class, <strong class="source-inline">RestaurantItem</strong>, that conforms to the <strong class="source-inline">MKAnnotation</strong> protocol. Next, you created <strong class="source-inline">MapDataManager</strong>, a data manager class that loads restaurant data from a <strong class="source-inline">.plist</strong> file and puts it into an array of <strong class="source-inline">RestaurantItem</strong> instances. You created the <strong class="source-inline">DataManager</strong> protocol and refactored both <strong class="source-inline">MapDataManager</strong> and <strong class="source-inline">ExploreDataManager</strong> classes to use this protocol. After that, you created the <strong class="source-inline">MapViewController</strong> class, a view controller for the <strong class="bold">Map</strong> screen, and configured it to display custom annotations. You configured callout buttons in the custom annotations to present the <strong class="bold">Restaurant Detail</strong> screen. Next, you created the <strong class="source-inline">RestaurantDetailViewController</strong> class, a view controller for the <strong class="bold">Restaurant Detail</strong> screen, and passed data to it from the <strong class="source-inline">MapViewController</strong> instance. At this point, you know how to create objects that conform to the <strong class="source-inline">MKAnnotation</strong> protocol, how to add them to a map view, and how to create custom <strong class="source-inline">MKAnnotationViews</strong>, which enables you to add annotated maps to your own projects.</p>
			<p>You also added storyboard files to your project, learned how to use storyboard references and organized your view controller classes (<strong class="source-inline">ExploreViewController</strong>, <strong class="source-inline">RestaurantListViewController</strong>, <strong class="source-inline">LocationViewController</strong>, and <strong class="source-inline">MapViewController</strong>) using extensions. This will help you organize storyboards and code for large projects, making it easier to read and maintain. </p>
			<p>In the next chapter, you'll learn about <strong class="bold">JSON</strong> files, and how to load data from them so the <strong class="bold">Restaurant List</strong> and <strong class="bold">Map</strong> screens can display details about a particular restaurant.</p>
		</div>
	</body></html>