<html><head></head><body>
<div id="_idContainer175" class="calibre2">
<h1 class="chapter-number" id="_idParaDest-139"><a id="_idTextAnchor157" class="calibre3 pcalibre pcalibre1"/><span class="kobospan" id="kobo.1.1">12</span></h1>
<h1 id="_idParaDest-140" class="calibre6"><a id="_idTextAnchor158" class="calibre3 pcalibre pcalibre1"/><span class="kobospan" id="kobo.2.1">Testing Your App</span></h1>
<p class="calibre4"><span class="kobospan" id="kobo.3.1">Testing Android apps is a crucial aspect of the development process, ensuring that our application functions as intended and meets user expectations. </span><span class="kobospan" id="kobo.3.2">It helps us identify and fix bugs before they reach production and ensure that our app is stable and performs well. </span><span class="kobospan" id="kobo.3.3">This chapter will equip you with the skills to write tests for the different layers of our app that we’ve created </span><span><span class="kobospan" id="kobo.4.1">so far.</span></span></p>
<p class="calibre4"><span class="kobospan" id="kobo.5.1">In this chapter, we will learn how to add tests for the different layers in our </span><strong class="bold"><span class="kobospan" id="kobo.6.1">MVVM</span></strong><span class="kobospan" id="kobo.7.1"> (</span><strong class="bold"><span class="kobospan" id="kobo.8.1">Model-View-ViewModel</span></strong><span class="kobospan" id="kobo.9.1">) architecture. </span><span class="kobospan" id="kobo.9.2">We will learn the importance of adding tests to our apps and how to add unit tests, integration tests, and </span><span><span class="kobospan" id="kobo.10.1">instrumentation tests.</span></span></p>
<p class="calibre4"><span class="kobospan" id="kobo.11.1">In this chapter, we’re going to cover the following </span><span><span class="kobospan" id="kobo.12.1">main topics:</span></span></p>
<ul class="calibre16">
<li class="calibre15"><span class="kobospan" id="kobo.13.1">Importance </span><span><span class="kobospan" id="kobo.14.1">of testing</span></span></li>
<li class="calibre15"><span class="kobospan" id="kobo.15.1">Testing the network and </span><span><span class="kobospan" id="kobo.16.1">database layers</span></span></li>
<li class="calibre15"><span class="kobospan" id="kobo.17.1">Testing </span><span><span class="kobospan" id="kobo.18.1">our </span></span><span><strong class="source-inline1"><span class="kobospan" id="kobo.19.1">ViewModels</span></strong></span></li>
<li class="calibre15"><span class="kobospan" id="kobo.20.1">Adding UI tests to </span><span><span class="kobospan" id="kobo.21.1">our composables</span></span></li>
</ul>
<h1 id="_idParaDest-141" class="calibre6"><a id="_idTextAnchor159" class="calibre3 pcalibre pcalibre1"/><span class="kobospan" id="kobo.22.1">Technical requirements</span></h1>
<p class="calibre4"><span class="kobospan" id="kobo.23.1">To follow the instructions in this chapter, you will need to have Android Studio Hedgehog or later (</span><a href="https://developer.android.com/studio" class="calibre3 pcalibre pcalibre1"><span><span class="kobospan" id="kobo.24.1">https://developer.android.com/studio</span></span></a><span><span class="kobospan" id="kobo.25.1">) </span></span><span><span class="kobospan" id="kobo.26.1">downloaded</span></span><span><span class="kobospan" id="kobo.27.1">.</span></span></p>
<p class="calibre4"><span class="kobospan" id="kobo.28.1">You can use the previous chapter’s code to follow the instructions in this chapter. </span><span class="kobospan" id="kobo.28.2">You can find the code for this chapter </span><span><span class="kobospan" id="kobo.29.1">at </span></span><a href="https://github.com/PacktPublishing/Mastering-Kotlin-for-Android/tree/main/chaptertwelve" class="calibre3 pcalibre pcalibre1"><span><span class="kobospan" id="kobo.30.1">https://github.com/PacktPublishing/Mastering-Kotlin-for-Android/tree/main/chaptertwelve</span></span></a><span><span class="kobospan" id="kobo.31.1">.</span></span></p>
<h1 id="_idParaDest-142" class="calibre6"><a id="_idTextAnchor160" class="calibre3 pcalibre pcalibre1"/><span class="kobospan" id="kobo.32.1">Importance of testing</span></h1>
<p class="calibre4"><span class="kobospan" id="kobo.33.1">Writing tests is a</span><a id="_idIndexMarker596" class="calibre3 pcalibre pcalibre1"/><span class="kobospan" id="kobo.34.1"> crucial aspect of app development. </span><span class="kobospan" id="kobo.34.2">It has the </span><span><span class="kobospan" id="kobo.35.1">following benefits:</span></span></p>
<ul class="calibre16">
<li class="calibre15"><span class="kobospan" id="kobo.36.1">It helps us to </span><strong class="bold"><span class="kobospan" id="kobo.37.1">identify and fix bugs</span></strong><span class="kobospan" id="kobo.38.1"> before they reach production. </span><span class="kobospan" id="kobo.38.2">When we write tests for our code, we can see issues at an early stage and quickly fix them before they reach our users, which is normally </span><span><span class="kobospan" id="kobo.39.1">very costly.</span></span></li>
<li class="calibre15"><strong class="bold"><span class="kobospan" id="kobo.40.1">Ensures code quality</span></strong><span class="kobospan" id="kobo.41.1">. </span><span class="kobospan" id="kobo.41.2">When we write tests, we are forced to write code that can be tested. </span><span class="kobospan" id="kobo.41.3">This means that we write code that is modular and loosely coupled. </span><span class="kobospan" id="kobo.41.4">This makes our code base more maintainable and easier to work with. </span><span class="kobospan" id="kobo.41.5">When we find a piece of code that is hard to test, it is a sign that the code is not well written and needs to </span><span><span class="kobospan" id="kobo.42.1">be refactored.</span></span></li>
<li class="calibre15"><span class="kobospan" id="kobo.43.1">Writing tests results in </span><strong class="bold"><span class="kobospan" id="kobo.44.1">improved documentation and code understanding</span></strong><span class="kobospan" id="kobo.45.1">. </span><span class="kobospan" id="kobo.45.2">When we write tests, we are forced to think about how our code works and how it should be used. </span><span class="kobospan" id="kobo.45.3">This makes it easier for other developers to understand our code. </span><span class="kobospan" id="kobo.45.4">While tests can serve as a form of documentation, they should not replace proper </span><span><span class="kobospan" id="kobo.46.1">code documentation.</span></span></li>
<li class="calibre15"><span class="kobospan" id="kobo.47.1">Tests help us to </span><strong class="bold"><span class="kobospan" id="kobo.48.1">refactor our code with confidence</span></strong><span class="kobospan" id="kobo.49.1">. </span><span class="kobospan" id="kobo.49.2">When we have tests in place, we can refactor our code and be sure that we have not broken the existing features in our app that were working well before the refactoring. </span><span class="kobospan" id="kobo.49.3">This is because we can run our tests and see whether they pass </span><span><span class="kobospan" id="kobo.50.1">or fail.</span></span></li>
<li class="calibre15"><span class="kobospan" id="kobo.51.1">Tests help us </span><strong class="bold"><span class="kobospan" id="kobo.52.1">test regression</span></strong><span class="kobospan" id="kobo.53.1">, especially adding new features or modifying existing ones. </span><span class="kobospan" id="kobo.53.2">Tests ensure that the existing functionality still works as before, and nothing has </span><span><span class="kobospan" id="kobo.54.1">been broken.</span></span></li>
</ul>
<p class="calibre4"><span class="kobospan" id="kobo.55.1">These are just to mention a few. </span><span class="kobospan" id="kobo.55.2">There are many more benefits of writing tests, and the best way to realize them is to start writing tests for your code. </span><span class="kobospan" id="kobo.55.3">One important thing to note is that we can also add tests to our </span><strong class="bold"><span class="kobospan" id="kobo.56.1">Continuous Integration/Continuous Delivery</span></strong><span class="kobospan" id="kobo.57.1"> (</span><strong class="bold"><span class="kobospan" id="kobo.58.1">CI/CD</span></strong><span class="kobospan" id="kobo.59.1">) pipelines to ensure</span><a id="_idIndexMarker597" class="calibre3 pcalibre pcalibre1"/><span class="kobospan" id="kobo.60.1"> that our tests run automatically when we push our code to our repositories. </span><span class="kobospan" id="kobo.60.2">This also ensures that as we collaborate with other people on our projects, we can be sure that our code is always in a good state and we can always deploy our code to production </span><span><span class="kobospan" id="kobo.61.1">with confidence.</span></span></p>
<p class="calibre4"><span class="kobospan" id="kobo.62.1">In Android, we have a concept called the </span><strong class="bold"><span class="kobospan" id="kobo.63.1">testing pyramid</span></strong><span class="kobospan" id="kobo.64.1"> that helps us to understand the several types of tests that we can write for our </span><a id="_idIndexMarker598" class="calibre3 pcalibre pcalibre1"/><span class="kobospan" id="kobo.65.1">applications and how they relate to each other. </span><span class="kobospan" id="kobo.65.2">The testing </span><a id="_idIndexMarker599" class="calibre3 pcalibre pcalibre1"/><span class="kobospan" id="kobo.66.1">pyramid is divided into three layers, as shown in the </span><span><span class="kobospan" id="kobo.67.1">following figure:</span></span></p>
<div class="calibre2">
<div class="img---figure" id="_idContainer166">
<span class="kobospan" id="kobo.68.1"><img alt="Figure 12.1 – Testing pyramid" src="image/B19779_12_01.jpg" class="calibre5"/></span>
</div>
</div>
<p class="img---caption" lang="en-US" xml:lang="en-US"><span class="kobospan" id="kobo.69.1">Figure 12.1 – Testing pyramid</span></p>
<p class="calibre4"><span class="kobospan" id="kobo.70.1">As shown in the preceding diagram, we have three layers </span><span><span class="kobospan" id="kobo.71.1">of tests:</span></span></p>
<ul class="calibre16">
<li class="calibre15"><strong class="bold"><span class="kobospan" id="kobo.72.1">Unit tests</span></strong><span class="kobospan" id="kobo.73.1">: These tests sit at the bottom of the pyramid. </span><span class="kobospan" id="kobo.73.2">These are tests that test a single unit of code in isolation. </span><span class="kobospan" id="kobo.73.3">Unit tests are intended to test the smallest testable parts of an application – typically, methods and functions. </span><span class="kobospan" id="kobo.73.4">They are the fastest to run and are the most reliable. </span><span class="kobospan" id="kobo.73.5">They are also the easiest to write and maintain. </span><span class="kobospan" id="kobo.73.6">Unit tests run on your local machine only. </span><span class="kobospan" id="kobo.73.7">These tests are compiled to run locally on the </span><strong class="bold"><span class="kobospan" id="kobo.74.1">Java Virtual Machine </span></strong><span class="kobospan" id="kobo.75.1">(</span><strong class="bold"><span class="kobospan" id="kobo.76.1">JVM</span></strong><span class="kobospan" id="kobo.77.1">) to minimize execution time. </span><span class="kobospan" id="kobo.77.2">For tests that depend on your own dependencies, we use mock objects to provide the external dependencies. </span><strong class="bold"><span class="kobospan" id="kobo.78.1">MockK</span></strong><span class="kobospan" id="kobo.79.1"> and </span><strong class="bold"><span class="kobospan" id="kobo.80.1">Mockito</span></strong><span class="kobospan" id="kobo.81.1"> are popular frameworks for </span><span><span class="kobospan" id="kobo.82.1">mocking dependencies.</span></span></li>
<li class="calibre15"><strong class="bold"><span class="kobospan" id="kobo.83.1">Integration tests</span></strong><span class="kobospan" id="kobo.84.1">: These tests</span><a id="_idIndexMarker600" class="calibre3 pcalibre pcalibre1"/><span class="kobospan" id="kobo.85.1"> sit in the</span><a id="_idIndexMarker601" class="calibre3 pcalibre pcalibre1"/><span class="kobospan" id="kobo.86.1"> middle of the pyramid. </span><span class="kobospan" id="kobo.86.2">They</span><a id="_idIndexMarker602" class="calibre3 pcalibre pcalibre1"/><span class="kobospan" id="kobo.87.1"> test how different units of code </span><a id="_idIndexMarker603" class="calibre3 pcalibre pcalibre1"/><span class="kobospan" id="kobo.88.1">work together. </span><span class="kobospan" id="kobo.88.2">They are slower to run than</span><a id="_idIndexMarker604" class="calibre3 pcalibre pcalibre1"/><span class="kobospan" id="kobo.89.1"> unit tests. </span><span class="kobospan" id="kobo.89.2">They are also hard to write as they require multiple components and dependencies to work and maintain. </span><strong class="bold"><span class="kobospan" id="kobo.90.1">Roboletric</span></strong><span class="kobospan" id="kobo.91.1"> is a popular framework for writing </span><span><span class="kobospan" id="kobo.92.1">integration tests.</span></span></li>
<li class="calibre15"><strong class="bold"><span class="kobospan" id="kobo.93.1">UI tests</span></strong><span class="kobospan" id="kobo.94.1">: These tests sit at the top of the </span><a id="_idIndexMarker605" class="calibre3 pcalibre pcalibre1"/><span class="kobospan" id="kobo.95.1">pyramid. </span><span class="kobospan" id="kobo.95.2">They test how the different components of our app work </span><a id="_idIndexMarker606" class="calibre3 pcalibre pcalibre1"/><span class="kobospan" id="kobo.96.1">together. </span><span class="kobospan" id="kobo.96.2">They are the slowest to run since they run on a real device or emulator and are the least reliable. </span><span class="kobospan" id="kobo.96.3">They are also the </span><a id="_idIndexMarker607" class="calibre3 pcalibre pcalibre1"/><span class="kobospan" id="kobo.97.1">most expensive to write and maintain. </span><span class="kobospan" id="kobo.97.2">There are several frameworks for writing UI tests, including </span><strong class="bold"><span class="kobospan" id="kobo.98.1">Espresso</span></strong><span class="kobospan" id="kobo.99.1">, </span><strong class="bold"><span class="kobospan" id="kobo.100.1">UI Automator</span></strong><span class="kobospan" id="kobo.101.1">, </span><span><span class="kobospan" id="kobo.102.1">and </span></span><span><strong class="bold"><span class="kobospan" id="kobo.103.1">Appium</span></strong></span><span><span class="kobospan" id="kobo.104.1">.</span></span></li>
</ul>
<p class="calibre4"><span class="kobospan" id="kobo.105.1">The testing pyramid presents a way to distribute the tests that we write on our code base. </span><span class="kobospan" id="kobo.105.2">The ideal distribution percentages are </span><strong class="bold"><span class="kobospan" id="kobo.106.1">70% for unit tests</span></strong><span class="kobospan" id="kobo.107.1">, </span><strong class="bold"><span class="kobospan" id="kobo.108.1">20% for integration tests</span></strong><span class="kobospan" id="kobo.109.1">, and </span><strong class="bold"><span class="kobospan" id="kobo.110.1">10% for UI tests</span></strong><span class="kobospan" id="kobo.111.1">. </span><span class="kobospan" id="kobo.111.2">Notice as we go up the pyramid that the number of tests reduces. </span><span class="kobospan" id="kobo.111.3">This is because as we go up the pyramid, the tests become more expensive to write and maintain. </span><span class="kobospan" id="kobo.111.4">This is why</span><a id="_idIndexMarker608" class="calibre3 pcalibre pcalibre1"/><span class="kobospan" id="kobo.112.1"> we should strive to write more unit tests than integration tests and more integration tests than </span><span><span class="kobospan" id="kobo.113.1">UI tests.</span></span></p>
<p class="calibre4"><span class="kobospan" id="kobo.114.1">Over the next few sections, we will write the tests for the different layers we have discussed. </span><span class="kobospan" id="kobo.114.2">Let us start by testing our database and network layers in </span><span><span class="kobospan" id="kobo.115.1">our app.</span></span></p>
<h1 id="_idParaDest-143" class="calibre6"><a id="_idTextAnchor161" class="calibre3 pcalibre pcalibre1"/><span class="kobospan" id="kobo.116.1">Testing the network and database layers</span></h1>
<p class="calibre4"><span class="kobospan" id="kobo.117.1">In this section, we are going to learn how to write tests for our network and database layers step </span><span><span class="kobospan" id="kobo.118.1">by step.</span></span></p>
<h2 id="_idParaDest-144" class="calibre7"><a id="_idTextAnchor162" class="calibre3 pcalibre pcalibre1"/><span class="kobospan" id="kobo.119.1">Testing the network layer</span></h2>
<p class="calibre4"><span class="kobospan" id="kobo.120.1">To test our network layer, we will write </span><a id="_idIndexMarker609" class="calibre3 pcalibre pcalibre1"/><span class="kobospan" id="kobo.121.1">unit tests. </span><span class="kobospan" id="kobo.121.2">However, since we are using Retrofit to make our network requests, we will use </span><strong class="source-inline"><span class="kobospan" id="kobo.122.1">MockWebServer</span></strong><span class="kobospan" id="kobo.123.1"> to mock our network requests. </span><span class="kobospan" id="kobo.123.2">The </span><strong class="source-inline"><span class="kobospan" id="kobo.124.1">MockWebServer </span></strong><span class="kobospan" id="kobo.125.1">is a library that allows us to mock our network requests. </span><span class="kobospan" id="kobo.125.2">Let us start by setting up the test dependencies in our </span><span><span class="kobospan" id="kobo.126.1">version catalog:</span></span></p>
<ol class="calibre14">
<li class="calibre15"><span class="kobospan" id="kobo.127.1">Open the </span><strong class="source-inline1"><span class="kobospan" id="kobo.128.1">libs.version.toml</span></strong><span class="kobospan" id="kobo.129.1"> file and add the following versions in the </span><span><span class="kobospan" id="kobo.130.1">versions section:</span></span><pre class="source-code"><span class="kobospan1" id="kobo.131.1">
mockWebServer = "5.0.0-alpha.2"
coroutinesTest = "1.7.3"
truth = "1.1.5"</span></pre><p class="calibre4"><span class="kobospan" id="kobo.132.1">We are setting up the versions for </span><strong class="source-inline"><span class="kobospan" id="kobo.133.1">mockWebServer</span></strong><span class="kobospan" id="kobo.134.1">, </span><strong class="source-inline"><span class="kobospan" id="kobo.135.1">coroutinesTest</span></strong><span class="kobospan" id="kobo.136.1">, </span><span><span class="kobospan" id="kobo.137.1">and </span></span><span><strong class="source-inline"><span class="kobospan" id="kobo.138.1">truth</span></strong></span><span><span class="kobospan" id="kobo.139.1">.</span></span></p></li> <li class="calibre15"><span class="kobospan" id="kobo.140.1">Next, in the</span><a id="_idIndexMarker610" class="calibre3 pcalibre pcalibre1"/><span class="kobospan" id="kobo.141.1"> libraries section, add </span><span><span class="kobospan" id="kobo.142.1">the following:</span></span><pre class="source-code"><span class="kobospan1" id="kobo.143.1">
test-mock-webserver = { module = "com.squareup.okhttp3:mockwebserver", version.ref = "mockWebServer" }
test-coroutines = { module = "org.jetbrains.kotlinx:kotlinx-coroutines-test", version.ref = "coroutinesTest" }
test-truth = { module = "com.google.truth:truth", version.ref = "truth" }</span></pre><p class="calibre4"><span class="kobospan" id="kobo.144.1">Here, we are adding the dependencies for </span><span><span class="kobospan" id="kobo.145.1">these libraries.</span></span></p></li> <li class="calibre15"><span class="kobospan" id="kobo.146.1">Next, we will create a bundle so that it is easy to add all test dependencies at once. </span><span class="kobospan" id="kobo.146.2">In the bundle section, add </span><span><span class="kobospan" id="kobo.147.1">the following:</span></span><pre class="source-code"><span class="kobospan1" id="kobo.148.1">
test = ["test-mock-webserver", "test-coroutines", "test-truth"]</span></pre></li> <li class="calibre15"><span class="kobospan" id="kobo.149.1">Click on the </span><strong class="bold"><span class="kobospan" id="kobo.150.1">Sync Now</span></strong><span class="kobospan" id="kobo.151.1"> button at the top to add </span><span><span class="kobospan" id="kobo.152.1">the dependencies.</span></span></li>
<li class="calibre15"><span class="kobospan" id="kobo.153.1">Lastly, let us head over to the app-level </span><strong class="source-inline1"><span class="kobospan" id="kobo.154.1">build.gradle.kts</span></strong><span class="kobospan" id="kobo.155.1"> file and add </span><span><span class="kobospan" id="kobo.156.1">the following:</span></span><pre class="source-code"><span class="kobospan1" id="kobo.157.1">
testImplementation(libs.bundles.test)</span></pre><p class="calibre4"><span class="kobospan" id="kobo.158.1">This will add the test bundle to our </span><span><span class="kobospan" id="kobo.159.1">test directory.</span></span></p></li> <li class="calibre15"><span class="kobospan" id="kobo.160.1">Click on the </span><strong class="bold"><span class="kobospan" id="kobo.161.1">Sync Now</span></strong><span class="kobospan" id="kobo.162.1"> button to add the dependencies to </span><span><span class="kobospan" id="kobo.163.1">our app.</span></span></li>
</ol>
<p class="calibre4"><span class="kobospan" id="kobo.164.1">Before we start writing our tests, we need to do several setup tasks. </span><span class="kobospan" id="kobo.164.2">First, we need to create a JSON response for the request that our test </span><span><span class="kobospan" id="kobo.165.1">will use:</span></span></p>
<ol class="calibre14">
<li class="calibre15"><span class="kobospan" id="kobo.166.1">To do this, right-click on the </span><strong class="source-inline1"><span class="kobospan" id="kobo.167.1">app</span></strong><span class="kobospan" id="kobo.168.1"> directory, select </span><strong class="bold"><span class="kobospan" id="kobo.169.1">New</span></strong><span class="kobospan" id="kobo.170.1">, and at the bottom of the pop-up dialog, </span><span><span class="kobospan" id="kobo.171.1">select </span></span><span><strong class="bold"><span class="kobospan" id="kobo.172.1">Folder</span></strong></span><span><span class="kobospan" id="kobo.173.1">.</span></span></li>
<li class="calibre15"><span class="kobospan" id="kobo.174.1">From the options presented, select </span><strong class="bold"><span class="kobospan" id="kobo.175.1">Java Resources Folder</span></strong><span class="kobospan" id="kobo.176.1">. </span><span class="kobospan" id="kobo.176.2">This should create a new folder </span><a id="_idIndexMarker611" class="calibre3 pcalibre pcalibre1"/><span class="kobospan" id="kobo.177.1">named </span><strong class="source-inline1"><span class="kobospan" id="kobo.178.1">resources</span></strong><span class="kobospan" id="kobo.179.1">, as shown in the </span><span><span class="kobospan" id="kobo.180.1">following figure:</span></span></li>
</ol>
<div class="calibre2">
<div class="img---figure" id="_idContainer167">
<span class="kobospan" id="kobo.181.1"><img alt="Figure 12.2 – The resources folder" src="image/B19779_12_02.jpg" class="calibre5"/></span>
</div>
</div>
<p class="img---caption" lang="en-US" xml:lang="en-US"><span class="kobospan" id="kobo.182.1">Figure 12.2 – The resources folder</span></p>
<ol class="calibre14">
<li value="3" class="calibre15"><span class="kobospan" id="kobo.183.1">Inside this folder, let us create a new JSON file called </span><strong class="source-inline1"><span class="kobospan" id="kobo.184.1">catsresponse.json</span></strong><span class="kobospan" id="kobo.185.1"> and add the </span><span><span class="kobospan" id="kobo.186.1">following JSON:</span></span><pre class="source-code"><span class="kobospan1" id="kobo.187.1">
[
  {
    "_id": "eLjLV4oegWGFv9MH",
    "mimetype": "image/png",
    "size": 39927,
    "tags": [
      "cute",
      "pyret"
    ]
  },
  {
    "_id": "PA2gYEbMCzaiDrWv",
    "mimetype": "image/jpeg",
    "size": 59064,
    "tags": [
      "cute",
      "best",
      "siberian",
      "fluffy"
    ]
  },
  {
    "_id": "8PKU6iXscrogXrHm",
    "mimetype": "image/jpeg",
    "size": 60129,
    "tags": [
      "cute",
      "fat",
      "ragdoll",
      "beautiful",
      "sleeping"
    ]
  }
]</span></pre><p class="calibre4"><span class="kobospan" id="kobo.188.1">Our app uses the Cat as a</span><a id="_idIndexMarker612" class="calibre3 pcalibre pcalibre1"/><span class="kobospan" id="kobo.189.1"> Service API, which returns a list of cats per the filter you have applied. </span><span class="kobospan" id="kobo.189.2">The API returns this list of cats in a JSON response, as shown previously. </span><span class="kobospan" id="kobo.189.3">When testing, especially with mocked data, the structure and data types of the JSON response should match those of the real API to ensure our tests </span><span><span class="kobospan" id="kobo.190.1">are correct.</span></span></p></li> <li class="calibre15"><span class="kobospan" id="kobo.191.1">Now that we have our response ready, we have to create a class that utilizes this response along with our test class in the </span><strong class="source-inline1"><span class="kobospan" id="kobo.192.1">com.packt.chaptertwelve (test)</span></strong><span class="kobospan" id="kobo.193.1"> directory shown in the </span><span><span class="kobospan" id="kobo.194.1">following figure:</span></span></li>
</ol>
<div class="calibre2">
<div class="img---figure" id="_idContainer168">
<span class="kobospan" id="kobo.195.1"><img alt="Figure 12.3 – Test directory" src="image/B19779_12_03.jpg" class="calibre5"/></span>
</div>
</div>
<p class="img---caption" lang="en-US" xml:lang="en-US"><span class="kobospan" id="kobo.196.1">Figure 12.3 – Test directory</span></p>
<ol class="calibre14">
<li value="5" class="calibre15"><span class="kobospan" id="kobo.197.1">Inside the </span><strong class="source-inline1"><span class="kobospan" id="kobo.198.1">com.packt.chaptertwelve (test)</span></strong><span class="kobospan" id="kobo.199.1"> directory, let us create a new Kotlin file called </span><strong class="source-inline1"><span class="kobospan" id="kobo.200.1">MockRequestDispatcher.kt</span></strong><span class="kobospan" id="kobo.201.1"> and add the </span><span><span class="kobospan" id="kobo.202.1">following code:</span></span><pre class="source-code"><span class="kobospan1" id="kobo.203.1">
import com.google.common.io.Resources
import okhttp3.mockwebserver.Dispatcher
import okhttp3.mockwebserver.MockResponse
import okhttp3.mockwebserver.RecordedRequest
import java.io.File
import java.net.HttpURLConnection
class MockRequestDispatcher : Dispatcher() {
    override fun dispatch(request: RecordedRequest): MockResponse {
        return when (request.path) {
            "/cats?tag=cute" -&gt; {
                MockResponse()
                    .setResponseCode(HttpURLConnection.HTTP_OK)
                    .setBody(getJson("catsresponse.json"))
            }
            else -&gt; throw IllegalArgumentException("Unknown Request Path ${request.path}")
        }
    }
    private fun getJson(path: String): String {
        val uri = Resources.getResource(path)
        val file = File(uri.path)
        return String(file.readBytes())
    }
}</span></pre><p class="calibre4"><span class="kobospan" id="kobo.204.1">Here is a breakdown </span><a id="_idIndexMarker613" class="calibre3 pcalibre pcalibre1"/><span class="kobospan" id="kobo.205.1">of the </span><span><span class="kobospan" id="kobo.206.1">preceding code:</span></span></p><ul class="calibre17"><li class="calibre15"><span class="kobospan" id="kobo.207.1">We have created a class called </span><strong class="source-inline1"><span class="kobospan" id="kobo.208.1">MockRequestDispatcher</span></strong><span class="kobospan" id="kobo.209.1"> that extends </span><strong class="source-inline1"><span class="kobospan" id="kobo.210.1">Dispatcher</span></strong><span class="kobospan" id="kobo.211.1">. </span><span class="kobospan" id="kobo.211.2">This class will be used to mock our </span><span><span class="kobospan" id="kobo.212.1">network requests.</span></span></li><li class="calibre15"><span class="kobospan" id="kobo.213.1">We override the </span><strong class="source-inline1"><span class="kobospan" id="kobo.214.1">dispatch</span></strong><span class="kobospan" id="kobo.215.1"> function, which takes </span><strong class="source-inline1"><span class="kobospan" id="kobo.216.1">RecordedRequest</span></strong><span class="kobospan" id="kobo.217.1"> and returns </span><strong class="source-inline1"><span class="kobospan" id="kobo.218.1">MockResponse</span></strong><span class="kobospan" id="kobo.219.1">. </span><span class="kobospan" id="kobo.219.2">This function is called when a request is made to </span><span><span class="kobospan" id="kobo.220.1">the server.</span></span></li><li class="calibre15"><span class="kobospan" id="kobo.221.1">We check the path of the request, and if it matches the path of our request, we return </span><strong class="source-inline1"><span class="kobospan" id="kobo.222.1">MockResponse</span></strong><span class="kobospan" id="kobo.223.1"> with a response code of </span><strong class="source-inline1"><span class="kobospan" id="kobo.224.1">200</span></strong><span class="kobospan" id="kobo.225.1"> and a body of the </span><strong class="source-inline1"><span class="kobospan" id="kobo.226.1">Json</span></strong><span class="kobospan" id="kobo.227.1"> response that we created earlier. </span><span class="kobospan" id="kobo.227.2">For now, we have only mocked a successful response, but it’s important to handle all the different HTTP response codes and error cases to properly mimic </span><span><span class="kobospan" id="kobo.228.1">real-world scenarios.</span></span></li><li class="calibre15"><span class="kobospan" id="kobo.229.1">If the path does not match, we </span><span><span class="kobospan" id="kobo.230.1">throw </span></span><span><strong class="source-inline1"><span class="kobospan" id="kobo.231.1">IllegalArgumentException</span></strong></span><span><span class="kobospan" id="kobo.232.1">.</span></span></li><li class="calibre15"><span class="kobospan" id="kobo.233.1">Lastly, we create a </span><strong class="source-inline1"><span class="kobospan" id="kobo.234.1">getJson</span></strong><span class="kobospan" id="kobo.235.1"> function that takes a path and returns a </span><strong class="source-inline1"><span class="kobospan" id="kobo.236.1">String</span></strong><span class="kobospan" id="kobo.237.1"> instance type. </span><span class="kobospan" id="kobo.237.2">This function is used to read the </span><strong class="source-inline1"><span class="kobospan" id="kobo.238.1">Json</span></strong><span class="kobospan" id="kobo.239.1"> response from the file that we </span><span><span class="kobospan" id="kobo.240.1">created earlier.</span></span></li></ul><p class="calibre4"><span class="kobospan" id="kobo.241.1">We can add as many paths as we want to this class. </span><span class="kobospan" id="kobo.241.2">Since our project only has one path, this is all </span><span><span class="kobospan" id="kobo.242.1">we need.</span></span></p></li> <li class="calibre15"><span class="kobospan" id="kobo.243.1">Next, let us create our test class. </span><span class="kobospan" id="kobo.243.2">Let us create a new Kotlin file called </span><strong class="source-inline1"><span class="kobospan" id="kobo.244.1">CatsAPITest.kt</span></strong><span class="kobospan" id="kobo.245.1"> and add the </span><span><span class="kobospan" id="kobo.246.1">following code:</span></span><pre class="source-code"><span class="kobospan1" id="kobo.247.1">
class CatsAPITest {
    private lateinit var mockWebServer: MockWebServer
    private lateinit var catsAPI: CatsAPI
    @Before
    fun setup() {
        // Setup MockWebServer
        mockWebServer = MockWebServer()
        mockWebServer.dispatcher = MockRequestDispatcher()
        mockWebServer.start()
        // Setup Retrofit
        val json = Json {
            ignoreUnknownKeys = true
            isLenient = true
        }
        val retrofit = Retrofit.Builder()
            .baseUrl(mockWebServer.url("/"))
            .addConverterFactory(
                json.asConverterFactory(
                    contentType = "application/json".toMediaType()
                )
            )
            .build()
        catsAPI = retrofit.create(CatsAPI::class.java)
    }
    @Test
    fun `fetchCats() returns a list of cats`() = runTest {
        val response = catsAPI.fetchCats("cute")
        assert(response.isSuccessful)
    }
    @After
    @Throws(IOException::class)
    fun tearDown() {
        mockWebServer.shutdown()
    }
}</span></pre><p class="calibre4"><span class="kobospan" id="kobo.248.1">Here is a breakdown of the </span><span><span class="kobospan" id="kobo.249.1">preceding code:</span></span></p><ul class="calibre17"><li class="calibre15"><span class="kobospan" id="kobo.250.1">We have created a class called </span><strong class="source-inline1"><span class="kobospan" id="kobo.251.1">CatsAPITest</span></strong><span class="kobospan" id="kobo.252.1">. </span><span class="kobospan" id="kobo.252.2">This class will be used to test our </span><span><span class="kobospan" id="kobo.253.1">network layer.</span></span></li><li class="calibre15"><span class="kobospan" id="kobo.254.1">We have created two variables: </span><strong class="source-inline1"><span class="kobospan" id="kobo.255.1">mockWebServer</span></strong><span class="kobospan" id="kobo.256.1"> and </span><strong class="source-inline1"><span class="kobospan" id="kobo.257.1">catsAPI</span></strong><span class="kobospan" id="kobo.258.1">. </span><span class="kobospan" id="kobo.258.2">The </span><strong class="source-inline1"><span class="kobospan" id="kobo.259.1">mockWebServer</span></strong><span class="kobospan" id="kobo.260.1"> variable will be used to mock our network requests. </span><span class="kobospan" id="kobo.260.2">The </span><strong class="source-inline1"><span class="kobospan" id="kobo.261.1">catsAPI</span></strong><span class="kobospan" id="kobo.262.1"> variable will be </span><a id="_idIndexMarker614" class="calibre3 pcalibre pcalibre1"/><span class="kobospan" id="kobo.263.1">used to make our </span><span><span class="kobospan" id="kobo.264.1">network reques</span><a id="_idTextAnchor163" class="calibre3 pcalibre pcalibre1"/><span class="kobospan" id="kobo.265.1">ts.</span></span></li><li class="calibre15"><span class="kobospan" id="kobo.266.1">We have the </span><strong class="source-inline1"><span class="kobospan" id="kobo.267.1">setup()</span></strong><span class="kobospan" id="kobo.268.1"> function, which is annotated with the </span><strong class="source-inline1"><span class="kobospan" id="kobo.269.1">@Before</span></strong><span class="kobospan" id="kobo.270.1"> annotation. </span><span class="kobospan" id="kobo.270.2">This means that this function will run before our tests run. </span><span class="kobospan" id="kobo.270.3">In this function, we have done </span><span><span class="kobospan" id="kobo.271.1">the following:</span></span><ul class="calibre17"><li class="calibre15"><span class="kobospan" id="kobo.272.1">We have created a </span><strong class="source-inline1"><span class="kobospan" id="kobo.273.1">MockWebServer</span></strong><span class="kobospan" id="kobo.274.1"> instance and assigned it to the </span><strong class="source-inline1"><span class="kobospan" id="kobo.275.1">mockWebServer</span></strong><span class="kobospan" id="kobo.276.1"> variable. </span><span class="kobospan" id="kobo.276.2">We then set the dispatcher of </span><strong class="source-inline1"><span class="kobospan" id="kobo.277.1">mockWebServer</span></strong><span class="kobospan" id="kobo.278.1"> to an instance of </span><strong class="source-inline1"><span class="kobospan" id="kobo.279.1">MockRequestDispatcher</span></strong><span class="kobospan" id="kobo.280.1">. </span><span class="kobospan" id="kobo.280.2">This is the class that we created earlier. </span><span class="kobospan" id="kobo.280.3">We then </span><span><span class="kobospan" id="kobo.281.1">start</span><a id="_idTextAnchor164" class="calibre3 pcalibre pcalibre1"/> </span><span><strong class="source-inline1"><span class="kobospan" id="kobo.282.1">mockWebServer</span></strong></span><span><span class="kobospan" id="kobo.283.1">.</span></span></li><li class="calibre15"><span class="kobospan" id="kobo.284.1">We have created a Retrofit instance and added the </span><strong class="source-inline1"><span class="kobospan" id="kobo.285.1">kotlinx-serialization-converter</span></strong><span class="kobospan" id="kobo.286.1"> factory. </span><span class="kobospan" id="kobo.286.2">We then assign the </span><strong class="source-inline1"><span class="kobospan" id="kobo.287.1">catsAPI</span></strong><span class="kobospan" id="kobo.288.1"> variable to an instance </span><span><span class="kobospan" id="kobo.289.1">of </span></span><span><strong class="source-inline1"><span class="kobospan" id="kobo.290.1">CatsAPI</span></strong></span><span><span class="kobospan" id="kobo.291.1">.</span></span></li></ul></li><li class="calibre15"><span class="kobospan" id="kobo.292.1">We have our test function, which is annotated with the </span><strong class="source-inline1"><span class="kobospan" id="kobo.293.1">@Test</span></strong><span class="kobospan" id="kobo.294.1"> annotation. </span><span class="kobospan" id="kobo.294.2">This means that this function will be run as a test. </span><span class="kobospan" id="kobo.294.3">In this function, we do </span><span><span class="kobospan" id="kobo.295.1">the following:</span></span><ul class="calibre17"><li class="calibre15"><span class="kobospan" id="kobo.296.1">We wrap the test in the </span><strong class="source-inline1"><span class="kobospan" id="kobo.297.1">runTest()</span></strong><span class="kobospan" id="kobo.298.1"> function. </span><span class="kobospan" id="kobo.298.2">This is because we want to test suspending functions. </span><strong class="source-inline1"><span class="kobospan" id="kobo.299.1">runTest</span></strong><span class="kobospan" id="kobo.300.1"> is a coroutine test builder designed for testing coroutines. </span><span class="kobospan" id="kobo.300.2">It is part of the </span><strong class="source-inline1"><span class="kobospan" id="kobo.301.1">kotlinx-coroutines-test</span></strong><span class="kobospan" id="kobo.302.1"> library that we </span><span><span class="kobospan" id="kobo.303.1">added earlier.</span></span></li><li class="calibre15"><span class="kobospan" id="kobo.304.1">We make a network </span><a id="_idIndexMarker615" class="calibre3 pcalibre pcalibre1"/><span class="kobospan" id="kobo.305.1">request to </span><strong class="source-inline1"><span class="kobospan" id="kobo.306.1">mockWebServer</span></strong><span class="kobospan" id="kobo.307.1"> using the </span><strong class="source-inline1"><span class="kobospan" id="kobo.308.1">catsAPI</span></strong><span class="kobospan" id="kobo.309.1"> instance that we created earlier. </span><span class="kobospan" id="kobo.309.2">We then assert that the response </span><span><span class="kobospan" id="kobo.310.1">is successful.</span></span></li><li class="calibre15"><span class="kobospan" id="kobo.311.1">We have the </span><strong class="source-inline1"><span class="kobospan" id="kobo.312.1">tearDown()</span></strong><span class="kobospan" id="kobo.313.1"> function, which is annotated with the </span><strong class="source-inline1"><span class="kobospan" id="kobo.314.1">@After</span></strong><span class="kobospan" id="kobo.315.1"> annotation. </span><span class="kobospan" id="kobo.315.2">This means that this function will run after our tests run. </span><span class="kobospan" id="kobo.315.3">This function is used to shut down our </span><span><strong class="source-inline1"><span class="kobospan" id="kobo.316.1">mockWebServer</span></strong></span><span><span class="kobospan" id="kobo.317.1"> instance.</span></span></li></ul></li></ul></li> <li class="calibre15"><span class="kobospan" id="kobo.318.1">Press the green </span><em class="italic"><span class="kobospan" id="kobo.319.1">run</span></em><span class="kobospan" id="kobo.320.1"> icon next to our test class to run our tests. </span><span class="kobospan" id="kobo.320.2">We should see the following output in the </span><span><strong class="bold"><span class="kobospan" id="kobo.321.1">Run</span></strong></span><span><span class="kobospan" id="kobo.322.1"> window:</span></span></li>
</ol>
<div class="calibre2">
<div class="img---figure" id="_idContainer169">
<span class="kobospan" id="kobo.323.1"><img alt="Figure 12.4 – Test passing" src="image/B19779_12_04.jpg" class="calibre5"/></span>
</div>
</div>
<p class="img---caption" lang="en-US" xml:lang="en-US"><span class="kobospan" id="kobo.324.1">Figure 12.4 – Test passing</span></p>
<p class="calibre4"><span class="kobospan" id="kobo.325.1">As seen in the preceding figure, our test runs successfully. </span><span class="kobospan" id="kobo.325.2">This means that our network layer is working as expected. </span><span class="kobospan" id="kobo.325.3">We </span><a id="_idIndexMarker616" class="calibre3 pcalibre pcalibre1"/><span class="kobospan" id="kobo.326.1">can now move on to testing our </span><span><span class="kobospan" id="kobo.327.1">database layer.</span></span></p>
<h2 id="_idParaDest-145" class="calibre7"><a id="_idTextAnchor165" class="calibre3 pcalibre pcalibre1"/><span class="kobospan" id="kobo.328.1">Testing the database layer</span></h2>
<p class="calibre4"><span class="kobospan" id="kobo.329.1">We are using </span><strong class="bold"><span class="kobospan" id="kobo.330.1">Room</span></strong><span class="kobospan" id="kobo.331.1"> for our</span><a id="_idIndexMarker617" class="calibre3 pcalibre pcalibre1"/><span class="kobospan" id="kobo.332.1"> database. </span><span class="kobospan" id="kobo.332.2">To test our database layer, we will write JUnit tests that will run on an Android device. </span><span class="kobospan" id="kobo.332.3">JUnit is </span><a id="_idIndexMarker618" class="calibre3 pcalibre pcalibre1"/><span class="kobospan" id="kobo.333.1">a platform that serves as a foundation for launching testing frameworks. </span><span class="kobospan" id="kobo.333.2">It also provides APIs for writing unit tests that run on the platform. </span><span class="kobospan" id="kobo.333.3">The tests will execute faster than our UI tests since they do not require us to create an activity. </span><span class="kobospan" id="kobo.333.4">This means our test will be in the </span><strong class="source-inline"><span class="kobospan" id="kobo.334.1">androidTest</span></strong><span class="kobospan" id="kobo.335.1"> directory shown in the </span><span><span class="kobospan" id="kobo.336.1">following figure:</span></span></p>
<div class="calibre2">
<div class="img---figure" id="_idContainer170">
<span class="kobospan" id="kobo.337.1"><img alt="Figure 12.5 – Android test directory" src="image/B19779_12_05.jpg" class="calibre5"/></span>
</div>
</div>
<p class="img---caption" lang="en-US" xml:lang="en-US"><span class="kobospan" id="kobo.338.1">Figure 12.5 – Android test directory</span></p>
<p class="calibre4"><span class="kobospan" id="kobo.339.1">Let us create a new file called </span><strong class="source-inline"><span class="kobospan" id="kobo.340.1">CatsDaoTest.kt</span></strong><span class="kobospan" id="kobo.341.1"> and add the </span><span><span class="kobospan" id="kobo.342.1">following code:</span></span></p>
<pre class="source-code"><span class="kobospan1" id="kobo.343.1">
@RunWith(AndroidJUnit4::class)
class CatDaoTest {
    private lateinit var database: CatDatabase
    private lateinit var catDao: CatDao
    @Before
    fun createDatabase() {
        database = Room.inMemoryDatabaseBuilder(
            ApplicationProvider.getApplicationContext(),
            CatDatabase::class.java
        ).allowMainThreadQueries().build()
        catDao = database.catDao()
    }
    @After
    fun closeDatabase() {
        database.close()
    }
}</span></pre> <p class="calibre4"><span class="kobospan" id="kobo.344.1">Here is a breakdown of the </span><span><span class="kobospan" id="kobo.345.1">preceding code:</span></span></p>
<ul class="calibre16">
<li class="calibre15"><span class="kobospan" id="kobo.346.1">We have created two variables: </span><strong class="source-inline1"><span class="kobospan" id="kobo.347.1">database</span></strong><span class="kobospan" id="kobo.348.1"> and </span><strong class="source-inline1"><span class="kobospan" id="kobo.349.1">catDao</span></strong><span class="kobospan" id="kobo.350.1">. </span><span class="kobospan" id="kobo.350.2">The </span><strong class="source-inline1"><span class="kobospan" id="kobo.351.1">database</span></strong><span class="kobospan" id="kobo.352.1"> variable will be used to create an instance of our database. </span><span class="kobospan" id="kobo.352.2">The </span><strong class="source-inline1"><span class="kobospan" id="kobo.353.1">catDao</span></strong><span class="kobospan" id="kobo.354.1"> variable will be </span><a id="_idIndexMarker619" class="calibre3 pcalibre pcalibre1"/><span class="kobospan" id="kobo.355.1">used to create an instance of our </span><span><strong class="source-inline1"><span class="kobospan" id="kobo.356.1">CatDao</span></strong></span><span><span class="kobospan" id="kobo.357.1"> interface.</span></span></li>
<li class="calibre15"><span class="kobospan" id="kobo.358.1">We have the </span><strong class="source-inline1"><span class="kobospan" id="kobo.359.1">createDatabase()</span></strong><span class="kobospan" id="kobo.360.1"> function, which is annotated with the </span><strong class="source-inline1"><span class="kobospan" id="kobo.361.1">@Before</span></strong><span class="kobospan" id="kobo.362.1"> annotation. </span><span class="kobospan" id="kobo.362.2">This means that this function will run before our tests run. </span><span class="kobospan" id="kobo.362.3">Inside the function, we create an instance of our database and assign it to the </span><strong class="source-inline1"><span class="kobospan" id="kobo.363.1">database</span></strong><span class="kobospan" id="kobo.364.1"> variable. </span><span class="kobospan" id="kobo.364.2">We are using the </span><span><span class="kobospan" id="kobo.365.1">in-memory database.</span></span></li>
<li class="calibre15"><span class="kobospan" id="kobo.366.1">We have the </span><strong class="source-inline1"><span class="kobospan" id="kobo.367.1">closeDatabase()</span></strong><span class="kobospan" id="kobo.368.1"> function, which is annotated with the </span><strong class="source-inline1"><span class="kobospan" id="kobo.369.1">@After</span></strong><span class="kobospan" id="kobo.370.1"> annotation. </span><span class="kobospan" id="kobo.370.2">This means that this function will run after our tests run. </span><span class="kobospan" id="kobo.370.3">This function is used to close </span><span><span class="kobospan" id="kobo.371.1">our database.</span></span></li>
</ul>
<p class="calibre4"><span class="kobospan" id="kobo.372.1">With this done, we can now start </span><a id="_idIndexMarker620" class="calibre3 pcalibre pcalibre1"/><span class="kobospan" id="kobo.373.1">writing </span><span><span class="kobospan" id="kobo.374.1">our tests:</span></span></p>
<ol class="calibre14">
<li class="calibre15"><span class="kobospan" id="kobo.375.1">In the </span><strong class="source-inline1"><span class="kobospan" id="kobo.376.1">CatsDaoTest</span></strong><span class="kobospan" id="kobo.377.1"> class, add the following </span><span><span class="kobospan" id="kobo.378.1">test function:</span></span><pre class="source-code"><span class="kobospan1" id="kobo.379.1">
@Test
fun testInsertAndReadCat() = runTest {
    // Given a cat
    val cat = CatEntity(
        id = "1",
        owner = "John Doe",
        tags = listOf("cute", "fluffy"),
        createdAt = "2021-07-01T00:00:00.000Z",
        updatedAt = "2021-07-01T00:00:00.000Z",
        isFavorite = false
    )
    // Insert the cat to the database
    catDao.insert(cat)
    // Then the cat is in the database
    val cats = catDao.getCats()
    assert(cats.first().contains(cat))
}</span></pre><p class="calibre4"><span class="kobospan" id="kobo.380.1">In this test, we have created a </span><strong class="source-inline"><span class="kobospan" id="kobo.381.1">CatEntity</span></strong><span class="kobospan" id="kobo.382.1"> object with the details of a cat. </span><span class="kobospan" id="kobo.382.2">We then inserted the details of the cat into the database. </span><span class="kobospan" id="kobo.382.3">Lastly, we assert that the details of the cat are in </span><span><span class="kobospan" id="kobo.383.1">the database.</span></span></p></li> <li class="calibre15"><span class="kobospan" id="kobo.384.1">Click on the green </span><em class="italic"><span class="kobospan" id="kobo.385.1">run</span></em><span class="kobospan" id="kobo.386.1"> icon</span><a id="_idIndexMarker621" class="calibre3 pcalibre pcalibre1"/><span class="kobospan" id="kobo.387.1"> next to our test class to run our tests. </span><span class="kobospan" id="kobo.387.2">You should see the following output in the </span><span><strong class="bold"><span class="kobospan" id="kobo.388.1">Run</span></strong></span><span><span class="kobospan" id="kobo.389.1"> window:</span></span></li>
</ol>
<div class="calibre2">
<div class="img---figure" id="_idContainer171">
<span class="kobospan" id="kobo.390.1"><img alt="Figure 12.6 – Test to insert and read from the database" src="image/B19779_12_06.jpg" class="calibre5"/></span>
</div>
</div>
<p class="img---caption" lang="en-US" xml:lang="en-US"><span class="kobospan" id="kobo.391.1">Figure 12.6 – Test to insert and read from the database</span></p>
<p class="calibre4"><span class="kobospan" id="kobo.392.1">Our test runs successfully. </span><span class="kobospan" id="kobo.392.2">This means that our database layer is working as expected. </span><span class="kobospan" id="kobo.392.3">Let us add another test that tests adding a cat to </span><span><span class="kobospan" id="kobo.393.1">the favorites.</span></span></p>
<ol class="calibre14">
<li value="3" class="calibre15"><span class="kobospan" id="kobo.394.1">Still inside the </span><strong class="source-inline1"><span class="kobospan" id="kobo.395.1">CatsDaoTest</span></strong><span class="kobospan" id="kobo.396.1"> class, let us add the following </span><span><span class="kobospan" id="kobo.397.1">test function:</span></span><pre class="source-code"><span class="kobospan1" id="kobo.398.1">
@Test
fun testAddCatToFavorites() = runTest {
    // Given a cat
    val cat = CatEntity(
        id = "1",
        owner = "John Doe",
        tags = listOf("cute", "fluffy"),
        createdAt = "2021-07-01T00:00:00.000Z",
        updatedAt = "2021-07-01T00:00:00.000Z",
        isFavorite = false
    )
    // Insert the cat to the database
    catDao.insert(cat)
    // Favorite the cat
    catDao.update(cat.copy(isFavorite = true))
    // Assert that the cat is in the favorite list
    val favoriteCats = catDao.getFavoriteCats()
    assert(favoriteCats.first().contains(cat.copy(isFavorite = true)))
}</span></pre><p class="calibre4"><span class="kobospan" id="kobo.399.1">In this test, we have created a </span><strong class="source-inline"><span class="kobospan" id="kobo.400.1">CatEntity</span></strong><span class="kobospan" id="kobo.401.1"> object with the details of a cat. </span><span class="kobospan" id="kobo.401.2">We then insert the cat into the</span><a id="_idIndexMarker622" class="calibre3 pcalibre pcalibre1"/><span class="kobospan" id="kobo.402.1"> database. </span><span class="kobospan" id="kobo.402.2">We then update the </span><strong class="source-inline"><span class="kobospan" id="kobo.403.1">CatEntity</span></strong><span class="kobospan" id="kobo.404.1"> object, passing </span><strong class="source-inline"><span class="kobospan" id="kobo.405.1">isFavorite</span></strong><span class="kobospan" id="kobo.406.1"> as </span><strong class="source-inline"><span class="kobospan" id="kobo.407.1">true</span></strong><span class="kobospan" id="kobo.408.1">. </span><span class="kobospan" id="kobo.408.2">Lastly, we assert that the cat is on the </span><span><span class="kobospan" id="kobo.409.1">favorite list.</span></span></p></li> <li class="calibre15"><span class="kobospan" id="kobo.410.1">Click on the green </span><em class="italic"><span class="kobospan" id="kobo.411.1">run</span></em><span class="kobospan" id="kobo.412.1"> icon next to our test class to run our tests. </span><span class="kobospan" id="kobo.412.2">You should see the following output in the </span><span><strong class="bold"><span class="kobospan" id="kobo.413.1">Run</span></strong></span><span><span class="kobospan" id="kobo.414.1"> window:</span></span></li>
</ol>
<div class="calibre2">
<div class="img---figure" id="_idContainer172">
<span class="kobospan" id="kobo.415.1"><img alt="Figure 12.7 – Favoriting a cat test" src="image/B19779_12_07.jpg" class="calibre5"/></span>
</div>
</div>
<p class="img---caption" lang="en-US" xml:lang="en-US"><span class="kobospan" id="kobo.416.1">Figure 12.7 – Favoriting a cat test</span></p>
<p class="calibre4"><span class="kobospan" id="kobo.417.1">Our tests run successfully. </span><span class="kobospan" id="kobo.417.2">This </span><a id="_idIndexMarker623" class="calibre3 pcalibre pcalibre1"/><span class="kobospan" id="kobo.418.1">means that our functionality for adding cats to favorites is </span><span><span class="kobospan" id="kobo.419.1">working properly.</span></span></p>
<p class="calibre4"><span class="kobospan" id="kobo.420.1">We have seen how to test our network and database layers. </span><span class="kobospan" id="kobo.420.2">Next, let us test our </span><span><span class="kobospan" id="kobo.421.1">ViewModel layer.</span></span></p>
<h1 id="_idParaDest-146" class="calibre6"><a id="_idTextAnchor166" class="calibre3 pcalibre pcalibre1"/><span class="kobospan" id="kobo.422.1">Testing our ViewModels</span></h1>
<p class="calibre4"><span class="kobospan" id="kobo.423.1">Our </span><strong class="source-inline"><span class="kobospan" id="kobo.424.1">ViewModel</span></strong><span class="kobospan" id="kobo.425.1"> class fetches data</span><a id="_idIndexMarker624" class="calibre3 pcalibre pcalibre1"/><span class="kobospan" id="kobo.426.1"> from the repository and exposes it to the UI. </span><span class="kobospan" id="kobo.426.2">To test our </span><strong class="source-inline"><span class="kobospan" id="kobo.427.1">ViewModel</span></strong><span class="kobospan" id="kobo.428.1">, we will write unit tests. </span><span class="kobospan" id="kobo.428.2">Let us start by setting up the test dependencies in our </span><span><span class="kobospan" id="kobo.429.1">version catalog:</span></span></p>
<ol class="calibre14">
<li class="calibre15"><span class="kobospan" id="kobo.430.1">Open the </span><strong class="source-inline1"><span class="kobospan" id="kobo.431.1">libs.version.toml</span></strong><span class="kobospan" id="kobo.432.1"> file and add the following versions in the </span><span><span class="kobospan" id="kobo.433.1">versions section:</span></span><pre class="source-code"><span class="kobospan1" id="kobo.434.1">
mockk = "1.13.3"</span></pre></li> <li class="calibre15"><span class="kobospan" id="kobo.435.1">Next, in the libraries section, add </span><span><span class="kobospan" id="kobo.436.1">the following:</span></span><pre class="source-code"><span class="kobospan1" id="kobo.437.1">
test-mockk = { module = "io.mockk:mockk", version.ref = "mockk" }</span></pre></li> <li class="calibre15"><span class="kobospan" id="kobo.438.1">Add the </span><strong class="source-inline1"><span class="kobospan" id="kobo.439.1">test-mockk</span></strong><span class="kobospan" id="kobo.440.1"> dependency to the </span><strong class="source-inline1"><span class="kobospan" id="kobo.441.1">test</span></strong><span class="kobospan" id="kobo.442.1"> bundle. </span><span class="kobospan" id="kobo.442.2">Our updated </span><strong class="source-inline1"><span class="kobospan" id="kobo.443.1">test</span></strong><span class="kobospan" id="kobo.444.1"> bundle should now look </span><span><span class="kobospan" id="kobo.445.1">like this:</span></span><pre class="source-code"><span class="kobospan1" id="kobo.446.1">
test = ["test-mock-webserver", "test-coroutines", "test-truth", "test-mockk"]</span></pre></li> <li class="calibre15"><span class="kobospan" id="kobo.447.1">Click on the </span><strong class="bold"><span class="kobospan" id="kobo.448.1">Sync Now</span></strong><span class="kobospan" id="kobo.449.1"> button at the top to add the dependencies. </span><span class="kobospan" id="kobo.449.2">Adding </span><strong class="source-inline1"><span class="kobospan" id="kobo.450.1">mockk</span></strong><span class="kobospan" id="kobo.451.1"> allows us to mock </span><span><span class="kobospan" id="kobo.452.1">our dependencies.</span></span></li>
<li class="calibre15"><span class="kobospan" id="kobo.453.1">We are now ready to create our test class. </span><span class="kobospan" id="kobo.453.2">Create a new Kotlin file called </span><strong class="source-inline1"><span class="kobospan" id="kobo.454.1">CatsViewModelTest.kt</span></strong><span class="kobospan" id="kobo.455.1"> inside</span><a id="_idIndexMarker625" class="calibre3 pcalibre pcalibre1"/><span class="kobospan" id="kobo.456.1"> the test directory and add the </span><span><span class="kobospan" id="kobo.457.1">following code:</span></span><pre class="source-code"><span class="kobospan1" id="kobo.458.1">
class PetsViewModelTest {
    private val petsRepository = mockk&lt;PetsRepository&gt;(relaxed = true)
    private lateinit var petsViewModel: PetsViewModel
    @Before
    fun setup() {
        Dispatchers.setMain(Dispatchers.Unconfined)
        petsViewModel = PetsViewModel(petsRepository)
    }
    @After
    fun tearDown() {
        Dispatchers.resetMain()
    }
}</span></pre><p class="calibre4"><span class="kobospan" id="kobo.459.1">Here is a breakdown of the </span><span><span class="kobospan" id="kobo.460.1">preceding code:</span></span></p><ul class="calibre17"><li class="calibre15"><span class="kobospan" id="kobo.461.1">We have created two variables: </span><strong class="source-inline1"><span class="kobospan" id="kobo.462.1">petsRepository</span></strong><span class="kobospan" id="kobo.463.1"> and </span><strong class="source-inline1"><span class="kobospan" id="kobo.464.1">petsViewModel</span></strong><span class="kobospan" id="kobo.465.1">. </span><span class="kobospan" id="kobo.465.2">The </span><strong class="source-inline1"><span class="kobospan" id="kobo.466.1">petsRepository</span></strong><span class="kobospan" id="kobo.467.1"> variable will be used to mock our </span><strong class="source-inline1"><span class="kobospan" id="kobo.468.1">PetsRepository</span></strong><span class="kobospan" id="kobo.469.1"> interface. </span><span class="kobospan" id="kobo.469.2">We used </span><strong class="source-inline1"><span class="kobospan" id="kobo.470.1">mockk&lt;PetsRepository&gt;</span></strong><span class="kobospan" id="kobo.471.1"> to provide a mock instance of </span><strong class="source-inline1"><span class="kobospan" id="kobo.472.1">PetsRepository</span></strong><span class="kobospan" id="kobo.473.1">. </span><span class="kobospan" id="kobo.473.2">The </span><strong class="source-inline1"><span class="kobospan" id="kobo.474.1">petsViewModel</span></strong><span class="kobospan" id="kobo.475.1"> variable will be used to create an instance </span><span><span class="kobospan" id="kobo.476.1">of </span></span><span><strong class="source-inline1"><span class="kobospan" id="kobo.477.1">Pets</span><a id="_idTextAnchor167" class="calibre3 pcalibre pcalibre1"/><span class="kobospan" id="kobo.478.1">ViewModel</span></strong></span><span><span class="kobospan" id="kobo.479.1">.</span></span></li><li class="calibre15"><span class="kobospan" id="kobo.480.1">We have the </span><strong class="source-inline1"><span class="kobospan" id="kobo.481.1">setup()</span></strong><span class="kobospan" id="kobo.482.1"> function, which is annotated with the </span><strong class="source-inline1"><span class="kobospan" id="kobo.483.1">@Before</span></strong><span class="kobospan" id="kobo.484.1"> annotation. </span><span class="kobospan" id="kobo.484.2">This means that this function will run before our tests run. </span><span class="kobospan" id="kobo.484.3">We set the main dispatcher to </span><strong class="source-inline1"><span class="kobospan" id="kobo.485.1">Dispatchers.Unconfined</span></strong><span class="kobospan" id="kobo.486.1">. </span><span class="kobospan" id="kobo.486.2">This is because we are using coroutines in our ViewModel. </span><span class="kobospan" id="kobo.486.3">We then assign the </span><strong class="source-inline1"><span class="kobospan" id="kobo.487.1">petsViewModel</span></strong><span class="kobospan" id="kobo.488.1"> property to an instance </span><span><span class="kobospan" id="kobo.489.1">of </span></span><span><strong class="source-inline1"><span class="kobospan" id="kobo.490.1">PetsViewModel</span></strong></span><span><span class="kobospan" id="kobo.491.1">.</span></span></li><li class="calibre15"><span class="kobospan" id="kobo.492.1">We have the </span><strong class="source-inline1"><span class="kobospan" id="kobo.493.1">tearDown()</span></strong><span class="kobospan" id="kobo.494.1"> function, which is annotated with the </span><strong class="source-inline1"><span class="kobospan" id="kobo.495.1">@After</span></strong><span class="kobospan" id="kobo.496.1"> annotation. </span><span class="kobospan" id="kobo.496.2">This means</span><a id="_idIndexMarker626" class="calibre3 pcalibre pcalibre1"/><span class="kobospan" id="kobo.497.1"> that this function will run after our tests run. </span><span class="kobospan" id="kobo.497.2">This function is used to reset the </span><span><span class="kobospan" id="kobo.498.1">main dispatcher.</span></span></li></ul></li> </ol>
<p class="calibre4"><span class="kobospan" id="kobo.499.1">With this, we are ready to write our test. </span><span class="kobospan" id="kobo.499.2">Below the </span><strong class="source-inline"><span class="kobospan" id="kobo.500.1">tearDown()</span></strong><span class="kobospan" id="kobo.501.1"> function, add the following </span><span><span class="kobospan" id="kobo.502.1">test function:</span></span></p>
<pre class="source-code"><span class="kobospan1" id="kobo.503.1">
@Test
fun testGetPets() = runTest {
    val cats = listOf(
        Cat(
            id = "1",
            owner = "John Doe",
            tags = listOf("cute", "fluffy"),
            createdAt = "2021-07-01T00:00:00.000Z",
            updatedAt = "2021-07-01T00:00:00.000Z",
            isFavorite = false
        )
    )
    // Given
    coEvery { petsRepository.getPets() } returns flowOf(cats)
    // When
    petsViewModel.getPets()
    coVerify { petsRepository.getPets() }
    // Then
    val uiState = petsViewModel.petsUIState.value
    assertEquals(cats, uiState.pets)
}</span></pre> <p class="calibre4"><span class="kobospan" id="kobo.504.1">In this test function, we have created a list of cats. </span><span class="kobospan" id="kobo.504.2">We then mock the </span><strong class="source-inline"><span class="kobospan" id="kobo.505.1">getPets()</span></strong><span class="kobospan" id="kobo.506.1"> function of </span><strong class="source-inline"><span class="kobospan" id="kobo.507.1">PetsRepository</span></strong><span class="kobospan" id="kobo.508.1"> to return a flow of cats. </span><span class="kobospan" id="kobo.508.2">It returns a flow of cats since our </span><strong class="source-inline"><span class="kobospan" id="kobo.509.1">getPets()</span></strong><span class="kobospan" id="kobo.510.1"> function in </span><strong class="source-inline"><span class="kobospan" id="kobo.511.1">PetsRepository</span></strong><span class="kobospan" id="kobo.512.1"> returns </span><strong class="source-inline"><span class="kobospan" id="kobo.513.1">Flow&lt;List&lt;Cat&gt;&gt;</span></strong><span class="kobospan" id="kobo.514.1">; this way, we mock the correct behavior of this function. </span><span class="kobospan" id="kobo.514.2">We then call the </span><strong class="source-inline"><span class="kobospan" id="kobo.515.1">getPets()</span></strong><span class="kobospan" id="kobo.516.1"> function of </span><strong class="source-inline"><span class="kobospan" id="kobo.517.1">PetsViewModel</span></strong><span class="kobospan" id="kobo.518.1">. </span><span class="kobospan" id="kobo.518.2">We</span><a id="_idIndexMarker627" class="calibre3 pcalibre pcalibre1"/><span class="kobospan" id="kobo.519.1"> then assert that the </span><strong class="source-inline"><span class="kobospan" id="kobo.520.1">getPets()</span></strong><span class="kobospan" id="kobo.521.1"> function of </span><strong class="source-inline"><span class="kobospan" id="kobo.522.1">PetsRepository</span></strong><span class="kobospan" id="kobo.523.1"> is called. </span><span class="kobospan" id="kobo.523.2">Lastly, we assert that the list of cats that we created is the same as the list of cats that we get from </span><strong class="source-inline"><span class="kobospan" id="kobo.524.1">PetsViewModel</span></strong><span class="kobospan" id="kobo.525.1">. </span><span class="kobospan" id="kobo.525.2">Remember to remove the private marker in our </span><strong class="source-inline"><span class="kobospan" id="kobo.526.1">PetsViewModel</span></strong><span class="kobospan" id="kobo.527.1"> class in case you get an error when trying to access the </span><strong class="source-inline"><span class="kobospan" id="kobo.528.1">getPets()</span></strong><span class="kobospan" id="kobo.529.1"> function. </span><span class="kobospan" id="kobo.529.2">Click on the green </span><em class="italic"><span class="kobospan" id="kobo.530.1">run</span></em><span class="kobospan" id="kobo.531.1"> icon next to our test class to run our tests. </span><span class="kobospan" id="kobo.531.2">You should see the following output in the </span><span><strong class="bold"><span class="kobospan" id="kobo.532.1">Run</span></strong></span><span><span class="kobospan" id="kobo.533.1"> window:</span></span></p>
<div class="calibre2">
<div class="img---figure" id="_idContainer173">
<span class="kobospan" id="kobo.534.1"><img alt="Figure 12.8 – PetsViewModelTest" src="image/B19779_12_08.jpg" class="calibre5"/></span>
</div>
</div>
<p class="img---caption" lang="en-US" xml:lang="en-US"><span class="kobospan" id="kobo.535.1">Figure 12.8 – PetsViewModelTest</span></p>
<p class="calibre4"><span class="kobospan" id="kobo.536.1">Our test runs successfully. </span><span class="kobospan" id="kobo.536.2">This means that our </span><strong class="source-inline"><span class="kobospan" id="kobo.537.1">ViewModel</span></strong><span class="kobospan" id="kobo.538.1"> layer is working as expected. </span><span class="kobospan" id="kobo.538.2">We can now move on to testing our UI layer. </span><span class="kobospan" id="kobo.538.3">In the next section, we will learn how to write UI tests in </span><span><span class="kobospan" id="kobo.539.1">Jetpack Compose.</span></span></p>
<h1 id="_idParaDest-147" class="calibre6"><a id="_idTextAnchor168" class="calibre3 pcalibre pcalibre1"/><span class="kobospan" id="kobo.540.1">Adding UI tests to our composables</span></h1>
<p class="calibre4"><span class="kobospan" id="kobo.541.1">Writing UI tests has been made easier for us. </span><span class="kobospan" id="kobo.541.2">Jetpack Compose </span><a id="_idIndexMarker628" class="calibre3 pcalibre pcalibre1"/><span class="kobospan" id="kobo.542.1">provides a set of testing APIs to find elements, verify their attributes, and </span><a id="_idIndexMarker629" class="calibre3 pcalibre pcalibre1"/><span class="kobospan" id="kobo.543.1">perform actions on these elements. </span><span class="kobospan" id="kobo.543.2">Jetpack</span><a id="_idIndexMarker630" class="calibre3 pcalibre pcalibre1"/><span class="kobospan" id="kobo.544.1"> Compose uses </span><strong class="bold"><span class="kobospan" id="kobo.545.1">semantics</span></strong><span class="kobospan" id="kobo.546.1"> to identify</span><a id="_idIndexMarker631" class="calibre3 pcalibre pcalibre1"/><span class="kobospan" id="kobo.547.1"> elements in</span><a id="_idTextAnchor169" class="calibre3 pcalibre pcalibre1"/><span class="kobospan" id="kobo.548.1"> our composables. </span><span class="kobospan" id="kobo.548.2">Semantics are a way to describe the UI elements in</span><a id="_idTextAnchor170" class="calibre3 pcalibre pcalibre1"/><span class="kobospan" id="kobo.549.1"> our composables. </span><span class="kobospan" id="kobo.549.2">Semantics are used by accessibility services to make our apps accessible. </span><span class="kobospan" id="kobo.549.3">Testing dependencies are already set up as we created our new project in </span><a href="B19779_02.xhtml#_idTextAnchor031" class="calibre3 pcalibre pcalibre1"><span><em class="italic"><span class="kobospan" id="kobo.550.1">Chapter 2</span></em></span></a><span class="kobospan" id="kobo.551.1"> so no need to add any dependencies. </span><span class="kobospan" id="kobo.551.2">We have a number of composables on our project. </span><span class="kobospan" id="kobo.551.3">For this chapter, we will write tests for the </span><span><strong class="source-inline"><span class="kobospan" id="kobo.552.1">PetListItem</span></strong></span><span><span class="kobospan" id="kobo.553.1"> composable.</span></span></p>
<p class="calibre4"><span class="kobospan" id="kobo.554.1">Let us head over to the </span><strong class="source-inline"><span class="kobospan" id="kobo.555.1">PetListItem.kt</span></strong><span class="kobospan" id="kobo.556.1"> file. </span><span class="kobospan" id="kobo.556.2">We need to add a </span><strong class="source-inline"><span class="kobospan" id="kobo.557.1">testTags</span></strong><span class="kobospan" id="kobo.558.1"> modifier to our composable. </span><span class="kobospan" id="kobo.558.2">This is because we are using tags to identify our composables. </span><span class="kobospan" id="kobo.558.3">In the </span><strong class="source-inline"><span class="kobospan" id="kobo.559.1">PetListItem</span></strong><span class="kobospan" id="kobo.560.1"> composable, modify the composable contents to be </span><span><span class="kobospan" id="kobo.561.1">as follows:</span></span></p>
<pre class="source-code"><span class="kobospan1" id="kobo.562.1">
ElevatedCard(
    modifier = Modifier
        .fillMaxWidth()
        .padding(6.dp)
        .testTag("PetListItemCard"),
) {
    Column(
        modifier = Modifier
            .fillMaxWidth()
            .padding(bottom = 10.dp)
            .testTag("PetListItemColumn")
            .clickable {
                onPetClicked(cat)
            }
    ) {
        AsyncImage(
            model = "https://cataas.com/cat/${cat.id}",
            contentDescription = "Cute cat",
            modifier = Modifier
                .fillMaxWidth()
                .height(200.dp),
            contentScale = ContentScale.FillWidth
        )
        Row(
            modifier = Modifier
                .padding(start = 6.dp, end = 6.dp)
                .fillMaxWidth(),
            verticalAlignment = Alignment.CenterVertically,
            horizontalArrangement = Arrangement.SpaceBetween
        ) {
            FlowRow(
                modifier = Modifier
                    .padding(start = 6.dp, end = 6.dp)
            ) {
                repeat(cat.tags.size) {
                    SuggestionChip(
                        modifier = Modifier
                            .padding(start = 3.dp, end = 3.dp),
                        onClick = { },
                        label = {
                            Text(text = cat.tags[it])
                        }
                    )
                }
            }
            Icon(
                modifier = Modifier
                    .testTag("PetListItemFavoriteIcon")
                    .clickable {
                        onFavoriteClicked(cat.copy(isFavorite = !cat.isFavorite))
                    },
                imageVector = if (cat.isFavorite) {
                    Icons.Default.Favorite
                } else {
                    Icons.Default.FavoriteBorder
                },
                contentDescription = "Favorite",
                tint = if (cat.isFavorite) {
                    Color.Red
                } else {
                    Color.Gray
                }
            )
        }
    }
}</span></pre> <p class="calibre4"><span class="kobospan" id="kobo.563.1">Notice we have added the </span><strong class="source-inline"><span class="kobospan" id="kobo.564.1">testTag()</span></strong><span class="kobospan" id="kobo.565.1"> modifier to our components. </span><span class="kobospan" id="kobo.565.2">With this, we are able to use the Finders APIs in Jetpack Compose to</span><a id="_idIndexMarker632" class="calibre3 pcalibre pcalibre1"/><span class="kobospan" id="kobo.566.1"> find our composables. </span><span class="kobospan" id="kobo.566.2">Once we use the finders, we can</span><a id="_idIndexMarker633" class="calibre3 pcalibre pcalibre1"/><span class="kobospan" id="kobo.567.1"> perform actions and assert on our composables. </span><span class="kobospan" id="kobo.567.2">Let us now create a new file in our </span><strong class="source-inline"><span class="kobospan" id="kobo.568.1">androidTest</span></strong><span class="kobospan" id="kobo.569.1"> directory called </span><strong class="source-inline"><span class="kobospan" id="kobo.570.1">PetListItemTest.kt</span></strong><span class="kobospan" id="kobo.571.1"> and add the </span><span><span class="kobospan" id="kobo.572.1">following code:</span></span></p>
<pre class="source-code"><span class="kobospan1" id="kobo.573.1">
class PetListItemTest {
    @get:Rule
    val composeTestRule = createComposeRule()
    @Test
    fun testPetListItem() {
        with(composeTestRule) {
            setContent {
                PetListItem(
                    cat = Cat(
                        id = "1",
                        owner = "John Doe",
                        tags = listOf("cute", "fluffy"),
                        createdAt = "2021-07-01T00:00:00.000Z",
                        updatedAt = "2021-07-01T00:00:00.000Z",
                        isFavorite = false
                    ),
                    onPetClicked = { },
                    onFavoriteClicked = {})
            }
            // Assertions using tags
            onNodeWithTag("PetListItemCard").assertExists()
            onNodeWithTag("PetListItemColumn").assertExists()
            onNodeWithTag("PetListItemFavoriteIcon").assertExists()
            // Assertions using text
            onNodeWithText("fluffy").assertIsDisplayed()
            onNodeWithContentDescription("Favorite").assertIsDisplayed()
            onNodeWithContentDescription("Cute cat").assertIsDisplayed()
            // Actions
            onNodeWithTag("PetListItemFavoriteIcon").performClick()
        }
    }
}</span></pre> <p class="calibre4"><span class="kobospan" id="kobo.574.1">Here is a </span><a id="_idIndexMarker634" class="calibre3 pcalibre pcalibre1"/><span class="kobospan" id="kobo.575.1">breakdown of the </span><a id="_idIndexMarker635" class="calibre3 pcalibre pcalibre1"/><span><span class="kobospan" id="kobo.576.1">preceding code:</span></span></p>
<ul class="calibre16">
<li class="calibre15"><span class="kobospan" id="kobo.577.1">We have created a class called </span><strong class="source-inline1"><span class="kobospan" id="kobo.578.1">PetListItemTest</span></strong><span class="kobospan" id="kobo.579.1">. </span><span class="kobospan" id="kobo.579.2">We will use this class to test our </span><strong class="source-inline1"><span class="kobospan" id="kobo.580.1">PetListItem</span></strong><span class="kobospan" id="kobo.581.1"> composable. </span><span class="kobospan" id="kobo.581.2">Inside this class, we have created a rule called </span><strong class="source-inline1"><span class="kobospan" id="kobo.582.1">composeTestRule</span></strong><span class="kobospan" id="kobo.583.1">. </span><span class="kobospan" id="kobo.583.2">This rule will be used to create our com</span><a id="_idTextAnchor171" class="calibre3 pcalibre pcalibre1"/><span class="kobospan" id="kobo.584.1">posables. </span><span class="kobospan" id="kobo.584.2">Through this rule, we can set Compose </span><a id="_idIndexMarker636" class="calibre3 pcalibre pcalibre1"/><span class="kobospan" id="kobo.585.1">content or access </span><span><span class="kobospan" id="kobo.586.1">our activity.</span></span></li>
<li class="calibre15"><span class="kobospan" id="kobo.587.1">We have the </span><strong class="source-inline1"><span class="kobospan" id="kobo.588.1">testPetListItem()</span></strong><span class="kobospan" id="kobo.589.1"> function, which is annotated with the </span><strong class="source-inline1"><span class="kobospan" id="kobo.590.1">@Test</span></strong><span class="kobospan" id="kobo.591.1"> annotation. </span><span class="kobospan" id="kobo.591.2">Several</span><a id="_idIndexMarker637" class="calibre3 pcalibre pcalibre1"/><span class="kobospan" id="kobo.592.1"> things are happeni</span><a id="_idTextAnchor172" class="calibre3 pcalibre pcalibre1"/><span class="kobospan" id="kobo.593.1">ng in </span><span><span class="kobospan" id="kobo.594.1">this function:</span></span><ul class="calibre17"><li class="calibre15"><span class="kobospan" id="kobo.595.1">We have used the </span><strong class="source-inline1"><span class="kobospan" id="kobo.596.1">with</span></strong><span class="kobospan" id="kobo.597.1"> scoping function to be able to use </span><strong class="source-inline1"><span class="kobospan" id="kobo.598.1">composeTestRule</span></strong><span class="kobospan" id="kobo.599.1">. </span><span class="kobospan" id="kobo.599.2">We then set the content of our composable. </span><span class="kobospan" id="kobo.599.3">In this case, it is the </span><strong class="source-inline1"><span class="kobospan" id="kobo.600.1">PetListItem</span></strong><span class="kobospan" id="kobo.601.1"> composable that we want to test. </span><span class="kobospan" id="kobo.601.2">We pass a </span><strong class="source-inline1"><span class="kobospan" id="kobo.602.1">cat</span></strong><span class="kobospan" id="kobo.603.1"> object to </span><span><span class="kobospan" id="kobo.604.1">our composable.</span></span></li><li class="calibre15"><span class="kobospan" id="kobo.605.1">We are using the </span><strong class="source-inline1"><span class="kobospan" id="kobo.606.1">onNodeWithTag()</span></strong><span class="kobospan" id="kobo.607.1"> function to find our composables. </span><span class="kobospan" id="kobo.607.2">We then use the </span><strong class="source-inline1"><span class="kobospan" id="kobo.608.1">assertExists()</span></strong><span class="kobospan" id="kobo.609.1"> function to assert that the composables exist. </span><span class="kobospan" id="kobo.609.2">This will find our composables using the tags that we </span><span><span class="kobospan" id="kobo.610.1">added earlier.</span></span></li><li class="calibre15"><span class="kobospan" id="kobo.611.1">We are using the </span><strong class="source-inline1"><span class="kobospan" id="kobo.612.1">onNodeWithText()</span></strong><span class="kobospan" id="kobo.613.1"> function to find our composables. </span><span class="kobospan" id="kobo.613.2">We then use the </span><strong class="source-inline1"><span class="kobospan" id="kobo.614.1">assertIsDisplayed()</span></strong><span class="kobospan" id="kobo.615.1"> function to assert that the composables exist. </span><span class="kobospan" id="kobo.615.2">We have also used the </span><strong class="source-inline1"><span class="kobospan" id="kobo.616.1">onNodeWithContentDescription()</span></strong><span class="kobospan" id="kobo.617.1"> function to find our composables. </span><span class="kobospan" id="kobo.617.2">These two functions help us find composables whose text or content description matches the text or content description that we pass to </span><span><span class="kobospan" id="kobo.618.1">the function.</span></span></li><li class="calibre15"><span class="kobospan" id="kobo.619.1">Lastly, we are using the </span><strong class="source-inline1"><span class="kobospan" id="kobo.620.1">performClick()</span></strong><span class="kobospan" id="kobo.621.1"> function to perform an action on our composables. </span><span class="kobospan" id="kobo.621.2">In this case, we are performing a click action on our </span><span><strong class="source-inline1"><span class="kobospan" id="kobo.622.1">PetListItemFavoriteIcon</span></strong></span><span><span class="kobospan" id="kobo.623.1"> composable.</span></span></li></ul></li>
</ul>
<p class="calibre4"><span class="kobospan" id="kobo.624.1">Click on the green </span><em class="italic"><span class="kobospan" id="kobo.625.1">run</span></em><span class="kobospan" id="kobo.626.1"> icon next to our test class to run our tests. </span><span class="kobospan" id="kobo.626.2">We should see the following output in the </span><span><strong class="bold"><span class="kobospan" id="kobo.627.1">Run</span></strong></span><span><span class="kobospan" id="kobo.628.1"> window:</span></span></p>
<div class="calibre2">
<div class="img---figure" id="_idContainer174">
<span class="kobospan" id="kobo.629.1"><img alt="Figure 12.9 – Jetpack Compose UI tests" src="image/B19779_12_09.jpg" class="calibre5"/></span>
</div>
</div>
<p class="img---caption" lang="en-US" xml:lang="en-US"><span class="kobospan" id="kobo.630.1">Figure 12.9 – Jetpack Compose UI tests</span></p>
<p class="calibre4"><span class="kobospan" id="kobo.631.1">Our test runs successfully. </span><span class="kobospan" id="kobo.631.2">Additionally, the test is also run on the device that we are working on. </span><span class="kobospan" id="kobo.631.3">We are also able to see the </span><a id="_idIndexMarker638" class="calibre3 pcalibre pcalibre1"/><span class="kobospan" id="kobo.632.1">components being displayed and actions </span><span><span class="kobospan" id="kobo.633.1">being performed.</span></span></p>
<p class="calibre4"><span class="kobospan" id="kobo.634.1">We have seen how to write </span><a id="_idIndexMarker639" class="calibre3 pcalibre pcalibre1"/><span class="kobospan" id="kobo.635.1">UI tests in Jetpack Compose. </span><span class="kobospan" id="kobo.635.2">To learn more about testing in Jetpack Compose, check out the official documentation (</span><a href="https://developer.android.com/jetpack/compose/testing" class="calibre3 pcalibre pcalibre1"><span class="kobospan" id="kobo.636.1">https://developer.android.com/jetpack/compose/testing</span></a><span class="kobospan" id="kobo.637.1">). </span><span class="kobospan" id="kobo.637.2">With the knowledge that we have gained in this chapter, we can add more tests to the different layers of our app. </span><span class="kobospan" id="kobo.637.3">You can try adding more tests to test </span><span><span class="kobospan" id="kobo.638.1">your knowledge.</span></span></p>
<h1 id="_idParaDest-148" class="calibre6"><a id="_idTextAnchor173" class="calibre3 pcalibre pcalibre1"/><span class="kobospan" id="kobo.639.1">Summary</span></h1>
<p class="calibre4"><span class="kobospan" id="kobo.640.1">In this chapter, we have learned how to add tests for the different layers in our MVVM architecture. </span><span class="kobospan" id="kobo.640.2">We have learned about the importance of adding tests to our apps and how to add unit tests, integration tests, and </span><span><span class="kobospan" id="kobo.641.1">instrumentation tests.</span></span></p>
<p class="calibre4"><span class="kobospan" id="kobo.642.1">In the next chapter, we will learn step-by-step how to publish a new app in the Google Play Store. </span><span class="kobospan" id="kobo.642.2">We will walk through how to create a signed app bundle and the things required for us to publish our first app to the Play Store. </span><span class="kobospan" id="kobo.642.3">Additionally, we will learn about some of the Google Play Store policies and how to always stay compliant to avoid our apps from being removed or accounts from </span><span><span class="kobospan" id="kobo.643.1">being banned.</span></span></p>
</div>
</body></html>