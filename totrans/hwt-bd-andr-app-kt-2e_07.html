<html><head></head><body>
		<div><h1 id="_idParaDest-121" class="chapter number"><a id="_idTextAnchor421"/><a id="_idTextAnchor422"/><a id="_idTextAnchor423"/><a id="_idTextAnchor424"/><a id="_idTextAnchor425"/>7</h1>
			<h1 id="_idParaDest-122"><a id="_idTextAnchor426"/>Android Permissions and Google Maps</h1>
			<p><a id="_idTextAnchor427"/>This chapter will teach you how to request and obtain app permissions in Android. You will gain a solid understanding of how to include local and global interactive maps in your app by using the Google Maps API and how to request permissions to use device features that provide richer functionality.</p>
			<p>By the end of the chapter, you will be able to create permission requests for your app and handle missing permissions.</p>
			<p><a id="_idTextAnchor428"/>In the previous chapter, we learned how to present data in lists using <code>RecyclerView</code>. Then, we used that knowledge to present the user with a list of secret cat agents. In this chapter, we will learn how to find the user’s location on the map and how to deploy cat agents to the field by selecting locations on the map.</p>
			<p>First, we will explore the Android permissions system. Many Android features are not immediately available to us. These features are gated behind a permission system to protect the user. For us to access those features, we must ask the user to allow us to do so. Some such features include but are not limited to obtaining the user’s location, accessing the user’s contacts, accessing their camera, and establishing a Bluetooth connection. Different Android versions enforce different permission rules.</p>
			<p class="callout heading">Note</p>
			<p class="callout">When Android 6 (Marshmallow) was introduced in 2015, for example, several permissions you could silently obtain on installation were deemed insecure and became runtime permissions, requiring explicit user consent.</p>
			<p>We will then look at the Google Maps API. This API allows us to present the user with a map of any desired location in the world. We will add data to that map and let the user interact with the map. The API also lets you show points of interest and render a street view of supported locations, though we will not explore these features in this book.</p>
			<p>We will cover the following topics in this chapter:</p>
			<ul>
				<li>Requesting permission from the user</li>
				<li>Showing a map of the user’s location</li>
				<li>Map clicks and custom markers</li>
			</ul>
			<h1 id="_idParaDest-123"><a id="_idTextAnchor429"/><a id="_idTextAnchor430"/>Technical requirements</h1>
			<p>The complete code for all the exercises and the activity in this chapter is available on GitHub at <a href="https://packt.link/6ShZd">https://packt.link/6ShZd</a></p>
			<h1 id="_idParaDest-124"><a id="_idTextAnchor431"/>Requesting permission from the user</h1>
			<p>Our app might <a id="_idIndexMarker619"/>want to implement certain features that <a id="_idIndexMarker620"/>Google deems dangerous. This usually means access to those features could risk the user’s privacy. For example, some permissions may allow you to read users’ messages or determine their current location.</p>
			<p>Depending on the required permission and the target Android API level we are developing, we may need to request that permission from the user. If the device is running on Android 6 (Marshmallow, API level 23), and the target API of our app is 23 or higher (it almost certainly will be, as most devices by now will run newer versions of Android), there will be no alert for the user about any permissions requested by the app at install time. Instead, our app must ask the user to grant those permissions at runtime.</p>
			<p>When we request permission, the user sees a dialog like the one shown in <em class="italic">Figure 7</em><em class="italic">.1</em>.<a id="_idTextAnchor432"/></p>
			<div><div><img src="img/B19411_07_01.jpg" alt="Figure 7.1 – Permission dialog for device location access"/>
				</div>
			</div>
			<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 7.1 – Permission dialog for device location access</p>
			<p class="callout heading">Note</p>
			<p class="callout">For a full list of permissions and their protection level, see here: <a href="https://developer.android.com/reference/android/Manifest.permission">https://developer.android.com/reference/android/Manifest.permission</a>.</p>
			<p>We must include permissions in our manifest file when we intend to use them. A manifest with the <code>SEND_SMS</code> permission would look something like the following snippet:</p>
			<pre class="source code">
&lt;manifest xmlns:android=
    "http://schemas.android.com/apk/res/android"
  package="com.example.snazzyapp"&gt;
<strong class="bold">  </strong><strong class="bold">&lt;uses-permission android:name="android.permission.SEND_SMS" /&gt;</strong>
  &lt;application …&gt; ... &lt;/application&gt;
&lt;/manifest&gt;</pre>
			<p>Safe permissions (or normal permissions, as Google calls them) would be automatically granted to <a id="_idIndexMarker621"/>the<a id="_idIndexMarker622"/> user. However, dangerous ones would only be granted if explicitly approved by the user. If we fail to request permission from the user and try to execute an action that requires that permission, the result would be the action not running at best and our app crashing at worst.</p>
			<p>We should first check whether the user has already granted us that permission before asking the user for permission. If the user has not yet granted us permission, we may need to check whether a rationale dialog should be shown prior to the permission request. This depends on how obvious the justification for the request would be to the user.</p>
			<p>For example, if a camera app requests permission to access the camera, we can safely assume the reason would be clear to the user. However, some cases may not be as clear to the user, especially if the user is not tech-savvy. In those cases, we may have to justify the request to the user.</p>
			<p>Google provides us with a function called <code>shouldShowRequestPermissionRationale(Activity, String)</code> for this purpose. Under the hood, this function checks whether the user has previously denied the permission but also whether the user has denied us permission before.</p>
			<p>The idea is to allow us to justify our request to the user for permission before requesting it, thus increasing the likelihood of them approving the request. Once we determine whether the app should present the user with our rationale or whether no rationale was required, we can proceed to request the permission.</p>
			<p>Let’s see how we can request permission. First, we must include the Jetpack Activity and Fragment dependencies in our app <code>gradle</code> file:</p>
			<pre class="source code">
implementation "androidx.activity:activity-ktx:1.6.1"
implementation "androidx.fragment:fragment-ktx:1.5.5"</pre>
			<p>This will provide us with <code>ActivityResultLauncher</code>, which we will use to launch the permission request dialog and handle the user’s response.</p>
			<p>The following is <a id="_idIndexMarker623"/>an <a id="_idIndexMarker624"/>example of an <code>Activity</code> class requesting the <code>Location</code> permission:</p>
			<pre class="source code">
class MainActivity : AppCompatActivity() {
  private lateinit var requestPermissionLauncher:
    ActivityResultLauncher&lt;String&gt;
  override fun onCreate() {
    ...
    requestPermissionLauncher = registerForActivityResult(
      RequestPermission()) { isGranted -&gt;
        if (isGranted) {... } else { ... }    }</pre>
			<p>When <code>Activity</code> is created, we register the launcher to handle permission request responses. We keep a reference to the result for later use. When <code>Activity</code> is resumed, we check the status of the permission and continue accordingly:</p>
			<pre class="source code">
override fun onResume() {
  ...
  when {
    hasLocationPermission() -&gt; getLastLocation()
    shouldShowRequestPermissionRationale(this, 
    ACCESS_FINE_LOCATION) -&gt; {
      showPermissionRationale {
        requestPermissionLauncher
          .launch(ACCESS_FINE_LOCATION)
      }
    }
    else -&gt; requestPermissionLauncher.
              launch(ACCESS_FINE_LOCATION)
  }
}</pre>
			<p>We start by <a id="_idIndexMarker625"/>checking <a id="_idIndexMarker626"/>the location permission (<code>ACCESS_FINE_LOCATION</code>) by calling <code>getHas</code><strong class="source inline">
</strong><code>LocationPermissions()</code>:</p>
			<pre class="source code">
private fun hasLocationPermission() =
  checkSelfPermission(this, Manifest.permission.ACCESS_FINE_
  LOCATION) == PERMISSION_G<a id="_idTextAnchor433"/>RANTED</pre>
			<p>This function checks whether the user has granted us the requested permissions by calling <code>checkSelfPermission(Context, String)</code> with the requested permission.</p>
			<p>If the user hasn’t granted us permission, we call <code>shouldShowRequestPermission</code><strong class="source inline">
Rationale(Activity, String)</strong>, which we mentioned earlier, to check whether a rationale dialog should be presented to the user.</p>
			<p>If showing our rationale is needed, we call <code>showPermissionRationale(() -&gt; Unit)</code>, passing in a lambda that will use <code>requestPermissionLauncher</code> to launch the request dialog after the user dismisses our rationale dialog using the positive button. If no rationale is needed, we launch the dialog with <code>requestPermissionLauncher</code> directly. The following code is for presenting the rationale dialog:</p>
			<pre class="source code">
private fun showPermissionRationale(
  positiveAction: () -&gt; Unit) {
  AlertDialog.Builder(this)
    .setTitle("Location permission")
    .setMessage("We need your permission to find your current 
        position")
    .setPositiveButton(android.R.string.ok) { _, _ -&gt;
        positiveAction()
    }
    .setNegativeButton(android.R.string.cancel) { dialog, _ -&gt; 
        dialog.dismiss() }
    .create().show()
}</pre>
			<p>Our <code>showPermissionRationale</code> function presents the user with a dialog with a brief explanation of why we need their permission. The <strong class="bold">OK</strong> button will execute the positive <a id="_idIndexMarker627"/>action<a id="_idIndexMarker628"/> provided, and the <strong class="bold">Cancel</strong> one will dismiss the <a id="_idTextAnchor434"/>dialog:</p>
			<div><div><img src="img/B19411_07_02.jpg" alt="Figure 7.2 – Rationale dialog"/>
				</div>
			</div>
			<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 7.2 – Rationale dialog</p>
			<p>Lastly, we request permission by calling <code>requestPermissionLauncher.launch(ACCESS_FINE_LOCATION)</code> using the request permission launcher we declared earlier.</p>
			<p>If we’ve requested the location permission from the user, the response will be processed by the request permission launcher depending on the value returned via <code>isGranted</code>, as shown in the following code:</p>
			<pre class="source code">
registerForActivityResult(RequestPermission()) { isGranted -&gt;
  if (isGranted) { getLastLocation() }
  else {
    showPermissionRationale { requestPermissionLauncher
      .launch(ACCESS_FINE_LOCATION) }
  }
}</pre>
			<p>This code is the expansion of the code we observed earlier, added to the <code>onCreate</code> function of <code>Activity</code>. This chapter will take us through the development of an app that shows <a id="_idIndexMarker629"/>us<a id="_idIndexMarker630"/> our current location on a map and allows us to place a marker where we want to deploy our secret cat agent.</p>
			<p>Let’s start with our first <a id="_idTextAnchor435"/><a id="_idTextAnchor436"/>exercise.</p>
			<h2 id="_idParaDest-125"><a id="_idTextAnchor437"/>Exercise 7.01 – requesting the location permission</h2>
			<p>In this <a id="_idIndexMarker631"/>exercise, we will request that the user provide<a id="_idIndexMarker632"/> the location permission. We will first create a <strong class="bold">Google Maps Activity</strong> project. Then, we will define the permission required in the manifest file. To get started, let’s implement the code required to request permission from the user to access their location:</p>
			<ol>
				<li>Start by creating a new Google Maps Activity project (<strong class="bold">File</strong> | <strong class="bold">New</strong> | <strong class="bold">New Project</strong> | <strong class="bold">Google Maps Activity</strong>). We’re not using Google Maps in this exercise. However, the Google Maps Activity is still a good choice in this case. It will save you a lot of boilerplate coding in the next exercise (<em class="italic">Exercise 7.02</em>). Don’t worry; it will have no impact on your current exercise. Click <strong class="bold">Next</strong>, as shown in the following s<a id="_idTextAnchor438"/>creenshot:</li>
			</ol>
			<div><div><img src="img/B19411_07_03.jpg" alt="Figure 7.3 – Choose your project"/>
				</div>
			</div>
			<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 7.3 – Choose your project</p>
			<ol>
				<li value="2">Name <a id="_idIndexMarker633"/>your<a id="_idIndexMarker634"/> application <code>Cat </code><code>Agent Deployer</code>.</li>
				<li>Make sure your package name is <code>com.example.catagentdeployer</code>.</li>
				<li>Set the save location to where you want to save your project.</li>
				<li>Leave everything else at its default values and click <strong class="bold">Finish</strong>.</li>
				<li>Make sure you are on the <strong class="bold">Android</strong> view in your <strong class="bold">Pr<a id="_idTextAnchor439"/>oject</strong> pane:</li>
			</ol>
			<div><div><img src="img/B19411_07_04.jpg" alt="Figure 7.4 – The Android view"/>
				</div>
			</div>
			<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 7.4 – The Android view</p>
			<ol>
				<li value="7">Open your <code>AndroidManifest.xml</code> file. Make sure the location permission was<a id="_idIndexMarker635"/> already <a id="_idIndexMarker636"/>added to your app:<pre class="source code">
&lt;manifest ...&gt;
    <strong class="bold">&lt;uses-permission android:name=</strong>
<strong class="bold">        "android.permission.ACCESS_FINE_LOCATION" /&gt;</strong>
    &lt;application ...&gt; ... &lt;/application&gt;
&lt;/manifest&gt;</pre></li>
			</ol>
			<p class="callout heading">Note</p>
			<p class="callout"><code>ACCESS_FINE_LOCATION</code> is the permission you will need to obtain the user’s location based on GPS in addition to the less accurate Wi-Fi and mobile data-based location information you could obtain by using the <code>ACCESS_COARSE_LOCATION</code> permission.</p>
			<ol>
				<li value="8">Open your <code>MapsActivity.kt</code> file. At the bottom of the <code>MapsActivity</code> class block, add an empty <code>getLastLocation()</code> function:<pre class="source code">
class MapsActivity : ... {
  ...
  <strong class="bold">private fun getLastLocation() {</strong>
<strong class="bold">    Log.d("MapsActivity", "getLastLocation() called.")</strong>
  <strong class="bold">}</strong>
}</pre></li>
			</ol>
			<p>This will be the function you will call when you have ensured the user has granted you the location permission.</p>
			<ol>
				<li value="9">Next, add the request permission launcher to the top of the <code>MapsActivity</code> class:<pre class="source code">
class MapsActivity : ... {
    private lateinit var requestPermissionLauncher:
        ActivityResultLauncher&lt;String&gt;</pre></li>
			</ol>
			<p>This is the variable through which we will launch the permission request and track user responses.</p>
			<p>Now navigate to the bottom of the <code>onCreate()</code> function and register for activity <a id="_idIndexMarker637"/>results, storing<a id="_idIndexMarker638"/> the result in <code>requestPermissionLauncher</code>, which you declared in the previous step:</p>
			<pre class="source code">
override fun onCreate(savedInstanceState: Bundle?) {
  ...
  requestPermissionLauncher =
    registerForActivityResult(RequestPermission()) { 
    isGranted -&gt;
      if (isGranted) { getLastLocation() }
      else {
        showPermissionRationale {
          requestPermissionLauncher
            .launch(ACCESS_FINE_LOCATION)
        }
      }
    }
}</pre>
			<ol>
				<li value="10">To present users with the rationale for the permission request, implement the <code>show</code><strong class="source inline">
PermissionRationale(() -&gt; Unit)</strong> function right before the <code>getLast</code><strong class="source inline">
</strong><code>Location()</code> function:<pre class="source code">
private fun showPermissionRationale(positiveAction: ()
-&gt; Unit) {
  AlertDialog.Builder(this)
    .setTitle("Location permission")
    .setMessage("This app will not work without knowing 
        your current location")
    .setPositiveButton(android.R.string.ok) { _, _ -&gt;
        positiveAction() }
    .setNegativeButton(android.R.string.cancel) { dialog, 
        _ -&gt; dialog.dismiss() }
    .create().show()
}</pre></li>
			</ol>
			<p>This function<a id="_idIndexMarker639"/> will<a id="_idIndexMarker640"/> present the user with a simple alert dialog explaining that the app will not work without knowing their current location, as shown in <em class="italic">Figure 7</em><em class="italic">.1</em>. Tapping <code>positiveAction</code> lambda. Tapping <strong class="bold">CANCEL</strong> will dismiss the dialog.</p>
			<ol>
				<li value="11">To determine whether or not your app already has the location permission, introduce the following <code>hasLocationPermission()</code> function right before the <code>requestPermissionWithRationaleIfNeeded()</code> function:<pre class="source code">
private fun hasLocationPermission() =
    ContextCompat.checkSelfPermission(
        this, Manifest.permission.ACCESS_FINE_LOCATION
    ) == PackageManager.PERMISSION_GRANTED</pre></li>
				<li>Finally, update the <code>onMapReady()</code> function of your <code>MapsActivity</code> class to determine the permission status and proceed accordingly:<pre class="source code">
override fun onMapReady(googleMap: GoogleMap) {
  mMap = googleMap
  when {
    hasLocationPermission() -&gt; getLastLocation()
    shouldShowRequestPermissionRationale(this,
      ACCESS_FINE_LOCATION) -&gt; {
      showPermissionRationale {
        requestPermissionLauncher
          .launch(ACCESS_FINE_LOCATION)
      }
    }
    else -&gt; requestPermissionLauncher
      .launch(ACCESS_FINE_LOCATION)
  }
}</pre></li>
			</ol>
			<p>The <code>when</code> statement <a id="_idIndexMarker641"/>will check whether the <a id="_idIndexMarker642"/>permission was already granted. If not, it will check whether a rationale dialog should be presented. Then, if the rationale is accepted by the user or no rationale dialog is required, it will present a standard permission request dialog to the user (as shown in <em class="italic">Figure 7</em><em class="italic">.1</em>), asking them to allow the app to access their location. You pass the requested permission you want the user to grant your app (<code>Manifest.permission.ACCESS_FINE_LOCATION</code>).</p>
			<ol>
				<li value="13">Run your app. You should now see a system permission dialog requesting you to allow the app to access the location of the device, as sh<a id="_idTextAnchor440"/>own in <em class="italic">Figure 7</em><em class="italic">.5</em>.</li>
			</ol>
			<div><div><img src="img/B19411_07_05.jpg" alt="Figure 7.5 – App requesting the location permission"/>
				</div>
			</div>
			<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 7.5 – App requesting the location permission</p>
			<p>If the user denies<a id="_idIndexMarker643"/> the<a id="_idIndexMarker644"/> permission, the rationale dialog will appear. If the rationale is accepted, the system permission dialog will show again. Up until SDK 31, the user had the option to choose not to let the app ask for permission again (<em class="italic">Figure 7</em><em class="italic">.6</em>). From SDK 31 onwards, not asking a third time is the default. Allowing it afterwards requires using th<a id="_idTextAnchor441"/>e device settings.</p>
			<div><div><img src="img/B19411_07_06.jpg" alt="Figure 7.6 – The Don’t ask again message"/>
				</div>
			</div>
			<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 7.6 – The Don’t ask again message</p>
			<p>Once the user has allowed or permanently denied the permission, the dialog will never show again. To reset the state of your app permissions, you would have to manually grant <a id="_idIndexMarker645"/>it<a id="_idIndexMarker646"/> permission via the <strong class="bold">App </strong><strong class="bold">Info</strong> interface.</p>
			<p>Now that we can get the location permission, we will now look into obtaining the use<a id="_idTextAnchor442"/><a id="_idTextAnchor443"/>r’s current location.</p>
			<h1 id="_idParaDest-126"><a id="_idTextAnchor444"/>Showing a map of the user’s location</h1>
			<p>Having successfully<a id="_idIndexMarker647"/> obtained permission from the user to access their location, we can now ask the user’s device to provide us with its last known location. This is also usually the user’s current location. We will then use this location to present the user with a map of their current location.</p>
			<p>To obtain the user’s last known location, Google has provided us with the Google Play Location service and, more specifically, with the <code>FusedLocationProviderClient</code> class. The <code>FusedLocationProviderClient</code> class helps us interact with Google’s Fused Location Provider API, which is a location API that intelligently combines different signals from multiple device sensors to provide us with device location information.</p>
			<p>To access the <code>FusedLocationProviderClient</code> class, we must first include the Google Play Location service library in our project. This simply means adding the following code snippet to the <code>dependencies</code> block of our <code>build.gradle</code> app:</p>
			<pre class="source code">
implementation "com.google.android.gms:play-services-location:21.0.1"</pre>
			<p>With the location service imported, we can now obtain an instance of the <code>FusedLocation</code><strong class="source inline">
ProviderClient</strong> class by calling <code>LocationServices.getFusedLocationProvider</code><strong class="source inline">
</strong><code>Client(this@MainActivity)</code>.</p>
			<p>Once we have a fused location client, we can obtain the user’s last location by calling <code>fused</code><strong class="source inline">
</strong><code>LocationClient.lastLocation</code>.</p>
			<p class="callout heading">Note</p>
			<p class="callout">This is given that we have already received the location permission from the user.</p>
			<p>Since this is an asynchronous call, we should also provide a success listener as a minimum. If we wanted to, we could also add listeners for cancellation, failure, and the completion of requests. Calling <code>lastLocation</code> returns <code>Task&lt;Location&gt;</code>. <code>Task</code> is a Google API abstract class whose implementations perform async operations.</p>
			<p>In this case, that operation is returning a location. So, adding listeners is simply a matter of chaining calls. We will add the following code snippet to our call:</p>
			<pre class="source code">
.addOnSuccessListener { location: Location? -&gt; }</pre>
			<p>Note that the <code>location</code> parameter could be <code>null</code> if the client fails to obtain the user’s current location. This is not very common but could happen if, for example, the user disabled their location services during the call.</p>
			<p>Once the code inside our success listener block is executed, and <code>location</code> is not <code>null</code>, we have the<a id="_idIndexMarker648"/> user’s current location in the form of a <code>Location</code> instance.</p>
			<p>A <code>Location</code> instance holds a single coordinate on Earth, expressed using longitude and latitude.</p>
			<p class="callout heading">Note</p>
			<p class="callout">For our purpose, it is sufficient to know that each point on the surface of the Earth is mapped to a single pair of <strong class="bold">longitude</strong> (<strong class="bold">Lng</strong>) and <strong class="bold">latitude</strong> (<strong class="bold">Lat</strong>) values.</p>
			<p>This is where it gets exciting. Google lets us present any location on an interactive map by using a <code>SupportMapFragment</code> class. All it takes is to sign up for a free API key. When you create your application with a Google Maps Activity, Android Studio immediately opens the <code>AndroidManifest.xml</code> file. A comment in the file sends us to <a href="https://packt.link/FK58V">https://packt.link/FK58V</a> to obtain the required API key. You can copy that link to your browser or press <em class="italic">Ctrl</em>/<em class="italic">Command</em> + click on it.</p>
			<p>On the page, follow the directions and click <code>YOUR_API_KEY</code> string in the meta tag value with your newly obtained key.</p>
			<p>At this point, if you run your app, you will already see an interactive map on your screen, <a id="_idTextAnchor445"/>as seen in <em class="italic">Figure 7</em><em class="italic">.7</em>.</p>
			<div><div><img src="img/B19411_07_07.jpg" alt="Figure 7.7 – Interactive map"/>
				</div>
			</div>
			<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 7.7 – Interactive map</p>
			<p>To position the map<a id="_idIndexMarker649"/> based on our current location, we create a <code>LatLng</code> instance with the coordinates from our <code>Location</code> instance and call <code>moveCamera(CameraUpdate)</code> on the <code>GoogleMap</code> instance. To satisfy the <code>CameraUpdate</code> requirement, we call <code>CameraUpdateFactory.newLatLng(LatLng)</code>, passing in the <code>LatLng</code> parameter created earlier. The call would look something like this:</p>
			<pre class="source code">
mMap.moveCamera(CameraUpdateFactory.newLatLng(latLng))</pre>
			<p class="callout heading">Note</p>
			<p class="callout">To discover the rest of the available <code>CameraUpdateFactory</code> options, visit <a href="https://packt.link/EBRnt">https://packt.link/EBRnt</a>.</p>
			<p>We could also call <code>newLatLngZoom(LatLng, Float)</code> to modify the zoom-in and zoom-out features of the map.</p>
			<p class="callout heading">Note</p>
			<p class="callout">Valid zoom values range between 2.0 (farthest) and 21.0 (closest). Values outside of that range are capped.</p>
			<p>Some areas may not have tiles to render the closest zoom values.</p>
			<p>We call <code>addMarker(MarkerOptions)</code> on the <code>GoogleMap</code> instance to add a marker at the user’s coordinate. The <code>MarkerOptions</code> parameters are configured by chaining calls to a <code>MarkerOptions()</code> instance. We could call <code>position(LatLng)</code> and <code>title(String)</code> for a simple marker at our desired position. The call would look like the following:</p>
			<pre class="source code">
mMap.addMarker(MarkerOptions().position(latLng)
    .title("Pin Label"))</pre>
			<p>The order in<a id="_idIndexMarker650"/> which we chain the calls does not matter.</p>
			<p>Let’s practice this in<a id="_idTextAnchor446"/><a id="_idTextAnchor447"/> the following exercise.</p>
			<h2 id="_idParaDest-127"><a id="_idTextAnchor448"/>Exercise 7.02 – obtaining the user’s current location</h2>
			<p>Now that your app can be granted location permission, you can use the location permission to get the user’s current location. You will then display the map and update it to zoom into the user’s current location and show a pin at that location. To do this, perform the following steps:</p>
			<ol>
				<li>First, add the Google Play location service to your <code>build.gradle</code> file. You should add it within the <code>dependencies</code> block:<pre class="source code">
dependencies {
<strong class="bold">  implementation "com.google.android.gms: play-services-</strong>
  <strong class="bold">location:21.0.1"</strong>
  ...
}</pre></li>
				<li>Click the <strong class="bold">Sync Project with Gradle Files</strong> button in Android Studio for Gradle to fetch the newly added dependency.</li>
				<li>Obtain an API key: open the <code>AndroidManifest.xml</code> file (<code>app/src/main/AndroidManifest.xml</code>) and <em class="italic">Ctrl</em> / <em class="italic">Cmd</em> + click the link <a href="https://developers.google.com/maps/documentation/android-sdk/get-api-key">https://developers.google.com/maps/documentation/android-sdk/get-api-key</a>.</li>
				<li>Follow the instructions on the website until you have generated a new API key.</li>
				<li>Update your <code>google_maps_api.xml</code> file by replacing <code>YOUR_API_KEY</code> with your <a id="_idIndexMarker651"/>new API key in the following code:<pre class="source code">
&lt;meta-data
android:name="com.google.android.geo.API_KEY"
            android:value="<strong class="bold">YOUR_API_KEY</strong>" /&gt;</pre></li>
				<li>Open your <code>MapsActivity.kt</code> file. At the top of your <code>MapsActivity</code> class, define a lazily initialized fused location provider client:<pre class="source code">
class MapsActivity : ... {
  <strong class="bold">private val fusedLocationProviderClient by lazy {</strong>
    <strong class="bold">LocationServices</strong>
<strong class="bold">      .getFusedLocationProviderClient(this)</strong>
  <strong class="bold">}</strong>
  override fun onCreate(savedInstanceState: Bundle?)
  { ... }
  ...
}</pre></li>
			</ol>
			<p>By making <code>fusedLocationProviderClient</code> initialize lazily, you are ensuring it is only initialized when needed, which essentially guarantees the <code>Activity</code> class will have been created before initialization.</p>
			<ol>
				<li value="7">Introduce an <code>updateMapLocation(LatLng)</code> function and an <code>addMarkerAtLocation(LatLng, String)</code> function immediately after the <code>getLastLocation()</code> function to zoom the map at a given location and add a marker at that location, respectively:<pre class="source code">
private fun updateMapLocation(location: LatLng) {
    mMap.moveCamera(CameraUpdateFactory.newLatLngZoom(
        location, 7f))
}
private fun addMarkerAtLocation(location: LatLng,
title: String) {
    mMap.addMarker(MarkerOptions().title(title)
        .position(location))
}</pre></li>
				<li>Now update <a id="_idIndexMarker652"/>your <code>getLastLocation()</code> function to retrieve the user’s location:<pre class="source code">
private fun getLastLocation() {
<strong class="bold">  fusedLocationProviderClient.lastLocation</strong>
<strong class="bold">    .addOnSuccessListener { location: Location? -&gt;</strong>
<strong class="bold">      </strong><strong class="bold">location?.let {</strong>
<strong class="bold">        val userLocation = LatLng(</strong>
<strong class="bold">          location.latitude, location.longitude)</strong>
<strong class="bold">        updateMapLocation(userLocation)</strong>
<strong class="bold">        addMarkerAtLocation(userLocation, "You")</strong>
<strong class="bold">     }</strong>
<strong class="bold">  }</strong>
}</pre></li>
			</ol>
			<p>Your code requests the last location by calling <code>lastLocation</code> and then attaches a <code>lambda</code> function as an <code>OnSuccessListener</code> interface. Once a location is obtained, the <code>lambda</code> function is executed, updating the map location. The code then adds a marker at that location with the <code>You</code> title if a non-null location was returned.</p>
			<ol>
				<li value="9">Run your<a id="_idIndexMarker653"/> app. It sh<a id="_idTextAnchor449"/>ould look like <em class="italic">Figure 7</em><em class="italic">.8</em>.</li>
			</ol>
			<div><div><img src="img/B19411_07_08.jpg" alt="Figure 7.8 – Interactive map with a marker at the current location"/>
				</div>
			</div>
			<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 7.8 – Interactive map with a marker at the current location</p>
			<p>Once the app has been granted permission, it can request the user’s last location from the Google Play location service via the fused location provider client. This gives you an easy and concise way to fetch the user’s current location. Remember to turn on the location on your device for the app to work.</p>
			<p>With the user’s location, your app can tell the map where to zoom and where to place a marker. If the <a id="_idIndexMarker654"/>user clicks on the marker, they will see the title you assigned to it (<code>You</code> in the exercise).</p>
			<p>In the next section, we will learn how to respond to clicks on the m<a id="_idTextAnchor450"/><a id="_idTextAnchor451"/>ap and how to move markers.</p>
			<h1 id="_idParaDest-128"><a id="_idTextAnchor452"/>Map clicks and custom markers</h1>
			<p>With a map <a id="_idIndexMarker655"/>showing<a id="_idIndexMarker656"/> the user’s current location by zooming in at the right location and placing a marker there, we have a rudimentary knowledge of how to render the desired map and how to obtain the required permissions and the user’s current location.</p>
			<p>In this section, we will learn how to respond to a user interacting with the map and how to use markers more extensively. We will learn how to move markers on the map and replace the default pin marker with custom icons. When we know how to let the user place a marker anywhere on the map, we can let them choose where to deploy the secret cat agent.</p>
			<p>We need to add a listener to the <code>GoogleMap</code> instance to listen for clicks on the map. Looking at our <code>MapsActivity.kt</code> file, the best place to do so would be in <code>onMapReady(GoogleMap)</code>. A naïve implementation might look like this:</p>
			<pre class="source code">
override fun onMapReady(googleMap: GoogleMap) {
    mMap = googleMap.apply {
        setOnMapClickListener { latLng -&gt;
            addMarkerAtLocation(latLng, "Deploy here")
        }
    }
    ...
}</pre>
			<p>However, if we ran this code, we’d find that a new marker is added for every click on the map. This is not our desired behavior.</p>
			<p>To control a marker on the map, we need to keep a reference to that marker. That is achieved easily enough by keeping a reference to the output of <code>GoogleMap.addMarker(MarkerOptions)</code>. The <code>addMarker</code> function returns a <code>Marker</code> instance. To move a marker on the map, we assign a new position value to it by calling its <code>position</code> setter.</p>
			<p>To replace the default pin icon with a custom icon, we must provide a <code>BitmapDescriptor</code> to the marker or the <code>MarkerOptions()</code> instance. The <code>BitmapDescriptor</code> wrappers work around bitmaps used by <code>GoogleMap</code> to render markers and ground overlays, but we won’t cover that in this book.</p>
			<p>We obtain <code>BitmapDescriptor</code> by using <code>BitmapDescriptorFactory</code>. The factory will<a id="_idIndexMarker657"/> require <a id="_idIndexMarker658"/>an asset, which can be provided in a few ways. You can provide it with the name of a bitmap in the <code>assets</code> directory, a <code>Bitmap</code>, a filename of a file in the internal storage, or a resource ID.</p>
			<p>The factory can also create default markers of different colors. We are interested in the <code>Bitmap</code> option because we intend to use a vector drawable, and the factory does not directly support those. In addition, when converting the drawable to a <code>Bitmap</code>, we can manipulate it to suit our needs (for example, we could change its color).</p>
			<p>Android Studio offers us quite a wide range of free vector <code>Drawables</code> out of the box. For this example, we want the <code>paw</code> drawable. To do this, right-click anywhere in the left Android pane, and select <strong class="bold">New</strong> | <strong class="bold">Vector Asset</strong>.</p>
			<p>Now, click the Android icon next to the <strong class="bold">Clip Art</strong> label for the l<a id="_idTextAnchor453"/>ist of icons (see <em class="italic">Figure 7</em><em class="italic">.9</em>):</p>
			<div><div><img src="img/B19411_07_09.jpg" alt="Figure 7.9 – Asset Studio"/>
				</div>
			</div>
			<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 7.9 – Asset Studio</p>
			<p>We’ll now<a id="_idIndexMarker659"/> access<a id="_idIndexMarker660"/> a window to choose from the offered <a id="_idTextAnchor454"/>pool of clip art (<em class="italic">Figure 7</em><em class="italic">.10</em>):</p>
			<div><div><img src="img/B19411_07_010.jpg" alt="Figure 7.10 – Selecting an icon"/>
				</div>
			</div>
			<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 7.10 – Selecting an icon</p>
			<p>Once we choose an icon, we can name it, and it will be created for us as a vector drawable XML file. We will name it <code>target_icon</code>.</p>
			<p>To use the created asset, we must first get it as a <code>Drawable</code> instance. This is done by calling <code>Context</code><strong class="source inline">
Compat.getDrawable(Context, Int)</strong>, passing in the activity and <code>R.drawable.target_icon</code> as a reference to our asset. Next, we need to define bounds for the <code>Drawable</code> instance to draw in.</p>
			<p>Calling <code>Drawable.setBound(Int, Int, Int, Int)</code> with (<code>0</code>, <code>0</code>, <code>drawable.intrinsic</code><strong class="source inline">
Width</strong>, <code>drawable.intrinsicHeight</code>) will tell the drawable to draw within its intrinsic size.</p>
			<p>To change the color of our icon, we can tint it. To tint a <code>Drawable</code> instance in a way that is <a id="_idIndexMarker661"/>supported <a id="_idIndexMarker662"/>by devices running APIs older than <code>21</code>, we must first wrap our <code>Drawable</code> instance with <code>DrawableCompat</code> by calling <code>DrawableCompat.wrap(Drawable)</code>. The returned <code>Drawable</code> can then be tinted using <code>DrawableCompat.setTint(Drawable, Int)</code>.</p>
			<p>Next, we need to create a <code>Bitmap</code> to hold our icon. Its dimensions can match those of the <code>Drawable</code> bounds, and we want its <code>Config</code> to be <code>Bitmap.Config.ARGB_8888</code>.</p>
			<p class="callout heading">Note</p>
			<p class="callout"><code>8</code> indicates the number of bits per channel. <code>ARGB_8888</code> means <a id="_idIndexMarker663"/>we want 8-bit red, green, blue, and alpha channels.</p>
			<p>We then create a <code>Canvas</code> for the <code>Bitmap</code>, allowing us to draw our <code>Drawable</code> instance by calling…you guessed it, <code>Drawable.draw(Canvas)</code>:</p>
			<pre class="source code">
private fun getBitmapDescriptorFromVector(@DrawableRes vectorDrawableResourceId: Int): BitmapDescriptor? {
  val bitmap = ContextCompat.getDrawable(this,
    vectorDrawableResourceId)?.let { vectorDrawable -&gt;
      vectorDrawable.setBounds(0, 0,
        vectorDrawable.intrinsicWidth,
        vectorDrawable.intrinsicHeight)
      val drawableWithTint = DrawableCompat.
        wrap(vectorDrawable)
      DrawableCompat.setTint(drawableWithTint, Color.RED)
      val bitmap = Bitmap.createBitmap(
        vectorDrawable.intrinsicWidth,
        vectorDrawable.intrinsicHeight,
        Bitmap.Config.ARGB_8888
      )
      val canvas = Canvas(bitmap)
      drawableWithTint.draw(canvas)
      bitmap
    }
    return BitmapDescriptorFactory.fromBitmap(bitmap)
      .also { bitmap?.recycle() }
}</pre>
			<p>With the <code>Bitmap</code> containing our icon, we are now ready to obtain a <code>BitmapDescriptor</code> instance from <code>BitmapDescriptorFactory</code>. Don’t forget to recycle your <code>Bitmap</code> afterward. This will avoid a memory leak.</p>
			<p>You have<a id="_idIndexMarker664"/> learned how to present the user with a meaningful <a id="_idIndexMarker665"/>map by centering it on their current location and showing their cur<a id="_idTextAnchor455"/><a id="_idTextAnchor456"/>rent location using a custom marker.</p>
			<h2 id="_idParaDest-129"><a id="_idTextAnchor457"/>Exercise 7.03 – adding a custom marker where the map was clicked</h2>
			<p>In this exercise, you<a id="_idIndexMarker666"/> will respond to a user’s map click by placing a red paw-shaped marker at the location on the map the user clicked:</p>
			<ol>
				<li>In <code>MapsActivity.kt</code> (found under <code>app/src/main/java/com/example/catagentdeployer</code>), right below the definition of the <code>mMap</code> variable, define a nullable <code>Marker</code> variable to hold a reference to the paw marker on the map:<pre class="source code">
private lateinit var mMap: GoogleMap
<strong class="bold">private var marker: Marker? = null</strong></pre></li>
				<li>Update <code>addMarkerAtLocation(LatLng, String)</code> to also accept a nullable <code>BitmapDescriptor</code> with a default value of <code>null</code>:<pre class="source code">
private fun addMarkerAtLocation(
  location: LatLng, title: String<strong class="bold">,</strong>
  <strong class="bold">markerIcon: BitmapDescriptor? = null</strong>
) <strong class="bold">=</strong> mMap.addMarker(
  MarkerOptions().title(title).position(location)
    <strong class="bold">.apply { markerIcon?.let { icon(markerIcon) } }</strong>
)</pre></li>
			</ol>
			<p>If the <code>markerIcon</code> provided<a id="_idIndexMarker667"/> is not null, the app sets it to <code>MarkerOptions</code>. The function now returns the marker it added to the map.</p>
			<ol>
				<li value="3">Create a <code>getBitmapDescriptorFromVector(Int): BitmapDescriptor?</code> function below your <code>addMarkerAtLocation(LatLng, String, BitmapDescriptor?): Marker</code> function to provide <code>BitmapDescriptor</code> given a <code>Drawable</code> resource ID:<pre class="source code">
private fun getBitmapDescriptorFromVector(@DrawableRes vectorDrawableResourceId: Int): BitmapDescriptor? {
  val bitmap = ContextCompat.getDrawable(this,
    vectorDrawableResourceId)?.let { vectorDrawable -&gt;
      vectorDrawable.setBounds(0, 0,
        vectorDrawable.intrinsicWidth,
        vectorDrawable.intrinsicHeight)
      val drawableWithTint = DrawableCompat
        .wrap(vectorDrawable)
      DrawableCompat.setTint(drawableWithTint, Color.RED)
      val bitmap = Bitmap.createBitmap(
        vectorDrawable.intrinsicWidth,
        vectorDrawable.intrinsicHeight,
        Bitmap.Config.ARGB_8888
      )
      val canvas = Canvas(bitmap)
      drawableWithTint.draw(canvas)
      bitmap
    }
  return BitmapDescriptorFactory.fromBitmap(bitmap)
    .also { bitmap?.recycle() }
}</pre></li>
			</ol>
			<p>This function first<a id="_idIndexMarker668"/> obtains a drawable using <code>ContextCompat</code> by passing in the provided resource ID. It then sets the drawing bounds for the drawable, wraps it in <code>DrawableCompat</code>, and sets its tint to red.</p>
			<p>Then, it creates a <code>Bitmap</code> and a <code>Canvas</code> for that <code>Bitmap</code>, upon which it draws the tinted drawable. The bitmap is then returned to be used by <code>BitmapDescriptorFactory</code> to build <code>BitmapDescriptor</code>. Lastly, <code>Bitmap</code> is recycled to avoid a memory leak.</p>
			<ol>
				<li value="4">Before you can use the <code>Drawable</code> instance, you must first create it. Right-click on the Android pane, and then select <strong class="bold">New</strong> | <strong class="bold">Vector Asset</strong>.</li>
				<li>In the window that opens, click on the Android icon next to the <strong class="bold">Clip Art</strong> label to <a id="_idTextAnchor458"/>select a different icon (<em class="italic">Figure 7</em><em class="italic">.11</em>):</li>
			</ol>
			<div><div><img src="img/B19411_07_011.jpg" alt="Figure 7.11 – Asset Studio"/>
				</div>
			</div>
			<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 7.11 – Asset Studio</p>
			<ol>
				<li value="6">From the list <a id="_idIndexMarker669"/>of icons, select the <code>pets</code> into the search field if you can’t find the icon. On<a id="_idTextAnchor459"/>ce you select the <strong class="bold">pets</strong> icon, click <strong class="bold">OK</strong>:</li>
			</ol>
			<div><div><img src="img/B19411_07_012.jpg" alt="Figure 7.12 – Selecting an icon"/>
				</div>
			</div>
			<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 7.12 – Selecting an icon</p>
			<ol>
				<li value="7">Name your icon <code>target_icon</code>. Click <strong class="bold">Next</strong> and <strong class="bold">Finish</strong>.</li>
				<li>Define an <code>addOrMoveSelectedPositionMarker(LatLng)</code> function to create a new marker or move it to the provided location if one has already been created. Add it after the <code>getBitmapDescriptorFromVector(Int)</code> function:<pre class="source code">
private fun addOrMoveSelectedPositionMarker(latLng:
LatLng) {
  if (marker == null) {
    marker = addMarkerAtLocation(latLng,
      "Deploy here", getBitmapDescriptorFromVector(
        R.drawable.target_icon)
    )
  } else { marker?.apply { position = latLng } }
}</pre></li>
				<li>Update <a id="_idIndexMarker670"/>your <code>onMapReady(GoogleMap)</code> function to set an <code>OnMapClickListener</code> event on <code>mMap</code>, which will add a marker to the clicked location or move the existing marker to the clicked location:<pre class="source code">
override fun onMapReady(googleMap: GoogleMap) {
    mMap = googleMap<strong class="bold">.apply {</strong>
        <strong class="bold">setOnMapClickListener { latLng -&gt;</strong>
            <strong class="bold">addOrMoveSelectedPositionMarker(latLng)</strong>
        <strong class="bold">}</strong>
    <strong class="bold">}</strong>
    if (hasLocationPermission()) { ... }
}</pre></li>
			</ol>
			<p>Run your<a id="_idTextAnchor460"/> app. It should look like <em class="italic">Figure 7</em><em class="italic">.13</em>.</p>
			<div><div><img src="img/B19411_07_013.jpg" alt="Figure 7.13 – The complete app"/>
				</div>
			</div>
			<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 7.13 – The complete app</p>
			<p>Clicking anywhere on the map will now move the paw icon to that location. Clicking the paw icon will show the <strong class="bold">Deploy </strong><strong class="bold">here</strong> label.</p>
			<p class="callout heading">Note</p>
			<p class="callout">The location of the paw is a geographical one, not a screen one. That means if you drag your map or zoom in, the paw will move with the map and remain in the same geographical location.</p>
			<p>You now know<a id="_idIndexMarker671"/> how to respond to user clicks on the map and add and move markers around. You also know how <a id="_idTextAnchor461"/><a id="_idTextAnchor462"/>to customize the appearance of markers.</p>
			<h2 id="_idParaDest-130"><a id="_idTextAnchor463"/>Activity 7.01 – creating an app to find the location of a parked car</h2>
			<p>Some people often <a id="_idIndexMarker672"/>forget where it was that they parked their car. Let’s say you want to help these people by developing an app that lets the user store the last place they parked. The app will show a pin at the car’s location when the user launches the app. The user can click an <strong class="bold">I’m parked here</strong> button to update the pin location to the current location the next time they park.</p>
			<p>Your goal in this activity is to develop an app that shows the user a map of the current location. The app must first ask the user for permission to access their location. Make sure to also provide a rationale dialog, if needed, according to the SDK.</p>
			<p>The app will show a car icon where the user last told it the car was. The user can click a button labeled <strong class="bold">I’m parked here</strong> to move the car icon to the current location. When the user relaunches the app, it will show the user’s current location and the car icon where the car was last parked.</p>
			<p>As a bonus feature of your app, you can choose to add functionality that stores the car’s location so that it can be restored after the user has killed and then re-opened the app. This bonus functionality relies on using <code>SharedPreferences</code>; a concept that will be covered in <a href="B19411_10.xhtml#_idTextAnchor512"><em class="italic">Chapter 10</em></a>, <em class="italic">Persisting Data</em>. As such, <em class="italic">steps 9</em> and <em class="italic">10</em> here will give you the required implementation.</p>
			<p>The following<a id="_idIndexMarker673"/> steps will help you complete the activity:</p>
			<ol>
				<li>Create a Google Maps Activity app.</li>
				<li>Obtain an API key for the app and update your <code>google_maps_api.xml</code> file with that key.</li>
				<li>Show a button at the bottom with an <strong class="bold">I’m parked </strong><strong class="bold">here</strong> label.</li>
				<li>Include the location service in your app.</li>
				<li>Request the user’s permission to access their location.</li>
				<li>Obtain the user’s location and place a pin on the map at that location.</li>
				<li>Add a car icon to your project.</li>
				<li>Add functionality to move the car icon to the user’s current location.</li>
				<li>Bonus step: store the selected location in <code>SharedPreferences</code>. This function, placed in your activity, will help you do this:<pre class="source code">
private fun saveLocation(latLng: LatLng) =
  getPreferences(MODE_PRIVATE)?.edit()?.apply {
    putString("latitude", latLng.latitude.toString())
    putString("longitude", latLng.longitude.toString())
    apply()
  }</pre></li>
				<li>Bonus step: restore any saved location from <code>SharedPreferences</code>. You can use the following function:<pre class="source code">
val latitude = sharedPreferences
    .getString("latitude", null)
    ?.toDoubleOrNull() ?: return null
val longitude = sharedPreferences
    .getString("longitude", null)
    ?.toDoubleOrNull() ?: return null</pre></li>
			</ol>
			<p>With this activity completed, you have demonstrated your understanding of requesting permissions in an Android app. You have also shown that you can present the user with a map and <a id="_idIndexMarker674"/>control pins on that map. Finally, you have also demonstrated your knowledge of obtaining the user’s current location. Well done.</p>
			<p class="callout heading">Note</p>
			<p class="callout">The solution to this activity <a id="_idTextAnchor464"/><a id="_idTextAnchor465"/>can be found at <a href="https://packt.link/By7eE">https://packt.link/By7eE</a>.</p>
			<h1 id="_idParaDest-131"><a id="_idTextAnchor466"/>Summary</h1>
			<p>In this chapter, we learned about Android permissions. We touched on the reasons for having them and saw how we could request the user’s permission to perform certain tasks. We also learned how to use Google’s Maps API and how to present the user with an interactive map.</p>
			<p>Lastly, we leveraged our knowledge of presenting a map and requesting permissions to find out the user’s current location and present it on the map. Of course, there is a lot more that can be done with the Google Maps API, and you could explore a lot more possibilities with certain permissions.</p>
			<p>You should now have enough understanding of the foundations to explore further. To read more about permissions, visit <a href="https://packt.link/57BdN">https://packt.link/57BdN</a>. To read more about the Maps API, visit <a href="https://packt.link/8akrP">https://packt.link/8akrP</a>.</p>
			<p>In the next chapter, we will learn how to perform background tasks using <code>Services</code> and <code>WorkManager</code>. We will also learn how to present the user with notifications, even when the app is not running. These are powerful tools to have in your arsenal as a mobile developer.</p>
		</div>
		<div><div></div>
		</div>
	</body></html>