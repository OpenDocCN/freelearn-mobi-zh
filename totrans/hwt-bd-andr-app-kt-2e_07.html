<html><head></head><body>
		<div id="_idContainer156">
			<h1 id="_idParaDest-121" class="chapter number"><a id="_idTextAnchor421"/><a id="_idTextAnchor422"/><a id="_idTextAnchor423"/><a id="_idTextAnchor424"/><a id="_idTextAnchor425"/>7</h1>
			<h1 id="_idParaDest-122"><a id="_idTextAnchor426"/>Android Permissions and Google Maps</h1>
			<p><a id="_idTextAnchor427"/>This chapter will teach you how to request and obtain app permissions in Android. You will gain a solid understanding of how to include local and global interactive maps in your app by using the Google Maps API and how to request permissions to use device features that provide <span class="No-Break">richer functionality.</span></p>
			<p>By the end of the chapter, you will be able to create permission requests for your app and handle <span class="No-Break">missing permissions.</span></p>
			<p><a id="_idTextAnchor428"/>In the previous chapter, we learned how to present data in lists using <strong class="source inline">RecyclerView</strong>. Then, we used that knowledge to present the user with a list of secret cat agents. In this chapter, we will learn how to find the user’s location on the map and how to deploy cat agents to the field by selecting locations on <span class="No-Break">the map.</span></p>
			<p>First, we will explore the Android permissions system. Many Android features are not immediately available to us. These features are gated behind a permission system to protect the user. For us to access those features, we must ask the user to allow us to do so. Some such features include but are not limited to obtaining the user’s location, accessing the user’s contacts, accessing their camera, and establishing a Bluetooth connection. Different Android versions enforce different <span class="No-Break">permission rules.</span></p>
			<p class="callout heading">Note</p>
			<p class="callout">When Android 6 (Marshmallow) was introduced in 2015, for example, several permissions you could silently obtain on installation were deemed insecure and became runtime permissions, requiring explicit <span class="No-Break">user consent.</span></p>
			<p>We will then look at the Google Maps API. This API allows us to present the user with a map of any desired location in the world. We will add data to that map and let the user interact with the map. The API also lets you show points of interest and render a street view of supported locations, though we will not explore these features in <span class="No-Break">this book.</span></p>
			<p>We will cover the following topics in <span class="No-Break">this chapter:</span></p>
			<ul>
				<li>Requesting permission from <span class="No-Break">the user</span></li>
				<li>Showing a map of the <span class="No-Break">user’s location</span></li>
				<li>Map clicks and <span class="No-Break">custom markers</span></li>
			</ul>
			<h1 id="_idParaDest-123"><a id="_idTextAnchor429"/><a id="_idTextAnchor430"/>Technical requirements</h1>
			<p>The complete code for all the exercises and the activity in this chapter is available on GitHub <span class="No-Break">at </span><a href="https://packt.link/6ShZd"><span class="No-Break">https://packt.link/6ShZd</span></a></p>
			<h1 id="_idParaDest-124"><a id="_idTextAnchor431"/>Requesting permission from the user</h1>
			<p>Our app might <a id="_idIndexMarker619"/>want to implement certain features that <a id="_idIndexMarker620"/>Google deems dangerous. This usually means access to those features could risk the user’s privacy. For example, some permissions may allow you to read users’ messages or determine their <span class="No-Break">current location.</span></p>
			<p>Depending on the required permission and the target Android API level we are developing, we may need to request that permission from the user. If the device is running on Android 6 (Marshmallow, API level 23), and the target API of our app is 23 or higher (it almost certainly will be, as most devices by now will run newer versions of Android), there will be no alert for the user about any permissions requested by the app at install time. Instead, our app must ask the user to grant those permissions <span class="No-Break">at runtime.</span></p>
			<p>When we request permission, the user sees a dialog like the one shown in <span class="No-Break"><em class="italic">Figure 7</em></span><span class="No-Break"><em class="italic">.1</em></span><span class="No-Break">.</span><a id="_idTextAnchor432"/></p>
			<div>
				<div id="_idContainer143" class="IMG---Figure">
					<img src="image/B19411_07_01.jpg" alt="Figure 7.1 – Permission dialog for device location access"/>
				</div>
			</div>
			<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 7.1 – Permission dialog for device location access</p>
			<p class="callout heading">Note</p>
			<p class="callout">For a full list of permissions and their protection level, see <span class="No-Break">here: </span><a href="https://developer.android.com/reference/android/Manifest.permission"><span class="No-Break">https://developer.android.com/reference/android/Manifest.permission</span></a><span class="No-Break">.</span></p>
			<p>We must include permissions in our manifest file when we intend to use them. A manifest with the <strong class="source inline">SEND_SMS</strong> permission would look something like the <span class="No-Break">following snippet:</span></p>
			<pre class="source code">
&lt;manifest xmlns:android=
    "http://schemas.android.com/apk/res/android"
  package="com.example.snazzyapp"&gt;
<strong class="bold">  </strong><strong class="bold">&lt;uses-permission android:name="android.permission.SEND_SMS" /&gt;</strong>
  &lt;application …&gt; ... &lt;/application&gt;
&lt;/manifest&gt;</pre>
			<p>Safe permissions (or normal permissions, as Google calls them) would be automatically granted to <a id="_idIndexMarker621"/>the<a id="_idIndexMarker622"/> user. However, dangerous ones would only be granted if explicitly approved by the user. If we fail to request permission from the user and try to execute an action that requires that permission, the result would be the action not running at best and our app crashing <span class="No-Break">at worst.</span></p>
			<p>We should first check whether the user has already granted us that permission before asking the user for permission. If the user has not yet granted us permission, we may need to check whether a rationale dialog should be shown prior to the permission request. This depends on how obvious the justification for the request would be to <span class="No-Break">the user.</span></p>
			<p>For example, if a camera app requests permission to access the camera, we can safely assume the reason would be clear to the user. However, some cases may not be as clear to the user, especially if the user is not tech-savvy. In those cases, we may have to justify the request to <span class="No-Break">the user.</span></p>
			<p>Google provides us with a function called <strong class="source inline">shouldShowRequestPermissionRationale(Activity, String)</strong> for this purpose. Under the hood, this function checks whether the user has previously denied the permission but also whether the user has denied us <span class="No-Break">permission before.</span></p>
			<p>The idea is to allow us to justify our request to the user for permission before requesting it, thus increasing the likelihood of them approving the request. Once we determine whether the app should present the user with our rationale or whether no rationale was required, we can proceed to request <span class="No-Break">the permission.</span></p>
			<p>Let’s see how we can request permission. First, we must include the Jetpack Activity and Fragment dependencies in our app <span class="No-Break"><strong class="source inline">gradle</strong></span><span class="No-Break"> file:</span></p>
			<pre class="source code">
implementation "androidx.activity:activity-ktx:1.6.1"
implementation "androidx.fragment:fragment-ktx:1.5.5"</pre>
			<p>This will provide us with <strong class="source inline">ActivityResultLauncher</strong>, which we will use to launch the permission request dialog and handle the <span class="No-Break">user’s response.</span></p>
			<p>The following is <a id="_idIndexMarker623"/>an <a id="_idIndexMarker624"/>example of an <strong class="source inline">Activity</strong> class requesting the <span class="No-Break"><strong class="source inline">Location</strong></span><span class="No-Break"> permission:</span></p>
			<pre class="source code">
class MainActivity : AppCompatActivity() {
  private lateinit var requestPermissionLauncher:
    ActivityResultLauncher&lt;String&gt;
  override fun onCreate() {
    ...
    requestPermissionLauncher = registerForActivityResult(
      RequestPermission()) { isGranted -&gt;
        if (isGranted) {... } else { ... }    }</pre>
			<p>When <strong class="source inline">Activity</strong> is created, we register the launcher to handle permission request responses. We keep a reference to the result for later use. When <strong class="source inline">Activity</strong> is resumed, we check the status of the permission and <span class="No-Break">continue accordingly:</span></p>
			<pre class="source code">
override fun onResume() {
  ...
  when {
    hasLocationPermission() -&gt; getLastLocation()
    shouldShowRequestPermissionRationale(this, 
    ACCESS_FINE_LOCATION) -&gt; {
      showPermissionRationale {
        requestPermissionLauncher
          .launch(ACCESS_FINE_LOCATION)
      }
    }
    else -&gt; requestPermissionLauncher.
              launch(ACCESS_FINE_LOCATION)
  }
}</pre>
			<p>We start by <a id="_idIndexMarker625"/>checking <a id="_idIndexMarker626"/>the location permission (<strong class="source inline">ACCESS_FINE_LOCATION</strong>) by <span class="No-Break">calling </span><span class="No-Break"><strong class="source inline">getHas</strong></span><strong class="source inline">
</strong><span class="No-Break"><strong class="source inline">LocationPermissions()</strong></span><span class="No-Break">:</span></p>
			<pre class="source code">
private fun hasLocationPermission() =
  checkSelfPermission(this, Manifest.permission.ACCESS_FINE_
  LOCATION) == PERMISSION_G<a id="_idTextAnchor433"/>RANTED</pre>
			<p>This function checks whether the user has granted us the requested permissions by calling <strong class="source inline">checkSelfPermission(Context, String)</strong> with the <span class="No-Break">requested permission.</span></p>
			<p>If the user hasn’t granted us permission, we <span class="No-Break">call </span><span class="No-Break"><strong class="source inline">shouldShowRequestPermission</strong></span><strong class="source inline">
Rationale(Activity, String)</strong>, which we mentioned earlier, to check whether a rationale dialog should be presented to <span class="No-Break">the user.</span></p>
			<p>If showing our rationale is needed, we call <strong class="source inline">showPermissionRationale(() -&gt; Unit)</strong>, passing in a lambda that will use <strong class="source inline">requestPermissionLauncher</strong> to launch the request dialog after the user dismisses our rationale dialog using the positive button. If no rationale is needed, we launch the dialog with <strong class="source inline">requestPermissionLauncher</strong> directly. The following code is for presenting the <span class="No-Break">rationale dialog:</span></p>
			<pre class="source code">
private fun showPermissionRationale(
  positiveAction: () -&gt; Unit) {
  AlertDialog.Builder(this)
    .setTitle("Location permission")
    .setMessage("We need your permission to find your current 
        position")
    .setPositiveButton(android.R.string.ok) { _, _ -&gt;
        positiveAction()
    }
    .setNegativeButton(android.R.string.cancel) { dialog, _ -&gt; 
        dialog.dismiss() }
    .create().show()
}</pre>
			<p>Our <strong class="source inline">showPermissionRationale</strong> function presents the user with a dialog with a brief explanation of why we need their permission. The <strong class="bold">OK</strong> button will execute the positive <a id="_idIndexMarker627"/>action<a id="_idIndexMarker628"/> provided, and the <strong class="bold">Cancel</strong> one will dismiss <span class="No-Break">the <a id="_idTextAnchor434"/>dialog:</span></p>
			<div>
				<div id="_idContainer144" class="IMG---Figure">
					<img src="image/B19411_07_02.jpg" alt="Figure 7.2 – Rationale dialog"/>
				</div>
			</div>
			<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 7.2 – Rationale dialog</p>
			<p>Lastly, we request permission by calling <strong class="source inline">requestPermissionLauncher.launch(ACCESS_FINE_LOCATION)</strong> using the request permission launcher we <span class="No-Break">declared earlier.</span></p>
			<p>If we’ve requested the location permission from the user, the response will be processed by the request permission launcher depending on the value returned via <strong class="source inline">isGranted</strong>, as shown in the <span class="No-Break">following code:</span></p>
			<pre class="source code">
registerForActivityResult(RequestPermission()) { isGranted -&gt;
  if (isGranted) { getLastLocation() }
  else {
    showPermissionRationale { requestPermissionLauncher
      .launch(ACCESS_FINE_LOCATION) }
  }
}</pre>
			<p>This code is the expansion of the code we observed earlier, added to the <strong class="source inline">onCreate</strong> function of <strong class="source inline">Activity</strong>. This chapter will take us through the development of an app that shows <a id="_idIndexMarker629"/>us<a id="_idIndexMarker630"/> our current location on a map and allows us to place a marker where we want to deploy our secret <span class="No-Break">cat agent.</span></p>
			<p>Let’s start with our <span class="No-Break">first <a id="_idTextAnchor435"/><a id="_idTextAnchor436"/>exercise.</span></p>
			<h2 id="_idParaDest-125"><a id="_idTextAnchor437"/>Exercise 7.01 – requesting the location permission</h2>
			<p>In this <a id="_idIndexMarker631"/>exercise, we will request that the user provide<a id="_idIndexMarker632"/> the location permission. We will first create a <strong class="bold">Google Maps Activity</strong> project. Then, we will define the permission required in the manifest file. To get started, let’s implement the code required to request permission from the user to access <span class="No-Break">their location:</span></p>
			<ol>
				<li>Start by creating a new Google Maps Activity project (<strong class="bold">File</strong> | <strong class="bold">New</strong> | <strong class="bold">New Project</strong> | <strong class="bold">Google Maps Activity</strong>). We’re not using Google Maps in this exercise. However, the Google Maps Activity is still a good choice in this case. It will save you a lot of boilerplate coding in the next exercise (<em class="italic">Exercise 7.02</em>). Don’t worry; it will have no impact on your current exercise. Click <strong class="bold">Next</strong>, as shown in the <span class="No-Break">following s<a id="_idTextAnchor438"/>creenshot:</span></li>
			</ol>
			<div>
				<div id="_idContainer145" class="IMG---Figure">
					<img src="image/B19411_07_03.jpg" alt="Figure 7.3 – Choose your project"/>
				</div>
			</div>
			<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 7.3 – Choose your project</p>
			<ol>
				<li value="2">Name <a id="_idIndexMarker633"/>your<a id="_idIndexMarker634"/> application <strong class="source inline">Cat </strong><span class="No-Break"><strong class="source inline">Agent Deployer</strong></span><span class="No-Break">.</span></li>
				<li>Make sure your package name <span class="No-Break">is </span><span class="No-Break"><strong class="source inline">com.example.catagentdeployer</strong></span><span class="No-Break">.</span></li>
				<li>Set the save location to where you want to save <span class="No-Break">your project.</span></li>
				<li>Leave everything else at its default values and <span class="No-Break">click </span><span class="No-Break"><strong class="bold">Finish</strong></span><span class="No-Break">.</span></li>
				<li>Make sure you are on the <strong class="bold">Android</strong> view in your <span class="No-Break"><strong class="bold">Pr<a id="_idTextAnchor439"/>oject</strong></span><span class="No-Break"> pane:</span></li>
			</ol>
			<div>
				<div id="_idContainer146" class="IMG---Figure">
					<img src="image/B19411_07_04.jpg" alt="Figure 7.4 – The Android view"/>
				</div>
			</div>
			<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 7.4 – The Android view</p>
			<ol>
				<li value="7">Open your <strong class="source inline">AndroidManifest.xml</strong> file. Make sure the location permission was<a id="_idIndexMarker635"/> already <a id="_idIndexMarker636"/>added to <span class="No-Break">your app:</span><pre class="source code">
&lt;manifest ...&gt;
    <strong class="bold">&lt;uses-permission android:name=</strong>
<strong class="bold">        "android.permission.ACCESS_FINE_LOCATION" /&gt;</strong>
    &lt;application ...&gt; ... &lt;/application&gt;
&lt;/manifest&gt;</pre></li>
			</ol>
			<p class="callout heading">Note</p>
			<p class="callout"><strong class="source inline">ACCESS_FINE_LOCATION</strong> is the permission you will need to obtain the user’s location based on GPS in addition to the less accurate Wi-Fi and mobile data-based location information you could obtain by using the <span class="No-Break"><strong class="source inline">ACCESS_COARSE_LOCATION</strong></span><span class="No-Break"> permission.</span></p>
			<ol>
				<li value="8">Open your <strong class="source inline">MapsActivity.kt</strong> file. At the bottom of the <strong class="source inline">MapsActivity</strong> class block, add an empty <span class="No-Break"><strong class="source inline">getLastLocation()</strong></span><span class="No-Break"> function:</span><pre class="source code">
class MapsActivity : ... {
  ...
  <strong class="bold">private fun getLastLocation() {</strong>
<strong class="bold">    Log.d("MapsActivity", "getLastLocation() called.")</strong>
  <strong class="bold">}</strong>
}</pre></li>
			</ol>
			<p>This will be the function you will call when you have ensured the user has granted you the <span class="No-Break">location permission.</span></p>
			<ol>
				<li value="9">Next, add the request permission launcher to the top of the <span class="No-Break"><strong class="source inline">MapsActivity</strong></span><span class="No-Break"> class:</span><pre class="source code">
class MapsActivity : ... {
    private lateinit var requestPermissionLauncher:
        ActivityResultLauncher&lt;String&gt;</pre></li>
			</ol>
			<p>This is the variable through which we will launch the permission request and track <span class="No-Break">user responses.</span></p>
			<p>Now navigate to the bottom of the <strong class="source inline">onCreate()</strong> function and register for activity <a id="_idIndexMarker637"/>results, storing<a id="_idIndexMarker638"/> the result in <strong class="source inline">requestPermissionLauncher</strong>, which you declared in the <span class="No-Break">previous step:</span></p>
			<pre class="source code">
override fun onCreate(savedInstanceState: Bundle?) {
  ...
  requestPermissionLauncher =
    registerForActivityResult(RequestPermission()) { 
    isGranted -&gt;
      if (isGranted) { getLastLocation() }
      else {
        showPermissionRationale {
          requestPermissionLauncher
            .launch(ACCESS_FINE_LOCATION)
        }
      }
    }
}</pre>
			<ol>
				<li value="10">To present users with the rationale for the permission request, implement <span class="No-Break">the </span><span class="No-Break"><strong class="source inline">show</strong></span><strong class="source inline">
PermissionRationale(() -&gt; Unit)</strong> function right before <span class="No-Break">the </span><span class="No-Break"><strong class="source inline">getLast</strong></span><strong class="source inline">
</strong><span class="No-Break"><strong class="source inline">Location()</strong></span><span class="No-Break"> function:</span><pre class="source code">
private fun showPermissionRationale(positiveAction: ()
-&gt; Unit) {
  AlertDialog.Builder(this)
    .setTitle("Location permission")
    .setMessage("This app will not work without knowing 
        your current location")
    .setPositiveButton(android.R.string.ok) { _, _ -&gt;
        positiveAction() }
    .setNegativeButton(android.R.string.cancel) { dialog, 
        _ -&gt; dialog.dismiss() }
    .create().show()
}</pre></li>
			</ol>
			<p>This function<a id="_idIndexMarker639"/> will<a id="_idIndexMarker640"/> present the user with a simple alert dialog explaining that the app will not work without knowing their current location, as shown in <span class="No-Break"><em class="italic">Figure 7</em></span><em class="italic">.1</em>. Tapping <strong class="bold">OK</strong> will execute the provided <strong class="source inline">positiveAction</strong> lambda. Tapping <strong class="bold">CANCEL</strong> will dismiss <span class="No-Break">the dialog.</span></p>
			<ol>
				<li value="11">To determine whether or not your app already has the location permission, introduce the following <strong class="source inline">hasLocationPermission()</strong> function right before the <span class="No-Break"><strong class="source inline">requestPermissionWithRationaleIfNeeded()</strong></span><span class="No-Break"> function:</span><pre class="source code">
private fun hasLocationPermission() =
    ContextCompat.checkSelfPermission(
        this, Manifest.permission.ACCESS_FINE_LOCATION
    ) == PackageManager.PERMISSION_GRANTED</pre></li>
				<li>Finally, update the <strong class="source inline">onMapReady()</strong> function of your <strong class="source inline">MapsActivity</strong> class to determine the permission status and <span class="No-Break">proceed accordingly:</span><pre class="source code">
override fun onMapReady(googleMap: GoogleMap) {
  mMap = googleMap
  when {
    hasLocationPermission() -&gt; getLastLocation()
    shouldShowRequestPermissionRationale(this,
      ACCESS_FINE_LOCATION) -&gt; {
      showPermissionRationale {
        requestPermissionLauncher
          .launch(ACCESS_FINE_LOCATION)
      }
    }
    else -&gt; requestPermissionLauncher
      .launch(ACCESS_FINE_LOCATION)
  }
}</pre></li>
			</ol>
			<p>The <strong class="source inline">when</strong> statement <a id="_idIndexMarker641"/>will check whether the <a id="_idIndexMarker642"/>permission was already granted. If not, it will check whether a rationale dialog should be presented. Then, if the rationale is accepted by the user or no rationale dialog is required, it will present a standard permission request dialog to the user (as shown in <span class="No-Break"><em class="italic">Figure 7</em></span><em class="italic">.1</em>), asking them to allow the app to access their location. You pass the requested permission you want the user to grant your <span class="No-Break">app (</span><span class="No-Break"><strong class="source inline">Manifest.permission.ACCESS_FINE_LOCATION</strong></span><span class="No-Break">).</span></p>
			<ol>
				<li value="13">Run your app. You should now see a system permission dialog requesting you to allow the app to access the location of the device, as sh<a id="_idTextAnchor440"/>own in <span class="No-Break"><em class="italic">Figure 7</em></span><span class="No-Break"><em class="italic">.5</em></span><span class="No-Break">.</span></li>
			</ol>
			<div>
				<div id="_idContainer147" class="IMG---Figure">
					<img src="image/B19411_07_05.jpg" alt="Figure 7.5 – App requesting the location permission"/>
				</div>
			</div>
			<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 7.5 – App requesting the location permission</p>
			<p>If the user denies<a id="_idIndexMarker643"/> the<a id="_idIndexMarker644"/> permission, the rationale dialog will appear. If the rationale is accepted, the system permission dialog will show again. Up until SDK 31, the user had the option to choose not to let the app ask for permission again (<span class="No-Break"><em class="italic">Figure 7</em></span><em class="italic">.6</em>). From SDK 31 onwards, not asking a third time is the default. Allowing it afterwards requires using th<a id="_idTextAnchor441"/>e <span class="No-Break">device settings.</span></p>
			<div>
				<div id="_idContainer148" class="IMG---Figure">
					<img src="image/B19411_07_06.jpg" alt="Figure 7.6 – The Don’t ask again message"/>
				</div>
			</div>
			<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 7.6 – The Don’t ask again message</p>
			<p>Once the user has allowed or permanently denied the permission, the dialog will never show again. To reset the state of your app permissions, you would have to manually grant <a id="_idIndexMarker645"/>it<a id="_idIndexMarker646"/> permission via the <strong class="bold">App </strong><span class="No-Break"><strong class="bold">Info</strong></span><span class="No-Break"> interface.</span></p>
			<p>Now that we can get the location permission, we will now look into obtaining the use<a id="_idTextAnchor442"/><a id="_idTextAnchor443"/>r’s <span class="No-Break">current location.</span></p>
			<h1 id="_idParaDest-126"><a id="_idTextAnchor444"/>Showing a map of the user’s location</h1>
			<p>Having successfully<a id="_idIndexMarker647"/> obtained permission from the user to access their location, we can now ask the user’s device to provide us with its last known location. This is also usually the user’s current location. We will then use this location to present the user with a map of their <span class="No-Break">current location.</span></p>
			<p>To obtain the user’s last known location, Google has provided us with the Google Play Location service and, more specifically, with the <strong class="source inline">FusedLocationProviderClient</strong> class. The <strong class="source inline">FusedLocationProviderClient</strong> class helps us interact with Google’s Fused Location Provider API, which is a location API that intelligently combines different signals from multiple device sensors to provide us with device <span class="No-Break">location information.</span></p>
			<p>To access the <strong class="source inline">FusedLocationProviderClient</strong> class, we must first include the Google Play Location service library in our project. This simply means adding the following code snippet to the <strong class="source inline">dependencies</strong> block of our <span class="No-Break"><strong class="source inline">build.gradle</strong></span><span class="No-Break"> app:</span></p>
			<pre class="source code">
implementation "com.google.android.gms:play-services-location:21.0.1"</pre>
			<p>With the location service imported, we can now obtain an instance of <span class="No-Break">the </span><span class="No-Break"><strong class="source inline">FusedLocation</strong></span><strong class="source inline">
ProviderClient</strong> class by <span class="No-Break">calling </span><span class="No-Break"><strong class="source inline">LocationServices.getFusedLocationProvider</strong></span><strong class="source inline">
</strong><span class="No-Break"><strong class="source inline">Client(this@MainActivity)</strong></span><span class="No-Break">.</span></p>
			<p>Once we have a fused location client, we can obtain the user’s last location by <span class="No-Break">calling </span><span class="No-Break"><strong class="source inline">fused</strong></span><strong class="source inline">
</strong><span class="No-Break"><strong class="source inline">LocationClient.lastLocation</strong></span><span class="No-Break">.</span></p>
			<p class="callout heading">Note</p>
			<p class="callout">This is given that we have already received the location permission from <span class="No-Break">the user.</span></p>
			<p>Since this is an asynchronous call, we should also provide a success listener as a minimum. If we wanted to, we could also add listeners for cancellation, failure, and the completion of requests. Calling <strong class="source inline">lastLocation</strong> returns <strong class="source inline">Task&lt;Location&gt;</strong>. <strong class="source inline">Task</strong> is a Google API abstract class whose implementations perform <span class="No-Break">async operations.</span></p>
			<p>In this case, that operation is returning a location. So, adding listeners is simply a matter of chaining calls. We will add the following code snippet to <span class="No-Break">our call:</span></p>
			<pre class="source code">
.addOnSuccessListener { location: Location? -&gt; }</pre>
			<p>Note that the <strong class="source inline">location</strong> parameter could be <strong class="source inline">null</strong> if the client fails to obtain the user’s current location. This is not very common but could happen if, for example, the user disabled their location services during <span class="No-Break">the call.</span></p>
			<p>Once the code inside our success listener block is executed, and <strong class="source inline">location</strong> is not <strong class="source inline">null</strong>, we have the<a id="_idIndexMarker648"/> user’s current location in the form of a <span class="No-Break"><strong class="source inline">Location</strong></span><span class="No-Break"> instance.</span></p>
			<p>A <strong class="source inline">Location</strong> instance holds a single coordinate on Earth, expressed using longitude <span class="No-Break">and latitude.</span></p>
			<p class="callout heading">Note</p>
			<p class="callout">For our purpose, it is sufficient to know that each point on the surface of the Earth is mapped to a single pair of <strong class="bold">longitude</strong> (<strong class="bold">Lng</strong>) and <strong class="bold">latitude</strong> (<span class="No-Break"><strong class="bold">Lat</strong></span><span class="No-Break">) values.</span></p>
			<p>This is where it gets exciting. Google lets us present any location on an interactive map by using a <strong class="source inline">SupportMapFragment</strong> class. All it takes is to sign up for a free API key. When you create your application with a Google Maps Activity, Android Studio immediately opens the <strong class="source inline">AndroidManifest.xml</strong> file. A comment in the file sends us to <a href="https://packt.link/FK58V">https://packt.link/FK58V</a> to obtain the required API key. You can copy that link to your browser or press <em class="italic">Ctrl</em>/<em class="italic">Command</em> + click <span class="No-Break">on it.</span></p>
			<p>On the page, follow the directions and click <strong class="bold">Create</strong>. Once you have a key, replace the <strong class="source inline">YOUR_API_KEY</strong> string in the meta tag value with your newly <span class="No-Break">obtained key.</span></p>
			<p>At this point, if you run your app, you will already see an interactive map on your screen, <a id="_idTextAnchor445"/>as seen in <span class="No-Break"><em class="italic">Figure 7</em></span><span class="No-Break"><em class="italic">.7</em></span><span class="No-Break">.</span></p>
			<div>
				<div id="_idContainer149" class="IMG---Figure">
					<img src="image/B19411_07_07.jpg" alt="Figure 7.7 – Interactive map"/>
				</div>
			</div>
			<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 7.7 – Interactive map</p>
			<p>To position the map<a id="_idIndexMarker649"/> based on our current location, we create a <strong class="source inline">LatLng</strong> instance with the coordinates from our <strong class="source inline">Location</strong> instance and call <strong class="source inline">moveCamera(CameraUpdate)</strong> on the <strong class="source inline">GoogleMap</strong> instance. To satisfy the <strong class="source inline">CameraUpdate</strong> requirement, we call <strong class="source inline">CameraUpdateFactory.newLatLng(LatLng)</strong>, passing in the <strong class="source inline">LatLng</strong> parameter created earlier. The call would look something <span class="No-Break">like this:</span></p>
			<pre class="source code">
mMap.moveCamera(CameraUpdateFactory.newLatLng(latLng))</pre>
			<p class="callout heading">Note</p>
			<p class="callout">To discover the rest of the available <strong class="source inline">CameraUpdateFactory</strong> options, <span class="No-Break">visit </span><a href="https://packt.link/EBRnt"><span class="No-Break">https://packt.link/EBRnt</span></a><span class="No-Break">.</span></p>
			<p>We could also call <strong class="source inline">newLatLngZoom(LatLng, Float)</strong> to modify the zoom-in and zoom-out features of <span class="No-Break">the map.</span></p>
			<p class="callout heading">Note</p>
			<p class="callout">Valid zoom values range between 2.0 (farthest) and 21.0 (closest). Values outside of that range <span class="No-Break">are capped.</span></p>
			<p>Some areas may not have tiles to render the closest <span class="No-Break">zoom values.</span></p>
			<p>We call <strong class="source inline">addMarker(MarkerOptions)</strong> on the <strong class="source inline">GoogleMap</strong> instance to add a marker at the user’s coordinate. The <strong class="source inline">MarkerOptions</strong> parameters are configured by chaining calls to a <strong class="source inline">MarkerOptions()</strong> instance. We could call <strong class="source inline">position(LatLng)</strong> and <strong class="source inline">title(String)</strong> for a simple marker at our desired position. The call would look like <span class="No-Break">the following:</span></p>
			<pre class="source code">
mMap.addMarker(MarkerOptions().position(latLng)
    .title("Pin Label"))</pre>
			<p>The order in<a id="_idIndexMarker650"/> which we chain the calls does <span class="No-Break">not matter.</span></p>
			<p>Let’s practice this in<a id="_idTextAnchor446"/><a id="_idTextAnchor447"/> the <span class="No-Break">following exercise.</span></p>
			<h2 id="_idParaDest-127"><a id="_idTextAnchor448"/>Exercise 7.02 – obtaining the user’s current location</h2>
			<p>Now that your app can be granted location permission, you can use the location permission to get the user’s current location. You will then display the map and update it to zoom into the user’s current location and show a pin at that location. To do this, perform the <span class="No-Break">following steps:</span></p>
			<ol>
				<li>First, add the Google Play location service to your <strong class="source inline">build.gradle</strong> file. You should add it within the <span class="No-Break"><strong class="source inline">dependencies</strong></span><span class="No-Break"> block:</span><pre class="source code">
dependencies {
<strong class="bold">  implementation "com.google.android.gms: play-services-</strong>
  <strong class="bold">location:21.0.1"</strong>
  ...
}</pre></li>
				<li>Click the <strong class="bold">Sync Project with Gradle Files</strong> button in Android Studio for Gradle to fetch the newly <span class="No-Break">added dependency.</span></li>
				<li>Obtain an API key: open the <strong class="source inline">AndroidManifest.xml</strong> file (<strong class="source inline">app/src/main/AndroidManifest.xml</strong>) and <em class="italic">Ctrl</em> / <em class="italic">Cmd</em> + click the <span class="No-Break">link </span><a href="https://developers.google.com/maps/documentation/android-sdk/get-api-key"><span class="No-Break">https://developers.google.com/maps/documentation/android-sdk/get-api-key</span></a><span class="No-Break">.</span></li>
				<li>Follow the instructions on the website until you have generated a new <span class="No-Break">API key.</span></li>
				<li>Update your <strong class="source inline">google_maps_api.xml</strong> file by replacing <strong class="source inline">YOUR_API_KEY</strong> with your <a id="_idIndexMarker651"/>new API key in the <span class="No-Break">following code:</span><pre class="source code">
&lt;meta-data
android:name="com.google.android.geo.API_KEY"
            android:value="<strong class="bold">YOUR_API_KEY</strong>" /&gt;</pre></li>
				<li>Open your <strong class="source inline">MapsActivity.kt</strong> file. At the top of your <strong class="source inline">MapsActivity</strong> class, define a lazily initialized fused location <span class="No-Break">provider client:</span><pre class="source code">
class MapsActivity : ... {
  <strong class="bold">private val fusedLocationProviderClient by lazy {</strong>
    <strong class="bold">LocationServices</strong>
<strong class="bold">      .getFusedLocationProviderClient(this)</strong>
  <strong class="bold">}</strong>
  override fun onCreate(savedInstanceState: Bundle?)
  { ... }
  ...
}</pre></li>
			</ol>
			<p>By making <strong class="source inline">fusedLocationProviderClient</strong> initialize lazily, you are ensuring it is only initialized when needed, which essentially guarantees the <strong class="source inline">Activity</strong> class will have been created <span class="No-Break">before initialization.</span></p>
			<ol>
				<li value="7">Introduce an <strong class="source inline">updateMapLocation(LatLng)</strong> function and an <strong class="source inline">addMarkerAtLocation(LatLng, String)</strong> function immediately after the <strong class="source inline">getLastLocation()</strong> function to zoom the map at a given location and add a marker at that <span class="No-Break">location, respectively:</span><pre class="source code">
private fun updateMapLocation(location: LatLng) {
    mMap.moveCamera(CameraUpdateFactory.newLatLngZoom(
        location, 7f))
}
private fun addMarkerAtLocation(location: LatLng,
title: String) {
    mMap.addMarker(MarkerOptions().title(title)
        .position(location))
}</pre></li>
				<li>Now update <a id="_idIndexMarker652"/>your <strong class="source inline">getLastLocation()</strong> function to retrieve the <span class="No-Break">user’s location:</span><pre class="source code">
private fun getLastLocation() {
<strong class="bold">  fusedLocationProviderClient.lastLocation</strong>
<strong class="bold">    .addOnSuccessListener { location: Location? -&gt;</strong>
<strong class="bold">      </strong><strong class="bold">location?.let {</strong>
<strong class="bold">        val userLocation = LatLng(</strong>
<strong class="bold">          location.latitude, location.longitude)</strong>
<strong class="bold">        updateMapLocation(userLocation)</strong>
<strong class="bold">        addMarkerAtLocation(userLocation, "You")</strong>
<strong class="bold">     }</strong>
<strong class="bold">  }</strong>
}</pre></li>
			</ol>
			<p>Your code requests the last location by calling <strong class="source inline">lastLocation</strong> and then attaches a <strong class="source inline">lambda</strong> function as an <strong class="source inline">OnSuccessListener</strong> interface. Once a location is obtained, the <strong class="source inline">lambda</strong> function is executed, updating the map location. The code then adds a marker at that location with the <strong class="source inline">You</strong> title if a non-null location <span class="No-Break">was returned.</span></p>
			<ol>
				<li value="9">Run your<a id="_idIndexMarker653"/> app. It sh<a id="_idTextAnchor449"/>ould look like <span class="No-Break"><em class="italic">Figure 7</em></span><span class="No-Break"><em class="italic">.8</em></span><span class="No-Break">.</span></li>
			</ol>
			<div>
				<div id="_idContainer150" class="IMG---Figure">
					<img src="image/B19411_07_08.jpg" alt="Figure 7.8 – Interactive map with a marker at the current location"/>
				</div>
			</div>
			<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 7.8 – Interactive map with a marker at the current location</p>
			<p>Once the app has been granted permission, it can request the user’s last location from the Google Play location service via the fused location provider client. This gives you an easy and concise way to fetch the user’s current location. Remember to turn on the location on your device for the app <span class="No-Break">to work.</span></p>
			<p>With the user’s location, your app can tell the map where to zoom and where to place a marker. If the <a id="_idIndexMarker654"/>user clicks on the marker, they will see the title you assigned to it (<strong class="source inline">You</strong> in <span class="No-Break">the exercise).</span></p>
			<p>In the next section, we will learn how to respond to clicks on the m<a id="_idTextAnchor450"/><a id="_idTextAnchor451"/>ap and how to <span class="No-Break">move markers.</span></p>
			<h1 id="_idParaDest-128"><a id="_idTextAnchor452"/>Map clicks and custom markers</h1>
			<p>With a map <a id="_idIndexMarker655"/>showing<a id="_idIndexMarker656"/> the user’s current location by zooming in at the right location and placing a marker there, we have a rudimentary knowledge of how to render the desired map and how to obtain the required permissions and the user’s <span class="No-Break">current location.</span></p>
			<p>In this section, we will learn how to respond to a user interacting with the map and how to use markers more extensively. We will learn how to move markers on the map and replace the default pin marker with custom icons. When we know how to let the user place a marker anywhere on the map, we can let them choose where to deploy the secret <span class="No-Break">cat agent.</span></p>
			<p>We need to add a listener to the <strong class="source inline">GoogleMap</strong> instance to listen for clicks on the map. Looking at our <strong class="source inline">MapsActivity.kt</strong> file, the best place to do so would be in <strong class="source inline">onMapReady(GoogleMap)</strong>. A naïve implementation might look <span class="No-Break">like this:</span></p>
			<pre class="source code">
override fun onMapReady(googleMap: GoogleMap) {
    mMap = googleMap.apply {
        setOnMapClickListener { latLng -&gt;
            addMarkerAtLocation(latLng, "Deploy here")
        }
    }
    ...
}</pre>
			<p>However, if we ran this code, we’d find that a new marker is added for every click on the map. This is not our <span class="No-Break">desired behavior.</span></p>
			<p>To control a marker on the map, we need to keep a reference to that marker. That is achieved easily enough by keeping a reference to the output of <strong class="source inline">GoogleMap.addMarker(MarkerOptions)</strong>. The <strong class="source inline">addMarker</strong> function returns a <strong class="source inline">Marker</strong> instance. To move a marker on the map, we assign a new position value to it by calling its <span class="No-Break"><strong class="source inline">position</strong></span><span class="No-Break"> setter.</span></p>
			<p>To replace the default pin icon with a custom icon, we must provide a <strong class="source inline">BitmapDescriptor</strong> to the marker or the <strong class="source inline">MarkerOptions()</strong> instance. The <strong class="source inline">BitmapDescriptor</strong> wrappers work around bitmaps used by <strong class="source inline">GoogleMap</strong> to render markers and ground overlays, but we won’t cover that in <span class="No-Break">this book.</span></p>
			<p>We obtain <strong class="source inline">BitmapDescriptor</strong> by using <strong class="source inline">BitmapDescriptorFactory</strong>. The factory will<a id="_idIndexMarker657"/> require <a id="_idIndexMarker658"/>an asset, which can be provided in a few ways. You can provide it with the name of a bitmap in the <strong class="source inline">assets</strong> directory, a <strong class="source inline">Bitmap</strong>, a filename of a file in the internal storage, or a <span class="No-Break">resource ID.</span></p>
			<p>The factory can also create default markers of different colors. We are interested in the <strong class="source inline">Bitmap</strong> option because we intend to use a vector drawable, and the factory does not directly support those. In addition, when converting the drawable to a <strong class="source inline">Bitmap</strong>, we can manipulate it to suit our needs (for example, we could change <span class="No-Break">its color).</span></p>
			<p>Android Studio offers us quite a wide range of free vector <strong class="source inline">Drawables</strong> out of the box. For this example, we want the <strong class="source inline">paw</strong> drawable. To do this, right-click anywhere in the left Android pane, and select <strong class="bold">New</strong> | <span class="No-Break"><strong class="bold">Vector Asset</strong></span><span class="No-Break">.</span></p>
			<p>Now, click the Android icon next to the <strong class="bold">Clip Art</strong> label for the l<a id="_idTextAnchor453"/>ist of icons (see <span class="No-Break"><em class="italic">Figure 7</em></span><span class="No-Break"><em class="italic">.9</em></span><span class="No-Break">):</span></p>
			<div>
				<div id="_idContainer151" class="IMG---Figure">
					<img src="image/B19411_07_09.jpg" alt="Figure 7.9 – Asset Studio"/>
				</div>
			</div>
			<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 7.9 – Asset Studio</p>
			<p>We’ll now<a id="_idIndexMarker659"/> access<a id="_idIndexMarker660"/> a window to choose from the offered <a id="_idTextAnchor454"/>pool of clip art (<span class="No-Break"><em class="italic">Figure 7</em></span><span class="No-Break"><em class="italic">.10</em></span><span class="No-Break">):</span></p>
			<div>
				<div id="_idContainer152" class="IMG---Figure">
					<img src="image/B19411_07_010.jpg" alt="Figure 7.10 – Selecting an icon"/>
				</div>
			</div>
			<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 7.10 – Selecting an icon</p>
			<p>Once we choose an icon, we can name it, and it will be created for us as a vector drawable XML file. We will name <span class="No-Break">it </span><span class="No-Break"><strong class="source inline">target_icon</strong></span><span class="No-Break">.</span></p>
			<p>To use the created asset, we must first get it as a <strong class="source inline">Drawable</strong> instance. This is done by <span class="No-Break">calling </span><span class="No-Break"><strong class="source inline">Context</strong></span><strong class="source inline">
Compat.getDrawable(Context, Int)</strong>, passing in the activity and <strong class="source inline">R.drawable.target_icon</strong> as a reference to our asset. Next, we need to define bounds for the <strong class="source inline">Drawable</strong> instance to <span class="No-Break">draw in.</span></p>
			<p>Calling <strong class="source inline">Drawable.setBound(Int, Int, Int, Int)</strong> with (<strong class="source inline">0</strong>, <span class="No-Break"><strong class="source inline">0</strong></span><span class="No-Break">, </span><span class="No-Break"><strong class="source inline">drawable.intrinsic</strong></span><strong class="source inline">
Width</strong>, <strong class="source inline">drawable.intrinsicHeight</strong>) will tell the drawable to draw within its <span class="No-Break">intrinsic size.</span></p>
			<p>To change the color of our icon, we can tint it. To tint a <strong class="source inline">Drawable</strong> instance in a way that is <a id="_idIndexMarker661"/>supported <a id="_idIndexMarker662"/>by devices running APIs older than <strong class="source inline">21</strong>, we must first wrap our <strong class="source inline">Drawable</strong> instance with <strong class="source inline">DrawableCompat</strong> by calling <strong class="source inline">DrawableCompat.wrap(Drawable)</strong>. The returned <strong class="source inline">Drawable</strong> can then be tinted using <span class="No-Break"><strong class="source inline">DrawableCompat.setTint(Drawable, Int)</strong></span><span class="No-Break">.</span></p>
			<p>Next, we need to create a <strong class="source inline">Bitmap</strong> to hold our icon. Its dimensions can match those of the <strong class="source inline">Drawable</strong> bounds, and we want its <strong class="source inline">Config</strong> to <span class="No-Break">be </span><span class="No-Break"><strong class="source inline">Bitmap.Config.ARGB_8888</strong></span><span class="No-Break">.</span></p>
			<p class="callout heading">Note</p>
			<p class="callout"><strong class="bold">ARGB</strong> stands for <strong class="bold">Alpha, Red, Green, and Blue</strong>. The <strong class="source inline">8</strong> indicates the number of bits per channel. <strong class="source inline">ARGB_8888</strong> means <a id="_idIndexMarker663"/>we want 8-bit red, green, blue, and <span class="No-Break">alpha channels.</span></p>
			<p>We then create a <strong class="source inline">Canvas</strong> for the <strong class="source inline">Bitmap</strong>, allowing us to draw our <strong class="source inline">Drawable</strong> instance by calling…you guessed <span class="No-Break">it, </span><span class="No-Break"><strong class="source inline">Drawable.draw(Canvas)</strong></span><span class="No-Break">:</span></p>
			<pre class="source code">
private fun getBitmapDescriptorFromVector(@DrawableRes vectorDrawableResourceId: Int): BitmapDescriptor? {
  val bitmap = ContextCompat.getDrawable(this,
    vectorDrawableResourceId)?.let { vectorDrawable -&gt;
      vectorDrawable.setBounds(0, 0,
        vectorDrawable.intrinsicWidth,
        vectorDrawable.intrinsicHeight)
      val drawableWithTint = DrawableCompat.
        wrap(vectorDrawable)
      DrawableCompat.setTint(drawableWithTint, Color.RED)
      val bitmap = Bitmap.createBitmap(
        vectorDrawable.intrinsicWidth,
        vectorDrawable.intrinsicHeight,
        Bitmap.Config.ARGB_8888
      )
      val canvas = Canvas(bitmap)
      drawableWithTint.draw(canvas)
      bitmap
    }
    return BitmapDescriptorFactory.fromBitmap(bitmap)
      .also { bitmap?.recycle() }
}</pre>
			<p>With the <strong class="source inline">Bitmap</strong> containing our icon, we are now ready to obtain a <strong class="source inline">BitmapDescriptor</strong> instance from <strong class="source inline">BitmapDescriptorFactory</strong>. Don’t forget to recycle your <strong class="source inline">Bitmap</strong> afterward. This will avoid a <span class="No-Break">memory leak.</span></p>
			<p>You have<a id="_idIndexMarker664"/> learned how to present the user with a meaningful <a id="_idIndexMarker665"/>map by centering it on their current location and showing their cur<a id="_idTextAnchor455"/><a id="_idTextAnchor456"/>rent location using a <span class="No-Break">custom marker.</span></p>
			<h2 id="_idParaDest-129"><a id="_idTextAnchor457"/>Exercise 7.03 – adding a custom marker where the map was clicked</h2>
			<p>In this exercise, you<a id="_idIndexMarker666"/> will respond to a user’s map click by placing a red paw-shaped marker at the location on the map the <span class="No-Break">user clicked:</span></p>
			<ol>
				<li>In <strong class="source inline">MapsActivity.kt</strong> (found under <strong class="source inline">app/src/main/java/com/example/catagentdeployer</strong>), right below the definition of the <strong class="source inline">mMap</strong> variable, define a nullable <strong class="source inline">Marker</strong> variable to hold a reference to the paw marker on <span class="No-Break">the map:</span><pre class="source code">
private lateinit var mMap: GoogleMap
<strong class="bold">private var marker: Marker? = null</strong></pre></li>
				<li>Update <strong class="source inline">addMarkerAtLocation(LatLng, String)</strong> to also accept a nullable <strong class="source inline">BitmapDescriptor</strong> with a default value <span class="No-Break">of </span><span class="No-Break"><strong class="source inline">null</strong></span><span class="No-Break">:</span><pre class="source code">
private fun addMarkerAtLocation(
  location: LatLng, title: String<strong class="bold">,</strong>
  <strong class="bold">markerIcon: BitmapDescriptor? = null</strong>
) <strong class="bold">=</strong> mMap.addMarker(
  MarkerOptions().title(title).position(location)
    <strong class="bold">.apply { markerIcon?.let { icon(markerIcon) } }</strong>
)</pre></li>
			</ol>
			<p>If the <strong class="source inline">markerIcon</strong> provided<a id="_idIndexMarker667"/> is not null, the app sets it to <strong class="source inline">MarkerOptions</strong>. The function now returns the marker it added to <span class="No-Break">the map.</span></p>
			<ol>
				<li value="3">Create a <strong class="source inline">getBitmapDescriptorFromVector(Int): BitmapDescriptor?</strong> function below your <strong class="source inline">addMarkerAtLocation(LatLng, String, BitmapDescriptor?): Marker</strong> function to provide <strong class="source inline">BitmapDescriptor</strong> given a <strong class="source inline">Drawable</strong> <span class="No-Break">resource ID:</span><pre class="source code">
private fun getBitmapDescriptorFromVector(@DrawableRes vectorDrawableResourceId: Int): BitmapDescriptor? {
  val bitmap = ContextCompat.getDrawable(this,
    vectorDrawableResourceId)?.let { vectorDrawable -&gt;
      vectorDrawable.setBounds(0, 0,
        vectorDrawable.intrinsicWidth,
        vectorDrawable.intrinsicHeight)
      val drawableWithTint = DrawableCompat
        .wrap(vectorDrawable)
      DrawableCompat.setTint(drawableWithTint, Color.RED)
      val bitmap = Bitmap.createBitmap(
        vectorDrawable.intrinsicWidth,
        vectorDrawable.intrinsicHeight,
        Bitmap.Config.ARGB_8888
      )
      val canvas = Canvas(bitmap)
      drawableWithTint.draw(canvas)
      bitmap
    }
  return BitmapDescriptorFactory.fromBitmap(bitmap)
    .also { bitmap?.recycle() }
}</pre></li>
			</ol>
			<p>This function first<a id="_idIndexMarker668"/> obtains a drawable using <strong class="source inline">ContextCompat</strong> by passing in the provided resource ID. It then sets the drawing bounds for the drawable, wraps it in <strong class="source inline">DrawableCompat</strong>, and sets its tint <span class="No-Break">to red.</span></p>
			<p>Then, it creates a <strong class="source inline">Bitmap</strong> and a <strong class="source inline">Canvas</strong> for that <strong class="source inline">Bitmap</strong>, upon which it draws the tinted drawable. The bitmap is then returned to be used by <strong class="source inline">BitmapDescriptorFactory</strong> to build <strong class="source inline">BitmapDescriptor</strong>. Lastly, <strong class="source inline">Bitmap</strong> is recycled to avoid a <span class="No-Break">memory leak.</span></p>
			<ol>
				<li value="4">Before you can use the <strong class="source inline">Drawable</strong> instance, you must first create it. Right-click on the Android pane, and then select <strong class="bold">New</strong> | <span class="No-Break"><strong class="bold">Vector Asset</strong></span><span class="No-Break">.</span></li>
				<li>In the window that opens, click on the Android icon next to the <strong class="bold">Clip Art</strong> label to <a id="_idTextAnchor458"/>select a different icon (<span class="No-Break"><em class="italic">Figure 7</em></span><span class="No-Break"><em class="italic">.11</em></span><span class="No-Break">):</span></li>
			</ol>
			<div>
				<div id="_idContainer153" class="IMG---Figure">
					<img src="image/B19411_07_011.jpg" alt="Figure 7.11 – Asset Studio"/>
				</div>
			</div>
			<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 7.11 – Asset Studio</p>
			<ol>
				<li value="6">From the list <a id="_idIndexMarker669"/>of icons, select the <strong class="bold">pets</strong> icon. You can type <strong class="source inline">pets</strong> into the search field if you can’t find the icon. On<a id="_idTextAnchor459"/>ce you select the <strong class="bold">pets</strong> icon, <span class="No-Break">click </span><span class="No-Break"><strong class="bold">OK</strong></span><span class="No-Break">:</span></li>
			</ol>
			<div>
				<div id="_idContainer154" class="IMG---Figure">
					<img src="image/B19411_07_012.jpg" alt="Figure 7.12 – Selecting an icon"/>
				</div>
			</div>
			<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 7.12 – Selecting an icon</p>
			<ol>
				<li value="7">Name your icon <strong class="source inline">target_icon</strong>. Click <strong class="bold">Next</strong> <span class="No-Break">and </span><span class="No-Break"><strong class="bold">Finish</strong></span><span class="No-Break">.</span></li>
				<li>Define an <strong class="source inline">addOrMoveSelectedPositionMarker(LatLng)</strong> function to create a new marker or move it to the provided location if one has already been created. Add it after the <span class="No-Break"><strong class="source inline">getBitmapDescriptorFromVector(Int)</strong></span><span class="No-Break"> function:</span><pre class="source code">
private fun addOrMoveSelectedPositionMarker(latLng:
LatLng) {
  if (marker == null) {
    marker = addMarkerAtLocation(latLng,
      "Deploy here", getBitmapDescriptorFromVector(
        R.drawable.target_icon)
    )
  } else { marker?.apply { position = latLng } }
}</pre></li>
				<li>Update <a id="_idIndexMarker670"/>your <strong class="source inline">onMapReady(GoogleMap)</strong> function to set an <strong class="source inline">OnMapClickListener</strong> event on <strong class="source inline">mMap</strong>, which will add a marker to the clicked location or move the existing marker to the <span class="No-Break">clicked location:</span><pre class="source code">
override fun onMapReady(googleMap: GoogleMap) {
    mMap = googleMap<strong class="bold">.apply {</strong>
        <strong class="bold">setOnMapClickListener { latLng -&gt;</strong>
            <strong class="bold">addOrMoveSelectedPositionMarker(latLng)</strong>
        <strong class="bold">}</strong>
    <strong class="bold">}</strong>
    if (hasLocationPermission()) { ... }
}</pre></li>
			</ol>
			<p>Run your<a id="_idTextAnchor460"/> app. It should look like <span class="No-Break"><em class="italic">Figure 7</em></span><span class="No-Break"><em class="italic">.13</em></span><span class="No-Break">.</span></p>
			<div>
				<div id="_idContainer155" class="IMG---Figure">
					<img src="image/B19411_07_013.jpg" alt="Figure 7.13 – The complete app"/>
				</div>
			</div>
			<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 7.13 – The complete app</p>
			<p>Clicking anywhere on the map will now move the paw icon to that location. Clicking the paw icon will show the <strong class="bold">Deploy </strong><span class="No-Break"><strong class="bold">here</strong></span><span class="No-Break"> label.</span></p>
			<p class="callout heading">Note</p>
			<p class="callout">The location of the paw is a geographical one, not a screen one. That means if you drag your map or zoom in, the paw will move with the map and remain in the same <span class="No-Break">geographical location.</span></p>
			<p>You now know<a id="_idIndexMarker671"/> how to respond to user clicks on the map and add and move markers around. You also know how <a id="_idTextAnchor461"/><a id="_idTextAnchor462"/>to customize the appearance <span class="No-Break">of markers.</span></p>
			<h2 id="_idParaDest-130"><a id="_idTextAnchor463"/>Activity 7.01 – creating an app to find the location of a parked car</h2>
			<p>Some people often <a id="_idIndexMarker672"/>forget where it was that they parked their car. Let’s say you want to help these people by developing an app that lets the user store the last place they parked. The app will show a pin at the car’s location when the user launches the app. The user can click an <strong class="bold">I’m parked here</strong> button to update the pin location to the current location the next time <span class="No-Break">they park.</span></p>
			<p>Your goal in this activity is to develop an app that shows the user a map of the current location. The app must first ask the user for permission to access their location. Make sure to also provide a rationale dialog, if needed, according to <span class="No-Break">the SDK.</span></p>
			<p>The app will show a car icon where the user last told it the car was. The user can click a button labeled <strong class="bold">I’m parked here</strong> to move the car icon to the current location. When the user relaunches the app, it will show the user’s current location and the car icon where the car was <span class="No-Break">last parked.</span></p>
			<p>As a bonus feature of your app, you can choose to add functionality that stores the car’s location so that it can be restored after the user has killed and then re-opened the app. This bonus functionality relies on using <strong class="source inline">SharedPreferences</strong>; a concept that will be covered in <a href="B19411_10.xhtml#_idTextAnchor512"><span class="No-Break"><em class="italic">Chapter 10</em></span></a>, <em class="italic">Persisting Data</em>. As such, <em class="italic">steps 9</em> and <em class="italic">10</em> here will give you the <span class="No-Break">required implementation.</span></p>
			<p>The following<a id="_idIndexMarker673"/> steps will help you complete <span class="No-Break">the activity:</span></p>
			<ol>
				<li>Create a Google Maps <span class="No-Break">Activity app.</span></li>
				<li>Obtain an API key for the app and update your <strong class="source inline">google_maps_api.xml</strong> file with <span class="No-Break">that key.</span></li>
				<li>Show a button at the bottom with an <strong class="bold">I’m parked </strong><span class="No-Break"><strong class="bold">here</strong></span><span class="No-Break"> label.</span></li>
				<li>Include the location service in <span class="No-Break">your app.</span></li>
				<li>Request the user’s permission to access <span class="No-Break">their location.</span></li>
				<li>Obtain the user’s location and place a pin on the map at <span class="No-Break">that location.</span></li>
				<li>Add a car icon to <span class="No-Break">your project.</span></li>
				<li>Add functionality to move the car icon to the user’s <span class="No-Break">current location.</span></li>
				<li>Bonus step: store the selected location in <strong class="source inline">SharedPreferences</strong>. This function, placed in your activity, will help you <span class="No-Break">do this:</span><pre class="source code">
private fun saveLocation(latLng: LatLng) =
  getPreferences(MODE_PRIVATE)?.edit()?.apply {
    putString("latitude", latLng.latitude.toString())
    putString("longitude", latLng.longitude.toString())
    apply()
  }</pre></li>
				<li>Bonus step: restore any saved location from <strong class="source inline">SharedPreferences</strong>. You can use the <span class="No-Break">following function:</span><pre class="source code">
val latitude = sharedPreferences
    .getString("latitude", null)
    ?.toDoubleOrNull() ?: return null
val longitude = sharedPreferences
    .getString("longitude", null)
    ?.toDoubleOrNull() ?: return null</pre></li>
			</ol>
			<p>With this activity completed, you have demonstrated your understanding of requesting permissions in an Android app. You have also shown that you can present the user with a map and <a id="_idIndexMarker674"/>control pins on that map. Finally, you have also demonstrated your knowledge of obtaining the user’s current location. <span class="No-Break">Well done.</span></p>
			<p class="callout heading">Note</p>
			<p class="callout">The solution to this activity <a id="_idTextAnchor464"/><a id="_idTextAnchor465"/>can be found <span class="No-Break">at </span><a href="https://packt.link/By7eE"><span class="No-Break">https://packt.link/By7eE</span></a><span class="No-Break">.</span></p>
			<h1 id="_idParaDest-131"><a id="_idTextAnchor466"/>Summary</h1>
			<p>In this chapter, we learned about Android permissions. We touched on the reasons for having them and saw how we could request the user’s permission to perform certain tasks. We also learned how to use Google’s Maps API and how to present the user with an <span class="No-Break">interactive map.</span></p>
			<p>Lastly, we leveraged our knowledge of presenting a map and requesting permissions to find out the user’s current location and present it on the map. Of course, there is a lot more that can be done with the Google Maps API, and you could explore a lot more possibilities with <span class="No-Break">certain permissions.</span></p>
			<p>You should now have enough understanding of the foundations to explore further. To read more about permissions, visit <a href="https://packt.link/57BdN">https://packt.link/57BdN</a>. To read more about the Maps API, <span class="No-Break">visit </span><a href="https://packt.link/8akrP"><span class="No-Break">https://packt.link/8akrP</span></a><span class="No-Break">.</span></p>
			<p>In the next chapter, we will learn how to perform background tasks using <strong class="source inline">Services</strong> and <strong class="source inline">WorkManager</strong>. We will also learn how to present the user with notifications, even when the app is not running. These are powerful tools to have in your arsenal as a <span class="No-Break">mobile developer.</span></p>
		</div>
		<div>
			<div id="_idContainer157" class="IMG---Figure">
			</div>
		</div>
	</body></html>