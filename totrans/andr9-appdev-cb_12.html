<html><head></head><body>
        <section>

                            <header>
                    <h1 class="header-title">Multimedia</h1>
                </header>
            
            <article>
                
<p class="NormalPACKT"><span>In this chapter, we will cover the following topics:</span></p>
<ul>
<li class="BulletPACKT"><span>Playing sound effects with <kbd>SoundPool</kbd></span></li>
<li class="BulletPACKT"><span>Playing audio with <kbd>MediaPlayer</kbd></span></li>
<li class="BulletPACKT"><span>Responding to hardware media controls in your app</span></li>
<li class="BulletPACKT"><span>Taking a photo with the default camera app</span></li>
<li style="margin-bottom: .0001pt" class="BulletEndPACKT">Taking a picture using the Camera2 API</li>
</ul>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Introduction</h1>
                </header>
            
            <article>
                
<p class="NormalPACKT"><span>Now that we've explored graphics and animations in the previous chapters, it's time to look at the sound options available in Android. The two most popular options to play sound are the following:</span></p>
<ul>
<li class="BulletPACKT"><kbd>SoundPool</kbd>: This is for short sound clips</li>
<li class="BulletEndPACKT"><kbd><span class="KeyWordPACKT"><span>MediaPlayer</span></span></kbd><span>: This is</span> <span>designed for larger sound files (such as music) and video files</span></li>
</ul>
<p class="NormalPACKT"><span>The first two recipes will look at using these libraries. We'll also look at how to use hardware related to sound, such as the volume controls and media playback controls (play, pause, next and previous, often available on headphones).</span></p>
<p style="margin-bottom: .0001pt" class="NormalPACKT"><span>The rest of the chapter will focus on using the camera, both indirectly through Intents (to pass the camera request to the default camera application) and directly using the camera APIs. We'll show a complete example using  the  Camera2 APIs released with Android 5.0 Lollipop (API 21).</span></p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Playing sound effects with SoundPool</h1>
                </header>
            
            <article>
                
<p class="NormalPACKT"><span>When you need</span> <span>sound effects in your application, <kbd>SoundPool</kbd></span> <span>is usually a good starting point.</span></p>
<p class="NormalPACKT"><span><kbd>SoundPool</kbd> is interesting in that it allows us to create special effects with our sounds by changing the play rate and by allowing multiple sounds to play simultaneously.</span></p>
<p class="NormalPACKT"><span>Popular audio file types supported include:</span></p>
<ul>
<li class="BulletPACKT"><span>3GPP (</span><kbd><span class="CodeInTextPACKT"><span>.3gp</span></span></kbd><span>)</span></li>
<li class="BulletPACKT"><span>3GPP (</span><kbd><span class="CodeInTextPACKT"><span>.3gp</span></span></kbd><span>)</span></li>
<li class="BulletPACKT"><span>FLAC (</span><kbd><span class="CodeInTextPACKT"><span>.flac</span></span></kbd><span>)</span></li>
<li class="BulletPACKT"><span>MP3 (</span><kbd><span class="CodeInTextPACKT"><span>.mp3</span></span></kbd><span>)</span></li>
<li class="BulletPACKT"><span>MIDI Type 0 and 1 (</span><kbd><span class="CodeInTextPACKT"><span>.mid</span></span></kbd><span>,</span> <kbd><span class="CodeInTextPACKT"><span>.xmf</span></span></kbd><span>, and</span> <kbd><span class="CodeInTextPACKT"><span>.mxmf</span></span></kbd><span>)</span></li>
<li class="BulletPACKT"><span>Ogg (</span><kbd><span class="CodeInTextPACKT"><span>.ogg</span></span></kbd><span>)</span></li>
<li class="BulletEndPACKT"><span>WAVE (</span><kbd><span class="CodeInTextPACKT"><span>.wav</span></span></kbd><span>)</span></li>
</ul>
<p class="NormalPACKT"><span>See the <span class="ItalicsPACKT">Supported Media Formats</span> link for a complete list, including network protocols.</span></p>
<p class="NormalPACKT"><span>As is common in Android, new releases to the OS bring changes to the APIs.</span> <kbd>SoundPool</kbd> <span>is no exception and the original</span> <kbd><span class="CodeInTextPACKT"><span>SoundPool</span></span></kbd> <span>constructor was deprecated in Lollipop (API 21). Rather than setting our minimum API to 21 or relying on deprecated code (which may stop working at some point), we'll implement both the old and the new approach and check the OS version at runtime to use the appropriate method.</span></p>
<p style="margin-bottom: .0001pt" class="NormalPACKT"><span>This recipe will demonstrate how to play sound effects using the Android</span> <kbd><span class="CodeInTextPACKT"><span>SoundPool</span></span></kbd> <span>library. To demonstrate playing sounds simultaneously, we'll create two buttons, and each will play a sound when pressed.</span></p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Getting ready</h1>
                </header>
            
            <article>
                
<p class="NormalPACKT"><span>Create a new project in Android Studio and call it</span> <kbd><span class="CodeInTextPACKT"><span>SoundPool</span></span></kbd><span>. Use the default <span class="ScreenTextPACKT"><span class="packt_screen">Phone &amp; Tablet</span></span> options, and select <span class="ScreenTextPACKT"><span class="packt_screen">Empty Activity</span></span> when prompted for <span class="ScreenTextPACKT"><span class="packt_screen">Activity Type</span></span>.</span></p>
<p class="NormalPACKT"><span>To demonstrate playing sounds simultaneously, we need at least two audio files in the project. We went to SoundBible.com (<a href="http://soundbible.com/royalty-free-sounds-5.html">http://soundbible.com/royalty-free-sounds-5.html</a>)</span><span> and found two royalty-free, public-domain sounds to include in the downloaded project files.</span></p>
<p style="margin-bottom: 7.2pt" class="NormalPACKT"><span>The first sound is a longer playing so<span>und:</span></span> <a href="http://soundbible.com/2032-Water.html"><span class="URLPACKT"><span><span>http</span><span>://soundbible.com/2032-Water</span></span></span><span>.html</span></a></p>
<p style="margin-bottom: 7.2pt" class="NormalPACKT"><span>The second sound is shorter:</span> <a href="http://soundbible.com/1615-Metal-Drop.html"><span class="URLPACKT"><span>http://soundbible.com/1615-Metal-Drop.html</span></span></a></p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">How to do it...</h1>
                </header>
            
            <article>
                
<p class="NormalPACKT"><span>As explained</span> <span>before, we'll need two audio files to include</span> <span>in the project. Once you have your sound files ready, follow these steps:</span></p>
<ol>
<li class="NumberedBulletPACKT"><span>Create a new raw folder (<span class="ScreenTextPACKT"><span class="packt_screen">File</span></span> | <span class="ScreenTextPACKT"><span class="packt_screen">New</span></span> | <span class="ScreenTextPACKT"><span class="packt_screen">Android resource directory</span></span>) and choose</span> <span class="CodeInTextPACKT"><span><span class="packt_screen">raw</span></span></span> <span>in the <span class="packt_screen"><span class="ScreenTextPACKT">Resource</span></span> <span class="ScreenTextPACKT">type</span> drop-down.</span></li>
<li class="NumberedBulletPACKT"><span>Copy your sound files to</span> <kbd><span class="CodeInTextPACKT"><span>res/raw</span></span></kbd> <span>as</span> <kbd><span class="CodeInTextPACKT"><span>sound_1</span></span></kbd> <span>an</span>d <kbd>sound_2</kbd>. (<span>Keep their original extensions.)</span></li>
<li class="NumberedBulletPACKT"><span>Open</span> <kbd><span class="CodeInTextPACKT"><span>activity_main.xml</span></span></kbd> <span>and replace the existing</span> <kbd><span class="CodeInTextPACKT"><span>TextView</span></span></kbd> <span>with the following buttons:</span></li>
</ol>
<pre style="padding-left: 60px"><span>&lt;Button<br/></span><span>    </span><span>android</span><span>:id=</span><span>"@+id/button1"<br/></span><span>    </span><span>android</span><span>:layout_width=</span><span>"wrap_content"<br/></span><span>    </span><span>android</span><span>:layout_height=</span><span>"wrap_content"<br/></span><span>    </span><span>android</span><span>:text=</span><span>"Button"<br/></span><span>    </span><span>android</span><span>:onClick=</span><span>"playSound1"</span><span>/&gt;<br/></span><span>&lt;Button<br/></span><span>    </span><span>android</span><span>:id=</span><span>"@+id/button2"<br/></span><span>    </span><span>android</span><span>:layout_width=</span><span>"wrap_content"<br/></span><span>    </span><span>android</span><span>:layout_height=</span><span>"wrap_content"<br/></span><span>    </span><span>android</span><span>:text=</span><span>"Button"<br/></span><span>    </span><span>android</span><span>:onClick=</span><span>"playSound2"<br/></span><span>    </span><span>app</span><span>:layout_constraintTop_toBottomOf=</span><span>"@+id/button1"</span><span>/&gt;</span></pre>
<ol start="4">
<li class="NumberedBulletPACKT"><span>Now, open</span> <kbd><span class="CodeInTextPACKT"><span>Act</span></span><span class="CodeInTextPACKT"><span>ivityMain.java</span></span></kbd> <span>and add the following global variables:</span></li>
</ol>
<pre style="padding-left: 60px" class="CodeWithinBulletsPACKT"><span>HashMap&lt;Integer, Integer&gt; mHashMap= null;<br/></span><span>SoundPool mSoundPool;</span></pre>
<ol start="5">
<li class="NumberedBulletPACKT">Modify the exist<span>ing</span> <kbd><span class="CodeInTextPACKT"><span>onCreate()</span></span></kbd> <span>method as follows:</span></li>
</ol>
<pre style="padding-left: 60px"><span>final </span>Button button1 = findViewById(R.id.<span>button1</span>)<span>;<br/></span>button1.setEnabled(<span>false</span>)<span>;<br/></span><span>final </span>Button button2 = findViewById(R.id.<span>button2</span>)<span>;<br/></span>button2.setEnabled(<span>false</span>)<span>;<br/></span><span><br/></span><span>if </span>(Build.VERSION.<span>SDK_INT </span>&gt;= Build.VERSION_CODES.<span>LOLLIPOP</span>) {<br/>    createSoundPoolNew()<span>;<br/></span>} <span>else </span>{<br/>    createSoundPoolOld()<span>;<br/></span>}<br/><span>mSoundPool</span>.setOnLoadCompleteListener(<span>new </span>SoundPool.OnLoadCompleteListener() {<br/>    <span>@Override<br/></span><span>    </span><span>public void </span><span>onLoadComplete</span>(SoundPool soundPool<span>, int </span>sampleId<span>, int </span>status) {<br/>        <span>button1</span>.setEnabled(<span>true</span>)<span>;<br/></span><span>        </span><span>button2</span>.setEnabled(<span>true</span>)<span>;<br/></span><span>    </span>}<br/>})<span>;<br/></span><span>mHashMap </span>= <span>new </span>HashMap&lt;&gt;()<span>;<br/></span><span>mHashMap</span>.put(<span>1</span><span>, </span><span>mSoundPool</span>.load(<span>this, </span>R.raw.<span>sound_1</span><span>, </span><span>1</span>))<span>;<br/></span><span>mHashMap</span>.put(<span>2</span><span>, </span><span>mSoundPool</span>.load(<span>this, </span>R.raw.<span>sound_2</span><span>, </span><span>1</span>))<span>;</span></pre>
<ol start="6">
<li class="NumberedBulletPACKT">Add t<span>he</span> <kbd><span class="CodeInTextPACKT"><span>createSoundPoolNew()</span></span></kbd> <span>method:</span></li>
</ol>
<pre style="padding-left: 60px"><span>@TargetApi</span>(Build.VERSION_CODES.<span>LOLLIPOP</span>)<br/><span>private void </span><span>createSoundPoolNew</span>() {<br/>    AudioAttributes audioAttributes = <span>new </span>AudioAttributes.Builder()<br/>            .setUsage(AudioAttributes.<span>USAGE_MEDIA</span>)<br/>            .setContentType(AudioAttributes.<span>CONTENT_TYPE_SONIFICATION</span>)<br/>            .build()<span>;<br/></span><span>    </span><span>mSoundPool </span>= <span>new </span>SoundPool.Builder()<br/>            .setAudioAttributes(audioAttributes)<br/>            .setMaxStreams(<span>2</span>)<br/>            .build()<span>;<br/></span>}</pre>
<ol start="7">
<li class="NumberedBulletPACKT">Add th<span>e</span> <kbd><span class="CodeInTextPACKT"><span>createSoundPoolOld()</span></span></kbd> <span>method:</span></li>
</ol>
<pre style="padding-left: 60px"><span>@SuppressWarnings</span>(<span>"deprecation"</span>)<br/><span>private void </span><span>createSoundPoolOld</span>(){<br/>    <span>mSoundPool </span>= <span>new </span>SoundPool(<span>2</span><span>, </span>AudioManager.<span>STREAM_MUSIC</span><span>, </span><span>0</span>)<span>;<br/></span>}</pre>
<ol start="8">
<li class="NumberedBulletPACKT">Add the b<span>utton</span> <kbd><span class="CodeInTextPACKT"><span>onClick()</span></span></kbd> <span>methods:</span></li>
</ol>
<pre style="padding-left: 60px"><span>public void </span><span>playSound1</span>(View view){<br/>    <span>mSoundPool</span>.play(<span>mHashMap</span>.get(<span>1</span>)<span>, </span><span>0.1f</span><span>, </span><span>0.1f</span><span>, </span><span>1</span><span>, </span><span>0</span><span>, </span><span>1.0f</span>)<span>;<br/></span>}<br/><span>public void </span><span>playSound2</span>(View view){<br/>    <span>mSoundPool</span>.play(<span>mHashMap</span>.get(<span>2</span>)<span>, </span><span>0.9f</span><span>, </span><span>0.9f</span><span>, </span><span>1</span><span>, </span><span>1</span><span>, </span><span>1.0f</span>)<span>;<br/></span>}</pre>
<p class="mce-root"/>
<p class="mceNonEditable"/>
<ol start="9">
<li class="NumberedBulletPACKT">Override t<span>he</span> <kbd><span class="CodeInTextPACKT"><span>onStop()</span></span></kbd> <span>callback as follows:</span></li>
</ol>
<pre style="padding-left: 60px"><span>@Override<br/></span><span>protected void </span><span>onStop</span>() {<br/>    <span>mSoundPool</span>.release()<span>;<br/></span><span>    super</span>.onStop()<span>;<br/></span>}</pre>
<ol start="10">
<li style="margin-bottom: .0001pt" class="NumberedBulletEndPACKT">Run the app<span>lication on a device or emulator.</span></li>
</ol>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">How it works...</h1>
                </header>
            
            <article>
                
<p class="NormalPACKT"><span>The first detail to</span> <span>notice is how we construct the</span> <span>object itself. As we mentioned in the introduction, the <kbd>SoundPool</kbd> constructor was changed in Lollipop (API 21). The old constructor was deprecated in favor of using</span> <kbd><span class="CodeInTextPACKT"><span>SoundPool.Builder()</span></span></kbd><span>. With a constantly changing environment such as Android, changes in the API are very common, so it's a good idea to learn how to work with the changes. As you can see, it's not difficult in this case. We just check the current OS version and call the appropriate method. It is worth noting the two method annotations.  The first specifies the target API:</span></p>
<p class="CodeEndPACKT"><kbd><span>@TargetApi(Build.VERSION_CODES.LOLLIPOP)</span></kbd></p>
<p class="NormalPACKT"><span>And the second suppresses the deprecation warning:</span></p>
<p class="CodeEndPACKT"><kbd><span>@SuppressWarnings("deprecation")</span></kbd></p>
<p class="NormalPACKT"><span>After creating <kbd>SoundPool</kbd>, we set a</span> <kbd><span class="CodeInTextPACKT"><span>setOnLoadCompleteListener()</span></span></kbd> <span>listener. Enabling the buttons is mostly for demonstration purposes to illustrate that <kbd>SoundPool</kbd> needs to load sound resources before they are available.</span></p>
<p style="margin-bottom: .0001pt" class="NormalPACKT"><span>The final point to make on using <kbd>SoundPool</kbd> is the call to</span> <kbd><span class="CodeInTextPACKT"><span>play()</span></span></kbd><span>. We need to pass in the</span> <kbd><span class="CodeInTextPACKT"><span>soundID</span></span></kbd><span>, which was returned when we loaded the sound using</span> <kbd><span class="CodeInTextPACKT"><span>load()</span></span></kbd><span>.</span> <kbd><span>p</span><span class="CodeInTextPACKT"><span>lay()</span></span></kbd> <span>gives us a few options, including sound volume (left and right), loop count, and playback rate. To demonstrate its flexibility, we play the first sound (which is longer) at a lower volume to create more of a background effect with the running water. The second sound plays at a higher volume and we play it twice.</span></p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">There's more...</h1>
                </header>
            
            <article>
                
<p class="NormalPACKT"><span>If you only need a basic sound effect, such as a click, you can use the <kbd>AudioManager</kbd></span> <kbd><span class="CodeInTextPACKT"><span>playSoundEffect()</span></span></kbd> <span>method. Here's an example:</span></p>
<pre>AudioManager audioManager =(AudioManager)<br/>this.getSystemService(Context.AUDIO_SERVICE);<br/>audioManager.playSoundEffect(SoundEffectConstants.CLICK);</pre>
<p style="margin-bottom: .0001pt" class="NormalPACKT"><span>You can only specify a sound from the</span> <kbd><span class="CodeInTextPACKT"><span>SoundEffectConstants</span></span></kbd><span>; you cannot use your own sound files.</span></p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">See also</h1>
                </header>
            
            <article>
                
<ul>
<li class="BulletPACKT"><span class="ScreenTextPACKT"><span><kbd>SoundPool</kbd> Developer</span></span> <span class="ScreenTextPACKT"><span>Docs: </span></span><a href="https://developer.android.com/reference/android/media/SoundPool.html"><span class="URLPACKT">https://developer.android.com/reference/android/media/SoundPool.html</span></a></li>
</ul>
<ul>
<li style="margin-bottom: 4.3pt" class="BulletEndPACKT"><span class="ScreenTextPACKT"><span><kbd>AudioManager</kbd> Developer</span></span> <span class="ScreenTextPACKT"><span>Docs<span>: </span></span></span><a href="https://developer.android.com/reference/android/media/AudioManager.html"><span class="URLPACKT">https://developer.android.com/reference/android/media/Audi</span><span class="ScreenTextPACKT">oManager.html</span></a></li>
</ul>
<p> </p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Playing audio with MediaPlayer</h1>
                </header>
            
            <article>
                
<p class="NormalPACKT"><span>MediaPlayer</span> <span>is probably one of the most important classes for adding multimedia capability to your applications. It supports the following media sources:</span></p>
<ul>
<li class="BulletPACKT"><span>Project resources</span></li>
<li class="BulletPACKT"><span>Local files</span></li>
<li class="BulletEndPACKT"><span>External resources (such as URLs, including streaming)</span></li>
</ul>
<p class="NormalPACKT"><span>MediaPlayer supports the following popular</span> <span>audio files:</span></p>
<ul>
<li class="BulletPACKT"><span>3GPP (</span><kbd><span class="CodeInTextPACKT"><span>.3gp</span></span></kbd><span>)</span></li>
<li class="BulletPACKT"><span>3GPP (</span><kbd><span class="CodeInTextPACKT"><span>.3gp</span></span></kbd><span>)</span></li>
<li class="BulletPACKT"><span>FLAC (</span><kbd><span class="CodeInTextPACKT"><span>.flac</span></span></kbd><span>)</span></li>
<li class="BulletPACKT"><span>MP3 (</span><kbd><span class="CodeInTextPACKT"><span>.mp3</span></span></kbd><span>)</span></li>
<li class="BulletPACKT"><span>MIDI Type 0 and 1 (</span><kbd><span class="CodeInTextPACKT"><span>.mid</span></span></kbd><span>,</span> <kbd><span class="CodeInTextPACKT"><span>.xmf</span></span></kbd><span>, and</span> <kbd><span class="CodeInTextPACKT"><span>.mxmf</span></span></kbd><span>)</span></li>
<li class="BulletPACKT"><span>Ogg (</span><kbd><span class="CodeInTextPACKT"><span>.ogg</span></span></kbd><span>)</span></li>
<li class="BulletEndPACKT"><span>WAVE (</span><kbd><span class="CodeInTextPACKT"><span>.wav</span></span></kbd><span>)</span></li>
</ul>
<p class="NormalPACKT"><span>And it supports these popular</span> <span>file types:</span></p>
<ul>
<li class="BulletPACKT"><span>3GPP (</span><kbd><span class="CodeInTextPACKT"><span>.3gp</span></span></kbd><span>)</span></li>
<li class="BulletPACKT"><span>Matroska (</span><kbd><span class="CodeInTextPACKT"><span>.mkv</span></span></kbd><span>)</span></li>
<li class="BulletPACKT"><span>WebM (</span><kbd><span class="CodeInTextPACKT"><span>.webm</span></span></kbd><span>)</span></li>
<li class="BulletEndPACKT"><span>MPEG-4 (</span><kbd><span class="CodeInTextPACKT"><span>.mp4</span></span></kbd><span>,</span> <kbd><span class="CodeInTextPACKT"><span>.m4a</span></span></kbd><span>)</span></li>
</ul>
<p class="NormalPACKT"><span>See the <span class="ItalicsPACKT">Supported Media Formats</span> link for a complete list, including network protocols.</span></p>
<p style="margin-bottom: .0001pt" class="NormalPACKT"><span>This recipe will</span> <span>demonstrate</span> <span>how to set up <kbd>MediaPlayer</kbd> in your app to play a sound included with your project. (For a complete review of the full capability offered by <kbd>MediaPlayer</kbd>, see the Developer Docs link at the end of this recipe.)</span></p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Getting ready</h1>
                </header>
            
            <article>
                
<p class="NormalPACKT"><span>Create a new project in Android Studio and call it</span> <kbd><span class="CodeInTextPACKT"><span>MediaPlayer</span></span></kbd><span>. Use the default <span class="ScreenTextPACKT"><span class="packt_screen">Phone &amp; Tablet</span></span> options and select <span class="ScreenTextPACKT"><span class="packt_screen">Empty Activity</span></span> when prompted for <span class="ScreenTextPACKT"><span class="packt_screen">Activity Type</span></span>.</span></p>
<p class="NormalPACKT"><span>We will also need a sound for this recipe and will use the same longer playing "water" sound used in the previous recipe:</span></p>
<p class="mce-root"><a href="http://soundbible.com/2032-Water.html">http://soundbible.com/2032-Water.html</a></p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">How to do it...</h1>
                </header>
            
            <article>
                
<p class="NormalPACKT"><span>As explained</span> <span>previously, we'll need a sound file to include in the</span> <span>project. Once you have your sound file ready, follow these steps:</span></p>
<ol>
<li class="NormalPACKT"><span>Create a new raw folder (<span class="ScreenTextPACKT"><span class="packt_screen">File</span></span> | <span class="ScreenTextPACKT"><span class="packt_screen">New</span></span> | <span class="ScreenTextPACKT"><span class="packt_screen">Android resource directory</span></span>) and chose</span> <span class="CodeInTextPACKT"><span class="packt_screen">raw</span></span> <span>in the <span class="packt_screen">R<span class="ScreenTextPACKT">esource</span></span> <span class="ScreenTextPACKT">type</span> dropdo</span><span>wn.</span></li>
<li><span>Copy your sound file to</span> <kbd><span class="CodeInTextPACKT"><span>res/raw</span></span></kbd> <span>as</span> <kbd><span class="CodeInTextPACKT"><span>sound_1</span></span></kbd><span>. (Keep the original extension.)</span></li>
<li class="NumberedBulletPACKT"><span>Open</span> <kbd><span class="CodeInTextPACKT"><span>activity_main.xml</span></span></kbd> <span>and replace the existing</span> <kbd><span class="CodeInTextPACKT"><span>TextView</span></span></kbd> <span>with the following buttons:</span></li>
</ol>
<pre style="padding-left: 60px"><span>&lt;Button<br/></span><span>    </span><span>android</span><span>:id=</span><span>"@+id/buttonPlay"<br/></span><span>    </span><span>android</span><span>:layout_width=</span><span>"100dp"<br/></span><span>    </span><span>android</span><span>:layout_height=</span><span>"wrap_content"<br/></span><span>    </span><span>android</span><span>:text=</span><span>"Play"<br/></span><span>    </span><span>android</span><span>:onClick=</span><span>"buttonPlay" </span><span>/&gt;<br/></span><span>&lt;Button<br/></span><span>    </span><span>android</span><span>:text=</span><span>"Pause"<br/></span><span>    </span><span>android</span><span>:layout_width=</span><span>"100dp"<br/></span><span>    </span><span>android</span><span>:layout_height=</span><span>"wrap_content"<br/></span><span>    </span><span>android</span><span>:id=</span><span>"@+id/buttonPause"<br/></span><span>    </span><span>android</span><span>:onClick=</span><span>"buttonPause"<br/></span><span>    </span><span>app</span><span>:layout_constraintTop_toBottomOf=</span><span>"@+id/buttonPlay"</span><span>/&gt;<br/></span><span>&lt;Button<br/></span><span>    </span><span>android</span><span>:text=</span><span>"Stop"<br/></span><span>    </span><span>android</span><span>:layout_width=</span><span>"100dp"<br/></span><span>    </span><span>android</span><span>:layout_height=</span><span>"wrap_content"<br/></span><span>    </span><span>android</span><span>:id=</span><span>"@+id/buttonStop"<br/></span><span>    </span><span>android</span><span>:onClick=</span><span>"buttonStop"<br/></span><span>    </span><span>app</span><span>:layout_constraintTop_toBottomOf=</span><span>"@+id/buttonPause"</span><span>/&gt;</span></pre>
<ol start="4">
<li class="NumberedBulletPACKT"><span>Now, open</span> <kbd><span class="CodeInTextPACKT"><span>ActivityM</span></span><span class="CodeInTextPACKT"><span>ain.java</span></span></kbd> <span>and add the following global variable:</span></li>
</ol>
<pre style="padding-left: 60px" class="CodeWithinBulletsEndPACKT"><span>MediaPlayer mMediaPlayer;</span></pre>
<ol start="5">
<li class="NumberedBulletPACKT">Add the <kbd>but<span class="CodeInTextPACKT"><span>tonPlay()</span></span></kbd> <span>method:</span></li>
</ol>
<pre style="padding-left: 60px" class="CodeWithinBulletsPACKT"><span>public void buttonPlay(View view){<br/></span><span>    if (mMediaPlayer==null) {<br/></span><span>        mMediaPlayer = MediaPlayer.create(this, R.raw.sound_1);<br/></span><span>        mMediaPlayer.setLooping(true);<br/></span><span>        mMediaPlayer.start();<br/></span><span>    } else  {<br/></span><span>        mMediaPlayer.start();<br/></span><span>    }<br/></span><span>}</span></pre>
<ol start="6">
<li class="NumberedBulletPACKT"><span>Add the</span> <kbd><span class="CodeInTextPACKT"><span>buttonPause</span></span><span class="CodeInTextPACKT"><span>()</span></span></kbd> <span>method:</span></li>
</ol>
<pre style="padding-left: 60px" class="CodeWithinBulletsPACKT"><span>public void buttonPause(View view){<br/></span><span>    if (mMediaPlayer!=null &amp;&amp; mMediaPlayer.isPlaying()) {<br/></span><span>        mMediaPlayer.pause();<br/></span><span>    }<br/></span><span>}</span></pre>
<ol start="7">
<li class="NumberedBulletPACKT">Add the <kbd><span class="CodeInTextPACKT"><span>buttonStop()</span></span></kbd> <span>method:</span></li>
</ol>
<pre style="padding-left: 60px" class="CodeWithinBulletsPACKT"><span>public void buttonStop(View view){<br/></span><span>    if (mMediaPlayer!=null) {<br/></span><span>        mMediaPlayer.stop();<br/></span><span>        mMediaPlayer.release();<br/></span><span>        mMediaPlayer = null;<br/></span><span>    }<br/></span><span>}</span></pre>
<ol start="8">
<li class="NumberedBulletPACKT">Finally, override <span>the</span> <kbd><span class="CodeInTextPACKT"><span>onStop()</span></span></kbd> <span>callback with the</span> <span>following code:</span></li>
</ol>
<pre style="padding-left: 60px"><span>@Override<br/></span><span>protected void </span><span>onStop</span>() {<br/>    <span>super</span>.onStop()<span>;<br/></span><span>    if </span>(<span>mMediaPlayer</span>!=<span>null</span>) {<br/>        <span>mMediaPlayer</span>.release()<span>;<br/></span><span>        </span><span>mMediaPlayer </span>= <span>null;<br/></span><span>    </span>}<br/>}</pre>
<ol start="9">
<li class="NumberedBulletEndPACKT"><span>You're ready to ru</span><span>n the application on a device or emulator.</span></li>
</ol>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">How it works...</h1>
                </header>
            
            <article>
                
<p class="NormalPACKT"><span>The code here is pretty straightforward. We create</span> MediaPlayer <span>with our sound and start playing the sound. The buttons will replay, pause, and stop accordingly.</span></p>
<p style="margin-bottom: .0001pt" class="NormalPACKT"><span>Even this basic example illustrates one very important concept regarding MediaPlayer, and that is the <span class="ItalicsPACKT">state</span>. If you're making serious use of MediaPlayer, review the link provided later for detailed information.</span></p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">There's more...</h1>
                </header>
            
            <article>
                
<p class="NormalPACKT"><span>To make our</span> <span>demonstration easier to follow, we use the UI</span> <span>thread for all our operations. For this example, using a short audio file included with the project, we aren't likely to experience any UI delays. In general, it's a good idea to use a background thread when preparing <kbd>MediaPlayer</kbd>. To make this common task easier, <kbd>MediaPlayer</kbd> already includes an asynchronous prepare method called</span> <kbd><span class="CodeInTextPACKT"><span>prepareAsync()</span></span></kbd><span>. The following code will create an</span> <kbd><span class="CodeInTextPACKT"><span>OnPreparedListener()</span></span></kbd> <span>listener and use the</span> <kbd><span class="CodeInTextPACKT"><span>prepareAsync()</span></span></kbd> <span>method:</span></p>
<pre><span>mMediaPlayer </span>= <span>new </span>MediaPlayer()<span>;<br/></span><span>mMediaPlayer</span>.setOnPreparedListener(<span>new </span>MediaPlayer.OnPreparedListener() {<br/>    <span>@Override<br/></span><span>    </span><span>public void </span><span>onPrepared</span>(MediaPlayer mp) {<br/>        <span>mMediaPlayer</span>.start()<span>;<br/></span><span>    </span>}<br/>})<span>;<br/></span><span>try </span>{<br/>    <span>mMediaPlayer</span>.setDataSource(<span>/*URI, URL or path here*/</span>))<span>;<br/></span>} <span>catch </span>(IOException e) {<br/>    e.printStackTrace()<span>;<br/></span>}<br/><span>mMediaPlayer</span>.prepareAsync()<span>;</span></pre>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Playing music in the background</h1>
                </header>
            
            <article>
                
<p class="NormalPACKT"><span>Our example is</span> <span>meant to play audio when the application is in the</span> <span>foreground, and will release the <kbd>MediaPlayer</kbd> resources in the</span> <kbd>onStop()</kbd> <span>callback. What if you are creating a music player and want to play music in the background, even when the user is using another application? In that scenario, you'll want to use <kbd>MediaPlayer</kbd> in a service, instead of an activity. You'll use the <kbd>MediaPlayer</kbd> library the same way; you'll just need to pass information (such as sound selection) from the UI to your service.</span></p>
<div class="packt_infobox">
<p>Note that since a service runs in the same UI thread as the activities, you still do not want to perform potentially blocking operations in a service. MediaPlayer does handle background threads to prevent blocking your UI thread; otherwise, you would want to perform threading yourself. (See <a href="98c7bc7b-43e2-43de-aed4-fe2fb6dc72f3.xhtml" target="_blank">Chapter 15</a>, <em>Getting Your App Ready for the Play Store</em> for more information on threading and options.)</p>
</div>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Using hardware volume keys to control your app's audio volume</h1>
                </header>
            
            <article>
                
<p class="NormalPACKT"><span>If you want the</span> <span>volume controls to control the volume in your app, use the</span> <kbd><span class="CodeInTextPACKT"><span>setVolumeControlStream()</span></span></kbd> <span>method to specify your application's audio stream, as follows:</span></p>
<pre>setVolumeControlStream(AudioManager.STREAM_MUSIC)<span>;</span></pre>
<p style="margin-bottom: .0001pt" class="NormalPACKT"><span>See the</span> <kbd><span class="CodeInTextPACKT"><span>AudioManager</span></span></kbd> <span>link below for other streaming options.</span></p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">See also</h1>
                </header>
            
            <article>
                
<ul>
<li class="NormalPACKT"><span><span>Supported media formats:</span> <a href="https://developer.android.com/guide/appendix/media-formats.html"><span class="URLPACKT"><span>https://developer.android.com/guide</span></span>/appendix/media-formats.html</a></span></li>
<li class="NormalPACKT"><span><kbd>MediaPlayer</kbd> developer</span> d<span>ocs:</span> <a href="http://developer.android.com/reference/android/media/MediaPlayer.html"><span class="URLPACKT"><span>http://developer.android.com/reference/android/media/MediaPlayer.html</span></span></a></li>
<li style="margin-bottom: .0001pt" class="BulletEndPACKT"><span class="ScreenTextPACKT"><span><kbd>AudioManager</kbd> developer</span></span> d<span class="ScreenTextPACKT"><span>ocs:</span></span> <a href="https://developer.android.com/reference/android/media/AudioManager.html"><span class="URLPACKT"><span>https://developer.android.com/reference/android/media/AudioManager.html</span></span></a></li>
</ul>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Responding to hardware media controls in your app</h1>
                </header>
            
            <article>
                
<p class="NormalPACKT"><span>Having your app respond to</span> <span>media controls (like on headphones), such as Play, Pause, Skip, and so on, is a nice touch your users will appreciate.</span> <span>Android makes this possible through the media library. As with the <em><span class="ItalicsPACKT">Playing sound effects with SoundPool</span></em> recipe earlier, the Lollipop release changed how this is done. Unlike the</span> <kbd><span class="CodeInTextPACKT"><span>SoundPool</span></span></kbd> <span>example, this recipe is able to take advantage of another approach, the compatibility library.</span></p>
<p style="margin-bottom: .0001pt" class="NormalPACKT"><span>This recipe will show you how to set up</span> <kbd><span class="CodeInTextPACKT"><span>MediaSession</span></span></kbd> <span>to respond to the hardware buttons, which will work on Lollipop and later, as well as previous</span> Lollipop <span>versions using the</span> <kbd><span class="CodeInTextPACKT"><span>MediaSessionCompat</span></span></kbd> <span>library. (The compatibility library will take care of checking the OS version and using the correct API calls automatically.)</span></p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Getting ready</h1>
                </header>
            
            <article>
                
<p style="margin-bottom: .0001pt" class="NormalPACKT"><span>Create a new project in Android Studio and call it</span> <kbd><span class="CodeInTextPACKT"><span>HardwareMediaControls</span></span></kbd><span>.  </span><span class="s1">Use the default </span><span class="packt_screen"><span class="s2">Phone &amp; Tablet</span><span class="s1"> </span></span><span class="s1">options and select </span><span class="s2"><span class="packt_screen">Empty Activity</span></span><span class="s1"> on the</span><span class="packt_screen"><span class="s1"> </span><span class="s2">Add an Activity</span></span> <span class="s2">to <span class="packt_screen">Mobile</span></span><span class="s1"> dialog.</span></p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">How to do it...</h1>
                </header>
            
            <article>
                
<p class="NormalPACKT"><span>We'll just be using Toast messages to respond to the hardware events and therefore will not need to make any changes to the activity layout. The first step is to add the V13 support library to the project. Start by opening </span><kbd>build.gradle (Module: app)</kbd> <span>and perform the following steps:</span></p>
<ol>
<li><span>Add the following library to the dependency section:</span></li>
</ol>
<pre style="padding-left: 60px">implementation <span>'com.android.support:support-v13:28.0.0-rc02'</span></pre>
<ol start="2">
<li>Next, open <kbd><span class="CodeInTextPACKT">ActivityMain.java</span></kbd> <span>and add the following <kbd><span class="CodeInTextPACKT">mMediaSessionCallback</span></kbd> <span>to the class declaration:</span></span></li>
</ol>
<pre style="padding-left: 60px">MediaSessionCompat.Callback <span>mMediaSessionCallback </span>= <span>new </span>MediaSessionCompat.Callback() {<br/>    <span>@Override<br/></span><span>    </span><span>public void </span><span>onPlay</span>() {<br/>        <span>super</span>.onPlay()<span>;<br/></span><span>        </span>Toast.<span>makeText</span>(MainActivity.<span>this, </span><span>"onPlay()"</span><span>, </span>Toast.<span>LENGTH_SHORT</span>).show()<span>;<br/></span><span>    </span>}<br/>    <span>@Override<br/></span><span>    </span><span>public void </span><span>onPause</span>() {<br/>        <span>super</span>.onPause()<span>;<br/></span><span>        </span>Toast.<span>makeText</span>(MainActivity.<span>this, </span><span>"onPause()"</span><span>, </span>Toast.<span>LENGTH_SHORT</span>).show()<span>;<br/></span><span>    </span>}<br/>    <span>@Override<br/></span><span>    </span><span>public void </span><span>onSkipToNext</span>() {<br/>        <span>super</span>.onSkipToNext()<span>;<br/></span><span>        </span>Toast.<span>makeText</span>(MainActivity.<span>this, </span><span>"onSkipToNext()"</span><span>, </span>Toast.<span>LENGTH_SHORT</span>).show()<span>;<br/></span><span>    </span>}<br/>    <span>@Override<br/></span><span>    </span><span>public void </span><span>onSkipToPrevious</span>() {<br/>        <span>super</span>.onSkipToPrevious()<span>;<br/></span><span>        </span>Toast.<span>makeText</span>(MainActivity.<span>this, </span><span>"onSkipToPrevious()"</span><span>, </span>Toast.<span>LENGTH_SHORT</span>).show()<span>;<br/></span><span>    </span>}<br/>}<span>;</span></pre>
<ol start="3">
<li>Add the following code <span>to the existing</span> <kbd><span class="CodeInTextPACKT"><span>onCreate()</span></span></kbd> <span>callback:</span></li>
</ol>
<pre style="padding-left: 60px">MediaSessionCompat mediaSession = <br/>        <span>new </span>MediaSessionCompat(<span>this, </span>getApplication().getPackageName())<span>;<br/></span>mediaSession.setCallback(<span>mMediaSessionCallback</span>)<span>;<br/></span>mediaSession.setFlags(MediaSessionCompat.<span>FLAG_HANDLES_MEDIA_BUTTONS</span>)<span>;<br/></span>mediaSession.setActive(<span>true</span>)<span>;<br/></span>PlaybackStateCompat state = <span>new </span>PlaybackStateCompat.Builder()<br/>        .setActions(PlaybackStateCompat.<span>ACTION_PLAY </span>|<br/>                PlaybackStateCompat.<span>ACTION_PLAY_PAUSE </span>|<br/>                PlaybackStateCompat.<span>ACTION_PAUSE </span>|<br/>                PlaybackStateCompat.<span>ACTION_SKIP_TO_NEXT </span>|<br/>                PlaybackStateCompat.<span>ACTION_SKIP_TO_PREVIOUS</span>).build()<span>;<br/></span>mediaSession.setPlaybackState(state)<span>;</span></pre>
<ol start="4">
<li>Run the applic<span>ation on a device or emulator with media controls (such as headphones) to see the Toast messages.</span></li>
</ol>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">How it works...</h1>
                </header>
            
            <article>
                
<p class="NormalPACKT"><span>There are four steps to</span> <span>setting this up:</span></p>
<ol>
<li class="NumberedBulletPACKT"><span>Create a</span> <kbd><span class="CodeInTextPACKT"><span>MediaSession.Callback</span></span></kbd> <span>and attach it to <kbd>MediaSession</kbd></span></li>
<li class="NumberedBulletPACKT"><span>Set the <kbd>MediaSession</kbd> flags to indicate we want media buttons</span></li>
<li class="NumberedBulletPACKT"><span>Set</span> <kbd><span class="CodeInTextPACKT"><span>SessionState</span></span></kbd> <span>to</span> <span class="CodeInTextPACKT"><span>active</span></span></li>
<li class="NumberedBulletEndPACKT"><span>Set</span> <kbd><span class="CodeInTextPACKT"><span>PlayBackState</span></span></kbd> <span>with the actions we're going to handle</span></li>
</ol>
<p class="NormalPACKT"><span>Steps 4 and 1 work together as the callback will only get the events set in the</span> <kbd><span class="CodeInTextPACKT"><span>PlayBackState</span></span></kbd><span>.</span></p>
<p class="NormalPACKT"><span>Since we're not actually controlling any playback in this recipe, we just demonstrate how to respond to the hardware events. You'll want to implement actual functionality in</span> <kbd><span class="CodeInTextPACKT"><span>PlayBackState</span></span></kbd> <span>and include a call to</span> <kbd><span class="CodeInTextPACKT"><span>setState()</span></span></kbd> <span>after the</span> <kbd><span class="CodeInTextPACKT"><span>setActions()</span></span></kbd> <span>call.</span></p>
<p style="margin-bottom: .0001pt" class="NormalPACKT"><span>This is a very nice example of how the changes to the API can make things easier. And since the new</span> <kbd><span class="CodeInTextPACKT"><span>MediaSession</span></span></kbd> <span>and</span> <kbd><span class="CodeInTextPACKT"><span>PlaybackState</span></span></kbd> <span>were rolled into the <kbd>Compatibility</kbd> library, we can take advantage of these new APIs on older versions of the OS.</span></p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">There's more...</h1>
                </header>
            
            <article>
                
<p>With all the variety of hardware available on the market, how can your app check what is being used?</p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Checking the hardware type</h1>
                </header>
            
            <article>
                
<p class="NormalPACKT"><span>If you want your app to respond differently based on the current output hardware, you can use</span> <kbd><span class="CodeInTextPACKT"><span>AudioManager</span></span></kbd> <span>to check. The following is an example:</span></p>
<pre class="CodePACKT"><span>AudioManager audioManager =(AudioManager) this.getSystemService(Context.AUDIO_SERVICE);<br/></span><span>if (audioManager.isBluetoothA2dpOn()) {<br/></span><span>    // Adjust output for Bluetooth.<br/></span><span>} else if (audioManager.isSpeakerphoneOn()) {<br/></span><span>    // Adjust output for Speakerphone.<br/></span><span>} else if (audioManager.isWiredHeadsetOn()) {<br/></span><span>    //Only checks if a wired headset is plugged in<br/></span><span>    //May not be the audio output<br/></span><span>} else {<br/></span><span>    // Regular speakers?<br/></span><span>}</span></pre>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">See also</h1>
                </header>
            
            <article>
                
<ul>
<li class="BulletPACKT"><span class="ScreenTextPACKT"><span><kbd>MediaSession</kbd> developer</span></span> d<span class="ScreenTextPACKT"><span>ocs:</span></span> <a href="https://developer.android.com/reference/android/media/session/MediaSession.html"><span class="URLPACKT"><span>https://developer.android.com/reference/android/media/session/MediaSession.html</span></span></a></li>
</ul>
<ul>
<li class="BulletPACKT"><span class="ScreenTextPACKT"><span><kbd>MediaSessionCompat</kbd> developer</span></span> d<span class="ScreenTextPACKT"><span>ocs:</span></span> <a href="https://developer.android.com/reference/android/support/v4/media/session/MediaSessionCompat.html"><span class="URLPACKT"><span>https://developer.android.com/reference/android/support/v4/media/session/MediaSessionCompat.html</span></span></a></li>
</ul>
<ul>
<li class="BulletPACKT"><span class="ScreenTextPACKT"><span><kbd>PlaybackState</kbd> developer</span></span> d<span class="ScreenTextPACKT"><span>ocs:</span></span> <a href="https://developer.android.com/reference/android/support/v4/media/session/PlaybackStateCompat.html"><span class="URLPACKT"><span>https://developer.android.com/reference/android/support/v4/media/session/PlaybackStateCompat.html</span></span></a></li>
</ul>
<ul>
<li style="margin-bottom: 4.3pt" class="BulletEndPACKT"><span class="ScreenTextPACKT"><span><kbd>PlaybackStateCompat</kbd> developer</span></span> d<span class="ScreenTextPACKT"><span>ocs:</span></span> <a href="https://developer.android.com/reference/android/support/v4/media/session/PlaybackStateCompat.html"><span class="URLPACKT"><span>https://developer.android.com/reference/android/support/v4/media/session/PlaybackStateCompat.html</span></span></a></li>
</ul>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Taking a photo with the default camera app</h1>
                </header>
            
            <article>
                
<p class="NormalPACKT"><span>If your application needs an</span> <span>image from the camera, but is not a camera</span> <span>replacement app, it may be better to allow the default camera app to take the picture. This also respects your user's preferred camera application.</span></p>
<p style="margin-bottom: .0001pt" class="NormalPACKT"><span>When you take a photo, unless it is specific to your application, it's considered good practice to make the photo publicly available. (This allows it to be included in the user's photo gallery.) This recipe will demonstrate using the default photo application to click a picture, save it to the public folder, and display the image.</span></p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Getting ready</h1>
                </header>
            
            <article>
                
<p style="margin-bottom: .0001pt" class="NormalPACKT"><span>Create a new project in Android Studio and call it</span> <kbd><span class="CodeInTextPACKT"><span>UsingTheDefaultCameraApp</span></span></kbd><span>.  </span><span class="s1">Use the default </span><span class="s2"><span class="packt_screen">Phone &amp; Tablet</span></span><span class="s1"> options and select </span><span class="s2"><span class="packt_screen">Empty Activity</span></span><span class="s1"> on the </span><span class="s2"><span class="packt_screen">Add an Activity</span> to <span class="packt_screen">Mobile</span></span><span class="s1"> dialog.</span></p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">How to do it...</h1>
                </header>
            
            <article>
                
<p class="NormalPACKT"><span>We're going to create a layout with an</span> ImageView and button. The button will create an Intent to launch the default Camera app. When the camera app is done, our app will get a callback. We'll check the result and display the picture if available. Start by opening the Android Manifest and follow these steps:</p>
<ol>
<li class="NumberedBulletPACKT"><span>Add the following permission:</span></li>
</ol>
<pre style="padding-left: 60px"><span>&lt;uses-permission </span><span>android</span><span>:name=</span><span>"android.permission.READ_EXTERNAL_STORAGE" </span><span>/&gt;</span></pre>
<ol start="2">
<li class="NumberedBulletPACKT"><span>Open</span> <kbd><span class="CodeInTextPACKT"><span>activity_</span></span><span class="CodeInTextPACKT"><span>main.xml</span></span></kbd><span> and replace the existing</span> <span class="CodeInTextPACKT"><span>TextView</span></span> <span>with the following views:</span></li>
</ol>
<pre style="padding-left: 60px"><span>&lt;android.support.v7.widget.AppCompatImageView<br/></span><span> </span><span>android</span><span>:id=</span><span>"@+id/imageView"<br/></span><span> </span><span>android</span><span>:layout_width=</span><span>"wrap_content"<br/></span><span> </span><span>android</span><span>:layout_height=</span><span>"wrap_content"<br/></span><span> </span><span>android</span><span>:src=</span><span>"@mipmap/ic_launcher"<br/></span><span> </span><span>app</span><span>:layout_constraintTop_toTopOf=</span><span>"parent"<br/></span><span> </span><span>app</span><span>:layout_constraintLeft_toLeftOf=</span><span>"parent"<br/></span><span> </span><span>app</span><span>:layout_constraintRight_toRightOf=</span><span>"parent" </span><span>/&gt;<br/></span><span>&lt;android.support.v7.widget.AppCompatButton<br/></span><span> </span><span>android</span><span>:id=</span><span>"@+id/button"<br/></span><span> </span><span>android</span><span>:layout_width=</span><span>"wrap_content"<br/></span><span> </span><span>android</span><span>:layout_height=</span><span>"wrap_content"<br/></span><span> </span><span>android</span><span>:text=</span><span>"Take Picture"<br/></span><span> </span><span>android</span><span>:onClick=</span><span>"takePicture"<br/></span><span> </span><span>app</span><span>:layout_constraintBottom_toBottomOf=</span><span>"parent"<br/></span><span> </span><span>app</span><span>:layout_constraintLeft_toLeftOf=</span><span>"parent"<br/></span><span> </span><span>app</span><span>:layout_constraintRight_toRightOf=</span><span>"parent"</span><span>/&gt;</span></pre>
<ol start="3">
<li class="NumberedBulletPACKT">Open <kbd>MainActi<span class="CodeInTextPACKT"><span>vity.java</span></span></kbd> <span>and add the following global variables to the</span> <kbd><span class="CodeInTextPACKT"><span>MainActivity</span></span></kbd> <span>class:</span></li>
</ol>
<pre style="padding-left: 60px" class="CodeWithinBulletsPACKT"><span>final int PHOTO_RESULT=1;<br/></span><span>private Uri mLastPhotoURI=null;</span></pre>
<ol start="4">
<li class="NumberedBulletPACKT"><span>Add the</span> <span>following metho</span><span>d to create the URI for</span> <span>the photo:</span></li>
</ol>
<pre style="padding-left: 60px"><span>private </span>Uri <span>createFileURI</span>() {<br/>    String timeStamp = <span>new </span>SimpleDateFormat(<span>"yyyyMMdd_HHmmss"</span>)<br/>            .format(System.<span>currentTimeMillis</span>())<span>;<br/></span><span>    </span>String fileName = <span>"PHOTO_" </span>+ timeStamp + <span>".jpg"</span><span>;<br/></span><span>    return </span>Uri.<span>fromFile</span>(<span>new </span>File(Environment<br/>            .<span>getExternalStoragePublicDirectory</span>(Environment.<span>DIRECTORY_PICTURES</span>)<span>,</span>fileName))<span>;<br/></span>}</pre>
<ol start="5">
<li class="NumberedBulletPACKT">Add the following m<span>ethod to handle the button click:</span></li>
</ol>
<pre style="padding-left: 60px"><span>public void </span><span>takePicture</span>(View view) {<br/>    Intent takePictureIntent = <span>new </span>Intent(MediaStore.<span>ACTION_IMAGE_CAPTURE</span>)<span>;<br/></span><span>    if </span>(takePictureIntent.resolveActivity(getPackageManager()) != <span>null</span>) {<br/>        <span>mLastPhotoURI </span>= createFileURI()<span>;<br/></span><span>        </span>takePictureIntent.putExtra(MediaStore.<span>EXTRA_OUTPUT</span><span>, </span><span>mLastPhotoURI</span>)<span>;<br/></span><span>        </span>startActivityForResult(takePictureIntent<span>, </span><span>PHOTO_RESULT</span>)<span>;<br/></span><span>    </span>}<br/>}</pre>
<ol start="6">
<li class="NumberedBulletPACKT">Add a new method to <span>override</span> <kbd><span class="CodeInTextPACKT"><span>onActivityResult()</span></span></kbd><span> as follows:</span></li>
</ol>
<pre style="padding-left: 60px"><span>@Override<br/></span><span>protected void </span><span>onActivityResult</span>(<span>int </span>requestCode<span>, int </span>resultCode<span>, </span>Intent data) {<br/>    <span>if </span>(requestCode == <span>PHOTO_RESULT </span>&amp;&amp; resultCode == <span>RESULT_OK </span>) {<br/>        AppCompatImageView imageView = findViewById(R.id.<span>imageView</span>)<span>;<br/></span><span>        </span>imageView.setImageBitmap(BitmapFactory.<span>decodeFile</span>(<span>mLastPhotoURI</span>.getPath()))<span>;<br/></span><span>    </span>}<br/>}</pre>
<p style="padding-left: 60px">7. Add the following code to the end of the existing <kbd>onCreate()</kbd> method: </p>
<pre style="padding-left: 60px">StrictMode.VmPolicy.Builder builder = <span>new </span>StrictMode.VmPolicy.Builder()<span>;<br/></span>StrictMode.<span>setVmPolicy</span>(builder.build())<span>;<br/></span><span><br/></span><span>if </span>(ContextCompat.<span>checkSelfPermission</span>(<span>this, </span>Manifest.permission.<span>READ_EXTERNAL_STORAGE</span>) <br/>        != PackageManager.<span>PERMISSION_GRANTED </span>) {<br/>    ActivityCompat.<span>requestPermissions</span>(<span>this, <br/></span><span>            new </span>String[] {Manifest.permission.<span>READ_EXTERNAL_STORAGE</span>}<span>,</span><span>0</span>)<span>;<br/></span>}</pre>
<p style="padding-left: 60px"><span>8. You're</span> <span>ready to run the a</span><span>pplication</span> <span>on a device or emulator.</span></p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">How it works...</h1>
                </header>
            
            <article>
                
<p class="NormalPACKT"><span>There are two parts to working with the default camera app. The first is to set up the Intent to launch the app. We create the Intent using</span> <kbd><span class="CodeInTextPACKT"><span>MediaStore.ACTION_IMAGE_CAPTURE</span></span></kbd> <span>to indicate we want a photo app. We verify a default app exists by checking the results from</span> <kbd><span class="CodeInTextPACKT"><span>resolveActivity()</span></span></kbd><span>. As long as it's not null, we know an application is available to handle the Intent. (Otherwise, our app will crash.) We create a filename and add it to the Intent with</span> <kbd><span class="CodeInTextPACKT"><span>putExtra(MediaStore.EXTRA_OUTPUT, mLastPhotoURI)</span></span></kbd><span>.</span></p>
<p style="margin-bottom: .0001pt" class="NormalPACKT"><span>When we get the callback in</span> <kbd><span class="CodeInTextPACKT"><span>onActivityResult()</span></span></kbd><span>, we first make sure it's </span><kbd>PHOTO_RESULT</kbd> and <kbd>RESULT_OK</kbd> (the user could have cancelled), then we load the photo in ImageView.</p>
<p>You might be wondering what the <kbd>StrictMode</kbd> calls are for in <kbd>onCreate()</kbd>. Basically, those lines of code disable an additional security check made by the OS. If we don't disable StrictMode, the app will crash when creating the file URI with a <kbd>FileUriExposedException</kbd> exception.  For a production app, one solution would be to create a FileProvider as we did in the <em>Accessing External Storage with Scoped Directories</em> recipe from <a href="2bf1b0ac-516b-48e1-95f6-ce76f2046d20.xhtml" target="_blank">Chapter 7</a>, <em>Data Storage</em>. Refer to the <em>See also</em> section for other options.</p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">There's more...</h1>
                </header>
            
            <article>
                
<p class="NormalPACKT"><span>If you don't care where the picture is stored, you can call the Intent without using the</span> <kbd><span class="CodeInTextPACKT"><span>MediaStore.EXTRA_OUTPUT</span></span></kbd> <span>extra. If you don't specify the output file,</span> <kbd><span class="CodeInTextPACKT"><span>onActivityResult()</span></span></kbd> <span>will include a thumbnail of the image in the data Intent. The following is how you can display the thumbnail:</span></p>
<pre class="CodePACKT"><span>if (data != null) {<br/></span><span>    imageView</span><span>.setImageBitmap((Bitmap) data.getExtras().get(“data”));<br/></span><span>}</span></pre>
<p class="NormalPACKT"><span>Here's the code to load the full resolution image, using the URI returned in</span> the <span class="CodeInTextPACKT"><span>data Intent</span></span><span>:</span></p>
<pre class="CodePACKT"><span>if (data != null) {<br/></span><span>    try {<br/></span><span>        imageView.setImageBitmap(<br/></span><span>            MediaStore.Images.Media. getBitmap(getContentResolver(),<br/></span><span>            Uri.parse(data.toUri(Intent.URI_ALLOW_UNSAFE))));<br/></span><span>    } catch (IOException e) {<br/></span><span>        e.printStackTrace();<br/></span><span>    }<br/></span><span>}</span></pre>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Calling the default video app</h1>
                </header>
            
            <article>
                
<p class="NormalPACKT"><span>It's the same process if you want</span> <span>to call the default video capture application. Just change the Intent in step 5, as follows:</span></p>
<pre class="CodeEndPACKT"><span>Intent takeVideoIntent = new Intent(MediaStore.ACTION_VIDEO_CAPTURE);</span></pre>
<p class="NormalPACKT"><span>You can get the URI to the video in</span> <kbd>onActivityResult()</kbd><span>, as follows:</span></p>
<pre style="margin-bottom: .0001pt" class="CodeEndPACKT"><span>Uri videoUri = intent.getData();</span></pre>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">See also</h1>
                </header>
            
            <article>
                
<ul>
<li style="margin-bottom: .0001pt" class="BulletEndPACKT"><span>The <em><span class="ItalicsPACKT">Scaling down large images to avoid Out of Memory exceptions</span></em> recipe in</span> <a href="a9bb5495-da76-415c-b83e-c75d0b8ce4fd.xhtml" target="_blank"><span class="ChapterrefPACKT"><span>Chapter 10</span></span></a><span><em>, <span class="ItalicsPACKT">Graphics and Animation</span></em></span></li>
<li>The <em>Accessing External Storage with Scoped Directories</em><span> recipe in <a href="2bf1b0ac-516b-48e1-95f6-ce76f2046d20.xhtml" target="_blank">Chapter 7</a>, <em><span class="cdp-organizer-chapter-title"><span class="cdp-organize-title-label">Data Storage</span></span></em><br/></span></li>
</ul>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Taking a picture using the Camera2 API</h1>
                </header>
            
            <article>
                
<p class="NormalPACKT"><span>The previous recipe</span><span> </span><span>demonstrated how to use an Intent to call the</span><span> </span><span>default photo application. If you only need a quick photo, the Intent is probably the ideal solution. If not, and you need more control over the camera, this recipe will show you how to use the camera directly with the Camera2 API.</span></p>
<p>Now that 85% of devices are using Android 5.0 or later, this recipe focuses only on the Camera2 API.  (Google has already deprecated the original Camera API.)</p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Getting ready</h1>
                </header>
            
            <article>
                
<p style="margin-bottom: .0001pt" class="NormalPACKT"><span>Create a new project in Android Studio and call it</span> <span class="CodeInTextPACKT"><span>Camera2API</span></span><span>. In the <span class="ScreenTextPACKT"><span class="packt_screen">Target Android</span> Devices</span> dialog, select the <span class="ScreenTextPACKT"><span class="packt_screen">Phone &amp; Tablet</span></span> option and choose <span class="packt_screen">API 21: Android 5.0 (Lollipop)</span>, or later, for the m<span class="ScreenTextPACKT">inimum SDK</span>. S</span><span class="s1">elect </span><span class="s2">Empty Activity</span><span class="s1"> on the </span><span class="s2">Add an Activity to Mobile</span><span class="s1"> dialog.</span></p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">How to do it...</h1>
                </header>
            
            <article>
                
<p class="NormalPACKT"><span>As you'll see, there's a lot of code for this recipe. Start by opening the Android Manifest and following these steps:</span></p>
<ol>
<li class="NumberedBulletPACKT"><span>Add the following t</span><span>wo permissions:</span></li>
</ol>
<pre style="padding-left: 60px"><span>&lt;uses-permission </span><span>android</span><span>:name=</span><span>"android.permission.CAMERA" </span><span>/&gt;<br/></span><span>&lt;uses-permission </span><span>android</span><span>:name=</span><span>"android.permission.WRITE_EXTERNAL_STORAGE" </span><span>/&gt;</span></pre>
<ol start="2">
<li class="NumberedBulletPACKT"><span>Now, open</span> <kbd><span class="CodeInTextPACKT"><span>activity_main.xml</span></span></kbd> <span>and replace the existing TextView with the following views:</span></li>
</ol>
<pre style="padding-left: 60px"><span>&lt;TextureView<br/></span><span>    </span><span>android</span><span>:id=</span><span>"@+id/textureView"<br/></span><span>    </span><span>android</span><span>:layout_width=</span><span>"match_parent"<br/></span><span>    </span><span>android</span><span>:layout_height=</span><span>"match_parent"<br/></span><span>    </span><span>app</span><span>:layout_constraintTop_toTopOf=</span><span>"parent"<br/></span><span>    </span><span>app</span><span>:layout_constraintBottom_toTopOf=</span><span>"@+id/button"<br/></span><span>    </span><span>app</span><span>:layout_constraintLeft_toLeftOf=</span><span>"parent"<br/></span><span>    </span><span>app</span><span>:layout_constraintRight_toRightOf=</span><span>"parent" </span><span>/&gt;<br/></span><span>&lt;android.support.v7.widget.AppCompatButton<br/></span><span>    </span><span>android</span><span>:id=</span><span>"@+id/button"<br/></span><span>    </span><span>android</span><span>:layout_width=</span><span>"wrap_content"<br/></span><span>    </span><span>android</span><span>:layout_height=</span><span>"wrap_content"<br/></span><span>    </span><span>android</span><span>:text=</span><span>"Take Picture"<br/></span><span>    </span><span>android</span><span>:onClick=</span><span>"takePictureClick"<br/></span><span>    </span><span>app</span><span>:layout_constraintBottom_toBottomOf=</span><span>"parent"<br/></span><span>    </span><span>app</span><span>:layout_constraintLeft_toLeftOf=</span><span>"parent"<br/></span><span>    </span><span>app</span><span>:layout_constraintRight_toRightOf=</span><span>"parent"</span><span>/&gt;</span></pre>
<ol start="3">
<li class="NumberedBulletPACKT"><span>Now, open</span> <kbd><span class="CodeInTextPACKT"><span>Ma</span></span><span class="CodeInTextPACKT"><span>inActivity.java </span></span></kbd><span>and add the following global variables to the</span> <kbd><span class="CodeInTextPACKT"><span>MainActivity</span></span></kbd> <span>class:</span></li>
</ol>
<pre style="padding-left: 60px" class="CodeWithinBulletsPACKT"><span>private CameraDevice mCameraDevice = null;<br/></span><span>private CaptureRequest.Builder mCaptureRequestBuilder = null;<br/></span><span>private CameraCaptureSession mCameraCaptureSession  = null;<br/></span><span>private TextureView mTextureView = null;<br/></span><span>private Size mPreviewSize = null;</span></pre>
<ol start="4">
<li class="NumberedBulletPACKT"><span>Add the</span> <span>following</span> <kbd><span class="CodeInTextPACKT"><span>Comparator</span></span></kbd> <span>class to the <kbd>MainActivity</kbd> class:</span></li>
</ol>
<pre style="padding-left: 60px"><span>static class </span>CompareSizesByArea <span>implements </span>Comparator&lt;Size&gt; {<br/>    <span>@Override<br/></span><span>    </span><span>public int </span><span>compare</span>(Size lhs<span>, </span>Size rhs) {<br/>        <span>return </span>Long.<span>signum</span>((<span>long</span>) lhs.getWidth() * lhs.getHeight() <br/>                - (<span>long</span>) rhs.getWidth() * rhs.getHeight())<span>;<br/></span><span>    </span>}<br/>}</pre>
<ol start="5">
<li class="NumberedBulletPACKT">Add the followin<span>g</span><span> </span><kbd><span class="CodeInTextPACKT"><span>CameraCaptureSession.StateCallback</span></span></kbd><span>:</span></li>
</ol>
<pre style="padding-left: 60px"><span>private </span>CameraCaptureSession.StateCallback <span>mPreviewStateCallback </span>= <span>new </span>CameraCaptureSession.StateCallback() {<br/>    <span>@Override<br/></span><span>    </span><span>public void </span><span>onConfigured</span>(CameraCaptureSession session) {<br/>        startPreview(session)<span>;<br/></span><span>    </span>}<br/>    <span>@Override<br/></span><span>    </span><span>public void </span><span>onConfigureFailed</span>(CameraCaptureSession session) {}<br/>}<span>;</span></pre>
<ol start="6">
<li class="NumberedBulletPACKT"><span>Add</span> <span>the</span> <span>followi</span><span>ng</span> <kbd><span class="CodeInTextPACKT"><span>SurfaceTextureListener</span></span></kbd><span>:</span></li>
</ol>
<pre style="padding-left: 60px"><span>private </span>TextureView.SurfaceTextureListener <span>mSurfaceTextureListener </span>=<br/>        <span>new </span>TextureView.SurfaceTextureListener() {<br/>            <span>@Override<br/></span><span>            </span><span>public void </span><span>onSurfaceTextureUpdated</span>(SurfaceTexture     <br/>            surface)                        <br/>            {<br/>            }<br/>            <span>@Override<br/></span><span>            </span><span>public void </span><span>onSurfaceTextureSizeChanged</span>(<br/>                    SurfaceTexture surface<span>, int </span>width<span>, int </span>height) {<br/>            }<br/>            <span>@Override<br/></span><span>            </span><span>public boolean </span><span>onSurfaceTextureDestroyed</span>(SurfaceTexture <br/>            surface) {<br/>                <span>return false;<br/></span><span>            </span>}<br/>            <span>@Override<br/></span><span>            </span><span>public void </span><span>onSurfaceTextureAvailable</span>(<br/>                    SurfaceTexture surface<span>, int </span>width<span>, int </span>height) {<br/>                openCamera()<span>;<br/></span><span>            </span>}<br/>        }<span>;</span></pre>
<ol start="7">
<li>Add <kbd>CameraDevice.StateCallback</kbd><span> </span>as follows:</li>
</ol>
<pre style="padding-left: 60px"><span>private </span>CameraDevice.StateCallback <span>mStateCallback </span>= <span>new </span>CameraDevice.StateCallback() {<br/>    <span>@Override<br/></span><span>    </span><span>public void </span><span>onOpened</span>(CameraDevice camera) {<br/>        <span>mCameraDevice </span>= camera<span>;<br/></span><span>        </span>SurfaceTexture texture = <span>mTextureView</span>.getSurfaceTexture()<span>;<br/></span><span>        if </span>(texture == <span>null</span>) {<br/>            <span>return;<br/></span><span>        </span>}<br/>        texture.setDefaultBufferSize(<span>mPreviewSize</span>.getWidth()<span>, <br/></span><span>        mPreviewSize</span>.getHeight())<span>;<br/></span><span>        </span>Surface surface = <span>new </span>Surface(texture)<span>;<br/></span><span>        try </span>{<br/>            <span>mCaptureRequestBuilder </span>= <span>mCameraDevice<br/></span><span>                    <br/></span>        .createCaptureRequest(CameraDevice.<span>TEMPLATE_PREVIEW</span>)<span>;<br/></span><span>        </span>} <span>catch </span>(CameraAccessException e){<br/>            e.printStackTrace()<span>;<br/></span><span>        </span>}<br/>        <span>mCaptureRequestBuilder</span>.addTarget(surface)<span>;<br/></span><span>        try </span>{<br/>            <span>mCameraDevice</span>.createCaptureSession(Arrays<br/>                    .<span>asList</span>(surface)<span>, </span><span>mPreviewStateCallback</span><span>, null</span>)<span>;<br/></span><span>        </span>} <span>catch </span>(CameraAccessException e) {<br/>            e.printStackTrace()<span>;<br/></span><span>        </span>}<br/>    }<br/>    <span>@Override<br/></span><span>    </span><span>public void </span><span>onError</span>(CameraDevice camera<span>, int </span>error) {}<br/>    <span>@Override<br/></span><span>    </span><span>public void </span><span>onDisconnected</span>(CameraDevice camera) {}<br/>}<span>;</span></pre>
<ol start="8">
<li>Add the following <kbd>CaptureCallback</kbd> class to receive the capture completed event: </li>
</ol>
<pre style="padding-left: 60px">final CameraCaptureSession.CaptureCallback mCaptureCallback = <br/>        new CameraCaptureSession.CaptureCallback() {<br/>    @Override<br/>    public void onCaptureCompleted(CameraCaptureSession session,  <br/>     CaptureRequest request,                                  <br/>     TotalCaptureResult result) {<br/>        super.onCaptureCompleted(session, request, result);<br/>        Toast.makeText(MainActivity.this, "Picture Saved", <br/>        Toast.LENGTH_SHORT).show();<br/>        startPreview(session);<br/>    }<br/>};</pre>
<p class="mce-root"/>
<ol start="9">
<li class="NumberedBulletPACKT"><span>Add the</span> <span>followin</span><span>g code to t</span><span>he</span> <span>existing</span> <kbd><span class="CodeInTextPACKT"><span>onCreate()</span></span></kbd> <span>callback:</span></li>
</ol>
<pre style="padding-left: 60px"><span>mTextureView </span>= findViewById(R.id.<span>textureView</span>)<span>;<br/></span><span>mTextureView</span>.setSurfaceTextureListener(<span>mSurfaceTextureListener</span>)<span>;<br/></span><span><br/></span><span>if</span>(ActivityCompat.<span>checkSelfPermission</span>(<span>this, </span>Manifest.permission.<span>CAMERA</span>) <br/>        != PackageManager.<span>PERMISSION_GRANTED</span>) {<br/>    ActivityCompat.<span>requestPermissions</span>(<span>this, new </span>String[]{Manifest.permission.<span>CAMERA</span>}<span>, </span><span>1</span>)<span>;<br/></span>}</pre>
<ol start="10">
<li>Add the following m<span>ethods to override</span> <kbd><span class="CodeInTextPACKT"><span>onPause()</span></span></kbd> <span>and</span> <kbd><span class="CodeInTextPACKT"><span>onResume()</span></span></kbd><span>:</span></li>
</ol>
<pre style="padding-left: 60px" class="CodeWithinBulletsPACKT"><span>@Override<br/></span><span>protected void onPause() {<br/></span><span>    super.onPause();<br/></span><span>    if (mCameraDevice != null) {<br/></span><span>        mCameraDevice.close();<br/></span><span>        mCameraDevice = null;<br/></span><span>    }<br/></span><span>}<br/></span><span>@Override<br/></span><span>public void onResume() {<br/></span><span>    super.onResume();<br/></span><span>    if (mTextureView.isAvailable()) {<br/></span><span>        openCamera();<br/></span><span>    } else {<br/></span><span>        mTextureView.setSurfaceTextureListener(<br/>             mSurfaceTextureListener);<br/></span><span>    }<br/></span><span>}</span></pre>
<ol start="11">
<li>Add the <kbd><span class="CodeInTextPACKT"><span>openCam</span></span><span class="CodeInTextPACKT"><span>era()</span></span></kbd> <span>method:</span></li>
</ol>
<pre style="padding-left: 60px"><span>private void </span><span>openCamera</span>() {<br/>    CameraManager manager = (CameraManager) getSystemService(<span>CAMERA_SERVICE</span>)<span>;<br/></span><span>    try</span>{<br/>        String cameraId = manager.getCameraIdList()[<span>0</span>]<span>;<br/></span><span>        </span>CameraCharacteristics characteristics = manager.getCameraCharacteristics(cameraId)<span>;<br/></span><span>        </span>StreamConfigurationMap map = characteristics<br/>                .get(CameraCharacteristics.<span>SCALER_STREAM_CONFIGURATION_MAP</span>)<span>;<br/></span><span>        </span><span>mPreviewSize </span>= map.getOutputSizes(SurfaceTexture.<span>class</span>) [<span>0</span>]<span>;<br/></span><span>        </span>manager.openCamera(cameraId<span>, </span><span>mStateCallback</span><span>, null</span>)<span>;<br/></span><span>    </span>} <span>catch</span>(CameraAccessException e) {<br/>        e.printStackTrace()<span>;<br/></span><span>    </span>} <span>catch </span>(SecurityException e) {<br/>        e.printStackTrace()<span>;<br/></span><span>    </span>}<br/>}</pre>
<ol start="12">
<li>Add the <kbd><span class="CodeInTextPACKT"><span>startPrevi</span></span><span class="CodeInTextPACKT"><span>ew()</span></span></kbd> <span>method:</span></li>
</ol>
<pre style="padding-left: 60px"><span>private void </span><span>startPreview</span>(CameraCaptureSession session) {<br/>    <span>mCameraCaptureSession </span>= session<span>;<br/></span><span>    </span><span>mCaptureRequestBuilder</span>.set(CaptureRequest.<span>CONTROL_MODE</span><span>, <br/></span>    CameraMetadata.<span>CONTROL_MODE_AUTO</span>)<span>;<br/></span><span>    </span>HandlerThread backgroundThread = <span>new <br/></span>    HandlerThread(<span>"CameraPreview"</span>)<span>;<br/></span><span>    </span>backgroundThread.start()<span>;<br/></span><span>    </span>Handler backgroundHandler = <span>new </span>Handler(backgroundThread. <br/>    getLooper())<span>;<br/></span><span>    try </span>{<br/>        <span>mCameraCaptureSession<br/></span><span>                </span>.setRepeatingRequest(<span>mCaptureRequestBuilder</span>.build()<span>, <br/>    null, </span>backgroundHandler)<span>;<br/></span><span>    </span>} <span>catch </span>(CameraAccessException e) {<br/>        e.printStackTrace()<span>;<br/></span><span>    </span>}<br/>}</pre>
<ol start="13">
<li>Add the <kbd>getPictureFile()</kbd> method:</li>
</ol>
<pre style="padding-left: 60px"><span>private </span>File <span>getPictureFile</span>() {<br/>    String timeStamp = <span>new </span>SimpleDateFormat(<span>"yyyyMMdd_HHmmss"</span>)<br/>            .format(System.<span>currentTimeMillis</span>())<span>;<br/></span><span>    </span>String fileName = <span>"PHOTO_" </span>+ timeStamp + <span>".jpg"</span><span>;<br/></span><span>    return new </span>File(Environment<br/>            .<span>getExternalStoragePublicDirectory</span>(Environment.<span>DIRECTORY_PICTURES</span>)<span>,</span>fileName)<span>;<br/></span>}</pre>
<ol start="14">
<li>Add the following method to save the image file: </li>
</ol>
<pre style="padding-left: 60px"><span>private void </span><span>saveImage</span>(ImageReader reader) {<br/>    Image image = <span>null;<br/></span><span>    try </span>{<br/>        image = reader.acquireLatestImage()<span>;<br/></span><span>        </span>ByteBuffer buffer = image.getPlanes()[<span>0</span>].getBuffer()<span>;<br/></span><span>        byte</span>[] bytes = <span>new byte</span>[buffer.capacity()]<span>;<br/></span><span>        </span>buffer.get(bytes)<span>;<br/></span><span>        </span>OutputStream output = <span>new </span>FileOutputStream(getPictureFile())<span>;<br/></span><span>        </span>output.write(bytes)<span>;<br/></span><span>        </span>output.close()<span>;<br/></span><span>    </span>} <span>catch </span>(FileNotFoundException e) {<br/>        e.printStackTrace()<span>;<br/></span><span>    </span>} <span>catch </span>(IOException e) {<br/>        e.printStackTrace()<span>;<br/></span><span>    </span>} <span>finally </span>{<br/>        <span>if </span>(image != <span>null</span>) {<br/>            image.close()<span>;<br/></span><span>        </span>}<br/>    }<br/>}</pre>
<ol start="15">
<li>Add the following method to handle the button click: </li>
</ol>
<pre style="padding-left: 60px"><span>public void </span><span>takePictureClick</span>(View view) {<br/>    <span>if </span>(<span>null </span>== <span>mCameraDevice</span>) {<br/>        <span>return;<br/></span><span>    </span>}<br/>    takePicture()<span>;<br/></span>}</pre>
<ol start="16">
<li>Add the final code to actually set up the camera and take the picture:</li>
</ol>
<pre style="padding-left: 60px"><span>private void </span><span>takePicture</span>() {<br/>    CameraManager manager = (CameraManager) getSystemService(Context.<span>CAMERA_SERVICE</span>)<span>;<br/></span><span>    try </span>{<br/>        CameraCharacteristics characteristics = manager<br/>                .getCameraCharacteristics(<span>mCameraDevice</span>.getId())<span>;<br/></span><span>        </span>StreamConfigurationMap configurationMap = characteristics<br/>                <br/>       .get(CameraCharacteristics.<span>SCALER_STREAM_CONFIGURATION_MAP</span>)<span>;<br/></span><span>        if </span>(configurationMap == <span>null</span>) <span>return;<br/></span><span>        </span>Size largest = Collections.<span>max</span>(Arrays.<span>asList</span>(configurationMap<br/>                .getOutputSizes(ImageFormat.<span>JPEG</span>))<span>, new <br/></span>        CompareSizesByArea())<span>;<br/></span><span>        </span>ImageReader reader = ImageReader<br/>                .<span>newInstance</span>(largest.getWidth()<span>, </span>largest.getHeight()<span>, <br/></span>        ImageFormat.<span>JPEG</span><span>, </span><span>1</span>)<span>;<br/></span><span>        </span>List&lt;Surface&gt; outputSurfaces = <span>new </span>ArrayList&lt;&gt;(<span>2</span>)<span>;<br/></span><span>        </span>outputSurfaces.add(reader.getSurface())<span>;<br/></span><span>        </span>outputSurfaces.add(<span>new <br/></span>        Surface(<span>mTextureView</span>.getSurfaceTexture()))<span>;<br/></span><span>        final </span>CaptureRequest.Builder captureBuilder = <span>mCameraDevice<br/></span><span>                <br/></span>        .createCaptureRequest(CameraDevice.<span>TEMPLATE_STILL_CAPTURE</span>)<span>;<br/></span><span>        </span>captureBuilder.addTarget(reader.getSurface())<span>;<br/></span><span>        </span>captureBuilder.set(CaptureRequest.<span>CONTROL_MODE</span><span>, <br/></span>        CameraMetadata.<span>CONTROL_MODE_AUTO</span>)<span>;<br/></span><span>        </span>ImageReader.OnImageAvailableListener readerListener =<br/>                <span>new </span>ImageReader.OnImageAvailableListener() {<br/>            <span>@Override<br/></span><span>            </span><span>public void </span><span>onImageAvailable</span>(ImageReader reader) {<br/>                saveImage(reader)<span>;<br/></span><span>            </span>}<br/>        }<span>;<br/></span><span>        </span>HandlerThread thread = <span>new </span>HandlerThread(<span>"CameraPicture"</span>)<span>;<br/></span><span>        </span>thread.start()<span>;<br/></span><span>        final </span>Handler backgroundHandler = <span>new <br/></span>        Handler(thread.getLooper())<span>;<br/></span><span>        </span>reader.setOnImageAvailableListener(readerListener<span>, <br/></span>        backgroundHandler)<span>;<br/></span><span>        </span><span>mCameraDevice</span>.createCaptureSession(outputSurfaces<span>,<br/></span><span>                new </span>CameraCaptureSession.StateCallback() {<br/>                    <span>@Override<br/></span><span>                    </span><span>public void </span><span>onConfigured</span>(CameraCaptureSession <br/>                    session) {<br/>                        <span>try </span>{<br/>                            session.capture(<span>captureBuilder</span>.build()<span>,<br/></span><span>                                    </span><span>mCaptureCallback</span><span>, <br/></span><span>                       backgroundHandler</span>)<span>;<br/></span><span>                        </span>} <span>catch </span>(CameraAccessException e) {<br/>                            e.printStackTrace()<span>;<br/></span><span>                        </span>}<br/>                    }<br/>                    <span>@Override<br/></span><span>                    </span><span>public void </span><span>onConfigureFailed</span>(CameraCaptureSession <br/>                   session) { }<br/>                }<span>, </span>backgroundHandler)<span>;<br/></span><span>    </span>} <span>catch </span>(CameraAccessException e) {<br/>        e.printStackTrace()<span>;<br/></span><span>    </span>}</pre>
<ol start="17">
<li>Run the applicati<span>on on a device or emulator with a camera.</span></li>
</ol>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">How it works...</h1>
                </header>
            
            <article>
                
<p>As you can see, there are a lot of steps for this recipe, but at a high level, it's pretty simple:</p>
<ul>
<li>Set up the camera preview</li>
<li>Capture the image</li>
</ul>
<p class="NormalPACKT">Now, we'll look at each in detail.</p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Setting up the camera preview</h1>
                </header>
            
            <article>
                
<p class="NormalPACKT"><span>Here's a rundown on how</span> <span>the code sets up the preview:</span></p>
<ol>
<li class="NumberedBulletPACKT"><span>First, we set up the</span> <kbd><span class="CodeInTextPACKT"><span>TextureView.SurfaceTextureListener</span></span></kbd> <span>with the</span> <kbd><span class="CodeInTextPACKT"><span>setSurfaceTextureListener()</span></span></kbd> <span>method in</span> <kbd><span class="CodeInTextPACKT"><span>onCreate()</span></span></kbd></li>
<li class="NumberedBulletPACKT"><span>When we get the</span> <kbd><span class="CodeInTextPACKT"><span>onSurfaceTextureAvailable()</span></span></kbd> <span>callback, we open the camera</span></li>
<li class="NumberedBulletPACKT"><span>We pass our</span> <kbd><span class="CodeInTextPACKT"><span>CameraDevice.StateCallback</span></span></kbd> <span>class to the</span> <kbd><span class="CodeInTextPACKT"><span>openCamera()</span></span></kbd> <span>method, which eventually calls the</span> <kbd><span class="CodeInTextPACKT"><span>onOpened()</span></span></kbd> <span>callback</span></li>
<li class="NumberedBulletPACKT"><kbd><span class="CodeInTextPACKT"><span>onOpened()</span></span></kbd> <span>gets the surface for the preview by calling</span> <kbd><span class="CodeInTextPACKT"><span>getSurfaceTexture()</span></span></kbd> <span>and passes it to the <kbd>CameraDevice</kbd> by calling</span> <kbd><span class="CodeInTextPACKT"><span>createCaptureSession()</span></span></kbd></li>
<li style="margin-bottom: .0001pt" class="NumberedBulletEndPACKT"><span>Finally, when</span> <span class="CodeInTextPACKT"><span><kbd>CameraCaptureSession.StateCallback</kbd> <kbd>onConfigured()</kbd></span></span> <span>is called, we start the preview with the</span> <kbd><span class="CodeInTextPACKT"><span>setRepeatingRequest()</span></span></kbd> <span>method</span></li>
</ol>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Capturing the image</h1>
                </header>
            
            <article>
                
<p class="NormalPACKT"><span>Even though the</span> <kbd><span class="CodeInTextPACKT"><span>takePicture()</span></span></kbd> <span>method</span> <span>may appear to be procedural, capturing an image also involves several classes and relies on callbacks. Here's a breakdown of how the code works:</span></p>
<ol>
<li class="NumberedBulletPACKT"><span>The process starts when the <span class="ScreenTextPACKT">Take Picture</span> button is clicked.</span></li>
<li class="NumberedBulletPACKT"><span>Then the code queries the camera to find the largest available image size</span></li>
<li class="NumberedBulletPACKT"><span>Then an</span> <span class="CodeInTextPACKT"><span>ImageReader is created.</span></span></li>
<li class="NumberedBulletPACKT"><span>Next, the code sets up</span> <kbd><span class="CodeInTextPACKT"><span>OnImageAvailableListener</span></span></kbd><span>, and saves the image in the</span> <kbd><span class="CodeInTextPACKT"><span>onImageAvailable()</span></span></kbd> <span>callback.</span></li>
<li class="NumberedBulletPACKT"><span>Then it creates</span> <kbd><span class="CodeInTextPACKT"><span>CaptureRequest.Builder</span></span></kbd> <span>and includes the</span> <kbd><span class="CodeInTextPACKT"><span>ImageReader</span></span></kbd> <span>surface.</span></li>
<li class="NumberedBulletPACKT">N<span>ext it creates</span> <kbd>CameraCaptureSession.CaptureCallback</kbd>, w<span>hich defines<br/>
the</span> <kbd><span class="CodeInTextPACKT"><span>onCaptureCompleted()</span></span></kbd> <span>callback. When the capture is complete, it restarts the preview.</span></li>
<li style="margin-bottom: .0001pt" class="NumberedBulletEndPACKT"><span>Finally, the</span> <kbd><span class="CodeInTextPACKT"><span>createCaptureSession()</span></span></kbd> <span>method is called, creating a</span> <kbd><span class="CodeInTextPACKT"><span>CameraCaptureSession.StateCallback</span></span></kbd><span>. This is where the</span> <kbd><span class="CodeInTextPACKT"><span>capture()</span></span></kbd> <span>method is called, passing in the</span> <kbd><span class="CodeInTextPACKT"><span>CameraCaptureSession.CaptureCallback</span></span></kbd> <span>created earlier.</span></li>
</ol>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">There's more...</h1>
                </header>
            
            <article>
                
<p style="margin-bottom: .0001pt" class="NormalPACKT"><span>We've just created the base code to demonstrate a working Camera application. There are many areas for improvement. First, you should handle the device orientation, for both the preview and when saving the images. (See the following links.) Also, with Android 6.0 (API 23) having over 60% of the market share, your apps should already be using the new permission model. Instead of just checking for an exception as we do in the</span> <kbd><span class="CodeInTextPACKT"><span>openCamera()</span></span></kbd> <span>method, it would be better to check for the required permission.</span></p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">See also</h1>
                </header>
            
            <article>
                
<ul>
<li class="BulletEndPACKT"><span>Camera2 API Developer Docs <a href="https://developer.android.com/reference/android/hardware/camera2/package-summary.html"><span class="URLPACKT"><span><span>https://devel</span></span></span><span>oper.android.com/reference/android/hardware/camera2/package-summary.html</span></a></span></li>
<li class="BulletPACKT"><span>For examples on detecting the current device orientation, refer to</span><span> </span><a href="9ec1f7c4-f4c5-4cb3-b10a-59915ba73449.xhtml" target="_blank"><span class="ChapterrefPACKT"><span>Chapter 9</span></span></a><span>,<span> </span><span class="ItalicsPACKT"><em>Using the Touchscreen and Sensors</em></span></span></li>
<li class="BulletPACKT">T<span class="ItalicsPACKT"><span class="ItalicsPACKT"><span>he <em>The Android 6.0 Runtime Permission Model</em> recipe </span></span></span><span>in</span> <span class="ChapterrefPACKT"><span><a href="98c7bc7b-43e2-43de-aed4-fe2fb6dc72f3.xhtml" target="_blank">Chapter 15</a>, <em><span class="cdp-organizer-chapter-title"><span class="cdp-organize-title-label">Getting your app ready for the Play Store</span></span></em><br/></span></span></li>
</ul>


            </article>

            
        </section>
    </body></html>