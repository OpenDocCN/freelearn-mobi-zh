<html><head></head><body>
        

                            
                    <h1 class="header-title">Multimedia</h1>
                
            
            
                
<p class="NormalPACKT">In this chapter, we will cover the following topics:</p>
<ul>
<li class="BulletPACKT">Playing sound effects with <kbd>SoundPool</kbd></li>
<li class="BulletPACKT">Playing audio with <kbd>MediaPlayer</kbd></li>
<li class="BulletPACKT">Responding to hardware media controls in your app</li>
<li class="BulletPACKT">Taking a photo with the default camera app</li>
<li style="margin-bottom: .0001pt" class="BulletEndPACKT">Taking a picture using the Camera2 API</li>
</ul>


            

            
        
    

        

                            
                    <h1 class="header-title">Introduction</h1>
                
            
            
                
<p class="NormalPACKT">Now that we've explored graphics and animations in the previous chapters, it's time to look at the sound options available in Android. The two most popular options to play sound are the following:</p>
<ul>
<li class="BulletPACKT"><kbd>SoundPool</kbd>: This is for short sound clips</li>
<li class="BulletEndPACKT"><kbd>MediaPlayer</kbd>: This is designed for larger sound files (such as music) and video files</li>
</ul>
<p class="NormalPACKT">The first two recipes will look at using these libraries. We'll also look at how to use hardware related to sound, such as the volume controls and media playback controls (play, pause, next and previous, often available on headphones).</p>
<p style="margin-bottom: .0001pt" class="NormalPACKT">The rest of the chapter will focus on using the camera, both indirectly through Intents (to pass the camera request to the default camera application) and directly using the camera APIs. We'll show a complete example using  the  Camera2 APIs released with Android 5.0 Lollipop (API 21).</p>


            

            
        
    

        

                            
                    <h1 class="header-title">Playing sound effects with SoundPool</h1>
                
            
            
                
<p class="NormalPACKT">When you need sound effects in your application, <kbd>SoundPool</kbd> is usually a good starting point.</p>
<p class="NormalPACKT"><kbd>SoundPool</kbd> is interesting in that it allows us to create special effects with our sounds by changing the play rate and by allowing multiple sounds to play simultaneously.</p>
<p class="NormalPACKT">Popular audio file types supported include:</p>
<ul>
<li class="BulletPACKT">3GPP (<kbd>.3gp</kbd>)</li>
<li class="BulletPACKT">3GPP (<kbd>.3gp</kbd>)</li>
<li class="BulletPACKT">FLAC (<kbd>.flac</kbd>)</li>
<li class="BulletPACKT">MP3 (<kbd>.mp3</kbd>)</li>
<li class="BulletPACKT">MIDI Type 0 and 1 (<kbd>.mid</kbd>, <kbd>.xmf</kbd>, and <kbd>.mxmf</kbd>)</li>
<li class="BulletPACKT">Ogg (<kbd>.ogg</kbd>)</li>
<li class="BulletEndPACKT">WAVE (<kbd>.wav</kbd>)</li>
</ul>
<p class="NormalPACKT">See the Supported Media Formats link for a complete list, including network protocols.</p>
<p class="NormalPACKT">As is common in Android, new releases to the OS bring changes to the APIs. <kbd>SoundPool</kbd> is no exception and the original <kbd>SoundPool</kbd> constructor was deprecated in Lollipop (API 21). Rather than setting our minimum API to 21 or relying on deprecated code (which may stop working at some point), we'll implement both the old and the new approach and check the OS version at runtime to use the appropriate method.</p>
<p style="margin-bottom: .0001pt" class="NormalPACKT">This recipe will demonstrate how to play sound effects using the Android <kbd>SoundPool</kbd> library. To demonstrate playing sounds simultaneously, we'll create two buttons, and each will play a sound when pressed.</p>


            

            
        
    

        

                            
                    <h1 class="header-title">Getting ready</h1>
                
            
            
                
<p class="NormalPACKT">Create a new project in Android Studio and call it <kbd>SoundPool</kbd>. Use the default Phone &amp; Tablet options, and select Empty Activity when prompted for Activity Type.</p>
<p class="NormalPACKT">To demonstrate playing sounds simultaneously, we need at least two audio files in the project. We went to SoundBible.com (<a href="http://soundbible.com/royalty-free-sounds-5.html">http://soundbible.com/royalty-free-sounds-5.html</a>) and found two royalty-free, public-domain sounds to include in the downloaded project files.</p>
<p style="margin-bottom: 7.2pt" class="NormalPACKT">The first sound is a longer playing sound: <a href="http://soundbible.com/2032-Water.html">http://soundbible.com/2032-Water.html</a></p>
<p style="margin-bottom: 7.2pt" class="NormalPACKT">The second sound is shorter: <a href="http://soundbible.com/1615-Metal-Drop.html">http://soundbible.com/1615-Metal-Drop.html</a></p>


            

            
        
    

        

                            
                    <h1 class="header-title">How to do it...</h1>
                
            
            
                
<p class="NormalPACKT">As explained before, we'll need two audio files to include in the project. Once you have your sound files ready, follow these steps:</p>
<ol>
<li class="NumberedBulletPACKT">Create a new raw folder (File | New | Android resource directory) and choose raw in the Resource type drop-down.</li>
<li class="NumberedBulletPACKT">Copy your sound files to <kbd>res/raw</kbd> as <kbd>sound_1</kbd> and <kbd>sound_2</kbd>. (Keep their original extensions.)</li>
<li class="NumberedBulletPACKT">Open <kbd>activity_main.xml</kbd> and replace the existing <kbd>TextView</kbd> with the following buttons:</li>
</ol>
<pre style="padding-left: 60px">&lt;Button<br/>    android:id="@+id/button1"<br/>    android:layout_width="wrap_content"<br/>    android:layout_height="wrap_content"<br/>    android:text="Button"<br/>    android:onClick="playSound1"/&gt;<br/>&lt;Button<br/>    android:id="@+id/button2"<br/>    android:layout_width="wrap_content"<br/>    android:layout_height="wrap_content"<br/>    android:text="Button"<br/>    android:onClick="playSound2"<br/>    app:layout_constraintTop_toBottomOf="@+id/button1"/&gt;</pre>
<ol start="4">
<li class="NumberedBulletPACKT">Now, open <kbd>ActivityMain.java</kbd> and add the following global variables:</li>
</ol>
<pre style="padding-left: 60px" class="CodeWithinBulletsPACKT">HashMap&lt;Integer, Integer&gt; mHashMap= null;<br/>SoundPool mSoundPool;</pre>
<ol start="5">
<li class="NumberedBulletPACKT">Modify the existing <kbd>onCreate()</kbd> method as follows:</li>
</ol>
<pre style="padding-left: 60px">final Button button1 = findViewById(R.id.button1);<br/>button1.setEnabled(false);<br/>final Button button2 = findViewById(R.id.button2);<br/>button2.setEnabled(false);<br/><br/>if (Build.VERSION.SDK_INT &gt;= Build.VERSION_CODES.LOLLIPOP) {<br/>    createSoundPoolNew();<br/>} else {<br/>    createSoundPoolOld();<br/>}<br/>mSoundPool.setOnLoadCompleteListener(new SoundPool.OnLoadCompleteListener() {<br/>    @Override<br/>    public void onLoadComplete(SoundPool soundPool, int sampleId, int status) {<br/>        button1.setEnabled(true);<br/>        button2.setEnabled(true);<br/>    }<br/>});<br/>mHashMap = new HashMap&lt;&gt;();<br/>mHashMap.put(1, mSoundPool.load(this, R.raw.sound_1, 1));<br/>mHashMap.put(2, mSoundPool.load(this, R.raw.sound_2, 1));</pre>
<ol start="6">
<li class="NumberedBulletPACKT">Add the <kbd>createSoundPoolNew()</kbd> method:</li>
</ol>
<pre style="padding-left: 60px">@TargetApi(Build.VERSION_CODES.LOLLIPOP)<br/>private void createSoundPoolNew() {<br/>    AudioAttributes audioAttributes = new AudioAttributes.Builder()<br/>            .setUsage(AudioAttributes.USAGE_MEDIA)<br/>            .setContentType(AudioAttributes.CONTENT_TYPE_SONIFICATION)<br/>            .build();<br/>    mSoundPool = new SoundPool.Builder()<br/>            .setAudioAttributes(audioAttributes)<br/>            .setMaxStreams(2)<br/>            .build();<br/>}</pre>
<ol start="7">
<li class="NumberedBulletPACKT">Add the <kbd>createSoundPoolOld()</kbd> method:</li>
</ol>
<pre style="padding-left: 60px">@SuppressWarnings("deprecation")<br/>private void createSoundPoolOld(){<br/>    mSoundPool = new SoundPool(2, AudioManager.STREAM_MUSIC, 0);<br/>}</pre>
<ol start="8">
<li class="NumberedBulletPACKT">Add the button <kbd>onClick()</kbd> methods:</li>
</ol>
<pre style="padding-left: 60px">public void playSound1(View view){<br/>    mSoundPool.play(mHashMap.get(1), 0.1f, 0.1f, 1, 0, 1.0f);<br/>}<br/>public void playSound2(View view){<br/>    mSoundPool.play(mHashMap.get(2), 0.9f, 0.9f, 1, 1, 1.0f);<br/>}</pre>
<p class="mce-root"/>
<p class="mceNonEditable"/>
<ol start="9">
<li class="NumberedBulletPACKT">Override the <kbd>onStop()</kbd> callback as follows:</li>
</ol>
<pre style="padding-left: 60px">@Override<br/>protected void onStop() {<br/>    mSoundPool.release();<br/>    super.onStop();<br/>}</pre>
<ol start="10">
<li style="margin-bottom: .0001pt" class="NumberedBulletEndPACKT">Run the application on a device or emulator.</li>
</ol>


            

            
        
    

        

                            
                    <h1 class="header-title">How it works...</h1>
                
            
            
                
<p class="NormalPACKT">The first detail to notice is how we construct the object itself. As we mentioned in the introduction, the <kbd>SoundPool</kbd> constructor was changed in Lollipop (API 21). The old constructor was deprecated in favor of using <kbd>SoundPool.Builder()</kbd>. With a constantly changing environment such as Android, changes in the API are very common, so it's a good idea to learn how to work with the changes. As you can see, it's not difficult in this case. We just check the current OS version and call the appropriate method. It is worth noting the two method annotations.  The first specifies the target API:</p>
<p class="CodeEndPACKT"><kbd>@TargetApi(Build.VERSION_CODES.LOLLIPOP)</kbd></p>
<p class="NormalPACKT">And the second suppresses the deprecation warning:</p>
<p class="CodeEndPACKT"><kbd>@SuppressWarnings("deprecation")</kbd></p>
<p class="NormalPACKT">After creating <kbd>SoundPool</kbd>, we set a <kbd>setOnLoadCompleteListener()</kbd> listener. Enabling the buttons is mostly for demonstration purposes to illustrate that <kbd>SoundPool</kbd> needs to load sound resources before they are available.</p>
<p style="margin-bottom: .0001pt" class="NormalPACKT">The final point to make on using <kbd>SoundPool</kbd> is the call to <kbd>play()</kbd>. We need to pass in the <kbd>soundID</kbd>, which was returned when we loaded the sound using <kbd>load()</kbd>. <kbd>play()</kbd> gives us a few options, including sound volume (left and right), loop count, and playback rate. To demonstrate its flexibility, we play the first sound (which is longer) at a lower volume to create more of a background effect with the running water. The second sound plays at a higher volume and we play it twice.</p>


            

            
        
    

        

                            
                    <h1 class="header-title">There's more...</h1>
                
            
            
                
<p class="NormalPACKT">If you only need a basic sound effect, such as a click, you can use the <kbd>AudioManager</kbd> <kbd>playSoundEffect()</kbd> method. Here's an example:</p>
<pre>AudioManager audioManager =(AudioManager)<br/>this.getSystemService(Context.AUDIO_SERVICE);<br/>audioManager.playSoundEffect(SoundEffectConstants.CLICK);</pre>
<p style="margin-bottom: .0001pt" class="NormalPACKT">You can only specify a sound from the <kbd>SoundEffectConstants</kbd>; you cannot use your own sound files.</p>


            

            
        
    

        

                            
                    <h1 class="header-title">See also</h1>
                
            
            
                
<ul>
<li class="BulletPACKT"><kbd>SoundPool</kbd> Developer Docs: <a href="https://developer.android.com/reference/android/media/SoundPool.html">https://developer.android.com/reference/android/media/SoundPool.html</a></li>
</ul>
<ul>
<li style="margin-bottom: 4.3pt" class="BulletEndPACKT"><kbd>AudioManager</kbd> Developer Docs: <a href="https://developer.android.com/reference/android/media/AudioManager.html">https://developer.android.com/reference/android/media/AudioManager.html</a></li>
</ul>
<p> </p>


            

            
        
    

        

                            
                    <h1 class="header-title">Playing audio with MediaPlayer</h1>
                
            
            
                
<p class="NormalPACKT">MediaPlayer is probably one of the most important classes for adding multimedia capability to your applications. It supports the following media sources:</p>
<ul>
<li class="BulletPACKT">Project resources</li>
<li class="BulletPACKT">Local files</li>
<li class="BulletEndPACKT">External resources (such as URLs, including streaming)</li>
</ul>
<p class="NormalPACKT">MediaPlayer supports the following popular audio files:</p>
<ul>
<li class="BulletPACKT">3GPP (<kbd>.3gp</kbd>)</li>
<li class="BulletPACKT">3GPP (<kbd>.3gp</kbd>)</li>
<li class="BulletPACKT">FLAC (<kbd>.flac</kbd>)</li>
<li class="BulletPACKT">MP3 (<kbd>.mp3</kbd>)</li>
<li class="BulletPACKT">MIDI Type 0 and 1 (<kbd>.mid</kbd>, <kbd>.xmf</kbd>, and <kbd>.mxmf</kbd>)</li>
<li class="BulletPACKT">Ogg (<kbd>.ogg</kbd>)</li>
<li class="BulletEndPACKT">WAVE (<kbd>.wav</kbd>)</li>
</ul>
<p class="NormalPACKT">And it supports these popular file types:</p>
<ul>
<li class="BulletPACKT">3GPP (<kbd>.3gp</kbd>)</li>
<li class="BulletPACKT">Matroska (<kbd>.mkv</kbd>)</li>
<li class="BulletPACKT">WebM (<kbd>.webm</kbd>)</li>
<li class="BulletEndPACKT">MPEG-4 (<kbd>.mp4</kbd>, <kbd>.m4a</kbd>)</li>
</ul>
<p class="NormalPACKT">See the Supported Media Formats link for a complete list, including network protocols.</p>
<p style="margin-bottom: .0001pt" class="NormalPACKT">This recipe will demonstrate how to set up <kbd>MediaPlayer</kbd> in your app to play a sound included with your project. (For a complete review of the full capability offered by <kbd>MediaPlayer</kbd>, see the Developer Docs link at the end of this recipe.)</p>


            

            
        
    

        

                            
                    <h1 class="header-title">Getting ready</h1>
                
            
            
                
<p class="NormalPACKT">Create a new project in Android Studio and call it <kbd>MediaPlayer</kbd>. Use the default Phone &amp; Tablet options and select Empty Activity when prompted for Activity Type.</p>
<p class="NormalPACKT">We will also need a sound for this recipe and will use the same longer playing "water" sound used in the previous recipe:</p>
<p class="mce-root"><a href="http://soundbible.com/2032-Water.html">http://soundbible.com/2032-Water.html</a></p>


            

            
        
    

        

                            
                    <h1 class="header-title">How to do it...</h1>
                
            
            
                
<p class="NormalPACKT">As explained previously, we'll need a sound file to include in the project. Once you have your sound file ready, follow these steps:</p>
<ol>
<li class="NormalPACKT">Create a new raw folder (File | New | Android resource directory) and chose raw in the Resource type dropdown.</li>
<li>Copy your sound file to <kbd>res/raw</kbd> as <kbd>sound_1</kbd>. (Keep the original extension.)</li>
<li class="NumberedBulletPACKT">Open <kbd>activity_main.xml</kbd> and replace the existing <kbd>TextView</kbd> with the following buttons:</li>
</ol>
<pre style="padding-left: 60px">&lt;Button<br/>    android:id="@+id/buttonPlay"<br/>    android:layout_width="100dp"<br/>    android:layout_height="wrap_content"<br/>    android:text="Play"<br/>    android:onClick="buttonPlay" /&gt;<br/>&lt;Button<br/>    android:text="Pause"<br/>    android:layout_width="100dp"<br/>    android:layout_height="wrap_content"<br/>    android:id="@+id/buttonPause"<br/>    android:onClick="buttonPause"<br/>    app:layout_constraintTop_toBottomOf="@+id/buttonPlay"/&gt;<br/>&lt;Button<br/>    android:text="Stop"<br/>    android:layout_width="100dp"<br/>    android:layout_height="wrap_content"<br/>    android:id="@+id/buttonStop"<br/>    android:onClick="buttonStop"<br/>    app:layout_constraintTop_toBottomOf="@+id/buttonPause"/&gt;</pre>
<ol start="4">
<li class="NumberedBulletPACKT">Now, open <kbd>ActivityMain.java</kbd> and add the following global variable:</li>
</ol>
<pre style="padding-left: 60px" class="CodeWithinBulletsEndPACKT">MediaPlayer mMediaPlayer;</pre>
<ol start="5">
<li class="NumberedBulletPACKT">Add the <kbd>buttonPlay()</kbd> method:</li>
</ol>
<pre style="padding-left: 60px" class="CodeWithinBulletsPACKT">public void buttonPlay(View view){<br/>    if (mMediaPlayer==null) {<br/>        mMediaPlayer = MediaPlayer.create(this, R.raw.sound_1);<br/>        mMediaPlayer.setLooping(true);<br/>        mMediaPlayer.start();<br/>    } else  {<br/>        mMediaPlayer.start();<br/>    }<br/>}</pre>
<ol start="6">
<li class="NumberedBulletPACKT">Add the <kbd>buttonPause()</kbd> method:</li>
</ol>
<pre style="padding-left: 60px" class="CodeWithinBulletsPACKT">public void buttonPause(View view){<br/>    if (mMediaPlayer!=null &amp;&amp; mMediaPlayer.isPlaying()) {<br/>        mMediaPlayer.pause();<br/>    }<br/>}</pre>
<ol start="7">
<li class="NumberedBulletPACKT">Add the <kbd>buttonStop()</kbd> method:</li>
</ol>
<pre style="padding-left: 60px" class="CodeWithinBulletsPACKT">public void buttonStop(View view){<br/>    if (mMediaPlayer!=null) {<br/>        mMediaPlayer.stop();<br/>        mMediaPlayer.release();<br/>        mMediaPlayer = null;<br/>    }<br/>}</pre>
<ol start="8">
<li class="NumberedBulletPACKT">Finally, override the <kbd>onStop()</kbd> callback with the following code:</li>
</ol>
<pre style="padding-left: 60px">@Override<br/>protected void onStop() {<br/>    super.onStop();<br/>    if (mMediaPlayer!=null) {<br/>        mMediaPlayer.release();<br/>        mMediaPlayer = null;<br/>    }<br/>}</pre>
<ol start="9">
<li class="NumberedBulletEndPACKT">You're ready to run the application on a device or emulator.</li>
</ol>


            

            
        
    

        

                            
                    <h1 class="header-title">How it works...</h1>
                
            
            
                
<p class="NormalPACKT">The code here is pretty straightforward. We create MediaPlayer with our sound and start playing the sound. The buttons will replay, pause, and stop accordingly.</p>
<p style="margin-bottom: .0001pt" class="NormalPACKT">Even this basic example illustrates one very important concept regarding MediaPlayer, and that is the state. If you're making serious use of MediaPlayer, review the link provided later for detailed information.</p>


            

            
        
    

        

                            
                    <h1 class="header-title">There's more...</h1>
                
            
            
                
<p class="NormalPACKT">To make our demonstration easier to follow, we use the UI thread for all our operations. For this example, using a short audio file included with the project, we aren't likely to experience any UI delays. In general, it's a good idea to use a background thread when preparing <kbd>MediaPlayer</kbd>. To make this common task easier, <kbd>MediaPlayer</kbd> already includes an asynchronous prepare method called <kbd>prepareAsync()</kbd>. The following code will create an <kbd>OnPreparedListener()</kbd> listener and use the <kbd>prepareAsync()</kbd> method:</p>
<pre>mMediaPlayer = new MediaPlayer();<br/>mMediaPlayer.setOnPreparedListener(new MediaPlayer.OnPreparedListener() {<br/>    @Override<br/>    public void onPrepared(MediaPlayer mp) {<br/>        mMediaPlayer.start();<br/>    }<br/>});<br/>try {<br/>    mMediaPlayer.setDataSource(/*URI, URL or path here*/));<br/>} catch (IOException e) {<br/>    e.printStackTrace();<br/>}<br/>mMediaPlayer.prepareAsync();</pre>


            

            
        
    

        

                            
                    <h1 class="header-title">Playing music in the background</h1>
                
            
            
                
<p class="NormalPACKT">Our example is meant to play audio when the application is in the foreground, and will release the <kbd>MediaPlayer</kbd> resources in the <kbd>onStop()</kbd> callback. What if you are creating a music player and want to play music in the background, even when the user is using another application? In that scenario, you'll want to use <kbd>MediaPlayer</kbd> in a service, instead of an activity. You'll use the <kbd>MediaPlayer</kbd> library the same way; you'll just need to pass information (such as sound selection) from the UI to your service.</p>
<div><p>Note that since a service runs in the same UI thread as the activities, you still do not want to perform potentially blocking operations in a service. MediaPlayer does handle background threads to prevent blocking your UI thread; otherwise, you would want to perform threading yourself. (See <a href="98c7bc7b-43e2-43de-aed4-fe2fb6dc72f3.xhtml" target="_blank">Chapter 15</a>, <em>Getting Your App Ready for the Play Store</em> for more information on threading and options.)</p>
</div>


            

            
        
    

        

                            
                    <h1 class="header-title">Using hardware volume keys to control your app's audio volume</h1>
                
            
            
                
<p class="NormalPACKT">If you want the volume controls to control the volume in your app, use the <kbd>setVolumeControlStream()</kbd> method to specify your application's audio stream, as follows:</p>
<pre>setVolumeControlStream(AudioManager.STREAM_MUSIC);</pre>
<p style="margin-bottom: .0001pt" class="NormalPACKT">See the <kbd>AudioManager</kbd> link below for other streaming options.</p>


            

            
        
    

        

                            
                    <h1 class="header-title">See also</h1>
                
            
            
                
<ul>
<li class="NormalPACKT">Supported media formats: <a href="https://developer.android.com/guide/appendix/media-formats.html">https://developer.android.com/guide/appendix/media-formats.html</a></li>
<li class="NormalPACKT"><kbd>MediaPlayer</kbd> developer docs: <a href="http://developer.android.com/reference/android/media/MediaPlayer.html">http://developer.android.com/reference/android/media/MediaPlayer.html</a></li>
<li style="margin-bottom: .0001pt" class="BulletEndPACKT"><kbd>AudioManager</kbd> developer docs: <a href="https://developer.android.com/reference/android/media/AudioManager.html">https://developer.android.com/reference/android/media/AudioManager.html</a></li>
</ul>


            

            
        
    

        

                            
                    <h1 class="header-title">Responding to hardware media controls in your app</h1>
                
            
            
                
<p class="NormalPACKT">Having your app respond to media controls (like on headphones), such as Play, Pause, Skip, and so on, is a nice touch your users will appreciate. Android makes this possible through the media library. As with the <em>Playing sound effects with SoundPool</em> recipe earlier, the Lollipop release changed how this is done. Unlike the <kbd>SoundPool</kbd> example, this recipe is able to take advantage of another approach, the compatibility library.</p>
<p style="margin-bottom: .0001pt" class="NormalPACKT">This recipe will show you how to set up <kbd>MediaSession</kbd> to respond to the hardware buttons, which will work on Lollipop and later, as well as previous Lollipop versions using the <kbd>MediaSessionCompat</kbd> library. (The compatibility library will take care of checking the OS version and using the correct API calls automatically.)</p>


            

            
        
    

        

                            
                    <h1 class="header-title">Getting ready</h1>
                
            
            
                
<p style="margin-bottom: .0001pt" class="NormalPACKT">Create a new project in Android Studio and call it <kbd>HardwareMediaControls</kbd>.  Use the default Phone &amp; Tablet options and select Empty Activity on the Add an Activity to Mobile dialog.</p>


            

            
        
    

        

                            
                    <h1 class="header-title">How to do it...</h1>
                
            
            
                
<p class="NormalPACKT">We'll just be using Toast messages to respond to the hardware events and therefore will not need to make any changes to the activity layout. The first step is to add the V13 support library to the project. Start by opening <kbd>build.gradle (Module: app)</kbd> and perform the following steps:</p>
<ol>
<li>Add the following library to the dependency section:</li>
</ol>
<pre style="padding-left: 60px">implementation 'com.android.support:support-v13:28.0.0-rc02'</pre>
<ol start="2">
<li>Next, open <kbd>ActivityMain.java</kbd> and add the following <kbd>mMediaSessionCallback</kbd> to the class declaration:</li>
</ol>
<pre style="padding-left: 60px">MediaSessionCompat.Callback mMediaSessionCallback = new MediaSessionCompat.Callback() {<br/>    @Override<br/>    public void onPlay() {<br/>        super.onPlay();<br/>        Toast.makeText(MainActivity.this, "onPlay()", Toast.LENGTH_SHORT).show();<br/>    }<br/>    @Override<br/>    public void onPause() {<br/>        super.onPause();<br/>        Toast.makeText(MainActivity.this, "onPause()", Toast.LENGTH_SHORT).show();<br/>    }<br/>    @Override<br/>    public void onSkipToNext() {<br/>        super.onSkipToNext();<br/>        Toast.makeText(MainActivity.this, "onSkipToNext()", Toast.LENGTH_SHORT).show();<br/>    }<br/>    @Override<br/>    public void onSkipToPrevious() {<br/>        super.onSkipToPrevious();<br/>        Toast.makeText(MainActivity.this, "onSkipToPrevious()", Toast.LENGTH_SHORT).show();<br/>    }<br/>};</pre>
<ol start="3">
<li>Add the following code to the existing <kbd>onCreate()</kbd> callback:</li>
</ol>
<pre style="padding-left: 60px">MediaSessionCompat mediaSession = <br/>        new MediaSessionCompat(this, getApplication().getPackageName());<br/>mediaSession.setCallback(mMediaSessionCallback);<br/>mediaSession.setFlags(MediaSessionCompat.FLAG_HANDLES_MEDIA_BUTTONS);<br/>mediaSession.setActive(true);<br/>PlaybackStateCompat state = new PlaybackStateCompat.Builder()<br/>        .setActions(PlaybackStateCompat.ACTION_PLAY |<br/>                PlaybackStateCompat.ACTION_PLAY_PAUSE |<br/>                PlaybackStateCompat.ACTION_PAUSE |<br/>                PlaybackStateCompat.ACTION_SKIP_TO_NEXT |<br/>                PlaybackStateCompat.ACTION_SKIP_TO_PREVIOUS).build();<br/>mediaSession.setPlaybackState(state);</pre>
<ol start="4">
<li>Run the application on a device or emulator with media controls (such as headphones) to see the Toast messages.</li>
</ol>


            

            
        
    

        

                            
                    <h1 class="header-title">How it works...</h1>
                
            
            
                
<p class="NormalPACKT">There are four steps to setting this up:</p>
<ol>
<li class="NumberedBulletPACKT">Create a <kbd>MediaSession.Callback</kbd> and attach it to <kbd>MediaSession</kbd></li>
<li class="NumberedBulletPACKT">Set the <kbd>MediaSession</kbd> flags to indicate we want media buttons</li>
<li class="NumberedBulletPACKT">Set <kbd>SessionState</kbd> to active</li>
<li class="NumberedBulletEndPACKT">Set <kbd>PlayBackState</kbd> with the actions we're going to handle</li>
</ol>
<p class="NormalPACKT">Steps 4 and 1 work together as the callback will only get the events set in the <kbd>PlayBackState</kbd>.</p>
<p class="NormalPACKT">Since we're not actually controlling any playback in this recipe, we just demonstrate how to respond to the hardware events. You'll want to implement actual functionality in <kbd>PlayBackState</kbd> and include a call to <kbd>setState()</kbd> after the <kbd>setActions()</kbd> call.</p>
<p style="margin-bottom: .0001pt" class="NormalPACKT">This is a very nice example of how the changes to the API can make things easier. And since the new <kbd>MediaSession</kbd> and <kbd>PlaybackState</kbd> were rolled into the <kbd>Compatibility</kbd> library, we can take advantage of these new APIs on older versions of the OS.</p>


            

            
        
    

        

                            
                    <h1 class="header-title">There's more...</h1>
                
            
            
                
<p>With all the variety of hardware available on the market, how can your app check what is being used?</p>


            

            
        
    

        

                            
                    <h1 class="header-title">Checking the hardware type</h1>
                
            
            
                
<p class="NormalPACKT">If you want your app to respond differently based on the current output hardware, you can use <kbd>AudioManager</kbd> to check. The following is an example:</p>
<pre class="CodePACKT">AudioManager audioManager =(AudioManager) this.getSystemService(Context.AUDIO_SERVICE);<br/>if (audioManager.isBluetoothA2dpOn()) {<br/>    // Adjust output for Bluetooth.<br/>} else if (audioManager.isSpeakerphoneOn()) {<br/>    // Adjust output for Speakerphone.<br/>} else if (audioManager.isWiredHeadsetOn()) {<br/>    //Only checks if a wired headset is plugged in<br/>    //May not be the audio output<br/>} else {<br/>    // Regular speakers?<br/>}</pre>


            

            
        
    

        

                            
                    <h1 class="header-title">See also</h1>
                
            
            
                
<ul>
<li class="BulletPACKT"><kbd>MediaSession</kbd> developer docs: <a href="https://developer.android.com/reference/android/media/session/MediaSession.html">https://developer.android.com/reference/android/media/session/MediaSession.html</a></li>
</ul>
<ul>
<li class="BulletPACKT"><kbd>MediaSessionCompat</kbd> developer docs: <a href="https://developer.android.com/reference/android/support/v4/media/session/MediaSessionCompat.html">https://developer.android.com/reference/android/support/v4/media/session/MediaSessionCompat.html</a></li>
</ul>
<ul>
<li class="BulletPACKT"><kbd>PlaybackState</kbd> developer docs: <a href="https://developer.android.com/reference/android/support/v4/media/session/PlaybackStateCompat.html">https://developer.android.com/reference/android/support/v4/media/session/PlaybackStateCompat.html</a></li>
</ul>
<ul>
<li style="margin-bottom: 4.3pt" class="BulletEndPACKT"><kbd>PlaybackStateCompat</kbd> developer docs: <a href="https://developer.android.com/reference/android/support/v4/media/session/PlaybackStateCompat.html">https://developer.android.com/reference/android/support/v4/media/session/PlaybackStateCompat.html</a></li>
</ul>


            

            
        
    

        

                            
                    <h1 class="header-title">Taking a photo with the default camera app</h1>
                
            
            
                
<p class="NormalPACKT">If your application needs an image from the camera, but is not a camera replacement app, it may be better to allow the default camera app to take the picture. This also respects your user's preferred camera application.</p>
<p style="margin-bottom: .0001pt" class="NormalPACKT">When you take a photo, unless it is specific to your application, it's considered good practice to make the photo publicly available. (This allows it to be included in the user's photo gallery.) This recipe will demonstrate using the default photo application to click a picture, save it to the public folder, and display the image.</p>


            

            
        
    

        

                            
                    <h1 class="header-title">Getting ready</h1>
                
            
            
                
<p style="margin-bottom: .0001pt" class="NormalPACKT">Create a new project in Android Studio and call it <kbd>UsingTheDefaultCameraApp</kbd>.  Use the default Phone &amp; Tablet options and select Empty Activity on the Add an Activity to Mobile dialog.</p>


            

            
        
    

        

                            
                    <h1 class="header-title">How to do it...</h1>
                
            
            
                
<p class="NormalPACKT">We're going to create a layout with an ImageView and button. The button will create an Intent to launch the default Camera app. When the camera app is done, our app will get a callback. We'll check the result and display the picture if available. Start by opening the Android Manifest and follow these steps:</p>
<ol>
<li class="NumberedBulletPACKT">Add the following permission:</li>
</ol>
<pre style="padding-left: 60px">&lt;uses-permission android:name="android.permission.READ_EXTERNAL_STORAGE" /&gt;</pre>
<ol start="2">
<li class="NumberedBulletPACKT">Open <kbd>activity_main.xml</kbd> and replace the existing TextView with the following views:</li>
</ol>
<pre style="padding-left: 60px">&lt;android.support.v7.widget.AppCompatImageView<br/> android:id="@+id/imageView"<br/> android:layout_width="wrap_content"<br/> android:layout_height="wrap_content"<br/> android:src="img/ic_launcher"<br/> app:layout_constraintTop_toTopOf="parent"<br/> app:layout_constraintLeft_toLeftOf="parent"<br/> app:layout_constraintRight_toRightOf="parent" /&gt;<br/>&lt;android.support.v7.widget.AppCompatButton<br/> android:id="@+id/button"<br/> android:layout_width="wrap_content"<br/> android:layout_height="wrap_content"<br/> android:text="Take Picture"<br/> android:onClick="takePicture"<br/> app:layout_constraintBottom_toBottomOf="parent"<br/> app:layout_constraintLeft_toLeftOf="parent"<br/> app:layout_constraintRight_toRightOf="parent"/&gt;</pre>
<ol start="3">
<li class="NumberedBulletPACKT">Open <kbd>MainActivity.java</kbd> and add the following global variables to the <kbd>MainActivity</kbd> class:</li>
</ol>
<pre style="padding-left: 60px" class="CodeWithinBulletsPACKT">final int PHOTO_RESULT=1;<br/>private Uri mLastPhotoURI=null;</pre>
<ol start="4">
<li class="NumberedBulletPACKT">Add the following method to create the URI for the photo:</li>
</ol>
<pre style="padding-left: 60px">private Uri createFileURI() {<br/>    String timeStamp = new SimpleDateFormat("yyyyMMdd_HHmmss")<br/>            .format(System.currentTimeMillis());<br/>    String fileName = "PHOTO_" + timeStamp + ".jpg";<br/>    return Uri.fromFile(new File(Environment<br/>            .getExternalStoragePublicDirectory(Environment.DIRECTORY_PICTURES),fileName));<br/>}</pre>
<ol start="5">
<li class="NumberedBulletPACKT">Add the following method to handle the button click:</li>
</ol>
<pre style="padding-left: 60px">public void takePicture(View view) {<br/>    Intent takePictureIntent = new Intent(MediaStore.ACTION_IMAGE_CAPTURE);<br/>    if (takePictureIntent.resolveActivity(getPackageManager()) != null) {<br/>        mLastPhotoURI = createFileURI();<br/>        takePictureIntent.putExtra(MediaStore.EXTRA_OUTPUT, mLastPhotoURI);<br/>        startActivityForResult(takePictureIntent, PHOTO_RESULT);<br/>    }<br/>}</pre>
<ol start="6">
<li class="NumberedBulletPACKT">Add a new method to override <kbd>onActivityResult()</kbd> as follows:</li>
</ol>
<pre style="padding-left: 60px">@Override<br/>protected void onActivityResult(int requestCode, int resultCode, Intent data) {<br/>    if (requestCode == PHOTO_RESULT &amp;&amp; resultCode == RESULT_OK ) {<br/>        AppCompatImageView imageView = findViewById(R.id.imageView);<br/>        imageView.setImageBitmap(BitmapFactory.decodeFile(mLastPhotoURI.getPath()));<br/>    }<br/>}</pre>
<p style="padding-left: 60px">7. Add the following code to the end of the existing <kbd>onCreate()</kbd> method: </p>
<pre style="padding-left: 60px">StrictMode.VmPolicy.Builder builder = new StrictMode.VmPolicy.Builder();<br/>StrictMode.setVmPolicy(builder.build());<br/><br/>if (ContextCompat.checkSelfPermission(this, Manifest.permission.READ_EXTERNAL_STORAGE) <br/>        != PackageManager.PERMISSION_GRANTED ) {<br/>    ActivityCompat.requestPermissions(this, <br/>            new String[] {Manifest.permission.READ_EXTERNAL_STORAGE},0);<br/>}</pre>
<p style="padding-left: 60px">8. You're ready to run the application on a device or emulator.</p>


            

            
        
    

        

                            
                    <h1 class="header-title">How it works...</h1>
                
            
            
                
<p class="NormalPACKT">There are two parts to working with the default camera app. The first is to set up the Intent to launch the app. We create the Intent using <kbd>MediaStore.ACTION_IMAGE_CAPTURE</kbd> to indicate we want a photo app. We verify a default app exists by checking the results from <kbd>resolveActivity()</kbd>. As long as it's not null, we know an application is available to handle the Intent. (Otherwise, our app will crash.) We create a filename and add it to the Intent with <kbd>putExtra(MediaStore.EXTRA_OUTPUT, mLastPhotoURI)</kbd>.</p>
<p style="margin-bottom: .0001pt" class="NormalPACKT">When we get the callback in <kbd>onActivityResult()</kbd>, we first make sure it's <kbd>PHOTO_RESULT</kbd> and <kbd>RESULT_OK</kbd> (the user could have cancelled), then we load the photo in ImageView.</p>
<p>You might be wondering what the <kbd>StrictMode</kbd> calls are for in <kbd>onCreate()</kbd>. Basically, those lines of code disable an additional security check made by the OS. If we don't disable StrictMode, the app will crash when creating the file URI with a <kbd>FileUriExposedException</kbd> exception.  For a production app, one solution would be to create a FileProvider as we did in the <em>Accessing External Storage with Scoped Directories</em> recipe from <a href="2bf1b0ac-516b-48e1-95f6-ce76f2046d20.xhtml" target="_blank">Chapter 7</a>, <em>Data Storage</em>. Refer to the <em>See also</em> section for other options.</p>


            

            
        
    

        

                            
                    <h1 class="header-title">There's more...</h1>
                
            
            
                
<p class="NormalPACKT">If you don't care where the picture is stored, you can call the Intent without using the <kbd>MediaStore.EXTRA_OUTPUT</kbd> extra. If you don't specify the output file, <kbd>onActivityResult()</kbd> will include a thumbnail of the image in the data Intent. The following is how you can display the thumbnail:</p>
<pre class="CodePACKT">if (data != null) {<br/>    imageView.setImageBitmap((Bitmap) data.getExtras().get(“data”));<br/>}</pre>
<p class="NormalPACKT">Here's the code to load the full resolution image, using the URI returned in the data Intent:</p>
<pre class="CodePACKT">if (data != null) {<br/>    try {<br/>        imageView.setImageBitmap(<br/>            MediaStore.Images.Media. getBitmap(getContentResolver(),<br/>            Uri.parse(data.toUri(Intent.URI_ALLOW_UNSAFE))));<br/>    } catch (IOException e) {<br/>        e.printStackTrace();<br/>    }<br/>}</pre>


            

            
        
    

        

                            
                    <h1 class="header-title">Calling the default video app</h1>
                
            
            
                
<p class="NormalPACKT">It's the same process if you want to call the default video capture application. Just change the Intent in step 5, as follows:</p>
<pre class="CodeEndPACKT">Intent takeVideoIntent = new Intent(MediaStore.ACTION_VIDEO_CAPTURE);</pre>
<p class="NormalPACKT">You can get the URI to the video in <kbd>onActivityResult()</kbd>, as follows:</p>
<pre style="margin-bottom: .0001pt" class="CodeEndPACKT">Uri videoUri = intent.getData();</pre>


            

            
        
    

        

                            
                    <h1 class="header-title">See also</h1>
                
            
            
                
<ul>
<li style="margin-bottom: .0001pt" class="BulletEndPACKT">The <em>Scaling down large images to avoid Out of Memory exceptions</em> recipe in <a href="a9bb5495-da76-415c-b83e-c75d0b8ce4fd.xhtml" target="_blank">Chapter 10</a><em>, Graphics and Animation</em></li>
<li>The <em>Accessing External Storage with Scoped Directories</em> recipe in <a href="2bf1b0ac-516b-48e1-95f6-ce76f2046d20.xhtml" target="_blank">Chapter 7</a>, <em>Data Storage</em><br/></li>
</ul>


            

            
        
    

        

                            
                    <h1 class="header-title">Taking a picture using the Camera2 API</h1>
                
            
            
                
<p class="NormalPACKT">The previous recipe demonstrated how to use an Intent to call the default photo application. If you only need a quick photo, the Intent is probably the ideal solution. If not, and you need more control over the camera, this recipe will show you how to use the camera directly with the Camera2 API.</p>
<p>Now that 85% of devices are using Android 5.0 or later, this recipe focuses only on the Camera2 API.  (Google has already deprecated the original Camera API.)</p>


            

            
        
    

        

                            
                    <h1 class="header-title">Getting ready</h1>
                
            
            
                
<p style="margin-bottom: .0001pt" class="NormalPACKT">Create a new project in Android Studio and call it Camera2API. In the Target Android Devices dialog, select the Phone &amp; Tablet option and choose API 21: Android 5.0 (Lollipop), or later, for the minimum SDK. Select Empty Activity on the Add an Activity to Mobile dialog.</p>


            

            
        
    

        

                            
                    <h1 class="header-title">How to do it...</h1>
                
            
            
                
<p class="NormalPACKT">As you'll see, there's a lot of code for this recipe. Start by opening the Android Manifest and following these steps:</p>
<ol>
<li class="NumberedBulletPACKT">Add the following two permissions:</li>
</ol>
<pre style="padding-left: 60px">&lt;uses-permission android:name="android.permission.CAMERA" /&gt;<br/>&lt;uses-permission android:name="android.permission.WRITE_EXTERNAL_STORAGE" /&gt;</pre>
<ol start="2">
<li class="NumberedBulletPACKT">Now, open <kbd>activity_main.xml</kbd> and replace the existing TextView with the following views:</li>
</ol>
<pre style="padding-left: 60px">&lt;TextureView<br/>    android:id="@+id/textureView"<br/>    android:layout_width="match_parent"<br/>    android:layout_height="match_parent"<br/>    app:layout_constraintTop_toTopOf="parent"<br/>    app:layout_constraintBottom_toTopOf="@+id/button"<br/>    app:layout_constraintLeft_toLeftOf="parent"<br/>    app:layout_constraintRight_toRightOf="parent" /&gt;<br/>&lt;android.support.v7.widget.AppCompatButton<br/>    android:id="@+id/button"<br/>    android:layout_width="wrap_content"<br/>    android:layout_height="wrap_content"<br/>    android:text="Take Picture"<br/>    android:onClick="takePictureClick"<br/>    app:layout_constraintBottom_toBottomOf="parent"<br/>    app:layout_constraintLeft_toLeftOf="parent"<br/>    app:layout_constraintRight_toRightOf="parent"/&gt;</pre>
<ol start="3">
<li class="NumberedBulletPACKT">Now, open <kbd>MainActivity.java </kbd>and add the following global variables to the <kbd>MainActivity</kbd> class:</li>
</ol>
<pre style="padding-left: 60px" class="CodeWithinBulletsPACKT">private CameraDevice mCameraDevice = null;<br/>private CaptureRequest.Builder mCaptureRequestBuilder = null;<br/>private CameraCaptureSession mCameraCaptureSession  = null;<br/>private TextureView mTextureView = null;<br/>private Size mPreviewSize = null;</pre>
<ol start="4">
<li class="NumberedBulletPACKT">Add the following <kbd>Comparator</kbd> class to the <kbd>MainActivity</kbd> class:</li>
</ol>
<pre style="padding-left: 60px">static class CompareSizesByArea implements Comparator&lt;Size&gt; {<br/>    @Override<br/>    public int compare(Size lhs, Size rhs) {<br/>        return Long.signum((long) lhs.getWidth() * lhs.getHeight() <br/>                - (long) rhs.getWidth() * rhs.getHeight());<br/>    }<br/>}</pre>
<ol start="5">
<li class="NumberedBulletPACKT">Add the following <kbd>CameraCaptureSession.StateCallback</kbd>:</li>
</ol>
<pre style="padding-left: 60px">private CameraCaptureSession.StateCallback mPreviewStateCallback = new CameraCaptureSession.StateCallback() {<br/>    @Override<br/>    public void onConfigured(CameraCaptureSession session) {<br/>        startPreview(session);<br/>    }<br/>    @Override<br/>    public void onConfigureFailed(CameraCaptureSession session) {}<br/>};</pre>
<ol start="6">
<li class="NumberedBulletPACKT">Add the following <kbd>SurfaceTextureListener</kbd>:</li>
</ol>
<pre style="padding-left: 60px">private TextureView.SurfaceTextureListener mSurfaceTextureListener =<br/>        new TextureView.SurfaceTextureListener() {<br/>            @Override<br/>            public void onSurfaceTextureUpdated(SurfaceTexture     <br/>            surface)                        <br/>            {<br/>            }<br/>            @Override<br/>            public void onSurfaceTextureSizeChanged(<br/>                    SurfaceTexture surface, int width, int height) {<br/>            }<br/>            @Override<br/>            public boolean onSurfaceTextureDestroyed(SurfaceTexture <br/>            surface) {<br/>                return false;<br/>            }<br/>            @Override<br/>            public void onSurfaceTextureAvailable(<br/>                    SurfaceTexture surface, int width, int height) {<br/>                openCamera();<br/>            }<br/>        };</pre>
<ol start="7">
<li>Add <kbd>CameraDevice.StateCallback</kbd> as follows:</li>
</ol>
<pre style="padding-left: 60px">private CameraDevice.StateCallback mStateCallback = new CameraDevice.StateCallback() {<br/>    @Override<br/>    public void onOpened(CameraDevice camera) {<br/>        mCameraDevice = camera;<br/>        SurfaceTexture texture = mTextureView.getSurfaceTexture();<br/>        if (texture == null) {<br/>            return;<br/>        }<br/>        texture.setDefaultBufferSize(mPreviewSize.getWidth(), <br/>        mPreviewSize.getHeight());<br/>        Surface surface = new Surface(texture);<br/>        try {<br/>            mCaptureRequestBuilder = mCameraDevice<br/>                    <br/>        .createCaptureRequest(CameraDevice.TEMPLATE_PREVIEW);<br/>        } catch (CameraAccessException e){<br/>            e.printStackTrace();<br/>        }<br/>        mCaptureRequestBuilder.addTarget(surface);<br/>        try {<br/>            mCameraDevice.createCaptureSession(Arrays<br/>                    .asList(surface), mPreviewStateCallback, null);<br/>        } catch (CameraAccessException e) {<br/>            e.printStackTrace();<br/>        }<br/>    }<br/>    @Override<br/>    public void onError(CameraDevice camera, int error) {}<br/>    @Override<br/>    public void onDisconnected(CameraDevice camera) {}<br/>};</pre>
<ol start="8">
<li>Add the following <kbd>CaptureCallback</kbd> class to receive the capture completed event: </li>
</ol>
<pre style="padding-left: 60px">final CameraCaptureSession.CaptureCallback mCaptureCallback = <br/>        new CameraCaptureSession.CaptureCallback() {<br/>    @Override<br/>    public void onCaptureCompleted(CameraCaptureSession session,  <br/>     CaptureRequest request,                                  <br/>     TotalCaptureResult result) {<br/>        super.onCaptureCompleted(session, request, result);<br/>        Toast.makeText(MainActivity.this, "Picture Saved", <br/>        Toast.LENGTH_SHORT).show();<br/>        startPreview(session);<br/>    }<br/>};</pre>
<p class="mce-root"/>
<ol start="9">
<li class="NumberedBulletPACKT">Add the following code to the existing <kbd>onCreate()</kbd> callback:</li>
</ol>
<pre style="padding-left: 60px">mTextureView = findViewById(R.id.textureView);<br/>mTextureView.setSurfaceTextureListener(mSurfaceTextureListener);<br/><br/>if(ActivityCompat.checkSelfPermission(this, Manifest.permission.CAMERA) <br/>        != PackageManager.PERMISSION_GRANTED) {<br/>    ActivityCompat.requestPermissions(this, new String[]{Manifest.permission.CAMERA}, 1);<br/>}</pre>
<ol start="10">
<li>Add the following methods to override <kbd>onPause()</kbd> and <kbd>onResume()</kbd>:</li>
</ol>
<pre style="padding-left: 60px" class="CodeWithinBulletsPACKT">@Override<br/>protected void onPause() {<br/>    super.onPause();<br/>    if (mCameraDevice != null) {<br/>        mCameraDevice.close();<br/>        mCameraDevice = null;<br/>    }<br/>}<br/>@Override<br/>public void onResume() {<br/>    super.onResume();<br/>    if (mTextureView.isAvailable()) {<br/>        openCamera();<br/>    } else {<br/>        mTextureView.setSurfaceTextureListener(<br/>             mSurfaceTextureListener);<br/>    }<br/>}</pre>
<ol start="11">
<li>Add the <kbd>openCamera()</kbd> method:</li>
</ol>
<pre style="padding-left: 60px">private void openCamera() {<br/>    CameraManager manager = (CameraManager) getSystemService(CAMERA_SERVICE);<br/>    try{<br/>        String cameraId = manager.getCameraIdList()[0];<br/>        CameraCharacteristics characteristics = manager.getCameraCharacteristics(cameraId);<br/>        StreamConfigurationMap map = characteristics<br/>                .get(CameraCharacteristics.SCALER_STREAM_CONFIGURATION_MAP);<br/>        mPreviewSize = map.getOutputSizes(SurfaceTexture.class) [0];<br/>        manager.openCamera(cameraId, mStateCallback, null);<br/>    } catch(CameraAccessException e) {<br/>        e.printStackTrace();<br/>    } catch (SecurityException e) {<br/>        e.printStackTrace();<br/>    }<br/>}</pre>
<ol start="12">
<li>Add the <kbd>startPreview()</kbd> method:</li>
</ol>
<pre style="padding-left: 60px">private void startPreview(CameraCaptureSession session) {<br/>    mCameraCaptureSession = session;<br/>    mCaptureRequestBuilder.set(CaptureRequest.CONTROL_MODE, <br/>    CameraMetadata.CONTROL_MODE_AUTO);<br/>    HandlerThread backgroundThread = new <br/>    HandlerThread("CameraPreview");<br/>    backgroundThread.start();<br/>    Handler backgroundHandler = new Handler(backgroundThread. <br/>    getLooper());<br/>    try {<br/>        mCameraCaptureSession<br/>                .setRepeatingRequest(mCaptureRequestBuilder.build(), <br/>    null, backgroundHandler);<br/>    } catch (CameraAccessException e) {<br/>        e.printStackTrace();<br/>    }<br/>}</pre>
<ol start="13">
<li>Add the <kbd>getPictureFile()</kbd> method:</li>
</ol>
<pre style="padding-left: 60px">private File getPictureFile() {<br/>    String timeStamp = new SimpleDateFormat("yyyyMMdd_HHmmss")<br/>            .format(System.currentTimeMillis());<br/>    String fileName = "PHOTO_" + timeStamp + ".jpg";<br/>    return new File(Environment<br/>            .getExternalStoragePublicDirectory(Environment.DIRECTORY_PICTURES),fileName);<br/>}</pre>
<ol start="14">
<li>Add the following method to save the image file: </li>
</ol>
<pre style="padding-left: 60px">private void saveImage(ImageReader reader) {<br/>    Image image = null;<br/>    try {<br/>        image = reader.acquireLatestImage();<br/>        ByteBuffer buffer = image.getPlanes()[0].getBuffer();<br/>        byte[] bytes = new byte[buffer.capacity()];<br/>        buffer.get(bytes);<br/>        OutputStream output = new FileOutputStream(getPictureFile());<br/>        output.write(bytes);<br/>        output.close();<br/>    } catch (FileNotFoundException e) {<br/>        e.printStackTrace();<br/>    } catch (IOException e) {<br/>        e.printStackTrace();<br/>    } finally {<br/>        if (image != null) {<br/>            image.close();<br/>        }<br/>    }<br/>}</pre>
<ol start="15">
<li>Add the following method to handle the button click: </li>
</ol>
<pre style="padding-left: 60px">public void takePictureClick(View view) {<br/>    if (null == mCameraDevice) {<br/>        return;<br/>    }<br/>    takePicture();<br/>}</pre>
<ol start="16">
<li>Add the final code to actually set up the camera and take the picture:</li>
</ol>
<pre style="padding-left: 60px">private void takePicture() {<br/>    CameraManager manager = (CameraManager) getSystemService(Context.CAMERA_SERVICE);<br/>    try {<br/>        CameraCharacteristics characteristics = manager<br/>                .getCameraCharacteristics(mCameraDevice.getId());<br/>        StreamConfigurationMap configurationMap = characteristics<br/>                <br/>       .get(CameraCharacteristics.SCALER_STREAM_CONFIGURATION_MAP);<br/>        if (configurationMap == null) return;<br/>        Size largest = Collections.max(Arrays.asList(configurationMap<br/>                .getOutputSizes(ImageFormat.JPEG)), new <br/>        CompareSizesByArea());<br/>        ImageReader reader = ImageReader<br/>                .newInstance(largest.getWidth(), largest.getHeight(), <br/>        ImageFormat.JPEG, 1);<br/>        List&lt;Surface&gt; outputSurfaces = new ArrayList&lt;&gt;(2);<br/>        outputSurfaces.add(reader.getSurface());<br/>        outputSurfaces.add(new <br/>        Surface(mTextureView.getSurfaceTexture()));<br/>        final CaptureRequest.Builder captureBuilder = mCameraDevice<br/>                <br/>        .createCaptureRequest(CameraDevice.TEMPLATE_STILL_CAPTURE);<br/>        captureBuilder.addTarget(reader.getSurface());<br/>        captureBuilder.set(CaptureRequest.CONTROL_MODE, <br/>        CameraMetadata.CONTROL_MODE_AUTO);<br/>        ImageReader.OnImageAvailableListener readerListener =<br/>                new ImageReader.OnImageAvailableListener() {<br/>            @Override<br/>            public void onImageAvailable(ImageReader reader) {<br/>                saveImage(reader);<br/>            }<br/>        };<br/>        HandlerThread thread = new HandlerThread("CameraPicture");<br/>        thread.start();<br/>        final Handler backgroundHandler = new <br/>        Handler(thread.getLooper());<br/>        reader.setOnImageAvailableListener(readerListener, <br/>        backgroundHandler);<br/>        mCameraDevice.createCaptureSession(outputSurfaces,<br/>                new CameraCaptureSession.StateCallback() {<br/>                    @Override<br/>                    public void onConfigured(CameraCaptureSession <br/>                    session) {<br/>                        try {<br/>                            session.capture(captureBuilder.build(),<br/>                                    mCaptureCallback, <br/>                       backgroundHandler);<br/>                        } catch (CameraAccessException e) {<br/>                            e.printStackTrace();<br/>                        }<br/>                    }<br/>                    @Override<br/>                    public void onConfigureFailed(CameraCaptureSession <br/>                   session) { }<br/>                }, backgroundHandler);<br/>    } catch (CameraAccessException e) {<br/>        e.printStackTrace();<br/>    }</pre>
<ol start="17">
<li>Run the application on a device or emulator with a camera.</li>
</ol>


            

            
        
    

        

                            
                    <h1 class="header-title">How it works...</h1>
                
            
            
                
<p>As you can see, there are a lot of steps for this recipe, but at a high level, it's pretty simple:</p>
<ul>
<li>Set up the camera preview</li>
<li>Capture the image</li>
</ul>
<p class="NormalPACKT">Now, we'll look at each in detail.</p>


            

            
        
    

        

                            
                    <h1 class="header-title">Setting up the camera preview</h1>
                
            
            
                
<p class="NormalPACKT">Here's a rundown on how the code sets up the preview:</p>
<ol>
<li class="NumberedBulletPACKT">First, we set up the <kbd>TextureView.SurfaceTextureListener</kbd> with the <kbd>setSurfaceTextureListener()</kbd> method in <kbd>onCreate()</kbd></li>
<li class="NumberedBulletPACKT">When we get the <kbd>onSurfaceTextureAvailable()</kbd> callback, we open the camera</li>
<li class="NumberedBulletPACKT">We pass our <kbd>CameraDevice.StateCallback</kbd> class to the <kbd>openCamera()</kbd> method, which eventually calls the <kbd>onOpened()</kbd> callback</li>
<li class="NumberedBulletPACKT"><kbd>onOpened()</kbd> gets the surface for the preview by calling <kbd>getSurfaceTexture()</kbd> and passes it to the <kbd>CameraDevice</kbd> by calling <kbd>createCaptureSession()</kbd></li>
<li style="margin-bottom: .0001pt" class="NumberedBulletEndPACKT">Finally, when <kbd>CameraCaptureSession.StateCallback</kbd> <kbd>onConfigured()</kbd> is called, we start the preview with the <kbd>setRepeatingRequest()</kbd> method</li>
</ol>


            

            
        
    

        

                            
                    <h1 class="header-title">Capturing the image</h1>
                
            
            
                
<p class="NormalPACKT">Even though the <kbd>takePicture()</kbd> method may appear to be procedural, capturing an image also involves several classes and relies on callbacks. Here's a breakdown of how the code works:</p>
<ol>
<li class="NumberedBulletPACKT">The process starts when the Take Picture button is clicked.</li>
<li class="NumberedBulletPACKT">Then the code queries the camera to find the largest available image size</li>
<li class="NumberedBulletPACKT">Then an ImageReader is created.</li>
<li class="NumberedBulletPACKT">Next, the code sets up <kbd>OnImageAvailableListener</kbd>, and saves the image in the <kbd>onImageAvailable()</kbd> callback.</li>
<li class="NumberedBulletPACKT">Then it creates <kbd>CaptureRequest.Builder</kbd> and includes the <kbd>ImageReader</kbd> surface.</li>
<li class="NumberedBulletPACKT">Next it creates <kbd>CameraCaptureSession.CaptureCallback</kbd>, which defines<br/>
the <kbd>onCaptureCompleted()</kbd> callback. When the capture is complete, it restarts the preview.</li>
<li style="margin-bottom: .0001pt" class="NumberedBulletEndPACKT">Finally, the <kbd>createCaptureSession()</kbd> method is called, creating a <kbd>CameraCaptureSession.StateCallback</kbd>. This is where the <kbd>capture()</kbd> method is called, passing in the <kbd>CameraCaptureSession.CaptureCallback</kbd> created earlier.</li>
</ol>


            

            
        
    

        

                            
                    <h1 class="header-title">There's more...</h1>
                
            
            
                
<p style="margin-bottom: .0001pt" class="NormalPACKT">We've just created the base code to demonstrate a working Camera application. There are many areas for improvement. First, you should handle the device orientation, for both the preview and when saving the images. (See the following links.) Also, with Android 6.0 (API 23) having over 60% of the market share, your apps should already be using the new permission model. Instead of just checking for an exception as we do in the <kbd>openCamera()</kbd> method, it would be better to check for the required permission.</p>


            

            
        
    

        

                            
                    <h1 class="header-title">See also</h1>
                
            
            
                
<ul>
<li class="BulletEndPACKT">Camera2 API Developer Docs <a href="https://developer.android.com/reference/android/hardware/camera2/package-summary.html">https://developer.android.com/reference/android/hardware/camera2/package-summary.html</a></li>
<li class="BulletPACKT">For examples on detecting the current device orientation, refer to <a href="9ec1f7c4-f4c5-4cb3-b10a-59915ba73449.xhtml" target="_blank">Chapter 9</a>, <em>Using the Touchscreen and Sensors</em></li>
<li class="BulletPACKT">The <em>The Android 6.0 Runtime Permission Model</em> recipe in <a href="98c7bc7b-43e2-43de-aed4-fe2fb6dc72f3.xhtml" target="_blank">Chapter 15</a>, <em>Getting your app ready for the Play Store</em><br/></li>
</ul>


            

            
        
    </body></html>