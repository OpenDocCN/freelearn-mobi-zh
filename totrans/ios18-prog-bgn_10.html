<html><head></head><body><div id="book-content"><div id="sbo-rt-content"><div id="_idContainer145" class="Basic-Text-Frame">
    <h1 class="chapterNumber">9</h1>
    <h1 id="_idParaDest-135" class="chapterTitle">Swift Concurrency</h1>
    <p class="normal">Apple introduced <strong class="keyWord">Swift concurrency</strong>, which adds support for structured asynchronous and parallel <a id="_idIndexMarker336"/>programming to Swift 5.5, during WWDC21. It allows you to write concurrent code, which is more readable and easier to understand. During WWDC24, Apple <a id="_idIndexMarker337"/>introduced <strong class="keyWord">Swift 6</strong>, which makes concurrency programming <a id="_idIndexMarker338"/>easier by diagnosing <strong class="keyWord">data races</strong> at compile time.</p>
    <div class="note">
      <p class="normal">At the present time, it is not recommended to turn strict concurrency on for large existing projects, as it is likely to generate multiple errors and warnings. However, as this is Apple’s direction going forward, you will be turning it on for the project in this chapter and in <em class="italic">Part 3</em> of this book so you may learn and gain experience with it.</p>
    </div>
    <p class="normal">In this chapter, you will learn the basic concepts of Swift concurrency. Next, you will examine an <a id="_idIndexMarker339"/>app without concurrency and explore its issues. After that, you will use <code class="inlineCode">async/await</code> to implement concurrency in the app. Finally, you’ll make your app more <a id="_idIndexMarker340"/>efficient by using <code class="inlineCode">async-let</code>.</p>
    <p class="normal">By the end of this chapter, you’ll have learned the basics of how Swift concurrency works and how to update your own apps to use it.</p>
    <p class="normal">The following topics will be covered:</p>
    <ul>
      <li class="bulletList">Understanding Swift concurrency</li>
      <li class="bulletList">Examining an app without concurrency</li>
      <li class="bulletList">Updating the app using <code class="inlineCode">async/await</code></li>
      <li class="bulletList">Improving efficiency using <code class="inlineCode">async-let</code></li>
    </ul>
    <h1 id="_idParaDest-136" class="heading-1">Technical requirements</h1>
    <p class="normal">We will use an example app, <em class="italic">BreakfastMaker</em>, to understand the concepts of Swift concurrency.</p>
    <p class="normal">The completed Xcode project for this chapter is in the <code class="inlineCode">Chapter09</code> folder of the code bundle for this book, which can be downloaded here:</p>
    <p class="normal"><a href="https://github.com/PacktPublishing/iOS-18-Programming-for-Beginners-Ninth-Edition"><span class="url">https://github.com/PacktPublishing/iOS-18-Programming-for-Beginners-Ninth-Edition</span></a></p>
    <p class="normal">Check out the following video to see the code in action:</p>
    <p class="normal"><a href="https://youtu.be/uEckcWHFeiE%0D"><span class="url">https://youtu.be/uEckcWHFeiE</span></a></p>
    <p class="normal">Let’s start by learning about Swift concurrency in the next section.</p>
    <h1 id="_idParaDest-137" class="heading-1">Understanding Swift concurrency</h1>
    <p class="normal">In Swift 5.5, Apple added <a id="_idIndexMarker341"/>support for writing <strong class="keyWord">asynchronous</strong> and <strong class="keyWord">parallel</strong> code in a structured way.</p>
    <p class="normal">Asynchronous <a id="_idIndexMarker342"/>code allows your app to suspend and resume code. Parallel code allows your app to run multiple pieces of code simultaneously. This allows your <a id="_idIndexMarker343"/>app to do things like update the user interface while still performing operations like downloading data from the internet.</p>
    <div class="note">
      <p class="normal">You can <a id="_idIndexMarker344"/>find links to all of Apple’s Swift concurrency videos during WWDC21 at <a href="https://developer.apple.com/news/?id=2o3euotz"><span class="url">https://developer.apple.com/news/?id=2o3euotz</span></a>.</p>
      <p class="normal">You can read Apple’s Swift concurrency documentation at <a href="https://developer.apple.com/news/?id=2o3euotz"><span class="url">https://developer.apple.com/news/?id=2o3euotz</span></a>.</p>
    </div>
    <p class="normal">During WWDC24, Apple released Swift 6. With the Swift 6 language mode, the compiler can now guarantee that concurrent programs are free of data races. This means that code from one part of your app can no longer access the same area of memory that is being modified by code from another part of your app. However, when you create a new Xcode project, it defaults to the Swift 5 language mode, and you have to turn on the Swift 6 language mode to enable this feature.</p>
    <div class="note">
      <p class="normal">To view Apple’s WWDC24 video on migrating your app to Swift 6, click this link: <a href="https://developer.apple.com/videos/play/wwdc2024/10169/%0D"><span class="url">https://developer.apple.com/videos/play/wwdc2024/10169/</span></a></p>
      <p class="normal">To view Apple’s documentation on migrating your app to Swift 6, click this link: <a href="https://www.swift.org/migration/documentation/migrationguide/"><span class="url">https://www.swift.org/migration/documentation/migrationguide/</span></a></p>
    </div>
    <p class="normal">To give you an idea of how Swift concurrency works, imagine that you are making soft-boiled eggs and toast for breakfast. Here is one way of doing it:</p>
    <ol>
      <li class="numberedList" value="1">Put two slices of bread into the toaster.</li>
      <li class="numberedList">Wait two minutes until the bread is toasted.</li>
      <li class="numberedList">Put two eggs in a pan containing boiling water, and cover them.</li>
      <li class="numberedList">Wait seven minutes until the eggs are cooked.</li>
      <li class="numberedList">Plate and serve your breakfast.</li>
    </ol>
    <p class="normal">This takes nine minutes in total. Now, think about this sequence of events. Do you spend that time just staring at the toaster and the pan? You’ll probably be using your phone while <a id="_idIndexMarker345"/>the bread is in the toaster and the eggs are in the pan. In other words, you can do other things while the toast and eggs are being prepared. So, the sequence of events would be more accurately described as follows:</p>
    <ol>
      <li class="numberedList" value="1">Put two slices of bread into the toaster.</li>
      <li class="numberedList">Use your phone for two minutes until the bread is toasted.</li>
      <li class="numberedList">Put two eggs in a pan containing boiling water, and cover them.</li>
      <li class="numberedList">Use your phone for seven minutes until the eggs are cooked.</li>
      <li class="numberedList">Plate and serve your breakfast.</li>
    </ol>
    <p class="normal">Here, you can see that your interaction with the toaster and pan can be suspended and then resumed, which means these operations are asynchronous. The operation still takes nine minutes, but you were able to do other things during that time.</p>
    <p class="normal">There is another factor to consider. You don’t need to wait for the bread to finish toasting before you put the eggs in the pan. This means you could modify the sequence of steps as follows:</p>
    <ol>
      <li class="numberedList" value="1">Put two slices of bread into the toaster.</li>
      <li class="numberedList">While the bread is toasting, put two eggs in a pan containing boiling water, and cover them.</li>
      <li class="numberedList">Use your phone for seven minutes. During that time, the bread will be toasted and the eggs will be cooked.</li>
      <li class="numberedList">Plate and serve your breakfast.</li>
    </ol>
    <p class="normal">Toasting the bread and boiling the eggs are now carried out in parallel, which saves you two minutes. Great! However, do note that you have more things to keep track of.</p>
    <p class="normal">Now that you understand the concepts of asynchronous and parallel operations, let’s study the issues that an app without concurrency has in the next section.</p>
    <h1 id="_idParaDest-138" class="heading-1">Examining an app without concurrency</h1>
    <p class="normal">You’ve seen how asynchronous and parallel operations can help you prepare breakfast faster <a id="_idIndexMarker346"/>and allow you to use your phone while you’re doing it. Now, let’s look at a sample app that simulates the process of preparing breakfast. Initially, this app does not have concurrency implemented so you can see how that affects the app. Follow these steps:</p>
    <ol>
      <li class="numberedList" value="1">If you have not already done so, download the <code class="inlineCode">Chapter09</code> folder of the code bundle for this book at this link: <a href="https://github.com/PacktPublishing/iOS-18-Programming-for-Beginners-Eighth-Edition"><span class="url">https://github.com/PacktPublishing/iOS-18-Programming-for-Beginners-Eighth-Edition</span></a>.</li>
      <li class="numberedList">Open the <code class="inlineCode">Chapter09</code> folder, and you’ll see two folders, <code class="inlineCode">BreakfastMaker-start</code> and <code class="inlineCode">BreakfastMaker-complete</code>. The first folder contains the app that you will be modifying in this chapter, and the second contains the completed app.</li>
      <li class="numberedList">Open the <code class="inlineCode">BreakfastMaker-start</code> folder and then the <code class="inlineCode">BreakfastMaker</code> Xcode project. Click on the <strong class="screenText">Main</strong> storyboard file in the Project navigator. You should see four labels and a button in the <strong class="screenText">View Controller Scene</strong>, as shown here:</li>
    </ol>
    <figure class="mediaobject"><img src="image/B31371_09_01.png" alt="" width="812" height="416"/></figure>
    <p class="packt_figref">Figure 9.1: Main storyboard file showing the View Controller Scene</p>
    <p class="normal-one">The app will display a screen that shows the status of the toast and eggs, and the time taken to plate and serve your breakfast. The app will also display a button that you can use to test the responsiveness of the user interface.</p>
    <div class="note-one">
      <p class="normal">Don’t worry if some of these concepts are not familiar to you. You will learn how to build user interfaces using storyboards for your apps in the next chapter, <em class="chapterRef">Chapter 10</em>, <em class="italic">Setting Up the User Interface</em>.</p>
    </div>
    <ol>
      <li class="numberedList" value="4">Click <a id="_idIndexMarker347"/>the <strong class="screenText">ViewController</strong> file in the Project navigator. You should see the following code in the Editor area:
        <pre class="programlisting code-one"><code class="hljs-code"><span class="hljs-keyword">import</span> UIKit
<span class="hljs-keyword">class</span> <span class="hljs-title">ViewController</span>: <span class="hljs-type">UIViewController</span> {
   <span class="hljs-keyword">@IBOutlet</span> <span class="hljs-keyword">var</span> <span class="hljs-template-variable">toastLabel</span>: <span class="hljs-type">UILabel</span>!
   <span class="hljs-keyword">@IBOutlet</span> <span class="hljs-keyword">var</span> <span class="hljs-template-variable">eggLabel</span>: <span class="hljs-type">UILabel</span>!
   <span class="hljs-keyword">@IBOutlet</span> <span class="hljs-keyword">var</span> <span class="hljs-template-variable">plateAndServeLabel</span>: <span class="hljs-type">UILabel</span>!
   <span class="hljs-keyword">@IBOutlet</span> <span class="hljs-keyword">var</span> <span class="hljs-template-variable">elapsedTimeLabel</span>: <span class="hljs-type">UILabel</span>!
   <span class="hljs-keyword">override</span> <span class="hljs-keyword">func</span> <span class="hljs-template-variable">viewDidAppear</span>(<span class="hljs-keyword">_</span> <span class="hljs-params">animated</span>: <span class="hljs-type">Bool</span>) {
      <span class="hljs-keyword">super</span>.<span class="hljs-con-attribute">viewDidAppear</span>(animated)
      <span class="hljs-keyword">let</span> startTime <span class="hljs-operator">=</span> <span class="hljs-type">Date</span>().<span class="hljs-con-attribute">timeIntervalSince1970</span>
     <span class="hljs-variable"> toastLabel</span>.<span class="hljs-con-attribute">text</span> <span class="hljs-operator">=</span> <span class="hljs-string">"Making toast..."</span>
      <span class="hljs-variable">toastLabel</span>.<span class="hljs-con-attribute">text</span> <span class="hljs-operator">=</span> <span class="hljs-variable">makeToast</span>()
     <span class="hljs-variable"> eggLabel</span>.<span class="hljs-con-attribute">text</span> <span class="hljs-operator">=</span> <span class="hljs-string">"Boiling eggs..."</span>
      <span class="hljs-variable">eggLabel</span>.<span class="hljs-con-attribute">text</span> <span class="hljs-operator">=</span> <span class="hljs-variable">boilEggs</span>()
      <span class="hljs-variable">plateAndServeLabel</span>.<span class="hljs-con-attribute">text</span> <span class="hljs-operator">=</span> <span class="hljs-variable">plateAndServe</span>()
      <span class="hljs-keyword">let</span> endTime <span class="hljs-operator">=</span> <span class="hljs-type">Date</span>().<span class="hljs-con-attribute">timeIntervalSince1970</span>
      <span class="hljs-variable">elapsedTimeLabel</span>.<span class="hljs-type">text</span> <span class="hljs-operator">=</span> <span class="hljs-string">"Elapsed time is</span>
<span class="hljs-string">     </span> \(((endTime - startTime)<span class="hljs-subst"> </span><span class="hljs-operator">*</span><span class="hljs-subst"> </span><span class="hljs-number">100</span>).<span class="hljs-con-attribute">rounded</span>()
<span class="hljs-subst">      </span><span class="hljs-operator">/</span><span class="hljs-subst"> </span><span class="hljs-number">100</span><span class="hljs-subst">)</span><span class="hljs-string"> seconds"</span>
   }
   <span class="hljs-keyword">func</span> <span class="hljs-template-variable">makeToast</span>() -&gt; <span class="hljs-type">String</span> {
      <span class="hljs-con-attribute">sleep</span>(<span class="hljs-number">2</span>)
      <span class="hljs-keyword">return</span> <span class="hljs-string">"Toast done"</span>
   }
   <span class="hljs-keyword">func</span> <span class="hljs-template-variable">boilEggs</span>() -&gt; <span class="hljs-type">String</span> {
      <span class="hljs-con-attribute">sleep</span>(7)
      <span class="hljs-keyword">return</span> <span class="hljs-string">"Eggs done"</span>
   }
   <span class="hljs-keyword">func</span> <span class="hljs-template-variable">plateAndServe</span>() -&gt; <span class="hljs-type">String</span> {
      <span class="hljs-keyword">return</span> <span class="hljs-string">"Plating and serving done"</span>
   }
   <span class="hljs-keyword">@IBAction</span> <span class="hljs-keyword">func</span> <span class="hljs-template-variable">testButton</span>(<span class="hljs-keyword">_</span> <span class="hljs-params">sender</span>: <span class="hljs-type">UIButton</span>) {
      <span class="hljs-con-attribute">print</span>(<span class="hljs-string">"Button tapped"</span>)
   }
}
</code></pre>
      </li>
    </ol>
    <p class="normal-one">As you can see, this code simulates the process of making breakfast that was described in the previous section. Let’s break it down:</p>
    <pre class="programlisting code-one"><code class="hljs-code"><span class="hljs-keyword">@IBOutlet</span> <span class="hljs-keyword">var</span> <span class="hljs-template-variable">toastLabel</span>: <span class="hljs-type">UILabel</span>!
<span class="hljs-keyword">@IBOutlet</span> <span class="hljs-keyword">var</span> <span class="hljs-template-variable">eggLabel</span>: <span class="hljs-type">UILabel</span>!
<span class="hljs-keyword">@IBOutlet</span> <span class="hljs-keyword">var</span> <span class="hljs-template-variable">plateAndServeLabel</span>: <span class="hljs-type">UILabel</span>!
<span class="hljs-keyword">@IBOutlet</span> <span class="hljs-keyword">var</span> <span class="hljs-template-variable">elapsedTimeLabel</span>: <span class="hljs-type">UILabel</span>!
</code></pre>
    <p class="normal-one">These <a id="_idIndexMarker348"/>outlets are linked to four labels in the <code class="inlineCode">Main</code> storyboard file. When you run the app, these labels will display the status of the toast and eggs, plating, and serving, as well as the time taken to complete the process.</p>
    <pre class="programlisting code-one"><code class="hljs-code"><span class="hljs-keyword">override</span>  <span class="hljs-keyword">func</span> <span class="hljs-template-variable">viewDidAppear</span>(<span class="hljs-template-variable">_</span> <span class="hljs-params">animated</span>: <span class="hljs-type">Bool</span>) {
</code></pre>
    <p class="normal-one">This statement method is called when the view controller’s view appears onscreen.</p>
    <pre class="programlisting code-one"><code class="hljs-code"><span class="hljs-keyword">let</span> startTime <span class="hljs-operator">=</span> <span class="hljs-type">Date</span>().<span class="hljs-con-attribute">timeIntervalSince1970</span>
</code></pre>
    <p class="normal-one">This statement sets startTime to the current time, so the app can later calculate how long it takes to make the meal.</p>
    <pre class="programlisting code-one"><code class="hljs-code"><span class="hljs-variable">toastLabel</span>.<span class="hljs-con-attribute">text</span> <span class="hljs-operator">=</span> <span class="hljs-string">"Making toast..."</span>
</code></pre>
    <p class="normal-one">This statement makes toastLabel display the text Making toast....</p>
    <pre class="programlisting code-one"><code class="hljs-code"><span class="hljs-variable">toastLabel</span>.<span class="hljs-con-attribute">text</span> <span class="hljs-operator">=</span> <span class="hljs-variable">makeToast</span>()
</code></pre>
    <p class="normal-one">This statement calls the makeToast() method, which waits for two seconds to simulate the time taken to make toast, and then returns the text Toast done, which will be displayed by toastLabel.</p>
    <pre class="programlisting code-one"><code class="hljs-code"><span class="hljs-variable">eggLabel</span>.<span class="hljs-con-attribute">text</span> <span class="hljs-operator">=</span> <span class="hljs-string">"Boiling eggs..."</span>
</code></pre>
    <p class="normal-one">This statement makes eggLabel display the text Boiling eggs....</p>
    <pre class="programlisting code-one"><code class="hljs-code"><span class="hljs-variable">eggLabel</span>.<span class="hljs-con-attribute">text</span> <span class="hljs-operator">=</span> <span class="hljs-variable">boilEggs</span>()
</code></pre>
    <p class="normal-one">This statement calls the boilEggs() method, which waits for seven seconds to simulate the time taken to boil two eggs, and then returns the text Eggs done, which will be displayed by eggLabel.</p>
    <pre class="programlisting code-one"><code class="hljs-code"><span class="hljs-variable">plateAndServeLabel</span>.<span class="hljs-con-attribute">text</span> <span class="hljs-operator">=</span> <span class="hljs-variable">plateAndServe</span>()
</code></pre>
    <p class="normal-one">This statement calls the plateAndServe() method, which returns the text Plating and serving done, which will be displayed by <code class="inlineCode">plateAndServeLabel</code>.</p>
    <pre class="programlisting code-one"><code class="hljs-code"><span class="hljs-keyword">let</span> endTime <span class="hljs-operator">=</span> <span class="hljs-type">Date</span>().<span class="hljs-con-attribute">timeIntervalSince1970</span>
</code></pre>
    <p class="normal-one">This <a id="_idIndexMarker349"/>statement sets <code class="inlineCode">endTime</code> to the current time.</p>
    <pre class="programlisting code-one"><code class="hljs-code"><span class="hljs-variable">elapsedTimeLabel</span>.<span class="hljs-con-attribute">text</span> <span class="hljs-operator">=</span> <span class="hljs-string">"Elapsed time is</span>
\(((endTime - startTime)<span class="hljs-subst"> </span><span class="hljs-operator">*</span><span class="hljs-subst"> </span><span class="hljs-number">100</span>).<span class="hljs-con-attribute">rounded</span>()
<span class="hljs-operator">/</span><span class="hljs-subst"> </span><span class="hljs-number">100</span><span class="hljs-subst">)</span><span class="hljs-string"> seconds"</span>
</code></pre>
    <p class="normal-one">This statement calculates the elapsed time (approximately eight seconds), which will be displayed by elapsedTim<code class="inlineCode">eLabel</code>.</p>
    <pre class="programlisting code-one"><code class="hljs-code"><span class="hljs-keyword">@IBAction</span> <span class="hljs-keyword">func</span> <span class="hljs-template-variable">testButton</span>(<span class="hljs-template-variable">_</span> <span class="hljs-params">sender</span>: <span class="hljs-type">UIButton</span>) {
   print(<span class="hljs-string">"Button tapped"</span>)
}
</code></pre>
    <p class="normal-one">This method displays <strong class="screenText">Button tapped</strong> in the Debug area each time the button onscreen is tapped.</p>
    <p class="normal">Build and run the app, and tap the button the moment the user interface appears:</p>
    <figure class="mediaobject"><img src="image/B31371_09_02.png" alt="" width="455" height="514"/></figure>
    <p class="packt_figref">Figure 9.2: iOS Simulator running the BreakfastMaker app, showing the button to be tapped</p>
    <p class="normal">You <a id="_idIndexMarker350"/>should notice the following issues:</p>
    <ul>
      <li class="bulletList">Tapping the button has no effect initially, and you’ll only see <strong class="screenText">Button tapped</strong> in the Debug area after approximately nine seconds.</li>
      <li class="bulletList"><strong class="screenText">Making toast...</strong> and <strong class="screenText">Boiling eggs...</strong> are never displayed, and <strong class="screenText">Toast done</strong> and <strong class="screenText">Eggs done</strong> only appear after approximately nine seconds.</li>
    </ul>
    <p class="normal">The reason why this happens is that your app’s code did not update the user interface while the <code class="inlineCode">makeToast()</code> and <code class="inlineCode">boilEggs()</code> methods were running. Your app did register the button taps but was only able to process them and update the labels after <code class="inlineCode">makeToast()</code> and <code class="inlineCode">boilEggs()</code> had completed their execution. These issues do not offer a good user experience with your app.</p>
    <p class="normal">You <a id="_idIndexMarker351"/>have now experienced the issues presented by an app that does not have concurrency implemented. In the next section, you’ll modify the app using <code class="inlineCode">async/await</code> so that it can update the user interface while the <code class="inlineCode">makeToast()</code> and <code class="inlineCode">boilEggs()</code> methods are running.</p>
    <h1 id="_idParaDest-139" class="heading-1">Updating the app using async/await</h1>
    <p class="normal">As you saw previously, the app is unresponsive when the <code class="inlineCode">makeToast()</code> and <code class="inlineCode">poachEgg()</code> methods <a id="_idIndexMarker352"/>are running. To resolve this, you will use async/await in the app.</p>
    <p class="normal">Writing the <code class="inlineCode">async</code> keyword in the method declaration indicates that the method is asynchronous. This is what it looks like:</p>
    <pre class="programlisting code"><code class="hljs-code"><span class="hljs-keyword">func</span> <span class="hljs-template-variable">methodName</span>() <span class="hljs-keyword">async</span> -&gt; returnType {
</code></pre>
    <p class="normal">Writing the <code class="inlineCode">await</code> keyword in front of a method call marks a point where execution may be suspended, thus allowing other operations to run. This is what it looks like:</p>
    <pre class="programlisting code"><code class="hljs-code"><span class="hljs-keyword">await</span> <span class="hljs-template-variable">methodName</span>()
</code></pre>
    <div class="note">
      <p class="normal">You can watch Apple’s WWDC21 video discussing async/await at <a href="https://developer.apple.com/videos/play/wwdc2021/10132/"><span class="url">https://developer.apple.com/videos/play/wwdc2021/10132/</span></a>.</p>
    </div>
    <p class="normal">You will modify your app to use async/await. This will enable it to suspend the <code class="inlineCode">makeToast()</code> and <code class="inlineCode">poachEgg()</code> methods to process button taps, update the user interface, and then resume execution of both methods afterward. You will also enable strict concurrency checking for your app by turning on the Swift 6 language mode. Follow these steps:</p>
    <ol>
      <li class="numberedList" value="1">In the Project navigator, click the <strong class="screenText">BreakfastMaker</strong> icon at the top and then the <strong class="screenText">BreakfastMaker</strong> target. In the <strong class="screenText">Build Settings</strong> tab, change <strong class="screenText">Swift Language Version</strong> to <strong class="screenText">Swift 6</strong>:</li>
    </ol>
    <figure class="mediaobject"><img src="image/B31371_09_03.png" alt="" width="812" height="384"/></figure>
    <p class="packt_figref">Figure 9.3: BreakfastMaker project with Swift Language Version set to Swift 6</p>
    <p class="normal-one">This <a id="_idIndexMarker353"/>enables strict concurrency checking for your app.</p>
    <ol>
      <li class="numberedList" value="2">Click the <strong class="screenText">ViewController</strong> file in the Project navigator. Modify the <code class="inlineCode">makeToast()</code> and <code class="inlineCode">boilEggs()</code> methods, as shown here, to make the code in their bodies asynchronous:
        <pre class="programlisting code-one"><code class="hljs-code"><span class="hljs-keyword">func</span> <span class="hljs-template-variable">makeToast</span>() -&gt; <span class="hljs-type">String</span> {
   <span class="code-highlight"><strong class="hljs-keyword-slc">try?</strong><strong class="hljs-slc"> </strong><strong class="hljs-keyword-slc">await</strong><strong class="hljs-slc"> </strong><strong class="hljs-type-slc">Task</strong><strong class="hljs-slc">.sleep(for: .seconds(2))</strong></span>
   <span class="hljs-keyword">return</span> <span class="hljs-string">"Toast done"</span>
}
<span class="hljs-keyword">func</span> <span class="hljs-template-variable">boilEggs</span>() -&gt; <span class="hljs-type">String</span> {
   <span class="code-highlight"><strong class="hljs-keyword-slc">try?</strong><strong class="hljs-slc"> </strong><strong class="hljs-keyword-slc">await</strong><strong class="hljs-slc"> </strong><strong class="hljs-type-slc">Task</strong><strong class="hljs-slc">.sleep(for: .seconds(7))</strong></span>
   <span class="hljs-keyword">return</span> <span class="hljs-string">"Eggs done"</span>
}
</code></pre>
      </li>
    </ol>
    <p class="normal-one"><code class="inlineCode">Task</code> represents a unit of asynchronous work. It has a static method, <code class="inlineCode">sleep(for:)</code>, which pauses execution for a specified duration, measured in seconds. Since this method is a throwing method, you’ll use the <code class="inlineCode">try?</code> keyword to call it without having to implement a <code class="inlineCode">do-catch</code> block. The <code class="inlineCode">await</code> keyword indicates that this code can be suspended to allow other code to run.</p>
    <div class="note-one">
      <p class="normal">Using <code class="inlineCode">try?</code> will result in any errors being suppressed or ignored. This is acceptable in this case because sleeping for 2 or 7 seconds is unlikely to generate an error. This may not be acceptable in other situations, where a <code class="inlineCode">do-catch</code> block is a better solution. You may wish to reread <em class="chapterRef">Chapter 8</em>, <em class="italic">Protocols, Extensions, and Error Handling</em> for information on how to implement a <code class="inlineCode">do-catch</code> block.</p>
    </div>
    <ol>
      <li class="numberedList" value="3">Errors will appear for both <code class="inlineCode">makeToast()</code> and <code class="inlineCode">boilEggs()</code>. Click either error icon to display the error message:</li>
    </ol>
    <figure class="mediaobject"><img src="image/B31371_09_04.png" alt="" width="517" height="110"/></figure>
    <p class="packt_figref">Figure 9.4: Error message when the error icon is clicked</p>
    <p class="normal-one">The <a id="_idIndexMarker354"/>error is displayed because you’re calling an asynchronous method inside a method that does not support concurrency. You will need to add the <code class="inlineCode">async</code> keyword to the method declaration to indicate that it is asynchronous.</p>
    <ol>
      <li class="numberedList" value="4">For each method, click the <strong class="screenText">Fix</strong> button to add the <code class="inlineCode">async</code> keyword to the method declaration.</li>
      <li class="numberedList">Verify that your code looks like this after you’re done:
        <pre class="programlisting code-one"><code class="hljs-code"><span class="hljs-keyword">func</span> <span class="hljs-template-variable">makeToast</span>() <span class="code-highlight"><strong class="hljs-keyword-slc">async</strong></span> -&gt; <span class="hljs-type">String</span> {
   <span class="hljs-keyword">try?</span> <span class="hljs-keyword">await</span> <span class="hljs-type">Task</span>.sleep(for: .seconds(2))
   <span class="hljs-keyword">return</span> <span class="hljs-string">"Toast done"</span>
}
<span class="hljs-keyword">func</span> <span class="hljs-template-variable">boilEggs</span>() <span class="code-highlight"><strong class="hljs-keyword-slc">async</strong></span> -&gt; <span class="hljs-type">String</span> {
   <span class="hljs-keyword">try?</span> <span class="hljs-keyword">await</span> <span class="hljs-type">Task</span>.sleep(for: .seconds(2))
   <span class="hljs-keyword">return</span> <span class="hljs-string">"Eggs done"</span>
}
</code></pre>
      </li>
      <li class="numberedList">The errors in the <code class="inlineCode">makeToast()</code> and <code class="inlineCode">poachEgg()</code> methods should be gone, but new errors will appear in the <code class="inlineCode">viewDidAppear()</code> method. Click one of the error icons to see the error message, which will be the same as the message you saw in <em class="italic">step 2</em>. This is because you’re calling an asynchronous method inside a method that does not support concurrency.</li>
      <li class="numberedList">Click the <strong class="screenText">Fix</strong> button, and more errors will appear.</li>
      <li class="numberedList">Ignore <a id="_idIndexMarker355"/>the error in the method declaration for now, and click the one next to the <code class="inlineCode">makeToast()</code> method call to see the error message:</li>
    </ol>
    <figure class="mediaobject"><img src="image/B31371_09_05.png" alt="" width="577" height="124"/></figure>
    <p class="packt_figref">Figure 9.5: Error message when the error icon is clicked</p>
    <p class="normal-one">This error message is displayed because you did not use <code class="inlineCode">await</code> when calling an asynchronous function.</p>
    <ol>
      <li class="numberedList" value="9">Click the <strong class="screenText">Fix</strong> button to insert the <code class="inlineCode">await</code> keyword before the method call.</li>
      <li class="numberedList">Repeat <em class="italic">step 7</em> and <em class="italic">step 8</em> for the error next to the <code class="inlineCode">boilEggs()</code> method call. The <code class="inlineCode">await</code> keyword will be inserted for the <code class="inlineCode">boilEggs()</code> method call as well.</li>
      <li class="numberedList">Click the error icon in the <code class="inlineCode">viewDidAppear()</code> method declaration to see the error message:</li>
    </ol>
    <figure class="mediaobject"><img src="image/B31371_09_06.png" alt="" width="812" height="172"/></figure>
    <p class="packt_figref">Figure 9.6: Error with the error icon highlighted</p>
    <p class="normal-one">This error is displayed because you can’t use the <code class="inlineCode">async</code> keyword to make the <code class="inlineCode">viewDidAppear()</code> method asynchronous, as this capability is not present in the superclass.</p>
    <ol>
      <li class="numberedList" value="12">To resolve this issue, you’ll remove the <code class="inlineCode">async</code> keyword and enclose all the code after <code class="inlineCode">super.viewDidAppear()</code> in a <code class="inlineCode">Task</code> block, which will allow it to execute asynchronously in a synchronous method. Modify your code as follows:
        <pre class="programlisting code-one"><code class="hljs-code"><span class="hljs-keyword">override</span>  <span class="hljs-keyword">func</span> <span class="hljs-template-variable">viewDidAppear</span>(<span class="hljs-keyword">_</span> <span class="hljs-params">animated</span>: <span class="hljs-type">Bool</span>) {
   <span class="hljs-keyword">super</span>.<span class="hljs-con-attribute">viewDidAppear</span>(animated)
   <span class="code-highlight"><strong class="hljs-type-slc">Task</strong><strong class="hljs-slc"> {</strong></span>
      <span class="hljs-keyword">let</span> startTime <span class="hljs-operator">=</span> <span class="hljs-type">Date</span>()<span class="hljs-title">.</span><span class="hljs-con-attribute">timeIntervalSince1970</span>
     <span class="hljs-variable"> toastLabel</span>.<span class="hljs-con-attribute">text</span> <span class="hljs-operator">=</span> <span class="hljs-string">"Making toast..."</span>
     <span class="hljs-variable"> toastLabel</span>.<span class="hljs-con-attribute">text</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">await</span> <span class="hljs-variable">makeToast</span>()
     <span class="hljs-variable"> eggLabel</span>.<span class="hljs-con-attribute">text</span> <span class="hljs-operator">=</span> <span class="hljs-string">"Boiling eggs..."</span>
     <span class="hljs-variable"> eggLabel</span>.<span class="hljs-con-attribute">text</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">await</span> <span class="hljs-variable">boilEggs</span>()
      <span class="hljs-variable">plateAndServeLabel</span>.<span class="hljs-con-attribute">text</span> <span class="hljs-operator">=</span> <span class="hljs-variable">plateAndServe</span>()
      <span class="hljs-keyword">let</span> endTime <span class="hljs-operator">=</span> <span class="hljs-type">Date</span>().<span class="hljs-con-attribute">timeIntervalSince1970</span>
      <span class="hljs-variable">elapsedTimeLabel</span>.<span class="hljs-con-attribute">text</span> <span class="hljs-operator">=</span> <span class="hljs-string">"Elapsed time is</span>
<span class="hljs-string">     </span> \(((endTime - startTime)<span class="hljs-subst"> </span><span class="hljs-operator">*</span><span class="hljs-subst"> </span><span class="hljs-number">100</span>).<span class="hljs-con-attribute">rounded</span>()
<span class="hljs-subst">      </span><span class="hljs-operator">/</span><span class="hljs-subst"> </span><span class="hljs-number">100</span>)<span class="hljs-string"> seconds"</span>
   <span class="code-highlight"><strong class="hljs-slc">}</strong></span>
}
</code></pre>
      </li>
    </ol>
    <p class="normal">Build <a id="_idIndexMarker356"/>and run the app, and tap the button as soon as you see the user interface. Note that <strong class="screenText">Button tapped</strong> now appears immediately in the Debug area, and the labels update as they should. This is because the app is now able to suspend the <code class="inlineCode">makeToast()</code> and <code class="inlineCode">boilEggs()</code> methods to respond to taps, update the user interface, and resume method execution later. Awesome!</p>
    <p class="normal">However, if you look at the elapsed time, you’ll see that the app takes slightly longer to prepare breakfast than it did before:</p>
    <figure class="mediaobject"><img src="image/B31371_09_07.png" alt="" width="517" height="389"/></figure>
    <p class="packt_figref">Figure 9.7: iOS Simulator running the BreakfastMaker app, showing the elapsed time</p>
    <p class="normal">This is <a id="_idIndexMarker357"/>partly due to the additional processing required for the async/await suspending and resuming methods, but there is another factor involved. Even though the <code class="inlineCode">makeToast()</code> and <code class="inlineCode">boilEggs()</code> methods are now asynchronous, the <code class="inlineCode">boilEggs()</code> method only starts execution after the <code class="inlineCode">makeToast()</code> method has finished execution. In the next section, you’ll see how you can use <code class="inlineCode">async-let</code> to run the <code class="inlineCode">makeToast()</code> and <code class="inlineCode">boilEggs()</code> methods in parallel.</p>
    <h1 id="_idParaDest-140" class="heading-1">Improving efficiency using async-let</h1>
    <p class="normal">Even <a id="_idIndexMarker358"/>though your app <a id="_idIndexMarker359"/>is now responsive to button taps and can update the user interface while the <code class="inlineCode">makeToast()</code> and <code class="inlineCode">boilEggs()</code> methods are running, both methods still execute sequentially. The solution here is to use <code class="inlineCode">async-let</code>.</p>
    <p class="normal">Writing <code class="inlineCode">async</code> in front of a <code class="inlineCode">let</code> statement when you define a constant, and then writing <code class="inlineCode">await</code> when you access the constant, allows the parallel execution of asynchronous methods, as shown here:</p>
    <pre class="programlisting code"><code class="hljs-code"><span class="hljs-keyword">async</span> <span class="hljs-keyword">let</span> temporaryConstant1 <span class="hljs-operator">=</span> methodName1()
<span class="hljs-keyword">async</span> <span class="hljs-keyword">let</span> temporaryConstant2 <span class="hljs-operator">=</span> methodName2()
<span class="hljs-keyword">await</span> variable1 <span class="hljs-operator">=</span> temporaryConstant1
<span class="hljs-keyword">await</span> variable2 <span class="hljs-operator">=</span> temporaryConstant1
</code></pre>
    <p class="normal">In this example, <code class="inlineCode">methodName1()</code> and <code class="inlineCode">methodName2()</code> will run in parallel.</p>
    <p class="normal">You <a id="_idIndexMarker360"/>will modify your <a id="_idIndexMarker361"/>app to use <code class="inlineCode">async-let</code> to enable the <code class="inlineCode">makeToast()</code> and <code class="inlineCode">poachEgg()</code> methods to run in parallel. In the <code class="inlineCode">ViewController</code> file, modify the code in the <code class="inlineCode">Task</code> block as follows:</p>
    <pre class="programlisting code"><code class="hljs-code"><span class="hljs-type">Task</span> {
   <span class="hljs-keyword">let</span> startTime <span class="hljs-operator">=</span> <span class="hljs-type">Date</span>().<span class="hljs-con-attribute">timeIntervalSince1970</span>
   <span class="hljs-variable">toastLabel</span>.<span class="hljs-con-attribute">text</span> <span class="hljs-operator">=</span> <span class="hljs-string">"Making toast..."</span>
<span class="code-highlight"><strong class="hljs-slc">   </strong><strong class="hljs-keyword-slc">async</strong><strong class="hljs-slc"> </strong><strong class="hljs-keyword-slc">let</strong><strong class="hljs-slc"> tempToast </strong><strong class="hljs-operator-slc">=</strong><strong class="hljs-slc"> </strong><strong class="hljs-variable-slc">makeToast</strong><strong class="hljs-slc">()</strong></span>
   <span class="hljs-variable">eggLabel</span>.<span class="hljs-con-attribute">text</span> <span class="hljs-operator">=</span> <span class="hljs-string">"Boiling eggs..."</span>
<span class="code-highlight"><strong class="hljs-slc">   </strong><strong class="hljs-keyword-slc">async</strong><strong class="hljs-slc"> </strong><strong class="hljs-keyword-slc">let</strong><strong class="hljs-slc"> tempEggs </strong><strong class="hljs-operator-slc">=</strong><strong class="hljs-slc"> </strong><strong class="hljs-variable-slc">boilEggs</strong><strong class="hljs-slc">()</strong></span>
<span class="code-highlight"><strong class="hljs-slc">   </strong><strong class="hljs-keyword-slc">await</strong><strong class="hljs-slc"> </strong><strong class="hljs-variable-slc">toastLabel</strong><strong class="hljs-slc">.</strong><strong class="hljs-con-attribute-slc">text</strong><strong class="hljs-slc"> </strong><strong class="hljs-operator-slc">=</strong><strong class="hljs-slc"> tempToast</strong></span>
<span class="code-highlight"><strong class="hljs-slc">   </strong><strong class="hljs-keyword-slc">await</strong><strong class="hljs-slc"> </strong><strong class="hljs-variable-slc">eggLabel</strong><strong class="hljs-slc">.</strong><strong class="hljs-con-attribute-slc">text</strong><strong class="hljs-slc"> </strong><strong class="hljs-operator-slc">=</strong><strong class="hljs-slc"> tempEggs</strong></span>
   <span class="hljs-variable">plateAndServeLabel</span>.<span class="hljs-con-attribute">text</span> <span class="hljs-operator">=</span> <span class="hljs-variable">plateAndServe</span>()
   <span class="hljs-keyword">let</span> endTime <span class="hljs-operator">=</span> <span class="hljs-type">Date</span>().<span class="hljs-con-attribute">timeIntervalSince1970</span>
   <span class="hljs-variable">elapsedTimeLabel</span>.<span class="hljs-con-attribute">text</span> <span class="hljs-operator">=</span> <span class="hljs-string">"</span><span class="hljs-string">Elapsed time is</span>
<span class="hljs-string">  </span> \(((endTime - startTime)<span class="hljs-subst"> </span><span class="hljs-operator">*</span><span class="hljs-subst"> </span><span class="hljs-number">100</span>).<span class="hljs-con-attribute">rounded</span>()
<span class="hljs-subst">   </span><span class="hljs-operator">/</span><span class="hljs-subst"> </span><span class="hljs-number">100</span>)<span class="hljs-string"> seconds"</span>
}
</code></pre>
    <p class="normal">Build and run the app. You’ll see that the elapsed time is now less than it was before:</p>
    <figure class="mediaobject"><img src="image/B31371_09_08.png" alt="" width="523" height="377"/></figure>
    <p class="packt_figref">Figure 9.8: iOS Simulator running the BreakfastMaker app, showing the elapsed time</p>
    <p class="normal">This <a id="_idIndexMarker362"/>is because using <code class="inlineCode">async-let</code> allows both the <code class="inlineCode">makeToast()</code> and <code class="inlineCode">poachEgg()</code> methods to run in parallel, and the <code class="inlineCode">poachEgg()</code> method no longer waits for the <code class="inlineCode">makeToast()</code> method to complete <a id="_idIndexMarker363"/>before starting execution. Cool!</p>
    <div class="note">
      <p class="normal">There is still lots more to learn about Swift concurrency, such as structured concurrency and actors, but that is beyond the scope of this chapter. You can learn <a id="_idIndexMarker364"/>more about structured concurrency at <a href="https://developer.apple.com/videos/play/wwdc2021/10134/"><span class="url">https://developer.apple.com/videos/play/wwdc2021/10134/</span></a>, and you can <a id="_idIndexMarker365"/>learn more about actors at <a href="https://developer.apple.com/videos/play/wwdc2021/10133/"><span class="url">https://developer.apple.com/videos/play/wwdc2021/10133/</span></a>.</p>
    </div>
    <p class="normal">You have successfully implemented asynchronous code in your app. Fantastic! There are still a lot of things to learn about Swift concurrency, such as structured concurrency and actors, but that is beyond the scope of this chapter.</p>
    <p class="normal">Give yourself a pat on the back; you have completed the first part of this book!</p>
    <h1 id="_idParaDest-141" class="heading-1">Summary</h1>
    <p class="normal">In this chapter, you learned about Swift concurrency and how to implement it in the <em class="italic">BreakfastMaker</em> app.</p>
    <p class="normal">You started by learning the basic concepts of Swift concurrency. Then, you examined an app without concurrency and explored its issues. After that, you turned on strict concurrency checking and implemented concurrency in the app, using <code class="inlineCode">async</code>/<code class="inlineCode">await</code>. Finally, you made your app more efficient by using <code class="inlineCode">async let</code>.</p>
    <p class="normal">You now understand the basics of Swift concurrency and will be able to use <code class="inlineCode">async</code>/<code class="inlineCode">await</code> and <code class="inlineCode">async-let</code> in your own apps.</p>
    <p class="normal">In the next chapter, you will start writing your first iOS application by creating the screens for it, using storyboards, which allow you to rapidly prototype an application without having to type a lot of code.</p>
    <h1 id="_idParaDest-142" class="heading-1">Leave a review!</h1>
    <p class="normal">Thank you for purchasing this book from Packt Publishing—we hope you enjoy it! Your feedback is invaluable and helps us improve and grow. Once you’ve completed reading it, please take a moment to leave an Amazon review; it will only take a minute, but it makes a big difference for readers like you. Scan the QR code below or visit the link to receive a free ebook of your choice.</p>
    <p class="normal"><a href="https://packt.link/NzOWQ%0D"><span class="url">https://packt.link/NzOWQ</span></a></p>
    <p class="normal"><a href="https://packt.link/NzOWQ%0D"><span class="url"><img src="image/QR_Code2370024260177460609.png" alt="" width="177" height="177"/></span></a></p>
  </div>
</div></div></body></html>