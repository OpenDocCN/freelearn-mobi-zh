<html><head></head><body><div><div><div><div><h1 class="title"><a id="ch09"/>Chapter 9. Adding Social Media and Other Online Services</h1></div></div></div><p>Modern mobile devices are now amazingly powerful when it comes to graphics and sound, but perhaps the biggest differentiator between them and other dedicated hand-held videogame systems is that most of them are able to connect to the Internet.</p><p>While other gaming systems may be able to go online via WiFi, many modern devices can also use a 3G or other such data connections to connect to the Internet wherever the user happens to be. For this reason many games now feature the ability to connect to social media sites such as Facebook, or to share scores using services such as Apple's Game Center.</p><p>In this chapter, we will be looking at how it is possible to use Marmalade to add the following online capabilities to our games:</p><div><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">Launching a web browser to display a web page</li><li class="listitem" style="list-style-type: disc">Integrating with Facebook on iOS and Android</li><li class="listitem" style="list-style-type: disc">Familiarizing ourselves with the possibilities for other online functionality, including advertising and in-app purchasing</li></ul></div><div><div><div><div><h1 class="title"><a id="ch09lvl1sec56"/>Launching a web page in the device browser</h1></div></div></div><p>Let's start our foray<a id="id1296" class="indexterm"/>
<a id="id1297" class="indexterm"/> into the realm of the connected world by looking at the simplest way of adding an online feature to our games—launching a web page in the device browser.</p><p>Being able to direct the user to a website can be extremely useful for things such as instruction manuals, hints and tips, or technical support access. It is also great for cross promotion of titles by making it really simple to deliver a <strong>Get More Games</strong> button that highlights other games you have created.</p><p>How do we accomplish this magic? It's really simple! Just include the header file <code class="literal">s3eOSExec.h</code> and<a id="id1298" class="indexterm"/> then make a call to<a id="id1299" class="indexterm"/> <code class="literal">s3eOSExecAvailable</code> to see if the functionality is supported by the platform we are running on. Most of the platforms supported by Marmalade allow this functionality, but it is always best to check!</p><p>If support is <a id="id1300" class="indexterm"/>
<a id="id1301" class="indexterm"/>available, all we have to do is call the function <code class="literal">s3eOSExecExecute</code> with the URL of the web page and a Boolean value indicating whether or not our application will quit. On platforms that don't support multi-tasking this parameter will make no difference, so it is usually OK to set this flag to <code class="literal">false</code> to ensure that our application is not closed down.</p><p>Here's a code snippet to illustrate:</p><div><pre class="programlisting">if (s3eOSExecAvailable())
{
  s3eOSExecExecute("http://www.google.com", false);
}</pre></div><p>The main disadvantage of this approach is that by launching the application in the device's internal web browser, it takes the user away from our game; but in the cases mentioned previously, this may be an acceptable trade-off given how easy it is to implement.</p></div></div>
<div><div><div><div><h1 class="title"><a id="ch09lvl1sec57"/>Integrating with social media</h1></div></div></div><p>Social media sites<a id="id1302" class="indexterm"/> such as Facebook<a id="id1303" class="indexterm"/> provide a great way of advertising our games by getting our players to spread the word for us. There are countless examples of games which allow players to post a message to their Facebook wall or Twitter<a id="id1304" class="indexterm"/> feed to show off their latest high score or boast about achieving a certain target in the game.</p><p>In this section we will take a detailed look at how we can implement integration with Facebook and we will also talk briefly about Twitter.</p><div><div><div><div><h2 class="title"><a id="ch09lvl2sec141"/>Using Facebook</h2></div></div></div><p>Marmalade comes with an API called s3eFacebook<a id="id1305" class="indexterm"/> that wraps up most <a id="id1306" class="indexterm"/>of the tricky stuff involved in communicating with the Facebook servers. Unfortunately this ease of use does come at a price, which is that it is only supported on iOS and Android.</p><p>If Facebook support is required across all platforms, we would need to implement everything from scratch using HTTP requests via the IwHTTP API<a id="id1307" class="indexterm"/> provided with Marmalade. This is a challenging task, so we'll be using the s3eFacebook API in this part of the book.</p><div><div><div><div><h3 class="title"><a id="ch09lvl3sec87"/>Creating a Facebook app</h3></div></div></div><p>The first step in Facebook integration to a Marmalade project is to create a Facebook App on the Facebook website, which is really little more than a way of authenticating the source of any Facebook API requests.</p><p>When we create a Facebook App we are provided with two hexadecimal values. One is called the <a id="id1308" class="indexterm"/>
<strong>App Id</strong> (also known sometimes as the <strong>API Key</strong>) and the other is the <a id="id1309" class="indexterm"/> <strong>App Secret</strong>. These values will be needed when we send requests to Facebook in order to identify our application on the Facebook servers.</p><p>To create a Facebook App follow these steps:</p><div><ol class="orderedlist arabic"><li class="listitem">Log in to <a id="id1310" class="indexterm"/>Facebook by visiting <a class="ulink" href="http://www.facebook.com">www.facebook.com</a> and entering your username and password. If you do not already have a Facebook account, you can also sign up for one at this address.<a id="id1311" class="indexterm"/><div><img src="img/3363_09_01.jpg" alt="Creating a Facebook app"/></div></li><li class="listitem">Once you are logged in to Facebook, visit the URL <a class="ulink" href="http://www.facebook.com/developers">www.facebook.com/developers</a>. If you have never created a Facebook App before, you will see a dialog like the one in the preceding screenshot. This screen has a single drop-down box that allows you to specify whether everyone or just your friends will be able to see posts created by the application. For now leave this set to the default value of <strong>Everyone</strong> and click on the <strong>Go to App</strong> button.</li><li class="listitem">You will now see a screen detailing all the Facebook Apps you have created, which will be empty assuming this is the first App you have ever created! Click on the <strong>+ Create New App</strong> button to start creating a Facebook App.<div><img src="img/3363_09_02.jpg" alt="Creating a Facebook app"/></div></li><li class="listitem">The previous <a id="id1312" class="indexterm"/>dialog box shown should now appear, minus the pink box containing the text about verifying your account (more on this in a moment). For the purpose of this chapter all we need to supply is the <strong>App Name</strong> value, which is a string that will be shown to the user when our Marmalade project first attempts to access Facebook. It therefore makes sense to use the name of the game or perhaps your company name for this field.</li><li class="listitem">Click the <strong>Continue</strong> button to create the Facebook App. Note that the remaining fields can be ignored for now. The <strong>App Namespace</strong> value is used to reference the application on Facebook as a URL or as part of an HTTP request and is for more advanced Facebook integration. The <strong>Locale</strong> and <strong>Web Hosting</strong> controls can also be ignored for the purposes of this chapter.</li><li class="listitem">You will now be shown one of those annoying Captcha dialogs to prove you are a human and not some kind of spamming web bot. Enter the words shown in the image to proceed.</li><li class="listitem">At this point it is likely that you will be shown the <strong>Create New App</strong> dialog from step 4 again, this time with the text in the little pink box. This is another security check put in place by Facebook to stop hundreds of rogue Facebook applications from being created. You need to authorize your Facebook account before you can create a Facebook App. I would suggest you click the link labeled <strong>mobile phone</strong> to verify your account as it is by far the easiest way. You will be asked to enter your mobile phone number so a text message can be sent to you containing an authorization code that you then enter into a dialog to verify yourself.</li><li class="listitem">Once you have verified your account you will return to the <strong>Create New App</strong> dialog once again. Ensure the <strong>App Name</strong> value is correct and click on the <strong>Continue</strong> <a id="id1313" class="indexterm"/>button again. The Captcha screen will likely rear its ugly head once more, so fill it in.<div><img src="img/3363_09_03.jpg" alt="Creating a Facebook app"/></div></li><li class="listitem">At this point the Facebook App has been created and you should now be looking at a screen similar to that shown before, which shows various pieces of information about the Facebook App. The most important are the <strong>App Id/App Key</strong> and <strong>App Secret</strong> values, which you'll need later; so make a note of them.</li></ol></div></div><div><div><div><div><h3 class="title"><a id="ch09lvl3sec88"/>Creating a Facebook test user</h3></div></div></div><p>We will obviously <a id="id1314" class="indexterm"/>
<a id="id1315" class="indexterm"/>want to test the Facebook integration of our application out once it has been implemented, but it would be good if we didn't have to spam all our friends with test wall posts and the like. It's therefore a good idea to create a test user.</p><p>For understandable reasons Facebook doesn't really want us to create full Facebook accounts for our test users, so instead they allow us to create test users using our Facebook App. Follow these steps to create a test user:</p><div><ol class="orderedlist arabic"><li class="listitem">Log in to Facebook and then visit the <a class="ulink" href="http://www.facebook.com/developers">www.facebook.com/developers</a> page.</li><li class="listitem">Click on the relevant Facebook App in the left-hand pane and then click on the link labeled <strong>Edit Roles</strong> on the right-hand side of the <strong>Roles</strong> section of the page.<div><img src="img/3363_09_04.jpg" alt="Creating a Facebook test user"/></div></li><li class="listitem">The <strong>Roles</strong> page for the Facebook App will be displayed (see previous screenshot). At the bottom there is a section labeled <strong>Test Users</strong>, which has a link labeled <strong>Add</strong> that you should click on to create new test users.</li><li class="listitem">A small dialog box will appear with three options. The first is labeled <strong>Number to Add</strong> and is a drop-down box allowing between one and ten test users to be generated.</li><li class="listitem">The <strong>Authorize this App</strong> checkbox allows us to determine whether the created users have already authorized the Facebook App to use their account. It's worth creating users of both types to fully test our application, but ultimately it's up to you whether you authorize now or when we first try to log in using this user account.</li><li class="listitem">Finally, the <strong>Enable Ticker</strong> checkbox lets you decide whether the user will be using the Facebook Ticker interface (which is a real-time timeline of wall posts and other events) or the older standard interface. Not all users have access to the newer Ticker interface, so it is again worth testing your project using both methods.</li><li class="listitem">Click the <strong>Add</strong> button to create the new users. You will return to the screen first shown in step 3, but the new users will be shown at the bottom of the page now.</li><li class="listitem">Each test <a id="id1316" class="indexterm"/><a id="id1317" class="indexterm"/>user will have a couple of links next to them. You should first click on the <strong>Set Password</strong> link to allow a password to be set for this user. A textbox will appear, to allow you to enter a password.</li><li class="listitem">Next, click on the <strong>Switch To</strong> link next to one of the users to log in as that user and display their Facebook wall.</li><li class="listitem">At the top right of the test user's wall, there should be a button labeled <strong>Edit Profile</strong>. Click on it.</li><li class="listitem">On the <strong>Edit Profile</strong> screen, click on the <strong>Contact Information</strong> link in the left-hand side panel.</li><li class="listitem">At the top of the screen there should be two e-mail addresses associated with the profile. One of these should be of the form <code class="email">&lt;<a class="email" href="mailto:username@tfbnw.net">username@tfbnw.net</a>&gt;</code>, which is the e-mail address we will need to use later to log in as the test user. Make a note of this e-mail address and the password you set in step 8.</li></ol></div></div><div><div><div><div><h3 class="title"><a id="ch09lvl3sec89"/>Adding the s3eFacebook API to a Marmalade project</h3></div></div></div><p>With the Facebook <a id="id1318" class="indexterm"/>
<a id="id1319" class="indexterm"/>App and test users configured, let's get down to adding Facebook support to a Marmalade project. The first thing to do is open the project MKB file and add <code class="literal">s3eFacebook</code> to the list of <code class="literal">subprojects</code>. We can then include the <code class="literal">s3eFacebook.h</code> file whenever we need to make use of the s3eFacebook API functions.</p><p>We also need to add another configuration setting to the MKB file in the <code class="literal">deployments</code> section. The line in question looks like this and is only needed for iOS builds. On iOS our application temporarily loses focus when we log in to Facebook and this value ensures that we regain control when the login process is completed:</p><div><pre class="programlisting">iphone-bundle-url-schemes="fb0123456789abcdef"</pre></div><p>The hexadecimal value following the initial <code class="literal">fb</code> should be replaced with the 16-digit App Id generated <a id="id1320" class="indexterm"/>
<a id="id1321" class="indexterm"/>by the Facebook App.</p></div><div><div><div><div><h3 class="title"><a id="ch09lvl3sec90"/>Checking for s3eFacebook support</h3></div></div></div><p>As previously <a id="id1322" class="indexterm"/>mentioned, the s3eFacebook API is only supported on iOS and Android, so it's good to be able to check at runtime whether we can support Facebook or not. This is easily done using the <code class="literal">s3eFacebookAvailable</code> function, which will return <code class="literal">S3E_TRUE</code> if the API is available or <code class="literal">S3E_FALSE</code> if it isn't.</p></div><div><div><div><div><h3 class="title"><a id="ch09lvl3sec91"/>Initialization and termination</h3></div></div></div><p>Before we can call <a id="id1323" class="indexterm"/>
<a id="id1324" class="indexterm"/>any of the s3eFacebook APIs, we must first initialize a Facebook session. We do this with a call to the function <code class="literal">s3eFBInit</code> that takes a single parameter, a null-terminated string containing the App Id of the Facebook App we want to use.</p><p>The function will return a pointer to an <code class="literal">s3eFBSession</code> instance, which we will need to use to access the Facebook API and make requests to it.</p><p>We can release the Facebook session with a call to <code class="literal">s3eFBTerminate</code>, which takes the session pointer returned from <code class="literal">s3eFBInit</code> as its only argument.</p><p>It is sufficient to call the <code class="literal">s3eFBInit</code> function the first time we want to make any Facebook request and then to use this same session information for the execution life of our application. The <code class="literal">s3eFBTerminate</code> function only needs to be called at shutdown time.</p></div><div><div><div><div><h3 class="title"><a id="ch09lvl3sec92"/>Logging in and out of Facebook</h3></div></div></div><p>Before we can make any <a id="id1325" class="indexterm"/>
<a id="id1326" class="indexterm"/>Facebook request, we must first log in to Facebook. This is done with the <code class="literal">s3eFBSession_LogIn</code> function, which takes five parameters. The first is the <code class="literal">s3eFBSession</code> pointer returned from <code class="literal">s3eFBInit</code>. We can then specify a callback function, which will be triggered once successfully logged in. A pointer to a block of user data can also be specified, which will be passed into the callback function when it is triggered.</p><p>The callback function can be specified as <code class="literal">NULL</code>, in which case we need to check for login to be completed by calling the <code class="literal">s3eFBSession_LoggedIn</code> function. This takes the session pointer as an argument and will return <code class="literal">S3E_TRUE</code> when the session is logged in.</p><p>The final two parameters of <code class="literal">s3eFBSession_LogIn</code> are an array of null-terminated strings listing the Facebook API permissions we want to make use of and the number of permissions in this array. Permissions allow our application to notify the user that our application wants to perform certain operations on their account, such as posting to their wall or accessing their photo collection. A full list of permissions can be found at the web page <a class="ulink" href="http://developers.facebook.com/docs/authentication/permissions/">http://developers.facebook.com/docs/authentication/permissions/</a>.</p><p>The following example <a id="id1327" class="indexterm"/>
<a id="id1328" class="indexterm"/>code shows a sample callback function and how to use it with the <code class="literal">s3eFBSession_Login</code> function:</p><div><pre class="programlisting">// Login callback
void LoginCallback(struct s3eFBSession* apSession,
s3eResult* apLoginResult, void* apUserData)
{
  if (*apLoginResult == S3E_RESULT_SUCCESS)
  {
    // Logged in OK
  }
  else
  {
    // Login failed
  }
}

// Log in to Facebook using the session returned from s3eFBInit.
const char* permissions[] = { "publish_stream" };

s3eFBSession_Login(lpSession, LoginCallback, NULL,
  permissions, 1);</pre></div><p>This code attempts to log in to Facebook requesting the <code class="literal">publish_stream</code> permission that allows an application to post to a user's wall.</p><p>When a Facebook login attempt is made, our application will lose focus and the device's Facebook application will be started. If the user doesn't have a Facebook application installed, the device's web browser will be launched instead.</p><p>You will be asked to provide your Facebook account's login details, so for testing purposes enter the details for one of the test user accounts we generated earlier. Once logged in, another screen will appear detailing what our application wants to do with the user's Facebook account. In the previous example this would just be posting to the user's wall. If the Facebook App has not yet been authorized for the Facebook account, the screen will also have two buttons labeled <strong>Allow</strong> and <strong>Don't Allow</strong>, which the user can use to grant or disallow access respectively.</p><div><div><h3 class="title"><a id="note49"/>Note</h3><p>The Facebook login process will first look to see if a user is already logged in to Facebook by looking for a browser cookie, and will not ask for username and password details if this is the case. If the test device is also your own personal device, you will probably want to log out of Facebook before testing your application to avoid annoying those on your friends list!</p></div></div><p>After authorizing <a id="id1329" class="indexterm"/>
<a id="id1330" class="indexterm"/> (or indeed disallowing) the Facebook App, our application will regain focus and the login callback function will be triggered to say whether the process was successful or not. If the Facebook app was not authorized or there is no Internet connection available, login will fail.</p><p>Logging back out of Facebook again is also simple. All we have to do is make a call to <code class="literal">s3eFBSession_Logout</code>, passing the <code class="literal">s3eFBSession</code> pointer as its only argument. In practice we only ever need to log out of Facebook on closing our application or if you specifically want to log off to allow different user credentials to be used instead. The session will not expire or become invalid as long as our application is executing.</p></div><div><div><div><div><h3 class="title"><a id="ch09lvl3sec93"/>Posting a message to a user's wall</h3></div></div></div><p>We'll now take a <a id="id1331" class="indexterm"/>
<a id="id1332" class="indexterm"/>look at one of the most common things that games use Facebook for: posting a message to the user's wall to alert their friends to a new high score or some in-game achievement.</p><p>In order to do this we'll be making use of the Facebook Graph API. There are other ways, but the Graph API is the most up-to-date way of doing so and doesn't look likely to be replaced any time soon.</p><div><div><h3 class="title"><a id="note50"/>Note</h3><p>For more information on the Facebook Graph API take a look at the web page <a class="ulink" href="http://developers.facebook.com/docs/reference/api/">http://developers.facebook.com/docs/reference/api/</a>, and for details about wall posts take a look at <a class="ulink" href="http://developers.facebook.com/docs/reference/api/post/">http://developers.facebook.com/docs/reference/api/post/</a>.</p></div></div><p>To begin making a Facebook Graph API<a id="id1333" class="indexterm"/> request, we use the function <code class="literal">s3eFBRequest_WithGraphPath</code>. This function takes as arguments the session pointer, the desired Facebook Graph path, and the HTTP method to use (GET or POST). The Graph path and HTTP method are both specified as null-terminated strings.</p><p>The function will return a pointer to an <code class="literal">s3eFBRequest</code> structure representing the new request if it is successful, or <code class="literal">NULL</code> if it fails.</p><p>With the request structure created, we can now add the various parameters we need to it using the functions <code class="literal">s3eFBRequest_AddParamNumber</code> and <code class="literal">s3eFBRequest_AddParamString</code>. Both functions take the <code class="literal">s3eFBRequest</code> structure pointer and a null-terminated string for the parameter name as their first two parameters. The third parameter is a 64-bit integer value (Marmalade defines a type called <code class="literal">int64</code> for this) for the former function call, or a <code class="literal">const char</code> pointer to a null terminated string for the latter function.</p><p>Most Graph <a id="id1334" class="indexterm"/>
<a id="id1335" class="indexterm"/>API values will require you to specify an access token to show that your application is authorized to make requests. The access token is provided to our application as part of the login process and we can retrieve it using the <code class="literal">s3eFBSession_AccessToken</code> function, which again takes the session pointer as its sole input. The access token is returned as a <code class="literal">const char</code> pointer.</p><p>The access token can then be added to a Graph request using the <code class="literal">s3eFBRequest_AddParamString</code> function by specifying <code class="literal">access_token</code> for the parameter name and using the return value from the <code class="literal">s3eFBSession_AccessToken</code> function as the value for the parameter.</p><p>Once all parameters have been added to the request, we can send it to the Facebook servers using the <code class="literal">s3eFBRequest_Send</code> function. This function takes the request pointer as its first input, followed by a callback function and a pointer to an optional block of data that will be passed to the callback function when it is triggered.</p><p>The function will return immediately with <code class="literal">S3E_RESULT_SUCCESS</code> if the request was sent, or <code class="literal">S3E_RESULT_ERROR</code> if there was a problem transmitting it. The s3eFacebook API will wait for the request from Facebook to arrive and will call the specified callback function with the result when it does.</p><p>When a request is completed we should make a call to <code class="literal">s3eFBRequest_Delete</code> to free any resources associated with it.</p><p>Let's look at an example illustrating all of the previous points for posting a simple message to the user's wall:</p><div><pre class="programlisting">// Sample callback function for s3eFBRequest_Send function
void RequestCallback(struct s3eFBRequest* apRequest,
   s3eResult* apRequestResult, void* apUserData)
{
   if (*apRequestResult == S3E_RESULT_SUCCESS)
   {
      // Request successful
   }
   else
   {
      // Request failed
   }

   // Free the request resources
   s3eFBRequest_Delete(apRequest);
}

// The following code snippet illustrates how we can send a request
// to Facebook using the Graph API to post a wall message

s3eFBRequest* lpRequest = s3eFBRequest_WithGraphPath(lpSession,
   "me/feed", "POST");
if (lpRequest)
{
   // Add the required parameters
   const char* lpAccessToken = s3eFBSession_AccessToken(lpSession);
   s3eFBRequest_AddParamString(lpRequest, "access_token",
      lpAccessToken);
   s3eFBRequest_AddParamString(lpRequest, "message",
      "Hello Facebook!");

   // Send the request to Facebook
   if (s3eFBRequest_Send(lpRequest, RequestCallback, NULL) ==
      S3E_RESULT_SUCCESS)
   {
      // Wait for the callback to be triggered now!
   }
   else
   {
      // Error occurred sending request, so free it
      s3eFBRequest_Delete(lpRequest);
   }
}</pre></div></div><div><div><div><div><h3 class="title"><a id="ch09lvl3sec94"/>Further s3eFacebook features</h3></div></div></div><p>The previous <a id="id1336" class="indexterm"/>sections really just scratch the surface of the kind of Facebook integration that is possible using s3eFacebook. For example, we have made no mention of processing any results sent back to our application by the Facebook API. There is a whole family of functions with the prefix <code class="literal">s3eFBRequest_Response</code> that allow the return values from a Facebook request to be analyzed.</p><p>For more information on the entire s3eFacebook API, go to <strong>Marmalade API Reference</strong> | <strong>Extensions API Documentation</strong> | <strong>Facebook Extension</strong> | <strong>Facebook API Reference</strong> in the Marmalade documentation.</p></div></div><div><div><div><div><h2 class="title"><a id="ch09lvl2sec142"/>Using Twitter</h2></div></div></div><p>Sadly <a id="id1337" class="indexterm"/>Marmalade provides no dedicated built-in support for Twitter; so if Twitter is important to you, you'll need to provide your own implementation.</p><p>One way of doing this would be to use the Twitter API directly by sending HTTP requests to Twitter's servers using the IwHTTP API. This would allow a solution to be created that should work fine on all operating systems; but this might require a lot of code to be implemented to deal with all the possible problems that can occur when working online (for example, lack of internet connection, server timeouts, and so on).</p><p>Another possibility, although it would be limited to iOS and Android, would be to use the Marmalade <strong>Extensions Development Kit</strong> (<strong>EDK</strong>)<a id="id1338" class="indexterm"/> to access existing Twitter solutions on these two platforms. This may be simpler to implement since the low level Twitter API HTTP requests will have been taken care of; but the EDK is currently only supported by iOS and Android. <a class="link" href="ch10.html" title="Chapter 10. Extending Marmalade with the Extensions Development Kit (EDK)">Chapter 10</a>, <em>Extending Marmalade with the Extensions Development Kit (EDK)</em>, of this book will be looking at the EDK in more detail.</p><p>If you are interested in supporting Twitter in Marmalade, the following web page may be of use to you:</p><p>
<a class="ulink" href="https://dev.twitter.com/docs/twitter-libraries#cplusplus">https://dev.twitter.com/docs/twitter-libraries#cplusplus</a>
</p><p>It mentions a number of existing C++-based libraries for accessing Twitter that may form a good starting point for a Marmalade solution.</p></div></div>
<div><div><div><div><h1 class="title"><a id="ch09lvl1sec58"/>Connecting to other types of online services</h1></div></div></div><p>We'll now take a quick look <a id="id1339" class="indexterm"/>at some of the other types of online services that games on mobile devices typically connect to. While we won't be covering these in depth, it's still worth giving them a mention in order to form a better picture of what is possible.</p><div><div><div><div><h2 class="title"><a id="ch09lvl2sec143"/>Supporting social gaming networks</h2></div></div></div><p>Social gaming networks <a id="id1340" class="indexterm"/>such as Apple's Game Center or cross-platform solutions such as Scoreloop<a id="id1341" class="indexterm"/> or OpenFeint<a id="id1342" class="indexterm"/> have become commonplace in many mobile games. In the following sections we will look at some of the possibilities we have available in Marmalade projects for these types of services.</p><div><div><div><div><h3 class="title"><a id="ch09lvl3sec95"/>Using Apple's Game Center</h3></div></div></div><p>One of the most well-known social gaming systems in the mobile games world has to be Apple's Game Center (<a class="ulink" href="http://www.apple.com/game-center/">http://www.apple.com/game-center/</a>). Unsurprisingly, this system is solely devoted to iOS-based devices, so if you are developing a game for iOS this is probably going to be your first choice for support. <a id="id1343" class="indexterm"/>
</p><p>We cannot access<a id="id1344" class="indexterm"/> Apple's API directly given that it is an Objective-C library, so Marmalade instead comes with a wrapper API for the service, called s3eIOSGameCenter.</p><p>The s3eIOSGameCenter API<a id="id1345" class="indexterm"/> is far too big for us to delve into here, but it is quite a close wrapping of the standard Apple-supplied API and thus fairly simple to understand how to convert any sample code you may come across on the Internet to use the Marmalade wrappers. An example project to demonstrate its use is supplied in the Marmalade installation folder <code class="literal">examples\s3eIOSGameCenter</code> and there is plenty of information in the Marmalade documentation too, at <strong>Marmalade API Reference</strong> | <strong>S3E API Documentation</strong> | <strong>S3E: iOS Only</strong> | <strong>S3E iOS Game Center</strong>.</p><p>Support is provided for all the major features of Game Center, including leaderboards and achievements, multiplayer matchmaking, and even voice chat!</p></div><div><div><div><div><h3 class="title"><a id="ch09lvl3sec96"/>Using Scoreloop</h3></div></div></div><p>The <a id="id1346" class="indexterm"/>Scoreloop system is an extremely popular cross-platform solution that, at the time of writing, supports iOS, Android, BlackBerry PlayBook, and Windows Phone 7. Given that Marmalade supports the first three of these platforms, combined with the fact that the nice people at Scoreloop also supply a version of their API that can be used directly in a Marmalade project, this system is a very good choice if you want to support social gaming in a cross-platform project.</p><p>The Marmalade version of Scoreloop provides support for leaderboards, achievements, and Scoreloop's challenge system for offline multiplayer gaming.</p><p>More information on Scoreloop can be found at <a class="ulink" href="http://www.scoreloop.com">www.scoreloop.com</a>, where you can sign up for a free developer account and download the latest version of the SDK.</p></div></div><div><div><div><div><h2 class="title"><a id="ch09lvl2sec144"/>Supporting in-app purchases</h2></div></div></div><p>The current popularity of so-called Freemium games has come about because there are now other ways of charging for games besides a single up-front purchase cost. The advent of <a id="id1347" class="indexterm"/> <strong>in-app purchases</strong> (<strong>IAP</strong>) has allowed us to literally give away our games for free and yet still make a profit by selling additional game modes or level packs to users after they have already played and enjoyed our games.</p><p>In the following sections we will be looking at how Marmalade allows in-app purchases to be supported on iOS and Android.</p><div><div><div><div><h3 class="title"><a id="ch09lvl3sec97"/>Adding in-app purchasing for iOS devices</h3></div></div></div><p>As with Game Center, the<a id="id1348" class="indexterm"/>
<a id="id1349" class="indexterm"/> in-app purchase SDK supplied by Apple is written in Objective-C, so we can't use it directly in a Marmalade project.</p><p>Again Marmalade solves this problem by wrapping up the Apple libraries into an API called <a id="id1350" class="indexterm"/>s3eIOSAppStoreBilling.</p><p>This API allows us to obtain a list of in-app products that are available for purchase and their costs. We can then make a request to purchase a particular product and will be notified of success or failure when Apple's servers have taken care of all the behind-the-scenes stuff that needs to be done in order to process the payment.</p><p>Just like the original Apple implementation, there is no support for allowing a user to automatically download extra data when a purchase has been made. Instead we have to implement this ourselves on receipt of the purchase confirmation, which would involve either shipping all the "unlockable" data with the original application download or downloading it from our own server.</p><p>For more information on this API, take a look in the Marmalade documentation by going to <strong>Marmalade API Reference</strong> | <strong>S3E API Documentation</strong> | <strong>S3E: iOS Only</strong> | <strong>S3E iOS App Store Billing</strong>, and the example code that can be found in the Marmalade installation at <code class="literal">examples\s3e\s3eIOSAppStoreBilling</code>.</p></div><div><div><div><div><h3 class="title"><a id="ch09lvl3sec98"/>Adding in-app purchasing for Android devices</h3></div></div></div><p>Marmalade also provides <a id="id1351" class="indexterm"/>
<a id="id1352" class="indexterm"/>a wrapper API for implementing in-app purchases on Android called s3eAndroidMarketBilling. The naming of this API is still based on the original name of the Android store (Android Marketplace), but it works fine with the renamed Google Play system.</p><p>Sadly Marmalade hasn't been able to provide a single API that can target multiple platforms, simply because the iOS and Android systems work so differently. A good example of this is that the Google Play system does not allow us to query the list of available products for an application. This is a really strange omission on Google's part (especially given that you do have to set up a product list on the Google Play servers anyway) and it means we either have to hardcode our product identifiers into our application or provide our own server to mirror this information.</p><p>Information on this API can be found in the documentation by going to <strong>Marmalade API Reference</strong> | <strong>S3E API Documentation</strong> | <strong>S3E: Android Only</strong> | <strong>S3E Android Market Billing</strong>, and there is some sample code at <code class="literal">examples\s3e\s3eAndroidMarketBilling</code>.</p></div></div><div><div><div><div><h2 class="title"><a id="ch09lvl2sec145"/>Using advertising</h2></div></div></div><p>We've just <a id="id1353" class="indexterm"/>looked at in-app purchases as being one way of generating an income from your games, but another way is to make use of one of the many advertising solutions available. Just like those clickable adverts that are a common part of most websites, we can give over a little part of our game's screen display to adverts that will then provide another potential income stream.</p><p>The following sections explore some of the options available to us.</p><div><div><div><div><h3 class="title"><a id="ch09lvl3sec99"/>Implementing iAd support for iOS devices</h3></div></div></div><p>As you are probably <a id="id1354" class="indexterm"/>
<a id="id1355" class="indexterm"/>aware, Apple has its own advertising solution purely for iOS, called <strong>iAd</strong>. Again this requires use of an Objective-C API, so the Marmalade SDK provides a C wrapper for it called <a id="id1356" class="indexterm"/> <strong>s3eIOSIAD</strong>.</p><p>This is a very simple API that allows you to request an advertisement from the iAd servers. If an advert is available you have control over when to show it, so the advert only needs to be visible at certain points in your game if you so wish.</p><p>Documentation on this API can be found at <strong>Marmalade API Reference |S3E API Documentation</strong> | <strong>S3E: iOS Only</strong> | <strong>S3E iOS iAd</strong>, and example code exists in the Marmalade installation directory at <code class="literal">examples\s3e\s3eIOSIAd</code>.</p></div><div><div><div><div><h3 class="title"><a id="ch09lvl3sec100"/>Using other advertising solutions</h3></div></div></div><p>Since iAd can <a id="id1357" class="indexterm"/>only be used on iOS platforms, we are forced to consider other possible solutions when targeting other platforms (although most of these other solutions can still be used on iOS as it happens!).</p><p>Marmalade does not provide support for any other advertising systems directly, but other developers have taken up the challenge here and have made their own solutions available for use on the Marmalade Code Community pages.</p><p>At the time of writing there are a couple of useful projects called <em>s3eAdWhirl</em> and <em>s3eAdNinja</em> that at least provide support for Android. These solutions are quite clever in that they actually target multiple sources of mobile advertising in order to ensure that an advert is shown in your application as often as possible to maximize your revenue.</p><p>The <em>IwGameAds</em> module is another open-source community project that shows how to integrate with multiple ad services and works across more platforms than you can shake a very large stick at. The full source code and documentation for it can be found at the following web address:</p><p>
<a class="ulink" href="http://www.drmop.com/index.php/iwgameads-sdk/">http://www.drmop.com/index.php/iwgameads-sdk/</a>
</p><p>In the unlikely event that these don't suit your needs and there is a particular mobile advertising system you would like to use, another possibility is to implement your own support for that system using the Extensions Development Kit that is described in more detail in the next chapter.</p></div></div></div>
<div><div><div><div><h1 class="title"><a id="ch09lvl1sec59"/>Example code</h1></div></div></div><p>Now let's take a look at the example code associated with this chapter.</p><div><div><div><div><h2 class="title"><a id="ch09lvl2sec146"/>The Facebook project</h2></div></div></div><p>The Facebook project <a id="id1358" class="indexterm"/>brings together into one place all the information contained in this chapter about posting to a user's Facebook wall so you can easily see how to implement the code in a more real-world application.</p><p>On running the sample, we are presented with two menu buttons. The first allows us to log in and out of Facebook while the second allows us to post a message to our wall when we have successfully logged in. A status message will be displayed at the bottom of the screen.</p><p>The s3eFacebook API has been further wrapped into a small class called <code class="literal">Facebook</code>, which deals with logging in and out of Facebook and building up Graph API requests. This is a good approach as it provides a further layer of abstraction and keeps all the s3eFacebook API usage in one place. If the core Facebook API were to change for any reason (possible, given that Facebook could potentially change the way in which things have to be done at any time), all the code that needs to be updated is easy to find.</p><p>The message to post to the wall is requested using the <code class="literal">s3eOSReadStringUTF8WithDefault</code> function; so this example also serves as a guide to using this API.</p><p>If you want to build and run this sample code, you will need to create your own Facebook App and supply the App Id and App Secret values generated for it. The <code class="literal">app.icf</code> file contains two settings allowing these values to be specified (though currently only the App Id is actually used in the code!).</p><p>It is also necessary to modify the <code class="literal">iphone-bundle-url-schemes</code> line in the <code class="literal">deployments</code> section of the project's MKB file. If this setting is not changed, the application will not regain focus after the Facebook login process on iOS devices.</p><p>As mentioned when discussing the s3eFacebook API earlier in this chapter, this sample code will only work on iOS and Android devices.</p></div><div><div><div><div><h2 class="title"><a id="ch09lvl2sec147"/>The Skiing project</h2></div></div></div><p>This chapter sees <a id="id1359" class="indexterm"/>Facebook support being added to the Skiing project. The <code class="literal">Facebook.cpp</code> and <code class="literal">Facebook.h</code> files created for the Facebook project have been added to the Skiing project unchanged in order to support posting a message to the user's wall.</p><p>When the player reaches the "game over" screen, a check is made to see if Facebook support is available. If it isn't, the normal "game over" message is displayed and after a short delay the user will return to the title screen.</p><p>If Facebook functionality is available, a slightly different "game over" screen is displayed. This version informs the player of their score and then asks if they wish to post a message on their wall to boast about it to their friends. Buttons marked <strong>Yes</strong> and <strong>No</strong> are provided to allow the player to choose what to do.</p><p>If they click on the <strong>Yes</strong> button, the game will attempt to log in to Facebook and then post a message detailing the player's score. The request also references an image file and a web page link that will also be displayed alongside the wall message.</p><p>As with the previous Facebook project, it is necessary to create your own Facebook App and supply the correct values for the App Id, App Secret, and the <code class="literal">iphone-bundle-url-schemes</code> setting.</p></div></div>
<div><div><div><div><h1 class="title"><a id="ch09lvl1sec60"/>Summary</h1></div></div></div><p>In this chapter we've taken a quick look at how to add various kinds of online services to our games. Specifically, we've seen how to add Facebook support to our titles and now know where to start looking should we want to include social gaming, advertising, or in-app purchases.</p><p>Each of these topics could easily fill an entire chapter, but unfortunately there just isn't room in this book to go any deeper. Hopefully you now have a good idea of the options available though.</p><p>At several points in this chapter the Extensions Development Kit (EDK) was mentioned as a possible way of implementing online features that are currently not supported as part of the base Marmalade SDK. In the next chapter, we will be taking a look at the EDK to see how we can access APIs that form part of the iOS and Android operating systems.</p></div></body></html>