<html><head></head><body>
<div id="_idContainer067" class="calibre2">
<h1 class="chapter-number" id="_idParaDest-159"><a id="_idTextAnchor160" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.1.1">8</span></h1>
<h1 id="_idParaDest-160" class="calibre5"><a id="_idTextAnchor161" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.2.1">Adding Media Playback to Packtflix with ExoPlayer</span></h1>
<p class="calibre3"><span class="kobospan" id="kobo.3.1">In the journey of Android development, the ability to create rich, engaging multimedia applications is a crucial skill that sets apart great apps from the good ones. </span><span class="kobospan" id="kobo.3.2">As we venture further into the creation of our Netflix-like app, we’ll transition from the foundational structures and user interfaces for browsing movie lists and details to the core of multimedia experiences: video playback. </span><span class="kobospan" id="kobo.3.3">This chapter is dedicated to unlocking the potential of video content within our application, a feature that will significantly enhance user engagement and satisfaction. </span><span class="kobospan" id="kobo.3.4">Here, we will travel into the world of media playback on Android, focusing on the powerful and versatile library known </span><span><span class="kobospan" id="kobo.4.1">as ExoPlayer.</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.5.1">ExoPlayer stands out in the Android ecosystem as a robust, open-source library that provides an alternative to the standard Android MediaPlayer API. </span><span class="kobospan" id="kobo.5.2">It offers extensive customization options and supports a wide range of media formats, including those not natively supported by Android. </span><span class="kobospan" id="kobo.5.3">Our exploration will begin with an overview of media options in Android, setting the stage for why ExoPlayer is the library of choice for modern Android applications seeking to offer a superior media </span><span><span class="kobospan" id="kobo.6.1">playback experience.</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.7.1">Following the introduction to media options, we will learn the basics of ExoPlayer, covering its architecture, key components, and how it integrates within an Android application. </span><span class="kobospan" id="kobo.7.2">This foundational knowledge will prepare us to tackle the practical aspects of implementing video playback. </span><span class="kobospan" id="kobo.7.3">This chapter will guide you through creating a responsive, intuitive video playback UI that meets the expectations of </span><span><span class="kobospan" id="kobo.8.1">today’s users.</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.9.1">The journey will continue with hands-on examples and detailed guidance on playing videos using ExoPlayer. </span><span class="kobospan" id="kobo.9.2">This includes managing playback controls, adjusting video quality, and handling various media sources. </span><span class="kobospan" id="kobo.9.3">Additionally, while recognizing the importance of accessibility and global reach, you’ll learn how to add subtitles to your videos, ensuring your content is accessible to a </span><span><span class="kobospan" id="kobo.10.1">wider audience.</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.11.1">By the end of this chapter, you will have mastered the essentials of video playback in Android, equipped with the skills to enrich your applications with high-quality video content, creating immersive experiences for </span><span><span class="kobospan" id="kobo.12.1">your users.</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.13.1">In this chapter, we will cover the </span><span><span class="kobospan" id="kobo.14.1">following topics:</span></span></p>
<ul class="calibre15">
<li class="calibre14"><span class="kobospan" id="kobo.15.1">Reviewing media options </span><span><span class="kobospan" id="kobo.16.1">in Android</span></span></li>
<li class="calibre14"><span class="kobospan" id="kobo.17.1">Reviewing Android’s </span><span><span class="kobospan" id="kobo.18.1">media options</span></span></li>
<li class="calibre14"><span class="kobospan" id="kobo.19.1">Creating the video playback </span><span><span class="kobospan" id="kobo.20.1">user interface</span></span></li>
<li class="calibre14"><span class="kobospan" id="kobo.21.1">Playing video </span><span><span class="kobospan" id="kobo.22.1">using ExoPlayer</span></span></li>
<li class="calibre14"><span class="kobospan" id="kobo.23.1">Adding subtitles to the </span><span><span class="kobospan" id="kobo.24.1">video player</span></span></li>
</ul>
<h1 id="_idParaDest-161" class="calibre5"><a id="_idTextAnchor162" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.25.1">Technical requirements</span></h1>
<p class="calibre3"><span class="kobospan" id="kobo.26.1">As in the previous chapter, you will need to have Android Studio (or another editor of your </span><span><span class="kobospan" id="kobo.27.1">preference) installed.</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.28.1">We will continue working on the same project we started in </span><a href="B19443_07.xhtml#_idTextAnchor142" class="calibre6 pcalibre1 pcalibre"><span><em class="italic"><span class="kobospan" id="kobo.29.1">Chapter 7</span></em></span></a><span class="kobospan" id="kobo.30.1">. </span><span class="kobospan" id="kobo.30.2">You can find the complete code that we are going to build throughout this chapter in this book’s GitHub </span><span><span class="kobospan" id="kobo.31.1">repository: </span></span><a href="https://github.com/PacktPublishing/Thriving-in-Android-Development-using-Kotlin/tree/main/Chapter-8" class="calibre6 pcalibre1 pcalibre"><span><span class="kobospan" id="kobo.32.1">https://github.com/PacktPublishing/Thriving-in-Android-Development-using-Kotlin/tree/main/Chapter-8</span></span></a><span><span class="kobospan" id="kobo.33.1">.</span></span></p>
<h1 id="_idParaDest-162" class="calibre5"><a id="_idTextAnchor163" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.34.1">Reviewing Android’s media options</span></h1>
<p class="calibre3"><span class="kobospan" id="kobo.35.1">Android, as a versatile mobile operating system, offers comprehensive support for various types of media, including but not limited to audio files (such as MP3, WAV, and OGG) and video </span><a id="_idIndexMarker899" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.36.1">content (such as MP4, WebM, and MKV). </span><span class="kobospan" id="kobo.36.2">This broad support empowers developers to incorporate a wide range of media types into their applications that can be used for diverse user preferences and use cases. </span><span class="kobospan" id="kobo.36.3">From educational apps that leverage video tutorials for learning to entertainment platforms streaming movies and music, media playback is at the heart of modern mobile applications, driving user engagement </span><span><span class="kobospan" id="kobo.37.1">and satisfaction.</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.38.1">To start our journey, let’s look at which options we have in the Android ecosystem so that we can choose the most appropriate option to build the playback functionality of our app. </span><span class="kobospan" id="kobo.38.2">We will start with MediaPlayer API and VideoView before </span><span><span class="kobospan" id="kobo.39.1">considering ExoPlayer.</span></span></p>
<h2 id="_idParaDest-163" class="calibre7"><a id="_idTextAnchor164" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.40.1">Learning about the MediaPlayer API</span></h2>
<p class="calibre3"><span class="kobospan" id="kobo.41.1">The </span><strong class="bold"><span class="kobospan" id="kobo.42.1">MediaPlayer</span></strong><span class="kobospan" id="kobo.43.1"> API is a powerful and flexible class that allows Android developers to handle </span><a id="_idIndexMarker900" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.44.1">audio and video playback with a high degree </span><a id="_idIndexMarker901" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.45.1">of control. </span><span class="kobospan" id="kobo.45.2">The API is designed to be easy to use yet capable of catering to complex media </span><span><span class="kobospan" id="kobo.46.1">playback requirements.</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.47.1">Its main </span><a id="_idIndexMarker902" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.48.1">features are </span><span><span class="kobospan" id="kobo.49.1">as follows:</span></span></p>
<ul class="calibre15">
<li class="calibre14"><strong class="bold"><span class="kobospan" id="kobo.50.1">Versatile media source support</span></strong><span class="kobospan" id="kobo.51.1">: MediaPlayer can play media from various sources, including local files (such as device storage or SD cards), raw resources (which are bundled within the app), and network </span><span><span class="kobospan" id="kobo.52.1">streams (HTTP/HTTPS).</span></span></li>
<li class="calibre14"><strong class="bold"><span class="kobospan" id="kobo.53.1">Playback control</span></strong><span class="kobospan" id="kobo.54.1">: It offers comprehensive control over media playback, including play, pause, stop, rewind, and fast-forward options, as well as the ability to seek </span><span><span class="kobospan" id="kobo.55.1">specific timestamps.</span></span></li>
<li class="calibre14"><strong class="bold"><span class="kobospan" id="kobo.56.1">Volume control</span></strong><span class="kobospan" id="kobo.57.1">: The MediaPlayer API in Android allows developers to programmatically adjust the volume of audio playback. </span><span class="kobospan" id="kobo.57.2">This is achieved through methods such as </span><strong class="source-inline1"><span class="kobospan" id="kobo.58.1">setVolume(float leftVolume, float rightVolume)</span></strong><span class="kobospan" id="kobo.59.1">, which controls the volume level of the left and right speakers independently. </span><span class="kobospan" id="kobo.59.2">This feature is essential for creating applications that can dynamically adjust the playback volume based on specific user settings, environmental conditions, or application scenarios. </span><span class="kobospan" id="kobo.59.3">For instance, an app might automatically lower the volume during nighttime hours or increase it in a noisy environment to enhance </span><span><span class="kobospan" id="kobo.60.1">user experience.</span></span></li>
<li class="calibre14"><strong class="bold"><span class="kobospan" id="kobo.61.1">Event handling</span></strong><span class="kobospan" id="kobo.62.1">: MediaPlayer provides listeners that can be used to respond to media life cycle events, such as completion, preparation, error handling, and </span><span><span class="kobospan" id="kobo.63.1">buffering updates.</span></span></li>
<li class="calibre14"><strong class="bold"><span class="kobospan" id="kobo.64.1">Audio focus management</span></strong><span class="kobospan" id="kobo.65.1">: Essential for apps that play audio, MediaPlayer can handle audio focus to ensure a smooth user experience when multiple apps potentially play </span><span><span class="kobospan" id="kobo.66.1">sounds simultaneously.</span></span></li>
</ul>
<p class="calibre3"><span class="kobospan" id="kobo.67.1">As we can see, MediaPlayer provides the basic functionality we need for simple audio and video </span><a id="_idIndexMarker903" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.68.1">handling, so it could be a good solution for the </span><span><span class="kobospan" id="kobo.69.1">following cases:</span></span></p>
<ul class="calibre15">
<li class="calibre14"><strong class="bold"><span class="kobospan" id="kobo.70.1">Music players</span></strong><span class="kobospan" id="kobo.71.1">: MediaPlayer is well-suited for apps that play music or podcast files, whether it’s stored locally or streamed over </span><span><span class="kobospan" id="kobo.72.1">the internet</span></span></li>
<li class="calibre14"><strong class="bold"><span class="kobospan" id="kobo.73.1">Video players</span></strong><span class="kobospan" id="kobo.74.1">: Although MediaPlayer requires more setup for video playback compared to VideoView, it’s ideal for custom video player applications where developers need control over rendering </span><span><span class="kobospan" id="kobo.75.1">and playback</span></span></li>
<li class="calibre14"><strong class="bold"><span class="kobospan" id="kobo.76.1">Game sound effects</span></strong><span class="kobospan" id="kobo.77.1">: For games that need to play short sound effects, MediaPlayer can be used for its simplicity and ability to handle various </span><span><span class="kobospan" id="kobo.78.1">audio formats</span></span></li>
</ul>
<p class="calibre3"><span class="kobospan" id="kobo.79.1">Here’s an </span><a id="_idIndexMarker904" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.80.1">example of how to reproduce </span><a id="_idIndexMarker905" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.81.1">an audio file </span><span><span class="kobospan" id="kobo.82.1">using MediaPlayer:</span></span></p>
<pre class="source-code"><span class="kobospan1" id="kobo.83.1">
@Composable
fun AudioPlayerComposable() {
    val context = LocalContext.current
    val mediaPlayer = remember { MediaPlayer.create(
        context, R.raw.my_audio_file) }
    // Observe lifecycle to release MediaPlayer
    ObserveLifecycle(owner = ProcessLifecycleOwner.get()) {
        onExit = {
            mediaPlayer.release()
        }
    }
    Column(modifier = Modifier.padding(16.dp)) {
        Button(onClick = {
            if (!mediaPlayer.isPlaying) {
                mediaPlayer.start()
            }
        }) {
            Text("Play")
        }
        Button(onClick = {
            if (mediaPlayer.isPlaying) {
                mediaPlayer.pause() // Use pause or stop
                                       based on your need
            }
        }) {
            Text("Stop")
        }
    }
}
@Composable
fun ObserveLifecycle(owner: LifecycleOwner, onExit: () -&gt;
Unit) {
    // Use DisposableEffect to manage lifecycle
    DisposableEffect(owner) {
        val observer = LifecycleEventObserver { _, event -&gt;
            if (event == Lifecycle.Event.ON_DESTROY) {
                onExit()
            }
        }
        owner.lifecycle.addObserver(observer)
        onDispose {
            owner.lifecycle.removeObserver(observer)
        }
    }
}</span></pre> <p class="calibre3"><span class="kobospan" id="kobo.84.1">In this example, </span><strong class="source-inline"><span class="kobospan" id="kobo.85.1">MediaPlayer.create()</span></strong><span class="kobospan" id="kobo.86.1"> is used within the </span><strong class="source-inline"><span class="kobospan" id="kobo.87.1">remember</span></strong><span class="kobospan" id="kobo.88.1"> block to ensure that the media player is only instantiated once, maintaining this instance across recompositions </span><a id="_idIndexMarker906" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.89.1">of the composable. </span><span class="kobospan" id="kobo.89.2">Then, the </span><strong class="source-inline"><span class="kobospan" id="kobo.90.1">ObserveLifecycle</span></strong><span class="kobospan" id="kobo.91.1"> composable function is used to observe the life cycle of the entire application (using </span><strong class="source-inline"><span class="kobospan" id="kobo.92.1">ProcessLifecycleOwner</span></strong><span class="kobospan" id="kobo.93.1"> here for simplicity). </span><span class="kobospan" id="kobo.93.2">This function </span><a id="_idIndexMarker907" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.94.1">ensures that </span><strong class="source-inline"><span class="kobospan" id="kobo.95.1">mediaPlayer.release()</span></strong><span class="kobospan" id="kobo.96.1"> is called to free up resources when the app is destroyed, although you might adapt this to more specific life cycle events </span><span><span class="kobospan" id="kobo.97.1">as needed.</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.98.1">The UI consists of two buttons for play and stop functionalities. </span><span class="kobospan" id="kobo.98.2">The play button’s </span><strong class="source-inline"><span class="kobospan" id="kobo.99.1">onClick</span></strong><span class="kobospan" id="kobo.100.1"> logic checks if the media is not currently playing before starting playback. </span><span class="kobospan" id="kobo.100.2">This is done to avoid restarting the audio and video if the button is pressed during playback. </span><span class="kobospan" id="kobo.100.3">Similarly, the stop button pauses </span><span><span class="kobospan" id="kobo.101.1">the playback.</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.102.1">This example demonstrates how to integrate MediaPlayer with Jetpack Compose while managing the media player life cycle and providing a simple UI for controlling playback. </span><span class="kobospan" id="kobo.102.2">You can find more examples in the official </span><span><span class="kobospan" id="kobo.103.1">documentation: </span></span><a href="https://developer.android.com/media/platform/mediaplayer" class="calibre6 pcalibre1 pcalibre"><span><span class="kobospan" id="kobo.104.1">https://developer.android.com/media/platform/mediaplayer</span></span></a><span><span class="kobospan" id="kobo.105.1">.</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.106.1">Although our example illustrates how to provide the playback control UI, we still need to show the video so that our users can watch it. </span><span class="kobospan" id="kobo.106.2">This is where VideoView </span><span><span class="kobospan" id="kobo.107.1">comes in.</span></span></p>
<h2 id="_idParaDest-164" class="calibre7"><a id="_idTextAnchor165" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.108.1">Learning about VideoView</span></h2>
<p class="calibre3"><strong class="bold"><span class="kobospan" id="kobo.109.1">VideoView</span></strong><span class="kobospan" id="kobo.110.1"> is a higher-level UI component in Android that encapsulates the functionality </span><a id="_idIndexMarker908" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.111.1">of MediaPlayer and SurfaceView to provide a convenient way to play video files. </span><span class="kobospan" id="kobo.111.2">It simplifies the process of video playback by managing the underlying </span><a id="_idIndexMarker909" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.112.1">media playback mechanics, making it ideal for use cases that require straightforward video playback without the need for fine-grained control over the </span><span><span class="kobospan" id="kobo.113.1">media pipeline.</span></span></p>
<p class="callout-heading"><span class="kobospan" id="kobo.114.1">Note</span></p>
<p class="callout"><span class="kobospan" id="kobo.115.1">SurfaceView is a specialized component in the Android framework that provides a dedicated drawing surface within the app’s view hierarchy. </span><span class="kobospan" id="kobo.115.2">Unlike standard views, which are drawn onto a single canvas managed by the UI thread, SurfaceView can be rendered independently in a separate thread. </span><span class="kobospan" id="kobo.115.3">This allows for more efficient redrawing, especially for demanding content such as video playback or dynamic graphics. </span><span class="kobospan" id="kobo.115.4">SurfaceView is particularly useful when you need to update your views frequently or when the rendering process is computationally intensive as it does not block user interaction </span><span><span class="kobospan" id="kobo.116.1">while drawing.</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.117.1">Let’s explore </span><a id="_idIndexMarker910" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.118.1">some of VideoView’s features so that we can appreciate the practical benefits </span><span><span class="kobospan" id="kobo.119.1">it offers:</span></span></p>
<ul class="calibre15">
<li class="calibre14"><strong class="bold"><span class="kobospan" id="kobo.120.1">Simplicity</span></strong><span class="kobospan" id="kobo.121.1">: VideoView simplifies the implementation of video playback. </span><span class="kobospan" id="kobo.121.2">You can start playing a video with just a few lines of code, handling preparation and playback of the video </span><span><span class="kobospan" id="kobo.122.1">file automatically.</span></span></li>
<li class="calibre14"><strong class="bold"><span class="kobospan" id="kobo.123.1">Control integration</span></strong><span class="kobospan" id="kobo.124.1">: It can be easily integrated with media controls (using MediaController), allowing users to play, pause, and seek through </span><span><span class="kobospan" id="kobo.125.1">the video.</span></span></li>
<li class="calibre14"><strong class="bold"><span class="kobospan" id="kobo.126.1">Format support</span></strong><span class="kobospan" id="kobo.127.1">: VideoView supports various video formats that Android’s MediaPlayer </span><a id="_idIndexMarker911" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.128.1">supports, including MP4, 3GP, and more, depending on the device and </span><span><span class="kobospan" id="kobo.129.1">platform version.</span></span></li>
<li class="calibre14"><strong class="bold"><span class="kobospan" id="kobo.130.1">Layout flexibility</span></strong><span class="kobospan" id="kobo.131.1">: Being a view, VideoView can be placed anywhere in your application’s layout and can be resized and styled as needed, just like any other </span><span><span class="kobospan" id="kobo.132.1">UI component.</span></span></li>
</ul>
<p class="calibre3"><span class="kobospan" id="kobo.133.1">Understanding VideoView’s features sets the stage for its practical applications. </span><span class="kobospan" id="kobo.133.2">Now, let’s pinpoint </span><a id="_idIndexMarker912" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.134.1">exactly where VideoView shines. </span><span class="kobospan" id="kobo.134.2">Here are the best scenarios for using VideoView in </span><span><span class="kobospan" id="kobo.135.1">your app:</span></span></p>
<ul class="calibre15">
<li class="calibre14"><strong class="bold"><span class="kobospan" id="kobo.136.1">Simple video playback</span></strong><span class="kobospan" id="kobo.137.1">: When you need to play videos without requiring advanced playback features such as adaptive streaming, VideoView is a straightforward </span><a id="_idIndexMarker913" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.138.1">and effective choice. </span><span class="kobospan" id="kobo.138.2">Adaptive streaming, such </span><a id="_idIndexMarker914" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.139.1">as </span><strong class="bold"><span class="kobospan" id="kobo.140.1">HTTP Live Streaming</span></strong><span class="kobospan" id="kobo.141.1"> (</span><strong class="bold"><span class="kobospan" id="kobo.142.1">HLS</span></strong><span class="kobospan" id="kobo.143.1">) and </span><strong class="bold"><span class="kobospan" id="kobo.144.1">Dynamic Adaptive Streaming over HTTP</span></strong><span class="kobospan" id="kobo.145.1"> (</span><strong class="bold"><span class="kobospan" id="kobo.146.1">DASH</span></strong><span class="kobospan" id="kobo.147.1">), allows videos to be delivered in varying qualities, depending on network conditions. </span><span class="kobospan" id="kobo.147.2">HLS is widely used for live and on-demand streaming on the web, as well as dynamically adjusting video quality based on the viewer’s internet speed. </span><span class="kobospan" id="kobo.147.3">Similarly, DASH is a flexible standard that enables high-quality streaming of media content over </span><span><span class="kobospan" id="kobo.148.1">the internet.</span></span></li>
<li class="calibre14"><strong class="bold"><span class="kobospan" id="kobo.149.1">Local and network videos</span></strong><span class="kobospan" id="kobo.150.1">: It’s suitable for playing videos stored locally on the device or streamed over </span><span><span class="kobospan" id="kobo.151.1">the network.</span></span></li>
<li class="calibre14"><strong class="bold"><span class="kobospan" id="kobo.152.1">Embedded video content</span></strong><span class="kobospan" id="kobo.153.1">: VideoView is great for applications that need to embed video content directly within their UI, such as tutorial apps, video players, or social media apps with </span><span><span class="kobospan" id="kobo.154.1">video feeds.</span></span></li>
</ul>
<p class="calibre3"><span class="kobospan" id="kobo.155.1">Now that we know its features and recommended use cases, let’s look at an example so that we understand how it works. </span><span class="kobospan" id="kobo.155.2">In this example, we’re using the 1.7.0 version of the </span><span><strong class="source-inline"><span class="kobospan" id="kobo.156.1">androidx.media:media</span></strong></span><span><span class="kobospan" id="kobo.157.1"> library:</span></span></p>
<pre class="source-code"><span class="kobospan1" id="kobo.158.1">
@Composable
fun VideoPlayer(modifier: Modifier = Modifier, videoUrl:
String) {
    val context = LocalContext.current
    AndroidView(
        modifier = modifier,
        factory = { ctx -&gt;
            VideoView(ctx).apply {
                val mediaController = MediaController(ctx)
                setMediaController(mediaController)
                mediaController.setAnchorView(this)
                setVideoURI(Uri.parse(videoUrl))
                start() // Auto-start playback
            }
        }
    )
}</span></pre> <p class="calibre3"><span class="kobospan" id="kobo.159.1">Here, we start by </span><a id="_idIndexMarker915" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.160.1">declaring a composable called </span><strong class="source-inline"><span class="kobospan" id="kobo.161.1">VideoPlayer</span></strong><span class="kobospan" id="kobo.162.1">. </span><span class="kobospan" id="kobo.162.2">This composable </span><a id="_idIndexMarker916" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.163.1">accepts a </span><strong class="source-inline"><span class="kobospan" id="kobo.164.1">videoUrl</span></strong><span class="kobospan" id="kobo.165.1"> string as a parameter. </span><span class="kobospan" id="kobo.165.2">This specifies the location of the video to </span><span><span class="kobospan" id="kobo.166.1">be played.</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.167.1">Within the function, </span><strong class="source-inline"><span class="kobospan" id="kobo.168.1">LocalContext.current</span></strong><span class="kobospan" id="kobo.169.1"> is used to obtain the current context from the Compose environment. </span><span class="kobospan" id="kobo.169.2">The </span><strong class="source-inline"><span class="kobospan" id="kobo.170.1">AndroidView</span></strong><span class="kobospan" id="kobo.171.1"> composable is then employed to bridge the gap between traditional Android UI components and the Compose world. </span><span class="kobospan" id="kobo.171.2">It takes a factory Lambda expression where </span><strong class="source-inline"><span class="kobospan" id="kobo.172.1">VideoView</span></strong><span class="kobospan" id="kobo.173.1"> is instantiated by using </span><span><span class="kobospan" id="kobo.174.1">the context.</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.175.1">Next, </span><strong class="source-inline"><span class="kobospan" id="kobo.176.1">MediaController</span></strong><span class="kobospan" id="kobo.177.1"> is created and associated with </span><strong class="source-inline"><span class="kobospan" id="kobo.178.1">VideoView</span></strong><span class="kobospan" id="kobo.179.1"> through </span><strong class="source-inline"><span class="kobospan" id="kobo.180.1">setMediaController()</span></strong><span class="kobospan" id="kobo.181.1">, providing standard media controls such as play, pause, and seek to enhance user interaction with the </span><span><span class="kobospan" id="kobo.182.1">video playback.</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.183.1">The media </span><a id="_idIndexMarker917" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.184.1">controller is anchored to </span><strong class="source-inline"><span class="kobospan" id="kobo.185.1">VideoView</span></strong><span class="kobospan" id="kobo.186.1"> using </span><strong class="source-inline"><span class="kobospan" id="kobo.187.1">setAnchorView(this)</span></strong><span class="kobospan" id="kobo.188.1">, ensuring that the control interface is displayed </span><a id="_idIndexMarker918" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.189.1">correctly concerning the video view. </span><span class="kobospan" id="kobo.189.2">The video URL that’s passed to the function is parsed into a </span><strong class="source-inline"><span class="kobospan" id="kobo.190.1">Uri</span></strong><span class="kobospan" id="kobo.191.1"> component and set on </span><strong class="source-inline"><span class="kobospan" id="kobo.192.1">VideoView</span></strong><span class="kobospan" id="kobo.193.1"> with </span><strong class="source-inline"><span class="kobospan" id="kobo.194.1">setVideoURI()</span></strong><span class="kobospan" id="kobo.195.1">, pointing the player to the </span><span><span class="kobospan" id="kobo.196.1">video content.</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.197.1">Finally, </span><strong class="source-inline"><span class="kobospan" id="kobo.198.1">start()</span></strong><span class="kobospan" id="kobo.199.1"> is called on </span><strong class="source-inline"><span class="kobospan" id="kobo.200.1">VideoView</span></strong><span class="kobospan" id="kobo.201.1"> to initiate video playback automatically as soon as the setup is complete and the video is ready to </span><span><span class="kobospan" id="kobo.202.1">be shown.</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.203.1">In this section, we took a sneak peek at how the MediaPlayer API and VideoView work and their features. </span><span class="kobospan" id="kobo.203.2">Now, it’s time for the crown </span><span><span class="kobospan" id="kobo.204.1">jewel: ExoPlayer.</span></span></p>
<h1 id="_idParaDest-165" class="calibre5"><a id="_idTextAnchor166" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.205.1">Understanding the basics of ExoPlayer</span></h1>
<p class="calibre3"><strong class="bold"><span class="kobospan" id="kobo.206.1">ExoPlayer</span></strong><span class="kobospan" id="kobo.207.1"> stands as a significant advancement over Android’s basic MediaPlayer, offering a level </span><a id="_idIndexMarker919" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.208.1">of flexibility, customization, and support for advanced streaming formats that MediaPlayer simply cannot match. </span><span class="kobospan" id="kobo.208.2">This superiority makes ExoPlayer the go-to choice for developers needing robust, feature-rich media playback capabilities in </span><span><span class="kobospan" id="kobo.209.1">their applications.</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.210.1">One of ExoPlayer’s most compelling advantages is its adaptability. </span><span class="kobospan" id="kobo.210.2">Unlike the relatively static MediaPlayer, ExoPlayer can be easily adapted and extended to suit specific application needs. </span><span class="kobospan" id="kobo.210.3">Its modular architecture allows developers to include only the components they need, reducing the app’s overall size. </span><span class="kobospan" id="kobo.210.4">Furthermore, ExoPlayer’s customization options extend to its user interface, with the ability to create custom controls and layouts that seamlessly integrate with the rest of the application’s design. </span><span class="kobospan" id="kobo.210.5">This adaptability ensures that developers can craft a unique media playback experience that aligns perfectly with their app’s branding and user </span><span><span class="kobospan" id="kobo.211.1">interface guidelines.</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.212.1">In the realm of streaming, ExoPlayer’s strengths become even more apparent. </span><span class="kobospan" id="kobo.212.2">It offers out-of-the-box support for modern streaming protocols such as HLS and DASH. </span><span class="kobospan" id="kobo.212.3">These adaptive streaming protocols are essential for delivering content efficiently over the internet, adjusting the quality of the stream in real time based on the user’s current network conditions. </span><span class="kobospan" id="kobo.212.4">This ensures an optimal viewing experience that minimizes buffering and playback interruptions even under fluctuating </span><span><span class="kobospan" id="kobo.213.1">network speeds.</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.214.1">MediaPlayer, by contrast, offers limited support for such streaming protocols, often requiring developers to implement additional solutions or workarounds to achieve similar functionality. </span><span class="kobospan" id="kobo.214.2">With ExoPlayer, developers gain direct access to these advanced features, simplifying the development process and enhancing the end </span><span><span class="kobospan" id="kobo.215.1">user experience.</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.216.1">As we can see, ExoPlayer’s functionality is widely superior due to its flexibility and wide format support </span><a id="_idIndexMarker920" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.217.1">and those are the reasons we will use it in this project. </span><span class="kobospan" id="kobo.217.2">On the other hand, as it is more complex, we will have to learn more about it before we start to implement our video player </span><span><span class="kobospan" id="kobo.218.1">using it.</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.219.1">Well, let’s do exactly that and break down </span><span><span class="kobospan" id="kobo.220.1">ExoPlayer’s architecture.</span></span></p>
<h2 id="_idParaDest-166" class="calibre7"><a id="_idTextAnchor167" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.221.1">Exploring ExoPlayer’s architecture</span></h2>
<p class="calibre3"><span class="kobospan" id="kobo.222.1">ExoPlayer’s architecture is designed to be both flexible and extensible, making it capable of handling a </span><a id="_idIndexMarker921" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.223.1">wide range of media playback scenarios. </span><span class="kobospan" id="kobo.223.2">ExoPlayer has several core components that work together to provide a robust and efficient media playback experience. </span><span class="kobospan" id="kobo.223.3">Understanding these components is key to leveraging ExoPlayer’s full capabilities in our applications. </span><span class="kobospan" id="kobo.223.4">Let’s take a look at </span><span><span class="kobospan" id="kobo.224.1">them here.</span></span></p>
<h3 class="calibre9"><span class="kobospan" id="kobo.225.1">The ExoPlayer instance – the central media playback engine</span></h3>
<p class="calibre3"><span class="kobospan" id="kobo.226.1">The ExoPlayer instance itself acts as the central hub for media playback, orchestrating the interaction between the various components involved in the playback process, managing the </span><a id="_idIndexMarker922" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.227.1">playback state, and coordinating the </span><a id="_idIndexMarker923" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.228.1">fetching, decoding, and rendering of media. </span><span class="kobospan" id="kobo.228.2">Unlike Android’s MediaPlayer, which operates as a black box, ExoPlayer provides developers with detailed control over playback and access to the playback pipeline, enabling fine-tuned adjustments to fit the application’s </span><span><span class="kobospan" id="kobo.229.1">specific needs.</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.230.1">Here’s a simple example of how to initialize ExoPlayer and prepare it to play a </span><span><span class="kobospan" id="kobo.231.1">media item:</span></span></p>
<pre class="source-code"><span class="kobospan1" id="kobo.232.1">
val context = ... </span><span class="kobospan1" id="kobo.232.2">// Your context here
val player = ExoPlayer.Builder(context).build().apply {
    // Media item to be played
    val mediaItem =
        MediaItem.fromUri("http://example.com/media.mp3")
    // Set the media item to be played
    setMediaItem(mediaItem)
    // Prepare the player
    prepare()
    // Start playback
    playWhenReady = true
}</span></pre> <p class="calibre3"><span class="kobospan" id="kobo.233.1">The process begins with creating an </span><strong class="source-inline"><span class="kobospan" id="kobo.234.1">ExoPlayer</span></strong><span class="kobospan" id="kobo.235.1"> instance, utilizing a context-aware builder pattern </span><a id="_idIndexMarker924" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.236.1">that ensures the player is </span><a id="_idIndexMarker925" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.237.1">configured for the environment where it operates. </span><span class="kobospan" id="kobo.237.2">Following its instantiation, a media item is specified through a URI, which could either point to a local resource or a remote media file. </span><span class="kobospan" id="kobo.237.3">This media item is then associated with the </span><strong class="source-inline"><span class="kobospan" id="kobo.238.1">ExoPlayer</span></strong><span class="kobospan" id="kobo.239.1"> instance, indicating what content it should be prepared </span><span><span class="kobospan" id="kobo.240.1">to play.</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.241.1">Once the media item has been set, the player enters a preparation phase by invoking the </span><strong class="source-inline"><span class="kobospan" id="kobo.242.1">prepare()</span></strong><span class="kobospan" id="kobo.243.1"> method. </span><span class="kobospan" id="kobo.243.2">During this phase, ExoPlayer analyzes the media, setting up necessary buffers and decoding resources to ensure </span><span><span class="kobospan" id="kobo.244.1">smooth playback.</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.245.1">The final step in the process involves setting the player’s </span><strong class="source-inline"><span class="kobospan" id="kobo.246.1">playWhenReady</span></strong><span class="kobospan" id="kobo.247.1"> property to </span><strong class="source-inline"><span class="kobospan" id="kobo.248.1">true</span></strong><span class="kobospan" id="kobo.249.1">, a command that triggers playback as soon as the player is fully prepared. </span><span class="kobospan" id="kobo.249.2">This property provides flexibility, allowing developers to control when playback should start. </span><span class="kobospan" id="kobo.249.3">This can be immediately after preparation or delayed based on additional conditions or </span><span><span class="kobospan" id="kobo.250.1">user interactions.</span></span></p>
<h3 class="calibre9"><span class="kobospan" id="kobo.251.1">MediaItem – sourcing the media resource</span></h3>
<p class="calibre3"><span class="kobospan" id="kobo.252.1">In ExoPlayer, </span><strong class="bold"><span class="kobospan" id="kobo.253.1">MediaItem</span></strong><span class="kobospan" id="kobo.254.1"> encapsulates </span><a id="_idIndexMarker926" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.255.1">details about a media source, such as </span><a id="_idIndexMarker927" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.256.1">its URI, metadata, and any configuration related to playback. </span><span class="kobospan" id="kobo.256.2">It is a versatile and essential component that tells ExoPlayer what </span><a id="_idIndexMarker928" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.257.1">content to load and play.  </span><span class="kobospan" id="kobo.257.2">These are the key functions </span><span><span class="kobospan" id="kobo.258.1">of MediaItem:</span></span></p>
<ul class="calibre15">
<li class="calibre14"><strong class="bold"><span class="kobospan" id="kobo.259.1">Media source specification</span></strong><span class="kobospan" id="kobo.260.1">: The primary function of MediaItem is to specify the location of the media to be played. </span><span class="kobospan" id="kobo.260.2">This can be a file path, a URL, or a content URI, among </span><span><span class="kobospan" id="kobo.261.1">other formats.</span></span></li>
<li class="calibre14"><strong class="bold"><span class="kobospan" id="kobo.262.1">Media configuration</span></strong><span class="kobospan" id="kobo.263.1">: Beyond just specifying a media source, MediaItem allows for detailed configuration of the playback. </span><span class="kobospan" id="kobo.263.2">This includes setting DRM configurations, specifying subtitles, and defining custom attributes </span><span><span class="kobospan" id="kobo.264.1">through metadata.</span></span></li>
<li class="calibre14"><strong class="bold"><span class="kobospan" id="kobo.265.1">Adaptive streaming</span></strong><span class="kobospan" id="kobo.266.1">: For adaptive streaming content (such as DASH and HLS), MediaItem can include the necessary information for ExoPlayer to adapt the stream’s quality dynamically based on network conditions. </span><span class="kobospan" id="kobo.266.2">This information includes metadata such as the URLs of the various stream segments, available quality levels, </span><span><span class="kobospan" id="kobo.267.1">and codecs.</span></span></li>
<li class="calibre14"><strong class="bold"><span class="kobospan" id="kobo.268.1">Playback options</span></strong><span class="kobospan" id="kobo.269.1">: Developers can use MediaItem to configure specific playback options, such as start and end positions, looping, and more. </span><span class="kobospan" id="kobo.269.2">These options provide fine-grained control over how the media </span><span><span class="kobospan" id="kobo.270.1">is played.</span></span></li>
</ul>
<p class="calibre3"><span class="kobospan" id="kobo.271.1">In practice, once a MediaItem is created and configured, it is passed to the ExoPlayer instance so that it can be prepared for playback. </span><span class="kobospan" id="kobo.271.2">You can load a single MediaItem for simple playback scenarios or manage a playlist by loading multiple MediaItems. </span><span class="kobospan" id="kobo.271.3">Let’s see a </span><span><span class="kobospan" id="kobo.272.1">brief example:</span></span></p>
<pre class="source-code"><span class="kobospan1" id="kobo.273.1">
val mediaItem =
    MediaItem.fromUri("https://example.com/video.mp4")
player.setMediaItem(mediaItem)
player.prepare() // Prepares the player with the provided
                    MediaItem
player.playWhenReady = true // Starts playback as soon as
                               preparation is complete</span></pre> <p class="calibre3"><span class="kobospan" id="kobo.274.1">In this </span><a id="_idIndexMarker929" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.275.1">example, we are creating </span><strong class="source-inline"><span class="kobospan" id="kobo.276.1">mediaItem</span></strong><span class="kobospan" id="kobo.277.1"> from a URL and preparing it </span><a id="_idIndexMarker930" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.278.1">to be reproduced by the </span><span><span class="kobospan" id="kobo.279.1">ExoPlayer instance.</span></span></p>
<h3 class="calibre9"><span class="kobospan" id="kobo.280.1">TrackSelector – managing media tracks</span></h3>
<p class="calibre3"><span class="kobospan" id="kobo.281.1">The </span><strong class="source-inline"><span class="kobospan" id="kobo.282.1">TrackSelector</span></strong><span class="kobospan" id="kobo.283.1"> instance is a critical component of ExoPlayer that’s responsible for selecting </span><a id="_idIndexMarker931" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.284.1">the specific tracks to be played. </span><span class="kobospan" id="kobo.284.2">A video might contain multiple audio tracks in different languages, several video qualities, or various subtitle tracks, and </span><strong class="source-inline"><span class="kobospan" id="kobo.285.1">TrackSelector</span></strong><span class="kobospan" id="kobo.286.1"> decides which of these tracks are </span><a id="_idIndexMarker932" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.287.1">best suited for the current playback context based on the device’s capabilities, user preferences, and network conditions. </span><span class="kobospan" id="kobo.287.2">This selection process is crucial for adaptive streaming scenarios as a single video is encoded at multiple quality levels and stored on </span><span><span class="kobospan" id="kobo.288.1">the server.</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.289.1">Here’s an example of </span><span><span class="kobospan" id="kobo.290.1">its use:</span></span></p>
<pre class="source-code"><span class="kobospan1" id="kobo.291.1">
val trackSelector =
    DefaultTrackSelector(context).apply {
        setParameters(buildUponParameters()
            .setPreferredAudioLanguage("en")
}
val player = ExoPlayer.Builder(context)
    .setTrackSelector(trackSelector)
    .build()</span></pre> <p class="calibre3"><span class="kobospan" id="kobo.292.1">The process starts with the creation of a </span><strong class="source-inline"><span class="kobospan" id="kobo.293.1">DefaultTrackSelector</span></strong><span class="kobospan" id="kobo.294.1"> instance. </span><span class="kobospan" id="kobo.294.2">The </span><strong class="source-inline"><span class="kobospan" id="kobo.295.1">DefaultTrackSelector</span></strong><span class="kobospan" id="kobo.296.1"> instance is a component of </span><strong class="source-inline"><span class="kobospan" id="kobo.297.1">ExoPlayer</span></strong><span class="kobospan" id="kobo.298.1"> that decides which tracks (audio, video, or text) are played from the media based on various criteria, such as the user’s device capabilities and the tracks’ properties. </span><span class="kobospan" id="kobo.298.2">In this example, the track selector is configured to prefer audio tracks in English. </span><span class="kobospan" id="kobo.298.3">This preference is set by modifying the track selector’s parameters, indicating that if the media contains multiple audio tracks in different languages, the English one should be chosen, </span><span><span class="kobospan" id="kobo.299.1">if available.</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.300.1">After configuring the track selector, it’s used in the construction of the </span><strong class="source-inline"><span class="kobospan" id="kobo.301.1">ExoPlayer</span></strong><span class="kobospan" id="kobo.302.1"> instance. </span><span class="kobospan" id="kobo.302.2">Here, </span><strong class="source-inline"><span class="kobospan" id="kobo.303.1">ExoPlayer.Builder</span></strong><span class="kobospan" id="kobo.304.1"> is provided with the application context and the customized track selector when building the player. </span><span class="kobospan" id="kobo.304.2">This ensures that when the </span><strong class="source-inline"><span class="kobospan" id="kobo.305.1">ExoPlayer</span></strong><span class="kobospan" id="kobo.306.1"> instance prepares and plays media, it uses the logic defined in </span><strong class="source-inline"><span class="kobospan" id="kobo.307.1">DefaultTrackSelector</span></strong><span class="kobospan" id="kobo.308.1"> for track selection. </span><span class="kobospan" id="kobo.308.2">Essentially, this setup allows for more control over which audio track is selected during playback, based on the predefined criteria (in this case, the </span><span><span class="kobospan" id="kobo.309.1">language preference).</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.310.1">This approach </span><a id="_idIndexMarker933" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.311.1">to configuring ExoPlayer is particularly beneficial in </span><a id="_idIndexMarker934" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.312.1">applications that deal with media containing multiple tracks for different audience demographics or in scenarios where the application needs to adhere to user preferences or settings, such as a language selection option. </span><span class="kobospan" id="kobo.312.2">By customizing the track selector, developers can ensure that the media playback experience is optimized for the specific needs and preferences of their users, enhancing overall usability </span><span><span class="kobospan" id="kobo.313.1">and satisfaction.</span></span></p>
<h3 class="calibre9"><span class="kobospan" id="kobo.314.1">LoadControl – handling buffering and loading</span></h3>
<p class="calibre3"><span class="kobospan" id="kobo.315.1">The </span><strong class="source-inline"><span class="kobospan" id="kobo.316.1">LoadControl</span></strong><span class="kobospan" id="kobo.317.1"> component oversees the strategy for buffering and loading media resources. </span><span class="kobospan" id="kobo.317.2">Efficient buffering is essential for smooth playback, especially in streaming scenarios </span><a id="_idIndexMarker935" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.318.1">where network conditions can vary widely. </span><span class="kobospan" id="kobo.318.2">The </span><strong class="source-inline"><span class="kobospan" id="kobo.319.1">LoadControl</span></strong><span class="kobospan" id="kobo.320.1"> component determines how much media data to </span><a id="_idIndexMarker936" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.321.1">buffer at any given time, striking a balance between reducing initial loading times and minimizing the likelihood of playback interruptions. </span><span class="kobospan" id="kobo.321.2">We can customize the buffering policy to cater to specific requirements, such as prioritizing quick start times or ensuring </span><span><span class="kobospan" id="kobo.322.1">uninterrupted playback.</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.323.1">The following is an example of creating a custom </span><strong class="source-inline"><span class="kobospan" id="kobo.324.1">LoadControl</span></strong><span class="kobospan" id="kobo.325.1"> component to modify the </span><span><span class="kobospan" id="kobo.326.1">buffer policy:</span></span></p>
<pre class="source-code"><span class="kobospan1" id="kobo.327.1">
val loadControl = DefaultLoadControl.Builder().apply {
    // Set minimum buffer duration to 2 minutes
    setBufferDurationsMs(
        minBufferMs = 2 * 60 * 1000,
        maxBufferMs =
            DefaultLoadControl.DEFAULT_MAX_BUFFER_MS,
        bufferForPlaybackMs =
            DefaultLoadControl
            .DEFAULT_BUFFER_FOR_PLAYBACK_MS,
        bufferForPlaybackAfterRebufferMs =
            DefaultLoadControl
            .DEFAULT_BUFFER_FOR_PLAYBACK_AFTER_REBUFFER_MS
    )
}.build()
val player = ExoPlayer.Builder(context)
    .setLoadControl(loadControl)
    .build()
// Continue setting up the player as before</span></pre> <p class="calibre3"><span class="kobospan" id="kobo.328.1">The example </span><a id="_idIndexMarker937" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.329.1">begins by creating an instance of </span><strong class="source-inline"><span class="kobospan" id="kobo.330.1">DefaultLoadControl</span></strong><span class="kobospan" id="kobo.331.1"> using </span><strong class="source-inline"><span class="kobospan" id="kobo.332.1">Builder</span></strong><span class="kobospan" id="kobo.333.1">. </span><span class="kobospan" id="kobo.333.2">Here, </span><strong class="source-inline"><span class="kobospan" id="kobo.334.1">DefaultLoadControl</span></strong><span class="kobospan" id="kobo.335.1"> is an implementation </span><a id="_idIndexMarker938" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.336.1">of the </span><strong class="source-inline"><span class="kobospan" id="kobo.337.1">LoadControl</span></strong><span class="kobospan" id="kobo.338.1"> interface provided by ExoPlayer and is designed to manage media buffering based on various parameters that I will </span><span><span class="kobospan" id="kobo.339.1">explain now.</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.340.1">The </span><strong class="source-inline"><span class="kobospan" id="kobo.341.1">setBufferDurationsMs</span></strong><span class="kobospan" id="kobo.342.1"> method is called on the builder to specify custom buffer durations. </span><span class="kobospan" id="kobo.342.2">Specifically, it sets the minimum buffer duration (</span><strong class="source-inline"><span class="kobospan" id="kobo.343.1">minBufferMs</span></strong><span class="kobospan" id="kobo.344.1">) to 2 minutes (120,000 milliseconds). </span><span class="kobospan" id="kobo.344.2">This means that ExoPlayer will attempt to buffer at least 2 minutes of media before starting playback, which can help ensure smooth playback under varying </span><span><span class="kobospan" id="kobo.345.1">network conditions.</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.346.1">The other parameters (</span><strong class="source-inline"><span class="kobospan" id="kobo.347.1">maxBufferMs</span></strong><span class="kobospan" id="kobo.348.1">, </span><strong class="source-inline"><span class="kobospan" id="kobo.349.1">bufferForPlaybackMs</span></strong><span class="kobospan" id="kobo.350.1">, and </span><strong class="source-inline"><span class="kobospan" id="kobo.351.1">bufferForPlaybackAfterRebufferMs</span></strong><span class="kobospan" id="kobo.352.1">) are set to their default values, which are predefined in </span><strong class="source-inline"><span class="kobospan" id="kobo.353.1">DefaultLoadControl</span></strong><span class="kobospan" id="kobo.354.1">. </span><span class="kobospan" id="kobo.354.2">These parameters control the maximum buffer size, the minimum amount of media that must be buffered for playback to start, and the </span><a id="_idIndexMarker939" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.355.1">minimum amount of media that </span><a id="_idIndexMarker940" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.356.1">must be buffered to resume playback after a </span><span><span class="kobospan" id="kobo.357.1">rebuffer, respectively.</span></span></p>
<p class="callout-heading"><span class="kobospan" id="kobo.358.1">Note</span></p>
<p class="callout"><span class="kobospan" id="kobo.359.1">If you want to learn more about the aforementioned options, you can find all the details in the </span><a id="_idIndexMarker941" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.360.1">documentation for </span><span><strong class="source-inline1"><span class="kobospan" id="kobo.361.1">DefaultLoadControl.Builder</span></strong></span><span><span class="kobospan" id="kobo.362.1">: </span></span><a href="https://developer.android.com/reference/androidx/media3/exoplayer/DefaultLoadControl.Builder" class="calibre6 pcalibre1 pcalibre"><span><span class="kobospan" id="kobo.363.1">https://developer.android.com/reference/androidx/media3/exoplayer/DefaultLoadControl.Builder</span></span></a><span><span class="kobospan" id="kobo.364.1">.</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.365.1">After configuring the buffer durations, the </span><strong class="source-inline"><span class="kobospan" id="kobo.366.1">build()</span></strong><span class="kobospan" id="kobo.367.1"> method is called to create the </span><strong class="source-inline"><span class="kobospan" id="kobo.368.1">DefaultLoadControl</span></strong><span class="kobospan" id="kobo.369.1"> instance with the </span><span><span class="kobospan" id="kobo.370.1">specified settings.</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.371.1">This custom </span><strong class="source-inline"><span class="kobospan" id="kobo.372.1">LoadControl</span></strong><span class="kobospan" id="kobo.373.1"> component is then set on a new </span><strong class="source-inline"><span class="kobospan" id="kobo.374.1">ExoPlayer</span></strong><span class="kobospan" id="kobo.375.1"> instance through the </span><strong class="source-inline"><span class="kobospan" id="kobo.376.1">setLoadControl</span></strong><span class="kobospan" id="kobo.377.1"> method of </span><strong class="source-inline"><span class="kobospan" id="kobo.378.1">ExoPlayer.Builder</span></strong><span class="kobospan" id="kobo.379.1">. </span><span class="kobospan" id="kobo.379.2">This step integrates the custom buffering strategy with the player, meaning that the player will use the specified buffer durations </span><span><span class="kobospan" id="kobo.380.1">during playback.</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.381.1">Finally, the </span><strong class="source-inline"><span class="kobospan" id="kobo.382.1">build</span></strong><span class="kobospan" id="kobo.383.1"> method is called on </span><strong class="source-inline"><span class="kobospan" id="kobo.384.1">ExoPlayer.Builder</span></strong><span class="kobospan" id="kobo.385.1"> to create the </span><strong class="source-inline"><span class="kobospan" id="kobo.386.1">ExoPlayer</span></strong><span class="kobospan" id="kobo.387.1"> instance that was configured with the custom </span><span><strong class="source-inline"><span class="kobospan" id="kobo.388.1">LoadControl</span></strong></span><span><span class="kobospan" id="kobo.389.1"> component.</span></span></p>
<h3 class="calibre9"><span class="kobospan" id="kobo.390.1">Renderers – rendering media to outputs</span></h3>
<p class="calibre3"><span class="kobospan" id="kobo.391.1">Renderers are </span><a id="_idIndexMarker942" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.392.1">the components that output the media to </span><a id="_idIndexMarker943" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.393.1">the appropriate destination, such as rendering video frames to the screen or audio samples to speakers. </span><span class="kobospan" id="kobo.393.2">ExoPlayer uses separate renderers for different types of tracks, allowing for parallel processing and rendering of audio, video, and text tracks. </span><span class="kobospan" id="kobo.393.3">This separation enables ExoPlayer to support a wide range of media types and formats efficiently. </span><span class="kobospan" id="kobo.393.4">Moreover, developers can implement custom renderers to handle non-standard media types or apply special processing to media </span><span><span class="kobospan" id="kobo.394.1">before playback.</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.395.1">To illustrate </span><a id="_idIndexMarker944" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.396.1">this, consider the following example, where a </span><a id="_idIndexMarker945" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.397.1">custom renderer is being used to apply a grayscale filter to </span><span><span class="kobospan" id="kobo.398.1">video content:</span></span></p>
<pre class="source-code"><span class="kobospan1" id="kobo.399.1">
class GrayscaleVideoRenderer(
    eventHandler: Handler,
    videoListener: VideoRendererEventListener,
    maxDroppedFrameCountToNotify: Int
) : SimpleDecoderVideoRenderer(eventHandler, videoListener, maxDroppedFrameCountToNotify) {
    override fun onOutputFormatChanged(format: Format,
    outputMediaFormat: MediaFormat?) {
        super.onOutputFormatChanged(format,
            outputMediaFormat)
        // Setup to modify the color format to grayscale
    }
    override fun renderOutputBufferToSurface(buffer:
    OutputBuffer, surface: Surface,
    presentationTimeUs: Long) {
        // Apply grayscale effect to the buffer before
           rendering to the surface
    }
}</span></pre> <p class="calibre3"><span class="kobospan" id="kobo.400.1">The </span><strong class="source-inline"><span class="kobospan" id="kobo.401.1">GrayscaleVideoRenderer</span></strong><span class="kobospan" id="kobo.402.1"> class extends ExoPlayer’s </span><strong class="source-inline"><span class="kobospan" id="kobo.403.1">SimpleDecoderVideoRenderer</span></strong><span class="kobospan" id="kobo.404.1"> to apply a grayscale effect to video frames during playback. </span><span class="kobospan" id="kobo.404.2">This customization allows it to not just decode and display the video but also transform each frame to grayscale in real time, enhancing the visual presentation for stylistic choices </span><span><span class="kobospan" id="kobo.405.1">or accessibility.</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.406.1">When initializing, this renderer takes a </span><strong class="source-inline"><span class="kobospan" id="kobo.407.1">Handler</span></strong><span class="kobospan" id="kobo.408.1"> component for thread-safe event dispatching, a </span><strong class="source-inline"><span class="kobospan" id="kobo.409.1">VideoRendererEventListener</span></strong><span class="kobospan" id="kobo.410.1"> component for managing video events, and an </span><a id="_idIndexMarker946" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.411.1">integer that sets the threshold for notifying about dropped frames. </span><span class="kobospan" id="kobo.411.2">This </span><a id="_idIndexMarker947" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.412.1">setup helps keep the playback smooth </span><span><span class="kobospan" id="kobo.413.1">and responsive.</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.414.1">It overrides the </span><strong class="source-inline"><span class="kobospan" id="kobo.415.1">onOutputFormatChanged</span></strong><span class="kobospan" id="kobo.416.1"> method, where it prepares for video format changes. </span><span class="kobospan" id="kobo.416.2">This is where adjustments for grayscale processing would be set up. </span><span class="kobospan" id="kobo.416.3">The </span><strong class="source-inline"><span class="kobospan" id="kobo.417.1">renderOutputBufferToSurface</span></strong><span class="kobospan" id="kobo.418.1"> method is where the grayscale effect is applied to each video frame before they are rendered to </span><span><span class="kobospan" id="kobo.419.1">the screen.</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.420.1">Now that we are familiar with the most important components of ExoPlayer, let’s integrate it into </span><span><span class="kobospan" id="kobo.421.1">our project.</span></span></p>
<h2 id="_idParaDest-167" class="calibre7"><a id="_idTextAnchor168" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.422.1">Integrating ExoPlayer into our project</span></h2>
<p class="calibre3"><span class="kobospan" id="kobo.423.1">To integrate </span><a id="_idIndexMarker948" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.424.1">ExoPlayer, we have to include the necessary library dependencies in our </span><span><span class="kobospan" id="kobo.425.1">version catalog:</span></span></p>
<pre class="source-code"><span class="kobospan1" id="kobo.426.1">
[versions]
...
</span><span class="kobospan1" id="kobo.426.2">exoPlayer = "1.2.1"
[libraries]
...
</span><span class="kobospan1" id="kobo.426.3">exoPlayer-core = { module = "androidx.media3:media3-exoplayer", version.ref = "exoPlayer" }
exoPlayer-ui = { module = " androidx.media3:media3-ui", version.ref = "exoPlayer" }</span></pre> <p class="calibre3"><span class="kobospan" id="kobo.427.1">As with every dependency that we have included, we must add them to the </span><strong class="source-inline"><span class="kobospan" id="kobo.428.1">build.gradle</span></strong><span class="kobospan" id="kobo.429.1"> file of the module where we are going to use them. </span><span class="kobospan" id="kobo.429.2">In this case, we’ll add it them the </span><strong class="source-inline"><span class="kobospan" id="kobo.430.1">build.gradle</span></strong><span class="kobospan" id="kobo.431.1"> file </span><span><span class="kobospan" id="kobo.432.1">for </span></span><span><strong class="source-inline"><span class="kobospan" id="kobo.433.1">:feature:playback</span></strong></span><span><span class="kobospan" id="kobo.434.1">:</span></span></p>
<pre class="source-code"><span class="kobospan1" id="kobo.435.1">
dependencies {
    implementation(libs.exoPlayer.core)
    implementation(libs.exoPlayer.ui)
}</span></pre> <p class="calibre3"><span class="kobospan" id="kobo.436.1">With these </span><a id="_idIndexMarker949" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.437.1">two dependencies, we have all the components we need </span><a id="_idIndexMarker950" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.438.1">to </span><span><span class="kobospan" id="kobo.439.1">use ExoPlayer:</span></span></p>
<ul class="calibre15">
<li class="calibre14"><strong class="source-inline1"><span class="kobospan" id="kobo.440.1">androidx.media3:media3-exoplayer</span></strong><span class="kobospan" id="kobo.441.1">: This is the core module of ExoPlayer in the Media3 library. </span><span class="kobospan" id="kobo.441.2">It includes the essential classes and interfaces needed for media playback functionality. </span><span class="kobospan" id="kobo.441.3">This module provides the fundamental components for media playback, including the ExoPlayer interface, media source handling, and playback control logic. </span><span class="kobospan" id="kobo.441.4">It is the backbone of media playback in Media3, offering high-performance, low-level media </span><span><span class="kobospan" id="kobo.442.1">playback capabilities.</span></span></li>
<li class="calibre14"><strong class="source-inline1"><span class="kobospan" id="kobo.443.1">androidx.media3:media3-ui</span></strong><span class="kobospan" id="kobo.444.1">: This module provides user interface components for media playback in the Media3 library. </span><span class="kobospan" id="kobo.444.2">It includes pre-built UI components such as </span><strong class="source-inline1"><span class="kobospan" id="kobo.445.1">PlayerView</span></strong><span class="kobospan" id="kobo.446.1"> (a view that displays video content and playback controls) and other UI elements for controlling media playback. </span><span class="kobospan" id="kobo.446.2">These components can be customized or replaced with custom implementations if needed. </span><span class="kobospan" id="kobo.446.3">This module helps developers quickly integrate ExoPlayer with a functional UI for </span><span><span class="kobospan" id="kobo.447.1">media playback.</span></span></li>
</ul>
<p class="calibre3"><span class="kobospan" id="kobo.448.1">Now, we’re all set. </span><span class="kobospan" id="kobo.448.2">In the next section, we will build our playback UI and connect it </span><span><span class="kobospan" id="kobo.449.1">with ExoPlayer.</span></span></p>
<h1 id="_idParaDest-168" class="calibre5"><a id="_idTextAnchor169" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.450.1">Creating the video playback user interface</span></h1>
<p class="calibre3"><span class="kobospan" id="kobo.451.1">In this section, we’re going to build the video playback UI and focus on the essentials: a title bar, close, play/pause, forward and rewind buttons, a progress bar, and a time indicator. </span><span class="kobospan" id="kobo.451.2">We will </span><a id="_idIndexMarker951" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.452.1">start by creating the </span><strong class="source-inline"><span class="kobospan" id="kobo.453.1">PlaybackScreen</span></strong><span class="kobospan" id="kobo.454.1"> composable, the main composable for this new screen, after which we will add the additional components required to make </span><span><span class="kobospan" id="kobo.455.1">it function.</span></span></p>
<h2 id="_idParaDest-169" class="calibre7"><a id="_idTextAnchor170" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.456.1">Building PlaybackScreen and its composables</span></h2>
<p class="calibre3"><span class="kobospan" id="kobo.457.1">Let’s </span><a id="_idIndexMarker952" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.458.1">start building the </span><span><strong class="source-inline"><span class="kobospan" id="kobo.459.1">PlaybackScreen</span></strong></span><span><span class="kobospan" id="kobo.460.1"> composable:</span></span></p>
<pre class="source-code"><span class="kobospan1" id="kobo.461.1">
@Composable
fun PlaybackScreen() {
    Box(
        modifier = Modifier
            .fillMaxSize()
            .background(Color.Black)
    ) {
        TopMediaRow(Modifier.align(Alignment.TopCenter))
        PlayPauseButton(Modifier.align(Alignment.Center))
        ProgressBarWithTime(Modifier
            .align(Alignment.BottomCenter))
    }
}</span></pre> <p class="calibre3"><span class="kobospan" id="kobo.462.1">We start by declaring a </span><strong class="source-inline"><span class="kobospan" id="kobo.463.1">Box</span></strong><span class="kobospan" id="kobo.464.1"> container that fills the entire screen and sets its background to black, mimicking the dark mode typically preferred in video playback interfaces. </span><span class="kobospan" id="kobo.464.2">Within this </span><strong class="source-inline"><span class="kobospan" id="kobo.465.1">Box</span></strong><span class="kobospan" id="kobo.466.1">, we place three key components that constitute our playback UI: a top media row, a play/pause button, and a progress bar with a </span><span><span class="kobospan" id="kobo.467.1">time indicator.</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.468.1">Here, </span><strong class="source-inline"><span class="kobospan" id="kobo.469.1">TopMediaRow</span></strong><span class="kobospan" id="kobo.470.1"> is positioned at the top center of the screen, likely containing the title bar and close button. </span><span class="kobospan" id="kobo.470.2">Then, </span><strong class="source-inline"><span class="kobospan" id="kobo.471.1">PlayPauseButton</span></strong><span class="kobospan" id="kobo.472.1"> is placed right in the center of the screen, making it easy for users to start or pause playback with a simple tap. </span><span class="kobospan" id="kobo.472.2">Finally, </span><strong class="source-inline"><span class="kobospan" id="kobo.473.1">ProgressBarWithTime</span></strong><span class="kobospan" id="kobo.474.1"> is aligned at the bottom center, allowing users to see how much of the video has played and how much is left. </span><span class="kobospan" id="kobo.474.2">Each of these components is aligned within the </span><strong class="source-inline"><span class="kobospan" id="kobo.475.1">Box</span></strong><span class="kobospan" id="kobo.476.1"> container using the </span><strong class="source-inline"><span class="kobospan" id="kobo.477.1">Modifier.align</span></strong><span class="kobospan" id="kobo.478.1"> method, ensuring they are positioned exactly where we want them in </span><span><span class="kobospan" id="kobo.479.1">the UI.</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.480.1">Now that </span><a id="_idIndexMarker953" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.481.1">we have built the base of the screen, including every composable needed, it’s time to build them. </span><span class="kobospan" id="kobo.481.2">We will start with the </span><span><strong class="source-inline"><span class="kobospan" id="kobo.482.1">TopMediaRow</span></strong></span><span><span class="kobospan" id="kobo.483.1"> composable:</span></span></p>
<pre class="source-code"><span class="kobospan1" id="kobo.484.1">
@Composable
fun TopMediaRow(modifier: Modifier = Modifier) {
    Row(
        modifier = modifier.fillMaxWidth().padding(20.dp),
        horizontalArrangement = Arrangement.SpaceBetween,
        verticalAlignment = Alignment.CenterVertically
    ) {
        Text(text = "S1:E1 - Pilot", color = Color.White)
        Icon(imageVector = Icons.Default.Close,
            contentDescription = "Close",
                tint = Color.White)
    }
}</span></pre> <p class="calibre3"><span class="kobospan" id="kobo.485.1">In this </span><strong class="source-inline"><span class="kobospan" id="kobo.486.1">TopMediaRow</span></strong><span class="kobospan" id="kobo.487.1"> composable function, we’re designing the top part of our video playback UI, which is specifically tailored for displaying the episode information and a close button. </span><span class="kobospan" id="kobo.487.2">This function uses a </span><strong class="source-inline"><span class="kobospan" id="kobo.488.1">Row</span></strong><span class="kobospan" id="kobo.489.1"> layout to arrange its elements horizontally across the screen. </span><span class="kobospan" id="kobo.489.2">The modifier that’s applied to this </span><strong class="source-inline"><span class="kobospan" id="kobo.490.1">Row</span></strong><span class="kobospan" id="kobo.491.1"> layout ensures it stretches to fill the maximum </span><a id="_idIndexMarker954" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.492.1">width of its parent </span><a id="_idIndexMarker955" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.493.1">container and applies a padding of 20 </span><strong class="bold"><span class="kobospan" id="kobo.494.1">density-independent pixels</span></strong><span class="kobospan" id="kobo.495.1"> (</span><strong class="bold"><span class="kobospan" id="kobo.496.1">dp</span></strong><span class="kobospan" id="kobo.497.1">) around its edges for a neat, </span><span><span class="kobospan" id="kobo.498.1">uncluttered look.</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.499.1">Within the </span><strong class="source-inline"><span class="kobospan" id="kobo.500.1">Row</span></strong><span class="kobospan" id="kobo.501.1"> layout, we use two main components: </span><strong class="source-inline"><span class="kobospan" id="kobo.502.1">Text</span></strong> <span><span class="kobospan" id="kobo.503.1">and </span></span><span><strong class="source-inline"><span class="kobospan" id="kobo.504.1">Icon</span></strong></span><span><span class="kobospan" id="kobo.505.1">:</span></span></p>
<ul class="calibre15">
<li class="calibre14"><span class="kobospan" id="kobo.506.1">The </span><strong class="source-inline1"><span class="kobospan" id="kobo.507.1">Text</span></strong><span class="kobospan" id="kobo.508.1"> component displays the episode information, such as </span><strong class="bold"><span class="kobospan" id="kobo.509.1">S1:E1 ‘Pilot’</span></strong><span class="kobospan" id="kobo.510.1">, in white color, making it easily visible against the dark background typical of video </span><span><span class="kobospan" id="kobo.511.1">playback screens.</span></span></li>
<li class="calibre14"><span class="kobospan" id="kobo.512.1">The </span><strong class="source-inline1"><span class="kobospan" id="kobo.513.1">Icon</span></strong><span class="kobospan" id="kobo.514.1"> component uses the default “close” symbol with its tint also set to white to maintain consistency and visibility. </span><span class="kobospan" id="kobo.514.2">The </span><strong class="source-inline1"><span class="kobospan" id="kobo.515.1">horizontalArrangement</span></strong><span class="kobospan" id="kobo.516.1"> property is set to </span><strong class="source-inline1"><span class="kobospan" id="kobo.517.1">Arrangement.SpaceBetween</span></strong><span class="kobospan" id="kobo.518.1"> to ensure the text and icon are placed on opposite ends of the row, while </span><strong class="source-inline1"><span class="kobospan" id="kobo.519.1">verticalAlignment</span></strong><span class="kobospan" id="kobo.520.1"> keeps them centered vertically within </span><span><span class="kobospan" id="kobo.521.1">the row.</span></span></li>
</ul>
<p class="calibre3"><span class="kobospan" id="kobo.522.1">Now, let’s move to the next row, which contains the </span><span><strong class="source-inline"><span class="kobospan" id="kobo.523.1">PlayPauseButton</span></strong></span><span><span class="kobospan" id="kobo.524.1"> composable:</span></span></p>
<pre class="source-code"><span class="kobospan1" id="kobo.525.1">
@Composable
fun PlayPauseButton(modifier: Modifier = Modifier) {
    Row(
        horizontalArrangement = Arrangement.Center,
        verticalAlignment = Alignment.CenterVertically,
        modifier = modifier
    ) {
        IconButton(
            modifier = Modifier.padding(20.dp),
            onClick = { /* Rewind action */ })
        {
            Icon(
                modifier = Modifier
                    .height(80.dp)
                    .width(80.dp),
                imageVector = Icons.Default.ArrowBack,
                contentDescription = "Rewind 10s",
                tint = Color.White)
        }
        IconButton(
            modifier = Modifier
                .padding(20.dp),
            onClick = { /* Play/Pause action */ }
        ) {
            Icon(
            modifier = Modifier
                .height(80.dp)
                .width(80.dp),
            imageVector = Icons.Default.PlayArrow,
            contentDescription = "Play/Pause",
            tint = Color.White)
        }
        IconButton(
            modifier = Modifier
                .padding(20.dp),
            onClick = { /* Fast-forward action */ }) {
            Icon(
                modifier = Modifier
                    .height(80.dp)
                    .width(80.dp),
                imageVector = Icons.Default.ArrowForward,
                contentDescription = "Fast-forward 10s",
                tint = Color.White)
        }
    }
}</span></pre> <p class="calibre3"><span class="kobospan" id="kobo.526.1">The </span><strong class="source-inline"><span class="kobospan" id="kobo.527.1">PlayPauseButton</span></strong><span class="kobospan" id="kobo.528.1"> composable function will provide the central control mechanism for video playback and incorporate rewind, play/pause, and fast-forward actions </span><a id="_idIndexMarker956" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.529.1">within a single, intuitive interface. </span><span class="kobospan" id="kobo.529.2">This function employs a </span><strong class="source-inline"><span class="kobospan" id="kobo.530.1">Row</span></strong><span class="kobospan" id="kobo.531.1"> layout to horizontally align its child elements – the buttons for each control action – so that they’re centered both horizontally </span><span><span class="kobospan" id="kobo.532.1">and vertically.</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.533.1">Each button is created using the </span><strong class="source-inline"><span class="kobospan" id="kobo.534.1">IconButton</span></strong><span class="kobospan" id="kobo.535.1"> component. </span><span class="kobospan" id="kobo.535.2">These buttons are spaced out with a padding of 20 dp to ensure they’re comfortably tappable without the risk of accidental presses. </span><span class="kobospan" id="kobo.535.3">The icons for rewind, play/pause, and fast-forward are sized uniformly at 80 dp by 80 dp, making them large enough to be easily tapped and </span><span><span class="kobospan" id="kobo.536.1">visually recognized.</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.537.1">The </span><strong class="source-inline"><span class="kobospan" id="kobo.538.1">Icon</span></strong><span class="kobospan" id="kobo.539.1"> components within each </span><strong class="source-inline"><span class="kobospan" id="kobo.540.1">IconButton</span></strong><span class="kobospan" id="kobo.541.1"> are specifically chosen to visually represent their respective actions: an arrow pointing backward for rewind, a play arrow for play/pause, and an arrow pointing forward for fast-forward, each accompanied by a content description for accessibility purposes. </span><span class="kobospan" id="kobo.541.2">The placeholder comments within the </span><strong class="source-inline"><span class="kobospan" id="kobo.542.1">onClick</span></strong><span class="kobospan" id="kobo.543.1"> parameters indicate where the functionality for each button – rewinding the video by 10 seconds, toggling between playing and pausing, and fast-forwarding by 10 seconds – would </span><span><span class="kobospan" id="kobo.544.1">be implemented.</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.545.1">Finally, we </span><a id="_idIndexMarker957" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.546.1">have one last composable to build, the </span><span><strong class="source-inline"><span class="kobospan" id="kobo.547.1">ProgressBarWithTime</span></strong></span><span><span class="kobospan" id="kobo.548.1"> composable:</span></span></p>
<pre class="source-code"><span class="kobospan1" id="kobo.549.1">
@Composable
fun ProgressBarWithTime(modifier: Modifier = Modifier) {
    Row(
        modifier = modifier
            .fillMaxWidth()
            .wrapContentHeight()
            .padding(horizontal = 16.dp, vertical = 8.dp),
        horizontalArrangement = Arrangement.SpaceBetween,
        verticalAlignment = Alignment.CenterVertically
    ) {
            val progress = remember { mutableStateOf(0.3f)
                } // Dummy progress
            val formattedTime = "22:49" // Dummy time
            Row(
                modifier = Modifier.fillMaxWidth(),
                verticalAlignment =
                    Alignment.CenterVertically
            ) {
                Slider(
                    value = progress.value,
                    onValueChange =
                        { progress.value = it },
                    modifier = Modifier.weight(1f)
                )
                Spacer(modifier = Modifier.width(8.dp))
                Text(text = formattedTime,
                    color = Color.White)
            }
    }
}</span></pre> <p class="calibre3"><span class="kobospan" id="kobo.550.1">This </span><a id="_idIndexMarker958" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.551.1">composable is wrapped in a </span><strong class="source-inline"><span class="kobospan" id="kobo.552.1">Row</span></strong><span class="kobospan" id="kobo.553.1"> layout, which spans the maximum width available (to accommodate the length of the video) and adjusts its height to wrap the content closely, ensuring a tidy appearance with ample padding around its edges for a </span><span><span class="kobospan" id="kobo.554.1">balanced layout.</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.555.1">The core functionality centers around </span><span><span class="kobospan" id="kobo.556.1">two elements:</span></span></p>
<ul class="calibre15">
<li class="calibre14"><span class="kobospan" id="kobo.557.1">The </span><strong class="source-inline1"><span class="kobospan" id="kobo.558.1">Slider</span></strong><span class="kobospan" id="kobo.559.1"> component represents </span><a id="_idIndexMarker959" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.560.1">the video’s progress. </span><span class="kobospan" id="kobo.560.2">It uses a mutable state initialized at </span><strong class="source-inline1"><span class="kobospan" id="kobo.561.1">0.3</span></strong><span class="kobospan" id="kobo.562.1"> (30% progress) to simulate the current position of the video playback. </span><span class="kobospan" id="kobo.562.2">This state is interactively adjustable, allowing users to seek through the video. </span><span class="kobospan" id="kobo.562.3">The </span><strong class="source-inline1"><span class="kobospan" id="kobo.563.1">onValueChange</span></strong><span class="kobospan" id="kobo.564.1"> event updates the progress state, reflecting the user’s input. </span><span class="kobospan" id="kobo.564.2">To visually separate the progress bar from the time indicator and to ensure the layout remains intuitive, a spacer is inserted between these elements, maintaining a </span><span><span class="kobospan" id="kobo.565.1">clear distinction.</span></span></li>
<li class="calibre14"><span class="kobospan" id="kobo.566.1">Adjacent to the </span><strong class="source-inline1"><span class="kobospan" id="kobo.567.1">Slider</span></strong><span class="kobospan" id="kobo.568.1"> component, the </span><strong class="source-inline1"><span class="kobospan" id="kobo.569.1">Text</span></strong><span class="kobospan" id="kobo.570.1"> component displays the current playback </span><a id="_idIndexMarker960" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.571.1">time (set to </span><strong class="bold"><span class="kobospan" id="kobo.572.1">22:49</span></strong><span class="kobospan" id="kobo.573.1"> for now, until we integrate the playback functionality) in white color. </span><span class="kobospan" id="kobo.573.2">The time is displayed to provide users with exact information about how much of the video has been played or how much is left, enhancing the user experience by offering precise control over </span><span><span class="kobospan" id="kobo.574.1">video playback.</span></span></li>
</ul>
<p class="calibre3"><span class="kobospan" id="kobo.575.1">Although it may seem that our playback UI is complete, there is still one thing that we should take care of before integrating the playback feature itself. </span><span class="kobospan" id="kobo.575.2">When we are watching a video, we don’t want all those controls to be occupying the screen, making it difficult to watch the content. </span><span class="kobospan" id="kobo.575.3">The controls usually disappear automatically after the user hasn’t been interacting with the screen. </span><span class="kobospan" id="kobo.575.4">So, let’s implement </span><span><span class="kobospan" id="kobo.576.1">this change.</span></span></p>
<h2 id="_idParaDest-170" class="calibre7"><a id="_idTextAnchor171" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.577.1">Making the controls disappear when playing the content</span></h2>
<p class="calibre3"><span class="kobospan" id="kobo.578.1">We know our playback controls should disappear if they haven’t been used for a while. </span><span class="kobospan" id="kobo.578.2">The easiest </span><a id="_idIndexMarker961" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.579.1">way to do this is to have a value that will indicate if the controls should be visible or not, and we will modify its value to </span><strong class="source-inline"><span class="kobospan" id="kobo.580.1">false</span></strong><span class="kobospan" id="kobo.581.1"> when the screen has been idle for a time. </span><span class="kobospan" id="kobo.581.2">Let’s make these modifications in the </span><strong class="source-inline"><span class="kobospan" id="kobo.582.1">PlaybackScreen</span></strong><span class="kobospan" id="kobo.583.1"> composable, </span><span><span class="kobospan" id="kobo.584.1">as follows:</span></span></p>
<pre class="source-code"><span class="kobospan1" id="kobo.585.1">
@Composable
fun PlaybackScreen() {
    val isControlsVisible = remember { mutableStateOf(true) }
    val coroutineScope = rememberCoroutineScope()
    Box(
        modifier = Modifier
            .fillMaxSize()
            .background(Color.Black)
            .pointerInput(Unit) {
                detectTapGestures(
                    onPress = {
                        // Reset the visibility timer on
                           user interaction
                        isControlsVisible.value = true
                        coroutineScope.launch {
                            delay(15000) // 15 seconds
                                            delay
                            isControlsVisible.value = false
                        }
                    }
                )
            }
    ) {
        if (isControlsVisible.value) {
            TopMediaRow(Modifier.align(Alignment.TopCenter))
            PlayPauseButton(Modifier.align(
                Alignment.Center))
            ProgressBarWithTime(Modifier.align(
                Alignment.BottomCenter))
        }
    }
}</span></pre> <p class="calibre3"><span class="kobospan" id="kobo.586.1">The core idea of these modifications is to track user interaction and use a timer to determine when to hide the controls. </span><span class="kobospan" id="kobo.586.2">Initially, as mentioned previously, we’ll introduce a state to manage the visibility of the controls. </span><span class="kobospan" id="kobo.586.3">This state will likely be a Boolean that toggles between visible and invisible (</span><strong class="source-inline"><span class="kobospan" id="kobo.587.1">true</span></strong><span class="kobospan" id="kobo.588.1"> and </span><strong class="source-inline"><span class="kobospan" id="kobo.589.1">false</span></strong><span class="kobospan" id="kobo.590.1">) based on user interaction and the passage of time </span><span><span class="kobospan" id="kobo.591.1">without interaction.</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.592.1">For detecting user interactions, we could wrap the </span><strong class="source-inline"><span class="kobospan" id="kobo.593.1">Box</span></strong><span class="kobospan" id="kobo.594.1"> layout that contains our playback </span><a id="_idIndexMarker962" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.595.1">UI components in a </span><strong class="source-inline"><span class="kobospan" id="kobo.596.1">Modifier.pointerInput</span></strong><span class="kobospan" id="kobo.597.1"> Lambda. </span><span class="kobospan" id="kobo.597.2">Inside this Lambda, we can listen for touch input events, and each time a touch is detected, we can reset the timer – a coroutine launched with </span><strong class="source-inline"><span class="kobospan" id="kobo.598.1">LaunchedEffect</span></strong><span class="kobospan" id="kobo.599.1"> keyed to the visibility state might handle this. </span><span class="kobospan" id="kobo.599.2">This coroutine will wait for 15 seconds of inactivity (no touch events detected) before setting the controls’ visibility state to </span><strong class="source-inline"><span class="kobospan" id="kobo.600.1">false</span></strong><span class="kobospan" id="kobo.601.1">, effectively hiding them. </span><span class="kobospan" id="kobo.601.2">To ensure the controls reappear when the user interacts with the screen again, the same touch input detection mechanism will set the visibility state back to </span><strong class="source-inline"><span class="kobospan" id="kobo.602.1">true</span></strong><span class="kobospan" id="kobo.603.1">, and the coroutine will restart </span><span><span class="kobospan" id="kobo.604.1">its countdown.</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.605.1">Incorporating this functionality requires making modifications to the </span><strong class="source-inline"><span class="kobospan" id="kobo.606.1">PlaybackScreen</span></strong><span class="kobospan" id="kobo.607.1"> composable function so that it includes state handling for visibility and can modify the </span><strong class="source-inline"><span class="kobospan" id="kobo.608.1">TopMediaRow</span></strong><span class="kobospan" id="kobo.609.1">, </span><strong class="source-inline"><span class="kobospan" id="kobo.610.1">PlayPauseButton</span></strong><span class="kobospan" id="kobo.611.1">, and </span><strong class="source-inline"><span class="kobospan" id="kobo.612.1">ProgressBarWithTime</span></strong><span class="kobospan" id="kobo.613.1"> functions so that they accept and react to the visibility state. </span><span class="kobospan" id="kobo.613.2">This means each of these components will only be rendered when the state indicates they should </span><span><span class="kobospan" id="kobo.614.1">be visible.</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.615.1">Once we’ve finished, our playback UI should look </span><span><span class="kobospan" id="kobo.616.1">like this:</span></span></p>
<div class="calibre2">
<div class="img---figure" id="_idContainer064">
<span class="kobospan" id="kobo.617.1"><img alt="Figure 8.1: Finished playback UI (with controls shown)" src="image/B19443_08_01.jpg" class="calibre4"/></span>
</div>
</div>
<p class="img---caption" lang="en-US" xml:lang="en-US"><span class="kobospan" id="kobo.618.1">Figure 8.1: Finished playback UI (with controls shown)</span></p>
<p class="calibre3"><span class="kobospan" id="kobo.619.1">When the controls are hidden, it should just show the video content (this isn’t visible yet as it hasn’t </span><span><span class="kobospan" id="kobo.620.1">been implemented):</span></span></p>
<div class="calibre2">
<div class="img---figure" id="_idContainer065">
<span class="kobospan" id="kobo.621.1"><img alt="Figure 8.2: Finished playback UI (with controls hidden)" src="image/B19443_08_02.jpg" class="calibre4"/></span>
</div>
</div>
<p class="img---caption" lang="en-US" xml:lang="en-US"><span class="kobospan" id="kobo.622.1">Figure 8.2: Finished playback UI (with controls hidden)</span></p>
<p class="calibre3"><span class="kobospan" id="kobo.623.1">In this </span><a id="_idIndexMarker963" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.624.1">section, we created a UI to display the videos. </span><span class="kobospan" id="kobo.624.2">In the next section, we will integrate ExoPlayer so that our app can start </span><span><span class="kobospan" id="kobo.625.1">playing videos.</span></span></p>
<h1 id="_idParaDest-171" class="calibre5"><a id="_idTextAnchor172" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.626.1">Playing video using ExoPlayer</span></h1>
<p class="calibre3"><span class="kobospan" id="kobo.627.1">In this </span><a id="_idIndexMarker964" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.628.1">section, we’ll harness the full power of ExoPlayer </span><a id="_idIndexMarker965" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.629.1">so that we can integrate it into our newly created video playback UI. </span><span class="kobospan" id="kobo.629.2">Let’s learn how we can </span><span><span class="kobospan" id="kobo.630.1">do this.</span></span></p>
<h2 id="_idParaDest-172" class="calibre7"><a id="_idTextAnchor173" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.631.1">Creating PlaybackActivity</span></h2>
<p class="calibre3"><span class="kobospan" id="kobo.632.1">We’ll </span><a id="_idIndexMarker966" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.633.1">start by creating a new </span><strong class="source-inline"><span class="kobospan" id="kobo.634.1">Activity</span></strong><span class="kobospan" id="kobo.635.1"> for this </span><a id="_idIndexMarker967" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.636.1">functionality </span><span><span class="kobospan" id="kobo.637.1">called </span></span><span><strong class="source-inline"><span class="kobospan" id="kobo.638.1">PlaybackActivity</span></strong></span><span><span class="kobospan" id="kobo.639.1">:</span></span></p>
<pre class="source-code"><span class="kobospan1" id="kobo.640.1">
class PlaybackActivity: ComponentActivity() {
    override fun onCreate(savedInstanceState: Bundle?) {
        super.onCreate(savedInstanceState)
        setContent {
            PlaybackScreen()
        }
    }
}</span></pre> <p class="calibre3"><span class="kobospan" id="kobo.641.1">This </span><strong class="source-inline"><span class="kobospan" id="kobo.642.1">PlaybackActivity</span></strong><span class="kobospan" id="kobo.643.1"> activity will show our already created </span><strong class="source-inline"><span class="kobospan" id="kobo.644.1">PlaybackScreen()</span></strong><span class="kobospan" id="kobo.645.1"> in </span><span><span class="kobospan" id="kobo.646.1">its content.</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.647.1">We </span><a id="_idIndexMarker968" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.648.1">also want our playback UI to be always displayed </span><a id="_idIndexMarker969" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.649.1">in landscape mode. </span><span class="kobospan" id="kobo.649.2">To do so, we’ll configure this activity in the </span><strong class="source-inline"><span class="kobospan" id="kobo.650.1">AndroidManifest.xml</span></strong><span class="kobospan" id="kobo.651.1"> file, </span><span><span class="kobospan" id="kobo.652.1">as follows:</span></span></p>
<pre class="source-code"><span class="kobospan1" id="kobo.653.1">
&lt;?xml version="1.0" encoding="utf-8"?&gt;
&lt;manifest xmlns:android =
"http://schemas.android.com/apk/res/android"&gt;
    &lt;application&gt;
        &lt;activity android:name =
        "com.packt.playback.presentation.PlaybackActivity"
        android:screenOrientation="landscape"/&gt;
    &lt;/application&gt;
&lt;/manifest&gt;</span></pre> <p class="calibre3"><span class="kobospan" id="kobo.654.1">Here, we are declaring </span><strong class="source-inline"><span class="kobospan" id="kobo.655.1">PlaybackActivity</span></strong><span class="kobospan" id="kobo.656.1"> so that it has landscape as a forced screen orientation. </span><span class="kobospan" id="kobo.656.2">This will ensure it will only be rendered in landscape mode, despite what orientation the user is holding </span><span><span class="kobospan" id="kobo.657.1">their phone.</span></span></p>
<h2 id="_idParaDest-173" class="calibre7"><a id="_idTextAnchor174" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.658.1">Creating PlaybackViewModel</span></h2>
<p class="calibre3"><span class="kobospan" id="kobo.659.1">Now, we </span><a id="_idIndexMarker970" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.660.1">need to create the player, which is the </span><a id="_idIndexMarker971" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.661.1">component that’s responsible for managing the media playback. </span><span class="kobospan" id="kobo.661.2">We will create </span><strong class="source-inline"><span class="kobospan" id="kobo.662.1">PlaybackViewModel</span></strong><span class="kobospan" id="kobo.663.1"> to handle the ExoPlayer instance and all the logic needed for the view to interact with the video player and watch </span><span><span class="kobospan" id="kobo.664.1">the media.</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.665.1">To start, we </span><a id="_idIndexMarker972" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.666.1">are going to build the basic setup </span><a id="_idIndexMarker973" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.667.1">logic for our player </span><span><span class="kobospan" id="kobo.668.1">in </span></span><span><strong class="source-inline"><span class="kobospan" id="kobo.669.1">PlaybackViewModel</span></strong></span><span><span class="kobospan" id="kobo.670.1">:</span></span></p>
<pre class="source-code"><span class="kobospan1" id="kobo.671.1">
@HiltViewModel
class PlaybackViewModel @Inject constructor(): ViewModel()
{
    lateinit var player: ExoPlayer
    @OptIn(UnstableApi::class)
    private fun preparePlayerWithMediaSource(exoPlayer:
    ExoPlayer) {
        val mediaUrl = "https://example.com/media.mp4"
        val mediaSource = ProgressiveMediaSource.Factory(
            DefaultHttpDataSource.Factory())
            .createMediaSource(MediaItem.fromUri(mediaUrl))
        exoPlayer.setMediaSource(mediaSource)
        exoPlayer.prepare()
    }
    fun setupPlayer(context: Context) {
        player = ExoPlayer.Builder(context).build().also {
        exoPlayer -&gt;
            preparePlayerWithMediaSource(exoPlayer)
        }
    }
    override fun onCleared() {
        super.onCleared()
        player.release()
        progressUpdateJob?.cancel()
    }
}</span></pre> <p class="calibre3"><span class="kobospan" id="kobo.672.1">This is the </span><a id="_idIndexMarker974" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.673.1">start of our </span><strong class="source-inline"><span class="kobospan" id="kobo.674.1">PlaybackViewModel</span></strong><span class="kobospan" id="kobo.675.1"> composable, which is </span><a id="_idIndexMarker975" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.676.1">designed to manage the media playback functionality of an </span><span><span class="kobospan" id="kobo.677.1">Android app.</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.678.1">The core component of this </span><strong class="source-inline"><span class="kobospan" id="kobo.679.1">ViewModel</span></strong><span class="kobospan" id="kobo.680.1"> is the ExoPlayer instance, which is stored in a property named </span><strong class="source-inline"><span class="kobospan" id="kobo.681.1">player</span></strong><span class="kobospan" id="kobo.682.1">. </span><span class="kobospan" id="kobo.682.2">This </span><strong class="source-inline"><span class="kobospan" id="kobo.683.1">player</span></strong><span class="kobospan" id="kobo.684.1"> property is responsible for all media playback operations. </span><span class="kobospan" id="kobo.684.2">However, when </span><strong class="source-inline"><span class="kobospan" id="kobo.685.1">ViewModel</span></strong><span class="kobospan" id="kobo.686.1"> is first created, the player is not initialized; it’s declared with </span><strong class="source-inline"><span class="kobospan" id="kobo.687.1">lateinit</span></strong><span class="kobospan" id="kobo.688.1">, meaning it will be initialized later but before any other component needs to </span><span><span class="kobospan" id="kobo.689.1">access it.</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.690.1">The </span><strong class="source-inline"><span class="kobospan" id="kobo.691.1">setupPlayer</span></strong><span class="kobospan" id="kobo.692.1"> function is </span><a id="_idIndexMarker976" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.693.1">publicly exposed and intended to be called with a </span><strong class="source-inline"><span class="kobospan" id="kobo.694.1">Context</span></strong><span class="kobospan" id="kobo.695.1"> object, which provides access to application-specific resources and classes. </span><span class="kobospan" id="kobo.695.2">Inside this function, </span><strong class="source-inline"><span class="kobospan" id="kobo.696.1">ExoPlayer.Builder</span></strong><span class="kobospan" id="kobo.697.1"> is used to create an instance of </span><strong class="source-inline"><span class="kobospan" id="kobo.698.1">ExoPlayer</span></strong><span class="kobospan" id="kobo.699.1">. </span><span class="kobospan" id="kobo.699.2">This setup process involves calling the </span><strong class="source-inline"><span class="kobospan" id="kobo.700.1">build()</span></strong><span class="kobospan" id="kobo.701.1"> method on the builder, which returns a fully configured </span><strong class="source-inline"><span class="kobospan" id="kobo.702.1">ExoPlayer</span></strong><span class="kobospan" id="kobo.703.1"> instance. </span><span class="kobospan" id="kobo.703.2">Immediately after creating this instance, the </span><strong class="source-inline"><span class="kobospan" id="kobo.704.1">also</span></strong><span class="kobospan" id="kobo.705.1"> block executes, calling the </span><strong class="source-inline"><span class="kobospan" id="kobo.706.1">preparePlayerWithMediaSource</span></strong><span class="kobospan" id="kobo.707.1"> method with the newly </span><span><span class="kobospan" id="kobo.708.1">created player.</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.709.1">The </span><strong class="source-inline"><span class="kobospan" id="kobo.710.1">preparePlayerWithMediaSource</span></strong><span class="kobospan" id="kobo.711.1"> method is where the actual media source is set up. </span><span class="kobospan" id="kobo.711.2">It </span><a id="_idIndexMarker977" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.712.1">takes an </span><strong class="source-inline"><span class="kobospan" id="kobo.713.1">ExoPlayer</span></strong><span class="kobospan" id="kobo.714.1"> instance as an argument and configures it to play a specific media file. </span><span class="kobospan" id="kobo.714.2">The URL of the media file is defined as </span><a href="https://example.com/media.mp4" class="calibre6 pcalibre1 pcalibre"><span class="kobospan" id="kobo.715.1">https://example.com/media.mp4</span></a><span class="kobospan" id="kobo.716.1">. </span><span class="kobospan" id="kobo.716.2">To play this media, </span><strong class="source-inline"><span class="kobospan" id="kobo.717.1">ProgressiveMediaSource</span></strong><span class="kobospan" id="kobo.718.1"> is created, which is suitable for playing regular media files such as MP4s over HTTP. </span><span class="kobospan" id="kobo.718.2">This media source is then attached to the </span><strong class="source-inline"><span class="kobospan" id="kobo.719.1">ExoPlayer</span></strong><span class="kobospan" id="kobo.720.1"> instance </span><a id="_idIndexMarker978" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.721.1">using the </span><strong class="source-inline"><span class="kobospan" id="kobo.722.1">setMediaSource</span></strong><span class="kobospan" id="kobo.723.1"> method, and </span><strong class="source-inline"><span class="kobospan" id="kobo.724.1">prepare()</span></strong><span class="kobospan" id="kobo.725.1"> is called to prepare the player for playback. </span><span class="kobospan" id="kobo.725.2">It’s worth noting that this method is marked as private, meaning it’s intended to be used only within the </span><strong class="source-inline"><span class="kobospan" id="kobo.726.1">PlaybackViewModel</span></strong><span class="kobospan" id="kobo.727.1"> class. </span><span class="kobospan" id="kobo.727.2">The </span><strong class="source-inline"><span class="kobospan" id="kobo.728.1">@OptIn(UnstableApi::class)</span></strong><span class="kobospan" id="kobo.729.1"> annotation indicates that this method uses APIs that are not yet stable and may change in </span><span><span class="kobospan" id="kobo.730.1">the future.</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.731.1">Lastly, the </span><strong class="source-inline"><span class="kobospan" id="kobo.732.1">onCleared</span></strong><span class="kobospan" id="kobo.733.1"> method overrides a </span><strong class="source-inline"><span class="kobospan" id="kobo.734.1">ViewModel</span></strong><span class="kobospan" id="kobo.735.1"> life cycle callback that gets called when </span><strong class="source-inline"><span class="kobospan" id="kobo.736.1">ViewModel</span></strong><span class="kobospan" id="kobo.737.1"> is about to be destroyed. </span><span class="kobospan" id="kobo.737.2">This method releases the </span><strong class="source-inline"><span class="kobospan" id="kobo.738.1">ExoPlayer</span></strong><span class="kobospan" id="kobo.739.1"> instance by calling </span><strong class="source-inline"><span class="kobospan" id="kobo.740.1">player.release()</span></strong><span class="kobospan" id="kobo.741.1">, ensuring that resources are freed and preventing </span><span><span class="kobospan" id="kobo.742.1">memory leaks.</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.743.1">Now, we’ll add the view that will render the media content in </span><strong class="source-inline"><span class="kobospan" id="kobo.744.1">PlaybackScreen</span></strong><span class="kobospan" id="kobo.745.1"> and connect it to </span><span><span class="kobospan" id="kobo.746.1">the player:</span></span></p>
<pre class="source-code"><span class="kobospan1" id="kobo.747.1">
@Composable
fun PlaybackScreen() {
    val viewModel: PlaybackViewModel = hiltViewModel()
    val isControlsVisible = remember { mutableStateOf(true) }
    val coroutineScope = rememberCoroutineScope()
    viewModel.setupPlayer(LocalContext.current)
    Box(
        modifier = Modifier
            .fillMaxSize()
            .background(Color.Black)
            .pointerInput(Unit) {
                detectTapGestures(
                    onPress = {
                        isControlsVisible.value = true
                        coroutineScope.launch {
                            delay(15000) // 15 seconds
                                            delay
                            isControlsVisible.value = false
                        }
                    }
                )
            }
    ) {
        VideoPlayerComposable(
            modifier = Modifier.matchParentSize(),
            player = viewModel.player
        )
        if (isControlsVisible.value) {
            ...
</span><span class="kobospan1" id="kobo.747.2">        }
    }
}</span></pre> <p class="calibre3"><span class="kobospan" id="kobo.748.1">In the </span><strong class="source-inline"><span class="kobospan" id="kobo.749.1">PlaybackScreen</span></strong><span class="kobospan" id="kobo.750.1"> composable, we obtain an instance of </span><strong class="source-inline"><span class="kobospan" id="kobo.751.1">PlaybackViewModel</span></strong><span class="kobospan" id="kobo.752.1"> using </span><strong class="source-inline"><span class="kobospan" id="kobo.753.1">hiltViewModel()</span></strong><span class="kobospan" id="kobo.754.1">. </span><span class="kobospan" id="kobo.754.2">This </span><strong class="source-inline"><span class="kobospan" id="kobo.755.1">ViewModel</span></strong><span class="kobospan" id="kobo.756.1"> is central to managing the media playback life cycle and interactions within </span><span><span class="kobospan" id="kobo.757.1">the app.</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.758.1">Once </span><strong class="source-inline"><span class="kobospan" id="kobo.759.1">ViewModel</span></strong><span class="kobospan" id="kobo.760.1"> is ready, we call </span><strong class="source-inline"><span class="kobospan" id="kobo.761.1">viewModel.setupPlayer(LocalContext.current)</span></strong><span class="kobospan" id="kobo.762.1"> to initialize </span><strong class="source-inline"><span class="kobospan" id="kobo.763.1">ExoPlayer</span></strong><span class="kobospan" id="kobo.764.1">. </span><span class="kobospan" id="kobo.764.2">This setup is crucial because it prepares the player with the appropriate Android context, allowing it to load and play media files effectively. </span><span class="kobospan" id="kobo.764.3">Ensuring that ExoPlayer is initialized with the current context helps manage resources efficiently, which is essential for </span><span><span class="kobospan" id="kobo.765.1">smooth playback.</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.766.1">The UI </span><a id="_idIndexMarker979" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.767.1">component responsible for displaying the video is </span><strong class="source-inline"><span class="kobospan" id="kobo.768.1">VideoPlayerComposable</span></strong><span class="kobospan" id="kobo.769.1">. </span><span class="kobospan" id="kobo.769.2">We pass the initialized player from </span><strong class="source-inline"><span class="kobospan" id="kobo.770.1">ViewModel</span></strong><span class="kobospan" id="kobo.771.1"> to this composable, which is placed inside a </span><strong class="source-inline"><span class="kobospan" id="kobo.772.1">Box</span></strong><span class="kobospan" id="kobo.773.1"> layout. </span><span class="kobospan" id="kobo.773.2">This layout is configured to fill the maximum size of its parent and sets a black background to emphasize the video content. </span><span class="kobospan" id="kobo.773.3">The </span><strong class="source-inline"><span class="kobospan" id="kobo.774.1">Box</span></strong><span class="kobospan" id="kobo.775.1"> layout also handles user interactions, listening for tap gestures to toggle the visibility of playback controls. </span><span class="kobospan" id="kobo.775.2">When a tap is detected, it makes the controls visible and starts a coroutine that hides these controls again after 15 seconds if no further </span><span><span class="kobospan" id="kobo.776.1">interaction occurs.</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.777.1">Inside the </span><strong class="source-inline"><span class="kobospan" id="kobo.778.1">Box</span></strong><span class="kobospan" id="kobo.779.1"> layout, conditional logic checks the value of </span><strong class="source-inline"><span class="kobospan" id="kobo.780.1">isControlsVisible</span></strong><span class="kobospan" id="kobo.781.1">. </span><span class="kobospan" id="kobo.781.2">If </span><strong class="source-inline"><span class="kobospan" id="kobo.782.1">true</span></strong><span class="kobospan" id="kobo.783.1">, playback controls are rendered on top of the video. </span><span class="kobospan" id="kobo.783.2">This allows users to interact with the video, such as pausing, skipping, or adjusting the volume, but only when they choose to display </span><span><span class="kobospan" id="kobo.784.1">the controls.</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.785.1">Finally, we will explore how to implement </span><strong class="source-inline"><span class="kobospan" id="kobo.786.1">VideoPlayerComposable</span></strong><span class="kobospan" id="kobo.787.1"> so that we can effectively utilize the player to render the video while responding dynamically to user interactions with </span><span><span class="kobospan" id="kobo.788.1">playback controls.</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.789.1">Let’s see how we can implement this new composable. </span><span class="kobospan" id="kobo.789.2">Unfortunately, at the time of writing, the library doesn’t provide a Jetpack Compose option to show the player, so we need to create one inside an </span><strong class="source-inline"><span class="kobospan" id="kobo.790.1">AndroidView</span></strong><span class="kobospan" id="kobo.791.1"> composable, </span><span><span class="kobospan" id="kobo.792.1">as follows:</span></span></p>
<pre class="source-code"><span class="kobospan1" id="kobo.793.1">
@Composable
fun VideoPlayerComposable(
    modifier: Modifier = Modifier,
    player: ExoPlayer
) {
    AndroidView(
        factory = { ctx -&gt;
            PlayerView(ctx).apply {
                layoutParams = ViewGroup.LayoutParams(
                    MATCH_PARENT, MATCH_PARENT)
                setPlayer(player)
                useController = false
            }
        },
        modifier = modifier,
        update = { view -&gt;
            view.player = player
        }
    )
}</span></pre> <p class="calibre3"><span class="kobospan" id="kobo.794.1">The </span><strong class="source-inline"><span class="kobospan" id="kobo.795.1">VideoPlayerComposable</span></strong><span class="kobospan" id="kobo.796.1"> function takes </span><span><span class="kobospan" id="kobo.797.1">two parameters:</span></span></p>
<ul class="calibre15">
<li class="calibre14"><span class="kobospan" id="kobo.798.1">The </span><strong class="source-inline1"><span class="kobospan" id="kobo.799.1">Modifier</span></strong><span class="kobospan" id="kobo.800.1"> instance </span><a id="_idIndexMarker980" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.801.1">allows you to customize the layout or appearance of this composable when it’s used elsewhere in </span><span><span class="kobospan" id="kobo.802.1">your UI</span></span></li>
<li class="calibre14"><span class="kobospan" id="kobo.803.1">The </span><strong class="source-inline1"><span class="kobospan" id="kobo.804.1">ExoPlayer</span></strong><span class="kobospan" id="kobo.805.1"> instance </span><a id="_idIndexMarker981" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.806.1">is the media player that will handle the actual playback of the </span><span><span class="kobospan" id="kobo.807.1">video content</span></span></li>
</ul>
<p class="calibre3"><span class="kobospan" id="kobo.808.1">Inside the </span><strong class="source-inline"><span class="kobospan" id="kobo.809.1">AndroidView</span></strong><span class="kobospan" id="kobo.810.1"> composable, the factory Lambda is where the traditional Android view is created – in this case, </span><strong class="source-inline"><span class="kobospan" id="kobo.811.1">PlayerView</span></strong><span class="kobospan" id="kobo.812.1">. </span><span class="kobospan" id="kobo.812.2">Here, </span><strong class="source-inline"><span class="kobospan" id="kobo.813.1">PlayerView</span></strong><span class="kobospan" id="kobo.814.1"> is a view provided by the </span><strong class="source-inline"><span class="kobospan" id="kobo.815.1">ExoPlayer</span></strong><span class="kobospan" id="kobo.816.1"> library to display video content and playback controls. </span><span class="kobospan" id="kobo.816.2">Here, it’s initialized with the application </span><span><span class="kobospan" id="kobo.817.1">context (</span></span><span><strong class="source-inline"><span class="kobospan" id="kobo.818.1">ctx</span></strong></span><span><span class="kobospan" id="kobo.819.1">).</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.820.1">After </span><a id="_idIndexMarker982" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.821.1">creating </span><strong class="source-inline"><span class="kobospan" id="kobo.822.1">PlayerView</span></strong><span class="kobospan" id="kobo.823.1">, some properties are set </span><span><span class="kobospan" id="kobo.824.1">on it:</span></span></p>
<ul class="calibre15">
<li class="calibre14"><span class="kobospan" id="kobo.825.1">Here, </span><strong class="source-inline1"><span class="kobospan" id="kobo.826.1">layoutParams</span></strong><span class="kobospan" id="kobo.827.1"> is set to </span><strong class="source-inline1"><span class="kobospan" id="kobo.828.1">MATCH_PARENT</span></strong><span class="kobospan" id="kobo.829.1"> for both width and height, making </span><strong class="source-inline1"><span class="kobospan" id="kobo.830.1">PlayerView</span></strong><span class="kobospan" id="kobo.831.1"> fill the entire space allocated to it. </span><span class="kobospan" id="kobo.831.2">This ensures that the video will take up as much space as possible, typically the entire screen or the </span><span><span class="kobospan" id="kobo.832.1">parent container.</span></span></li>
<li class="calibre14"><span class="kobospan" id="kobo.833.1">Then, </span><strong class="source-inline1"><span class="kobospan" id="kobo.834.1">setPlayer(player)</span></strong><span class="kobospan" id="kobo.835.1"> attaches the passed </span><strong class="source-inline1"><span class="kobospan" id="kobo.836.1">ExoPlayer</span></strong><span class="kobospan" id="kobo.837.1"> instance to </span><strong class="source-inline1"><span class="kobospan" id="kobo.838.1">PlayerView</span></strong><span class="kobospan" id="kobo.839.1">. </span><span class="kobospan" id="kobo.839.2">This connection is what allows the video loaded in </span><strong class="source-inline1"><span class="kobospan" id="kobo.840.1">ExoPlayer</span></strong><span class="kobospan" id="kobo.841.1"> to be displayed in </span><span><span class="kobospan" id="kobo.842.1">this view.</span></span></li>
<li class="calibre14"><span class="kobospan" id="kobo.843.1">Finally, </span><strong class="source-inline1"><span class="kobospan" id="kobo.844.1">useController</span></strong><span class="kobospan" id="kobo.845.1"> is set to </span><strong class="source-inline1"><span class="kobospan" id="kobo.846.1">false</span></strong><span class="kobospan" id="kobo.847.1">, indicating that the default playback controls provided by </span><strong class="source-inline1"><span class="kobospan" id="kobo.848.1">PlayerView</span></strong><span class="kobospan" id="kobo.849.1"> (such as play, pause, and seek bar) will not be used. </span><span class="kobospan" id="kobo.849.2">We will implement our own </span><span><span class="kobospan" id="kobo.850.1">controls next.</span></span></li>
</ul>
<p class="calibre3"><span class="kobospan" id="kobo.851.1">Finally, the update Lambda of </span><strong class="source-inline"><span class="kobospan" id="kobo.852.1">AndroidView</span></strong><span class="kobospan" id="kobo.853.1"> is where you can update the properties of </span><strong class="source-inline"><span class="kobospan" id="kobo.854.1">PlayerView</span></strong><span class="kobospan" id="kobo.855.1"> based on changes to the composable’s state </span><span><span class="kobospan" id="kobo.856.1">or properties.</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.857.1">With these changes, our player is ready to start rendering the media via </span><strong class="source-inline"><span class="kobospan" id="kobo.858.1">ViewPlayer</span></strong><span class="kobospan" id="kobo.859.1">. </span><span class="kobospan" id="kobo.859.2">But we still have work to do. </span><span class="kobospan" id="kobo.859.3">We need to bind the already developed controls to the player controls and keep the time and the progress bar of the </span><span><span class="kobospan" id="kobo.860.1">video updated.</span></span></p>
<h2 id="_idParaDest-174" class="calibre7"><a id="_idTextAnchor175" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.861.1">Connecting the controls with ExoPlayer</span></h2>
<p class="calibre3"><span class="kobospan" id="kobo.862.1">Let’s start </span><a id="_idIndexMarker983" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.863.1">modifying the </span><strong class="source-inline"><span class="kobospan" id="kobo.864.1">PlayPauseButton</span></strong><span class="kobospan" id="kobo.865.1"> composable. </span><span class="kobospan" id="kobo.865.2">In this case, we will need to bind the control functions with </span><span><span class="kobospan" id="kobo.866.1">the ViewModel:</span></span></p>
<pre class="source-code"><span class="kobospan1" id="kobo.867.1">
@Composable
fun PlayPauseButton(
    isPlaying: Boolean,
    onRewind: () -&gt; Unit,
    onPlayPause: () -&gt; Unit,
    onFastForward: () -&gt; Unit,
    modifier: Modifier = Modifier,
    ) {
    Row(
        horizontalArrangement = Arrangement.Center,
        verticalAlignment = Alignment.CenterVertically,
        modifier = modifier
    ) {
        IconButton(
            onClick = onRewind,
            modifier = Modifier.padding(20.dp)
        ) {
            Icon(
                modifier = Modifier
                    .height(80.dp)
                    .width(80.dp),
                imageVector = Icons.Default.ArrowBack,
                contentDescription = "Rewind 10s",
                tint = Color.White
            )
        }
        IconButton(
            onClick = onPlayPause,
            modifier = Modifier.padding(20.dp)
        ) {
            Icon(
                modifier = Modifier
                    .height(80.dp)
                    .width(80.dp),
                imageVector = if (isPlaying)
                    Icons.Default.Close else
                    Icons.Default.PlayArrow,
                contentDescription = if (isPlaying) "Pause"
                    else "Play",
                tint = Color.White
            )
        }
        IconButton(
            onClick = onFastForward,
            modifier = Modifier.padding(20.dp)
        ) {
            Icon(
                modifier = Modifier
                    .height(80.dp)
                    .width(80.dp),
                imageVector = Icons.Default.ArrowForward,
                contentDescription = "Fast-forward 10s",
                tint = Color.White
            )
        }
    }
}</span></pre> <p class="calibre3"><span class="kobospan" id="kobo.868.1">Now, the </span><strong class="source-inline"><span class="kobospan" id="kobo.869.1">PlayPauseButton</span></strong><span class="kobospan" id="kobo.870.1"> composable </span><a id="_idIndexMarker984" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.871.1">takes several parameters, each serving a specific purpose within </span><a id="_idIndexMarker985" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.872.1">the </span><span><span class="kobospan" id="kobo.873.1">UI component:</span></span></p>
<ul class="calibre15">
<li class="calibre14"><strong class="source-inline1"><span class="kobospan" id="kobo.874.1">isPlaying</span></strong><span class="kobospan" id="kobo.875.1"> (Boolean): This parameter indicates the current playback state of the video. </span><span class="kobospan" id="kobo.875.2">It is used to determine which icon to display on the play/pause button – either a play icon when the video is paused or a pause icon when the video is actively playing. </span><span class="kobospan" id="kobo.875.3">This allows for intuitive control interactions from the </span><span><span class="kobospan" id="kobo.876.1">user’s perspective.</span></span></li>
<li class="calibre14"><strong class="source-inline1"><span class="kobospan" id="kobo.877.1">onRewind</span></strong><span class="kobospan" id="kobo.878.1"> (Lambda function): This is a callback function that’s triggered when the user presses the rewind button. </span><span class="kobospan" id="kobo.878.2">It should contain the logic for what happens when the video is rewound, such as moving the playback position backward by a </span><span><span class="kobospan" id="kobo.879.1">fixed amount.</span></span></li>
<li class="calibre14"><strong class="source-inline1"><span class="kobospan" id="kobo.880.1">onPlayPause</span></strong><span class="kobospan" id="kobo.881.1"> (Lambda function): This function is executed when the play/pause button is pressed. </span><span class="kobospan" id="kobo.881.2">It handles toggling between playing and pausing the video based on the current state, facilitating seamless user control over </span><span><span class="kobospan" id="kobo.882.1">video playback.</span></span></li>
<li class="calibre14"><strong class="source-inline1"><span class="kobospan" id="kobo.883.1">onFastForward</span></strong><span class="kobospan" id="kobo.884.1"> (Lambda function): Similar to </span><strong class="source-inline1"><span class="kobospan" id="kobo.885.1">onRewind</span></strong><span class="kobospan" id="kobo.886.1">, this callback is activated when the fast-forward button is pressed. </span><span class="kobospan" id="kobo.886.2">It controls the logic for fast-forwarding the video, advancing the playback position forward by a </span><span><span class="kobospan" id="kobo.887.1">predetermined interval.</span></span></li>
<li class="calibre14"><strong class="source-inline1"><span class="kobospan" id="kobo.888.1">modifier</span></strong><span class="kobospan" id="kobo.889.1"> (modifier): This parameter allows the appearance and layout of the button row </span><a id="_idIndexMarker986" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.890.1">within the composable to be customized. </span><span class="kobospan" id="kobo.890.2">As we’ve seen previously, wt can be used to apply padding, define alignment, and </span><span><span class="kobospan" id="kobo.891.1">set dimensions.</span></span></li>
</ul>
<p class="calibre3"><span class="kobospan" id="kobo.892.1">Now that </span><a id="_idIndexMarker987" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.893.1">we’ve added these new parameters, we need to pass them from the parent composable. </span><span class="kobospan" id="kobo.893.2">Here’s how you can include and invoke this composable with the </span><span><span class="kobospan" id="kobo.894.1">required parameters:</span></span></p>
<pre class="source-code"><span class="kobospan1" id="kobo.895.1">
val isPlaying = viewModel.isPlaying.collectAsState()
PlayPauseButton(
    isPlaying = isPlaying.value,
    onRewind = { viewModel.rewind() },
    onFastForward = {viewModel.fastForward() },
    onPlayPause = {viewModel.togglePlayPause() },
    modifier = Modifier.align(Alignment.Center)
)</span></pre> <p class="calibre3"><span class="kobospan" id="kobo.896.1">As we can see, we have bound every Lambda parameter to </span><strong class="source-inline"><span class="kobospan" id="kobo.897.1">ViewModel</span></strong><span class="kobospan" id="kobo.898.1"> functions (that are yet to be implemented) and we are providing an </span><strong class="source-inline"><span class="kobospan" id="kobo.899.1">isPlaying</span></strong><span class="kobospan" id="kobo.900.1"> state to reflect the current playing status of </span><span><span class="kobospan" id="kobo.901.1">the player.</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.902.1">Now, let’s implement those functions </span><span><span class="kobospan" id="kobo.903.1">in </span></span><span><strong class="source-inline"><span class="kobospan" id="kobo.904.1">ViewModel</span></strong></span><span><span class="kobospan" id="kobo.905.1">:</span></span></p>
<pre class="source-code"><span class="kobospan1" id="kobo.906.1">
private val _isPlaying = MutableStateFlow&lt;Boolean&gt;(false)
val isPlaying: MutableStateFlow&lt;Boolean&gt; = _isPlaying
fun setupPlayer(context: Context) {
    player = ExoPlayer.Builder(context).build().also {
    exoPlayer -&gt;
        preparePlayerWithMediaSource(exoPlayer)
        exoPlayer.addListener(object : Player.Listener {
            override fun onIsPlayingChanged(isPlaying:
            Boolean) {
                _isPlaying.value = isPlaying
            }
            override fun onPlaybackStateChanged(
            playbackState: Int) {
                super.onPlaybackStateChanged(playbackState)
            }
            override fun onPositionDiscontinuity(
            oldPosition: Player.PositionInfo, newPosition:
            Player.PositionInfo, reason: Int) {
                super.onPositionDiscontinuity(oldPosition,
                    newPosition, reason)
            }
            override fun onTimelineChanged(timeline:
            Timeline, reason: Int) {
                super.onTimelineChanged(timeline, reason)
            }
        })
    }
}
fun togglePlayPause() {
    if (player.isPlaying) {
        player.pause()
    } else {
        player.play()
    }
}
fun rewind() {
    val newPosition =
        (player.currentPosition - 10000).coerceAtLeast(0)
    player.seekTo(newPosition)
}
fun fastForward() {
    val newPosition =
        (player.currentPosition + 10000)
            .coerceAtMost(player.duration)
    player.seekTo(newPosition)
}</span></pre> <p class="calibre3"><span class="kobospan" id="kobo.907.1">First, we have defined a private mutable state flow, </span><strong class="source-inline"><span class="kobospan" id="kobo.908.1">_isPlaying</span></strong><span class="kobospan" id="kobo.909.1">, to track whether the video is currently playing. </span><span class="kobospan" id="kobo.909.2">This same state flow is exposed as a public </span><strong class="source-inline"><span class="kobospan" id="kobo.910.1">MutableStateFlow</span></strong><span class="kobospan" id="kobo.911.1"> component named </span><strong class="source-inline"><span class="kobospan" id="kobo.912.1">isPlaying</span></strong><span class="kobospan" id="kobo.913.1">. </span><span class="kobospan" id="kobo.913.2">In this case, </span><strong class="source-inline"><span class="kobospan" id="kobo.914.1">isPlaying</span></strong><span class="kobospan" id="kobo.915.1"> acts as a single source of truth for the playback state, allowing our UI components to update reactively </span><a id="_idIndexMarker988" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.916.1">based on whether the video is playing </span><span><span class="kobospan" id="kobo.917.1">or paused.</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.918.1">The </span><strong class="source-inline"><span class="kobospan" id="kobo.919.1">setupPlayer</span></strong><span class="kobospan" id="kobo.920.1"> function, which </span><a id="_idIndexMarker989" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.921.1">we’ve already implemented, initializes the </span><strong class="source-inline"><span class="kobospan" id="kobo.922.1">ExoPlayer</span></strong><span class="kobospan" id="kobo.923.1"> instance. </span><span class="kobospan" id="kobo.923.2">Now, it also attaches a listener to respond to playback events. </span><span class="kobospan" id="kobo.923.3">The listener added overrides several methods, but most importantly, </span><strong class="source-inline"><span class="kobospan" id="kobo.924.1">onIsPlayingChanged</span></strong><span class="kobospan" id="kobo.925.1"> is used to update </span><strong class="source-inline"><span class="kobospan" id="kobo.926.1">_isPlaying.value</span></strong><span class="kobospan" id="kobo.927.1"> based on the </span><span><span class="kobospan" id="kobo.928.1">player’s state.</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.929.1">We’ve also included the functions to manipulate playback that we were already being called from </span><span><span class="kobospan" id="kobo.930.1">the composable:</span></span></p>
<ul class="calibre15">
<li class="calibre14"><strong class="source-inline1"><span class="kobospan" id="kobo.931.1">togglePlayPause</span></strong><span class="kobospan" id="kobo.932.1">: This checks if the player is currently playing and toggles between play and pause. </span><span class="kobospan" id="kobo.932.2">This method directly controls the player’s state, making it the primary way the user interacts with </span><span><span class="kobospan" id="kobo.933.1">the playback.</span></span></li>
<li class="calibre14"><strong class="source-inline1"><span class="kobospan" id="kobo.934.1">rewind</span></strong><span class="kobospan" id="kobo.935.1"> and </span><strong class="source-inline1"><span class="kobospan" id="kobo.936.1">fastForward</span></strong><span class="kobospan" id="kobo.937.1">: These options calculate a new position based on the current playback position and seek to that position. </span><span class="kobospan" id="kobo.937.2">The </span><strong class="source-inline1"><span class="kobospan" id="kobo.938.1">rewind</span></strong><span class="kobospan" id="kobo.939.1"> function moves the playback position backward by 10 seconds, while </span><strong class="source-inline1"><span class="kobospan" id="kobo.940.1">fastForward</span></strong><span class="kobospan" id="kobo.941.1"> moves it forward by 10 seconds. </span><span class="kobospan" id="kobo.941.2">These methods enhance user control over the video, allowing for quick navigation within </span><span><span class="kobospan" id="kobo.942.1">the content.</span></span></li>
</ul>
<p class="calibre3"><span class="kobospan" id="kobo.943.1">Now, let’s connect the next (and last) </span><span><span class="kobospan" id="kobo.944.1">composable, </span></span><span><strong class="source-inline"><span class="kobospan" id="kobo.945.1">ProgressBarWithTime</span></strong></span><span><span class="kobospan" id="kobo.946.1">:</span></span></p>
<pre class="source-code"><span class="kobospan1" id="kobo.947.1">
@Composable
fun ProgressBarWithTime(
    currentPosition: Long,
    duration: Long,
    onSeek: (Long) -&gt; Unit,
    modifier: Modifier = Modifier,
) {
    val progress =
        if (duration &gt; 0) currentPosition.toFloat() /
            duration else 0f
    val formattedTime =
        "${formatTime(currentPosition)} /
            ${formatTime(duration)}"
    Row(
        modifier = modifier
            .fillMaxWidth()
            .wrapContentHeight()
            .padding(horizontal = 16.dp, vertical = 8.dp),
        horizontalArrangement = Arrangement.SpaceBetween,
        verticalAlignment = Alignment.CenterVertically
    ) {
        Slider(
            value = progress,
            onValueChange = { newValue -&gt;
                val newPosition =
                    (newValue * duration).toLong()
                onSeek(newPosition)
            },
            modifier = Modifier.weight(1f),
            valueRange = 0f..1f
        )
        Spacer(modifier = Modifier.width(8.dp))
        Text(text = formattedTime, color = Color.White)
    }
}</span></pre> <p class="calibre3"><span class="kobospan" id="kobo.948.1">The function now </span><a id="_idIndexMarker990" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.949.1">accepts three new parameters: </span><strong class="source-inline"><span class="kobospan" id="kobo.950.1">currentPosition</span></strong><span class="kobospan" id="kobo.951.1"> and </span><strong class="source-inline"><span class="kobospan" id="kobo.952.1">duration</span></strong><span class="kobospan" id="kobo.953.1"> to represent the current playback position and the total length of the video in milliseconds, respectively, and an </span><strong class="source-inline"><span class="kobospan" id="kobo.954.1">onSeek</span></strong><span class="kobospan" id="kobo.955.1"> Lambda function that defines what to do when the user seeks to a </span><span><span class="kobospan" id="kobo.956.1">new position.</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.957.1">The </span><strong class="source-inline"><span class="kobospan" id="kobo.958.1">progress</span></strong><span class="kobospan" id="kobo.959.1"> variable calculates how far along the video is, represented as a float between 0 and 1. </span><span class="kobospan" id="kobo.959.2">This is achieved by dividing </span><strong class="source-inline"><span class="kobospan" id="kobo.960.1">currentPosition</span></strong><span class="kobospan" id="kobo.961.1"> by </span><strong class="source-inline"><span class="kobospan" id="kobo.962.1">duration</span></strong><span class="kobospan" id="kobo.963.1">, which specifies a proportion of the video that has been played. </span><span class="kobospan" id="kobo.963.2">If the duration is 0 (to avoid division by zero), progress is set to </span><strong class="source-inline"><span class="kobospan" id="kobo.964.1">0f</span></strong><span class="kobospan" id="kobo.965.1">, indicating </span><span><span class="kobospan" id="kobo.966.1">no progress.</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.967.1">The </span><strong class="source-inline"><span class="kobospan" id="kobo.968.1">formattedTime</span></strong><span class="kobospan" id="kobo.969.1"> string provides a user-friendly display of the current position and total duration of the video by using a custom formatting function, </span><strong class="source-inline"><span class="kobospan" id="kobo.970.1">formatTime()</span></strong><span class="kobospan" id="kobo.971.1">  (as we’ll see next), to convert milliseconds into a more readable </span><span><span class="kobospan" id="kobo.972.1">format (HH:MM:SS).</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.973.1">Finally, slider progress is now bound to the progress value, and its </span><strong class="source-inline"><span class="kobospan" id="kobo.974.1">onValueChange</span></strong><span class="kobospan" id="kobo.975.1"> event is wired to call </span><strong class="source-inline"><span class="kobospan" id="kobo.976.1">onSeek</span></strong><span class="kobospan" id="kobo.977.1"> with the new position when the user interacts with it. </span><span class="kobospan" id="kobo.977.2">This allows the user to seek through the video by moving the slider, with the </span><strong class="source-inline"><span class="kobospan" id="kobo.978.1">onSeek</span></strong><span class="kobospan" id="kobo.979.1"> function updating the video playback </span><span><span class="kobospan" id="kobo.980.1">position accordingly.</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.981.1">Regarding the aforementioned </span><strong class="source-inline"><span class="kobospan" id="kobo.982.1">formatTime</span></strong><span class="kobospan" id="kobo.983.1"> function, it will work </span><span><span class="kobospan" id="kobo.984.1">as follows:</span></span></p>
<pre class="source-code"><span class="kobospan1" id="kobo.985.1">
fun formatTime(millis: Long): String {
    val totalSeconds = millis / 1000
    val hours = totalSeconds / 3600
    val minutes = (totalSeconds % 3600) / 60
    val seconds = totalSeconds % 60
    return if (hours &gt; 0) {
        String.format("%02d:%02d:%02d", hours, minutes,
            seconds)
    } else {
        String.format("%02d:%02d", minutes, seconds)
    }
}</span></pre> <p class="calibre3"><span class="kobospan" id="kobo.986.1">The input to </span><a id="_idIndexMarker991" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.987.1">the function is </span><strong class="source-inline"><span class="kobospan" id="kobo.988.1">millis</span></strong><span class="kobospan" id="kobo.989.1">, which represents the time duration in milliseconds. </span><span class="kobospan" id="kobo.989.2">This is a common way to represent time in programming because it’s precise. </span><span class="kobospan" id="kobo.989.3">However, milliseconds aren’t very human-friendly, so the first step inside the function is to convert milliseconds into total seconds by dividing by </span><strong class="source-inline"><span class="kobospan" id="kobo.990.1">1000</span></strong><span class="kobospan" id="kobo.991.1">. </span><span class="kobospan" id="kobo.991.2">We’re doing this because there are 1,000 milliseconds in </span><span><span class="kobospan" id="kobo.992.1">a second.</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.993.1">Once you have the total seconds, the function calculates hours, minutes, and seconds. </span><span class="kobospan" id="kobo.993.2">It divides the total seconds by </span><strong class="source-inline"><span class="kobospan" id="kobo.994.1">3600</span></strong><span class="kobospan" id="kobo.995.1"> (the number of seconds in an hour) to get hours. </span><span class="kobospan" id="kobo.995.2">The remainder from that division (using the modulo operator, </span><strong class="source-inline"><span class="kobospan" id="kobo.996.1">%</span></strong><span class="kobospan" id="kobo.997.1">) is then used to calculate minutes by dividing by </span><strong class="source-inline"><span class="kobospan" id="kobo.998.1">60</span></strong><span class="kobospan" id="kobo.999.1"> (since there are 60 seconds in a minute). </span><span class="kobospan" id="kobo.999.2">Finally, the remainder from the minutes calculation gives you </span><span><span class="kobospan" id="kobo.1000.1">the seconds.</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.1001.1">The last part is where the function formats the time string. </span><span class="kobospan" id="kobo.1001.2">If the duration includes hours (that is, if the duration is longer than 60 minutes), it formats the time as HH:MM:SS using </span><strong class="source-inline"><span class="kobospan" id="kobo.1002.1">String.format()</span></strong><span class="kobospan" id="kobo.1003.1">. </span><span class="kobospan" id="kobo.1003.2">This method is used to create a formatted string with placeholders (</span><strong class="source-inline"><span class="kobospan" id="kobo.1004.1">%02d</span></strong><span class="kobospan" id="kobo.1005.1">) for hours, minutes, and seconds. </span><span class="kobospan" id="kobo.1005.2">Here’s a breakdown of </span><span><span class="kobospan" id="kobo.1006.1">the format:</span></span></p>
<ul class="calibre15">
<li class="calibre14"><span class="kobospan" id="kobo.1007.1">The </span><strong class="source-inline1"><span class="kobospan" id="kobo.1008.1">%</span></strong><span class="kobospan" id="kobo.1009.1"> symbol indicates the start of a </span><span><span class="kobospan" id="kobo.1010.1">format specifier.</span></span></li>
<li class="calibre14"><span class="kobospan" id="kobo.1011.1">The </span><strong class="source-inline1"><span class="kobospan" id="kobo.1012.1">0</span></strong><span class="kobospan" id="kobo.1013.1"> specifies that the number should be padded with leading zeros if it has fewer digits </span><span><span class="kobospan" id="kobo.1014.1">than specified.</span></span></li>
<li class="calibre14"><span class="kobospan" id="kobo.1015.1">The </span><strong class="source-inline1"><span class="kobospan" id="kobo.1016.1">2</span></strong><span class="kobospan" id="kobo.1017.1"> indicates that the number should be at least two </span><span><span class="kobospan" id="kobo.1018.1">digits long.</span></span></li>
<li class="calibre14"><span class="kobospan" id="kobo.1019.1">The </span><strong class="source-inline1"><span class="kobospan" id="kobo.1020.1">d</span></strong><span class="kobospan" id="kobo.1021.1"> stands for ‘decimal’ and specifies that the placeholder is for an </span><span><span class="kobospan" id="kobo.1022.1">integer number.</span></span></li>
</ul>
<p class="calibre3"><span class="kobospan" id="kobo.1023.1">So, </span><strong class="source-inline"><span class="kobospan" id="kobo.1024.1">%02d</span></strong><span class="kobospan" id="kobo.1025.1"> ensures that the number is at least two digits long and padded with zeros </span><span><span class="kobospan" id="kobo.1026.1">if necessary.</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.1027.1">Going back </span><a id="_idIndexMarker992" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.1028.1">to th</span><a id="_idTextAnchor176" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.1029.1">e composable, we also need to modify where </span><strong class="source-inline"><span class="kobospan" id="kobo.1030.1">ProgressBarWithTime</span></strong><span class="kobospan" id="kobo.1031.1"> is called </span><span><span class="kobospan" id="kobo.1032.1">in </span></span><span><strong class="source-inline"><span class="kobospan" id="kobo.1033.1">PlaybackScreen</span></strong></span><span><span class="kobospan" id="kobo.1034.1">:</span></span></p>
<pre class="source-code"><span class="kobospan1" id="kobo.1035.1">
val currentPosition =
    viewModel.currentPosition.collectAsState()
val duration = viewModel.duration.collectAsState()
ProgressBarWithTime(
    currentPosition = currentPosition.value,
    duration = duration.value,
    onSeek = { newPosition -&gt;
        viewModel.seekTo(newPosition)
    },
    modifier = Modifier.align(Alignment.BottomCenter)
)</span></pre> <p class="calibre3"><span class="kobospan" id="kobo.1036.1">As we can see, we have bound the </span><strong class="source-inline"><span class="kobospan" id="kobo.1037.1">seekTo</span></strong><span class="kobospan" id="kobo.1038.1"> Lambda parameter to a </span><strong class="source-inline"><span class="kobospan" id="kobo.1039.1">ViewModel</span></strong><span class="kobospan" id="kobo.1040.1"> function (that is yet to be implemented) and we are also providing </span><strong class="source-inline"><span class="kobospan" id="kobo.1041.1">duration</span></strong><span class="kobospan" id="kobo.1042.1"> and </span><span><strong class="source-inline"><span class="kobospan" id="kobo.1043.1">currentPosition</span></strong></span><span><span class="kobospan" id="kobo.1044.1"> states.</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.1045.1">Now, let’s modify </span><strong class="source-inline"><span class="kobospan" id="kobo.1046.1">PlaybackViewModel</span></strong><span class="kobospan" id="kobo.1047.1"> so that we can implement the pending functions related to the </span><span><span class="kobospan" id="kobo.1048.1">progress bar.</span></span></p>
<h2 id="_idParaDest-175" class="calibre7"><a id="_idTextAnchor177" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.1049.1">Implementing the video controls in PlaybackViewModel</span></h2>
<p class="calibre3"><span class="kobospan" id="kobo.1050.1">The </span><a id="_idIndexMarker993" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.1051.1">last step to make the progress bar work is to modify </span><strong class="source-inline"><span class="kobospan" id="kobo.1052.1">PlaybackViewModel</span></strong><span class="kobospan" id="kobo.1053.1">. </span><span class="kobospan" id="kobo.1053.2">We can add the necessary functionality to control the progress bar </span><span><span class="kobospan" id="kobo.1054.1">like so:</span></span></p>
<pre class="source-code"><span class="kobospan1" id="kobo.1055.1">
private val _currentPosition = MutableStateFlow&lt;Long&gt;(0L)
val currentPosition: StateFlow&lt;Long&gt; = _currentPosition
private val _duration = MutableStateFlow&lt;Long&gt;(0L)
val duration: MutableStateFlow&lt;Long&gt; = _duration
private var progressUpdateJob: Job? </span><span class="kobospan1" id="kobo.1055.2">= null
fun setupPlayer(context: Context) {
    player = ExoPlayer.Builder(context).build().also {
    exoPlayer -&gt;
        preparePlayerWithMediaSource(exoPlayer)
        exoPlayer.addListener(object : Player.Listener {
            override fun onIsPlayingChanged(isPlaying:
            Boolean) {
                _isPlaying.value = isPlaying
                if (isPlaying) {
                    startPeriodicProgressUpdate()
                } else {
                    progressUpdateJob?.cancel()
                }
            }
            override fun onPlaybackStateChanged
            (playbackState: Int) {
                super.onPlaybackStateChanged(playbackState)
                if (playbackState == Player.STATE_READY ||
                playbackState == Player.STATE_BUFFERING) {
                    _duration.value = exoPlayer.duration
                }
            }
            override fun onPositionDiscontinuity(
            oldPosition: Player.PositionInfo, newPosition:
            Player.PositionInfo, reason: Int) {
                super.onPositionDiscontinuity(oldPosition,
                    newPosition, reason)
                _currentPosition.value =
                    newPosition.positionMs
            }
            override fun onTimelineChanged(timeline:
            Timeline, reason: Int) {
                super.onTimelineChanged(timeline, reason)
                if (!timeline.isEmpty) {
                    _duration.value = exoPlayer.duration
                }
            }
        })
    }
}
private fun startPeriodicProgressUpdate() {
    progressUpdateJob?.cancel()
    progressUpdateJob = viewModelScope.launch {
        while (coroutineContext.isActive) {
            val currentPosition = player.currentPosition
            _currentPosition.value = currentPosition
            delay(1000)
        }
    }
}
fun seekTo(position: Long) {
    if (::player.isInitialized &amp;&amp; position &gt;= 0 &amp;&amp;
    position &lt;= player.duration) {
        player.seekTo(position)
    }
}
override fun onCleared() {
    super.onCleared()
    player.release()
    progressUpdateJob?.cancel()
}</span></pre> <p class="calibre3"><span class="kobospan" id="kobo.1056.1">With that, we’ve declared private mutable state flows called </span><strong class="source-inline"><span class="kobospan" id="kobo.1057.1">_currentPosition</span></strong><span class="kobospan" id="kobo.1058.1"> and </span><strong class="source-inline"><span class="kobospan" id="kobo.1059.1">_duration</span></strong><span class="kobospan" id="kobo.1060.1"> for tracking the current playback position and the total video duration, respectively. </span><span class="kobospan" id="kobo.1060.2">These are exposed as read-only StateFlows to the rest of the app, ensuring </span><a id="_idIndexMarker994" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.1061.1">that the UI components can observe these values and react to changes, but cannot modify </span><span><span class="kobospan" id="kobo.1062.1">them directly.</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.1063.1">The listener in the </span><strong class="source-inline"><span class="kobospan" id="kobo.1064.1">setupPlayer</span></strong><span class="kobospan" id="kobo.1065.1"> function has also been modified to include functionality to keep the two states, </span><strong class="source-inline"><span class="kobospan" id="kobo.1066.1">_currentPosition</span></strong><span class="kobospan" id="kobo.1067.1"> and </span><strong class="source-inline"><span class="kobospan" id="kobo.1068.1">_duration</span></strong><span class="kobospan" id="kobo.1069.1">. </span><span class="kobospan" id="kobo.1069.2">The following modifications have been made to the </span><span><span class="kobospan" id="kobo.1070.1">listener callbacks:</span></span></p>
<ul class="calibre15">
<li class="calibre14"><strong class="source-inline1"><span class="kobospan" id="kobo.1071.1">onIsPlayingChanged</span></strong><span class="kobospan" id="kobo.1072.1">: This updates the </span><strong class="source-inline1"><span class="kobospan" id="kobo.1073.1">_isPlaying</span></strong><span class="kobospan" id="kobo.1074.1"> state and controls the start and stop of a job, which periodically updates the current playback position. </span><span class="kobospan" id="kobo.1074.2">This is essential for keeping the UI in sync with the </span><span><span class="kobospan" id="kobo.1075.1">actual playback.</span></span></li>
<li class="calibre14"><strong class="source-inline1"><span class="kobospan" id="kobo.1076.1">onPlaybackStateChanged</span></strong><span class="kobospan" id="kobo.1077.1">: This checks if the player is ready or buffering and updates the </span><strong class="source-inline1"><span class="kobospan" id="kobo.1078.1">_duration</span></strong><span class="kobospan" id="kobo.1079.1"> state with the total duration of the video. </span><span class="kobospan" id="kobo.1079.2">This is necessary for setting up the </span><span><span class="kobospan" id="kobo.1080.1">progress bar.</span></span></li>
<li class="calibre14"><strong class="source-inline1"><span class="kobospan" id="kobo.1081.1">onPositionDiscontinuity</span></strong><span class="kobospan" id="kobo.1082.1"> and </span><strong class="source-inline1"><span class="kobospan" id="kobo.1083.1">onTimelineChanged</span></strong><span class="kobospan" id="kobo.1084.1">: These ensure that changes in the video playback position or timeline (such as seeking or switching to another video) update </span><strong class="source-inline1"><span class="kobospan" id="kobo.1085.1">_currentPosition</span></strong><span class="kobospan" id="kobo.1086.1"> and </span><span><strong class="source-inline1"><span class="kobospan" id="kobo.1087.1">_duration</span></strong></span><span><span class="kobospan" id="kobo.1088.1"> correctly.</span></span></li>
</ul>
<p class="calibre3"><span class="kobospan" id="kobo.1089.1">Then, the new function, </span><strong class="source-inline"><span class="kobospan" id="kobo.1090.1">startPeriodicProgressUpdate</span></strong><span class="kobospan" id="kobo.1091.1">, launches a coroutine that periodically updates the </span><strong class="source-inline"><span class="kobospan" id="kobo.1092.1">_currentPosition</span></strong><span class="kobospan" id="kobo.1093.1"> state with the player’s current position. </span><span class="kobospan" id="kobo.1093.2">This loop runs every second, providing a near-real-time update of the playback position to the UI. </span><span class="kobospan" id="kobo.1093.3">It’s crucial for making the progress bar move smoothly as the </span><span><span class="kobospan" id="kobo.1094.1">video plays.</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.1095.1">Building </span><a id="_idIndexMarker995" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.1096.1">on this functionality, the </span><strong class="source-inline"><span class="kobospan" id="kobo.1097.1">seekTo</span></strong><span class="kobospan" id="kobo.1098.1"> function allows the video to be seeked to a new position. </span><span class="kobospan" id="kobo.1098.2">It checks that the position is within the bounds of the video before calling </span><strong class="source-inline"><span class="kobospan" id="kobo.1099.1">seekTo</span></strong><span class="kobospan" id="kobo.1100.1"> on the ExoPlayer instance, effectively letting the user jump to different parts of the video through the </span><span><span class="kobospan" id="kobo.1101.1">progress bar.</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.1102.1">Finally, the </span><strong class="source-inline"><span class="kobospan" id="kobo.1103.1">onCleared</span></strong><span class="kobospan" id="kobo.1104.1"> method has been modified to cancel the new </span><strong class="source-inline"><span class="kobospan" id="kobo.1105.1">progressUpdateJob</span></strong><span class="kobospan" id="kobo.1106.1"> composable in case we have to release </span><span><span class="kobospan" id="kobo.1107.1">the resources.</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.1108.1">With these changes, our video player is ready. </span><span class="kobospan" id="kobo.1108.2">We just have to modify the hardcoded media URL in </span><strong class="source-inline"><span class="kobospan" id="kobo.1109.1">PlaybackViewModel</span></strong><span class="kobospan" id="kobo.1110.1"> (</span><strong class="source-inline"><span class="kobospan" id="kobo.1111.1">val mediaUrl = "https://example.com/media.mp4"</span></strong><span class="kobospan" id="kobo.1112.1">) so that we can provide a URL to an actual video and let the magic happen! </span><span class="kobospan" id="kobo.1112.2">At this point, we should see the playback of the </span><span><span class="kobospan" id="kobo.1113.1">provided video.</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.1114.1">In the last section of this chapter, we are going to enhance the functionality of our video player a little bit further by learning how to </span><span><span class="kobospan" id="kobo.1115.1">add subtitles.</span></span></p>
<h1 id="_idParaDest-176" class="calibre5"><a id="_idTextAnchor178" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.1116.1">Adding subtitles to the video player</span></h1>
<p class="calibre3"><span class="kobospan" id="kobo.1117.1">In this section, we’ll be adding subtitles to our video player. </span><span class="kobospan" id="kobo.1117.2">Subtitles are crucial for making </span><a id="_idIndexMarker996" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.1118.1">videos accessible to everyone, but they can also be </span><a id="_idIndexMarker997" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.1119.1">great for watching videos in noisy environments or when you need to keep the volume down. </span><span class="kobospan" id="kobo.1119.2">In this section, we’ll learn how to load and display subtitles alongside our video while handling various formats and ensuring they sync up perfectly with </span><span><span class="kobospan" id="kobo.1120.1">our content.</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.1121.1">To add subtitles, follow </span><span><span class="kobospan" id="kobo.1122.1">these steps:</span></span></p>
<ol class="calibre13">
<li class="calibre14"><span class="kobospan" id="kobo.1123.1">Create a MediaSource for your video file, just as you would for any video playback in ExoPlayer. </span><span class="kobospan" id="kobo.1123.2">We did this in the </span><span><span class="kobospan" id="kobo.1124.1">previous section.</span></span></li>
<li class="calibre14"><span class="kobospan" id="kobo.1125.1">Create a MediaSource for your subtitle file. </span><span class="kobospan" id="kobo.1125.2">This often involves using </span><strong class="source-inline1"><span class="kobospan" id="kobo.1126.1">SingleSampleMediaSource</span></strong><span class="kobospan" id="kobo.1127.1"> for single subtitle files or similar approaches for </span><span><span class="kobospan" id="kobo.1128.1">different formats.</span></span></li>
<li class="calibre14"><span class="kobospan" id="kobo.1129.1">Use </span><strong class="source-inline1"><span class="kobospan" id="kobo.1130.1">MergingMediaSource</span></strong><span class="kobospan" id="kobo.1131.1"> to combine the video and subtitle sources. </span><span class="kobospan" id="kobo.1131.2">This merged source is then passed to the ExoPlayer instance </span><span><span class="kobospan" id="kobo.1132.1">for playback.</span></span></li>
<li class="calibre14"><span class="kobospan" id="kobo.1133.1">Initialize ExoPlayer with the merged source; it will handle the playback of both video </span><span><span class="kobospan" id="kobo.1134.1">and subtitles.</span></span></li>
</ol>
<p class="calibre3"><span class="kobospan" id="kobo.1135.1">ExoPlayer </span><a id="_idIndexMarker998" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.1136.1">supports a wide range of subtitle formats so </span><a id="_idIndexMarker999" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.1137.1">that it can cater to various use cases and standards. </span><span class="kobospan" id="kobo.1137.2">Some of the most popular formats are </span><span><span class="kobospan" id="kobo.1138.1">as follows:</span></span></p>
<ul class="calibre15">
<li class="calibre14"><strong class="bold"><span class="kobospan" id="kobo.1139.1">WebVTT</span></strong><span class="kobospan" id="kobo.1140.1"> (</span><strong class="source-inline1"><span class="kobospan" id="kobo.1141.1">.vtt</span></strong><span class="kobospan" id="kobo.1142.1">): A widely </span><a id="_idIndexMarker1000" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.1143.1">used format for HTML5 video subtitles that’s supported by many web browsers </span><span><span class="kobospan" id="kobo.1144.1">and platforms:</span></span><ul class="calibre16"><li class="calibre14"><strong class="bold"><span class="kobospan" id="kobo.1145.1">Advantages</span></strong><span class="kobospan" id="kobo.1146.1">: WebVTT is </span><a id="_idIndexMarker1001" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.1147.1">extensively supported across most modern web browsers, making it ideal for online streaming services. </span><span class="kobospan" id="kobo.1147.2">It offers options for styling, positioning, and cue settings, allowing for a customizable </span><span><span class="kobospan" id="kobo.1148.1">viewing experience.</span></span></li><li class="calibre14"><strong class="bold"><span class="kobospan" id="kobo.1149.1">Disadvantages</span></strong><span class="kobospan" id="kobo.1150.1">: Compared to simpler formats such as SRT, WebVTT’s additional </span><a id="_idIndexMarker1002" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.1151.1">features can make it more complex to create and edit. </span><span class="kobospan" id="kobo.1151.2">Also, different platforms and browsers may interpret styling and formatting cues differently, leading to </span><span><span class="kobospan" id="kobo.1152.1">inconsistent presentations.</span></span></li></ul></li>
<li class="calibre14"><strong class="bold"><span class="kobospan" id="kobo.1153.1">SubRip</span></strong><span class="kobospan" id="kobo.1154.1"> (</span><strong class="source-inline1"><span class="kobospan" id="kobo.1155.1">.srt</span></strong><span class="kobospan" id="kobo.1156.1">): One of </span><a id="_idIndexMarker1003" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.1157.1">the most common subtitle formats that’s simple in structure and supported by a wide range of </span><span><span class="kobospan" id="kobo.1158.1">media players:</span></span><ul class="calibre16"><li class="calibre14"><strong class="bold"><span class="kobospan" id="kobo.1159.1">Advantages</span></strong><span class="kobospan" id="kobo.1160.1">: The </span><a id="_idIndexMarker1004" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.1161.1">structure of SRT files is straightforward, making them easy to create, edit, and debug. </span><span class="kobospan" id="kobo.1161.2">It is also supported by almost all media players, making it universally applicable for offline and online </span><span><span class="kobospan" id="kobo.1162.1">video playback.</span></span></li><li class="calibre14"><strong class="bold"><span class="kobospan" id="kobo.1163.1">Disadvantages</span></strong><span class="kobospan" id="kobo.1164.1">: It provides </span><a id="_idIndexMarker1005" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.1165.1">basic text formatting, which limits its ability to customize the appearance </span><span><span class="kobospan" id="kobo.1166.1">of subtitles.</span></span></li></ul></li>
</ul>
<p class="calibre3"><span class="kobospan" id="kobo.1167.1">To give </span><a id="_idIndexMarker1006" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.1168.1">you an idea of what one of these formats looks like, here’s </span><a id="_idIndexMarker1007" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.1169.1">an example of the content of a SubRip (</span><strong class="source-inline"><span class="kobospan" id="kobo.1170.1">.</span></strong><span><strong class="source-inline"><span class="kobospan" id="kobo.1171.1">srt</span></strong></span><span><span class="kobospan" id="kobo.1172.1">) file:</span></span></p>
<pre class="source-code"><span class="kobospan1" id="kobo.1173.1">
1
00:00:01,000 --&gt; 00:00:03,000
Hello, welcome to our video!
</span><span class="kobospan1" id="kobo.1173.2">2
00:00:05,000 --&gt; 00:00:08,000
Today, we'll be discussing how to create a simple SRT file.
</span><span class="kobospan1" id="kobo.1173.3">3
00:00:10,000 --&gt; 00:00:12,000
Let's get started.
</span><span class="kobospan1" id="kobo.1173.4">4
00:00:15,000 --&gt; 00:00:20,000
Subtitles primarily enhance accessibility and also can be very helpful for understanding dialogue, especially in noisy environments.
</span><span class="kobospan1" id="kobo.1173.5">5
00:00:22,500 --&gt; 00:00:25,000
And that's all there is to it!</span></pre> <p class="calibre3"><span class="kobospan" id="kobo.1174.1">Each block starts with a sequence number (for example, 1, 2, 3, and so on), followed by the time range on the next line (start time --&gt; end time), and then the text of the subtitle. </span><span class="kobospan" id="kobo.1174.2">This text can be one or more lines and is followed by a blank line to indicate the end of the subtitle entry. </span><span class="kobospan" id="kobo.1174.3">This format can be edited with any text editor and saved with the </span><strong class="source-inline"><span class="kobospan" id="kobo.1175.1">.</span></strong><span><strong class="source-inline"><span class="kobospan" id="kobo.1176.1">srt</span></strong></span><span><span class="kobospan" id="kobo.1177.1"> extension.</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.1178.1">Now that </span><a id="_idIndexMarker1008" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.1179.1">we know a bit more about how to add subtitles </span><a id="_idIndexMarker1009" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.1180.1">to a video in ExoPlayer, let’s add them by default to our already-implemented playback functionality. </span><span class="kobospan" id="kobo.1180.2">We just need to change the logic for the player setup </span><span><span class="kobospan" id="kobo.1181.1">in </span></span><span><strong class="source-inline"><span class="kobospan" id="kobo.1182.1">PlaybackViewModel</span></strong></span><span><span class="kobospan" id="kobo.1183.1">:</span></span></p>
<pre class="source-code"><span class="kobospan1" id="kobo.1184.1">
@OptIn(UnstableApi::class)
private fun preparePlayerWithMediaSource(exoPlayer:
ExoPlayer) {
        val mediaUrl = "https://example.com/media.mp4"
        val subtitleUrl =
            "https://example.com/subtitles.srt"
        val videoMediaSource =
            ProgressiveMediaSource.Factory(
                DefaultHttpDataSource.Factory()
        ).createMediaSource(MediaItem.fromUri(mediaUrl))
        val subtitleSource =
            MediaItem.SubtitleConfiguration.Builder(
                Uri.parse(subtitleUrl)).build()
        val subtitleMediaSource =
            SingleSampleMediaSource.Factory(
                DefaultHttpDataSource.Factory()
        ).createMediaSource(subtitleSource, C.TIME_UNSET)
        val mergedSource =
            MergingMediaSource(videoMediaSource,
                subtitleMediaSource)
        exoPlayer.setMediaSource(mergedSource)
        exoPlayer.prepare()
}</span></pre> <p class="calibre3"><span class="kobospan" id="kobo.1185.1">In the preceding code, we modified the already existing </span><strong class="source-inline"><span class="kobospan" id="kobo.1186.1">preparePlayerWithMediaSource</span></strong><span class="kobospan" id="kobo.1187.1"> function. </span><span class="kobospan" id="kobo.1187.2">We started by adding a new media with the </span><span><span class="kobospan" id="kobo.1188.1">subtitles URL.</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.1189.1">Then we created </span><strong class="source-inline"><span class="kobospan" id="kobo.1190.1">MediaSource</span></strong><span class="kobospan" id="kobo.1191.1"> for the subtitles, and we created a </span><strong class="source-inline"><span class="kobospan" id="kobo.1192.1">MediaItem.SubtitleConfiguration</span></strong><span class="kobospan" id="kobo.1193.1"> object from the subtitle URL (</span><strong class="source-inline"><span class="kobospan" id="kobo.1194.1">subtitleUrl</span></strong><span class="kobospan" id="kobo.1195.1">). </span><span class="kobospan" id="kobo.1195.2">This configuration specifies how the subtitle should be loaded </span><span><span class="kobospan" id="kobo.1196.1">and displayed.</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.1197.1">Then, </span><strong class="source-inline"><span class="kobospan" id="kobo.1198.1">SingleSampleMediaSource</span></strong><span class="kobospan" id="kobo.1199.1"> is created for the subtitle configuration. </span><span class="kobospan" id="kobo.1199.2">Here, </span><strong class="source-inline"><span class="kobospan" id="kobo.1200.1">SingleSampleMediaSource</span></strong><span class="kobospan" id="kobo.1201.1"> is used because subtitle files are typically a single piece of </span><a id="_idIndexMarker1010" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.1202.1">content rather than streamed content. </span><span class="kobospan" id="kobo.1202.2">The </span><strong class="source-inline"><span class="kobospan" id="kobo.1203.1">createMediaSource</span></strong><span class="kobospan" id="kobo.1204.1"> method here is slightly different from the video one; it takes the </span><a id="_idIndexMarker1011" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.1205.1">subtitle configuration and a duration parameter, which is set to </span><strong class="source-inline"><span class="kobospan" id="kobo.1206.1">C.TIME_UNSET</span></strong><span class="kobospan" id="kobo.1207.1"> to indicate that the duration is unknown or should be determined from the </span><span><span class="kobospan" id="kobo.1208.1">content itself.</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.1209.1">Once both the video and subtitle sources have been created, they’re combined into a single source using </span><strong class="source-inline"><span class="kobospan" id="kobo.1210.1">MergingMediaSource</span></strong><span class="kobospan" id="kobo.1211.1">. </span><span class="kobospan" id="kobo.1211.2">This merged source tells </span><strong class="source-inline"><span class="kobospan" id="kobo.1212.1">ExoPlayer</span></strong><span class="kobospan" id="kobo.1213.1"> to play the video with the subtitles </span><span><span class="kobospan" id="kobo.1214.1">overlaying it.</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.1215.1">Finally, the merged source is set on the </span><strong class="source-inline"><span class="kobospan" id="kobo.1216.1">ExoPlayer</span></strong><span class="kobospan" id="kobo.1217.1"> instance with </span><strong class="source-inline"><span class="kobospan" id="kobo.1218.1">setMediaSource</span></strong><span class="kobospan" id="kobo.1219.1">, and </span><strong class="source-inline"><span class="kobospan" id="kobo.1220.1">prepare()</span></strong><span class="kobospan" id="kobo.1221.1"> is called. </span><span class="kobospan" id="kobo.1221.2">This action causes </span><strong class="source-inline"><span class="kobospan" id="kobo.1222.1">ExoPlayer</span></strong><span class="kobospan" id="kobo.1223.1"> to load the media and get ready for playback. </span><span class="kobospan" id="kobo.1223.2">When the video plays, the subtitles from the specified SRT file will be displayed at the correct times, as defined in </span><span><span class="kobospan" id="kobo.1224.1">the file.</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.1225.1">The following figure shows the </span><span><span class="kobospan" id="kobo.1226.1">subtitles added:</span></span></p>
<div class="calibre2">
<div class="img---figure" id="_idContainer066">
<span class="kobospan" id="kobo.1227.1"><img alt="Figure 8.3: Playback with subtitles" src="image/B19443_08_03.jpg" class="calibre4"/></span>
</div>
</div>
<p class="img---caption" lang="en-US" xml:lang="en-US"><span class="kobospan" id="kobo.1228.1">Figure 8.3: Playback with subtitles</span></p>
<p class="calibre3"><span class="kobospan" id="kobo.1229.1">With that, our </span><a id="_idIndexMarker1012" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.1230.1">player is ready to play back videos. </span><span class="kobospan" id="kobo.1230.2">By including </span><a id="_idIndexMarker1013" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.1231.1">subtitles, it offers a more accessible experience for </span><span><span class="kobospan" id="kobo.1232.1">our users.</span></span></p>
<h1 id="_idParaDest-177" class="calibre5"><a id="_idTextAnchor179" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.1233.1">Summary</span></h1>
<p class="calibre3"><span class="kobospan" id="kobo.1234.1">In this chapter, we tackled the essentials of adding video playback in our Android app while focusing on the powerful ExoPlayer library. </span><span class="kobospan" id="kobo.1234.2">We started by comparing media options in Android before quickly realizing ExoPlayer’s superiority due to its flexibility and wide format support. </span><span class="kobospan" id="kobo.1234.3">This set the stage for us to learn how ExoPlayer fits into an app and how to use it for playing </span><span><span class="kobospan" id="kobo.1235.1">videos smoothly.</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.1236.1">We then walked through building a user-friendly video playback interface, covering everything from setting up ExoPlayer to managing playback controls. </span><span class="kobospan" id="kobo.1236.2">Finally, we explored adding subtitles to make your videos accessible to a wider audience, highlighting ExoPlayer’s capability to </span><span><span class="kobospan" id="kobo.1237.1">enhance inclusivity.</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.1238.1">Now that you have a solid grasp of video playback using ExoPlayer, you’re ready to elevate your app with picture-in-picture mode and </span><span><span class="kobospan" id="kobo.1239.1">media casting.</span></span></p>
</div>
</body></html>