<html><head></head><body><div><div><div><div><h1 class="title"><a id="ch07"/>Chapter 7. Debugging with REPLs and Command Lines</h1></div></div></div><p>This chapter takes a break from programming the database API by looking at two different support tools and how to include a debugging web server in your iOS apps. This server can be used in any app to provide additional access supplementing the normal user interface. Being able to dump data is an important feature expected by most database developers—SQL <a id="id166" class="indexterm"/>systems usually have a way to execute raw SQL against the server. Including the server is more work than using the tools, but they can't be run against data on a device; only on OS X (which includes data in your simulator working directory).</p><div><div><div><div><h1 class="title"><a id="ch07lvl1sec33"/>Building and running the LevelDB dump utility</h1></div></div></div><p>The standard LevelDB source <a id="id167" class="indexterm"/>distribution includes a dump utility, but it is not built by default with the <code class="literal">Makefile</code>. This dump lets you see a raw copy of the content of your tables. After you have built LevelDB for a given setting, you can build the dump <a id="id168" class="indexterm"/>with the following command:</p><div><pre class="programlisting">
<strong>make leveldbutil</strong>
</pre></div><p>If you built your LevelDB using a <a id="id169" class="indexterm"/>
<code class="literal">CXXFlags</code> setting, then you need to build the <a id="id170" class="indexterm"/>
<code class="literal">util</code> with the same settings and repeat them in <code class="literal">LDFlags</code> to ensure LevelDB builds. The single command line looks like the following (without wrapping):</p><div><pre class="programlisting">
<strong>CXXFLAGS="-std=c++11 -stdlib=libc++" LDFLAGS=</strong>
<strong>  "-std=c++11 -stdlib=libc++" make leveldbutil</strong>
</pre></div><p>As you have already seen, a LevelDB database creates a number of files within a folder. The roles of these files are explained further in <a class="link" href="ch10.html" title="Chapter 10. Tuning and Key Policies">Chapter 10</a>, <em>Tuning and Key Policies</em>.</p><p>Depending on what you have been doing with a database, it may not have generated any <code class="literal">.sst</code> files. <a id="id171" class="indexterm"/>Some of our quick operations which only add a few records will only <a id="id172" class="indexterm"/>create <code class="literal">.log</code> files. <code class="literal">Sample06x</code> uses 50,000 records and writes in batches of 1,000 so it guarantees writing more than one <code class="literal">.sst</code> file to give us a much more interesting dump. You will see <code class="literal">Sample06x</code> discussed in more detail in the next chapter, but for now it has two key types, prefixed by <code class="literal">N~</code> and <code class="literal">P~</code>, which are added in an alternating sequence in our code.</p><p>The accompanying code contains a log of the build of the <code class="literal">leveldbutil</code> as well as several logs of running it. A heavily elided one for the large <code class="literal">Sample06x</code> is in the file <code class="literal">log of dump</code> <code class="literal">testLeveldb06x.txt</code> and shows the utility being run over the database folder created by running <code class="literal">Sample06x</code> on OS X.</p><p>The first file that we will look at is the <code class="literal">MANIFEST</code> <a id="id173" class="indexterm"/>file which shows how the number of writing passes was batched and also that a special comparator was used (explained in the next chapter). Your main concern with comparators for now, is that the dump <a id="id174" class="indexterm"/>utility ignores them, but other tools such as lev (see the following code) cannot open a database using a custom comparator. So, using <a id="id175" class="indexterm"/>
<code class="literal">leveldbutil</code> to check the <code class="literal">MANIFEST</code> file lets you <a id="id176" class="indexterm"/>check for this as a point of failure, if you have other programs getting errors on opening.</p><div><pre class="programlisting">
<strong>$ ./leveldbutil dump /tmp/testLeveldb06x/MANIFEST-000002 </strong>
<strong>$ ./leveldbutil dump /tmp/testLeveldb06x/*.log</strong>
<strong>$ ./leveldbutil dump /tmp/testLeveldb06x/000005.sst </strong>
<strong>$ ./leveldbutil dump /tmp/testLeveldb06x/000007.sst</strong>
</pre></div><p>The next file is the log file—there's only one active log file so you can use a command using <code class="literal">*.log</code> as shown here. The log contains the last lot of records written, from line 42001 in the input file onwards.</p><p>The log then shows an elided dump of two <code class="literal">.sst</code> files which are the sorted tables. The LevelDB processing creates these as an immutable store, leaving only recent entries in the <code class="literal">.log</code> file. Note how the two tables have an apparently interleaved set of keys.</p></div></div>
<div><div><div><div><h1 class="title"><a id="ch07lvl1sec34"/>Installing Node.js and the lev utility</h1></div></div></div><p>The popular node environment <a id="id177" class="indexterm"/>provides a server-side or command-line environment for running JavaScript programs that also supports console and even desktop programs <a id="id178" class="indexterm"/>(using packagers such as <code class="literal">AppJS</code>). Among the many libraries created for node are LevelUP and LevelDOWN. LevelDOWN is a simple wrapper for the C++ binding to LevelDB, providing the standard LevelDB API mapped to JavaScript functions. LevelUP started as a high-level interface to LevelDOWN but is now also an abstraction layer allowing other backends to be used that provide the LevelDB functions.</p><p>The <strong>lev</strong> utility , from <a class="ulink" href="https://github.com/hij1nx/lev">https://github.com/hij1nx/lev</a> provides a <a id="id179" class="indexterm"/>commandline and GUI for directly working with a LevelDB database using these libraries. It installs both LevelUP and LevelDOWN. We are just concerned with using lev as a utility without caring about how it is implemented. The installer for node is available from <a class="ulink" href="http://nodejs.org/">http://nodejs.org/</a> and is a simple GUI installer putting both <a id="id180" class="indexterm"/>node and the <strong>npm</strong> (<strong>Node Package Manager</strong>) into <code class="literal">/usr/local/bin</code>. You will also need to install Python 2.7 from <a class="ulink" href="http://www.python.org/download/releases/2.7.5/">http://www.python.org/download/releases/2.7.5/</a> in order to build LevelDown <a id="id181" class="indexterm"/> (ironically, yes, Python is used to script building a C++ binding for a JavaScript tool).</p><p>The accompanying <code class="literal">log of lev install with node package manager.txt</code> shows the installation of these packages in <a id="id182" class="indexterm"/>detail including the errors that occur if you have not upgraded the <a id="id183" class="indexterm"/>default Python version in your OS X. The install is triggered by a single command which automates downloading, building, and installing the packages in the following way:</p><div><pre class="programlisting">
<strong>$sudo npm install –g lev</strong>
<strong>$lev /tmp/testLeveldb06 --start "World" --end "You" --keys</strong>
<strong>"Worlds\tTrudy"</strong>
<strong>"Wubbel\tBuster"</strong>
<strong>"Wyrosdick\tMerle"</strong>
<strong>"Youtsey\tLynda"</strong>
</pre></div><p>Once you have lev installed, it offers command-line dumping of keys, deleting records, and adding new ones. See <code class="literal">log of dump testLeveldb06x.txt</code> for more examples.</p><div><div><div><div><h2 class="title"><a id="ch07lvl2sec13"/>Adding a REPL for debugging inside your iOS app</h2></div></div></div><p>The term <strong>REPL</strong> is <a id="id184" class="indexterm"/>commonly used in scripting languages and means <strong>Read Eval Print Loop</strong>. A REPL typically accepts commands and prints their result, then loops to accept the next command. It's like the terminal command line but embedded in an app.</p><p>The <code class="literal">Sample07</code> code provides an example of an iPhone app that includes a small web server and provides a REPL for database operations. This app  can be run on a simulator as well as a device. The following screenshot shows it running on the simulator, so the IP address shown is that of the OS X development system running the simulator:</p><div><img src="img/1015OS_07_01.jpg" alt="Adding a REPL for debugging inside your iOS app"/><div><p>The status report when debugging in Simulator, showing the address used to browse to the device</p></div></div><p>Once you are running the application, you can launch a web browser and type in this address, <strong>192.168.0.51:8080,</strong> as shown in the preceding screenshot. You can connect multiple browsers to the server from anything—use an iPad to query the database on an iPhone or iPod Touch! The web server is running totally in the background so your normal app behavior can continue. This makes it a debugging tool you can drop into any application (warning: this will be a security hole <a id="id185" class="indexterm"/>if included in distributed apps, unless you add authentication).</p><p>The first version of the REPL <a id="id186" class="indexterm"/>looks for known commands, or if it doesn't recognize a command, it assumes you're entering a partial key to be searched. The results of entering <code class="literal">Am</code> are shown in the following screenshot. Some server commands are:</p><div><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><code class="literal">help</code> lists <a id="id187" class="indexterm"/>commands and their syntax, see the <code class="literal">readme.md</code> document</li><li class="listitem" style="list-style-type: disc"><code class="literal">prefix aKey</code> sets <code class="literal">aKey</code> <a id="id188" class="indexterm"/>as the prefix on any keys from now</li><li class="listitem" style="list-style-type: disc"><code class="literal">unprefix</code> <a id="id189" class="indexterm"/>clears the key prefix</li><li class="listitem" style="list-style-type: disc"><code class="literal">put akey aValue</code><strong> </strong>adds <a id="id190" class="indexterm"/>key <code class="literal">aKey</code> value <code class="literal">aValue</code>, quoted to include spaces, using <code class="literal">\</code> to embed quotes, for example<code class="literal"> put Author "Andy Dent"</code></li><li class="listitem" style="list-style-type: disc"><code class="literal">get akey</code> returns the <a id="id191" class="indexterm"/>full value associated with <code class="literal">akey</code></li><li class="listitem" style="list-style-type: disc"><code class="literal">del akey</code> deletes <a id="id192" class="indexterm"/>the key <code class="literal">akey</code></li><li class="listitem" style="list-style-type: disc"><code class="literal">count fromPart toPart</code> <a id="id193" class="indexterm"/>just counts records, with both <code class="literal">fromPart</code> and <code class="literal">toPart</code> being optional (it runs an iterator over that range of partial keys)</li><li class="listitem" style="list-style-type: disc"><code class="literal">keys fromPart toPart</code> lists <a id="id194" class="indexterm"/>keys, both <code class="literal">fromPart</code> and <code class="literal">toPart</code> being optional</li><li class="listitem" style="list-style-type: disc"><code class="literal">stats</code> displays the database <a id="id195" class="indexterm"/>statistics</li></ul></div><div><img src="img/1015OS_07_02.jpg" alt="Adding a REPL for debugging inside your iOS app"/><div><p>The browser result after entering Am as a command, connected to iPhone</p></div></div><p>The web server engine being used <a id="id196" class="indexterm"/>is the open source <code class="literal">GCDWebServer</code> from <a class="ulink" href="https://github.com/swisspol/GCDWebServer">https://github.com/swisspol/GCDWebServer</a> and templated page generation uses <a id="id197" class="indexterm"/>
<code class="literal">GRMustache</code> from <a class="ulink" href="https://github.com/groue/GRMustache">https://github.com/groue/GRMustache</a> to provide templates using the common <strong>Mustache</strong> syntax of <a id="id198" class="indexterm"/>double braces <code class="literal">{{bracketing}}</code>.</p><p>The combination of these two source <a id="id199" class="indexterm"/>suites are being rolled up into one product adds code to make it easier to write your own REPL for embedded debugging, at <a class="ulink" href="https://github.com/AndyDentFree/REPLierGCDWebServer">https://github.com/AndyDentFree/REPLierGCDWebServer</a> that will continue to be maintained after the book launch as a generic REPL toolkit.</p><p>The <code class="literal">Sample07</code> logic to provide web templates is inside <code class="literal">ASDLevelDBREPL.m</code> and can be added very easily to any app with just one property. Add a <code class="literal">ASDLevelDBREPL</code> <code class="literal">*</code> property then start it and set its db property to the <code class="literal">APLevelDB*</code> property that you created in <code class="literal">Sample06</code>.</p><p>In <code class="literal">Sample07</code>, this is done in <code class="literal">GSdLDB07ViewController.m</code> in <code class="literal">viewDidLoad</code>, a slightly simplified version being:</p><div><pre class="programlisting">self.webserver = [ASDLevelDBREPL serverWithReporter:^(id msg){
    [self appendToDisplay:msg];
}];
self.webserver[@"title"] = @"Getting Started ... Sample07";
[self.webserver start]; // start the web server FROM MAIN THREAD
NSError* openError;
self.model = [Sample06_Model 
  modelWithSampleDatabasePath:&amp;openError];
if (openError == nil) {
  [self.model loadSampleDatafile:@"Sample500.txt"];
<strong>  self.webserver.db = self.model.db;</strong>
}</pre></div></div></div>
<div><div><div><div><h1 class="title"><a id="ch07lvl1sec35"/>Summary</h1></div></div></div><p>We have covered a couple of pre-built utilities for looking at different aspects of a database and learned a valuable way to add a debugging REPL to any iOS app. Next, we will go back to the intricacies of our GUI support with a richer version of <code class="literal">Sample06</code>. The next chapter will also discuss ways to store more information making our databases self-describing, so a more powerful database layer can be built up to abstract away some of these responsibilities.</p></div></body></html>