# 第1章. 开始使用 Apple Pay

Apple Pay 是一种移动支付系统，允许 iPhone 用户使用 Touch ID 支付商品和服务。在每次购买时，用户无需输入或确认支付卡信息（信用卡或借记卡），只需通过触摸 Home 键即可安全地授权支付。重要的是要注意，在 Apple Pay 交易过程中，支付卡信息永远不会离开用户的手机；此信息在设备中安全存储。相反，支付令牌存储了您处理支付所需的所有信息，从授权到结算（即，当用户的资金转移到您的商户银行账户时）。

使用 Apple Pay，您无需在您的服务器上存储客户的支付卡信息。这有助于减少客户在您的应用程序内支付商品时的疑虑；他们相信他们的支付卡信息在他们的设备中是安全的。您的好处是无需处理支付卡信息，至少对于基于 Apple Pay 的交易来说是这样。（当用户的设备不支持 Apple Pay 或用户尚未将支付卡添加到设备时，您可能必须使用常规方式处理支付，这可能涉及捕获和存储支付卡信息。）

虽然您从存储支付卡详情中解放出来，但您仍然需要处理支付，无论是直接处理还是通过支付网关。在两种情况下，您都需要获取 Apple Pay 商户标识符和证书来解密 Apple Pay 与交易支付信息一起创建的支付令牌。要在您的应用程序中使用 Apple Pay，您需要在项目中启用 Apple Pay 功能，这需要 Apple Pay 商户标识符。

本章描述了在线支付的工作原理，在线支付是传统**电子汇票捕捉**（**EDC**）系统的网络中心版本，用于处理信用卡交易。您还将学习 Apple Pay 支付工作流程的基础，从在用户的设备上显示**Apple Pay**按钮开始，当 Apple Pay 可用，展示 Apple Pay 支付表单，并在您的服务器上处理交易。

本章将完成以下内容：

+   提供在线支付流程概述

+   介绍 Apple Pay 支付工作流程

+   展示如何创建 Apple Pay 商户标识符和证书

+   描述如何在 Xcode 中为应用程序启用 Apple Pay 功能

# 在线支付流程概述

客户通常携带支付卡（借记卡或信用卡）在钱包或手提包中，他们使用这些卡来支付商品和服务。当持卡人用支付卡向商家付款时，商家通常使用支付网关来处理这笔交易。支付网关是一种电子商务服务，它授权基于支付卡的交易。*支付网关*在处理交易时执行多项任务，但其主要任务是提交交易授权给支付处理器之前对支付卡信息进行加密。*支付处理器*与发行客户卡的银行（称为*发行银行*或*发行者*）进行交互，最终批准或拒绝交易。支付处理器可能由支付网关、第三方或商家实现。商家可能会实现一个定制的支付处理器，例如，与定制的库存和订单系统集成。

不管理库存的商家可能只与支付网关打交道。支付网关提供库或框架，应用程序可以链接到这些库。在处理支付时，应用程序将支付令牌传递给库，库处理支付并将结果（*授权*或*拒绝*）返回给应用程序。网关执行所有必要的任务以授权交易并将支付金额从发卡行转移到商家的收单银行。*收单银行*（也称为*收单行*）是接收持卡人付款并将其记入商家银行账户（这是一种用于接收支付卡付款的特殊类型的账户，也称为*商家账户*）的银行。

需要与定制订单和库存管理系统集成的商家需要对支付处理采取更实际的方法。这正是本书讨论的场景。

首先，让我们谈谈在线支付系统是如何工作的。支付过程分为两个阶段：

+   授权

+   结算

在成功的授权中，对客户的卡执行*授权保留*，以保留为交易提供资金的资金。稍后，商家消耗或结算交易，将资金从客户的卡转移到商家的账户。

以下步骤描述了授权过程：

1.  客户出示支付卡以支付产品或服务。

1.  商家加密卡信息并向支付网关发送授权请求。

1.  然后，支付网关将授权请求转发到支付处理器。

1.  支付处理器将授权请求转发到适当的支付卡协会（Visa、MasterCard、American Express、Discover等）。

1.  卡协会将授权请求转发到发行银行，该银行最终批准或拒绝交易。一些卡协会，如Discover和American Express，也是发行银行。

1.  发行银行从支付处理器接收授权请求，并将其响应（*授权*或*拒绝*）发送给支付处理器。然后，发行银行保留一个*交易授权*或授权保留，将商家、支付卡和批准的金额（资金被保留但未从持卡人账户中扣除）联系起来。

1.  支付处理器将发行银行的响应转发给支付网关。

1.  支付网关随后将响应转发给商家，商家再将信息传达给持卡人。

要么立即，要么在一天结束时，商家开始**结算**过程以接收资金。这个过程与请求支付授权的程序类似；然而，不是授权交易，发行银行将授权保留转换为借记，并准备与收单银行结算交易：

1.  商家通过支付处理器将其批准的授权提交给其收单银行。

1.  收单银行向发行银行发出结算请求。

1.  发行银行向收单银行做出结算支付。

1.  收款行将批准的金额存入商家的银行账户。

# Apple Pay支付工作流程

如果您开发的应用能够与支付网关交互以处理支付卡，那么您或您的公司是**商家**，该应用是**商家应用**。

这是支付工作流程的概述：

1.  **显示** **Apple** **Pay按钮**：只有当用户可以执行Apple Pay支付时才显示此按钮。

1.  **创建支付请求**：此请求包含必要的支付信息和订单详情。

1.  **显示支付单据**：此单据显示了用户可以修改的订单信息，例如运费信息。

1.  **响应用户的变化**：当用户进行更改时，更新诸如运费和折扣等项目。

1.  **将支付信息提交给支付网关**：当用户授权支付请求时，将支付和订单信息提交给适当的系统。

## 显示Apple Pay按钮

当用户到达您的应用中允许用户购买东西的屏幕时，如果用户可以在设备上使用Apple Pay，应用应显示**Apple** **Pay**按钮，以便用户可以轻触按钮，验证购买详情，并通过Touch ID授权应用以完成订单并将订单金额记入适当的支付卡。决定用户是否可以使用Apple Pay涉及两个步骤：

+   确定设备是否支持Apple Pay

+   确定用户是否已将您支持的支付卡添加到设备中

    ### 小贴士

    您的应用必须在显示**Apple Pay**按钮之前进行两项检查。如果任一检查失败，应用不得显示**Apple Pay**按钮。相反，它应该通过购买按钮提供一个传统支付方式（例如获取信用卡号和发货地址）。

## 创建支付请求

如果用户可以使用Apple Pay，您的应用将准备一个支付请求。一个*支付请求*是一个对象，它描述了要收费的项目、您支持的卡关联以及账单和发货信息。

支付请求的主要组成部分是*支付摘要项*，它向用户描述支付请求。支付摘要项代表交易的一个组成部分，例如小计、折扣、运费、税费和总金额。每个项目都有一个标签，描述了每个金额的含义。最后一项是最重要的，因为它标识了收款人和用户将在下一张支付卡账单中看到的借记金额。因此，这个项目的标签应该是您公司的名称。

除了支付摘要项之外，您的应用还设置了支付请求的属性，描述了您支持哪些卡关联和在线支付协议。您的应用必须至少支持3D Secure协议。**EMV**（**欧联、万事达卡和维萨卡**）协议是可选的。

支付请求还允许您指示用户指定特定的订单详情，例如发货或账单信息。例如，您可能需要电子邮件地址或邮政地址。

如果您的订单系统需要额外的信息，例如订单号，您可以将这些信息包含在支付请求中作为自定义应用程序数据。当用户授权支付时，Apple Pay会将这些信息的哈希值包含在您收到的支付令牌中。如果您的订单系统稍后需要这些信息，您的应用必须能够单独提供它们。

## 展示支付单据

一旦您的应用创建了支付请求并且用户点击了**Apple Pay**按钮，应用就会向用户展示一个支付单据。*支付单据*（正式名称为*支付授权视图控制器*）向用户展示支付请求中的支付摘要项以供审查。用户在授权支付之前可以更改订单的某些方面。用户也可能决定不购买商品并取消交易。

## 响应订单变更和支付授权

您的应用实现了一个支付单据的代理，通过例如，当用户选择不同的发货方式时更新订单的运费和总金额来响应用户的操作。

### 注意

当用户使用Touch ID授权支付请求时，Apple Pay会与设备的安全元素（在设备上安全存储支付卡详情的芯片，即使是苹果也无法访问的详情）和苹果的服务器交互，以生成一个一次性使用的支付令牌。*支付信息*描述了支付交易，并包含所有将支付金额记在用户支付卡上所需的信息（但此信息不包含卡号）。

苹果使用您的商户证书在其服务器上加密令牌中的信息。

## 将支付信息提交给支付网关

当支付单告诉其代表用户已授权支付请求并发送支付信息给用户时，代表调用一个同步方法，该方法将支付信息转发到您的支付网关。当方法返回时，它向代表提供支付请求的结果。如果支付请求被批准，支付单向用户显示确认信息，告知交易已批准，并通知其代表。然后代表关闭支付单并显示一个自定义确认屏幕；这样的屏幕可能显示订单号和一条*感谢*信息。如果支付请求未被批准，代表必须显示适当的屏幕并要求用户提供另一种支付方式。

# 在您的应用中启用Apple Pay

为了您的应用能够使用Apple Pay，您必须有一个Apple商户标识符和商户证书。苹果使用证书来加密支付令牌中的支付信息。您的支付网关（Stripe、Worldpay等）使用证书来解密支付令牌中的信息。

## 创建您的应用Apple Pay商户标识符

您必须能够访问您的团队**成员中心**门户和您的支付网关的证书管理设施。

在您的团队**成员中心**页面通过以下步骤创建您的商户标识符：

1.  在**成员中心**，点击**证书、标识符和配置文件**。

1.  在**iOS应用**下，点击**标识符**。

1.  在**标识符**下，点击**商户ID**。

1.  点击**继续**（如果这是您的第一个商户标识符）或在页面右上角的加号（**+**）按钮。

1.  在**描述**字段中为商户标识符输入描述，例如`MerchantApp merchant identifier`。

1.  在ID字段中输入标识符字符串，例如`merchant.com.company.merchantapp`。

1.  点击**继续**然后点击**注册**。

1.  点击**完成**。

通过执行以下操作从您的支付网关请求Apple Pay证书：

1.  在您的支付网关的证书管理页面中创建一个Apple Pay证书。

1.  将**证书签名请求**（**CSR**）文件下载到您的Mac上。

现在，按照以下步骤在成员中心创建您的应用商户证书：

1.  在**证书、标识符和配置文件**页面，在**iOS应用**下，在**证书**下，点击**所有**。

1.  然后，选择**Apple Pay证书**并点击**继续**。

1.  在**您想使用哪个商家ID？**下，选择适当的商家标识符并点击**继续**。

1.  在**生成您的证书**下，点击**选择文件**。

1.  选择您从支付网关获得的CSR文件。

1.  然后，点击**生成**，然后点击**下载**以将您的应用商家证书下载到您的Mac。

通过以下步骤将您的应用商家证书上传到您的支付网关：

1.  在您的支付网关的证书管理页面上，上传您从**会员中心**门户下载的商家证书。

1.  确认您的商家证书已列在您的支付网关账户中。

## 在您的Mac上安装应用的Apple Pay商家证书

双击您之前从**会员中心**下载的商家证书。此时，**密钥链访问**将打开并安装证书，包括您的其他证书。

## 在您的应用Xcode项目中启用Apple Pay

要为您的应用提供访问Apple Pay的权限，您需要在Xcode项目中启用Apple Pay功能。执行以下操作：

1.  首先，在Xcode中打开您的项目。

1.  选择构建应用的target以打开target编辑器。

1.  然后，点击**功能**。

1.  找到**Apple Pay**功能，并将相应的开关切换到开启位置。

1.  在出现的对话框中，选择适当的开发团队，并点击**选择**。[在您的应用Xcode项目中启用Apple Pay](img/B05093_01_01.png.jpg)

# 摘要

在本章中，你学习了商家获取基于卡的支付所遵循的在线支付流程。本章介绍了通用的在线支付概念，以描述应用如何使用Apple Pay执行类似功能但更加安全。最后，你学习了如何创建Apple Pay商家标识符和商家证书，以在你的应用中启用Apple Pay支付。

下一章重点介绍支付请求工作流程，其中当设备上可用Apple Pay时，您将展示**Apple** **Pay**按钮，创建支付请求，并根据该请求展示支付表单。
