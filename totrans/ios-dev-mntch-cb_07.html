<html><head></head><body><div class="chapter" title="Chapter&#xA0;7.&#xA0;Multimedia Resources"><div class="titlepage"><div><div><h1 class="title"><a id="ch07"/>Chapter 7. Multimedia Resources</h1></div></div></div><p>In this chapter, we will cover:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">Selecting images and videos</li><li class="listitem" style="list-style-type: disc">Capturing media with the camera</li><li class="listitem" style="list-style-type: disc">Playing video</li><li class="listitem" style="list-style-type: disc">Playing music and sounds</li><li class="listitem" style="list-style-type: disc">Recording with the microphone</li><li class="listitem" style="list-style-type: disc">Managing multiple album items directly</li></ul></div><div class="section" title="Introduction"><div class="titlepage"><div><div><h1 class="title"><a id="ch07lvl1sec01"/>Introduction</h1></div></div></div><p>One of the most important features of today's smartphones and tablets is their ability to capture and manage multimedia resources. Be it photos, videos, or audio, an application targeted at these devices that can handle multimedia effectively is very important.</p><p>In this chapter, we will learn how to manage media stored on the device. We will also see how to use the device's multimedia capturing devices (camera and microphone) to capture content and create an application that will provide a rich experience to the user.</p><p>More specifically, we will discuss:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><code class="literal">UIImagePickerController:</code> This is a controller that not only provides access, through a user interface, to the saved photos and videos on the device, but also a camera interface for capturing<a id="id572" class="indexterm"/></li><li class="listitem" style="list-style-type: disc"><code class="literal">MPMoviePlayerController:</code> This is a controller that allows us to play and stream video files<a id="id573" class="indexterm"/></li><li class="listitem" style="list-style-type: disc"><code class="literal">MPMediaPickerController:</code> This is the default user interface for accessing the saved content, managed by the native iPod application<a id="id574" class="indexterm"/></li><li class="listitem" style="list-style-type: disc"><code class="literal">MPMusicPlayerController:</code> This is the object responsible for playing the iPod content<a id="id576" class="indexterm"/></li><li class="listitem" style="list-style-type: disc"><code class="literal">AVAudioPlayer:</code> This is the class that allows us to play sound files<a id="id577" class="indexterm"/></li><li class="listitem" style="list-style-type: disc"><code class="literal">AVAudioRecorder:</code> This is the class that allows us to use the microphone to record audio<a id="id578" class="indexterm"/></li><li class="listitem" style="list-style-type: disc"><code class="literal">ALAssetsLibrary:</code> This is the class that provides access to the device's available assets and their metadata<a id="id579" class="indexterm"/></li></ul></div></div></div>
<div class="section" title="Selecting images and videos"><div class="titlepage"><div><div><h1 class="title"><a id="ch07lvl1sec02"/>Selecting images and videos</h1></div></div></div><p>In this recipe, we will learn how to provide the user with the ability to import images and videos from the device album.</p><div class="section" title="Getting ready"><div class="titlepage"><div><div><h2 class="title"><a id="ch07lvl2sec01"/>Getting ready</h2></div></div></div><p>Create a new project in MonoDevelop, and name it<code class="literal"> ImagePickerApp</code>.<a id="id580" class="indexterm"/>
</p></div><div class="section" title="How to do it..."><div class="titlepage"><div><div><h2 class="title"><a id="ch07lvl2sec02"/>How to do it...</h2></div></div></div><div class="orderedlist"><ol class="orderedlist"><li class="listitem"> Add a<code class="literal"> UIImageView</code> and a<code class="literal"> UIButton</code> on the main view of<code class="literal"> MainController</code>.</li><li class="listitem"> Override the<code class="literal"> ViewDidLoad</code> method of the<code class="literal"> MainController</code> class, and enter the following code in it:<a id="id581" class="indexterm"/><div class="informalexample"><pre class="programlisting">this.imagePicker = new UIImagePickerController();
this.imagePicker.FinishedPickingMedia += this.ImagePicker_FinishedPickingMedia;
this.imagePicker.Canceled += this.ImagePicker_Cancelled;
this.imagePicker.SourceType = UIImagePickerControllerSourceType.PhotoLibrary;
this.buttonChoose.TouchUpInside += delegate {
this.PresentModalViewController(this.imagePicker, true);
} ;
</pre></div></li><li class="listitem"> Implement the handler methods for the<code class="literal"> FinishedPickingMedia</code> and<code class="literal"> Canceled</code> events:<div class="informalexample"><pre class="programlisting">private void ImagePicker_FinishedPickingMedia (object sender, UIImagePickerMediaPickedEventArgs e){
UIImage pickedImage = e.Info[UIImagePickerController.OriginalImage] as UIImage;
this.imageView.Image = pickedImage;
this.imagePicker.DismissModalViewControllerAnimated(true);
}
private void ImagePicker_Cancelled (object sender, EventArgs e){
this.imagePicker.DismissModalViewControllerAnimated(true);
}
</pre></div></li><li class="listitem"> Compile and run the application on the simulator.</li><li class="listitem"> Tap on the button to present the image picker, and select an image by tapping on its thumbnail. The image will be displayed in the image view. The<code class="literal"> UIImagePickerController</code> is displayed in the following screenshot:<a id="id582" class="indexterm"/></li></ol></div><div class="mediaobject"><img src="graphics/1468EXP_07_01.jpg" alt="How to do it..."/></div></div><div class="section" title="How it works..."><div class="titlepage"><div><div><h2 class="title"><a id="ch07lvl2sec03"/>How it works...</h2></div></div></div><p>The<code class="literal"> UIImagePickerController</code> is a special view controller that iOS provides for selecting images and videos that are saved on the device album, or from the camera.<a id="id583" class="indexterm"/>
</p><div class="note" title="Note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title"><a id="note33"/>Note</h3><p>By default, the iOS simulator does not have images stored in its album. To add images to the simulator, uncomment the method<code class="literal"> AddImagesToAlbum</code> of the downloaded project source code and call it once, passing as a parameter the physical path on your computer that contains images.</p></div><p>After initializing the image picker object, we need to subscribe to its<code class="literal"> FinishedPickingMedia</code> event, which provides us with the media the user has selected. In the handler we assign to it, we get the selected image:</p><div class="informalexample"><pre class="programlisting">UIImage pickedImage = e.Info[UIImagePickerController.OriginalImage] as UIImage;
</pre></div><p>The<code class="literal"> Info</code> property returns an<code class="literal"> NSDictionary</code> object that contains various information about the picked media. We retrieve the image passing the constant<code class="literal"> UIImagePickerController.OriginalImage</code> as a key. Because the values of the dictionary are of the type<code class="literal"> NSObject</code>, we cast the return value to a<code class="literal"> UIImage</code>. After we assign the image to the<code class="literal"> UIImageView</code> to be displayed, we dismiss the controller:<a id="id584" class="indexterm"/>
</p><div class="informalexample"><pre class="programlisting">this.imagePicker.DismissModalViewControllerAnimated(true);
</pre></div><p>The<code class="literal"> Canceled</code> event is triggered when the user taps on the controller's<span class="strong"><strong> Cancel</strong></span> button. We must subscribe to it to dismiss the controller, because it will not be dismissed automatically when the user taps on the<span class="strong"><strong> Cancel</strong></span> button.</p></div><div class="section" title="There's more..."><div class="titlepage"><div><div><h2 class="title"><a id="ch07lvl2sec04"/>There's more...</h2></div></div></div><p>We can define the source of images/videos the image picker will read from, through its<code class="literal"> SourceType</code> property. In this example, we use<code class="literal"> UIImagePickerController.PhotoLibrary</code> because the simulator does not support the camera hardware.<a id="id585" class="indexterm"/>
</p><div class="section" title="Picking videos"><div class="titlepage"><div><div><h3 class="title"><a id="ch07lvl3sec01"/>Picking videos</h3></div></div></div><p>The<code class="literal"> UIImagePickerController</code> displays only images by default. To support videos, its<code class="literal"> MediaType</code> property must be set. It accepts a<code class="literal"> string[]</code>, with the specified media names:<a id="id586" class="indexterm"/>
</p><div class="informalexample"><pre class="programlisting">this.imagePicker.MediaTypes = new string[] { "public.image", "public.movie" };
</pre></div><p>To determine the media type the user has picked, we check the<code class="literal"> MediaType</code> key of the dictionary in the<code class="literal"> FinishedPickingMedia</code> handler. If it is a video, we get its URL with the<code class="literal"> MediaUrl</code> key:<a id="id587" class="indexterm"/>
</p><div class="informalexample"><pre class="programlisting">if (e.Info[UIImagePickerController.MediaType].ToString() == "public.movie"){
NSUrl mediaUrl = e.Info[UIImagePickerController.MediaURL] as NSUrl;
// Do something useful with the media url.
}
</pre></div></div></div><div class="section" title="See also"><div class="titlepage"><div><div><h2 class="title"><a id="ch07lvl2sec05"/>See also</h2></div></div></div><p>In this chapter:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><span class="emphasis"><em>Capturing media with the camera</em></span></li><li class="listitem" style="list-style-type: disc"><span class="emphasis"><em>Managing album items directly</em></span></li></ul></div></div></div>
<div class="section" title="Capturing media with the camera"><div class="titlepage"><div><div><h1 class="title"><a id="ch07lvl1sec03"/>Capturing media with the camera</h1></div></div></div><p>In this recipe, we will learn how to use the device camera for capturing media.<a id="id588" class="indexterm"/>
</p><div class="section" title="Getting ready"><div class="titlepage"><div><div><h2 class="title"><a id="ch07lvl2sec06"/>Getting ready</h2></div></div></div><p>Open the project<code class="literal"> ImagePickerApp</code>, discussed in the previous task.</p><div class="note" title="Note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title"><a id="note34"/>Note</h3><p>The camera functionality is not available on iOS simulator. This example can only run on the device. Refer to<a class="link" href="ch14.html" title="Chapter 14. Deploying"> Chapter 14</a>,<span class="emphasis"><em> Deploying</em></span> for More Information.</p></div></div><div class="section" title="How to do it..."><div class="titlepage"><div><div><h2 class="title"><a id="ch07lvl2sec07"/>How to do it...</h2></div></div></div><div class="orderedlist"><ol class="orderedlist"><li class="listitem"> Inside the<code class="literal"> ViewDidLoad</code> method, replace the following line:<div class="informalexample"><pre class="programlisting">this.imagePicker.SourceType = UIImagePickerControllerSourceType.PhotoLibrary;
</pre></div></li><li class="listitem">with this code block:<div class="informalexample"><pre class="programlisting">if (UIImagePickerController.IsSourceTypeAvailable( UIImagePickerControllerSourceType.Camera)){
this.imagePicker.SourceType = UIImagePickerControllerSourceType.Camera;
} else{
this.imagePicker.SourceType = UIImagePickerControllerSourceType.PhotoLibrary;
}
</pre></div></li><li class="listitem"> In the<code class="literal"> FinishedPickingMedia</code> handler, add the following code before the dismissal of the image picker:<div class="informalexample"><pre class="programlisting">pickedImage.SaveToPhotosAlbum(delegate( UIImage image, NSError error) {
if (null != error){
Console.WriteLine("Image not saved! Message: {0}", error.LocalizedDescription);
}
} );
</pre></div></li><li class="listitem"> Compile and run the application on the device.</li><li class="listitem"> Tap the button to open the camera and take a picture. The picture will be saved to the device album.</li></ol></div></div><div class="section" title="How it works..."><div class="titlepage"><div><div><h2 class="title"><a id="ch07lvl2sec08"/>How it works...</h2></div></div></div><p>Before presenting the camera viewfinder, we have to make sure that the device the application is running on actually has the appropriate hardware. We do this by calling the static<code class="literal"> IsSourceTypeAvailable</code> method of the<code class="literal"> UIImagePickerController</code> class:<a id="id589" class="indexterm"/>
</p><div class="informalexample"><pre class="programlisting">if (UIImagePickerController.IsSourceTypeAvailable( UIImagePickerControllerSourceType.Camera))
</pre></div><p>If it returns<code class="literal"> true</code>, we set the source type to<code class="literal"> Camera:</code>
</p><div class="informalexample"><pre class="programlisting">this.imagePicker.SourceType = UIImagePickerControllerSourceType.Camera;
</pre></div><p>This will cause the image picker controller to start the camera device instead of loading the device albums.</p><p>When the user takes a photo (or video), it is not automatically saved on the device. To save it, we use the<code class="literal"> SaveToPhotosAlbum</code> method of the<code class="literal"> UIImage</code> class. This method accepts a delegate of type<code class="literal"> UIImage.SaveStatus</code>, which will report an error if something goes wrong:<a id="id590" class="indexterm"/>
</p><div class="informalexample"><pre class="programlisting">if (null != error){
Console.WriteLine("Image not saved! Message: {0}", error.LocalizedDescription);
}
</pre></div></div><div class="section" title="There's more..."><div class="titlepage"><div><div><h2 class="title"><a id="ch07lvl2sec09"/>There's more...</h2></div></div></div><p>The camera view can also be customized. To disable the default camera controls, set the<code class="literal"> ShowsCameraControls</code> property to<code class="literal"> false</code>. Then, pass a custom view with the controls you want to the<code class="literal"> CameraOverlayView</code> property. To trigger the shutter of the camera, call the<code class="literal"> TakePicture</code> method.<a id="id591" class="indexterm"/>
</p><div class="section" title="Image editing"><div class="titlepage"><div><div><h3 class="title"><a id="ch07lvl3sec02"/>Image editing</h3></div></div></div><p>The camera supports a simple editing function, after capturing an image. This editing function allows the user to select a specific part of the image and even zoom to a specific area. To present the editing controls, set the<code class="literal"> AllowsEditing</code> property to<code class="literal"> true</code>. The edited image can be retrieved from the dictionary in the<code class="literal"> FinishedPickingMedia</code> handler, passing the<code class="literal"> UIImagePickerController.EditedImage</code> key. The editing interface is shown in the following screenshot:<a id="id592" class="indexterm"/>
</p><div class="mediaobject"><img src="graphics/1468EXP_07_02.jpg" alt="Image editing"/></div></div></div><div class="section" title="See also"><div class="titlepage"><div><div><h2 class="title"><a id="ch07lvl2sec10"/>See also</h2></div></div></div><p>In this chapter:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><span class="emphasis"><em>Selecting images and videos</em></span></li></ul></div></div></div>
<div class="section" title="Playing video"><div class="titlepage"><div><div><h1 class="title"><a id="ch07lvl1sec04"/>Playing video</h1></div></div></div><p>In this recipe, we will learn how to display a video player interface and play video files.<a id="id593" class="indexterm"/>
</p><div class="section" title="Getting ready"><div class="titlepage"><div><div><h2 class="title"><a id="ch07lvl2sec11"/>Getting ready</h2></div></div></div><p>Create a new project in MonoDevelop and name it<code class="literal"> PlayVideoApp</code>.</p></div><div class="section" title="How to do it..."><div class="titlepage"><div><div><h2 class="title"><a id="ch07lvl2sec12"/>How to do it...</h2></div></div></div><div class="orderedlist"><ol class="orderedlist"><li class="listitem"> Add a button on the main view of<code class="literal"> MainController</code>.</li><li class="listitem"> Add a video file to the project, and set its<span class="strong"><strong> Build Action</strong></span> to<span class="strong"><strong> Content</strong></span>.</li><li class="listitem"> Enter the following<code class="literal"> using</code> directive in the<code class="literal"> MainController.cs</code> file:<div class="informalexample"><pre class="programlisting">using MonoTouch.MediaPlayer;
</pre></div></li><li class="listitem"> Override the<code class="literal"> ViewDidLoad</code> method of the<code class="literal"> MainController</code> class, and enter the following code:<div class="informalexample"><pre class="programlisting">this.moviePlayer = new MPMoviePlayerController( new NSUrl("videos/video.mov"));
this.moviePlayer.View.Frame = this.View.Bounds;
this.View.AddSubview(this.moviePlayer.View);

<span class="strong"><strong>this.playbackStateChanged = NSNotificationCenter.DefaultCenter.AddObserver( MPMoviePlayerController.PlaybackStateDidChangeNotification, this.MoviePlayer_PlaybackStateChanged)</strong></span>;<span class="strong"><strong>this.finishedPlaying = NSNotificationCenter.DefaultCenter.AddObserver( MPMoviePlayerController.PlaybackDidFinishNotification, this.MoviePlayer_FinishedPlayback);</strong></span>
this.buttonPlay.TouchUpInside += delegate {
this.moviePlayer.Play();
} ;
</pre></div></li><li class="listitem"> Enter the following methods in the<code class="literal"> MainController</code> class:<div class="informalexample"><pre class="programlisting">private void MoviePlayer_PlaybackStateChanged(NSNotification ntf){
Console.WriteLine("Movie player load state changed: {0}", this.moviePlayer.PlaybackState);
}
private void MoviePlayer_FinishedPlayback(NSNotification ntf){
Console.WriteLine("Movie player finished playing.");
}
</pre></div></li><li class="listitem"> Compile and run the application on the simulator.</li><li class="listitem"> Tap on the button and the video will load and start playing. Watch the messages displayed in the<span class="strong"><strong> Application Output</strong></span> in MonoDevelop.</li></ol></div><div class="section" title="How it works..."><div class="titlepage"><div><div><h3 class="title"><a id="ch07lvl2sec13"/>How it works...</h3></div></div></div><p>The<code class="literal"> MPMoviePlayerController</code> plays video files stored locally or streamed from the network. We initialize it with the constructor that accepts an<code class="literal"> NSUrl</code> parameter:<a id="id594" class="indexterm"/>
</p><div class="informalexample"><pre class="programlisting">this.moviePlayer = new MPMoviePlayerController( new NSUrl("videos/video.mov"));
</pre></div><p>The<code class="literal"> NSUrl</code> object maps to the local file we have added to the project.<a id="id595" class="indexterm"/>
</p><p>After creating the instance, we define a frame for its view and add it to our view:</p><div class="informalexample"><pre class="programlisting">this.moviePlayer.View.Frame = this.View.Bounds;
this.View.AddSubview(this.moviePlayer.View);
</pre></div><p>The highlighted code adds observers to the default notification center, so that we will be notified when the state of the playback changes or has finished. Then, we call its<code class="literal"> Play</code> method and the view of the<code class="literal"> MPMoviePlayerController</code> is displayed, and the video starts playing.</p><p>Inside the<code class="literal"> MoviePlayer_PlaybackStateChanged</code> method, we output the<code class="literal"> PlaybackState</code> property:</p><div class="informalexample"><pre class="programlisting">Console.WriteLine("Movie player load state changed: {0}", this.moviePlayer.PlaybackState);
</pre></div><p>This property informs us of the status of the playback, such as<code class="literal"> Paused, Playing, SeekingForward, SeekingBackward</code>, and so on.</p></div><div class="section" title="There's more..."><div class="titlepage"><div><div><h3 class="title"><a id="ch07lvl2sec14"/>There's more...</h3></div></div></div><p>Apart from the ones used in this example, we can add observers for more notifications of an<code class="literal"> MPMoviePlayerController</code>, some of which are:<a id="id596" class="indexterm"/>
</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><code class="literal">DidEnterFullscreenNotification:</code> This notifies that the user has tapped the full-screen control, and the controller has entered<code class="literal"> fullscreen</code> mode.<a id="id597" class="indexterm"/></li><li class="listitem" style="list-style-type: disc"><code class="literal">DidExitFullscreenNotification:</code> This notifies that the controller has left<code class="literal"> fullscreen</code> mode.<a id="id598" class="indexterm"/></li><li class="listitem" style="list-style-type: disc"><code class="literal">DurationAvailableNotification:</code> This notifies that the controller has received information on the duration of the video.<a id="id599" class="indexterm"/></li><li class="listitem" style="list-style-type: disc"><code class="literal">LoadStateDidChangeNotification:</code> This notification is useful for network playback and is triggered when the controller has finished preloading the media in the buffer.<a id="id600" class="indexterm"/></li><li class="listitem" style="list-style-type: disc"><code class="literal">NaturalSizeAvailableNotification:</code> This notification is triggered when the dimensions of the movie frame are made available. The size can be retrieved through the player's<code class="literal"> NaturalSize</code> property.<a id="id601" class="indexterm"/></li><li class="listitem" style="list-style-type: disc"><code class="literal">NowPlayingMovieDidChangeNotification:</code> This notification is triggered when the video content of the player has changed. The current content is available through its<code class="literal"> ContentUrl</code> property.<a id="id602" class="indexterm"/></li></ul></div><div class="section" title="Wireless streaming"><div class="titlepage"><div><div><h4 class="title"><a id="ch07lvl3sec03"/>Wireless streaming</h4></div></div></div><p>Starting with iOS version 4.3, the<code class="literal"> MPMoviePlayerController</code> can be used to stream video to Apple's AirPlay-enabled devices. To enable it, set its<code class="literal"> AllowsAirPlay</code> property to<code class="literal"> true</code>. When the<code class="literal"> MPMoviePlayerController</code> is displayed, it will present an interface that will allow the user to select the devices it detects.<a id="id603" class="indexterm"/>
</p></div></div><div class="section" title="See also"><div class="titlepage"><div><div><h3 class="title"><a id="ch07lvl2sec15"/>See also</h3></div></div></div><p>In this chapter:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><span class="emphasis"><em>Playing music and sounds</em></span></li></ul></div></div></div></div>
<div class="section" title="Playing music and sounds"><div class="titlepage"><div><div><h1 class="title"><a id="ch07lvl1sec05"/>Playing music and sounds</h1></div></div></div><p>In this recipe, we will learn how to play simple audio files and songs stored on the device.<a id="id604" class="indexterm"/>
</p><div class="section" title="Getting ready"><div class="titlepage"><div><div><h2 class="title"><a id="ch07lvl2sec16"/>Getting ready</h2></div></div></div><p>Create a new project in MonoDevelop, and name it<code class="literal"> PlayMusicApp</code>.</p><div class="note" title="Note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title"><a id="note35"/>Note</h3><p>This example will not work on the simulator. You will also need at least one song stored on the device.</p></div></div><div class="section" title="How to do it..."><div class="titlepage"><div><div><h2 class="title"><a id="ch07lvl2sec17"/>How to do it...</h2></div></div></div><div class="orderedlist"><ol class="orderedlist"><li class="listitem"> Add three buttons on the view of<code class="literal"> MainController</code>.</li><li class="listitem"> Add the following<code class="literal"> using</code> directive in the<code class="literal"> MainController.cs</code> file:<div class="informalexample"><pre class="programlisting">using MonoTouch.MediaPlayer;
</pre></div></li><li class="listitem"> Add two fields in the class:<div class="informalexample"><pre class="programlisting">private MPMusicPlayerController musicPlayerController;
private MPMediaPickerController mediaPicker;
</pre></div></li><li class="listitem"> Override the<code class="literal"> ViewDidLoad</code> method of the<code class="literal"> MainController</code> class, and enter the following code:<div class="informalexample"><pre class="programlisting">this.mediaPicker = new MPMediaPickerController(MPMediaType.Music);
this.mediaPicker.ItemsPicked += MediaPicker_ItemsPicked;
this.mediaPicker.DidCancel += MediaPicker_DidCancel;
<span class="strong"><strong>this.musicPlayerController = MPMusicPlayerController.ApplicationMusicPlayer;</strong></span>
this.buttonSelectSongs.TouchUpInside += delegate {
this.PresentModalViewController(this.mediaPicker, true);
} ;
this.buttonPlay.TouchUpInside += delegate {
this.musicPlayerController.Play();
} ;
this.buttonStop.TouchUpInside += delegate {
this.musicPlayerController.Stop();
} ;
</pre></div></li><li class="listitem"> Add the following methods:<div class="informalexample"><pre class="programlisting">private void MediaPicker_ItemsPicked ( object sender, ItemsPickedEventArgs e){
this.musicPlayerController.SetQueue(e.MediaItemCollection);
this.DismissModalViewControllerAnimated(true);
}
private void MediaPicker_DidCancel (object sender, EventArgs e){
this.mediaPicker.DismissModalViewControllerAnimated(true);
}
</pre></div></li><li class="listitem"> Compile and run the application on the device.</li><li class="listitem"> Tap the<span class="strong"><strong> Select songs</strong></span> button, and select one or more songs.</li></ol></div><div class="section" title="How it works..."><div class="titlepage"><div><div><h3 class="title"><a id="ch07lvl2sec18"/>How it works...</h3></div></div></div><p>The<code class="literal"> MPMediaPickerController</code> provides the same user interface as the native iPod application. The<code class="literal"> MPMusicPlayerController</code> is responsible for playing the songs stored on the device.<a id="id605" class="indexterm"/>
</p><p>We first initialize the media picker, passing the type of media we want it to look for in its constructor:</p><div class="informalexample"><pre class="programlisting">this.mediaPicker = new MPMediaPickerController(MPMediaType.Music);
</pre></div><p>After that, we subscribe to its<code class="literal"> ItemsPicked</code> and<code class="literal"> DidCancel</code> events so that we can capture feedback from the user:</p><div class="informalexample"><pre class="programlisting">this.mediaPicker.ItemsPicked += MediaPicker_ItemsPicked;
this.mediaPicker.DidCancel += MediaPicker_DidCancel;
</pre></div><p>The highlighted code shows how to initialize the music player object. The option demonstrated here,<code class="literal"> MPMusicPlayerController.ApplicationMusicPlayer</code>, creates an instance that is specific only to the application. The other option available,<code class="literal"> MPMusicPlayerController.iPodMusicPlayer</code>, creates an instance that allows media to be played even if the application is in the background, similar to the iPod application.<a id="id606" class="indexterm"/>
</p><p>In the<code class="literal"> MediaPicker_ItemsPicked</code> handler, we set the songs that were picked by the user to the music player, through its<code class="literal"> SetQueue</code> method:<a id="id607" class="indexterm"/>
</p><div class="informalexample"><pre class="programlisting">this.musicPlayerController.SetQueue(e.MediaItemCollection);
</pre></div><p>After that, we dismiss the modal media picker controller. Playing and stopping songs is achieved through the<code class="literal"> Play()</code> and<code class="literal"> Stop()</code> methods respectively of<code class="literal"> MPMusicPlayerController</code>.<a id="id608" class="indexterm"/>
</p></div><div class="section" title="There's more..."><div class="titlepage"><div><div><h3 class="title"><a id="ch07lvl2sec19"/>There's more...</h3></div></div></div><p>The<code class="literal"> MPMusicPlayerController</code> holds information on the currently playing item. This information can be accessed through its<code class="literal"> NowPlayingItem</code> property. It is of the type<code class="literal"> MPMediaItem</code> and holds various types of information of the currently playing media. The following example gets the title of the song that is being played:<a id="id609" class="indexterm"/>
</p><div class="informalexample"><pre class="programlisting">Console.WriteLine(this.musicPlayerController .NowPlayingItem.ValueForProperty(MPMediaItem.TitleProperty));
</pre></div><div class="section" title="Playing sound files"><div class="titlepage"><div><div><h4 class="title"><a id="ch07lvl3sec04"/>Playing sound files</h4></div></div></div><p>The<code class="literal"> MPMusicPlayerController</code> is an object that is specifically designed to manage and play items and playlists stored on the device's iPod library.<a id="id610" class="indexterm"/>
</p><p>For playing simple sound files, MonoTouch provides another wrapper to iOS' class,<code class="literal"> AVAudioPlayer</code>. The following is an example of its most simple usage:</p><div class="informalexample"><pre class="programlisting">using MonoTouch.AVFoundation;
//...
AVAudioPlayer audioPlayer = AVAudioPlayer.FromUrl( new NSUrl("path/to/sound file"));
audioPlayer.Play();
</pre></div></div></div><div class="section" title="See also"><div class="titlepage"><div><div><h3 class="title"><a id="ch07lvl2sec20"/>See also</h3></div></div></div><p>In this chapter:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><span class="emphasis"><em>Playing video</em></span></li></ul></div></div></div></div>
<div class="section" title="Recording with the microphone"><div class="titlepage"><div><div><h1 class="title"><a id="ch07lvl1sec06"/>Recording with the microphone</h1></div></div></div><p>In this recipe, we will learn how to use the device's microphone to record sounds.<a id="id611" class="indexterm"/>
</p><div class="section" title="Getting ready"><div class="titlepage"><div><div><h2 class="title"><a id="ch07lvl2sec21"/>Getting ready</h2></div></div></div><p>Create a new project in MonoDevelop, and name it<code class="literal"> RecordSoundApp</code>.</p><div class="note" title="Note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title"><a id="note36"/>Note</h3><p>This example will not work on the simulator.</p></div></div><div class="section" title="How to do it..."><div class="titlepage"><div><div><h2 class="title"><a id="ch07lvl2sec22"/>How to do it...</h2></div></div></div><div class="orderedlist"><ol class="orderedlist"><li class="listitem"> Add two buttons on the view of<code class="literal"> MainController</code>.</li><li class="listitem"> Enter the following<code class="literal"> using</code> directives in the<code class="literal"> MainController.cs</code> file:<div class="informalexample"><pre class="programlisting">using System.IO;
using MonoTouch.AVFoundation;
using MonoTouch.AudioToolbox;
</pre></div></li><li class="listitem"> Override the<code class="literal"> ViewDidLoad</code> method, and add the following code in it:<div class="informalexample"><pre class="programlisting">string soundFile = Path.Combine(Environment.GetFolderPath( Environment.SpecialFolder.Personal), "sound.wav");
NSUrl soundFileUrl = new NSUrl(soundFile);
NSDictionary recordingSettings = NSDictionary.FromObjectAndKey( AVAudioSettings.AVFormatIDKey, NSNumber.FromInt32((int) AudioFileType.WAVE));
NSError error = null;
this.audioRecorder = AVAudioRecorder.ToUrl( soundFileUrl, recordingSettings, out error);
this.buttonStart.TouchUpInside += delegate {
this.audioRecorder.Record();
} ;
this.buttonStop.TouchUpInside += delegate {
this.audioRecorder.Stop();
AVAudioPlayer player = AVAudioPlayer.FromUrl(soundFileUrl);
player.Play();
} ;
</pre></div></li><li class="listitem"> Compile and run the application on the device.</li><li class="listitem"> Tap the<span class="strong"><strong> Start recording</strong></span> button to start recording audio, for example, say something to record your voice.</li><li class="listitem"> Tap the<span class="strong"><strong> Stop recording</strong></span> button to stop recording and listen to the playback.</li></ol></div></div><div class="section" title="How it works..."><div class="titlepage"><div><div><h2 class="title"><a id="ch07lvl2sec23"/>How it works...</h2></div></div></div><p>The<code class="literal"> AVAudioRecorder</code> class provides the recording functionality. It does this by streaming the captured audio directly to the filesystem. To initialize an instance of<code class="literal"> AVAudioRecorder</code>, we use its static<code class="literal"> ToUrl</code> method:<a id="id612" class="indexterm"/>
</p><div class="informalexample"><pre class="programlisting">this.audioRecorder = AVAudioRecorder.ToUrl( soundFileUrl, recordingSettings, out error);
</pre></div><p>If the file that corresponds to the<code class="literal"> NSUrl</code> variable already exists, it will be overwritten.</p><p>The<code class="literal"> recordingSettings</code> variable is of type<code class="literal"> NSDictionary</code> and contains the settings for the output sound file. We must provide at least some minimal settings to the<code class="literal"> AVAudioRecorder</code> upon initialization. Here, we set the sound format to plain wav:</p><div class="informalexample"><pre class="programlisting">NSDictionary recordingSettings = NSDictionary.FromObjectAndKey( AVAudioSettings.AVFormatIDKey, NSNumber .FromInt32((int)AudioFileType.WAVE));
</pre></div><p>To instruct the recorder to start recording, we just call its<code class="literal"> Record()</code> method:</p><div class="informalexample"><pre class="programlisting">this.audioRecorder.Record();
</pre></div><p>When the user taps on the<span class="strong"><strong> Stop recording</strong></span> button, the recording stops, and the saved sound starts playing with the<code class="literal"> AVAudioPlayer:</code>
</p><div class="informalexample"><pre class="programlisting">this.audioRecorder.Stop();
AVAudioPlayer player = AVAudioPlayer.FromUrl(soundFileUrl);
player.Play();
</pre></div></div><div class="section" title="There's more..."><div class="titlepage"><div><div><h2 class="title"><a id="ch07lvl2sec24"/>There's more...</h2></div></div></div><p>The<code class="literal"> AVAudioRecorder</code> class also provides sound metering options. To enable sound metering, set its<code class="literal"> MeteringEnabled</code> property to<code class="literal"> true</code>. We can then output the peak power in decibels on a specific channel. To do this for the first channel of our recording, add the following code right after the<code class="literal"> Record()</code> method call:<a id="id613" class="indexterm"/>
</p><div class="informalexample"><pre class="programlisting">ThreadPool.QueueUserWorkItem(delegate {
while (this.audioRecorder.Recording){
this.audioRecorder.UpdateMeters();
Console.WriteLine(this.audioRecorder.PeakPower(0));
}
} );
</pre></div><p>The<code class="literal"> PeakPower</code> method accepts the zero-based index of the channel and returns the peak of the channel in decibels. Call<code class="literal"> UpdateMeters()</code> right before calling the<code class="literal"> PeakPower</code> method to get the most recent reading.<a id="id614" class="indexterm"/>
</p><p>Note that enabling metering on the recorder uses CPU resources. Do not enable it if you do not intend on using the metering values.</p><div class="section" title="Record for a pre-defined amount of time"><div class="titlepage"><div><div><h3 class="title"><a id="ch07lvl3sec05"/>Record for a pre-defined amount of time</h3></div></div></div><p>To record audio for a pre-defined amount of time, without the need for the user to stop the recording, call the<code class="literal"> RecordFor(double)</code> method. Its parameter specifies the amount of time in seconds for which to record.<a id="id615" class="indexterm"/>
</p></div></div><div class="section" title="See also"><div class="titlepage"><div><div><h2 class="title"><a id="ch07lvl2sec25"/>See also</h2></div></div></div><p>In this chapter:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><span class="emphasis"><em>Playing music and sounds</em></span></li></ul></div></div></div>
<div class="section" title="Managing multiple album items directly"><div class="titlepage"><div><div><h1 class="title"><a id="ch07lvl1sec07"/>Managing multiple album items directly</h1></div></div></div><p>In this recipe, we will discuss programmatically accessing the device's photo album.</p><div class="section" title="Getting ready"><div class="titlepage"><div><div><h2 class="title"><a id="ch07lvl2sec26"/>Getting ready</h2></div></div></div><p>Create a new project in MonoDevelop, and name it<code class="literal"> ManageAlbumApp</code>.<a id="id616" class="indexterm"/>
</p><div class="note" title="Note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title"><a id="note37"/>Note</h3><p>This example works on the simulator. At least one image must exist in the photo album.</p></div></div><div class="section" title="How to do it..."><div class="titlepage"><div><div><h2 class="title"><a id="ch07lvl2sec27"/>How to do it...</h2></div></div></div><div class="orderedlist"><ol class="orderedlist"><li class="listitem"> Add a button on the main view of<code class="literal"> MainController</code>.<a id="id617" class="indexterm"/></li><li class="listitem"> Enter the following<code class="literal"> using</code> directive in the<code class="literal"> MainController.cs</code> file:<div class="informalexample"><pre class="programlisting">using MonoTouch.AssetsLibrary;
</pre></div></li><li class="listitem"> Override the<code class="literal"> ViewDidLoad</code> method, and enter the following code in it:<div class="informalexample"><pre class="programlisting">this.buttonEnumerate.TouchUpInside += delegate {
this.assetsLibrary = new ALAssetsLibrary();
this.assetsLibrary.Enumerate(ALAssetsGroupType.All, this.GroupsEnumeration, this.GroupsEnumerationFailure);
} ;
</pre></div></li><li class="listitem"> Add the following methods in the class:<div class="informalexample"><pre class="programlisting">private void GroupsEnumeration(ALAssetsGroup assetGroup, ref bool stop){
if (null != assetGroup){
stop = false;
assetGroup.SetAssetsFilter(ALAssetsFilter.AllPhotos);
assetGroup.Enumerate(this.AssetEnumeration);
}
}
private void AssetEnumeration(ALAsset asset, int index, ref bool stop){
if (null != asset){
stop = false;
Console.WriteLine("Asset url: {0}", asset.DefaultRepresentation.Url.AbsoluteString);
}
}
private void GroupsEnumerationFailure(NSError error){
if (null != error){
Console.WriteLine("Error enumerating asset groups! Message: {0}", error.LocalizedDescription);
}
}
</pre></div></li><li class="listitem"> Compile and run the application.</li><li class="listitem"> Tap the<span class="strong"><strong> Enumerate assets</strong></span> button, and watch the URLs of saved photos being displayed in the<span class="strong"><strong> Application Output</strong></span> pad.</li></ol></div></div><div class="section" title="How it works..."><div class="titlepage"><div><div><h2 class="title"><a id="ch07lvl2sec28"/>How it works...</h2></div></div></div><p>The<code class="literal"> ALAssetsLibrary</code> class provides access to the album items of the device. These items are represented by the<code class="literal"> ALAsset</code> class and are divided into groups, represented by the<code class="literal"> ALAssetGroup</code> class.<a id="id618" class="indexterm"/>
</p><p>The first thing we need to do is to enumerate the asset groups. To do this, call the<code class="literal"> Enumerate</code> method:</p><div class="informalexample"><pre class="programlisting">this.assetsLibrary.Enumerate(ALAssetsGroupType.All, this.GroupsEnumeration, this.GroupsEnumerationFailure);
</pre></div><p>The first parameter is of the type<code class="literal"> ALAssetGroupTypes</code> and instructs the assets library on which asset groups to enumerate. Passing<code class="literal"> ALAssetGroupTypes.All</code> means we want to enumerate all asset groups. The other two parameters are delegate types. The<code class="literal"> GroupsEnumeration</code> method is where we read the group's data, while the<code class="literal"> GroupsEnumerationFailure</code> will occur if an error occurs. When the<code class="literal"> Enumerate</code> method is called for the first time, the user is asked to grant access to the application for accessing the device's assets. If the user denies access, the failure method will be triggered. The next time the<code class="literal"> Enumerate</code> method gets called, the access message appears again.</p><p>The signature of the<code class="literal"> GroupsEnumeration</code> method is the following:</p><div class="informalexample"><pre class="programlisting">private void GroupsEnumeration(ALAssetsGroup assetGroup, ref bool stop)
</pre></div><p>The<code class="literal"> assetGroup</code> parameter contains the group's information.<a id="id619" class="indexterm"/>
</p><p>Note the<code class="literal"> stop</code> parameter, which is declared as a<code class="literal"> ref</code>. When the enumeration occurs, the method is being triggered once to return the first group and does not get called for the second time, no matter how many more groups exists. To force it to keep getting called to enumerate all groups, we have to set the<code class="literal"> stop</code> variable to<code class="literal"> false</code>. When all groups have been enumerated, the method gets called one last time, with the<code class="literal"> assetGroup</code> variable set to<code class="literal"> null</code>. So, we need to check this. To put all this in code:</p><div class="informalexample"><pre class="programlisting">if (null != assetGroup){
// Continue enumerating
stop = false;
// Determine what assets to enumerate
assetGroup.SetAssetsFilter(ALAssetsFilter.AllPhotos);
// Enumerate assets
assetGroup.Enumerate(this.AssetEnumeration);
}
</pre></div><p>Calling the<code class="literal"> SetAssetsFilter</code> method on the instance of<code class="literal"> ALAssetGroup</code> class, we instruct it to filter what types of assets we want it to look for. After this, the process is similar to the groups enumeration. The<code class="literal"> ALAssetGroup</code> class also contains an<code class="literal"> Enumerate</code> method. It accepts a parameter of a delegate type, represented here by the<code class="literal"> AssetsEnumeration</code> method. Its implementation is similar to the<code class="literal"> GroupsEnumeration</code> method:<a id="id620" class="indexterm"/>
</p><div class="informalexample"><pre class="programlisting">if (null != asset){
// Continue enumerating assets
stop = false;
// Output the asset url
Console.WriteLine("Asset url: {0}", asset.DefaultRepresentation.Url.AbsoluteString);
</pre></div><p>The<code class="literal"> ALAsset</code> class contains various information and properties. Most information is stored in its<code class="literal"> DefaultRepresentation</code> property, which is of the type<code class="literal"> ALAssetRepresentation</code>.<a id="id621" class="indexterm"/>
</p></div><div class="section" title="There's more..."><div class="titlepage"><div><div><h2 class="title"><a id="ch07lvl2sec29"/>There's more...</h2></div></div></div><p>If the asset we are interested in is an image, we can get the actual image through the<code class="literal"> DefaultRepresentation</code> property:<a id="id622" class="indexterm"/>
</p><div class="informalexample"><pre class="programlisting">CGImage image = asset.DefaultRepresentation.GetImage();
</pre></div><div class="section" title="Reading EXIF data"><div class="titlepage"><div><div><h3 class="title"><a id="ch07lvl3sec06"/>Reading EXIF data</h3></div></div></div><p>We can read a photo's<span class="strong"><strong> EXchangeable Image File format</strong></span> (EXIF) metadata, through the<code class="literal"> Metadata</code> property of<code class="literal"> ALAssetRepresentation</code>, which is of the type<code class="literal"> NSDictionary</code>, as follows:<a id="id623" class="indexterm"/>
</p><div class="informalexample"><pre class="programlisting">NSDictionary metaData = asset.DefaultRepresentation.Metadata;
if (null != metaData){
NSDictionary exifData = (NSDictionary)metaData[ new NSString("{Exif}")];
}
</pre></div></div><div class="section" title="Retrieving individual assets"><div class="titlepage"><div><div><h3 class="title"><a id="ch07lvl3sec07"/>Retrieving individual assets</h3></div></div></div><p>We can also retrieve an individual asset if we know the asset's URL, through the<code class="literal"> AssetForUrl</code> method of<code class="literal"> ALAssetLibrary</code>.<a id="id624" class="indexterm"/>
</p></div></div><div class="section" title="See also"><div class="titlepage"><div><div><h2 class="title"><a id="ch07lvl2sec30"/>See also</h2></div></div></div><p>In this chapter:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><span class="emphasis"><em>Selecting images and videos</em></span></li></ul></div></div></div></body></html>