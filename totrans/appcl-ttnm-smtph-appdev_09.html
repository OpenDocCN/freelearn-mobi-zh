<html><head></head><body><div><div><div><div><h1 class="title"><a id="ch09"/>Chapter 9. Integrating your Apps with External Services</h1></div></div></div><p>In this chapter, we will cover:</p><div><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">Connecting to APIs that use basic authentication</li><li class="listitem" style="list-style-type: disc">Fetching data from the Google Places API</li><li class="listitem" style="list-style-type: disc">Connecting to FourSquare using OAuth</li><li class="listitem" style="list-style-type: disc">Posting a check-in to FourSquare</li><li class="listitem" style="list-style-type: disc">Searching and retrieving data via Yahoo! YQL</li><li class="listitem" style="list-style-type: disc">Integrating push notifications with UrbanAirship.com</li><li class="listitem" style="list-style-type: disc">Testing push notifications using PHP and HTTP POST</li></ul></div><div><div><div><div><h1 class="title"><a id="ch09lvl1sec01"/>Introduction</h1></div></div></div><p>Many mobile applications are self-contained programs (such as a Calculator app) and have no need to interact with other services or systems. However, will find that as you build more and more, it will start to become necessary to integrate with external vendors and systems in order to keep your users happy. The recent trend towards integrating Facebook "like" buttons and the ability to Tweet from within an app are excellent examples of this.</p><p>In this chapter, we are going to be concentrating on talking to a variety of different service providers in a number of common ways, including basic authorization, open authorization, and using a service provider (such as Urban Airship), coupled with some PHP code, to make push notifications work on your iPhone.</p></div></div>
<div><div><div><div><h1 class="title"><a id="ch09lvl1sec02"/>Connecting to APIs that use basic authentication</h1></div></div></div><p>Basic authentication is a method for gaining access to a system by way of Base64 encoding using the username and password credentials before sending them over HTTP. For example, given the username 'Aladdin' and password 'open sesame', the string 'Aladdin:open sesame' is Base64 encoded, resulting in 'QWxhZGRpbjpvcGVuIHNlc2FtZQ=='. This Base64 string is then decoded by the receiving server, resulting in the original username-password string separated by a colon. While this is not the most secure of authentication schemes, it is unreadable to the human eye, and for small APIs or private systems it is very easily implemented. All web browsers from the HTTP/1.1 support basic authentication, so it can be widely implemented across both the Web and mobile devices without being concerned about browser support.<a id="id319" class="indexterm"/>
</p><p>Many external services use basic authentication and session keys in order for you to access and interact with their APIs. In this example, I will show you how to access the Blurtit API using the basic authentication mechanism. The basic principles of this recipe should work for any other standard API that uses basic authentication as well.</p><div><div><div><div><h2 class="title"><a id="ch09lvl2sec01"/>Getting ready</h2></div></div></div><p>Blurtit is a free online question and answer system, much like Yahoo! Answers, or many of the other Q&amp;A style message boards that are on the Web. You will need to set up an account with Blurtit.com and register for their API, which is at<a class="ulink" href="http://api.blurtit.com"> http://api.blurtit.com</a>. After registering, you will be given a user ID, API key, login name, and password. You'll need these four items in order to connect to the API and retrieve data.<a id="id320" class="indexterm"/>
</p><div><h3 class="title"><a id="note61"/>Note</h3><p>The complete source code for this recipe can be found in the<code class="literal"> /Chapter 9/Recipe 1</code> folder.</p></div></div><div><div><div><div><h2 class="title"><a id="ch09lvl2sec02"/>How to do it…</h2></div></div></div><p>Create a new project in Titanium Studio, and open up the<code class="literal"> app.js</code> file, removing all of the existing code. First, we'll create some variables which will contain your API key, user ID, username, password, and the URL to the API. Make sure you replace the<code class="literal"> loginName</code> and<code class="literal"> loginPassword</code> variable values in the following code with the login information given to you when you signed up for the API in the<em> Getting ready</em> section:<a id="id321" class="indexterm"/>
</p><div><pre class="programlisting">var win = Titanium.UI.createWindow();
var userid = '123456';
var apikey = 'B_1a0350b39b19a05************';
var loginName = 'b****@gmail.com';
var loginPasswd = '******';
var apiUrl = 'http://api.blurtit.com/users/signin.json';
</pre></div><p>Now, to do the basic authentication, we need to create a request header. This information gets sent after your<strong> xhr</strong>
<code class="literal"> httpClient</code> object is declared, but before you execute the<code class="literal"> send</code> method:<a id="id322" class="indexterm"/>
</p><div><pre class="programlisting">var xhr = Titanium.Network.createHTTPClient();
xhr.open('POST', apiUrl);
authstr = 'Basic ' + Titanium.Utils.base64encode(userid+':'+apikey);
xhr.setRequestHeader('Authorization', authstr);
</pre></div><p>Next, create your parameter array based on the Blurtit API. In this case, we're passing in our<code class="literal"> login_name</code> and<code class="literal"> password</code> variables to perform a<code class="literal"> signin</code> request. Attach the<code class="literal"> params</code> array to your<code class="literal"> xhr.send()</code> method like so:</p><div><pre class="programlisting">var params = {
'login_name': loginName,
'password': loginPasswd
};
xhr.send(params);
</pre></div><p>Finally, in the<code class="literal"> xhr.onload()</code> method, read in the<code class="literal"> responseText</code> and assign it to a JSON object. We can then read in the returned data (in this case, a session ID) and we'll assign it to a label for display purposes:<a id="id323" class="indexterm"/>
</p><div><pre class="programlisting">//create and add the label to the window
var lblsession = Titanium.UI.createLabel({
width: 280,
height: 'auto',
textAlign: 'center'
});
win.add(lblsession);
//execute our onload function and assign the result to
//our lblsession control
xhr.onload = function() {
Titanium.API.info(' Text: ' + this.responseText);
var jsonObject = JSON.parse(this.responseText);
lblsession.text = "Session ID: \n" +
jsonObject.user.session_id;
};
//finally open the window
win.open();
</pre></div><p>Now that we have authorized and stored our session variable, we can call the functions available to us on the Blurtit API. The following is a sample which asks the API a simple question and then logs the JSON response to the console:</p><div><pre class="programlisting">function callAPI(apiFunction, params)
{
var xhr = Titanium.Network.createHTTPClient();
Ti.API.info('Session ID = ' + sessionid);
xhr.onload = function() {
//this is the response data to our question
Titanium.API.info(' Text: ' + this.responseText);
var jsonObject = JSON.parse(this.responseText);
};
xhr.open('POST', apiUrl + apiFunction);
authstr = 'Basic '+
Titanium.Utils.base64encode(userid+':'+apikey);
xhr.setRequestHeader('Authorization', authstr);
xhr.send(params);
}
var params = {
'session_id': sessionid,
'query': "Who is Britney Spears?"
};
//call the api with your session_id and question_id
callAPI('questions/search.json?query=' +
txtQuestion.value, params);
</pre></div></div><div><div><div><div><h2 class="title"><a id="ch09lvl2sec03"/>How it works…</h2></div></div></div><p>The basic authentication system works on the principle of authenticating and receiving a session token which can then be used in every following API call as a means of indentifying yourself to the server. This session variable is passed in as a parameter for every call to the system you will make. This can be seen in our previous code where we are calling the search questions method (<code class="literal">questions/search.json?query=xxx</code>).<a id="id324" class="indexterm"/>
</p><div><h3 class="title"><a id="note62"/>Note</h3><p>It should be noted that security is not the purpose of encoding the username and password variables into a Base64 string. Rather, it is done to ensure that possible non-HTTP compatible characters are encoded into values that are HTTP compatible. The basic authentication method is still widely in use on the Internet. However, it is being replaced with OAuth in many cases today. We will look at integrating with OAuth in one of the next recipes of this chapter.</p></div></div></div>
<div><div><div><div><h1 class="title"><a id="ch09lvl1sec03"/>Fetching data from the Google Places API</h1></div></div></div><p>The Google Places API is a new part of Google Maps and returns information about places (for example, banks, cash machines, services, airports, and more). It marks an attempt by Google to connect users directly to shops or items of interest near their location, and is heavily geared towards mobile usage. In this recipe, we will create a new module which will contain all of the code required to connect to, and return data from, the Google Places API.<a id="id325" class="indexterm"/>
</p><div><div><div><div><h2 class="title"><a id="ch09lvl2sec04"/>Getting ready</h2></div></div></div><p>You will require an API key from Google in order to perform requests against the Places API. You can obtain a key from Google's developer website here:<a class="ulink" href="http://https://code.google.com/apis/console"> https://code.google.com/apis/console</a>.<a id="id326" class="indexterm"/>
</p><div><h3 class="title"><a id="note63"/>Note</h3><p>Complete source code for this recipe can be found in the<code class="literal"> /Chapter 9/Recipe 2</code> folder.</p></div></div><div><div><div><div><h2 class="title"><a id="ch09lvl2sec05"/>How to do it…</h2></div></div></div><p>Create a new project in Titanium Studio, which you can give any name you want. Then, create a new file called<code class="literal"> placesapi.js</code> file, and save it to your project's<code class="literal"> Resources</code> directory. Type the following code into this new JavaScript file:</p><div><pre class="programlisting">var api = {
xhr: null
};
var places = (function() {
//create an object which will be our public API
//data format must be json or xml
api.getData = function(lat, lon, radius, types, name, sensor, success, error) {
if(api.xhr == null){
api.xhr = Titanium.Network.createHTTPClient();
}
var url =
"https://maps.googleapis.com/maps/api/place/search/json?";
url = url + "location=" + lat + ',' + lon;
url = url + "&amp;radius=" + radius;
url = url + "&amp;types=" + types;
url = url + "&amp;name=" + name;
url = url + "&amp;sensor=" + sensor;
url = url + "&amp;key="
+ Titanium.App.Properties.getString("googlePlacesAPIKey");
Ti.API.info(url);
api.xhr.open('GET', url);
api.xhr.setRequestHeader('Content-Type', 'application/json; charset=utf-8');
api.xhr.onerror = function(e){
Ti.API.error("API ERROR " + e.error);
if (error) {
error(e);
}
};
api.xhr.onload = function(){
Ti.API.debug("API response: " + this.responseText);
if (success) {
var jsonResponse = JSON.parse(this.responseText);
success(jsonResponse);
}
};
api.xhr.send();
};
//data format must be json or xml
api.getPlaceDetails = function(reference, sensor, success,
error) {
if(api.xhr == null){
api.xhr = Titanium.Network.createHTTPClient();
}
var url =
"https://maps.googleapis.com/maps/api/place/details/json?";
url = url + "reference=" + reference;
url = url + "&amp;sensor=" + sensor;
url = url + "&amp;key=" +
Titanium.App.Properties.getString("googlePlacesAPIKey");
//for debugging should you wish to check the URL
//Ti.API.info(url);
api.xhr.open('GET', url);
api.xhr.setRequestHeader('Content-Type', 'application/json;
charset=utf-8');
api.xhr.onerror = function(e){
Ti.API.error("API ERROR " + e.error);
if (error) {
error(e);
}
};
api.xhr.onload = function(){
Ti.API.debug("API response: " + this.responseText);
if (success) {
var jsonResponse = JSON.parse(this.responseText);
success(jsonResponse);
}
};
api.xhr.send();
};
//return our public API
return api;
} ());
</pre></div><p>Now open your<code class="literal"> app.js</code> file (or wherever you intend to call the Places module from), removing all of the existing code. Type in the following sample code in order to get data back using our API wrapper. Note that you can return XML data from this API in this example only using JSON, which should really be your de-facto standard for any mobile development. You will also need to replace the XXXXXXXXXXXXXXXXXXX API key with your own valid API key from Google.<a id="id327" class="indexterm"/>
</p><div><pre class="programlisting">//include our placesapi.js module we created earlier
Ti.include('placesapi.js');
//Types array
var types = ['airport', 'atm', 'bank', 'bar', 'parking', 'pet_store', 'pharmacy', 'police', 'post_office', 'shopping_mall'];
Titanium.App.Properties.setString("googlePlacesAPIKey", "XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX");
//fetch banks and atm's
//note the types list is a very short sample of all the types of
//places available to you in the Places API
places.getData(-33.8670522, 151.1957362, 500, types[1] + "|" + types[2], '', 'false',
function(response) {
//getting an item out of the json response
Ti.API.info(response.results[1].name);
Ti.API.info(response.results[1].vicinity);
Ti.API.info(response.results[1].icon);
Ti.API.info(response.results[1].types[0]);
},
function(e) {
Titanium.UI.createAlertDialog({
title: "API call failed",
message: e,
buttonNames: ['OK']
}).show();
});
</pre></div><p>Run the sample application in the emulator and you should be able to get a JSON formatted list returned, and the first item in that list logged to the console. Try extending this sample to integrate with Google Maps using real-time location data! You can also get more detailed place information by calling the<code class="literal"> getPlaceDetails()</code> method of the API, for example:<a id="id328" class="indexterm"/>
</p><div><pre class="programlisting">places.getPlaceDetails(response.results[1].reference, 'false', function(response){
//log the json response to the console
Ti.API.info(response);
},
function(e){
//something went wrong
//log any errors etc...
});
</pre></div></div><div><div><div><div><h2 class="title"><a id="ch09lvl2sec06"/>How it works…</h2></div></div></div><div><h3 class="title"><a id="tip06"/>Tip</h3><p>The Places API is probably the simplest kind of service integration available. With it, there is no authentication method except requiring an API key and all of the parameters are passed via the query string using a HTTP GET.</p><p>The request header is one important feature of this method. Note that we need to set the content type to<code class="literal"> application/json</code> before performing our<code class="literal"> send()</code> call on the xhr object. Without setting the content type you run the risk of the data being returned to you in HTML or some other format that won't be 100 percent JSON compatible. Therefore, it would probably not load into a JSON object.</p></div><p>When the Places service returns JSON results from a search, it places them within a results array. Even if the service returns no results, it still returns an empty results array. Each element of the response contains a single place result from the area you specified by the latitude and longitude inputs, ordered by prominence. Many things, including the number of check-ins, can affect the prominence of results and therefore its popularity. The Google documentation provides the following information on the data returned for each place result (see<a class="ulink" href="http://code.google.com/apis/maps/documentation/places/)"> http://code.google.com/apis/maps/documentation/places/):</a>
</p><div><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><strong>name</strong> contains the human-readable name for the returned result. For<strong> establishment</strong> results, this is usually the business name.</li><li class="listitem" style="list-style-type: disc"><strong>vicinity</strong> contains a feature name of a nearby location. This feature often refers to a street or neighborhood within the given results.</li><li class="listitem" style="list-style-type: disc"><strong>types[]</strong> contains an array of feature types describing the given result.</li><li class="listitem" style="list-style-type: disc"><strong>geometry</strong> contains geometry information about the result, generally including the<strong> location</strong> (geocode) of the Place and (optionally) the<strong> viewport</strong> identifying its general area of coverage.</li><li class="listitem" style="list-style-type: disc"><strong>icon</strong> contains the URL of a recommended icon, which may be displayed to the user when indicating this result.</li><li class="listitem" style="list-style-type: disc"><strong>reference</strong> contains a unique token that you can use to retrieve additional information about this place. You can store this token and use it at any time in the future to refresh cached data about this Place, but the same token is not guaranteed to be returned for any given Place across different searches.</li><li class="listitem" style="list-style-type: disc"><strong>id</strong> contains a unique stable identifier denoting this place.</li></ul></div><p>There are many other features within the Places API, including the ability to "check-in" to a place and more. Additionally, you should also note that when including this recipe into a live application, part of Google's terms is that you must show the "powered by Google" logo in your application, unless the results you're displaying are already on a Google branded map.</p></div></div>
<div><div><div><div><h1 class="title"><a id="ch09lvl1sec04"/>Connecting to FourSquare using OAuth</h1></div></div></div><p>Open Authorization (known normally by its shortened name, OAuth) is an open standard developed for authorization, which allows a user to share private data stored on one site or device (e.g. your mobile phone) with another site. Instead of using credentials such as a username and password, OAuth relies on tokens instead. Each token has encoded within in it a series of details for a specific site (e.g. FourSquare or Twitter), using specific resources or permissions (for example, photos or your personal information) for a specific duration of time (for example, two hours).<a id="id329" class="indexterm"/>
</p><p>FourSquare is a popular location-based social networking site specifically made for GPS-enabled mobile devices. It allows you to check-in to various locations, and in doing so, earn points and rewards in the form of "badges". In this recipe, we will use OAuth to connect to FourSquare and retrieve an access token that we can use later on to enable our application to "check-in" to various locations within the FourSquare community.<a id="id330" class="indexterm"/>
</p><div><div><div><div><h2 class="title"><a id="ch09lvl2sec07"/>Getting ready</h2></div></div></div><p>You will need a Client ID key from FourSquare in order to perform requests against the FourSquare API. You can obtain a key from the developer website for free here:<a class="ulink" href="http://developer.foursquare.com"> http://developer.foursquare.com</a>.</p><div><h3 class="title"><a id="note64"/>Note</h3><p>The complete source code for this recipe can be found in the<code class="literal"> /Chapter 9/Recipe 3</code> folder.</p></div></div><div><div><div><div><h2 class="title"><a id="ch09lvl2sec08"/>How to do it…</h2></div></div></div><p>Create a new project in Titanium Studio, which you can give any name you want. Then, create a new file called<code class="literal"> fsq_module.js</code> and save it to your projects<code class="literal"> Resources</code> directory. This file will contain all of the needed source code to create a module that we can include anywhere in our Titanium app. Open your new<code class="literal"> fsq_module.js</code> file in your editor and type in the following:</p><div><pre class="programlisting">var FOURSQModule = {};
(function() {
FOURSQModule.init = function(clientId, redirectUri) {
FOURSQModule.clientId = clientId;
FOURSQModule.redirectUri = redirectUri;
FOURSQModule.ACCESS_TOKEN = null;
FOURSQModule.xhr = null;
FOURSQModule.API_URL = "https://api.foursquare.com/v2/";
};
FOURSQModule.logout = function() {
showAuthorizeUI(
String.format('https://foursquare.com/oauth2/authorize?response_type=token&amp;client_id=%s&amp;redirect_uri=%s',
FOURSQModule.clientId,
FOURSQModule.redirectUri)
);
return;
};
/**
* displays the familiar web login dialog
*
*/
FOURSQModule.login = function(authSuccess_callback) {
if (authSuccess_callback != undefined) {
FOURSQModule.success_callback = authSuccess_callback;
}
showAuthorizeUI(
String.format('https://foursquare.com/oauth2/authenticate?response_type=token&amp;client_id=%s&amp;redirect_uri=%s',
FOURSQModule.clientId,
FOURSQModule.redirectUri)
);
return;
};
FOURSQModule.closeFSQWindow = function() {
destroyAuthorizeUI();
};
/*
* display the familiar web login dialog
*/
function showAuthorizeUI(pUrl)
{
window = Ti.UI.createWindow({
modal: true,
fullscreen: true,
width: '100%'
});
var transform = Ti.UI.create2DMatrix().scale(0);
view = Ti.UI.createView({
top: 5,
width: '100%',
height: 450,
border: 10,
backgroundColor: 'white',
borderColor: '#aaa',
borderRadius: 20,
borderWidth: 5,
zIndex: -1,
transform: transform
});
closeLabel = Ti.UI.createLabel({
textAlign: 'right',
font: {
fontWeight: 'bold',
fontSize: '12pt'
},
text: '(X)',
top: 5,
right: 12,
height: 14
});
window.open();
webView = Ti.UI.createWebView({
top: 25,
width: '100%',
url: pUrl,
autoDetect: [Ti.UI.AUTODETECT_NONE]
});
Ti.API.debug('Setting:[' + Ti.UI.AUTODETECT_NONE + ']');
webView.addEventListener('beforeload',
function(e) {
if (e.url.indexOf('http://www.foursquare.com/') != -1) {
Titanium.API.debug(e);
authorizeUICallback(e);
webView.stopLoading = true;
}
});
webView.addEventListener('load', authorizeUICallback);
view.add(webView);
closeLabel.addEventListener('click', destroyAuthorizeUI);
view.add(closeLabel);
window.add(view);
var animation = Ti.UI.createAnimation();
animation.transform = Ti.UI.create2DMatrix();
animation.duration = 500;
view.animate(animation);
};
/*
* unloads the UI used to have the user authorize the application
*/
function destroyAuthorizeUI()
{
Ti.API.debug('destroyAuthorizeUI');
// if the window doesn't exist, exit
if (window == null) {
return;
}
// remove the UI
try
{
Ti.API.debug('destroyAuthorizeUI:webView.removeEventListener');
webView.removeEventListener('load', authorizeUICallback);
Ti.API.debug('destroyAuthorizeUI:window.close()');
window.hide();
}
catch(ex)
{
Ti.API.debug('Cannot destroy the authorize UI. Ignoring.');
}
};
/*
* fires and event when login fails
*/
function authorizeUICallback(e)
{
Ti.API.debug('authorizeUILoaded ' + e.url);
Titanium.API.debug(e);
if (e.url.indexOf('#access_token') != -1)
{
var token = e.url.split("=")[1];
FOURSQModule.ACCESS_TOKEN = token;
Ti.App.fireEvent('app:4square_token', {
data: token
});
if (FOURSQModule.success_callback != undefined) {
FOURSQModule.success_callback({
access_token: token,
});
}
destroyAuthorizeUI();
} else if ('http://foursquare.com/' == e.url) {
Ti.App.fireEvent('app:4square_logout', {});
destroyAuthorizeUI();
} else if (e.url.indexOf('#error=access_denied') != -1) {
Ti.App.fireEvent('app:4square_access_denied', {});
destroyAuthorizeUI();
}
};
})();
</pre></div><p>Now, back in your<code class="literal"> app.js</code> file, type in the following code to include the new FourSquare module and execute the sign-in function:<a id="id331" class="indexterm"/>
</p><div><pre class="programlisting">function loginSuccess(e) {
alert('You have successfully logged into 4SQ!");
};
FOURSQModule.init('yourclientid', 'http://www.yourfoursquareurl.com');
FOURSQModule.login(loginSuccess, function(e) {
Titanium.UI.createAlertDialog({
title: "LOGIN FAILED",
message: e,
buttonNames: ['OK']
}).show();
});
</pre></div><p>Try running your application in either the Android or iPhone emulator. You should get a login screen appear on startup that looks similar to the one in the following screenshot:<a id="id332" class="indexterm"/>
</p><div><img src="img/3968_09_01.jpg" alt="How to do it…"/></div></div><div><div><div><div><h2 class="title"><a id="ch09lvl2sec09"/>How it works…</h2></div></div></div><p>The module we have built in this recipe follows a pattern and style that is very similar to others found on the Web, including modules that have been built for Titanium against Facebook, Twitter, and others. It consists of creating a modal view that "pops" up over top of the existing window, and contains a webview to the mobile version of the FourSquare login page. Once the user has logged into the system, we can then grab the access token from the response in the<code class="literal"> authorizeCallBack()</code> method, and save the resulting token to our module's<code class="literal"> ACCESS_TOKEN</code> property.<a id="id333" class="indexterm"/>
</p></div></div>
<div><div><div><div><h1 class="title"><a id="ch09lvl1sec05"/>Posting a check-in to FourSquare</h1></div></div></div><p>Now that we have created the basic module in order to authenticate against FourSquare, we are going to extend it in order to let the user "check-in" to a particular location. This works by sending details of your current place (for example, a bar, cinema, park, or museum) along with its latitude and longitude values to the FourSquare servers. From there, you can then tell which of your friends are nearby, or alternatively, make your location and activities public for everyone to see.<a id="id334" class="indexterm"/>
</p><div><h3 class="title"><a id="note65"/>Note</h3><p>Complete source code for this recipe can be found in the<code class="literal"> /Chapter 9/Recipe 4</code> folder.</p></div><div><div><div><div><h2 class="title"><a id="ch09lvl2sec10"/>How to do it…</h2></div></div></div><p>Open your<code class="literal"> fsq_module.js</code> file and extend the existing module so that it has the extra method as follows:</p><div><pre class="programlisting">FOURSQModule.callMethod = function(method, GETorPOST, params, success, error) {
//get the login information
try {
if (FOURSQModule.xhr == null) {
FOURSQModule.xhr = Titanium.Network.createHTTPClient();
}
FOURSQModule.xhr.open(GETorPOST, FOURSQModule.API_URL + method + "?oauth_token=" + FOURSQModule.ACCESS_TOKEN);
FOURSQModule.xhr.onerror = function(e) {
Ti.API.error("FOURSQModule ERROR " + e.error);
Ti.API.error("FOURSQModule ERROR " + FOURSQModule.xhr.location);
if ( error ) {
error(e);
}
};
FOURSQModule.xhr.onload = function(_xhr) {
Ti.API.debug("FOURSQModule response: " + FOURSQModule.xhr.responseText);
if ( success ) {
success(FOURSQModule.xhr);
}
};
FOURSQModule.xhr.send(params);
} catch(err) {
Titanium.UI.createAlertDialog({
title: "Error",
message: String(err),
buttonNames: ['OK']
}).show();
}
};
</pre></div><p>Now back in your<code class="literal"> app.js</code> file, we are going to extend the "login" call we wrote in the previous recipe to now post a FourSquare check-in after a successful authorization:<a id="id335" class="indexterm"/>
</p><div><pre class="programlisting">FOURSQModule.init('yourclientid', 'http://www.yourcallbackurl.com');
FOURSQModule.login(function(e){
//checkin to a lat/lon location... you can get
//this from a google map or your GPS co-ordinates
var params = {
shout: 'This is my check-in message!',
broadcast: 'public',
ll: '33.7,44.2'
};
FOURSQModule.callMethod("checkins/add", 'POST', params,
onSuccess_self, function(e) {
Titanium.UI.createAlertDialog({
title: "checkins/add: METHOD FAILED",
message: e,
buttonNames: ['OK']
}).show();
});
//now close the foursquare modal window
FOURSQModule.closeFSQWindow();
},
function(event) {
Titanium.UI.createAlertDialog({
title: "LOGIN FAILED",
message: event,
buttonNames: ['OK']
}).show();
});
</pre></div><p>Now try running your app in the emulator. After logging into the FourSquare system, you should automatically have posted a test check-in titled "This is my check-in message!" and the FourSquare system should send you a successful response message and log it to the console.<a id="id336" class="indexterm"/>
</p></div><div><div><div><div><h2 class="title"><a id="ch09lvl2sec11"/>How it works…</h2></div></div></div><p>The<code class="literal"> callMethod()</code> function of our FourSquare module does all of the work here. It is essentially taking in the method name to call, along with whether it is a GET or POST call and the parameters required to make that method work. Our example code is calling the<code class="literal"> checkins/add</code> method, which is a POST, and passing it through the parameters of<code class="literal"> shout, broadcast</code>, and<code class="literal"> ll</code>. These are our message, privacy setting, and current location respectively. All of the authorization work, including saving our access token, is done via the previous recipe. The following console output shows our response from FourSquare after a successful checkin post:<a id="id337" class="indexterm"/>
</p><div><pre class="programlisting">[DEBUG] destroyAuthorizeUI
[DEBUG] destroyAuthorizeUI:webView.removeEventListener
[DEBUG] destroyAuthorizeUI:window.close()
[DEBUG] FOURSQModule response: {"notifications":[{"type":"notificationTray","item":{"unreadCount":0}},{"type":"message"
,"item":{"message":"OK, got your shout (This is my check-in message!)!"}}],"response":{"checkin":{"i
d":"4ebf9a5d7ee54e4cd299b72e","createdAt":1321179741,"type":"shout","shout":"This is my check-in mes
sage!","timeZone":"Asia/Baghdad","location":{"lat":33.7,"lng":44.2}}}}
</pre></div></div></div>
<div><div><div><div><h1 class="title"><a id="ch09lvl1sec06"/>Searching and retrieving data via Yahoo! YQL</h1></div></div></div><p>YQL is an SQL-like language that allows you to query, filter, and combine data from multiple sources across both the Yahoo! Network and other open data sources. Normally, developer access to data from multiple resources is disparate and requires calls to multiple APIs from different providers, often with varying feed formats. YQL eliminates this problem by providing a single endpoint to query and shape the data you request. You may remember that we briefly touched on the usage of YQL via standard HTTP Request calls in<a class="link" href="ch02.html" title="Chapter 2. Working with Local and Remote Data Sources"> Chapter 2</a>, however, in this chapter, we will be utilizing the built-in Titanium YQL methods.<a id="id338" class="indexterm"/>
</p><p>Titanium has built-in support for YQL, and in this recipe we will create a simple application that searches for stock data on the YQL network, and then displays that data in a simple label.<a id="id339" class="indexterm"/>
</p><div><h3 class="title"><a id="note66"/>Note</h3><p>Note that when using YQL in an un-authenticated manner (such as we are doing here), there is a usage limit imposed of 100,000 calls per day. For most applications, this is a more than generous limit. However, if you do wish to have it increased, you will need to authenticate your calls via OAuth. You can do this by signing up with Yahoo! and registering your application.</p></div><p>The complete source code for this recipe can be found in the<code class="literal"> /Chapter 9/Recipe 5</code> folder.</p><div><div><div><div><h2 class="title"><a id="ch09lvl2sec12"/>How to do it…</h2></div></div></div><p>Create a new project, and then open the<code class="literal"> app.js</code> file, removing any existing content. Now type in the following code:</p><div><pre class="programlisting">//
// create base UI tab and root window
//
var win1 = Titanium.UI.createWindow({
backgroundColor:'#fff'
});
// This is the input textfield for our stock code
var txtStockCode = Titanium.UI.createTextField({
hintText: 'Stock code, e.g. APPL',
borderWidth: 0,
width: 200,
left: 10,
height: 30,
font: {fontSize: 14, fontColor: '#262626'},
autoCorrect: false,
autocapitalization: Titanium.UI.TEXT_AUTOCAPITALIZATION_ALL,
borderStyle: 1,
top: 5
});
//add the text field to the window
win1.add(txtStockCode);
// Create the search button from our search.png image
var btnSearch = Titanium.UI.createButton({
title: 'Search YQL',
width: 80,
height: 30,
right: 10,
borderRadius: 3,
top: 5
});
//add the button to the window
win1.add(btnSearch);
//This function is called on search button tap
//it will query YQL for our stock data
function searchYQL() {
// Do some basic validation to ensure the user
//has entered a stock code value
if(txtStockCode.value != '')
{
txtStockCode.blur(); //hides the keyboard
// Create the query string using a combination of
//YQL syntax and the value of the txtStockCode field
var query = 'select * from yahoo.finance.quotes where symbol
= "' + txtStockCode.value + '"';
// Execute the query and get the results
Titanium.Yahoo.yql(query, function(e) {
var data = e.data;
//Iff ErrorIndicationreturnedforsymbolchangedinvalid
//is null then we found a valid stock
if(data.quote.ErrorIndicationreturnedforsymbolchangedinvalid
== null)
{
//show our results in the console
Ti.API.info(data);
var lblStockInfo = Titanium.UI.createLabel({
top: 60,
left: 20,
width: 280,
height: 'auto',
text: ''
});
//create a label to show some of our info
lblStockInfo.text = lblStockInfo.text
+ 'Company name: ' + data.quote.Name;
lblStockInfo.text = lblStockInfo.text +'\nDays Low: '
+ data.quote.DaysLow;
lblStockInfo.text = lblStockInfo.text +'\nDays High: '
+ data.quote.DaysHigh;
lblStockInfo.text = lblStockInfo.text +'\nLast Open: '
+ data.quote.Open;
lblStockInfo.text = lblStockInfo.text +'\nLast Close: '
+ data.quote.PreviousClose;
lblStockInfo.text = lblStockInfo.text +'\nVolume: '
+ data.quote.Volume;
win1.add(lblStockInfo);
}
else
{
//show an alert dialog saying nothing could be found
alert('No stock information could be found for ' + txtStockCode.value);
}
});
} //end if
}
// Add the event listener for this button
btnSearch.addEventListener('click', searchYQL);
//open the window
win1.open();
</pre></div><p>You should now be able to run the app in your emulator and search for a stock symbol (such as 'AAPL' for Apple Inc.), and have some of the results listed out to a label on the screen, as seen next:<a id="id340" class="indexterm"/>
</p><div><img src="img/3968_09_02.jpg" alt="How to do it…"/></div></div><div><div><div><div><h2 class="title"><a id="ch09lvl2sec13"/>How it works…</h2></div></div></div><p>What is actually going on here within the<code class="literal"> searchYQL()</code> function? First, we're doing a very basic validation on the text field to ensure the user has entered in a stock symbol before pressing search. If a stock symbol is found, we use the<code class="literal"> blur()</code> method of the text field to ensure the keyboard becomes hidden. The meat of the code revolves around creating a Yahoo! YQL query using the correct syntax and providing the text field value as the symbol parameter. This YQL query is simply a string, joined together using the + symbol, much like you would do with any other string manipulation in JavaScript.<a id="id341" class="indexterm"/>
</p><p>We then execute our query using the<code class="literal"> Titanium.Yahoo.yql()</code> method, which returns the results within the 'e' object of the inline response function. We can then manipulate and use this JSON data in any way we wish. In this case, we're assigning a subsection of it to a label on the screen so the user can view the daily opening and closing figures of the stock in question.</p></div></div>
<div><div><div><div><h1 class="title"><a id="ch09lvl1sec07"/>Integrating push notifications with UrbanAirship.com</h1></div></div></div><p>Push notifications is a constantly-open IP connection used to forward notifications from the servers of third party applications to your iOS device. They are used as an alternative to "always running" applications, and allow your device to receive notifications from a specific app even when it is not running. If you have ever received an SMS on your iPhone, then you'll aready know what push notifications looks like. They are essentially a message box that consists of a title, a message, and both a "Close" button and an "Action" button. The "Action" button can be defined by your code, in both appearance and the underlying action and data that you want to be passed to your application when that button is pushed.<a id="id342" class="indexterm"/>
</p><div><div><div><div><h2 class="title"><a id="ch09lvl2sec14"/>Getting ready</h2></div></div></div><p>You will need to register for an account with Urban Airship at<a class="ulink" href="http://https://go.urbanairship.com/accounts/register/"> https://go.urbanairship.com/accounts/register/</a>. Once you have registered and verified your account via the email link sent to you from Urban Airship, you will need to add a new app to your account at<a class="ulink" href="http://https://go.urbanairship.com/apps/"> https://go.urbanairship.com/apps/</a>. If you haven't already done so, create and download a new Apple Push Certificate from your Apple Developer account. You can do this by creating a new App ID under "Provisioning" in your iOS Developer account, and then in the list of apps find the one you just created, and click on the "configure" link.<a id="id343" class="indexterm"/>
</p><p>A new page should then show up and allow you to select the push notifications option, such as the one in the following screenshot:</p><div><img src="img/3968_09_03.jpg" alt="Getting ready"/></div><p>You will need to create an application-specific client SSL certificate, which can be done through keychain. Click on the<strong> Configure</strong> button next to the<strong> Development SSL Certificate</strong> option, and work through the step-by-step wizard. When it is finished, you should be able to download a new Apple Push Notification certificate.<a id="id344" class="indexterm"/>
</p><p>Save this certificate to your computer's hard drive and then double-click the saved file to open it in Keychain Access. In Keychain Access, click on<strong> My Certificates</strong>, and then find the new Apple Push Notification certificate you just created, right-click on it, and select<strong> Export</strong>. You will need to give your new P12 certificate a name. After clicking<strong> Save</strong> you'll also be asked to provide a password, as seen in the following screenshot. This can be anything you like, such as<strong> packt</strong>.</p><div><img src="img/3968_09_04.jpg" alt="Getting ready"/></div><p>Now go back to the Urban Airship page where you are creating your new application and upload the new P12 certificate, providing the password in the box as requested. Save your application and you are now ready to send push notifications!<a id="id345" class="indexterm"/>
</p><div><h3 class="title">Note</h3><p>The complete source code for this recipe can be found in the<code class="literal"> /Chapter 9/Recipe 6</code> folder.</p></div></div><div><div><div><div><h2 class="title"><a id="ch09lvl2sec15"/>How to do it…</h2></div></div></div><p>Create a new development provisioning profile for your application in the provisioning section of the Developer website, and download it to your computer. Next, create a new Titanium project and ensure the app identifier you use matches the identifier you just used to create the provisioning certificate in the Developer Portal. Urban Airship has already created a basic registration sample for you, so we are also going to use that.<a id="id346" class="indexterm"/>
</p><p>Next, open the<code class="literal"> app.js</code> file, removing any existing content. Type in the following code:</p><div><pre class="programlisting">//create root window
var win = Titanium.UI.createWindow({
title:'sample',
backgroundColor:'#fff'
});
var key = 'your app key';
var secret = 'your app secret';
Titanium.Network.registerForPushNotifications({
types:[
Titanium.Network.NOTIFICATION_TYPE_BADGE,
Titanium.Network.NOTIFICATION_TYPE_ALERT,
Titanium.Network.NOTIFICATION_TYPE_SOUND
],
success: successCallback,
error: errorCallback,
callback: messageCallback
});
function successCallback(e) {
var request = Titanium.Network.createHTTPClient({
onload:function(e) {
if (request.status != 200 &amp;&amp; request.status != 201) {
request.onerror(e);
return;
}
},
onerror:function(e) {
alert("Register with Urban Airship Push Service failed. Error: "
+ e.error);
}
});
// Register device token with UA
request.open('PUT', 'https://go.urbanairship.com/api/device_tokens/'
+ e.deviceToken, true);
request.setRequestHeader('Authorization','Basic ' +
Titanium.Utils.base64encode(key + ':' + secret));
request.send();
}
function errorCallback(e) {
alert("Error during registration: " + e.error);
}
function messageCallback(e) {
var message;
if(e['aps'] != undefined) {
if(e['aps']['alert'] != undefined){
if(e['aps']['alert']['body'] != undefined){
message = e['aps']['alert']['body'];
} else {
message = e['aps']['alert'];
}
} else {
message = 'No Alert content';
}
} else {
message = 'No APS content';
}
alert(message);
}
//finally, open root window
win.open();
</pre></div><p>Now, in order to test this code, you must run the application on a device. The emulator simply does not have the push capability and so will not work for this recipe. Go to the<strong> Run on Device</strong> tab in Titanium Studio and provide the screen with the debug provision profile you created in the first steps of this recipe. Next, click on the<strong> Install Now</strong> button to compile and push the application package to your device using iTunes.<a id="id347" class="indexterm"/>
</p><p>Once your application has launched on the device and it is running, go to your web browser and, in your Urban Airship's app page, click on<strong> Push</strong> and then<strong> Device Tokens</strong>. Your new token should be listed on this page. If it is not, double check all of your steps again and ensure you are using the correct mobile provisioning profiles to build your app. You can now click on<strong> Send Broadcast</strong> in order to send a sample push notification to your device directly from the Urban Airship website. Try this now, and you should receive a message on your iPhone that looks very similar to the one shown in the following screenshots:<a id="id348" class="indexterm"/>
</p><div><img src="img/3968_09_05.jpg" alt="How to do it…"/></div></div><div><div><div><div><h2 class="title"><a id="ch09lvl2sec16"/>How it works…</h2></div></div></div><p>There are a number of key factors in ensuring you are successful in getting Push Notifications to work with your Titanium application. Keep these points in mind:<a id="id349" class="indexterm"/>
</p><div><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">Remember that each application you create needs its own Push Certificate, you cannot use wildcard certificates when integrating Push.<a id="id350" class="indexterm"/></li><li class="listitem" style="list-style-type: disc">Always create the Push Certificate under your Application settings in the developer console first, and then create your provisioning profiles. Doing it the other way around will mean your profile will be invalid and your app will not accept any push notification requests.<a id="id351" class="indexterm"/></li><li class="listitem" style="list-style-type: disc">Push notifications can only be tested on actual iPhone or iPod Touch devices, they will not work under the emulator.</li><li class="listitem" style="list-style-type: disc">The<code class="literal"> Titanium.Network.registerForPushNotifications</code> method requires the types of notifications you wish to use as the first parameter. If you do not request a specific permission from the user upfront, you may not be able to send them that kind of notification in the future. Furthermore, users must always agree to allow you to send push notifications to their device. You will not be able to do so if they do not allow the process to occur.</li><li class="listitem" style="list-style-type: disc">You need to create separate profiles and certificates for push notifications in both the Apple iOS Developer console and Urban Airship. You cannot use a development profile in production and vice versa.</li></ul></div></div></div>
<div><div><div><div><h1 class="title"><a id="ch09lvl1sec08"/>Testing push notifications using PHP and HTTP POST</h1></div></div></div><p>In order for our server application to programmatically push notifications to a user or group of users, we will need to create a script that can push the notifications to the Urban Airship servers. This can be done in a variety of methods (via desktop app, .NET application, web application and so on), but for the purposes of this recipe we will use PHP, which is simple, fast, and freely available.<a id="id352" class="indexterm"/>
</p><div><h3 class="title">Note</h3><p>The complete source code for this recipe can be found in the<code class="literal"> /Chapter 9/Recipe 7</code> folder.</p></div><div><div><div><div><h2 class="title"><a id="ch09lvl2sec17"/>How to do it…</h2></div></div></div><p>First, we need to create the PHP script which will communicate with the Urban Airship servers to send a push notification. Create the following PHP script, save it as<code class="literal"> airship.php</code>, and upload it to a server capable of running PHP and with CURL installed. There are plenty of free PHP/Apache hosting accounts available online if you don't already have one capable of doing this.</p><p>The following sample is taken from the Urban Airship website:</p><div><pre class="programlisting">&lt;?php
define('APPKEY','xxxx');
define('PUSHSECRET', 'xxx'); // Master Secret
define('PUSHURL',
'https://go.urbanairship.com/api/push/broadcast/');
$contents = array();
$contents['badge'] = "+1";
$contents['alert'] = "Hello there Titanium Developer!";
$push = array("aps" =&gt; $contents);
$json = json_encode($push);
$session = curl_init(PUSHURL);
curl_setopt($session, CURLOPT_USERPWD, APPKEY . ':' . PUSHSECRET);
curl_setopt($session, CURLOPT_POST, True);
curl_setopt($session, CURLOPT_POSTFIELDS, $json);
curl_setopt($session, CURLOPT_HEADER, False);
curl_setopt($session, CURLOPT_RETURNTRANSFER, True);
curl_setopt($session, CURLOPT_HTTPHEADER, array('Content-Type:application/json'));
$content = curl_exec($session);
echo $content; // just for testing what was sent
// Check if any error occured
$response = curl_getinfo($session);
if($response['http_code'] != 200) {
echo "Got negative response from server, http code: ".
$response['http_code'] . "\n";
} else {
echo "Wow, it worked!\n";
}
curl_close($session);
?&gt;
</pre></div><p>All that is left to do now is run the PHP script in a browser, and when you do, you should see a success message echoed out to the browser page, and you should also be able to see a new push notification delivered to your device that was set up in the previous recipe, as seen in the following screenshot:.<a id="id353" class="indexterm"/>
</p><div><img src="img/3968_09_06.jpg" alt="How to do it…"/></div></div><div><div><div><div><h2 class="title"><a id="ch09lvl2sec18"/>How it works…</h2></div></div></div><p>The PHP script in this recipe is doing much the same job as the actual Urban Airship website does when you can perform tests via their console. Here, we are using PHP to build a CURL request in JSON and post it to the Urban Airship server. That request is in turn received and then pushed out to your device or devices as a Push Notification by the Urban Airship system.<a id="id354" class="indexterm"/>
</p><p>In a production environment, you would want to extend your PHP script to either receive the badge and message variables as POST variables, or perhaps hook up the script directly to a database with whatever business logic your app requires. You should also note that Urban Airship provides samples for languages other than PHP. So if your system is built in .NET or another platform, the same principles of sending out broadcasts still apply.<a id="id355" class="indexterm"/>
</p></div></div></body></html>