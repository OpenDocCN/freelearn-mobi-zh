<html><head></head><body><div><div><div><div><h1 class="title"><a id="ch08"/>Chapter 8. Working with the CoreData and GameKit Frameworks</h1></div></div></div><p>In this chapter, we will cover:</p><div><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">Adding the GameKit and MessageUI frameworks</li><li class="listitem" style="list-style-type: disc">Building the Core Data data-model</li><li class="listitem" style="list-style-type: disc">Creating the Core Data model files</li><li class="listitem" style="list-style-type: disc">Adding and configuring the Storyboard</li><li class="listitem" style="list-style-type: disc">Creating the Books Library user interface</li><li class="listitem" style="list-style-type: disc">Displaying data within the Table View</li><li class="listitem" style="list-style-type: disc">Inserting data within our Core Data data-model</li><li class="listitem" style="list-style-type: disc">Deleting an item from the Table View using Core Data</li><li class="listitem" style="list-style-type: disc">Reordering rows within a Table View</li><li class="listitem" style="list-style-type: disc">Filtering and searching for data within a Table View</li><li class="listitem" style="list-style-type: disc">Working with the different keyboard styles</li><li class="listitem" style="list-style-type: disc">Transferring data to another device using Bluetooth</li><li class="listitem" style="list-style-type: disc">Implementing e-mail messaging</li></ul></div><div><div><div><div><h1 class="title"><a id="ch08lvl1sec80"/>Introduction</h1></div></div></div><p>Both the iPhone and iPad devices come with a built-in Bluetooth functionality, allowing it to communicate with other Bluetooth-capable devices, such as other iOS devices or Bluetooth-compatible headsets. In this chapter, we will take a look at how to create a simple <code class="literal">BooksLibrary</code> application, <a id="id794" class="indexterm"/>making use of Apple's powerful <strong>Core Data</strong> framework that will allow you to directly interface with an <strong>SQLite</strong> database to create and store client information using a form. </p><p>We will then take a look at how you can incorporate the Bluetooth functionality within your application so that you can send this information by communicating with another iOS device, and have this information received wirelessly and stored within the database at the other end. </p><p>This may all sound a bit confusing at first, but you will soon come to see that by using the iOS SDK, Bluetooth programming is actually quite simple and this functionality is nicely encapsulated within the <a id="id795" class="indexterm"/>
<strong>GameKit</strong> framework. Finally, we will be taking a look at how we can use the <a id="id796" class="indexterm"/>
<strong>MessageUI</strong> framework and the <code class="literal">MFMailComposeViewController</code> class to send an e-mail message containing the selected Book Details chosen within the table view as well as learning how to reorder and delete records within the <code class="literal">UITableView</code> control.</p></div></div>
<div><div><div><div><h1 class="title"><a id="ch08lvl1sec81"/>Adding the GameKit and MessageUI frameworks</h1></div></div></div><p>In this recipe we will <a id="id797" class="indexterm"/>
<a id="id798" class="indexterm"/>learn how to add the <code class="literal">GameKit</code> and <code class="literal">MessageUI</code> frameworks to provide the ability of sending information using Bluetooth, as well as sending e-mails.</p><div><div><div><div><h2 class="title"><a id="ch08lvl2sec285"/>Getting ready</h2></div></div></div><p>In order to proceed, we need to create a new application and add the frameworks to our project. </p></div><div><div><div><div><h2 class="title"><a id="ch08lvl2sec286"/>How to do it...</h2></div></div></div><p>To begin, follow these simple steps as outlined in the following order:</p><div><ol class="orderedlist arabic"><li class="listitem">Launch <code class="literal">Xcode</code> from the <code class="literal">/Xcode4/Applications</code> folder.</li><li class="listitem">Choose <strong>Create a new Xcode project</strong>, or <strong>File | New | Project…</strong>.</li><li class="listitem">Choose the <strong>Empty Application</strong> template from the list of available templates.</li><li class="listitem">Click on the <strong>Next</strong> button to proceed to the next step in the wizard.</li><li class="listitem">Enter in <strong>BooksLibrary</strong> as the name for your project.</li><li class="listitem">Select <strong>iPhone</strong> from under the <strong>Devices</strong> drop down.</li><li class="listitem">Ensure that the <strong>Use Core Data</strong> checkbox has been ticked.</li><li class="listitem">Ensure that the <strong>Use Automatic Reference Counting</strong> checkbox has been ticked.</li><li class="listitem">Ensure that the <strong>Include Unit Tests</strong> checkbox has not been ticked.</li><li class="listitem">Click on the <strong>Next</strong> button to proceed to the next step in the wizard and specify the location where you would like to save your project.</li><li class="listitem">Then, click on the <strong>Create</strong> button to continue and display the Xcode workspace.</li><li class="listitem">Next, add the <code class="literal">GameKit.framework</code> and <code class="literal">MessageUI.framework</code> frameworks to your project.</li></ol></div></div><div><div><div><div><h2 class="title"><a id="ch08lvl2sec287"/>How it works...</h2></div></div></div><p>In this recipe, we learned how to add both the <code class="literal">GameKit</code> and <code class="literal">MessageUI</code> frameworks to our project that will enable <a id="id799" class="indexterm"/>
<a id="id800" class="indexterm"/>
<a id="id801" class="indexterm"/>us to perform the ability of transmitting information over a Bluetooth network to other iOS devices, as well as providing the ability to send e-mail messages within our application using the <code class="literal">MFMailComposeViewController</code> class.</p></div><div><div><div><div><h2 class="title"><a id="ch08lvl2sec288"/>See also</h2></div></div></div><div><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">The <em>Building the Core Data data model</em> recipe</li><li class="listitem" style="list-style-type: disc">The <em>Adding the CoreLocation and MapKit frameworks</em> recipe in <a class="link" href="ch05.html" title="Chapter 5. Working with the Location Services and the MapKit Frameworks">Chapter 5</a>, <em>Location Services and Maps</em></li></ul></div></div></div>
<div><div><div><div><h1 class="title"><a id="ch08lvl1sec82"/>Building the Core Data data model</h1></div></div></div><p>In this recipe we will learn how to <a id="id802" class="indexterm"/>use the Core Data Model Editor to build our database schema for our <strong>BooksLibrary</strong> application.</p><div><div><div><div><h2 class="title"><a id="ch08lvl2sec289"/>Getting ready</h2></div></div></div><p>Following on from our previous recipe, ensure that our <strong>BooksLibrary</strong> project file is open.</p></div><div><div><div><div><h2 class="title"><a id="ch08lvl2sec290"/>How to do it...</h2></div></div></div><p>To begin, follow these simple steps as outlined in the following order:</p><div><ol class="orderedlist arabic"><li class="listitem">Select the <code class="literal">BooksLibrary.xcdatamodel</code> file from <strong>Project Navigator</strong>.<div><img src="img/3349OT_08_01.jpg" alt="How to do it..."/></div></li><li class="listitem">Next, click on the <a id="id803" class="indexterm"/><strong>+Add Entity</strong> button and name this entity <strong>Books</strong>.</li><li class="listitem">Then click on <a id="id804" class="indexterm"/>the <a id="id805" class="indexterm"/><strong>+Add Attribute </strong>button or alternatively from the <strong>Attributes</strong> pane. </li><li class="listitem">Create each of the <strong>Attributes</strong> and <strong>Type</strong>, as shown in the following table:<div><table border="1"><colgroup><col style="text-align: left"/><col style="text-align: left"/></colgroup><thead><tr><th style="text-align: left" valign="bottom">
<p>Attribute </p>
</th><th style="text-align: left" valign="bottom">
<p>Type</p>
</th></tr></thead><tbody><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">author</code>
</p>
</td><td style="text-align: left" valign="top">
<p>
<code class="literal">String</code>
</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">displayOrder</code>
</p>
</td><td style="text-align: left" valign="top">
<p>
<code class="literal">Integer 16</code>
</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">publisher</code>
</p>
</td><td style="text-align: left" valign="top">
<p>
<code class="literal">String</code>
</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">title</code>
</p>
</td><td style="text-align: left" valign="top">
<p>
<code class="literal">String</code>
</p>
</td></tr></tbody></table></div></li><li class="listitem">Save your project using <strong>File | Save</strong>, as we are done defining our database table schema.</li></ol></div></div><div><div><div><div><h2 class="title"><a id="ch08lvl2sec291"/>How it works...</h2></div></div></div><p>The Core Data database model is stored within <code class="literal">BooksLibrary.xcdatamodel</code>, located within the <code class="literal">BooksLibrary</code> group within the <strong>Project Navigator</strong> window. In this recipe, we learned how to define the database schema for our SQLite database and create the entities (table) and attributes (fields) that will enable our application to write to these fields within the database, so that it can be queried later.</p><p>In our next recipe, we will take a look at <a id="id806" class="indexterm"/>how to create the core data model files that will allow us to access the table definitions.</p></div><div><div><div><div><h2 class="title"><a id="ch08lvl2sec292"/>See also</h2></div></div></div><div><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">The <em>Creating the Core Data model files</em> recipe</li></ul></div></div></div>
<div><div><div><div><h1 class="title"><a id="ch08lvl1sec83"/>Creating the Core Data model files</h1></div></div></div><p>In this recipe we will learn how <a id="id807" class="indexterm"/>to create the associated Core Data model file object definitions for our <code class="literal">BooksLibrary</code> database schema. </p><div><div><div><div><h2 class="title"><a id="ch08lvl2sec293"/>Getting ready</h2></div></div></div><p>Following on from our previous recipe, ensure that our <strong>BooksLibrary</strong> project file is open.</p></div><div><div><div><div><h2 class="title"><a id="ch08lvl2sec294"/>How to do it...</h2></div></div></div><p>Before our application can start to use our <code class="literal">BooksLibrary</code> database, we need to create the entity class definitions that will define the variables the database store contains so that we can access these through code.</p><div><ol class="orderedlist arabic"><li class="listitem">Select the <code class="literal">BooksLibrary.xcdatamodel</code> file from <strong>Project</strong> <strong>Navigator</strong> window.</li><li class="listitem">Choose <strong>File | New | File…</strong> or press <em>Command + N</em>.</li><li class="listitem">Next, choose <strong>Core Data</strong> from within the <strong>iOS</strong> group.</li><li class="listitem">Then, select the <strong>NSManagedObject subclass</strong> from the list of available templates.<div><img src="img/3349OT_08_02.jpg" alt="How to do it..."/></div></li><li class="listitem">Click on the <strong>Next</strong> button to proceed with the next step within the wizard.</li><li class="listitem">Click on the <strong>Create</strong> <a id="id808" class="indexterm"/>button to save the file to the folder location specified.</li><li class="listitem">Next, we need to define the entities for which we want to create the <code class="literal">NSManagedObject</code> classes for.<div><img src="img/3349OT_08_03.jpg" alt="How to do it..."/></div></li><li class="listitem">Select the <strong>Books</strong> entity from the <strong>Select the entities you would like to manage</strong> list and then click on the <strong>Next</strong> button to proceed with the next step in the wizard.</li><li class="listitem">Ensure that the <strong>Use scalar properties for primitive data types option </strong>has not been ticked, then <a id="id809" class="indexterm"/>click on the <strong>Create</strong> button to generate the <code class="literal">NSManagedObject</code> class files.</li></ol></div></div><div><div><div><div><h2 class="title"><a id="ch08lvl2sec295"/>How it works...</h2></div></div></div><p>In this recipe, we learned about the <a id="id810" class="indexterm"/>
<code class="literal">NSManagedObject</code> class, and how we can use this to define the class for the <code class="literal">Books</code> entity that we created in the Core Data store, as well as defining the table schema fields so that when we want to use the <code class="literal">Books</code> class, we can access the attributes at runtime. </p><p>The Core Data model wizard generated two files for us. The <code class="literal">Books.h</code> interface file and a <code class="literal">Books.m</code> implementation file. The <code class="literal">Books.h</code> interface file contains each of our entity attribute fields with each being declared based on their object types, and the <code class="literal">Books.m</code> implementation file contains each of our entity attribute fields with each being declared as <code class="literal">dynamic</code>. This defines the entity attribute properties so that they can be used when data is being written or retrieved from the Core Data Model</p><div><div><h3 class="title"><a id="note58"/>Note</h3><p>For more information about the dynamic data type, you can refer to the Apple Developer documentation at the following URL: <a class="ulink" href="https://developer.apple.com/library/ios/#documentation/Cocoa/Conceptual/CoreData/Articles/cdAccessorMethods.html%23//apple_ref/doc/uid/TP40002154-SW9">https://developer.apple.com/library/ios/#documentation/Cocoa/Conceptual/CoreData/Articles/cdAccessorMethods.html%23//apple_ref/doc/uid/TP40002154-SW9</a>
</p></div></div></div><div><div><div><div><h2 class="title"><a id="ch08lvl2sec296"/>There's more…</h2></div></div></div><p>One thing to keep in mind when working with Core Data is that if you try to add a new field to the data-model schema, your <a id="id811" class="indexterm"/>application will crash. You will need to regenerate the <code class="literal">NSManagedObject</code> files, and then reset the simulator or delete the application from the iOS device.</p></div><div><div><div><div><h2 class="title"><a id="ch08lvl2sec297"/>See also</h2></div></div></div><div><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">The <em>Adding and configuring the storyboard</em> recipe</li></ul></div></div></div>
<div><div><div><div><h1 class="title"><a id="ch08lvl1sec84"/>Adding and configuring the Storyboard</h1></div></div></div><div><div><div><div><h2 class="title"><a id="ch08lvl2sec298"/>Getting ready</h2></div></div></div><p>In this recipe, we will learn <a id="id812" class="indexterm"/>
<a id="id813" class="indexterm"/>how to add and configure an application's project properties using Xcode so that it is set up correctly to use a Storyboard file.</p></div><div><div><div><div><h2 class="title"><a id="ch08lvl2sec299"/>How to do it...</h2></div></div></div><p>To begin, follow these simple steps as outlined in the following order:</p><div><ol class="orderedlist arabic"><li class="listitem">Select the <strong>BooksLibrary</strong> project from the <strong>Project Navigator</strong> window.</li><li class="listitem">Choose <strong>File | New | File…</strong>or press <em>Command + N</em></li><li class="listitem">Choose the <strong>Storyboard</strong> template from the list of available templates, located under the <strong>User Interface</strong> option within the <strong>iOS</strong> section.</li><li class="listitem">Click on the <strong>Next</strong> button to proceed to the next step in the wizard.</li><li class="listitem">Ensure that you have selected <strong>iPhone</strong> from under the <strong>Device Family</strong> drop down.</li><li class="listitem">Click on the <strong>Next</strong> button to proceed to the next step in the wizard.</li><li class="listitem">Specify <strong>MainStoryboard.storyboard</strong> as the name of the Storyboard file within the <strong>Save As</strong> field as the name of the file to be created.</li><li class="listitem">Click on the <strong>Create</strong> button to save the file to the folder specified.</li><li class="listitem">Our next step is to manually configure our project so that it recognizes and uses this file for our <a id="id814" class="indexterm"/><a id="id815" class="indexterm"/>application. This can be achieved by following these steps:</li><li class="listitem">Select the <strong>BooksLibrary</strong> project from the <strong>Project Navigator</strong> window.</li><li class="listitem">Next, select your project target from under the <strong>TARGETS</strong> group and select the <strong>Summary</strong> tab.<div><img src="img/3349OT_08_04.jpg" alt="How to do it..."/></div></li><li class="listitem">Select <strong>MainStoryboard</strong> from the <strong>Main Storyboard</strong> drop down.</li></ol></div></div><div><div><div><div><h2 class="title"><a id="ch08lvl2sec300"/>How it works...</h2></div></div></div><p>In this recipe, we learned how to manually add new Storyboard template to your project. We then looked at how to configure <a id="id816" class="indexterm"/>
<a id="id817" class="indexterm"/>our project properties so that it is set up to use the Storyboard user interface file by our application. </p></div><div><div><div><div><h2 class="title"><a id="ch08lvl2sec301"/>There's more…</h2></div></div></div><p>Finally, when using Storyboards, we don't need to create a new <code class="literal">UIWindow</code> as this will create another window instance, <a id="id818" class="indexterm"/>
<a id="id819" class="indexterm"/>and place this on top of the Storyboard. We need to modify our application's delegate <a id="id820" class="indexterm"/>
<code class="literal">AppDelegate.m</code> class as shown in the following code snippet:</p><div><pre class="programlisting">- (BOOL)application:(UIApplication *)application didFinishLaunchingWithOptions:(NSDictionary *)launchOptions{
   // Override point for customization after 
   // application launch.
   return YES;
}
}</pre></div><div><div><h3 class="title"><a id="note59"/>Note</h3><p>For more information about using Storyboards in your applications, you can refer to the Apple Developer Documentation located at: <a class="ulink" href="https://developer.apple.com/library/ios/#documentation/ToolsLanguages/Conceptual/Xcode4UserGuide/InterfaceBuilder/InterfaceBuilder">https://developer.apple.com/library/ios/#documentation/ToolsLanguages/Conceptual/Xcode4UserGuide/InterfaceBuilder/InterfaceBuilder</a>
</p></div></div></div><div><div><div><div><h2 class="title"><a id="ch08lvl2sec302"/>See also</h2></div></div></div><div><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">The <em>Creating the Books Library user interface</em> recipe</li></ul></div></div></div>
<div><div><div><div><h1 class="title"><a id="ch08lvl1sec85"/>Creating the Books Library user interface</h1></div></div></div><p>In this recipe we will learn <a id="id821" class="indexterm"/>how to build the user interface for our Books Library project, as well as creating a custom table view controller to act as the data source.</p><div><div><div><div><h2 class="title"><a id="ch08lvl2sec303"/>Getting ready…</h2></div></div></div><p>In this section, we will start by building the components that will comprise of our user interface for our application. </p></div><div><div><div><div><h2 class="title"><a id="ch08lvl2sec304"/>How to do it...</h2></div></div></div><p>To begin, follow these simple steps as outlined in the following order:</p><div><ol class="orderedlist arabic"><li class="listitem">From the <strong>Project</strong> <strong>Navigator</strong> window, select the file named <code class="literal">MainStoryboard.storyboard</code>.</li><li class="listitem">From the <strong>Object</strong> library, select and drag a new (<code class="literal">UITableViewController</code>) <strong>Table ViewController</strong> control, and add this to the view.</li><li class="listitem">Next, select the <code class="literal">UITableViewController</code> control that we just added, and then choose <strong>Editor | Embed In | Navigation Controller</strong>.</li><li class="listitem">On the <strong>Navigation Controller</strong> window, ensure that the <strong>Shows Navigation Bar</strong> and <strong>Shows Toolbar</strong> are both ticked under the <strong>Bar Visibility</strong> section of the <strong>Navigation Controller</strong> window.</li><li class="listitem">Next, select the <code class="literal">UITableViewController</code> control and then click on the <strong>Table</strong> <strong>View</strong> <strong>Cell</strong> tab, then choose the <strong>Prototype</strong> cell from the <strong>Prototype Cells</strong> section.</li><li class="listitem">From the <strong>Attributes Inspector</strong> section, change the <strong>Style</strong> to <strong>Subtitle</strong>. This will change the cell's appearance to contain two labels.</li><li class="listitem">Select the <strong>Identifier</strong> <a id="id822" class="indexterm"/>item and enter in <strong>BookCell</strong> as its unique identifier.</li><li class="listitem">Next, from the <strong>Object Library</strong> window, select and drag a (<code class="literal">UIBarButtonItem</code>), and add this to the left of the navigation bar on our <strong>Table</strong> <strong>View</strong> <strong>Controller</strong>.</li><li class="listitem">From the <strong>Attributes Inspector</strong> section, change the value of <strong>Title</strong> to <strong>Add</strong>.</li><li class="listitem">Add another <code class="literal">UIBarButtonItem</code> to the right of the navigation bar on our <strong>Table</strong> <strong>View</strong> <strong>Controller</strong> and change the value of <strong>Title</strong> to <strong>Sort Order</strong>.</li><li class="listitem">Add another <code class="literal">UIBarButtonItem</code> to the bottom left of the navigation bar on our <strong>Table</strong> <strong>View</strong> <strong>Controller</strong> and change the value of <strong>Title</strong> to <strong>Connect</strong>.</li><li class="listitem">Add a <strong>Flexible Space Bar Button</strong> item next to the <strong>Connect</strong> button.</li><li class="listitem">Add another <code class="literal">UIBarButtonItem</code> to the bottom right of the navigation bar on our <strong>Table</strong> <strong>View</strong> <strong>Controller</strong> and change the value of <strong>Title</strong> to <strong>Transfer</strong>.</li><li class="listitem">Next, we need to create our very own custom <code class="literal">UITableViewController</code> subclass that will act as the data source for our table.</li><li class="listitem">Select the <code class="literal">BooksLibary</code> folder, choose <strong>File | New | File…</strong> or press <em>Command + N</em>.</li><li class="listitem">Select the <strong>Objective-C class</strong> template from inside the <strong>Cocoa Touch</strong> group.</li><li class="listitem">Click on the <strong>Next</strong> button to proceed to the next step in the wizard.</li><li class="listitem">Enter in <strong>BooksViewController</strong> as the name of the file to create.</li><li class="listitem">Ensure that you have selected <strong>UITableViewController</strong> as the type of subclass to create from the <strong>Subclass</strong> of drop down.</li><li class="listitem">Next, click on the <strong>Next</strong> button to proceed to the next step in the wizard, and then click on the <strong>Create</strong> button to save the file.</li><li class="listitem">Next, select the <code class="literal">MainStoryboard.storyboard</code> file from the <strong>Project</strong> <strong>Navigator</strong> window.</li><li class="listitem">Select the <code class="literal">UITableViewController</code> control and click on the <strong>Identity Inspector</strong> section, change the value of the <strong>Custom Class</strong> property to read <code class="literal">BooksViewController</code>.</li><li class="listitem">Next, we are going to create and set up the <code class="literal">outlets</code> and <code class="literal">action</code> methods for each of our buttons, with the following names: <code class="literal">btnAdd</code>, <code class="literal">btnSortOrder</code>, <code class="literal">btnConnect</code>, and <code class="literal">btnTransfer</code>.</li></ol></div><p>Next, we need to set up references for <a id="id823" class="indexterm"/>both the <code class="literal">NSManagedObjectContext</code> and <code class="literal">NSFetchedResultsController</code> objects. </p><div><ol class="orderedlist arabic"><li class="listitem">Open the <code class="literal">BooksViewController.h</code> interface file from the <strong>Project</strong> <strong>Navigator</strong> window.</li><li class="listitem">Next, modify the interface file as shown by the highlighted code sections. <div><pre class="programlisting">//  BooksViewController.h
//  BooksLibrary
//  Created by Steven F Daniel on 03/12/12.
//  Copyright (c) 2012 GenieSoft Studios. All rights reserved.
#import  &lt;UIKit/UIKit.h&gt;
<strong>#import "Books.h"</strong>

@interface BooksViewController : UITableViewController
{
<strong>   NSManagedObjectContext     *managedObjectContext;</strong>
<strong>   NSFetchedResultsController *fetchedResultsController;</strong>
<strong>   NSArray                          *fetchedObjects;</strong>
   IBOutlet UIBarButtonItem *btnAdd;
   IBOutlet UIBarButtonItem *btnSortOrder;
   IBOutlet UIBarButtonItem *btnConnect;
   IBOutlet UIBarButtonItem *btnTransfer;
   
   // Fields for our btnAdd UIAlertView dialog
<strong>   UITextField *bookTitle;</strong>
<strong>   UITextField *bookAuthor;</strong>
<strong>   UITextField *bookPublisher;</strong>
}
<strong>   // Core Data session objects</strong>
<strong>   @property (strong, nonatomic) NSManagedObjectContext         </strong>
<strong>   *managedObjectContext;</strong>
<strong>   @property (strong, nonatomic)    </strong>
<strong>   NSFetchedResultsController *fetchedResultsController;</strong>

   // Property getters and setters for our UI
   @property (strong, nonatomic) IBOutlet UIBarButtonItem         
   *btnAdd;
   @property (strong, nonatomic) IBOutlet UIBarButtonItem     
   *btnSortOrder;
   @property (strong, nonatomic) IBOutlet UIBarButtonItem   
   *btnConnect;
   @property (strong, nonatomic) IBOutlet UIBarButtonItem   
   *btnTransfer;

// Create the class instance methods
<strong>-(void)populateBookDetails;</strong>

- (IBAction)btnAdd:(id)sender;
- (IBAction)btnSortOrder:(id)sender;
- (IBAction)btnConnect:(id)sender;
- (IBAction)btnTransfer:(id)sender;

@end</pre></div></li><li class="listitem">Next, open the <code class="literal">AppDelegate.m</code> implementation file, located within the <strong>BooksLibrary</strong> folder, and enter in the following highlighted code.<div><pre class="programlisting">//  AppDelegate.m
//  BooksLibrary
//  Created by Steven F Daniel on 03/12/12.
//  Copyright (c) 2012 GenieSoft Studios. All rights reserved.

#import  "AppDelegate.h"
<strong>#import "BooksViewController.h"</strong>

@implementationAppDelegate

@synthesize managedObjectContext = _managedObjectContext;
@synthesize managedObjectModel = _managedObjectModel;
@synthesize persistentStoreCoordinator = 
_persistentStoreCoordinator;</pre></div></li><li class="listitem">Next, modify the <code class="literal">didFinishLaunchingWithOptions</code> method, located within the <code class="literal">AppDelegate.m</code> implementation file.<div><pre class="programlisting">- (BOOL)application:(UIApplication *)application 
didFinishLaunchingWithOptions:(NSDictionary *)launchOptions {
<strong>  // Point our Books View Controller to our data-model</strong>
<strong>  UINavigationController *navigationController = </strong>
<strong>  (UINavigationController *)</strong>
<strong>  self.window.rootViewController;</strong>
<strong>  BooksViewController *booksViewController = </strong>
<strong>  [[navigationController</strong>
<strong>  viewControllers]objectAtIndex:0];</strong>
<strong>  booksViewController.managedObjectContext = </strong>
<strong>  self.managedObjectContext;</strong>
  return YES;
}</pre></div></li><li class="listitem">Then, <strong>Build</strong> and <strong>Run</strong> the application by choosing <strong>Product | Run</strong> from the <strong>Product</strong> menu, or alternatively pressing <em>Command + R</em>.</li></ol></div></div><div><div><div><div><h2 class="title"><a id="ch08lvl2sec305"/>How it works...</h2></div></div></div><p>In this recipe, we started by building our user interface for our <strong>BooksLibrary</strong> application, as well as properly configuring our <strong>Table</strong> <strong>View</strong> <strong>Controller</strong>. We then created our very own custom <code class="literal">UITableViewController</code> subclass that will act as the data source for our table so that it will know <a id="id824" class="indexterm"/>how many rows to be displayed when it retrieves the information from our database. </p><p>Next, we updated the class of our <code class="literal">UITableViewController</code> to use our newly created class instead of the default <code class="literal">UITableViewController</code> class, and included a reference to the <code class="literal">NSManagedObjectContext</code> and <code class="literal">NSFetchedResultsController</code> objects, that provides us with all of the Core Data fetch-related functions, needed to perform when populating our table view with data. These functions encapsulate the common functions that are associated with the table and the Core Data model. We created an <code class="literal">NSArray</code> array property that is used to store the retrieved data. </p><p>Finally, we initialized the data source for our <code class="literal">booksViewController</code> using the <code class="literal">managedObjectContext</code> method. This ensures that our controller has access to all of the required properties and methods required to add and retrieve the information from our data model. Before this can happen, we need to first cycle through each scene within our Storyboard in order to get a reference to the <code class="literal">BooksViewController</code>. This is so that we can initialize its data source, so that it points to our database. </p></div><div><div><div><div><h2 class="title"><a id="ch08lvl2sec306"/>See also</h2></div></div></div><div><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">The <em>Displaying data within the Table View</em> recipe</li></ul></div></div></div>
<div><div><div><div><h1 class="title"><a id="ch08lvl1sec86"/>Displaying data within the Table View </h1></div></div></div><p>In this recipe we will <a id="id825" class="indexterm"/>
<a id="id826" class="indexterm"/>learn how to populate a Table View Control with some data.</p><div><div><div><div><h2 class="title"><a id="ch08lvl2sec307"/>Getting ready</h2></div></div></div><p>Following on from our previous recipe, we will learn how to populate our <code class="literal">UITableViewControl</code> from our Core Data database model. </p></div><div><div><div><div><h2 class="title"><a id="ch08lvl2sec308"/>How to do it...</h2></div></div></div><p>To begin, follow these simple steps as outlined in the following order:</p><div><ol class="orderedlist arabic"><li class="listitem">Open the <code class="literal">BooksViewController.m</code> implementation file from the <strong>Project Navigator</strong> window.</li><li class="listitem">Next, modify the implementation file as shown by the highlighted code sections.<div><pre class="programlisting">//  BooksViewController.m
//  BooksLibrary
//  Created by Steven F Daniel on 03/12/12.
//  Copyright (c) 2012 GenieSoft Studios. All rights reserved.

#import "BooksViewController.h"

@implementation BooksViewController

<strong>@synthesize fetchedResultsController;</strong>
<strong>@synthesize managedObjectContext;</strong>
<strong>@synthesize btnAdd;</strong>
<strong>@synthesize btnSortOrder;</strong>
<strong>@synthesize btnConnect;</strong>
<strong>@synthesize btnTransfer;</strong>
</pre></div></li><li class="listitem">Modify the <code class="literal">viewDidLoad:</code> and <code class="literal">viewDidAppear:</code> methods as shown by the highlighted code sections.<div><pre class="programlisting">#pragma mark - View lifecycle
- (void)viewDidLoad {
[super viewDidLoad];
// Initialize and reload Book Details.
<strong>self.title = @"Book Details";</strong>
<strong>[self populateBookDetails];</strong>
}
#pragma mark reloads our book details when our view reappears
- (void)viewDidAppear:(BOOL)animated {
[super viewDidAppear:animated];
<strong>[self populateBookDetails];</strong>
}</pre></div></li><li class="listitem">Next, create the <a id="id827" class="indexterm"/><a id="id828" class="indexterm"/>following code sections, as specified in the code snippet.<div><pre class="programlisting">#pragma mark Populate our table view with our database records
-(void)populateBookDetails {
   // Define our table/entity name to use
   NSEntityDescription *entity = [NSEntityDescription
   entityForName:@"Books" 
   inManagedObjectContext:managedObjectContext];
   
   // Set up the fetch request
   NSFetchRequest *fetchRequest = [[NSFetchRequest alloc] init];
   [fetchRequest setEntity:entity];
   
   // Define how we are to sort the records
   NSSortDescriptor *sortDescriptor = [[NSSortDescriptor alloc] 
   initWithKey:@"displayOrder" ascending:YES];
   NSArray *sortDescriptors = [NSArray
   arrayWithObject:sortDescriptor];
   [fetchRequest setSortDescriptors:sortDescriptors];
   // Define the FetchResults controller
   fetchedResultsController = [[NSFetchedResultsControlleralloc] 
   initWithFetchRequest:fetchRequest
   managedObjectContext:managedObjectContext
   sectionNameKeyPath:nil cacheName:@"Root"];

   // Fetch the records and handle any errors 
   NSError *error = nil;
   if (![[self fetchedResultsController] performFetch:&amp;error]) {
      NSLog(@"There was an error retrieving the book 
      details.");
    }     
   // Number of rows to populate our Table View controller with.
   fetchedObjects = fetchedResultsController.fetchedObjects;   
   [self.tableView reloadData];
}
#pragma mark - Table view data source
-(NSInteger)numberOfSectionsInTableView:(UITableView *)tableView{
    // Return the number of sections.
return 1;
}
#pragma mark Return the number of rows in the section.
- (NSInteger)tableView:(UITableView *)tableView
   numberOfRowsInSection:(NSInteger)section {
   return [fetchedObjects count];
}
#pragma mark populate our tableview for each book added
- (UITableViewCell *)tableView:(UITableView *)tableView
  cellForRowAtIndexPath:(NSIndexPath *)indexPath {
  static NSString *CellIdentifier = @"BookCell";
  Books *bookDetails;
   
  // Populate our tableView with all items from our resultset
  bookDetails = [fetchedResultsController
  objectAtIndexPath:indexPath];
   
  UITableViewCell *cell = [tableView
  dequeueReusableCellWithIdentifier:CellIdentifier];
  if (cell == nil) {
      cell = [[UITableViewCell alloc] 
      initWithStyle:UITableViewCellStyleSubtitle
      reuseIdentifier:CellIdentifier];
  }
  // Configure the cell...
  cell.textLabel.text = bookDetails.title;
  cell.detailTextLabel.text = bookDetails.author;
  cell.showsReorderControl = YES;
  [tableView setAllowsSelection:YES];
  return cell;
}</pre></div></li></ol></div></div><div><div><div><div><h2 class="title"><a id="ch08lvl2sec309"/>How it works...</h2></div></div></div><p>In this recipe, we begin by setting the title for our navigation bar, and then call the <code class="literal">populateBookDetails</code> <a id="id829" class="indexterm"/>method that will be used to populate the database object items to our table view. We then defined the table entity that we want to use as our main data source and then created an instance to our <a id="id830" class="indexterm"/>
<code class="literal">fetchRequest</code> object that will be used to hold the returned items. Next, we specified that we would like to have the results sorted by <code class="literal">displayOrder</code> in ascending order and proceeded to execute the record set and check for any errors that occurred using the <code class="literal">performFetch</code> <a id="id831" class="indexterm"/>method and then save the result set to our <code class="literal">fetchedObjects</code> <a id="id832" class="indexterm"/>property, and call the <code class="literal">reloadData</code> method on <a id="id833" class="indexterm"/>our table view control to redisplay the records. Next, we modified our <code class="literal">viewDidAppear</code> method to handle the refreshing of our table view control whenever the view reappears, and then set the number of sections and rows that <a id="id834" class="indexterm"/>
<a id="id835" class="indexterm"/>our table view will contain. Finally, we supply the cells to reuse identifier of the <code class="literal">UITableViewController</code> cell that we set up previously, then assigned each of the properties from our <code class="literal">BookDetails</code> array, and write it to each of the cell labels.</p><div><div><h3 class="title"><a id="note60"/>Note</h3><p>Whenever you reference the <code class="literal">reuse</code> identifier as a parameter to the following method called <code class="literal">dequeueReusableCellWithIdentifier</code>, this automatically creates a new copy of the prototype, and returns the object back to you.</p></div></div></div><div><div><div><div><h2 class="title"><a id="ch08lvl2sec310"/>See also</h2></div></div></div><div><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">The <em>Inserting data within our Core Data data model</em> recipe</li></ul></div></div></div>
<div><div><div><div><h1 class="title"><a id="ch08lvl1sec87"/>Inserting data within our Core Data data model</h1></div></div></div><p>In this recipe we <a id="id836" class="indexterm"/>
<a id="id837" class="indexterm"/>will learn how to write to the data fields contained within our core data model.</p><div><div><div><div><h2 class="title"><a id="ch08lvl2sec311"/>Getting ready</h2></div></div></div><p>Following on from our previous recipe, we will learn how simple it is to update the contents of our Core Data database fields with some data. </p></div><div><div><div><div><h2 class="title"><a id="ch08lvl2sec312"/>How to do it...</h2></div></div></div><p>To begin, follow these simple steps as outlined in the following order:</p><div><ol class="orderedlist arabic"><li class="listitem">Open the <code class="literal">BooksViewController.m</code> implementation file from the <strong>Project Navigator</strong> window.</li><li class="listitem">Modify the <code class="literal">btnAdd:</code> method as shown in the following code snippet.<div><pre class="programlisting">#pragma mark method called when the user presses the Add button
-(IBAction)btnAdd:(id)sender{
   UIAlertView *alert = [[UIAlertView alloc] initWithTitle:@"Add 
   Book Details" message:@"\n\n\n\n" delegate:self
   cancelButtonTitle:@"Cancel" otherButtonTitles:@"OK", nil];
   bookTitle = [[UITextField alloc]
   initWithFrame:CGRectMake(12.0, 45.0, 260.0, 25.0)];
   [bookTitle setPlaceholder:@"Book Title:"];
   [bookTitle setBackgroundColor:[UIColor whiteColor]];
   [alert addSubview:bookTitle];
   bookAuthor = [[UITextField alloc] 
   initWithFrame:CGRectMake(12.0, 80.0, 260.0, 25.0)];
   [bookAuthor setPlaceholder:@"Author:"];
   [bookAuthor setBackgroundColor:[UIColor whiteColor]];
   [alert addSubview:bookAuthor];
   bookPublisher = [[UITextField alloc] 
   initWithFrame:CGRectMake(12.0, 80.0+35.0, 260.0, 25.0)];
   [bookPublisher setPlaceholder:@"Publisher:"];
   [bookPublisher setBackgroundColor:[UIColor whiteColor]];
   [alert addSubview:bookPublisher];

   // Show our Alert Dialog
   [alert show];
}</pre></div></li><li class="listitem">Next, create the <a id="id838" class="indexterm"/><a id="id839" class="indexterm"/>following code sections, as specified in the code snippet.<div><pre class="programlisting">#pragma mark method called and uses the data entered by the btnAdd method
-(void)alertView:(UIAlertView *)alertView clickedButtonAtIndex:(NSInteger)buttonIndex {
   NSString *title = [alertView buttonTitleAtIndex:buttonIndex];
   if ([title isEqualToString:@"OK"]) {
      // Set a pointer to our Books database table schema
      Books *book = (Books *)[NSEntityDescription
      insertNewObjectForEntityForName:@"Books" 
      inManagedObjectContext:managedObjectContext];

      NSMutableArray *array = [[fetchedResultsController
      fetchedObjects] mutableCopy];
      
      // Assign our text fields to each of their attributes
      [book setTitle:bookTitle.text];
      [book setAuthor:bookAuthor.text];
      [book setPublisher:bookPublisher.text];
      [book setValue:[NSNumber numberWithInt:[array count] == 0 ? 
      0 : ([array count] + 1)] forKey:@"displayOrder"];
      
      NSError *error;
      if (![managedObjectContext save:&amp;error]) {
         // Record could not be saved error message
         UIAlertView *alertView = [[UIAlertView alloc] 
         initWithTitle:@"Book Details"
         message:@"There was a problem saving the book details."
         delegate:self
         cancelButtonTitle:@"OK"
         otherButtonTitles:nil];
         
         [alertView show];
      }
      [self populateBookDetails];
   }
}</pre></div></li></ol></div></div><div><div><div><div><h2 class="title"><a id="ch08lvl2sec313"/>How it works...</h2></div></div></div><p>In this recipe, we start by dynamically creating each of our fields that will be accepting user input and positioning these within a <code class="literal">UIAlertView</code> dialog, and then adding this as a subview to the initial view controller. Next, we check to see if we have pressed the <strong>OK</strong> button before we create a <a id="id840" class="indexterm"/>
<a id="id841" class="indexterm"/>managed object context that is used to create a new managed object using the <code class="literal">Books</code> entity description. </p><p>We use the <code class="literal">getters</code> and <code class="literal">setters</code> method <a id="id842" class="indexterm"/>
<a id="id843" class="indexterm"/>for each of the schema fields of the managed object to set each of the attributes values of the managed object based on what has been entered by the user, earlier. Finally the context is instructed to save the changes to the persistent store, with a call to the context's <code class="literal">save</code> method. Any errors detected during <a id="id844" class="indexterm"/>
<a id="id845" class="indexterm"/>the save operation to our Core Data data model will be displayed within the <code class="literal">UIAlertView</code> dialog box. To conclude, we refresh the table view to show that the new record was added.</p></div><div><div><div><div><h2 class="title"><a id="ch08lvl2sec314"/>See also</h2></div></div></div><div><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">The <em>Delete an item from the Table View using Core Data</em> recipe</li></ul></div></div></div>
<div><div><div><div><h1 class="title"><a id="ch08lvl1sec88"/>Delete an item from the Table View using Core Data</h1></div></div></div><p>In this recipe we will <a id="id846" class="indexterm"/>
<a id="id847" class="indexterm"/>
<a id="id848" class="indexterm"/>learn how to delete an item from a Table View, as well our Core Data model.</p><div><div><div><div><h2 class="title"><a id="ch08lvl2sec315"/>Getting ready</h2></div></div></div><p>Following on from our previous recipe, we will learn how to delete a row from our Table View, and permanently remove this from our Core Data database. </p></div><div><div><div><div><h2 class="title"><a id="ch08lvl2sec316"/>How to do it...</h2></div></div></div><p>To begin, follow these simple steps as outlined in the following order:</p><div><ol class="orderedlist arabic"><li class="listitem">Open the <code class="literal">BooksViewController.m</code> implementation file from the <strong>Project Navigator</strong> window.</li><li class="listitem">Modify the <code class="literal">tableView:commitEditingStyle:</code> method as shown in the following code snippet.<div><pre class="programlisting">- (void)tableView:(UITableView *)tableViewcommitEditingStyle:(UITa
bleViewCellEditingStyle)editingStyleforRowAtIndexPath:(NSIndexPa
th *)indexPath {
   if (editingStyle == UITableViewCellEditingStyleDelete) {
      // Turn on table view animations
      [self.tableView beginUpdates];

      // Get the item to delete from our row
    Books *itemToDelete = [fetchedResultsController
    objectAtIndexPath:indexPath];
   // Delete the item in Core Data
   [self.managedObjectContext deleteObject:itemToDelete];
      
   // Commit the deletion
      NSError *error;
      if (![self.managedObjectContext save:&amp;error]) {
         NSLog(@"There was a problem deleting the Book %@",[error 
         domain]);
      }
      // Delete the (now empty) row on the table
      [self.tableView deleteRowsAtIndexPaths:[NSArray
      arrayWithObject:indexPath] 
      withRowAnimation:UITableViewRowAnimationFade];

      [self populateBookDetails];
      
      // Turn off table animations
      [self.tableView endUpdates];
    }
    // Finally, reload data in view
    [self.tableView reloadData];
}</pre></div></li><li class="listitem">Then, <strong>Build</strong> and <strong>Run</strong> the application by choosing <strong>Product | Run</strong> from the <strong>Product</strong> menu, or alternatively pressing <em>Command + R</em>.</li></ol></div><p>When the compilation completes, <a id="id849" class="indexterm"/>
<a id="id850" class="indexterm"/>
<a id="id851" class="indexterm"/>swipe a selected row to display the <strong>Delete</strong> button. </p><div><img src="img/3349OT_08_05.jpg" alt="How to do it..."/></div></div><div><div><div><div><h2 class="title"><a id="ch08lvl2sec317"/>How it works...</h2></div></div></div><p>In this recipe, we start by determining the type of action currently being performed within the Table View, which is <a id="id852" class="indexterm"/>determined by the <code class="literal">UITableViewCellEditingStyle</code> class. Next, we compare this against the <code class="literal">UITableViewCellEditingStyleDelete</code> constant variable, and if the condition is met, we remove the selected book <a id="id853" class="indexterm"/>details at the selected row from our <code class="literal">Books</code> database, and then refresh the Table View data source. If any errors have <a id="id854" class="indexterm"/>
<a id="id855" class="indexterm"/>
<a id="id856" class="indexterm"/>been detected during the removal process, these are then logged out to the Debug window.</p></div></div>
<div><div><div><div><h1 class="title"><a id="ch08lvl1sec89"/>Reordering rows within a Table View</h1></div></div></div><p>In this recipe we will <a id="id857" class="indexterm"/>
<a id="id858" class="indexterm"/>learn how to delete an item from a Table View, as well our core data model.</p><div><div><div><div><h2 class="title"><a id="ch08lvl2sec318"/>Getting ready</h2></div></div></div><p>Following on from our previous recipe, we will learn how to delete a row from our Table View, and permanently remove this from our Core Data database. </p></div><div><div><div><div><h2 class="title"><a id="ch08lvl2sec319"/>How to do it...</h2></div></div></div><p>To begin, follow these simple steps as outlined in the following order:</p><div><ol class="orderedlist arabic"><li class="listitem">Open the <code class="literal">BooksViewController.m</code> implementation file from the <strong>Project Navigator</strong> window.</li><li class="listitem">Modify the <code class="literal">btnSortOrder:</code> method as shown in the following code snippet.<div><pre class="programlisting">#pragma mark method called when the user presses the Display Order button
- (IBAction)btnSortOrder:(id)sender {
   if ([btnSortOrder.title isEqualToString:@"Sort Order"]){
      self.tableView.editing = YES;
      [btnSortOrder setTitle:@"Done"];
   }
   else if ([btnSortOrder.title isEqualToString:@"Done"]) {
      [btnSortOrder setTitle:@"Sort Order"];
      self.tableView.editing = NO;
   }
}</pre></div></li><li class="listitem">Next, create the following code sections, as specified in the code snippet.<div><pre class="programlisting">#pragma mark method to allow for rows to be moved around.
- (BOOL)tableView:(UITableView *)sender canMoveRowAtIndexPath:(NSIndexPath *)indexPath {
   return YES;
}
#pragma mark Change the order of the data.
- (void)tableView:(UITableView *)sender 
moveRowAtIndexPath:(NSIndexPath *)sourcePath
toIndexPath:(NSIndexPath *)destinationPath
{
   NSMutableArray *array = [[fetchedResultsController
   fetchedObjects] mutableCopy];
   
   id objectToMove = [array objectAtIndex:sourcePath.row];
   [array removeObjectAtIndex:sourcePath.row];
   [array insertObject:objectToMove atIndex:destinationPath.row];

   for (int i=0; i&lt;[array count]; i++) {
      [(NSManagedObject *)[array objectAtIndex:i] 
      setValue:[NSNumber numberWithInt:i] 
      forKey:@"displayOrder"];
   }
   NSError *error;
   BOOL success = [[self managedObjectContext] save:&amp;error];
   if (!success) {
      // Handle error
      NSLog(@"There was a problem updating the display order 
           %@",[error domain]);
   }
}</pre></div></li><li class="listitem">Then, <strong>Build</strong> and <strong>Run</strong> the application by choosing <strong>Product | Run</strong> from the <strong>Product</strong> menu, or alternatively pressing <em>Command + R</em>.</li></ol></div><p>When the compilation completes, <a id="id859" class="indexterm"/>
<a id="id860" class="indexterm"/>tap the <strong>Sort Order</strong> button to enable our table view to support editing, and allow rows to be moved around.</p><div><img src="img/3349OT_08_06.jpg" alt="How to do it..."/></div></div><div><div><div><div><h2 class="title"><a id="ch08lvl2sec320"/>How it works...</h2></div></div></div><p>In this recipe, we start by turning on table editing when the <strong>Sort Order</strong> button is pressed by setting the <code class="literal">self.tableView.editing</code> <a id="id861" class="indexterm"/>property to <code class="literal">YES</code>. Next, we implement the <code class="literal">canMoveRowAtIndexPath:</code> method <a id="id862" class="indexterm"/>that will be used to determine whether a row can be moved within the table view. In the <a id="id863" class="indexterm"/>
<code class="literal">moveRowAtIndexPath:</code> method, we create an <code class="literal">NSMutableArray</code> that will be used to store our data model results, returned by the <code class="literal">NSFetchedResultsController</code> <a id="id864" class="indexterm"/>class. Next, we then reiterate over the items and update the <code class="literal">displayOrder</code> field for each <a id="id865" class="indexterm"/>
<a id="id866" class="indexterm"/>item, before saving the managed object context with the reordered results.</p></div><div><div><div><div><h2 class="title"><a id="ch08lvl2sec321"/>There's more…</h2></div></div></div><p>The reason we use an <code class="literal">NSMutableArray</code> array is because we can insert and remove managed object pointers to and from the array without triggering any changes to the data store. Any changes you make to the object will be reflected immediately, which is often what you want to do, but in cases like this one, we don't want to apply these immediately.</p></div><div><div><div><div><h2 class="title"><a id="ch08lvl2sec322"/>See also</h2></div></div></div><div><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">The <em>Filtering and searching for data within a Table View</em> recipe</li></ul></div></div></div>
<div><div><div><div><h1 class="title"><a id="ch08lvl1sec90"/>Filtering and searching for data within a Table View</h1></div></div></div><p>In this recipe we <a id="id867" class="indexterm"/>
<a id="id868" class="indexterm"/>will learn how to search through our Table View to filter list items.</p><div><div><div><div><h2 class="title"><a id="ch08lvl2sec323"/>Getting ready</h2></div></div></div><p>Following on from our previous recipe, we will learn how to use the <code class="literal">UISearchBar</code> control to allow us to filter and narrow down the results of our book details. </p></div><div><div><div><div><h2 class="title"><a id="ch08lvl2sec324"/>How to do it...</h2></div></div></div><p>To begin, follow these simple steps as outlined in the following order:</p><div><ol class="orderedlist arabic"><li class="listitem">Select the <code class="literal">MainStoryboard.storyboard</code> file from the <strong>Project Navigator</strong> window.</li><li class="listitem">From <strong>Object Library</strong>, select and drag a (<code class="literal">UISearchBar</code>) <strong>Search</strong> <strong>Bar</strong> and <strong>Search Display Controller </strong>control to the top of the navigation bar of our (<code class="literal">UITableViewController</code>) control that we added in previous steps.</li><li class="listitem">Next, create the <code class="literal">outlet</code> method for the search bar and name it <code class="literal">filteredResults</code>. </li><li class="listitem">Open the <code class="literal">BooksViewController.h</code> interface file from the <strong>Project</strong> <strong>Navigator</strong> window.</li><li class="listitem">Next, modify the interface file and add the following highlighted code sections. <div><pre class="programlisting">//  BooksViewController.h
//  BooksLibrary
//  Created by Steven F Daniel on 03/12/12.
//  Copyright (c) 2012 GenieSoft Studios. All rights reserved.

#import &lt;UIKit/UIKit.h&gt;
#import "Books.h"

<strong>@interface BooksViewController : UITableViewController</strong>
<strong>&lt;UISearchBarDelegate&gt;{</strong>
...
    ...
IBOutlet UISearchBar *filteredResults;
}
    ...
    ...
// Property getters and setters for our UI
@property (strong, nonatomic) IBOutlet UISearchBar       *filteredResults;</pre></div></li><li class="listitem">Now that we have created our outlets and extended our class to include the <code class="literal">UISearchBarDelegate</code> <a id="id869" class="indexterm"/>object so that we can access the properties and methods. Our next step is to, start adding the <a id="id870" class="indexterm"/><a id="id871" class="indexterm"/>additional content to our <code class="literal">BooksViewController</code> class that will provide us with the ability to filter the results of our list.</li><li class="listitem">Open the <code class="literal">BooksViewController.m</code> implementation file from the <strong>Project Navigator</strong> window and create the following code sections, as specified in the code snippet.<div><pre class="programlisting">//
//  BooksViewController.m
//  BooksLibrary
//
//  Created by Steven F Daniel on 03/12/12.
//  Copyright (c) 2012 GenieSoft Studios. All rights reserved.
//

#import "BooksViewController.h"

@implementation BooksViewController

@synthesize   fetchedResultsController;
@synthesize   managedObjectContext;
@synthesize   btnAdd;
@synthesize   btnSortOrder;
@synthesize   btnConnect;
@synthesize   btnTransfer;
<strong>@synthesize filteredResults;</strong>

#pragma mark method called by the UISearchBar Delegates
-(void)searchBarTextDidBeginEditing:(UISearchBar *)searchBar {
   // Only show the Search Bar's cancel button while in edit mode
   filteredResults.showsCancelButton= YES;
   filteredResults.autocorrectionType = 
   UITextAutocorrectionTypeNo;
}
#pragma mark Hides our Search Bar's cancel button when not in edit mode
-(void)searchBarTextDidEndEditing:(UISearchBar *)searchBar {
   filteredResults.showsCancelButton = NO;
}
#pragma mark reload our contact details
-(void)searchBarCancelButtonClicked:(UISearchBar *)searchBar {
    [self populateBookDetails];
}
#pragma mark use an NSPredicate combined with the fetchedResultsController to perform the search
-(void)searchBarSearchButtonClicked:(UISearchBar *)theSearchBar {
   if (![destinationSearchBar.text isEqualToString:@""]) {
      NSPredicate *predicate =[NSPredicate
      predicateWithFormat:@"publisher contains[cd] %@", 
      self.filteredResults.text];
      [fetchedResultsController.fetchRequest
      setPredicate:predicate];
}
else {
      // We have hit the cancel button, reload our TableView
      [filteredResults resignFirstResponder];
      [self.tableView reloadData];
      return;
}
NSError *error = nil;
if (![[self fetchedResultsController] performFetch:&amp;error]) {
    // Handle the error that was caught by the exception
    NSLog(@"Unresolved error %@, %@", error, [error 
    userInfo]);
    exit(-1);
} 
// Return the number of rows to populate our Table View 
// controller with.
fetchedObjects = fetchedResultsController.fetchedObjects;
   
// reload the TableView Controller and hide the keyboard.
[filteredResults resignFirstResponder];
[self.tableView  reloadData];

// Display the total number of matching records found.
  NSString *searchResults = [[NSString alloc] 
  initWithFormat:@"%d matching record(s) 
  found.",[fetchedObjects count]];
  UIAlertView *alertView = [[UIAlertView alloc]
  initWithTitle:@"Search Results" 
  message:searchResults
  delegate:self
  cancelButtonTitle:@"OK" 
  otherButtonTitles:nil];

  [alertView show];   
}</pre></div></li></ol></div></div><div><div><div><div><h2 class="title"><a id="ch08lvl2sec325"/>How it works...</h2></div></div></div><p>In this recipe, we start by extending our <a id="id872" class="indexterm"/>
<code class="literal">BooksViewController</code> class to use the <code class="literal">UISearchBarDelegate</code> class protocols so that we have access to its properties and methods and then change the appearance of the <strong>Search</strong> bar when a user taps in it. Next, we specify to show the <strong>Cancel</strong> button when the user is in <strong>Edit</strong> mode, and then <a id="id873" class="indexterm"/>
<a id="id874" class="indexterm"/>turn off the <strong>Auto Correction</strong> feature and then proceed to hide the <strong>Cancel</strong> button of the <strong>Search </strong>bar when the user has finished with editing. In our next step, we call our <a id="id875" class="indexterm"/>
<code class="literal">populateBookDetails</code> method to get the updated records from the database, and populate this to our Table View control before proceeding to cycle through our data source and select those objects that have the occurrence of the search string. </p><p>Finally, we proceed to reload our Table View with the search data that was returned to be matching, and then display the total number of records that match our search string within a <code class="literal">UIAlertView</code> dialog box. If the <strong>Search</strong> criterion is empty, we perform a comparison using the <code class="literal">isEqualToString</code> method and check to see if the string is empty. We then resign the keyboard and reload all book details from our data model.</p></div><div><div><div><div><h2 class="title"><a id="ch08lvl2sec326"/>See also</h2></div></div></div><div><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">The <em>Working with the different keyboard styles</em> recipe</li></ul></div></div></div>
<div><div><div><div><h1 class="title"><a id="ch08lvl1sec91"/>Working with the different keyboard styles</h1></div></div></div><p>In this recipe we will learn how to <a id="id876" class="indexterm"/>delete an item from a table view, as well our core data model.</p><div><div><div><div><h2 class="title"><a id="ch08lvl2sec327"/>Getting Ready</h2></div></div></div><p>Following on from our previous recipe, we will learn how to apply customized keyboard styles to fields within our <code class="literal">UIAlertView</code> as defined in our <code class="literal">btnAdd</code> method that we defined in an earlier recipe. </p></div><div><div><div><div><h2 class="title"><a id="ch08lvl2sec328"/>How to do it...</h2></div></div></div><p>To begin, follow these simple steps as <a id="id877" class="indexterm"/>outlined in the following order:</p><div><ol class="orderedlist arabic"><li class="listitem">Open the <code class="literal">BooksViewController.m</code> implementation file from the <strong>Project Navigator</strong> window.</li><li class="listitem">Modify the <code class="literal">btnAdd</code> method to apply a custom keyboard type for our <code class="literal">bookTitle</code> field, as shown by the highlighted code section in the following code snippet.<div><pre class="programlisting">   UIAlertView *alert = [[UIAlertView alloc] 
   initWithTitle:@"Add Book Details" message:@"\n\n\n\n" 
   delegate:self cancelButtonTitle:@"Cancel" 
   otherButtonTitles:@"OK", nil];
   bookTitle = [[UITextField alloc] 
   initWithFrame:CGRectMake(12.0, 45.0, 260.0, 25.0)];
   [bookTitle setPlaceholder:@"Book Title:"];
   [bookTitle setBackgroundColor:[UIColor whiteColor]];
<strong>   bookTitle.keyboardType = UIKeyboardTypeAlphabet;</strong>
   [alertaddSubview:bookTitle];</pre></div></li></ol></div></div><div><div><div><div><h2 class="title"><a id="ch08lvl2sec329"/>How it works...</h2></div></div></div><p>In this recipe, we begin by updating the <a id="id878" class="indexterm"/>
<code class="literal">keyboardType</code> property of the <code class="literal">bookTitleUITextField</code> control and then specify the <code class="literal">UIKeyboardTypeAlphabet</code> variable as the keyboard type to use. </p></div><div><div><div><div><h2 class="title"><a id="ch08lvl2sec330"/>There's more…</h2></div></div></div><p>The <code class="literal">keyboardType</code> property <a id="id879" class="indexterm"/>accepts an enumeration type named <code class="literal">UIKeyboardType</code>. </p><p>The following table explains some of these types:</p><div><table border="1"><colgroup><col style="text-align: left"/><col style="text-align: left"/></colgroup><thead><tr><th style="text-align: left" valign="bottom">
<p>Keyboard type</p>
</th><th style="text-align: left" valign="bottom">
<p>Description</p>
</th></tr></thead><tbody><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">UIKeyboardTypeDefault</code>
</p>
</td><td style="text-align: left" valign="top">
<p>Default <a id="id880" class="indexterm"/>keyboard for the current input method.</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">UIKeyboardTypeASCIICapable</code>
</p>
</td><td style="text-align: left" valign="top">
<p>Displays <a id="id881" class="indexterm"/>standard ASCII characters.</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">UIKeyboardTypeNumbersAndPunctuation</code>
</p>
</td><td style="text-align: left" valign="top">
<p>Displays <a id="id882" class="indexterm"/>numbers and punctuation keyboard.</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">UIKeyboardTypeURL</code>
</p>
</td><td style="text-align: left" valign="top">
<p>Displays a <a id="id883" class="indexterm"/>keyboard optimized for URL entry.</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">UIKeyboardTypeNumberPad</code>
</p>
</td><td style="text-align: left" valign="top">
<p>Displays a <a id="id884" class="indexterm"/>numeric keypad designed for PIN entry. </p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">UIKeyboardTypePhonePad</code>
</p>
</td><td style="text-align: left" valign="top">
<p>Displays a <a id="id885" class="indexterm"/>keypad designed for entering telephone numbers.</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">UIKeyboardTypeNamePhonePad</code>
</p>
</td><td style="text-align: left" valign="top">
<p>Displays a <a id="id886" class="indexterm"/>keypad designed for <a id="id887" class="indexterm"/>entering a person's name or phone number.</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">UIKeyboardTypeEmailAddress</code>
</p>
</td><td style="text-align: left" valign="top">
<p>Displays a <a id="id888" class="indexterm"/>keyboard optimized for specifying email addresses.</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">UIKeyboardTypeDecimalPad</code>
</p>
</td><td style="text-align: left" valign="top">
<p>Displays a <a id="id889" class="indexterm"/>keyboard with numbers and a decimal point.</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">UIKeyboardTypeTwitter</code>
</p>
</td><td style="text-align: left" valign="top">
<p>Displays a <a id="id890" class="indexterm"/>keyboard optimized for twitter text entry, with easy access to the @ and # characters.</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">UIKeyboardTypeAlphabet</code>
</p>
</td><td style="text-align: left" valign="top">
<p>This has been <a id="id891" class="indexterm"/>depreciated, but uses the keyboard that displays standard ASCII characters.</p>
</td></tr></tbody></table></div><div><div><h3 class="title"><a id="note61"/>Note</h3><p>For more information on the <a id="id892" class="indexterm"/>
<code class="literal">UIKeyboardType</code> class, as well as the various keyboard types, refer to the Apple Developer Documentation located at: <a class="ulink" href="http://developer.apple.com/library/ios/#DOCUMENTATION/UIKit/Reference/UITextInputTraits_Protocol/Reference/UITextInputTraits.html">http://developer.apple.com/library/ios/#DOCUMENTATION/UIKit/Reference/UITextInputTraits_Protocol/Reference/UITextInputTraits.html</a>
</p></div></div></div><div><div><div><div><h2 class="title"><a id="ch08lvl2sec331"/>See also</h2></div></div></div><div><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">The <em>Inserting data within our Core Data data model</em> recipe</li></ul></div></div></div>
<div><div><div><div><h1 class="title"><a id="ch08lvl1sec92"/>Transferring data to another device using bluetooth</h1></div></div></div><p>In this recipe we will l<a id="id893" class="indexterm"/>
<a id="id894" class="indexterm"/>earn how to use the <code class="literal">GameKit</code> framework APIs that allow for communication over a Bluetooth network.</p><div><div><div><div><h2 class="title"><a id="ch08lvl2sec332"/>Getting ready</h2></div></div></div><p>Following on from our previous recipe, we will look at how we can implement these features into our application, to handle transfer our book details from one iOS device to another. </p></div><div><div><div><div><h2 class="title"><a id="ch08lvl2sec333"/>How to do it...</h2></div></div></div><p>To begin, follow these simple steps as outlined in the following order:</p><div><ol class="orderedlist arabic"><li class="listitem">Open the <code class="literal">BooksViewController.h</code> interface file from the <strong>Project</strong> <strong>Navigator</strong> window.</li><li class="listitem">Next, modify the interface file and add the following highlighted code sections. <div><pre class="programlisting">//  BooksViewController.h
//  BooksLibrary
//  Created by Steven F Daniel on 03/12/12.
//  Copyright (c) 2012 GenieSoft Studios. All rights reserved.

#import  &lt;UIKit/UIKit.h&gt;
<strong>#import &lt;GameKit/GameKit.h&gt;</strong>
#import  "Books.h"

<strong>@interface BooksViewController : UITableViewController</strong>
<strong>&lt;UISearchBarDelegate, GKSessionDelegate, GKPeerPickerControllerDelegate&gt;{</strong>
...
    ...
<strong>   GKSession              *currentSession;</strong>
<strong>   GKPeerPickerController *peerPicker;</strong>
<strong>   NSString               *itemSelected;</strong>
}
    ...
    ...
// Bluetooth session objects
<strong>@property (strong, nonatomic) GKSession *currentSession;</strong>
</pre></div><p>Now that we have created our properties and extended our class to include the <code class="literal">GKSessionDelegate</code> and <code class="literal">GKPeerPickerControllerDelegate</code> objects so that we can access their properties and methods. Our next step is to start adding the additional content to our <code class="literal">BooksViewController</code> class that will provide us with the ability to send details over Bluetooth.</p></li><li class="listitem">Open the <code class="literal">BooksViewController.m</code> implementation file from the <strong>Project Navigator</strong> window and enter in the following code highlighted sections.<div><pre class="programlisting">//
//  BooksViewController.m
//  BooksLibrary
//
//  Created by Steven F Daniel on 03/12/12.
//  Copyright (c) 2012 GenieSoft Studios. All rights reserved.
//

#import "BooksViewController.h"

@implementation BooksViewController

@synthesize fetchedResultsController;
@synthesize managedObjectContext;
@synthesize btnAdd;
@synthesize btnSortOrder;
@synthesize btnConnect;
@synthesize btnTransfer;
@synthesize currentSession;
<strong>@synthesize filteredResults;</strong>
</pre></div></li><li class="listitem">Next, modify the <a id="id895" class="indexterm"/><a id="id896" class="indexterm"/><a id="id897" class="indexterm"/><code class="literal">btnConnect</code> method, as shown in the following code snippet.<div><pre class="programlisting">#pragma mark called when the user presses the Connect button
- (IBAction)btnConnect:(id)sender {
   if ([btnConnect.title isEqualToString:@"Connect"]) {
      [btnConnect setTitle:@"Disconnect"];
      peerPicker = [[GKPeerPickerController alloc]init];
      peerPicker.delegate = self;
      peerPicker.connectionTypesMask = 
      GKPeerPickerConnectionTypeNearby;
      [peerPicker show];
      btnTransfer.enabled = YES;
   }
   else if ([btnConnect.title isEqualToString:@"Disconnect"]) {
      [btnConnectsetTitle:@"Connect"];
      [self.currentSession disconnectFromAllPeers];
      currentSession = nil;
      btnTransfer.enabled = NO;
   }
}</pre></div></li><li class="listitem">Next, modify the <a id="id898" class="indexterm"/><a id="id899" class="indexterm"/><a id="id900" class="indexterm"/><code class="literal">btnTransfer</code> method, as shown in the following code snippet.<div><pre class="programlisting">#pragma mark called when the user presses the Transfer button
- (IBAction)btnTransfer:(id)sender {
   // Converts an NSString object to NSData
   NSData *data;
   data = [itemSelected
   dataUsingEncoding:NSASCIIStringEncoding];

   [self.currentSession sendDataToAllPeers:data
   withDataMode:(GKSendDataReliable) error:nil];
}</pre></div></li><li class="listitem">Next, create the following code sections, as specified in the code snippet.<div><pre class="programlisting">#pragma mark Handle Bluetooth capabilities using the GameKit framework.
-(void)peerPickerController:(GKPeerPickerController *)picker didConnectPeer:(NSString *)peerIDtoSession:(GKSession *)session{
   self.currentSession = session;
   session.delegate = self;
   [sessionsetDataReceiveHandler:self withContext:nil];
   picker.delegate = nil;
   [picker dismiss];
}
#pragma mark Called when a connection has been made to Bluetooth,
#pragma mark details are added to the database on the receiving iOS device.
-(void)receiveData:(NSData *)data fromPeer:(NSString *)peer inSession:(GKSession *)session context:(void *)context {
   // Convert our NSData type to NSString
   NSString *strData;
   strData = [[NSString alloc] initWithData:data
   encoding:NSASCIIStringEncoding];
   
   // Split out our data and place the contents into an array.
   NSArray  *stringComponents = [strData
   componentsSeparatedByString:@"~"];
   NSMutableArray *myArray = [[NSMutableArray alloc] 
    initWithCapacity:1000];
   [myArray addObjectsFromArray:stringComponents];

   // Insert the passed record details into our database.
   Books *bookDetails = (Books *)[NSEntityDescription
   insertNewObjectForEntityForName:@"Books" 
   inManagedObjectContext:managedObjectContext];
   
   [bookDetails setTitle:[myArray objectAtIndex:0]];
   [bookDetails setPublisher:[myArray objectAtIndex:1]];
   [bookDetails setAuthor:[myArray objectAtIndex:2]];
   [bookDetails setDisplayOrder:[myArray objectAtIndex:3]];

   NSError *error;
   if (![managedObjectContext save:&amp;error]) {
       // Display error message stating that record not saved.
       UIAlertView *alertView = [[UIAlertView alloc] 
       initWithTitle:@"Book Library Details" 
       message:@"There was a problem saving the book details."
       delegate:self
       cancelButtonTitle:@"OK" 
       otherButtonTitles:nil];
       [alertView show];   
   }
   // Reload our book details from our database
   [self populateBookDetails];
}
#pragma mark called when user cancels the Bluetooth connection
-(void)peerPickerControllerDidCancel:(GKPeerPickerController *)picker {
   [btnTransfer setTitle:@"Transfer Book"];
   peerPicker = nil;
   peerPicker.delegate = nil;
   [peerPicker dismiss];
}
#pragma mark called when a change in state has been detected.
-(void)session:(GKSession *)session peer:(NSString *)peerIDdidChangeState:(GKPeerConnectionState)state {
   NSString *GKPeerStateInfo;
   switch (state) {
      case GKPeerStateAvailable: 
           GKPeerStateInfo = @"Wi-Fi is Available";      
           break;
      case GKPeerStateUnavailable:  
           GKPeerStateInfo = @"Wi-Fi is not Available";  
           break;
      case GKPeerStateConnecting:   
           GKPeerStateInfo = @"Establishing Connection";
        break;
      case GKPeerStateConnected:    
           GKPeerStateInfo = @"Connection Successful"; 
           break;
      case GKPeerStateDisconnected: 
           GKPeerStateInfo = @"Disconnected from Session";
             currentSession = nil; 
           break;
   }
   // Display the current connection state.
   NSLog(@"Connection State: %@", GKPeerStateInfo);
}
#pragma mark - Table view delegate
- (void)tableView:(UITableView *)tableViewdidSelectRowAtIndexPath:(NSIndexPath *)indexPath {
   // Get the currently selected item from our resultset
   Books *bookDetails = [fetchedResultsController
   objectAtIndexPath:indexPath];
  // Get the currently selected item within our tableView
  itemSelected =[NSString stringWithFormat:@"%@~%@~%@~%@",
            bookDetails.title,
            bookDetails.publisher,
            bookDetails.author,
            bookDetails.displayOrder];
}</pre></div></li></ol></div></div><div><div><div><div><h2 class="title"><a id="ch08lvl2sec334"/>How it works...</h2></div></div></div><p>In this recipe, we start by extending our <code class="literal">BooksViewController</code> class to use the <code class="literal">GKSessionDelegate</code> and <code class="literal">GKPeerPickerControllerDelegate</code> class protocols so that we have access to its properties and methods that are responsible for handling the Bluetooth functionality, and a <code class="literal">NSString</code> object variable <code class="literal">itemSelected</code> which will be used to store the selected book item from our Table View.</p><p>Next, we declare a <code class="literal">GKSessionDelegate</code> <a id="id901" class="indexterm"/>object that is used to represent an active session between two connected Bluetooth devices, and it allows for sending and receiving of data between the two. <code class="literal">GKPeerPickerControllerDelegate</code> <a id="id902" class="indexterm"/>
<a id="id903" class="indexterm"/>provides a standard UI to let your application discover and connect to another Bluetooth device, and is the easiest way of connecting between devices. </p><p>The <code class="literal">btnConnect:</code> method <a id="id904" class="indexterm"/>checks to see the current value of our button using the <code class="literal">isEqualToString</code> <a id="id905" class="indexterm"/>method and if the value reads <strong>Connect</strong>, we make a call to the <a id="id906" class="indexterm"/>
<code class="literal">GKPeerPickerController</code> class, which displays a standard UI for which you can connect to another Bluetooth device. Alternatively, if you click on <strong>Disconnect</strong>, we make a call to the <code class="literal">disconnectFromAllPeers</code> <a id="id907" class="indexterm"/>method from the <strong>GKSession</strong> object to close the connection between the two devices. The <code class="literal">connectionTypesMask</code> property indicates the types of connections that the user can choose from. </p><div><div><h3 class="title"><a id="note62"/>Note</h3><p>There are two types of connections: <code class="literal">GKPeerPickerConnectionTypeNearby</code> and <code class="literal">GKPeerPickerConnectionTypeOnline</code>. When using Bluetooth communication, use the <strong>GKPeerPickerConnectionTypeNearby</strong> constant. Alternatively, if you want to use Internet-based connectivity use the <strong>GKPeerPickerConnectionTypeOnline</strong> constant.</p></div></div><p>When a Bluetooth connection has been detected between the two devices and the user has selected one of the items to connect to from the list of available devices, the <code class="literal">peerPickerController:didConnectPeer:toSession:</code> method is called and we enable our <strong>Transfer</strong> <a id="id908" class="indexterm"/>button. Once the user has connected to the peer Bluetooth device, you save the <code class="literal">GKSession</code> object to the <code class="literal">currentSession</code> property, which enables you to use the <code class="literal">GKSession</code> object to communicate with the remote device.</p><p>When the user presses the <strong>Transfer</strong> button, it calls the <a id="id909" class="indexterm"/>
<code class="literal">btnTransfer:</code> method that calls the <a id="id910" class="indexterm"/>
<code class="literal">sendDataToAllPeers:</code> method of the <code class="literal">GKSession</code> object to send data to the other device via the <code class="literal">NSData</code> object. We use a variable called <code class="literal">itemSelected</code>, which contains the contact address information to be sent.</p><div><div><h3 class="title"><a id="note63"/>Note</h3><p>When using the <code class="literal">GKSendDataReliable</code> constant, the <code class="literal">GKSession</code> object will continue to send the data until it successfully transmits the data or the connection times out. Alternatively, using <code class="literal">GKSendDataUnreliable</code> indicates that the <code class="literal">GKSession</code> object should send the data only once with no retry.</p></div></div><p>The <code class="literal">receiveData:fromPeer:inSession:context:</code> method of the <code class="literal">GKSession</code> object is called once <a id="id911" class="indexterm"/>connection has been made between the two devices, to handle receiving of data that is sent as a <code class="literal">NSData</code> delimited string. This data needs to be converted into an <code class="literal">NSString</code> object before using the <code class="literal">componentsSeparatedByString</code> string class to split out each field individually, and place these into our <code class="literal">NSMutableArray</code> object variable <code class="literal">myArray</code>.</p><p>Next, we create a new <code class="literal">managedObjectContext</code> instance that points to our <code class="literal">Books</code> entity, and uses the <code class="literal">getter</code> and <code class="literal">setter</code> <a id="id912" class="indexterm"/>
<a id="id913" class="indexterm"/>methods of our <code class="literal">NSManagedObject</code> to assign each array element from our <code class="literal">myArray</code> object, to each of the entity field attributes before the details are then written to the database. Any errors detected during the save operation to our data model, Core Data, will <a id="id914" class="indexterm"/>be displayed within a <code class="literal">UIAlertView</code> dialog box. The <code class="literal">peerPickerControllerDidCancel:</code> method gets called whenever the user cancels out from the Bluetooth picker. Once this happens, we change the title of our <strong>Connect </strong>button and disable our <strong>Transfer</strong> button, before closing the <code class="literal">peerPicker</code> dialog box, releasing the memory allocated.</p><p>The method <code class="literal">didChangeState:</code> gets called whenever a device is connected or disconnected from a session and is smart enough to know when a connection has been established or ended by checking the <a id="id915" class="indexterm"/>
<code class="literal">state</code> property of the <code class="literal">GKPeerConnectionState</code> class <a id="id916" class="indexterm"/>and the constants to determine the type of connection. After we have determined the <code class="literal">state</code> type, we write the connection <code class="literal">state</code> to the console window using the <code class="literal">NSLog</code> statement.</p><p>In our final step, we use the <a id="id917" class="indexterm"/>
<code class="literal">didSelectRowAtIndexPath:</code> method, we construct the book detail information for the selected row. We use the row property of <code class="literal">indexPath</code> to seek inside our <code class="literal">Books</code> array, and extract the record information. We then construct the record as a delimited string and assign it to our <code class="literal">itemSelected</code> <a id="id918" class="indexterm"/>variable, which will be used by the <strong>Transfer</strong> button.</p><div><div><h3 class="title"><a id="note64"/>Note</h3><p>For more information on the <code class="literal">NSMutableArray</code> object, you can refer to the Apple Developer documentation at the following URL: <a class="ulink" href="https://developer.apple.com/library/mac/#documentation/Cocoa/Reference/Foundation/Classes/NSMutableArray_Class/Reference/Reference.html">https://developer.apple.com/library/mac/#documentation/Cocoa/Reference/Foundation/Classes/NSMutableArray_Class/Reference/Reference.html</a>
</p></div></div></div><div><div><div><div><h2 class="title"><a id="ch08lvl2sec335"/>See also</h2></div></div></div><div><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">The <em>Implementing e-mail messaging</em> recipe</li></ul></div></div></div>
<div><div><div><div><h1 class="title"><a id="ch08lvl1sec93"/>Implementing e-mail messaging</h1></div></div></div><p>In this recipe we will learn about <a id="id919" class="indexterm"/>the <code class="literal">MFMailComposeViewController</code> <a id="id920" class="indexterm"/>class, and how we can use this to incorporate e-mail messaging within our application.</p><div><div><div><div><h2 class="title"><a id="ch08lvl2sec336"/>Getting ready</h2></div></div></div><p>Following on from our previous recipe, we will look at how to implement the <code class="literal">sendEmail</code> method to compose an e-mail with the selected book details whenever a transfer has taken place.</p></div><div><div><div><div><h2 class="title"><a id="ch08lvl2sec337"/>How to do it...</h2></div></div></div><p>To begin, follow these simple steps as outlined in the following order:</p><div><ol class="orderedlist arabic"><li class="listitem">Open the <code class="literal">BooksViewController.h</code> interface file from the <strong>Project</strong> <strong>Navigator</strong> window.</li><li class="listitem">Next, modify the interface file and add the following highlighted code sections. <div><pre class="programlisting">//  BooksViewController.h
//  BooksLibrary
//  Created by Steven F Daniel on 03/12/12.
//  Copyright (c) 2012 GenieSoft Studios. All rights reserved.

#import  &lt;UIKit/UIKit.h&gt;
#import  &lt;GameKit/GameKit.h&gt;
<strong>#import &lt;MessageUI/MessageUI.h&gt;</strong>
#import  "Books.h"

<strong>@interface BooksViewController : UITableViewController&lt;UISearchBarDelegate, GKSessionDelegate, GKPeerPickerControllerDelegate, MFMailComposeViewControllerDelegate&gt;</strong>

// Create the class instance methods
<strong>-(void)sendEmail:(NSArray *)bookDetails;</strong>
</pre></div></li><li class="listitem">Open the <code class="literal">BooksViewController.m</code> implementation file from the <strong>Project Navigator</strong> window.</li><li class="listitem">Next, modify the <a id="id921" class="indexterm"/><code class="literal">sendEmail:</code> method, as shown in the following code snippet.<div><pre class="programlisting">#pragma mark sends an email for the chosen book details 
- (void)sendEmail:(NSArray *)bookDetails {
   
MFMailComposeViewController *mailComposer = 
[[MFMailComposeViewController alloc] init];
mailComposer.mailComposeDelegate = self;
   
// Check to make sure that we are set up to send mail
if ([MFMailComposeViewController canSendMail]) {
    [mailComposer setToRecipients:[NSArray
    arrayWithObjects:@"youremail@yourdomain.com",nil]];
    [mailComposer setSubject:@"Book Details"];
    // Book Details for the body of our email message
    NSString *bookItem = [NSString
    stringWithFormat:@"Title:%@\nPublisher:
    %@\nAuthor:%@\nSort Order:%@",
               [bookDetails objectAtIndex:0],
               [bookDetails objectAtIndex:1],
               [bookDetails objectAtIndex:2],
               [bookDetails objectAtIndex:3]];

      [mailComposer setMessageBody:bookItem isHTML:NO];
      [mailComposer.navigationBar setTintColor:[UIColor
       blueColor]];
       mailComposer.modalPresentationStyle = 
       UIModalPresentationFormSheet;
       [self presentViewController:mailComposer animated:YES
       completion:nil];
   }
   else {
      // Error sending the email message, so notify the user.
      UIAlertView *alertMessage = [[UIAlertView alloc] 
      initWithTitle:@"Failure"
      message:@"Your device hasn't been set up for email"
      delegate:nil
      cancelButtonTitle:@"OK"
      otherButtonTitles: nil];
      [alertMessage show];
   }
}
#pragma mark Dismiss our Mail Controller when the user finishes
- (void) mailComposeController:(MFMailComposeViewController *)controller didFinishWithResult:(MFMailComposeResult)result error:(NSError *)error {
   NSString *emailMsg = nil;
   
    // Notifies users about errors associated with the interface
   switch (result) {
           case MFMailComposeResultCancelled: 
                emailMsg = @"Email cancelled"; break;
           case MFMailComposeResultSent:      
                emailMsg = @"Email sent Successfully"; break;
           case MFMailComposeResultFailed:    
                emailMsg = @"Email sending failure";   break;
           default:                           
                emailMsg = @"Problem sending Email"; break;
   }
   // Display the alert dialog based on the message
   UIAlertView *alert = [[UIAlertView alloc]
                  initWithTitle: @"Book Details Email"
                  message: emailMsg
                  delegate: nil
                  cancelButtonTitle:@"OK"
                  otherButtonTitles:nil];
   [alert show];
   
   // make the MFMailComposeViewController disappear
   [self dismissViewControllerAnimated:YES completion:nil];
}</pre></div></li><li class="listitem">Next, we need to modify the <a id="id922" class="indexterm"/><code class="literal">receiveData:</code> <a id="id923" class="indexterm"/>method to <a id="id924" class="indexterm"/>enable e-mailing, as shown in the following code highlighted sections: <div><pre class="programlisting">-(void)receiveData:(NSData *)data fromPeer:(NSString *)peer inSession:(GKSession *)session context:(void *)context
{
   // Convert our NSData type to NSString
   ...
   ...

   NSError *error;
   if (![managedObjectContext save:&amp;error]) {
      ...
   }
   else {
      // Send an email for the received book details
<strong>      [self sendEmail:myArray];</strong>
   }
   ...
}</pre></div></li></ol></div></div><div><div><div><div><h2 class="title"><a id="ch08lvl2sec338"/>How it works...</h2></div></div></div><p>In this recipe, we created a new object instance of the <code class="literal">MFMailComposeViewController </code>class delegate that controls the mail dialog view, thus allowing the user to compose and send e-mail without leaving the application. We proceed to change the color of the mail composition sheet using the <a id="id925" class="indexterm"/>
<code class="literal">navigationBar:setTintColor:</code> method of the controller to red, and set the subject heading and body of our e-mail <a id="id926" class="indexterm"/>message. In our <a id="id927" class="indexterm"/>next step, we set the controllers <code class="literal">mailComposeDelegate</code> to itself, this ensures that our controller receives the <code class="literal">mailComposeController:didFinishWithResult:error:</code> message from the <code class="literal">MFMailComposeViewControllerDelegate</code> protocol when the user finishes with the e-mail dialog box. Finally, we call the controller's <code class="literal">dismissViewControllerAnimated:</code> method to display the e-mail dialog box.</p></div><div><div><div><div><h2 class="title"><a id="ch08lvl2sec339"/>There's more…</h2></div></div></div><p>Deploy the application onto two different iOS devices, and then <strong>Build</strong> and <strong>Run</strong> the application by choosing <strong>Product | Run</strong> from the <strong>Product</strong> menu, or alternatively pressing <em>Command + R</em>.</p><p>When the compilation completes, connect each of the devices using Bluetooth, select a book from the list, and click on the <strong>Connect</strong> button. After a few seconds, a pop up is displayed, and contains a list of the nearby Bluetooth devices that the user can choose from. Once the user has selected a device, confirmation is required from that device to allow the iOS Simulator to establish a connection with it. Once a connection has been established, click on the <strong>Transfer</strong> <a id="id928" class="indexterm"/>button to transmit the book details to the other device. The following screenshot shows the application running within the iOS Simulator and the other running on an iOS device with an Internet connection and Bluetooth connectivity, as well as showing the generated e-mail for the item selected in the list.</p><div><img src="img/3349OT_08_07.jpg" alt="There's more…"/></div></div><div><div><div><div><h2 class="title"><a id="ch08lvl2sec340"/>See also</h2></div></div></div><div><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">The <em>Transferring data to another device using Bluetooth</em> recipe</li></ul></div></div></div></body></html>