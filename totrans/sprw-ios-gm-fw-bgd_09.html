<html><head></head><body><div><div><div><div><h1 class="title"><a id="ch09"/>Chapter 9. Adding Audio to Our Game</h1></div></div></div><p>
<em>In the previous chapter, we learned about artificial intelligence. We learned theory about finite state machines and fuzzy logic. We applied these elements to our game. We also implemented the remaining gameplay elements into our game. In this chapter, we are going to add music and sound to our game. Audio in itself is an important aspect to any game as it is part of the player's experience. Try to play your favorite game without music and you'll find yourself having a different experience when playing the game.</em>
</p><p>We will cover the following topics in this chapter:</p><div><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">Loading sound and music files</li><li class="listitem" style="list-style-type: disc">Generating our own sound effects</li><li class="listitem" style="list-style-type: disc">Playing audio</li></ul></div><p>Let's add music and sound to our game, shall we?</p><div><div><div><div><h1 class="title"><a id="ch09lvl1sec111"/>Finding music and sound</h1></div></div></div><p>When developing a game, the developer is usually not a jack of all trades and may have a hard time when looking for sound and music. Apple's own GarageBand provides an easy way to create music using predefined loops or even one's own instruments. Another possibility is to find talented people who can help to create audio files. One of the places to look out for are the TIGSource forums—a place for independent<a id="id419" class="indexterm"/> game developers—which has a portfolio section at <a class="ulink" href="http://forums.tigsource.com/index.php?board=43.0">http://forums.tigsource.com/index.php?board=43.0</a> and a section that offers paid work at <a class="ulink" href="http://forums.tigsource.com/index.php?board=40.0">http://forums.tigsource.com/index.php?board=40.0</a>.</p><div><div><div><div><h2 class="title"><a id="ch09lvl2sec121"/>Generating sound effects</h2></div></div></div><p>
<strong>Bxfr</strong> is <a id="id420" class="indexterm"/>a procedural sound generator which is often used in game<a id="id421" class="indexterm"/> jams. It is available online at <a class="ulink" href="http://www.bfxr.net/">http://www.bfxr.net/</a>; the standalone <a id="id422" class="indexterm"/>versions for Windows and Mac OS X can be downloaded from this link as well. Its purpose is to generate 8-bit sound effects in just a few clicks:</p><div><img src="img/1509OS_09_01.jpg" alt="Generating sound effects"/></div><p>First of all, we need to select a type, which we can then modify with several sliders such as the frequency or the length of the sound.</p><p>Once we are done, we can export the sound effect using the <strong>Export Wav</strong> button.</p></div><div><div><div><div><h2 class="title"><a id="ch09lvl2sec122"/>Learning about audio formats</h2></div></div></div><p>Sparrow<a id="id423" class="indexterm"/> allows all audio files supported by iOS to be loaded. Some audio codecs support hardware-assisted decoding, while others don't.</p><p>The iOS devices contain specialized hardware that can handle the encoding and decoding of certain audio formats (for example, AIFC), thereby freeing up the CPU that would otherwise be required to handle these expensive operations. The drawback of the hardware-assisted approach is that only one file can be handled at a time. For example, you can't play background music and sound effects with it simultaneously.</p><p>For more information about how iOS handles audio playback, take a look at Apple's documentation<a id="id424" class="indexterm"/> at <a class="ulink" href="https://developer.apple.com/library/ios/documentation/audiovideo/conceptual/multimediapg/UsingAudio/UsingAudio.html">https://developer.apple.com/library/ios/documentation/audiovideo/conceptual/multimediapg/UsingAudio/UsingAudio.html</a>.</p><p>The best formats for audio formats in Sparrow are AIFC and CAFF.</p><p>Let's see what they are:</p><div><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">AIFC is<a id="id425" class="indexterm"/> a compressed <strong>Audio Interchange Format</strong> (<strong>AIFF</strong>) file. This is usually the best option for background music. There is one other<a id="id426" class="indexterm"/> thing to consider: if the audio playback is hardware-assisted (as it is in the case of AIFC), only one file can be played at a time.</li><li class="listitem" style="list-style-type: disc">The<a id="id427" class="indexterm"/> <strong>Core Audio File Format</strong> (<strong>CAFF</strong>) is<a id="id428" class="indexterm"/> an uncompressed audio format. This format is best used for short sound effects.</li></ul></div><p>Both these formats have the lowest footprint on the CPU. If application size is an issue, there is an unconventional way to solve this: some devices still only have mono speakers, so converting audio files to mono could be a valid option if there are a lot of sound files.</p><p>To convert <a id="id429" class="indexterm"/>audio files, the iOS SDK provides a command-line tool called <strong>afconvert</strong>. Assuming our audio file is called <code class="literal">myAudioFile.wav</code>, we can use the following examples:</p><div><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><strong>Convert to CAFF</strong>: The command to convert to CAFF is <code class="literal">afconvert –f caff –d LE16 myAudioFile.wav</code></li><li class="listitem" style="list-style-type: disc"><strong>Convert to AIFC</strong>: The command to convert to AIFC is <code class="literal">afconvert –f AIFC –d ima4 myAudioFile.wav</code></li></ul></div></div><div><div><div><div><h2 class="title"><a id="ch09lvl2sec123"/>Music and sound effects for our game</h2></div></div></div><p>The necessary audio files are once again uploaded to our GitHub repository. In order to use them, download them from <a class="ulink" href="https://github.com/freezedev/pirategame-assets/releases/download/0.9/Audio_09.zip">https://github.com/freezedev/pirategame-assets/releases/download/0.9/Audio_09.zip</a>, extract the file, and copy the contents in our template. When <a id="id430" class="indexterm"/>copying the files to the project, we need to make sure that we add them to the target.</p></div></div></div>
<div><div><div><div><h1 class="title"><a id="ch09lvl1sec112"/>Adding audio playback</h1></div></div></div><p>Now<a id="id431" class="indexterm"/> that we know about audio formats, we can generate sounds for ourselves if needed, and if we have the necessary files, we can play some audio.</p><div><div><div><div><h2 class="title"><a id="ch09lvl2sec124"/>Starting the audio engine</h2></div></div></div><p>Before we can play any sounds, we need to start the audio engine.</p></div></div>
<div><div><div><div><h1 class="title"><a id="ch09lvl1sec113"/>Time for action – getting audio files to play</h1></div></div></div><p>Perform<a id="id432" class="indexterm"/> the following steps to start the audio <a id="id433" class="indexterm"/>engine:</p><div><ol class="orderedlist arabic"><li class="listitem">Open our Xcode project if it's not already open.</li><li class="listitem">Switch to the <code class="literal">Game.m</code> file.</li><li class="listitem">Inside the initializer, start the audio engine as shown; it should be one of the first few statements:<div><pre class="programlisting">[SPAudioEngine start];</pre></div></li><li class="listitem">Add a <code class="literal">dealloc</code> method that stops the audio engine:<div><pre class="programlisting">-(void) dealloc
{
    [SPAudioEngine stop];
}</pre></div></li><li class="listitem">Run the example.</li></ol></div><p>When we run this example in the simulator, we might see the following lines in the console:</p><div><img src="img/1509OS_09_02.jpg" alt="Time for action – getting audio files to play"/></div><div><div><div><div><h2 class="title"><a id="ch09lvl2sec125"/>
<em>What just happened?</em>
</h2></div></div></div><p>To play any audio file, we need to start the audio engine at the start of our application, which in our case, is the initializer from the <code class="literal">Game</code> class.</p><p>There are different operational modes for the audio engine, which influence how the iPod music<a id="id434" class="indexterm"/> app will behave when we run our game.</p><p>If the audio<a id="id435" class="indexterm"/> is muted, the game audio will be muted as well. This is the default operational mode; other modes include the game audio continue even when the device is muted or the iPod music mixes with the game audio. Take a look at what the latter will look like in code:</p><div><pre class="programlisting">
<code class="literal">[</code>SPAudioEngine<code class="literal"> start: SPAudioSessionCategory_AmbientSound];</code>
</pre></div><p>For <a id="id436" class="indexterm"/>more through information, take a look at the Sparrow SPAudioEngine documentation at <a class="ulink" href="http://doc.sparrow-framework.org/v2/Classes/SPAudioEngine.html">http://doc.sparrow-framework.org/v2/Classes/SPAudioEngine.html</a>.</p><p>When we run this example, we get some information about the audio engine in the console.</p></div><div><div><div><div><h2 class="title"><a id="ch09lvl2sec126"/>Have a go hero</h2></div></div></div><p>Currently, the audio engine starts and stops when the game starts or stops, respectively. It's also a good idea to start and stop the engine if the background and foreground events (such as <code class="literal">applicationWillResignActive</code> and <code class="literal">applicationDidBecomeActive</code>) are triggered.</p></div><div><div><div><div><h2 class="title"><a id="ch09lvl2sec127"/>Playing music in our scenes</h2></div></div></div><p>Now that the audio engine is up and running, let's play the background music.</p></div></div>
<div><div><div><div><h1 class="title"><a id="ch09lvl1sec114"/>Time for action – playing music in our scenes</h1></div></div></div><p>Perform<a id="id437" class="indexterm"/> the following steps to play<a id="id438" class="indexterm"/> background music in our scenes:</p><div><ol class="orderedlist arabic"><li class="listitem">Open the <code class="literal">Scene.h</code> file.</li><li class="listitem">Add an instance variable named <code class="literal">backgroundMusic</code>, which is a pointer to <code class="literal">SPSoundChannel</code> using the following line of code:<div><pre class="programlisting">SPSoundChannel *backgroundMusic;</pre></div></li><li class="listitem">Declare a method called <code class="literal">stop</code> as follows:<div><pre class="programlisting">-(void) stop;</pre></div></li><li class="listitem">Inside the <code class="literal">Scene.m</code> file, define the <code class="literal">stop</code> method with an empty body.</li><li class="listitem">Update the <code class="literal">showScene</code> method in the <code class="literal">SceneDirector.m</code> file to fit the following block of code:<div><pre class="programlisting">-(void) showScene:(NSString *)name
{
    for (NSString* sceneName in _dict) {
        ((Scene *) _dict[sceneName]).visible = NO;
        [((Scene *) _dict[sceneName]) stop];
    }
    if (_dict[name] != nil) {
        ((Scene *) _dict[name]).visible = YES;
        [((Scene *) _dict[name]) reset];
        
    }
} </pre></div></li><li class="listitem">Switch to <code class="literal">PirateCove.m</code>.</li><li class="listitem">Inside the initializer, add the following lines at the top:<div><pre class="programlisting">SPSound *sound = [Assets sound:@"music_cove.aifc"];
backgroundMusic = [sound createChannel];
backgroundMusic.loop = YES;</pre></div></li><li class="listitem">Update the <code class="literal">reset</code> method to look like the following:<div><pre class="programlisting">-(void) reset
{
    [backgroundMusic play];
    
    _goldDamage = (150 + (50 * (World.level - 1)));
    _dialogUpdateDamage.content.text = [NSString stringWithFormat:@"Increasing damage costs %d gold. Do you wish to proceed?", _goldDamage];
    
    _goldHitpoints = (200 + (75 * (World.level - 1)));
    _dialogUpdateHitpoints.content.text = [NSString stringWithFormat:@"Increasing hitpoints costs %d gold. Do you wish to proceed?", _goldHitpoints];
    
    [self updateGoldTextField];
}</pre></div></li><li class="listitem">Implement the scene's <code class="literal">stop</code> method as follows:<div><pre class="programlisting">-(void) stop
{
    [backgroundMusic stop];
}</pre></div></li><li class="listitem">Run<a id="id439" class="indexterm"/> the example and you will see the following output. We can now hear the music in the background.<div><img src="img/1509OS_09_03.jpg" alt="Time for action – playing music in our scenes"/></div></li></ol></div><div><div><div><div><h2 class="title"><a id="ch09lvl2sec128"/>
<em>What just happened?</em>
</h2></div></div></div><p>First<a id="id440" class="indexterm"/> of all, we added an instance variable (<code class="literal">backgroundMusic</code>) to hold the background music. The <code class="literal">SPSound</code> variable holds the data of a sound file while <code class="literal">SPSoundChannel</code> plays the sound itself, similar to the relationship between <code class="literal">SPTexture</code> and <code class="literal">SPImage</code>. It is recommended that you keep a reference to <code class="literal">SPSoundChannel</code>. This is required if we want to stop the playback sound for any reason whatsoever.</p><p>To allow us to have background music in multiple scenes, we need to stop the background music from the current scene and start the music from the next scene because we don't want to run into any nasty side effects. These side effects are that the first music file will use the hardware codec and the second one will use software decoding, thereby heavily impacting the performance of our game. Both music files will play, though.</p><p>If we want to stop the background music when we are in the scene, we can utilize the scene's <code class="literal">reset</code> method. Now, we wanted to do the same only when the scene is deactivated. We first declared the <code class="literal">stop</code> method for exactly this purpose in step 3 and implemented<a id="id441" class="indexterm"/> it as an empty method in<a id="id442" class="indexterm"/> the step afterwards. In the <code class="literal">SceneManager</code> class, we need to call the <code class="literal">stop</code> method of each scene when we are hiding the scene.</p><p>Inside the initializer of the <code class="literal">PirateCove</code> scene, we created a local <code class="literal">SPSound</code> variable that loads the music file through our asset management system. We then used the <code class="literal">createChannel</code> method and saved the result in the instance variable. We want to loop the music endlessly, so we set the <code class="literal">loop</code> property to <code class="literal">YES</code>.</p><p>In step 8, we updated the <code class="literal">reset</code> method to play the background music and in step 9, we overwrote the <code class="literal">stop</code> method and stopped the background music.</p><p>When we run this example now, we can hear the music playing in a loop.</p></div><div><div><div><div><h2 class="title"><a id="ch09lvl2sec129"/>Have a go hero</h2></div></div></div><p>Now that the pirate cove scene has some background music, go ahead and give the battlefield some music.</p></div><div><div><div><div><h2 class="title"><a id="ch09lvl2sec130"/>Adding a sound effect</h2></div></div></div><p>Our <a id="id443" class="indexterm"/>audio engine is up and running; we already know that it works because we have played some music, and now it's time to add the sound effects.</p></div></div>
<div><div><div><div><h1 class="title"><a id="ch09lvl1sec115"/>Time for action – sound effects in the pirate cove</h1></div></div></div><p>To <a id="id444" class="indexterm"/>add sound effects to the <a id="id445" class="indexterm"/>pirate cove scene, perform the following steps:</p><div><ol class="orderedlist arabic"><li class="listitem">Open the <code class="literal">PirateCove.m</code> file.</li><li class="listitem">Update both the <code class="literal">onUpdateDamage</code> and <code class="literal">onUpdateHitpoints</code> methods to play a sound effect, as shown in the following code:<div><pre class="programlisting">-(void) onUpdateDamage: (SPEvent *) event
{
    World.damage = World.damage + (int) (World.damage / 10);
    World.gold = World.gold - _goldDamage;
    [self updateGoldTextField];
    
    [[Assets sound:@"powerup.caf"] play];
}

-(void) onUpdateHitpoints: (SPEvent *) event
{
    World.hitpoints = World.hitpoints + (int) (World.hitpoints / 5);
    World.gold = World.gold - _goldHitpoints;
    [self updateGoldTextField];
    
    [[Assets sound:@"powerup.caf"] play];
}</pre></div></li><li class="listitem">Run the example and you will see the following output. We can now hear a sound if we successfully upgrade our pirate ship.<div><img src="img/1509OS_09_04.jpg" alt="Time for action – sound effects in the pirate cove"/></div></li></ol></div><div><div><div><div><h2 class="title"><a id="ch09lvl2sec131"/>
<em>What just happened?</em>
</h2></div></div></div><p>Inside the pirate cove scene, we added a sound effect to both the <code class="literal">onUpdateDamage</code> and the <code class="literal">onUpdateHitpoints</code> methods. We got the powerup file through the asset management system and then played the sound directly. This method is useful for short sounds and at places where we don't need to keep a reference to manipulate the playback of the audio channel afterwards.</p><p>Now, when<a id="id446" class="indexterm"/> we run this<a id="id447" class="indexterm"/> example, we can hear a sound effect once we successfully upgrade our ship.</p></div><div><div><div><div><h2 class="title"><a id="ch09lvl2sec132"/>Have a go hero</h2></div></div></div><p>Go ahead and add the following sound effects in the battlefield:</p><div><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">When a ship is hit (the <code class="literal">hit</code> method in the <code class="literal">Ship</code> class)</li><li class="listitem" style="list-style-type: disc">When a ship shoots (the <code class="literal">shoot</code> method in the <code class="literal">Ship</code> class)</li><li class="listitem" style="list-style-type: disc">When a ship gets destroyed (hit points getter in the <code class="literal">Ship</code> class)</li></ul></div></div><div><div><div><div><h2 class="title"><a id="ch09lvl2sec133"/>Pop quiz</h2></div></div></div><p>Q1. AAC audio files offer hardware-assisted encoding.</p><div><ol class="orderedlist arabic"><li class="listitem">True</li><li class="listitem">False</li></ol></div><p>Q2. If <code class="literal">SPSound</code> only contains the sound data, which class should be used to play an audio file?</p><div><ol class="orderedlist arabic"><li class="listitem"><code class="literal">AVAudioSession</code></li><li class="listitem"><code class="literal">SPSoundChannel</code></li><li class="listitem"><code class="literal">SPAudio</code></li></ol></div><p>Q3. To play any sounds at all, we need to initialize the audio engine.</p><div><ol class="orderedlist arabic"><li class="listitem">True</li><li class="listitem">False</li></ol></div></div></div>
<div><div><div><div><h1 class="title"><a id="ch09lvl1sec116"/>Summary</h1></div></div></div><p>In this chapter, we learned how to load and play audio files. Specifically, we covered data formats and the basic usage of audio in Sparrow.</p><p>Now that our game has some audio, let's polish our game—which is the topic of the next chapter.</p></div></body></html>