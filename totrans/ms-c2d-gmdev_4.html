<html><head></head><body><div><div><div><div><h1 class="title"><a id="ch04"/>Chapter 4. Sound and Music</h1></div></div></div><p>This chapter is all about the different ways to present music and sound effects to the player of the game using Cocos2d, and why high-quality music and sound effects matter in a great game. Trust me, there's more to sound effects than just playing a sound file when an event happens. Otherwise, why would it have an entire chapter? Although there are a lot of users who play with the sound off on mobile devices, it's still an immersive part of some players' experience, so we have to pay close attention to not only the sounds we choose but also how they're implemented.</p><p>In this chapter, we will cover the following topics:</p><div><ul class="itemizedlist"><li class="listitem">Loading and unloading effects</li><li class="listitem">Playing sound effects and loop background music in creative ways</li><li class="listitem">Modifying the played sound on the fly</li><li class="listitem">Other good examples of sounds</li></ul></div><div><h3 class="title"><a id="tip25"/>Tip</h3><p>For the code up to this point, open the <strong>Chapter 4</strong> project and the sound effects from the <code class="literal">Sounds</code> directory in the book's included files.</p><p>It's recommended that you follow the code provided, as this chapter, along with future chapters, will be referencing methods and classes that are provided or mentioned within the book.</p><p>If there are any gameplay bugs or imbalances in the prototype, that's fine; we'll cover polishing in a later chapter. Remember, the prototype was done quickly with the sole purpose of showing others the core concept of the game, not providing them with a finished product.</p></div><div><div><div><div><h1 class="title"><a id="ch04lvl1sec29"/>Prerequisites</h1></div></div></div><p>Make <a id="id245" class="indexterm"/>sure you've copied the sound files to your project. If they aren't there, no matter how many times you try to preload, unload, play, or loop, the sound files simply won't play. Unlike the sprite sheets used with TexturePacker and the BMFonts created with Glyph Designer, it's best to drag the sound files into your project and have<a id="id246" class="indexterm"/> the <strong>Copy items if needed</strong> checkbox checked, as shown in the following screenshot. This will ensure that the files are in your project until you decide to delete them.</p><div><img src="img/image00245.jpeg" alt="Prerequisites"/></div><p style="clear:both; height: 1em;"> </p></div></div>
<div><div><div><div><h1 class="title"><a id="ch04lvl1sec30"/>Seeing the difference in audio types</h1></div></div></div><p>If you're <a id="id247" class="indexterm"/>wondering what the differences are between MP3, CAF, and <a id="id248" class="indexterm"/>other file and data formats for audio, check out <a class="ulink" href="http://www.raywenderlich.com/69365/audio-tutorial-ios-file-data-formats-2014-edition">http://www.raywenderlich.com/69365/audio-tutorial-ios-file-data-formats-2014-edition</a>, a detailed explanation on all the different types of audio. It's not necessary for this book, but if you're trying to save space or wondering if you can use certain audio files, this link will be helpful.</p><p>We're going to be using MP3 in this chapter (and subsequently in the rest of the book's content) as it's a very common format, as well as a format that's supported by OALSimpleAudio and the iPhone natively.</p></div>
<div><div><div><div><h1 class="title"><a id="ch04lvl1sec31"/>Learning about OALSimpleAudio</h1></div></div></div><p>If you've ever <a id="id249" class="indexterm"/>wanted an easy way to play sound files, OALSimpleAudio is the thing you need. It can very easily load a large variety of sound files, play effects, loop background music, and a lot more. Its existence and integration with Cocos2d makes it much easier to bring your game to life with the immersive capabilities <a id="id250" class="indexterm"/>of sound and music.</p><div><h3 class="title"><a id="tip26"/>Tip</h3><p>If you've programmed in Cocos2d before and are wondering where SimpleAudioEngine is, starting in Cocos2d v3.0, OALSimpleAudio is the new way to play sound effects. It's basically everything that SimpleAudioEngine was.</p></div><div><div><div><div><h2 class="title"><a id="ch04lvl2sec65"/>Preloading effects</h2></div></div></div><p>If you <a id="id251" class="indexterm"/>try to play an effect using OALSimpleAudio, there will be a slight freeze, or delay, as the device tries to quickly load the effect into the memory and then play it right away. Luckily, there's a way to load the sound effects and music such that it doesn't freeze in front of your users when you try to play an effect.</p><p>OALSimpleAudio allows preloading of effects, which essentially reads the sound effect into the memory long before you'll need the effect. The choice is up to you whether to do this at the beginning of the game (when users first launch it from their home screen), or between levels by unloading and reloading the effects for the upcoming level. The way to load sound files into the memory with OALSimpleAudio is by adding the following line of code:</p><div><pre class="programlisting">ALBuffer *buffer = [[OALSimpleAudio sharedInstance] preloadEffect:@"soundEffect.mp3"];</pre></div><p>The <code class="literal">buffer</code> variable assignment is optional and is used if you need to print out various pieces of information about the sound file such as frequency or bits of the buffer.</p><div><h3 class="title"><a id="tip27"/>Tip</h3><p>Although the preceding code example shows <code class="literal">.mp3</code> as the file extension, OALSimpleAudio can load any sound file that's supported by iOS.</p></div><p>However, if you want to cut down on the time it takes to load all your in-game sounds, you can do so in the background, which is known as loading asynchronously.</p></div><div><div><div><div><h2 class="title"><a id="ch04lvl2sec66"/>Loading files asynchronously</h2></div></div></div><p>Loading <a id="id252" class="indexterm"/>your files asynchronously is the best way to cut down on load time while simultaneously getting all the files loaded. However, note that because loading this way occurs in the background, there's no guarantee that the files will be ready when the user begins to interact with your game.</p><p>If you <a id="id253" class="indexterm"/>wish to make certain sound effects available for them at the beginning of the game (at the loading screen, before the main menu starts, right when the main menu starts, or whatever you see the beginning of your game as), it's recommended to load the minimum amount of sound needed if you still wish to load the majority of your effects asynchronously.</p><p>The way to do this is with the following line of code. It will push the loading into the background and notify you when it's done:</p><div><pre class="programlisting">__block ALBuffer *soundBuffer;
[[OALSimpleAudio sharedInstance] preloadEffect:@"soundEffect.mp3" reduceToMono:NO completionBlock:^(ALBuffer* buffer)
{
  soundBuffer = buffer;
}];</pre></div></div><div><div><div><div><h2 class="title"><a id="ch04lvl2sec67"/>Unloading effects</h2></div></div></div><p>If you <a id="id254" class="indexterm"/>know you're not going to use the sound effect for a while, or you often run into memory warnings, unloading your sound effects can be useful. For example, if your game uses a certain sound file for a voice-over in the tutorial only, once the user passes the tutorial, you can unload this sound effect to free up some memory. OALSimpleAudio will not unload sound effects that are either playing or paused.</p><p>To unload a specific sound effect, you can use this line of code:</p><div><pre class="programlisting">[[OALSimpleAudio sharedInstance] unloadEffect:@"soundEffect.mp3"];</pre></div><p>To unload all your sound effects at once, you can use the following line of code:</p><div><pre class="programlisting">[[OALSimpleAudio sharedInstance] unloadAllEffects];</pre></div><div><h3 class="title"><a id="tip28"/>Tip</h3><p>A recommended place to put these unloading calls is your <code class="literal">applicationDidReceiveMemoryWarning</code> method in the <code class="literal">AppDelegate</code> class.</p></div></div></div>
<div><div><div><div><h1 class="title"><a id="ch04lvl1sec32"/>Playing sound effects and loop background music</h1></div></div></div><p>Obviously, you<a id="id255" class="indexterm"/> wouldn't just <a id="id256" class="indexterm"/>want to be loading and unloading your sound effects all day, so let's get into the actual playing of these sounds here.</p><div><div><div><div><h2 class="title"><a id="ch04lvl2sec68"/>Getting some background music going</h2></div></div></div><p>It's <a id="id257" class="indexterm"/>always important to set the tone of the voice through the music that gets played in the background. Whether that means a bleak, withering tone or a happy-go-lucky, upbeat tone, the music can help bring in the player so that they become more engaged with the game.</p><p>Because the background music will likely be playing for the majority of the time throughout the game, it's not entirely important to preload it. However, it's still recommended, as it will prevent the slight bit of lag at the beginning of the game when the music first starts playing. You can preload the background music using the following code:</p><div><pre class="programlisting">[[OALSimpleAudio sharedInstance] preloadBg:@"backgroundMusic.mp3"];</pre></div><p>With the preceding line of code added, you can simply play the background music on loop with one call. To play preloaded background music, add this line of code:</p><div><pre class="programlisting">[[OALSimpleAudio sharedInstance] playBgWithLoop:YES];</pre></div><p>So, for this book's project, we're going to play background music throughout the time the game is being played. Thus, we want the user to be immersed as early as possible, so we're going to preload the background music even before the first scene loads, and start playing it as soon as possible. Open <code class="literal">AppDelegate.m</code>, and go to the <code class="literal">startScene</code> method. Right above the return statement, add this line of code:</p><div><pre class="programlisting">[[OALSimpleAudio sharedInstance] preloadBg:@"backgroundMusic.mp3"];</pre></div><p>Now that we have made OALSimpleAudio aware of what our background music is, we can immediately play the file on loop, so by the time the first scene gets displayed, there's already music playing. So, right below the preloading line, add this:</p><div><pre class="programlisting">[[OALSimpleAudio sharedInstance] playBgWithLoop:YES];</pre></div><p>Isn't that lovely? But background music alone isn't going to be enough. Let's add in some sound effects when the user does different activities in the game.</p></div><div><div><div><div><h2 class="title"><a id="ch04lvl2sec69"/>Sounds when a button is clicked on</h2></div></div></div><p>One <a id="id258" class="indexterm"/>of the human psychological traits that exists is the desire for feedback when an action is taken. Thus, when a button is pressed in digital space, we need to give the user feedback that their action has been received. This is why the button darkens slightly to indicate that it's being pressed down. Upon release of this button, we'd like to also play a sound effect telling the user their action is being processed.</p><p>To play a sound effect when a button is pressed in Cocos2d, just add the line of code required to play the sound file to whichever method the button calls. So, for this project, open <code class="literal">MainScene.m</code>, go to the <code class="literal">goToMenu</code> method, and add this line of code right before the line where the <code class="literal">replaceScene</code> method gets called:</p><div><pre class="programlisting">[[OALSimpleAudio sharedInstance] playEffect:@"buttonClick.mp3"];</pre></div><p>This will play the sound effect once, right before everything starts to load for the next scene. Do the same for the <strong>Restart</strong> button, by going to the <code class="literal">restartGame</code> method and the <code class="literal">goToGame</code> method in <code class="literal">MenuScene.m</code>:</p><div><pre class="programlisting">-(void)restartGame
{
  [[OALSimpleAudio sharedInstance] playEffect:@"buttonClick.mp3"];
  [[CCDirector sharedDirector] replaceScene:[MainScene scene]];
}

-(void)goToGame
{
  [[OALSimpleAudio sharedInstance] playEffect:@"buttonClick.mp3"];
  [[CCDirector sharedDirector] replaceScene:[MainScene scene]];
}</pre></div><div><h3 class="title"><a id="tip29"/>Tip</h3><p>If you notice a slight delay before the sound effect the first time you click on a button, that's a sign that you should preload the sound effect before the user can press the given button.</p></div><p>Now, if all we have is background music and button clicks, we surely need to engross the user even more. Thus, we'll add some sound when the user moves a unit distance on the game board.</p></div><div><div><div><div><h2 class="title"><a id="ch04lvl2sec70"/>Sounds on unit movements</h2></div></div></div><p>Similar to<a id="id259" class="indexterm"/> the button click effects, we want to play the effect whenever the <code class="literal">moveUnit</code> method gets called. Why here and not in the <code class="literal">Unit</code> class? Because, if we called it in the Unit class, we'd possibly be calling the method 81 times at once (9 x 9 grid). Yes, this is hard to obtain, but technically possible. Calling it up to 81 times at once will cause the effects to stack on top of each other and become a lot louder than we want.</p><p>So, open <code class="literal">MainScene.m</code> and go to the <code class="literal">moveUnit</code> method. Here, right after we update the position of the unit the user wants to move, we'll play the sound effect:</p><div><pre class="programlisting">-(void)moveUnit:(NSNotification*)notif
{
  NSDictionary *userInfo = [notif userInfo];
  Unit *u = (Unit*)userInfo[@"unit"];
  u.position = [self getPositionForGridCoord:u.gridPos];
  
// Add this line:
  [[OALSimpleAudio sharedInstance] playEffect:@"moveUnit.mp3"];
  
  ++numTurnSurvived;

   // ..etc..
}</pre></div><p>When you run the game and move a unit, you should hear a very subtle sound. The reason it's so subtle is that the user will be doing this for the entire game. We don't want to overwhelm them with the movement sound effect, as it might irritate some players, causing them to turn the sound off or simply quit playing, the latter of which we don't want to happen.</p></div><div><div><div><div><h2 class="title"><a id="ch04lvl2sec71"/>Sounds on unit combination</h2></div></div></div><p>Although <a id="id260" class="indexterm"/>the movement happens literally every turn (or else a turn won't happen), two units combining may not be the case every turn. Therefore, we want to give the player a rewarding feeling when they combine two weak units to make one strong unit.</p><p>Because our unit combination code is a bit scattered, we have to be careful where to place the code so that the unit combination sound effect happens only once per combination. For example, if all three units move into one square at the same time, we should only play the effect only once instead of twice by accident. This makes it a bit tricky, but for now, let's not worry about the three- or four-unit combinations, and just handle the two-unit combinations. It's going to play twice and three times respectively for the three- and four-unit combinations, but <a id="id261" class="indexterm"/>that's okay for an early version of the game.</p><p>First, open your <code class="literal">MainScene.m</code> file and add this method anywhere in your code:</p><div><pre class="programlisting">-(void)playUnitCombineSoundWithValue:(NSInteger)total
{
}</pre></div><p>Then go to the <code class="literal">checkForAnyDirectionCombineWithUnit</code> method and add the following lines of code right under the <code class="literal">NSInteger fv</code> and <code class="literal">NSInteger ov</code> lines (<code class="literal">fv</code> and <code class="literal">ov</code> stand for first value and other value respectively, and they will hold the values of the first unit and the other unit that get passed to this method):</p><div><pre class="programlisting">if (first.isFriendly)
[self playUnitCombineSoundWithValue:fv+ov];</pre></div><p>Also, go to the <code class="literal">checkForCombineWithUnit</code> method and add these lines of code at the same spot (below the two <code class="literal">NSInteger</code> declarations).</p><p>The reason we have the <code class="literal">if</code> statement is that we need to make sure the sound effect only plays when a friendly unit is combined with another friendly unit. We don't need to check <code class="literal">other</code> because we only call this method with two units of the same type. As for the <code class="literal">fv+ov</code> and <code class="literal">total</code> parameters, those will be used later in this chapter, so just hold on for now.</p><p>Lastly, in the <code class="literal">playUnitCombineSound</code> method, you'll need to add the following line of code so that the effect actually plays:</p><div><pre class="programlisting">[[OALSimpleAudio sharedInstance] playEffect:@"unitCombine.mp3"];</pre></div><p>If you run the game now, you will hear a sound when one friendly unit combines with another. There's just one more type of sound effect we want to add in this early version of the game.</p></div><div><div><div><div><h2 class="title"><a id="ch04lvl2sec72"/>Sounds when the user loses</h2></div></div></div><p>Last but <a id="id262" class="indexterm"/>not least, we want to include some sounds that play when a user loses their game. It's not entirely motivating to hear the losing sound effect over and over, but it is effective in keep user retention high, as it emphasizes the "let me try that one more time, I almost had it" feeling. Picking the right sound for this can be a bit hard, but once you've found a sound effect that you feel is sufficient, you can go ahead and add it to the <strong>Game Over</strong> screen.</p><p>So first, we need a <strong>Game Over</strong> screen to exist. Similar to the <code class="literal">Unit</code> class, create a <code class="literal">GameOverScene</code> class with a subclass of type <code class="literal">CCScene</code>. Your <code class="literal">GameOverScene.h</code> file should look <a id="id263" class="indexterm"/>something like this:</p><div><pre class="programlisting">#import "CCScene.h"

@interface GameOverScene : CCScene
{
  CGSize winSize;
}

@property (nonatomic, assign) NSInteger numUnitsKilled;
@property (nonatomic, assign) NSInteger numTotalScore;
@property (nonatomic, assign) NSInteger numTurnsSurvived;

+(CCScene*)scene;
@end</pre></div><p>Then open your <code class="literal">GameOverScene.m</code> file. It looks something like this:</p><div><pre class="programlisting">#import "GameOverScene.h"

@implementation GameOverScene

+(CCScene*)scene
{
  return [[self alloc] init];
}

-(id)init
{
  if ((self=[super init]))
  {
    winSize = [[CCDirector sharedDirector] viewSize];
    
    //these values range 0 to 1.0, so use float to get ratio
    CCNode *background = [CCNodeColor nodeWithColor:[CCColor colorWithRed:128/255.f green:0/255.f blue:88/255.f]];
    [self addChild:background];
    
    
  }
  return self;
}

-(void)goToMenu
{
  //to be filled in later
}

-(void)restartGame
{
  //to be filled in later
}
@end</pre></div><p>In the <code class="literal">init</code> method of the <code class="literal">GameOverScene</code>, we want the Game Over sound effect to play. We're <a id="id264" class="indexterm"/>adding it here so that the sound effect plays as soon as the Game Over scene loads. So, right under the line of code for the background color, add the following to play the Game Over sound effect:</p><div><pre class="programlisting">[[OALSimpleAudio sharedInstance] playEffect:@"gameOver.mp3"];</pre></div><p>To hear the sound play, we need to send the user to the GameOverScene when they lose, so go to the <code class="literal">endGame</code> method in the <code class="literal">MainScene.m</code> file, and change that line of code to this (don't forget to add the <code class="literal">#include "GameOverScene.h"</code> line of code at the top of the file):</p><div><pre class="programlisting">[[CCDirector sharedDirector] replaceScene:[GameOverScene scene]];</pre></div><p>And there you have it—a Game Over sound effect! So, up to this point, we have all the sound effects in place: the unit movements, the combinations, Game Over, the background music, and so on. But after a while, the sound gets a little repetitive, so let's modify the sounds a bit to lessen the annoyance of a repeated sound.</p></div></div>
<div><div><div><div><h1 class="title"><a id="ch04lvl1sec33"/>Modifying the sound effect on the fly</h1></div></div></div><p>One <a id="id265" class="indexterm"/>thing that's so cool about using OALSimpleAudio (and was also true about SimpleAudioEngine) is that you can modify how the audio file sounds when it gets played back to the user. For example, if you wish to have a series of coins collected, and each coin collected in rapid succession plays a slightly higher-pitched sound than the previous one, you can simply modify the pitch based on how many coins were collected.</p><div><div><div><div><h2 class="title"><a id="ch04lvl2sec73"/>The volume (or gain), pitch, and pan</h2></div></div></div><p>With <a id="id266" class="indexterm"/>one <a id="id267" class="indexterm"/>simple call that adds a few<a id="id268" class="indexterm"/> parameters to the default <code class="literal">playEffect</code> method, you can modify the loudness of the effect, the pitch of the sound effect, and where in the speakers your effect plays. You can do so with the following code:</p><div><pre class="programlisting">//volume range: 0.0 to 1.0
//pitch range: 0.0 to inf (1.0 is normal)
//pan range:  -1.0 to 1.0 (far left to far right)
//loop:  If YES, will play until stop is called on the sound
[[OALSimpleAudio sharedInstance] playEffect:@"soundEffect.mp3" volume:1 pitch:1 pan:1 loop:NO];</pre></div></div><div><div><div><div><h2 class="title"><a id="ch04lvl2sec74"/>Stopping looped sound effects</h2></div></div></div><p>If you've <a id="id269" class="indexterm"/>said "Yes" to the preceding loop and wish to stop it at some point, you have to grab the return value of the preceding function, like this:</p><div><pre class="programlisting">id&lt;ALSoundSource&gt; effect;

effect = [[OALSimpleAudio sharedInstance] playEffect:@"soundEffect.mp3" volume:1 pitch:1 pan:1 loop:NO];</pre></div><p>Then call the respective stop function on the variable:</p><div><pre class="programlisting">[effect stop];</pre></div></div><div><div><div><div><h2 class="title"><a id="ch04lvl2sec75"/>Modifying the combine sound effect</h2></div></div></div><p>Ideally, we<a id="id270" class="indexterm"/> don't want the user to hear the same sound effect over and over every time they combine units. Not only will it become obnoxious and annoying to the user but it will also make the game feel more boring and less exciting. With that said, we want to modify the combining sound effect so slightly so that as the user gets a higher number of unit combinations, they feel emboldened by their success, making them wish to play longer.</p><p>One of the approaches is to modify the pitch of the sound effect. This will work up to a certain point, until the sound effect becomes so pushed in one direction that it's simply better to provide another sound effect for truly large unit combinations.</p><p>Open the <code class="literal">MainScene.m</code> file and scroll to the <code class="literal">playUnitCombineSoundWithValue</code> method. Here, you're going to modify the code to look something like this:</p><div><pre class="programlisting">CGFloat pitchValue = 1.0 - (total / 100.f);
//eg: fv+ov = 20 ... 1.0 - 0.2 = 0.8
if (total &lt; 50)
{
  [[OALSimpleAudio sharedInstance] playEffect:@"unitCombine.mp3"
    volume:1 pitch:pitchValue pan:0 loop:NO];
}

else
{
  [[OALSimpleAudio sharedInstance]
    playEffect:@"largeUnitCombine.mp3"];
}</pre></div><p>When <a id="id271" class="indexterm"/>you run the game and combine a unit, you will hear the sound effect getting deeper and deeper until a certain value (the tipping point—in this case, a new unit value of 50 or more). At this point, we want to play a different sound effect, which is what the inner <code class="literal">if</code> statement handles.</p></div></div>
<div><div><div><div><h1 class="title"><a id="ch04lvl1sec34"/>Other great sound places</h1></div></div></div><p>The following <a id="id272" class="indexterm"/>are a couple of examples of games that make great use of sound effects. These games not only engage the user more, but are also great examples of how you can use sound effects for more than just basic events such as simple user movements or button clicks:</p><div><ul class="itemizedlist"><li class="listitem"><em>Threes!</em>: This game has faces on the cards, and if you don't do anything, after a few moments, you'll hear the cards making random noises. Also, if you try to slide the cards into a position that doesn't move anything (an invalid move), you will hear one of the cards say "Nope!" It's really cute and is just another way the ambience of the game is upheld through the sounds. Take a look at the UI of the game, as shown in the following screenshot:<div><img src="img/image00246.jpeg" alt="Other great sound places"/></div><p style="clear:both; height: 1em;"> </p></li><li class="listitem"><em>Crossy Road</em>: In this game, every now and then, you'll come across a vehicle that's <a id="id273" class="indexterm"/>playing music, a police car, or a garbage truck. All of these are fairly rare, but when the player experiences them and hears the extra level of sound, it becomes more enjoyable, as it's not just another car driving by. Plus, with all the cars and trains in the game, if you're wearing headphones, you'll hear the vehicle's music go from one ear to the other. Have a look at the UI of this game:<div><img src="img/image00247.jpeg" alt="Other great sound places"/></div><p style="clear:both; height: 1em;"> </p></li></ul></div></div>
<div><div><div><div><h1 class="title"><a id="ch04lvl1sec35"/>Summary</h1></div></div></div><p>This chapter taught you how to preload, unload, play, and modify sound files using <code class="literal">OALSimpleAudio</code> and Cocos2d. You also saw some cool ways in which we integrated the use of sound in this book's project. Because the game is still in that prototype-esque phase, the sounds may change or be modified. However, the vast majority of them are implemented. Also, if you want to learn how to turn on/off sound or music in your game via an option in the menu or settings, read <a class="link" title="Chapter 6. Tidying Up and Polishing" href="part0049.xhtml">Chapter 6</a>, <em>Tidying Up and Polishing</em>, as that chapter will cover more such details.</p><p>There are also a lot of situational methods in <code class="literal">OALSimpleAudio</code> that were not covered in this chapter. If you wish to read more about them, you can view the documentation at <a class="ulink" href="http://www.learn-cocos2d.com/api-ref/1.0/ObjectAL/html/interface_o_a_l_simple_audio.html#aaf877e4f0526408d569fd12f37e8e1f7">http://www.learn-cocos2d.com/api-ref/1.0/ObjectAL/html/interface_o_a_l_simple_audio.html#aaf877e4f0526408d569fd12f37e8e1f7</a>.</p><p>In the next chapter, we'll cover some really cool concepts and mechanics that most game developers don't take time to implement in their game—and it's more than just Game Center or iCloud support.</p></div></body></html>