<html><head></head><body><div class="chapter" title="Chapter&#xA0;10.&#xA0;Polishing Our Game"><div class="titlepage"><div><div><h1 class="title"><a id="ch10"/>Chapter 10. Polishing Our Game</h1></div></div></div><p>
<span class="emphasis"><em>In the previous chapter, we added sound and music to our game. We also learned about audio file formats and even how to generate our own sound effects.</em></span>
</p><p>In this chapter, we are going to polish our game. We will be covering the following topics in this chapter:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">Improving the game over mechanism</li><li class="listitem" style="list-style-type: disc">Adding a minimalistic tutorial</li><li class="listitem" style="list-style-type: disc">Loading and saving the current state of the game</li></ul></div><p>Polishing is<a id="id448" class="indexterm"/> the process of giving the last finishing touches to the game. There is a saying in software development that the last 20 percent of the development feels as hard as the first 80 percent. With such motivation, let's polish our game, shall we?</p><div class="section" title="Adding additional scenes"><div class="titlepage"><div><div><h1 class="title"><a id="ch10lvl1sec117"/>Adding additional scenes</h1></div></div></div><p>Our game still feels rough around the edges. Our first order of business is to add more scenes, which should make the game feel more rounded, especially when starting the game and when the game is over.</p><div class="section" title="The game over scene"><div class="titlepage"><div><div><h2 class="title"><a id="ch10lvl2sec134"/>The game over scene</h2></div></div></div><p>Currently, the <a id="id449" class="indexterm"/>game over mechanism is a bit too minimalistic. While the player can lose and win the game, they can't restart the game once it is over. The player needs to shut down the application and open it again.</p><p>This is counterintuitive as the default behavior of iOS apps is to freeze the app instead of shutting it down. So in the worst case, our game with the <span class="strong"><strong>Game Over</strong></span> message stays in the memory until the device is rebooted or the user kills the application from the app switcher.</p><div class="section" title="Creating the game over scene"><div class="titlepage"><div><div><h3 class="title"><a id="ch10lvl3sec10"/>Creating the game over scene</h3></div></div></div><p>As our first task, we are going to decouple the game over logic and move it into a separate scene. Our game over scene should show whether the game was won or lost.</p></div></div></div></div>
<div class="section" title="Time for action &#x2013; showing the game over scene"><div class="titlepage"><div><div><h1 class="title"><a id="ch10lvl1sec118"/>Time for action – showing the game over scene</h1></div></div></div><p>Use the <a id="id450" class="indexterm"/>following steps to create the game over scene:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Open our Xcode project if it's not already open.</li><li class="listitem">Create a new Objective-C class inside the <code class="literal">GameScenes</code> group.</li><li class="listitem">Call this class <code class="literal">GameOver</code> it should be a subclass of <code class="literal">Scene</code>.</li><li class="listitem">Switch to the <code class="literal">GameOver.h</code> file.</li><li class="listitem">Using the following line of code, add a property called <code class="literal">message</code>:<div class="informalexample"><pre class="programlisting">@property SPTextField *message;</pre></div></li><li class="listitem">Using the following line of code, add another property to indicate whether the game was won:<div class="informalexample"><pre class="programlisting">@property (nonatomic) BOOL gameWon;</pre></div></li><li class="listitem">Switch to <code class="literal">GameOver.m</code>.</li><li class="listitem">Import the <code class="literal">SceneDirector.h</code>, <code class="literal">Assets.h</code>, and the <code class="literal">World.h</code> files, as shown in the following code:<div class="informalexample"><pre class="programlisting">#import "SceneDirector.h"
#import "Assets.h"
#import "World.h"</pre></div></li><li class="listitem">Add an initializer for this new scene, as shown in the following code:<div class="informalexample"><pre class="programlisting">-(id) init
{
    if ((self = [super init])) {
        
        SPImage *background = [SPImage imageWithTexture:[Assets texture:@"water.png"]];
        
        _message = [SPTextField textFieldWithWidth:Sparrow.stage.width height:Sparrow.stage.height text:@"Game Over" 
              fontName:@"PirateFont" fontSize:24.0f color:SP_WHITE];
        
        SPTexture *yesButton = [[Assets textureAtlas:@"ui.xml"] textureByName:@"dialog_yes"];
SPButton *resetButton = [SPButton buttonWithUpState:yesButton text:@"Start over"];
        
        resetButton.x = (Sparrow.stage.width - resetButton.width) / 2;
        resetButton.y = Sparrow.stage.height - resetButton.height - 8.0f;
        
        [resetButton addEventListenerForType:SP_EVENT_TYPE_TRIGGERED block:^(id event) {
            [World reset];
            [(SceneDirector *) self.director showScene:@"piratecove"];
        }];
        
        [self addChild:background];
        [self addChild:_message];
        [self addChild:resetButton];
    }
    
    return self;
}</pre></div></li><li class="listitem">Add a <a id="id451" class="indexterm"/>getter for the <code class="literal">gameWon</code> property, as shown in the following code:<div class="informalexample"><pre class="programlisting">-(BOOL) getGameWon
{
    return _gameWon;
}</pre></div></li><li class="listitem">Now, add the setter for the <code class="literal">gameWon</code> property, as shown in the following code:<div class="informalexample"><pre class="programlisting">-(void) setGameWon:(BOOL)gameWon
{
    _gameWon = gameWon;
    
    if (_gameWon) {
        _message.text = @"You won the game. Congratulations.";
    } else {
        _message.text = @"Your ship sank. Try again.";
    }
}</pre></div></li><li class="listitem">Switch to <code class="literal">Game.m</code>.</li><li class="listitem">Import the <code class="literal">GameOver.h</code> file using the following line of code:<div class="informalexample"><pre class="programlisting">#import "GameOver.h"</pre></div></li><li class="listitem">Then, create an instance of the <code class="literal">GameOver</code> scene using the following code:<div class="informalexample"><pre class="programlisting">GameOver *gameOver = [[GameOver alloc] initWithName:@"gameover"];</pre></div></li><li class="listitem">Add the game over instance to the scene director using the following code:<div class="informalexample"><pre class="programlisting">[director addScene:gameOver];</pre></div></li><li class="listitem">Show the game over scene by default using the following line of code:<div class="informalexample"><pre class="programlisting">[director showScene:@"gameover"];</pre></div></li><li class="listitem">Run the<a id="id452" class="indexterm"/> example and we will see the game over scene, as shown in the following screenshot:<div class="mediaobject"><img src="graphics/1509OS_10_01.jpg" alt="Time for action – showing the game over scene"/></div></li></ol></div><div class="section" title="What just happened?"><div class="titlepage"><div><div><h2 class="title"><a id="ch10lvl2sec135"/>
<span class="emphasis"><em>What just happened?</em></span>
</h2></div></div></div><p>As we have done before, we opened our Xcode project. Then, we created a class, which is going to be our game over scene. It's called <code class="literal">GameOver</code> and is a subclass of <code class="literal">Scene</code>.</p><p>In the <code class="literal">GameOver</code> header file, we added two properties in step 5 and 6, respectively. The first property is the message that will be displayed on the screen. The second is to indicate whether the game was won. We added a custom getter and setter for this property later on. We marked this property as non-atomic, as we don't really need thread safety and we used only one thread anyway.</p><p>In the <code class="literal">GameOver.m</code> file, we imported all the necessary headers, which are as follows:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">The asset manager from <code class="literal">Assets.h</code>, as it is most likely that we load an asset</li><li class="listitem" style="list-style-type: disc">The scene director from <code class="literal">SceneDirector.h</code>, because we need to switch to another scene</li><li class="listitem" style="list-style-type: disc">The <code class="literal">World</code> class from <code class="literal">World.h</code>, as we need to reset our in-game values</li></ul></div><p>Then, we added the initializer. Our game over scene consists of the following:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">Water as the background</li><li class="listitem" style="list-style-type: disc">The text field which is the <code class="literal">message</code> property</li><li class="listitem" style="list-style-type: disc">The reset button</li></ul></div><p>In this example, we used the <code class="literal">SPTextField</code> factory method (also known as a convenience constructor) that<a id="id453" class="indexterm"/> lets us define the width, height, text, font name, font size, and color in a single step. One thing we need to consider is to keep the font size similar to the original bitmap font size. If it's much bigger than the original size, the font gets all pixelated and washed out.</p><p>There is a way to get around this though: if we set <code class="literal">SP_NATIVE_FONT_SIZE</code> as the font size for the font instance, it will automatically calculate its actual size so that it is displayed as sharp as possible.</p><p>We defined the touch event for the reset button as a block and reset all of our in-game values and switched to the pirate cove scene. After this, we added all of our display objects to the display tree.</p><p>Then, we <a id="id454" class="indexterm"/>defined our custom getter and setter for our <code class="literal">gameWon</code> property:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>Getter</strong></span>: This simply returns the internal <code class="literal">_gameWon</code> value</li><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>Setter</strong></span>: After we set the property value, we updated the message depending on its value</li></ul></div><p>In the <code class="literal">Game</code> class, we need to create an instance of the <code class="literal">GameOver</code> scene, which we then added to the scene director. In step 16, we updated the default scene to be the game over scene.</p><p>When we ran the example in the last step, we saw the game over scene.</p><div class="section" title="Connecting the game over scene"><div class="titlepage"><div><div><h3 class="title"><a id="ch10lvl3sec11"/>Connecting the game over scene</h3></div></div></div><p>Now that we have our game over scene, let's integrate it into the game.</p></div></div></div>
<div class="section" title="Time for action &#x2013; having the game over scene show up"><div class="titlepage"><div><div><h1 class="title"><a id="ch10lvl1sec119"/>Time for action – having the game over scene show up</h1></div></div></div><p>To incorporate the game over scene into the game, use the following steps:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Switch to the <code class="literal">Battlefield.h</code> file.</li><li class="listitem">Remove both the <code class="literal">textGameWon</code> and <code class="literal">textGameLost</code> properties.</li><li class="listitem">Switch to the <code class="literal">Battlefield.m</code> file.</li><li class="listitem">Remove all references to the <code class="literal">textGameWon</code> and <code class="literal">textGameLost</code> properties.</li><li class="listitem">In the <code class="literal">GameOver.m</code> file, add a <code class="literal">reset</code> method using the following code:<div class="informalexample"><pre class="programlisting">-(void) reset
{
    self.gameWon = NO;
}</pre></div></li><li class="listitem">In the <code class="literal">SceneDirector.h</code> file, add a property called <code class="literal">currentScene</code> using the following code:<div class="informalexample"><pre class="programlisting">@property (readonly) Scene *currentScene;</pre></div></li><li class="listitem">In the <code class="literal">SceneDirector.m</code> file, update the <code class="literal">showScene</code> method to set the <code class="literal">currentScene</code> property, as shown in the following code:<div class="informalexample"><pre class="programlisting">-(void) showScene:(NSString *)name
{
    for (NSString* sceneName in _dict) {
        ((Scene *) _dict[sceneName]).visible = false;
        [((Scene *) _dict[sceneName]) stop];
    }
    
    if (_dict[name] != nil) {
        ((Scene *) _dict[name]).visible = YES;
        [((Scene *) _dict[name]) reset];
        _currentScene = (Scene *) _dict[name];
    }
}</pre></div></li><li class="listitem">Switch<a id="id455" class="indexterm"/> to the <code class="literal">Battlefield.m</code> file.</li><li class="listitem">Update<a id="id456" class="indexterm"/> the <code class="literal">reset</code> method to set the visibility of the ships, as shown in the following code:<div class="informalexample"><pre class="programlisting">-(void) reset
{
    self.paused = NO;
    
    _pirateShip.x = [(NSNumber *) [Assets dictionaryFromJSON:@"gameplay.json"][@"battlefield"][@"pirate"][@"x"] floatValue];
    _pirateShip.y = [(NSNumber *) [Assets dictionaryFromJSON:@"gameplay.json"][@"battlefield"][@"pirate"][@"y"] floatValue];
    
    [_pirateShip reset];
<span class="strong"><strong>    _pirateShip.visible = YES;</strong></span>
    
    for (int i = 0; i &lt; [_enemyShip count]; i++) {
         ((Ship *) _enemyShip[i]).x = [(NSNumber *) [Assets dictionaryFromJSON:@"gameplay.json"][@"battlefield"][@"enemy"][i][@"x"] floatValue];
        ((Ship *) _enemyShip[i]).y = [(NSNumber *) [Assets dictionaryFromJSON:@"gameplay.json"][@"battlefield"][@"enemy"][i][@"y"] floatValue];
        [((Ship *) _enemyShip[i]) reset];
        <span class="strong"><strong>((Ship *) _enemyShip[i]).visible = NO;</strong></span>
    }
    
    for (int i = 0; i &lt; World.level; i++) {
        ((Ship *) _enemyShip[i]).visible = YES;
        [self updateAI:_enemyShip[i] withState:_aiState];
    }
}</pre></div></li><li class="listitem">Update<a id="id457" class="indexterm"/> the condition to win the game, as shown in the following code:<div class="informalexample"><pre class="programlisting">if (deadCount == World.level) {
  if (World.level == World.levelMax) {
<span class="strong"><strong>    [(SceneDirector *) self.director showScene:@"gameover"];</strong></span>
<span class="strong"><strong>    ((GameOver *) ((SceneDirector *) self.director).currentScene).gameWon = YES;</strong></span>
  } else {
    World.gold = World.gold + (250 * World.level);
    World.level++;
    self.paused = YES;
    [((SceneDirector *) self.director) showScene:@"piratecove"];
  }
}</pre></div></li><li class="listitem">Next, update the condition to lose the game, as shown in the following code:<div class="informalexample"><pre class="programlisting">__weak typeof(self) weakSelf = self;
_pirateShip.onDead = ^{
<span class="strong"><strong>  [(SceneDirector *) weakSelf.director showScene:@"gameover"];</strong></span>
<span class="strong"><strong>  ((GameOver *) ((SceneDirector *) weakSelf.director).currentScene).gameWon = NO;</strong></span>
};</pre></div></li><li class="listitem">In <code class="literal">Game.m</code>, change the default scene back to the pirate cove.</li><li class="listitem">Run the example. When we run the example and once we actually lose the game, we see the following screen:<div class="mediaobject"><img src="graphics/1509OS_10_02.jpg" alt="Time for action – having the game over scene show up"/></div></li></ol></div><div class="section" title="What just happened?"><div class="titlepage"><div><div><h2 class="title"><a id="ch10lvl2sec136"/>
<span class="emphasis"><em>What just happened?</em></span>
</h2></div></div></div><p>In the <code class="literal">Battlefield</code> header file, we removed the text field properties that show up when the game was won or lost. Then, we removed all code portions that reference these properties in <code class="literal">Battlefield.m</code>.</p><p>In step 5, we <a id="id458" class="indexterm"/>added a <code class="literal">reset</code> method for our <code class="literal">GameOver</code> scene, where we set the <code class="literal">gameWon</code> property to <code class="literal">NO</code>. The difference between this scene switch is that we need to set the <code class="literal">gameWon</code> property after the scene has been switched. In order to facilitate this, we updated the scene director.</p><p>In the next step, we added a read-only property called <code class="literal">currentScene</code> that gives us a reference<a id="id459" class="indexterm"/> to the current scene. After this, we updated the <code class="literal">showScene</code> method<a id="id460" class="indexterm"/> to set the current scene. This happened right after we set the current scene to be visible and called the <code class="literal">reset</code> method.</p><p>In the battlefield scene, we first updated the visibilities of our ships. If we hadn't done this, the enemy ships would stay visible even after we reset the game.</p><p>In steps 10 and 11, we updated the win and lose conditions. We imported the <code class="literal">GameOver.h</code> file here as well, in order to cast the <code class="literal">currentScene</code> property to a pointer to the <code class="literal">GameOver</code> class.</p><p>The last thing we did was change back to the pirate cove scene. When we ran the example and when we lost or won the game, the game over scene was shown and we were able to restart the game.</p></div><div class="section" title="Adding a main menu"><div class="titlepage"><div><div><h2 class="title"><a id="ch10lvl2sec137"/>Adding a main menu</h2></div></div></div><p>Next, we<a id="id461" class="indexterm"/> are going to add a simple main menu.</p></div></div>
<div class="section" title="Time for action &#x2013; integrating the main menu into our game"><div class="titlepage"><div><div><h1 class="title"><a id="ch10lvl1sec120"/>Time for action – integrating the main menu into our game</h1></div></div></div><p>Use the following <a id="id462" class="indexterm"/>steps to add a main menu:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Add a new class called <code class="literal">MainMenu</code> which should be a subclass of <code class="literal">Scene</code>.</li><li class="listitem">Switch to <code class="literal">MainMenu.m</code>.</li><li class="listitem">Import <code class="literal">Assets.h</code> and <code class="literal">SceneDirector.h</code>.</li><li class="listitem">Add the initializer for the main menu, as shown in the following code:<div class="informalexample"><pre class="programlisting">-(id) init
{
    if ((self = [super init])) {
        
        SPImage *background = [SPImage imageWithTexture:[Assets texture:@"water.png"]];
        
    SPTexture *shipTexture = [[Assets textureAtlas:@"ship_pirate_small_cannon.xml"] textureByName:@"ne_0001"];
        SPImage *ship = [SPImage imageWithTexture:shipTexture];
        ship.x = 16.0f;
        ship.y = (Sparrow.stage.height - ship.height) / 2;
        
    SPTexture *dialogTexture = [[Assets textureAtlas:@"ui.xml"] textureByName:@"dialog_yes"];
        SPButton *buttonNewGame = [SPButton buttonWithUpState:dialogTexture text:@"New game"];
        
        buttonNewGame.x = (Sparrow.stage.width - buttonNewGame.width) / 2;
        buttonNewGame.y = 50.0f;
        
        [buttonNewGame addEventListenerForType:SP_EVENT_TYPE_TRIGGERED block:^(id event) {
            [(SceneDirector *) self.director showScene:@"piratecove"];
        }];
        
        SPButton *buttonContinue = [SPButton buttonWithUpState:dialogTexture text:@"Continue"];
        
        buttonContinue.x = (Sparrow.stage.width - buttonContinue.width) / 2;
        buttonContinue.y = 150.0f;
        buttonContinue.enabled = NO;
        
        [self addChild:background];
        [self addChild:ship];
        [self addChild:buttonNewGame];
        [self addChild:buttonContinue];
    }
    
    return self;
}</pre></div></li><li class="listitem">Switch to <code class="literal">Game.m</code>.</li><li class="listitem">Import <code class="literal">MainMenu.h</code> using the following line of code:<div class="informalexample"><pre class="programlisting">#import "MainMenu.h"</pre></div></li><li class="listitem">Using the<a id="id463" class="indexterm"/> following code, create a local variable for the main menu that will hold an instance of the <code class="literal">MainMenu</code> class.<div class="informalexample"><pre class="programlisting">MainMenu *mainMenu = [[MainMenu alloc] initWithName:@"mainmenu"];</pre></div></li><li class="listitem">Add the <code class="literal">mainMenu</code> instance to the director, as shown in the following code:<div class="informalexample"><pre class="programlisting">[director addScene:mainMenu];</pre></div></li><li class="listitem">Update the <code class="literal">showScene</code> call to the main menu scene, as shown in the following code:<div class="informalexample"><pre class="programlisting">[director showScene:@"mainmenu"];</pre></div></li><li class="listitem">Run the example and we will see the main menu, as shown in the following screenshot:<div class="mediaobject"><img src="graphics/1509OS_10_03.jpg" alt="Time for action – integrating the main menu into our game"/></div></li></ol></div><div class="section" title="What just happened?"><div class="titlepage"><div><div><h2 class="title"><a id="ch10lvl2sec138"/>
<span class="emphasis"><em>What just happened?</em></span>
</h2></div></div></div><p>To add a main menu, we needed a class subclassed from <code class="literal">Scene</code>. Once the class was created, we imported the asset management system and the scene director.</p><p>In step 3, we added the initializer. Our main menu consists of the following:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">The same background that we used in the battlefield and other scenes</li><li class="listitem" style="list-style-type: disc">A pirate ship</li><li class="listitem" style="list-style-type: disc">A button to start a new game</li><li class="listitem" style="list-style-type: disc">A button to continue the game</li></ul></div><p>For the<a id="id464" class="indexterm"/> new game, we used a block for its touch event, which switches to the pirate cove scene. The <span class="strong"><strong>Continue</strong></span> button does not have an event yet and is disabled. After this, we need to take all our elements to the display tree.</p><p>In steps 5 to 9, we added the main menu to our game class in a manner similar to how we added the game over scene.</p><p>When we ran the example, we saw the main menu.</p></div><div class="section" title="Have a go hero"><div class="titlepage"><div><div><h2 class="title"><a id="ch10lvl2sec139"/>Have a go hero</h2></div></div></div><p>The main menu now only has two buttons. Typically, a main menu offers a bit more than this such as buttons to switch to the options menu or the credits screen. In some instances, the main menu even has buttons to navigate to social sites. Go ahead and add the options and credits screens, which can be opened from the main menu.</p></div><div class="section" title="Adding an intro scene"><div class="titlepage"><div><div><h2 class="title"><a id="ch10lvl2sec140"/>Adding an intro scene</h2></div></div></div><p>An intro scene is a perfect way to introduce the player to the characters, the story or the art style of a game. An intro is not necessary for all games; in fact, it's best used if it fits into the overall game and style of the game.</p><p>As we don't have a story or characters, we are going to show two ships moving near each other, shooting each other, and eventually one of the ships sinks.</p></div></div>
<div class="section" title="Time for action &#x2013; creating an intro for our game"><div class="titlepage"><div><div><h1 class="title"><a id="ch10lvl1sec121"/>Time for action – creating an intro for our game</h1></div></div></div><p>Use the <a id="id465" class="indexterm"/>following steps to add the intro scene:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">This is as good a time as any to move the collision detection code into a separate file. Create a new group called <code class="literal">Logic</code> and add a class inside this group called <code class="literal">Collision</code> which is a subclass of <code class="literal">NSObject</code>.</li><li class="listitem">Declare this static method in the <code class="literal">Collision</code> class, as shown in the following code:<div class="informalexample"><pre class="programlisting">+(void) checkShipCollision: (Ship *) ship1 againstShip: (Ship *) ship2 withReferenceToSprite: (SPSprite *) sprite;</pre></div></li><li class="listitem">Inside <code class="literal">Collision.m</code>, implement the <code class="literal">checkShipCollision</code> method with the following lines of code:<div class="informalexample"><pre class="programlisting">SPRectangle *enemyShipBounds = [ship1 boundsInSpace:sprite];
SPRectangle *ball1 = [ship2.cannonBallLeft boundsInSpace:sprite];
SPRectangle *ball2 = [ship2.cannonBallRight boundsInSpace:sprite];

if ([enemyShipBounds intersectsRectangle:ball1] || [enemyShipBounds intersectsRectangle:ball2]) {
  if (ship2.cannonBallLeft.visible || ship2.cannonBallRight.visible) {
    [ship2 abortShooting];
    if (ship1.type == ShipPirate) {
      [ship1 hit: World.damage];
    } else {
      [ship1 hit:[(NSNumber *) [Assets dictionaryFromJSON:@"gameplay.json"][@"damage"] intValue]];
    }
  }
}</pre></div></li><li class="listitem">In order<a id="id466" class="indexterm"/> for this code to work, we need to import <code class="literal">Assets.h</code> and <code class="literal">World.h</code> in the <code class="literal">Collision.m</code> file.</li><li class="listitem">In <code class="literal">Battlefield.m</code>, delete the collision code, import <code class="literal">Collision.h</code>, and use the new method from the <code class="literal">Collision</code> class now:<div class="informalexample"><pre class="programlisting">for (int i = 0; i &lt; World.level; i++) {
<span class="strong"><strong>  [Collision checkShipCollision:_pirateShip againstShip:_enemyShip[i] withReferenceToSprite:self];</strong></span>
<span class="strong"><strong>  [Collision checkShipCollision:_enemyShip[i] againstShip:_pirateShip withReferenceToSprite:self];</strong></span>
  
  [_enemyShip[i] advanceTime:passedTime];
  if (((Ship *) _enemyShip[i]).isDead) {
    deadCount++;
  }
}</pre></div></li><li class="listitem">Add the intro scene by subclassing <code class="literal">Scene</code> and call it <code class="literal">Intro</code>. This should be done inside the <code class="literal">GameScenes</code> group.</li><li class="listitem">In <code class="literal">Intro.h</code>, import <code class="literal">Ship.h</code> and add two instance variables, one for the pirate ship and one for the enemy ship, as shown in the following code:<div class="informalexample"><pre class="programlisting">@interface Intro : Scene {
    Ship *_pirateShip;
    Ship *_enemyShip;
}</pre></div></li><li class="listitem">Switch to <code class="literal">Intro.m</code>.</li><li class="listitem">Add an<a id="id467" class="indexterm"/> initializer for the <code class="literal">Intro</code> class with the help of the following code:<div class="informalexample"><pre class="programlisting">-(id) init
{
    if ((self = [super init])) {
        
        SPImage *background = [SPImage imageWithTexture:[Assets texture:@"water.png"]];
          
        _pirateShip = [[Ship alloc] initWithType:ShipPirate];
        _pirateShip.x = 16.0f;
        _pirateShip.y = ((Sparrow.stage.height - _pirateShip.height) / 2) - 20.0f;
        
        _enemyShip = [[Ship alloc] initWithType:ShipNormal];
        _enemyShip.x = Sparrow.stage.width - _enemyShip.width - 16.0f;
        _enemyShip.y = ((Sparrow.stage.height - _enemyShip.height) / 2) + 20.0f;
        
        [self addEventListener:@selector(onEnterFrame:) atObject:self forType:SP_EVENT_TYPE_ENTER_FRAME];
        
        SPButton *buttonNext = [SPButton buttonWithUpState:[[Assets textureAtlas:@"ui.xml"] textureByName:@"dialog_yes"] text:@"Next"];
        
        buttonNext.x = (Sparrow.stage.width - buttonNext.width) / 2;
        buttonNext.y = Sparrow.stage.height - buttonNext.height - 8.0f;
        
        [buttonNext addEventListenerForType:SP_EVENT_TYPE_TRIGGERED block:^(id event) {
            [(SceneDirector *) self.director showScene:@"piratecove"];
        }];
        [self addChild:background];
        [self addChild:_pirateShip];
        [self addChild:_enemyShip];
        [self addChild:buttonNext];
    }
    
    return self;
}</pre></div></li><li class="listitem">Add the event listener for <code class="literal">onEnterFrame</code>, as shown in the following code:<div class="informalexample"><pre class="programlisting">-(void) onEnterFrame: (SPEnterFrameEvent *) event
{
    double passedTime = event.passedTime;
    
    [Collision checkShipCollision:_pirateShip againstShip:_enemyShip withReferenceToSprite:self];
    [Collision checkShipCollision:_enemyShip againstShip:_pirateShip withReferenceToSprite:self];
    
    [_pirateShip advanceTime:passedTime];
    [_enemyShip advanceTime:passedTime];
}</pre></div></li><li class="listitem">Add <a id="id468" class="indexterm"/>a reset method, as shown in the following code:<div class="informalexample"><pre class="programlisting">-(void) reset
{
    [_pirateShip reset];
    [_enemyShip reset];
    
    [_pirateShip moveToX:Sparrow.stage.width / 2 andY:(Sparrow.stage.height / 2) - 20.0f withBlock:^{
        [_pirateShip.juggler delayInvocationByTime:1.5f block:^{
            [_pirateShip shootWithBlock:^{
                [_pirateShip shootWithBlock:^{
                    [_pirateShip shootWithBlock:^{
                        [_pirateShip.juggler delayInvocationByTime:1.0f block:^{
                            [_pirateShip shoot];
                        }];
                    }];
                }];
            }];
        }];
    }];
    
    [_enemyShip moveToX:Sparrow.stage.width / 2 andY:(Sparrow.stage.height / 2) + 20.0f withBlock:^{
        [_enemyShip shoot];
    }];
}</pre></div></li><li class="listitem">In <code class="literal">MainMenu.m</code>, show the intro scene if the new game button has been touched.</li><li class="listitem">In <code class="literal">Game.m</code>, import <code class="literal">Intro.h</code>, create an instance of the <code class="literal">Intro</code> class, and add it the director.</li><li class="listitem">Run the example.<p>When we start a new game, we see the intro in action, as shown in the following code:</p><div class="mediaobject"><img src="graphics/1509OS_10_04.jpg" alt="Time for action – creating an intro for our game"/></div></li></ol></div><div class="section" title="What just happened?"><div class="titlepage"><div><div><h2 class="title"><a id="ch10lvl2sec141"/>
<span class="emphasis"><em>What just happened?</em></span>
</h2></div></div></div><p>As we <a id="id469" class="indexterm"/>needed the collision detection in both the intro and the game itself, we moved it into its own class. When we moved the checkShipCollision method, we added an additional parameter. This parameter was then passed as a reference to the <code class="literal">boundsInSpace</code> method. We imported the asset management and the <code class="literal">World</code> class for this code snippet to work.</p><p>In the next step, we updated the collision in the battlefield scene.</p><p>We then added a new scene called <code class="literal">Intro</code>, where we first added two instance variables, one for our own ship and one for the pirate ship. In step 9, we added the initializer, which perform the following:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">Add the water background</li><li class="listitem" style="list-style-type: disc">Initialize both ship instances</li><li class="listitem" style="list-style-type: disc">Add a button to skip the intro</li></ul></div><p>We then added an event listener to skip the event listener and switch to the pirate cove scene. We also added an event listener for the enter frame event. We then added all elements to the display tree</p><p>In step 10, we implemented the <code class="literal">onEnterFrame</code> event listener, which calls the collision method and advances the time of both ships.</p><p>The <code class="literal">reset</code> method calls the <code class="literal">reset</code> method of these ships and moves the ships to the center of the screen. The enemy ship can shoot only once, while the pirate ships can shoot multiple times to kill the enemy ship.</p><p>We<a id="id470" class="indexterm"/> showed the intro scene in the main menu. After this, we added the <code class="literal">Intro</code> class to the game class, and when we ran the example, we saw the intro scene when we started a new game.</p></div></div>
<div class="section" title="Implementing tutorial mechanics"><div class="titlepage"><div><div><h1 class="title"><a id="ch10lvl1sec122"/>Implementing tutorial mechanics</h1></div></div></div><p>There are many different ways for tutorials to be implemented. It may range from just showing an image with controls, to having an interactive experience, to displaying a control scheme each time the player is about to perform an action. In general, the last two options could be achieved with a finite state machine, similar to the one we used for our artificial intelligence.</p><p>For our purposes, we will update the intro scene to display hints while the animation is playing.</p></div>
<div class="section" title="Time for action &#x2013; adding a tutorial to our intro scene"><div class="titlepage"><div><div><h1 class="title"><a id="ch10lvl1sec123"/>Time for action – adding a tutorial to our intro scene</h1></div></div></div><p>Follow <a id="id471" class="indexterm"/>these steps to <a id="id472" class="indexterm"/>display hints during the intro:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">In <code class="literal">Intro.h</code>, add an instance variable called message:<div class="informalexample"><pre class="programlisting">SPTextField *_message;</pre></div></li><li class="listitem">Switch to <code class="literal">Intro.m</code>.</li><li class="listitem">Update the initializer with the help of the following code:<div class="informalexample"><pre class="programlisting">[buttonNext addEventListenerForType:SP_EVENT_TYPE_TRIGGERED block:^(id event) {
  [(SceneDirector *) self.director showScene:@"piratecove"];
}];

<span class="strong"><strong>SPQuad *quad = [SPQuad quadWithWidth:400.0f height:60.0f color:SP_BLACK];</strong></span>
<span class="strong"><strong>quad.alpha = 0.8f;</strong></span>
<span class="strong"><strong>quad.x = 16.0f;</strong></span>
<span class="strong"><strong>quad.y = 16.0f;</strong></span>

<span class="strong"><strong>_message = [SPTextField textFieldWithWidth:400.0f height:60.0f text:@"Welcome to the battlefield."];</strong></span>
<span class="strong"><strong>_message.color = SP_WHITE;</strong></span>
<span class="strong"><strong>_message.x = 16.0f;</strong></span>
<span class="strong"><strong>_message.y = 16.0f;</strong></span>

[self addChild:background];
[self addChild:_pirateShip];
[self addChild:_enemyShip];
[self addChild:buttonNext];
<span class="strong"><strong>[self addChild:quad];</strong></span>
<span class="strong"><strong>[self addChild:_message];</strong></span>
</pre></div></li><li class="listitem">Update<a id="id473" class="indexterm"/> the <code class="literal">reset</code> method, as<a id="id474" class="indexterm"/> shown in the following code:<div class="informalexample"><pre class="programlisting">[_pirateShip moveToX:Sparrow.stage.width / 2 andY:(Sparrow.stage.height / 2) - 20.0f withBlock:^{
<span class="strong"><strong>  _message.text = @"There is your ship (the pirate ship) and at least one enemy";</strong></span>
  [_pirateShip.juggler delayInvocationByTime:2.5f block:^{
    [_pirateShip shootWithBlock:^{
       _message.text = @"Tap anywhere to move your ship.";
      [_pirateShip shootWithBlock:^{
        [_pirateShip shootWithBlock:^{
          <span class="strong"><strong>_message.text = @"Double-tap on your ship to shoot.";</strong></span>
          [_pirateShip.juggler delayInvocationByTime:2.5f block:^{
            <span class="strong"><strong>_message.text = @"In-between missions you can upgrade your ship.";</strong></span>
            [_pirateShip shoot];
          }];
        }];
      }];
    }];
  }];
}];</pre></div></li><li class="listitem">Run the example and when we see the intro, we now have hints displayed on the screen:<div class="mediaobject"><img src="graphics/1509OS_10_05.jpg" alt="Time for action – adding a tutorial to our intro scene"/></div></li></ol></div><div class="section" title="What just happened?"><div class="titlepage"><div><div><h2 class="title"><a id="ch10lvl2sec142"/>
<span class="emphasis"><em>What just happened?</em></span>
</h2></div></div></div><p>We first<a id="id475" class="indexterm"/> added an instance variable to display our hints. We<a id="id476" class="indexterm"/> then updated the initializer to initialize this instance variable and have a black but slightly opaque background. We added these two elements to the display tree.</p><p>In step 4, we updated the <code class="literal">reset</code> method to change the text of the message to show how the core gameplay elements work.</p><p>When we ran the example, the hints were displayed during the intro.</p></div></div>
<div class="section" title="Loading and saving the current state"><div class="titlepage"><div><div><h1 class="title"><a id="ch10lvl1sec124"/>Loading and saving the current state</h1></div></div></div><p>So far we can play the game, but as soon as we end the game, we have to start the game from the beginning.</p></div>
<div class="section" title="Time for action &#x2013; loading and saving the last played game"><div class="titlepage"><div><div><h1 class="title"><a id="ch10lvl1sec125"/>Time for action – loading and saving the last played game</h1></div></div></div><p>Follow <a id="id477" class="indexterm"/>these steps to load and save the current state:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">In <code class="literal">World.h</code>, declare<a id="id478" class="indexterm"/> methods to serialize and deserialize data:<div class="informalexample"><pre class="programlisting">+(NSDictionary *) serialize;
+(void) deserialize: (NSDictionary *) dict;</pre></div></li><li class="listitem">Implement these serializers with the following lines of code:<div class="informalexample"><pre class="programlisting">+(NSDictionary *) serialize
{
    return @{
             @"level": [NSNumber numberWithInt:level],
             @"gold": [NSNumber numberWithInt:gold],
             @"damage": [NSNumber numberWithInt:damage],
             @"hitpoints": [NSNumber numberWithInt:hitpoints]
    };
}

+(void) deserialize: (NSDictionary *) dict
{
    level = [(NSNumber *) dict[@"level"] intValue];
    gold = [(NSNumber *) dict[@"gold"] intValue];
    damage = [(NSNumber *) dict[@"damage"] intValue];
    hitpoints = [(NSNumber *) dict[@"hitpoints"] intValue];
}</pre></div></li><li class="listitem">In<a id="id479" class="indexterm"/> <code class="literal">MainMenu.m</code>, add <code class="literal">World.h</code> to the import section<a id="id480" class="indexterm"/> and update the initializer:<div class="informalexample"><pre class="programlisting">buttonContinue.x = (Sparrow.stage.width - buttonContinue.width) / 2;
buttonContinue.y = 150.0f;
buttonContinue.enabled = NO;

NSUserDefaults *userDefaults = [NSUserDefaults standardUserDefaults];
id savedGame = [userDefaults objectForKey:@"game"];
if (savedGame != nil) {
  [World deserialize:(NSDictionary *) [userDefaults objectForKey:@"game"]];
  buttonContinue.enabled = YES;
}

[buttonContinue addEventListenerForType:SP_EVENT_TYPE_TRIGGERED block:^(id event) {
  [(SceneDirector *) self.director showScene:@"piratecove"];
}];

[self addChild:background];</pre></div></li><li class="listitem">In <code class="literal">AppDelegate.m</code>, we import <code class="literal">World.h</code> and add a new method, as shown in the following code:<div class="informalexample"><pre class="programlisting">- (void)applicationWillResignActiveNotification:(NSNotification*)notification
{
    NSUserDefaults *userDefaults = [NSUserDefaults standardUserDefaults];
    [userDefaults setObject:[World serialize] forKey:@"game"];
    [userDefaults synchronize];
}</pre></div></li><li class="listitem">Run the example to see the result. When we start the game, we can now continue the game:<div class="mediaobject"><img src="graphics/1509OS_10_06.jpg" alt="Time for action – loading and saving the last played game"/></div></li></ol></div><div class="section" title="What just happened?"><div class="titlepage"><div><div><h2 class="title"><a id="ch10lvl2sec143"/>
<span class="emphasis"><em>What just happened?</em></span>
</h2></div></div></div><p>First, we added the serializer and deserializer methods to our <code class="literal">World</code> class. The serializer takes<a id="id481" class="indexterm"/> values from the <code class="literal">World</code> class and places them in <code class="literal">NSDictionary</code>. The<a id="id482" class="indexterm"/> deserializer works the other way around. It takes values from <code class="literal">NSDictionary</code> and updates the values in the <code class="literal">World</code> class.</p><p>In the main menu scene, we checked whether there is already something saved and we deserialize the data in case there is any data. We added an event listener for our <span class="strong"><strong>Continue</strong></span> button, which directly switches to the pirate cove scene.</p><p>In step 4, we saved the game data once the application was not active any more.</p><p>When we ran the example, we were able to resume the game.</p></div><div class="section" title="Pop quiz"><div class="titlepage"><div><div><h2 class="title"><a id="ch10lvl2sec144"/>Pop quiz</h2></div></div></div><p>Q1. When we override the font size for a bitmap font in SPTextField, it scales to that size.</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">True</li><li class="listitem">False</li></ol></div><p>Q2. When is it a good idea to encapsulate code snippets into their own class or methods?</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Always, even if it's just used a single time</li><li class="listitem">If the code snippet is being used multiple times</li><li class="listitem">Never</li></ol></div><p>Q3. <code class="literal">NSUserDefaults</code> provides a way to store data.</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">True</li><li class="listitem">False</li></ol></div></div></div>
<div class="section" title="Summary"><div class="titlepage"><div><div><h1 class="title"><a id="ch10lvl1sec126"/>Summary</h1></div></div></div><p>In this chapter, we learned about polishing our game. Specifically, we covered adding more scenes such as a main menu and an intro, and we touched upon tutorial mechanics.</p><p>Now that our game almost feels like an actual game, let's see how we can integrate third-party services—which is the topic of the next chapter.</p></div></body></html>