- en: '*Chapter 6*: Handling Flow Cancelations and Exceptions'
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: In the previous chapter, we focused on Kotlin Flows and learned how we can use
    them in our Android projects. We learned about creating Kotlin Flows with Flow
    builders. We then explored Flow operators and how to use them with Kotlin Flows.
    We then learned about buffering and combining Flows. Finally, we explored `SharedFlow`
    and `StateFlow`.
  prefs: []
  type: TYPE_NORMAL
- en: Flows can be canceled, and they can fail or encounter exceptions. Developers
    must be able to handle these properly to prevent application crashes and to inform
    their users with a dialog or a toast message. We will discuss how to do these
    tasks in this chapter.
  prefs: []
  type: TYPE_NORMAL
- en: In this chapter, we will start by understanding Flow cancelation. We will learn
    how to cancel Flows and handle cancelations for our Flows. Then, we will learn
    how to manage failures and exceptions that can happen in our Flows. We will also
    learn about retrying and handling Flow completion.
  prefs: []
  type: TYPE_NORMAL
- en: 'In this chapter, we are going to cover the following main topics:'
  prefs: []
  type: TYPE_NORMAL
- en: Canceling Kotlin Flows
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Retrying tasks with Flow
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Catching exceptions in Flows
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Handling flow completion
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: By the end of this chapter, you will understand how to cancel flows, and will
    have learned how to manage cancelations and how to handle exceptions in flows.
  prefs: []
  type: TYPE_NORMAL
- en: Technical requirements
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: 'You will need to download and install the latest version of Android Studio.
    You can find the latest version at [https://developer.android.com/studio](https://developer.android.com/studio).
    For an optimal learning experience, a computer with the following specifications
    is recommended:'
  prefs: []
  type: TYPE_NORMAL
- en: Intel Core i5 or equivalent or higher
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: 4 GB RAM minimum
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: 4 GB available space
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: The code examples for this chapter can be found on GitHub at [https://github.com/PacktPublishing/Simplifying-Android-Development-with-Coroutines-and-Flows/tree/main/Chapter06](https://github.com/PacktPublishing/Simplifying-Android-Development-with-Coroutines-and-Flows/tree/main/Chapter06)
  prefs: []
  type: TYPE_NORMAL
- en: Canceling Kotlin Flows
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: In this section, we will start by looking at Kotlin Flow cancelations. Like
    coroutines, Flows can also be canceled manually or automatically.
  prefs: []
  type: TYPE_NORMAL
- en: In [*Chapter 3*](B17773_03_Epub.xhtml#_idTextAnchor042), *Handling Coroutine
    Cancelations and Exceptions*, we learned about canceling coroutines and that coroutine
    cancellation must be cooperative. As Kotlin Flows are built on top of coroutines,
    Flow follows the cooperative cancellation of coroutines.
  prefs: []
  type: TYPE_NORMAL
- en: Flows created using the `flow{}` builder are cancellable by default. Each `emit`
    call to send new values to the Flow also calls `ensureActive` internally. This
    checks whether the coroutine is still active, and if not, it will throw `CancellationException`.
  prefs: []
  type: TYPE_NORMAL
- en: 'For example, we can use the `flow{}` builder to create a cancellable Flow,
    as shown in the following:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE0]'
  prefs: []
  type: TYPE_PRE
- en: '[PRE1]'
  prefs: []
  type: TYPE_PRE
- en: '[PRE2]'
  prefs: []
  type: TYPE_PRE
- en: '[PRE3]'
  prefs: []
  type: TYPE_PRE
- en: '[PRE4]'
  prefs: []
  type: TYPE_PRE
- en: '[PRE5]'
  prefs: []
  type: TYPE_PRE
- en: '[PRE6]'
  prefs: []
  type: TYPE_PRE
- en: '[PRE7]'
  prefs: []
  type: TYPE_PRE
- en: In the `fetchMovies` function here, we used the `flow` builder to create the
    Flow of movies returned by `movieRepository.fetchMovies`. This `Flow<Movie>` will
    be a cancellable Flow by default.
  prefs: []
  type: TYPE_NORMAL
- en: All other Flows, such as ones created using the `asFlow` and `flowOf` Flow builders,
    are not cancellable by default. We must handle the cancellation ourselves. There
    is a `cancellable()` operator we can use on a Flow to make it cancelable. This
    will add an `ensureActive` call on each emission of a new value.
  prefs: []
  type: TYPE_NORMAL
- en: 'The following example shows how we can make a Flow cancelable using the `cancellable`
    Flow operator:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE8]'
  prefs: []
  type: TYPE_PRE
- en: '[PRE9]'
  prefs: []
  type: TYPE_PRE
- en: '[PRE10]'
  prefs: []
  type: TYPE_PRE
- en: '[PRE11]'
  prefs: []
  type: TYPE_PRE
- en: '[PRE12]'
  prefs: []
  type: TYPE_PRE
- en: '[PRE13]'
  prefs: []
  type: TYPE_PRE
- en: In this example, we used the cancelable operator on the Flow returned by `movieRepository.fetchMovies()`
    to make the resulting Flow cancelable.
  prefs: []
  type: TYPE_NORMAL
- en: In this section, we learned how to cancel Kotlin Flows and how to make sure
    your Flows can be cancellable. In the next section, we will focus on how to retry
    your tasks with Kotlin Flows.
  prefs: []
  type: TYPE_NORMAL
- en: Retrying tasks with Flow
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: In this section, we will explore Kotlin Flow retrying. There are cases when
    retrying an operation is needed for your application.
  prefs: []
  type: TYPE_NORMAL
- en: When performing long-running tasks, such as a network call, sometimes it is
    necessary to try the call again. This includes cases such as logging in/out, posting
    data, or even fetching data. The user may be in an area with a low internet connection,
    or there may be other factors why the call is failing. With Kotlin Flows, we have
    the `retry` and `retryWhen` operators that we can use to retry Flows automatically.
  prefs: []
  type: TYPE_NORMAL
- en: The `retry` operator allows you to set a `retries` as the maximum number of
    times the Flow will retry. You can also set a `predicate` condition, a code block
    that will retry the Flow when it returns `true`. The predicate has a **Throwable**
    parameter representing the exception that occurred; you can use that to check
    whether you want to do the retry or not.
  prefs: []
  type: TYPE_NORMAL
- en: 'The following example shows how we can use the `retry` Flow operator to retry
    our tasks in our Flow:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE14]'
  prefs: []
  type: TYPE_PRE
- en: '[PRE15]'
  prefs: []
  type: TYPE_PRE
- en: '[PRE16]'
  prefs: []
  type: TYPE_PRE
- en: '[PRE17]'
  prefs: []
  type: TYPE_PRE
- en: '[PRE18]'
  prefs: []
  type: TYPE_PRE
- en: '[PRE19]'
  prefs: []
  type: TYPE_PRE
- en: Here, the Flow from `movieRepository.favoriteMovie(id)` will be retried up to
    three times when the exception encountered is `IOException`.
  prefs: []
  type: TYPE_NORMAL
- en: If you do not pass a value for the retries, the default of `Long.MAX_VALUE`
    will be used. `predicate,` when not provided, has a default value of `true`, meaning
    the Flow will always be retried if `retries` has not yet been reached.
  prefs: []
  type: TYPE_NORMAL
- en: 'The `retryWhen` operator is similar to the `retry` operator. We need to specify
    `predicate`, which is the condition and only when `true` will it perform the retry.
    `predicate` has a `true`, will retry the Flow. The following code shows an example
    of using `retryWhen` to retry your tasks in your Flow:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE20]'
  prefs: []
  type: TYPE_PRE
- en: '[PRE21]'
  prefs: []
  type: TYPE_PRE
- en: '[PRE22]'
  prefs: []
  type: TYPE_PRE
- en: '[PRE23]'
  prefs: []
  type: TYPE_PRE
- en: '[PRE24]'
  prefs: []
  type: TYPE_PRE
- en: '[PRE25]'
  prefs: []
  type: TYPE_PRE
- en: '[PRE26]'
  prefs: []
  type: TYPE_PRE
- en: In this example, we used `retryWhen` and specified that the retry will be done
    when the value of `attempt` is less than three and only if the exception is `IOException`.
  prefs: []
  type: TYPE_NORMAL
- en: 'With the `retryWhen` operator, we can also emit a value to the Flow (with the
    `emit` function), which we can use to represent the retry attempt or a value.
    We can then display this value on the screen or process it. The following example
    shows how we can use `emit` with the `retryWhen` operator:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE27]'
  prefs: []
  type: TYPE_PRE
- en: '[PRE28]'
  prefs: []
  type: TYPE_PRE
- en: '[PRE29]'
  prefs: []
  type: TYPE_PRE
- en: '[PRE30]'
  prefs: []
  type: TYPE_PRE
- en: '[PRE31]'
  prefs: []
  type: TYPE_PRE
- en: '[PRE32]'
  prefs: []
  type: TYPE_PRE
- en: '[PRE33]'
  prefs: []
  type: TYPE_PRE
- en: '[PRE34]'
  prefs: []
  type: TYPE_PRE
- en: '[PRE35]'
  prefs: []
  type: TYPE_PRE
- en: '[PRE36]'
  prefs: []
  type: TYPE_PRE
- en: Here, the Flowâ€™s task will be retried when the number of attempts is less than
    three and only if the exception is `Fetching title again` string that can be processed
    by the activity or fragment that listens to the Flow returned by `MovieViewModel.getTopMovieTitle()`.
  prefs: []
  type: TYPE_NORMAL
- en: In this section, you learned about retrying tasks such as network requests with
    Kotlin Flow. We will explore Kotlin Flow exceptions and how to update our code
    to catch these exceptions in the next section.
  prefs: []
  type: TYPE_NORMAL
- en: Catching exceptions in Flows
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: The Flows in your code can encounter `CancellationException` when they are canceled
    or other exceptions when emitting or collecting values. In this section, we will
    learn how to handle these Kotlin Flow exceptions.
  prefs: []
  type: TYPE_NORMAL
- en: 'Exceptions can happen in Flows during the collection of values or when using
    any operators on a Flow. We can handle exceptions in Flows by enclosing the collection
    of the Flow in our code with a `try-catch` block. For example, in the following
    code, the `try-catch` block is used to add exception handling:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE37]'
  prefs: []
  type: TYPE_PRE
- en: '[PRE38]'
  prefs: []
  type: TYPE_PRE
- en: '[PRE39]'
  prefs: []
  type: TYPE_PRE
- en: '[PRE40]'
  prefs: []
  type: TYPE_PRE
- en: '[PRE41]'
  prefs: []
  type: TYPE_PRE
- en: '[PRE42]'
  prefs: []
  type: TYPE_PRE
- en: '[PRE43]'
  prefs: []
  type: TYPE_PRE
- en: '[PRE44]'
  prefs: []
  type: TYPE_PRE
- en: '[PRE45]'
  prefs: []
  type: TYPE_PRE
- en: '[PRE46]'
  prefs: []
  type: TYPE_PRE
- en: '[PRE47]'
  prefs: []
  type: TYPE_PRE
- en: '[PRE48]'
  prefs: []
  type: TYPE_PRE
- en: '[PRE49]'
  prefs: []
  type: TYPE_PRE
- en: '[PRE50]'
  prefs: []
  type: TYPE_PRE
- en: '[PRE51]'
  prefs: []
  type: TYPE_PRE
- en: '[PRE52]'
  prefs: []
  type: TYPE_PRE
- en: '[PRE53]'
  prefs: []
  type: TYPE_PRE
- en: Here, the collection code for the Flow returned by `viewModel.fetchMovies` was
    wrapped in a `try-catch` block. If an exception was encountered in the Flow, the
    exception message will be logged with the `Error` tag and `exception.message`
    as the message.
  prefs: []
  type: TYPE_NORMAL
- en: We can also use the `catch` Flow operator to handle exceptions in our Flow.
    With the `catch` operator, we can catch the exceptions from the upstream Flow,
    or the function and operators before the `catch` operator was called.
  prefs: []
  type: TYPE_NORMAL
- en: 'In the following example, the `catch` operator was used to catch exceptions
    from the Flow returned by `viewModel.fetchMovies`:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE54]'
  prefs: []
  type: TYPE_PRE
- en: '[PRE55]'
  prefs: []
  type: TYPE_PRE
- en: '[PRE56]'
  prefs: []
  type: TYPE_PRE
- en: '[PRE57]'
  prefs: []
  type: TYPE_PRE
- en: '[PRE58]'
  prefs: []
  type: TYPE_PRE
- en: '[PRE59]'
  prefs: []
  type: TYPE_PRE
- en: '[PRE60]'
  prefs: []
  type: TYPE_PRE
- en: '[PRE61]'
  prefs: []
  type: TYPE_PRE
- en: '[PRE62]'
  prefs: []
  type: TYPE_PRE
- en: '[PRE63]'
  prefs: []
  type: TYPE_PRE
- en: '[PRE64]'
  prefs: []
  type: TYPE_PRE
- en: '[PRE65]'
  prefs: []
  type: TYPE_PRE
- en: '[PRE66]'
  prefs: []
  type: TYPE_PRE
- en: '[PRE67]'
  prefs: []
  type: TYPE_PRE
- en: Here, the `catch` operator was used in the Flow to catch the exceptions. The
    exception, which is an instance of `handleException` function that is going to
    handle the exception.
  prefs: []
  type: TYPE_NORMAL
- en: 'We can also use the `catch` operator to emit a new value to represent the error
    or for use as a fallback value instead, such as an empty list. In the following
    example, a default string value of `No Movie Fetched` will be used when an exception
    occurs in the Flow that returns the title of the top movie:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE68]'
  prefs: []
  type: TYPE_PRE
- en: '[PRE69]'
  prefs: []
  type: TYPE_PRE
- en: '[PRE70]'
  prefs: []
  type: TYPE_PRE
- en: '[PRE71]'
  prefs: []
  type: TYPE_PRE
- en: '[PRE72]'
  prefs: []
  type: TYPE_PRE
- en: '[PRE73]'
  prefs: []
  type: TYPE_PRE
- en: '[PRE74]'
  prefs: []
  type: TYPE_PRE
- en: '[PRE75]'
  prefs: []
  type: TYPE_PRE
- en: '[PRE76]'
  prefs: []
  type: TYPE_PRE
- en: '[PRE77]'
  prefs: []
  type: TYPE_PRE
- en: '[PRE78]'
  prefs: []
  type: TYPE_PRE
- en: '[PRE79]'
  prefs: []
  type: TYPE_PRE
- en: '[PRE80]'
  prefs: []
  type: TYPE_PRE
- en: In this example, we used the `catch` operator to emit the `No Movie Fetched`
    string when an exception occurs in getting the top movie title from `ViewModel`.
    This will be the value that will be used in the `displayTitle()` call.
  prefs: []
  type: TYPE_NORMAL
- en: As the `catch` operator only handles exceptions in the upstream Flow, an exception
    that happens during the `collect{}` call wonâ€™t be caught. While you can use the
    `try-catch` block to handle these exceptions, you can also move the collection
    code to an `onEach` operator, add the `catch` operator after it, and use `collect()`
    to start the collection.
  prefs: []
  type: TYPE_NORMAL
- en: 'The following example shows how your code can look when using an `onEach` operator
    for the collection of values and the `catch` operator for handling exceptions:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE81]'
  prefs: []
  type: TYPE_PRE
- en: '[PRE82]'
  prefs: []
  type: TYPE_PRE
- en: '[PRE83]'
  prefs: []
  type: TYPE_PRE
- en: '[PRE84]'
  prefs: []
  type: TYPE_PRE
- en: '[PRE85]'
  prefs: []
  type: TYPE_PRE
- en: '[PRE86]'
  prefs: []
  type: TYPE_PRE
- en: '[PRE87]'
  prefs: []
  type: TYPE_PRE
- en: '[PRE88]'
  prefs: []
  type: TYPE_PRE
- en: '[PRE89]'
  prefs: []
  type: TYPE_PRE
- en: '[PRE90]'
  prefs: []
  type: TYPE_PRE
- en: '[PRE91]'
  prefs: []
  type: TYPE_PRE
- en: '[PRE92]'
  prefs: []
  type: TYPE_PRE
- en: '[PRE93]'
  prefs: []
  type: TYPE_PRE
- en: '[PRE94]'
  prefs: []
  type: TYPE_PRE
- en: '[PRE95]'
  prefs: []
  type: TYPE_PRE
- en: Here, the `collect()` function without parameters was used, and the `onEach`
    operator will process each movie from the Flow.
  prefs: []
  type: TYPE_NORMAL
- en: In this section, we learned how to catch exceptions in Flows. In the following
    section, we will focus on Kotlin Flow completion.
  prefs: []
  type: TYPE_NORMAL
- en: Handling Flow completion
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: In this section, we will explore how to handle Flow completion. We can add code
    to perform additional tasks after our Flows have completed.
  prefs: []
  type: TYPE_NORMAL
- en: When the Flow encounters an exception, it will be canceled and complete the
    Flow. A Flow is also completed when the last element of the Flow has been emitted.
  prefs: []
  type: TYPE_NORMAL
- en: 'To add a listener in your Flow when it has completed, you can use the `onCompletion`
    operator and add the code block that will be run when the Flow completes. A common
    usage of `onCompletion` is hiding the **ProgressBar** in your UI when the Flow
    has completed, as shown in the following code:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE96]'
  prefs: []
  type: TYPE_PRE
- en: '[PRE97]'
  prefs: []
  type: TYPE_PRE
- en: '[PRE98]'
  prefs: []
  type: TYPE_PRE
- en: '[PRE99]'
  prefs: []
  type: TYPE_PRE
- en: '[PRE100]'
  prefs: []
  type: TYPE_PRE
- en: '[PRE101]'
  prefs: []
  type: TYPE_PRE
- en: '[PRE102]'
  prefs: []
  type: TYPE_PRE
- en: '[PRE103]'
  prefs: []
  type: TYPE_PRE
- en: '[PRE104]'
  prefs: []
  type: TYPE_PRE
- en: '[PRE105]'
  prefs: []
  type: TYPE_PRE
- en: '[PRE106]'
  prefs: []
  type: TYPE_PRE
- en: '[PRE107]'
  prefs: []
  type: TYPE_PRE
- en: '[PRE108]'
  prefs: []
  type: TYPE_PRE
- en: '[PRE109]'
  prefs: []
  type: TYPE_PRE
- en: '[PRE110]'
  prefs: []
  type: TYPE_PRE
- en: '[PRE111]'
  prefs: []
  type: TYPE_PRE
- en: '[PRE112]'
  prefs: []
  type: TYPE_PRE
- en: '[PRE113]'
  prefs: []
  type: TYPE_PRE
- en: In this example, we have added the `onCompletion` operator to hide `progressBar`
    when the Flow has completed. We have also used `onStart` to display `progressBar`.
  prefs: []
  type: TYPE_NORMAL
- en: The `onStart` operator is the opposite of `onCompletion`. It will be called
    before the Flow starts emitting values. In the previous example, `onStart` was
    used so that before the Flow starts, `progressBar` will be displayed on the screen.
  prefs: []
  type: TYPE_NORMAL
- en: 'Within the code block you add in `onStart` and `onCompletion` (if the Flow
    completed successfully and without exception), you can also emit values, such
    as an initial and final value. In the following example, an `onStart` operator
    is used to emit an initial value to be displayed on the screen:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE114]'
  prefs: []
  type: TYPE_PRE
- en: '[PRE115]'
  prefs: []
  type: TYPE_PRE
- en: '[PRE116]'
  prefs: []
  type: TYPE_PRE
- en: '[PRE117]'
  prefs: []
  type: TYPE_PRE
- en: '[PRE118]'
  prefs: []
  type: TYPE_PRE
- en: '[PRE119]'
  prefs: []
  type: TYPE_PRE
- en: '[PRE120]'
  prefs: []
  type: TYPE_PRE
- en: '[PRE121]'
  prefs: []
  type: TYPE_PRE
- en: '[PRE122]'
  prefs: []
  type: TYPE_PRE
- en: '[PRE123]'
  prefs: []
  type: TYPE_PRE
- en: '[PRE124]'
  prefs: []
  type: TYPE_PRE
- en: '[PRE125]'
  prefs: []
  type: TYPE_PRE
- en: '[PRE126]'
  prefs: []
  type: TYPE_PRE
- en: '[PRE127]'
  prefs: []
  type: TYPE_PRE
- en: Here, `onStart` is used to listen to when the Flow starts. When the Flow starts,
    it will emit a `Loadingâ€¦` string as the initial value of the Flow. This will then
    be the first item that will be displayed on the screen.
  prefs: []
  type: TYPE_NORMAL
- en: The `onCompletion` code block also has a nullable `catch`, the exception itself
    will not be handled, so you still need to use `catch` or `try-catch` to handle
    this exception.
  prefs: []
  type: TYPE_NORMAL
- en: 'The following example shows how we can use this nullable `onCompletion` call:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE128]'
  prefs: []
  type: TYPE_PRE
- en: '[PRE129]'
  prefs: []
  type: TYPE_PRE
- en: '[PRE130]'
  prefs: []
  type: TYPE_PRE
- en: '[PRE131]'
  prefs: []
  type: TYPE_PRE
- en: '[PRE132]'
  prefs: []
  type: TYPE_PRE
- en: '[PRE133]'
  prefs: []
  type: TYPE_PRE
- en: '[PRE134]'
  prefs: []
  type: TYPE_PRE
- en: '[PRE135]'
  prefs: []
  type: TYPE_PRE
- en: '[PRE136]'
  prefs: []
  type: TYPE_PRE
- en: '[PRE137]'
  prefs: []
  type: TYPE_PRE
- en: '[PRE138]'
  prefs: []
  type: TYPE_PRE
- en: '[PRE139]'
  prefs: []
  type: TYPE_PRE
- en: '[PRE140]'
  prefs: []
  type: TYPE_PRE
- en: '[PRE141]'
  prefs: []
  type: TYPE_PRE
- en: '[PRE142]'
  prefs: []
  type: TYPE_PRE
- en: '[PRE143]'
  prefs: []
  type: TYPE_PRE
- en: '[PRE144]'
  prefs: []
  type: TYPE_PRE
- en: In this example, we checked the cause in the `onCompletion` block, and if itâ€™s
    not null (which means an exception was encountered), `displayError` will be called
    and the cause passed to it.
  prefs: []
  type: TYPE_NORMAL
- en: In this section, we learned about `onStart` and `onCompletion` to handle when
    Flows start and when they are completed.
  prefs: []
  type: TYPE_NORMAL
- en: Letâ€™s try what you have learned by adding code to handle exceptions that can
    occur in Flows in an Android project.
  prefs: []
  type: TYPE_NORMAL
- en: Exercise 6.01 â€“ Handling Flow exception in an Android app
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: 'In this exercise, you will be continuing with the movie app you worked on in
    *Exercise 5.01 â€“ Using Kotlin Flow in an Android app*. This application displays
    the movies that are playing now in movie theaters. You will be updating the project
    to handle Flow cancelations and exceptions by following these steps:'
  prefs: []
  type: TYPE_NORMAL
- en: In Android Studio, open the movie app you worked on in *Exercise 5.01 â€“ Using
    Kotlin Flow in an Android app*.
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: 'Go to the `MovieViewModel` class. In the `fetchMovies` function, remove the
    line that sets the value of `_loading` to `true`. Your function will look like
    the following:'
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: '[PRE145]'
  prefs:
  - PREF_IND
  type: TYPE_PRE
- en: You removed the code that sets `loading` to `true` (and displays `ProgressBar`
    on the screen). It will be replaced in the next step with an `onStart` Flow operator.
  prefs: []
  type: TYPE_NORMAL
- en: 'Add an `onStart` operator before the `collect` call, which will set the value
    of `_loading` to `true` when the Flow starts, as shown in the following:'
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: '[PRE146]'
  prefs:
  - PREF_IND
  type: TYPE_PRE
- en: The `onStart` operator will set the value of `_loading` to `true` and display
    `ProgressBar` on the screen when the Flow starts.
  prefs: []
  type: TYPE_NORMAL
- en: 'Next, remove the line that sets the value of `_loading` to `false` in the code
    block inside the `collect` call. Your function will look like the following:'
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: '[PRE147]'
  prefs:
  - PREF_IND
  type: TYPE_PRE
- en: You removed the code that sets the value of `_loading` to `false` and hides
    `ProgressBar` on the screen when the Flow is collected.
  prefs: []
  type: TYPE_NORMAL
- en: 'Add an `onCompletion` operator before the `collect` call, which will set the
    value of `_loading` to `false` when the Flow has completed, as shown in the following:'
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: '[PRE148]'
  prefs:
  - PREF_IND
  type: TYPE_PRE
- en: The `onCompletion` Flow operator will set the value of `_loading` to `false`.
    This will then hide, upon completion of the Flow, `ProgressBar`, which is displayed
    on the screen while the movies are being fetched.
  prefs: []
  type: TYPE_NORMAL
- en: 'Add a `catch` operator before the `collect` function to handle the case when
    the Flow has encountered an exception:'
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: '[PRE149]'
  prefs:
  - PREF_IND
  type: TYPE_PRE
- en: This will set a string containing `An exception occurred:` and the exception
    message as the value of the `_error` LiveData. This `_error` LiveData will display
    an error message in `MainActivity`.
  prefs: []
  type: TYPE_NORMAL
- en: 'On your device or emulator, turn off the Wi-Fi and mobile data. Then, run the
    app. This will cause an error in fetching the movies, as there is no internet
    connection. The app will display a `SnackBar` message, as shown in the following
    screenshot:'
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: '![Figure 6.1 â€“ The error message displayed in the movie app'
  prefs: []
  type: TYPE_NORMAL
- en: '](img/Figure_6.1_B17773_new.jpg)'
  prefs: []
  type: TYPE_NORMAL
- en: Figure 6.1 â€“ The error message displayed in the movie app
  prefs: []
  type: TYPE_NORMAL
- en: 'Close the application and turn on the Wi-Fi and/or mobile data on your device
    or emulator. Run the application again. The app should show `ProgressBar`, display
    a list of movies (with the movie title and poster) on the screen, and hide `ProgressBar`,
    as shown in the following screenshot:'
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: '![Figure 6.2 â€“ The movie app with the list of movies'
  prefs: []
  type: TYPE_NORMAL
- en: '](img/Figure_6.2_B17773.jpg)'
  prefs: []
  type: TYPE_NORMAL
- en: Figure 6.2 â€“ The movie app with the list of movies
  prefs: []
  type: TYPE_NORMAL
- en: In this exercise, you have updated the application so that it can handle exceptions
    in the Flow instead of crashing.
  prefs: []
  type: TYPE_NORMAL
- en: Summary
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: This chapter focused on Kotlin Flow cancelations. You learned that Flows follow
    the cooperative cancellation of coroutines. The `flow{}` builder and `StateFlow`
    and `SharedFlow` implementations are cancellable by default. You can use the `cancellable`
    operator to make other Flows cancellable.
  prefs: []
  type: TYPE_NORMAL
- en: We then learned about retrying tasks with Kotlin Flow. You can use the `retry`
    and `retryWhen` functions to retry the Flow based on the number of attempts and
    the exception encountered by the Flow.
  prefs: []
  type: TYPE_NORMAL
- en: Then, we learned about handling exceptions that can happen during the emission
    or collection of data in a Flow. You can use the `try-catch` block or the `catch`
    Flow operator to handle Flow exceptions.
  prefs: []
  type: TYPE_NORMAL
- en: We learned how to handle Flow completion. With the `onStart` and `onCompletion`
    operators, you can listen and run code when Flows start and when they have finished.
    You can also emit values with the `onStart` and `onCompletion` code blocks, such
    as when you want to set an initial and final value for the Flow.
  prefs: []
  type: TYPE_NORMAL
- en: Finally, we worked on an exercise to update our Android project and handle the
    exceptions that can be encountered in a Flow. We used the `catch` Flow operator
    to handle exceptions in the project.
  prefs: []
  type: TYPE_NORMAL
- en: In the next chapter, we will dive into creating and running tests for the Kotlin
    Flows in our Android projects.
  prefs: []
  type: TYPE_NORMAL
