<html><head></head><body>
<div id="_idContainer115" class="calibre2">
<h1 class="chapter-number" id="_idParaDest-100"><a id="_idTextAnchor112" class="calibre3 pcalibre pcalibre1"/><span class="kobospan" id="kobo.1.1">9</span></h1>
<h1 id="_idParaDest-101" class="calibre6"><a id="_idTextAnchor113" class="calibre3 pcalibre pcalibre1"/><span class="kobospan" id="kobo.2.1">Runtime Permissions</span></h1>
<p class="calibre4"><span class="kobospan" id="kobo.3.1">As we build our Android apps, there are some functionalities that require permissions to be granted for them to function properly. </span><span class="kobospan" id="kobo.3.2">Due to privacy and data security policies, we as developers can not automatically grant permissions to the apps that we develop. </span><span class="kobospan" id="kobo.3.3">We need to inform the users of the permissions that the apps need and why they </span><span><span class="kobospan" id="kobo.4.1">need them.</span></span></p>
<p class="calibre4"><span class="kobospan" id="kobo.5.1">In this chapter, we will understand runtime permissions and how to request them in </span><span><span class="kobospan" id="kobo.6.1">our app.</span></span></p>
<p class="calibre4"><span class="kobospan" id="kobo.7.1">In this chapter, we’re going to cover the following </span><span><span class="kobospan" id="kobo.8.1">main topics:</span></span></p>
<ul class="calibre16">
<li class="calibre15"><span class="kobospan" id="kobo.9.1">Understanding </span><span><span class="kobospan" id="kobo.10.1">runtime permissions</span></span></li>
<li class="calibre15"><span class="kobospan" id="kobo.11.1">Requesting permissions </span><span><span class="kobospan" id="kobo.12.1">at runtime</span></span></li>
</ul>
<h1 id="_idParaDest-102" class="calibre6"><a id="_idTextAnchor114" class="calibre3 pcalibre pcalibre1"/><span class="kobospan" id="kobo.13.1">Technical requirements</span></h1>
<p class="calibre4"><span class="kobospan" id="kobo.14.1">To follow the instructions in this chapter, you will need to have Android Studio Hedgehog or later (</span><a href="https://developer.android.com/studio" class="calibre3 pcalibre pcalibre1"><span><span class="kobospan" id="kobo.15.1">https://developer.android.com/studio</span></span></a><span><span class="kobospan" id="kobo.16.1">) downloaded.</span></span></p>
<p class="calibre4"><span class="kobospan" id="kobo.17.1">You can use the previous chapter’s code to follow the instructions in this chapter. </span><span class="kobospan" id="kobo.17.2">You can find the code for this chapter </span><span><span class="kobospan" id="kobo.18.1">at </span></span><a href="https://github.com/PacktPublishing/Mastering-Kotlin-for-Android/tree/main/chapternine" class="calibre3 pcalibre pcalibre1"><span><span class="kobospan" id="kobo.19.1">https://github.com/PacktPublishing/Mastering-Kotlin-for-Android/tree/main/chapternine</span></span></a><span><span class="kobospan" id="kobo.20.1">.</span></span></p>
<h1 id="_idParaDest-103" class="calibre6"><a id="_idTextAnchor115" class="calibre3 pcalibre pcalibre1"/><span class="kobospan" id="kobo.21.1">Understanding runtime permissions</span></h1>
<p class="calibre4"><strong class="bold"><span class="kobospan" id="kobo.22.1">Runtime permissions</span></strong><span class="kobospan" id="kobo.23.1"> are permissions</span><a id="_idIndexMarker461" class="calibre3 pcalibre pcalibre1"/><span class="kobospan" id="kobo.24.1"> that are requested at runtime by an app. </span><span class="kobospan" id="kobo.24.2">They are also called </span><strong class="bold"><span class="kobospan" id="kobo.25.1">dangerous permissions</span></strong><span class="kobospan" id="kobo.26.1">. </span><span class="kobospan" id="kobo.26.2">The user can grant or deny each permission, and </span><a id="_idIndexMarker462" class="calibre3 pcalibre pcalibre1"/><span class="kobospan" id="kobo.27.1">the app can continue to run with limited capabilities even if the user denies a permission request. </span><span class="kobospan" id="kobo.27.2">Android provides several methods you can use to request permission, such as </span><strong class="source-inline"><span class="kobospan" id="kobo.28.1">requestPermissions()</span></strong><span class="kobospan" id="kobo.29.1"> and </span><strong class="source-inline"><span class="kobospan" id="kobo.30.1">checkSelfPermission()</span></strong><span class="kobospan" id="kobo.31.1">. </span><span class="kobospan" id="kobo.31.2">The user only needs to grant permission once during the lifetime of </span><span><span class="kobospan" id="kobo.32.1">the app.</span></span></p>
<p class="calibre4"><span class="kobospan" id="kobo.33.1">Some of the features that need permission to be granted to work are camera, location, microphone and storage. </span><span class="kobospan" id="kobo.33.2">Before using them, ensure that a user has permission to use them. </span><span class="kobospan" id="kobo.33.3">If the user has not granted permission, you must request it from them. </span><span class="kobospan" id="kobo.33.4">If the user has denied the permission, you must show a dialog explaining why you need it and ask the user to grant it from the settings. </span><span class="kobospan" id="kobo.33.5">If the user has granted permission, you can use the feature. </span><span class="kobospan" id="kobo.33.6">Failing to do these checks often results in an app crashing or a feature not working. </span><span class="kobospan" id="kobo.33.7">If your app targets </span><a id="_idIndexMarker463" class="calibre3 pcalibre pcalibre1"/><span class="kobospan" id="kobo.34.1">Android 6.0 and above, you must request these permissions at runtime, and the user must grant the permission for the app </span><span><span class="kobospan" id="kobo.35.1">to work.</span></span></p>
<p class="calibre4"><span class="kobospan" id="kobo.36.1">The flow for requesting</span><a id="_idIndexMarker464" class="calibre3 pcalibre pcalibre1"/><span class="kobospan" id="kobo.37.1"> permissions is shown in the </span><span><span class="kobospan" id="kobo.38.1">following chart:</span></span></p>
<div class="calibre2">
<div class="img---figure" id="_idContainer110">
<span class="kobospan" id="kobo.39.1"><img alt="Figure 9.1 – The runtime permissions flow" src="image/B19779_09_01.jpg" class="calibre5"/></span>
</div>
</div>
<p class="img---caption" lang="en-US" xml:lang="en-US"><span class="kobospan" id="kobo.40.1">Figure 9.1 – The runtime permissions flow</span></p>
<p class="calibre4"><span class="kobospan" id="kobo.41.1">As shown in the preceding diagram, this is </span><span><span class="kobospan" id="kobo.42.1">the flow:</span></span></p>
<ol class="calibre14">
<li class="calibre15"><span class="kobospan" id="kobo.43.1">The initial step is to </span><em class="italic"><span class="kobospan" id="kobo.44.1">declare</span></em><span class="kobospan" id="kobo.45.1"> the permission in the manifest file. </span><span class="kobospan" id="kobo.45.2">This is done by adding the permission to the </span><span><span class="kobospan" id="kobo.46.1">manifest file.</span></span></li>
<li class="calibre15"><span class="kobospan" id="kobo.47.1">After adding the permission to the manifest file, we must </span><em class="italic"><span class="kobospan" id="kobo.48.1">design the UX</span></em><span class="kobospan" id="kobo.49.1"> for the feature that needs </span><a id="_idIndexMarker465" class="calibre3 pcalibre pcalibre1"/><span class="kobospan" id="kobo.50.1">the permission to </span><span><span class="kobospan" id="kobo.51.1">be granted.</span></span></li>
<li class="calibre15"><span class="kobospan" id="kobo.52.1">The next step is </span><em class="italic"><span class="kobospan" id="kobo.53.1">waiting for the user to use</span></em><span class="kobospan" id="kobo.54.1"> the feature that needs permission to be granted. </span><span class="kobospan" id="kobo.54.2">At this point, we check whether the user has granted permission. </span><span class="kobospan" id="kobo.54.3">If the user has granted permission, we proceed to use </span><span><span class="kobospan" id="kobo.55.1">the feature.</span></span></li>
<li class="calibre15"><span class="kobospan" id="kobo.56.1">If the user </span><em class="italic"><span class="kobospan" id="kobo.57.1">has not granted permission</span></em><span class="kobospan" id="kobo.58.1">, we first check whether we need to </span><em class="italic"><span class="kobospan" id="kobo.59.1">show a rationale</span></em><span class="kobospan" id="kobo.60.1"> that explains why we need permission. </span><span class="kobospan" id="kobo.60.2">If we need to show the rationale, we show it with explanations and then request permission from the user. </span><span class="kobospan" id="kobo.60.3">If we do not need to show the rationale, we just request permission from </span><span><span class="kobospan" id="kobo.61.1">the user.</span></span></li>
<li class="calibre15"><span class="kobospan" id="kobo.62.1">Once the permission is requested, we wait for the </span><em class="italic"><span class="kobospan" id="kobo.63.1">user to grant or deny</span></em><span class="kobospan" id="kobo.64.1"> permission. </span><span class="kobospan" id="kobo.64.2">If the user grants permission, we proceed to use the feature. </span><span class="kobospan" id="kobo.64.3">If the user denies permission, we allow the app to work, but the user cannot use the feature that needs permission </span><span><span class="kobospan" id="kobo.65.1">to work.</span></span></li>
</ol>
<p class="calibre4"><span class="kobospan" id="kobo.66.1">With this flow in mind, let us look at how to implement it in code. </span><span class="kobospan" id="kobo.66.2">We are going to request permission to access </span><span><span class="kobospan" id="kobo.67.1">a location.</span></span></p>
<h1 id="_idParaDest-104" class="calibre6"><a id="_idTextAnchor116" class="calibre3 pcalibre pcalibre1"/><span class="kobospan" id="kobo.68.1">Requesting permissions at runtime</span></h1>
<p class="calibre4"><span class="kobospan" id="kobo.69.1">We will follow the</span><a id="_idIndexMarker466" class="calibre3 pcalibre pcalibre1"/><span class="kobospan" id="kobo.70.1"> steps covered in </span><span><em class="italic"><span class="kobospan" id="kobo.71.1">Figure 9</span></em></span><em class="italic"><span class="kobospan" id="kobo.72.1">.1</span></em><span class="kobospan" id="kobo.73.1"> to request runtime permissions for </span><span><span class="kobospan" id="kobo.74.1">our app:</span></span></p>
<ol class="calibre14">
<li class="calibre15"><span class="kobospan" id="kobo.75.1">Let us start by adding the permission to the manifest file. </span><span class="kobospan" id="kobo.75.2">We will request permission to access the user’s location. </span><span class="kobospan" id="kobo.75.3">To do this, we add the following permission to the </span><span><span class="kobospan" id="kobo.76.1">manifest file:</span></span><pre class="source-code"><span class="kobospan1" id="kobo.77.1">
&lt;uses-permission android:name="android.permission.ACCESS_COARSE_LOCATION" /&gt;</span></pre><p class="calibre4"><span class="kobospan" id="kobo.78.1">This specifies that our app will be using the </span><strong class="source-inline"><span class="kobospan" id="kobo.79.1">ACCESS_COARSE_LOCATION</span></strong><span class="kobospan" id="kobo.80.1"> permission. </span><span class="kobospan" id="kobo.80.2">Declaring permissions in the manifests is crucial for enhancing security, user awareness, and overall app compatibility. </span><span class="kobospan" id="kobo.80.3">By explicitly specifying the actions or resources apps require access to permissions informs users during installations, allowing them to make informed decisions about granting or denying access. </span><span class="kobospan" id="kobo.80.4">This declaration ensures compatibility across different Android versions and devices, facilitates inter-app communication, and supports intent filtering to control </span><a id="_idIndexMarker467" class="calibre3 pcalibre pcalibre1"/><span class="kobospan" id="kobo.81.1">component access. </span><span class="kobospan" id="kobo.81.2">Permissions also play a role in runtime permission requests for dangerous permissions and help maintain platform compatibility. </span><span class="kobospan" id="kobo.81.3">Additionally, Play Store reviews declare permissions as part of the submission process, contributing to adherence to policies and guidelines. </span><span class="kobospan" id="kobo.81.4">In essence, manifest-based permission declarations are fundamental for creating secure, transparent, and user-controlled environments in </span><span><span class="kobospan" id="kobo.82.1">our apps.</span></span></p><p class="calibre4"><span class="kobospan" id="kobo.83.1">The next thing is to create the UX for the feature that needs permission. </span><span class="kobospan" id="kobo.83.2">We will create a dialog to request permissions from the user. </span><span class="kobospan" id="kobo.83.3">It will also have the logic that shows the rationale to the user if permission was </span><span><span class="kobospan" id="kobo.84.1">previously denied.</span></span></p></li> <li class="calibre15"><span class="kobospan" id="kobo.85.1">Let’s create a new file in the </span><strong class="source-inline1"><span class="kobospan" id="kobo.86.1">view</span></strong><span class="kobospan" id="kobo.87.1"> package named </span><strong class="source-inline1"><span class="kobospan" id="kobo.88.1">PermissionDialog.kt</span></strong><span class="kobospan" id="kobo.89.1"> and add the utility functions to </span><span><span class="kobospan" id="kobo.90.1">the file:</span></span><pre class="source-code"><span class="kobospan1" id="kobo.91.1">
fun checkIfPermissionGranted(context: Context, permission: String): Boolean {
    return (ContextCompat.checkSelfPermission(context, permission)
            == PackageManager.PERMISSION_GRANTED)
}
fun shouldShowPermissionRationale(context: Context, permission: String): Boolean {
    val activity = context as Activity?
</span><span class="kobospan1" id="kobo.91.2">    if (activity == null)
        Log.d("Permissions", "Activity is null")
    return ActivityCompat.shouldShowRequestPermissionRationale(
        activity!!,
        permission
    )
}</span></pre><p class="calibre4"><span class="kobospan" id="kobo.92.1">The first function checks whether the permission has been granted using the </span><strong class="source-inline"><span class="kobospan" id="kobo.93.1">ContextCompat.checkSelfPermission()</span></strong><span class="kobospan" id="kobo.94.1"> function. </span><span class="kobospan" id="kobo.94.2">The second function checks whether </span><a id="_idIndexMarker468" class="calibre3 pcalibre pcalibre1"/><span class="kobospan" id="kobo.95.1">we need to show the rationale to the user. </span><span class="kobospan" id="kobo.95.2">This is done using the </span><strong class="source-inline"><span class="kobospan" id="kobo.96.1">ActivityCompat.shouldShowRequestPermissionRationale()</span></strong><span class="kobospan" id="kobo.97.1"> function. </span><span class="kobospan" id="kobo.97.2">This function returns </span><strong class="source-inline"><span class="kobospan" id="kobo.98.1">true</span></strong><span class="kobospan" id="kobo.99.1"> if the app has requested this permission previously and the user denied the request. </span><span class="kobospan" id="kobo.99.2">If the user turned down the permission request in the past and chose the </span><strong class="bold"><span class="kobospan" id="kobo.100.1">Don’t ask again</span></strong><span class="kobospan" id="kobo.101.1"> option in the permission request system dialog, this method </span><span><span class="kobospan" id="kobo.102.1">returns </span></span><span><strong class="source-inline"><span class="kobospan" id="kobo.103.1">false</span></strong></span><span><span class="kobospan" id="kobo.104.1">.</span></span></p><p class="calibre4"><span class="kobospan" id="kobo.105.1">Next, let us create a sealed class that will be used to represent the state of the </span><span><span class="kobospan" id="kobo.106.1">permission request.</span></span></p></li> <li class="calibre15"><span class="kobospan" id="kobo.107.1">Create a new file named </span><strong class="source-inline1"><span class="kobospan" id="kobo.108.1">PermissionAction.kt</span></strong><span class="kobospan" id="kobo.109.1"> in the </span><strong class="source-inline1"><span class="kobospan" id="kobo.110.1">data</span></strong><span class="kobospan" id="kobo.111.1"> package, and add the following code to </span><span><span class="kobospan" id="kobo.112.1">the file:</span></span><pre class="source-code"><span class="kobospan1" id="kobo.113.1">
sealed class PermissionAction {
    data object PermissionGranted : PermissionAction()
    data object PermissionDenied : PermissionAction()
}</span></pre><p class="calibre4"><span class="kobospan" id="kobo.114.1">The class has two states, </span><strong class="source-inline"><span class="kobospan" id="kobo.115.1">PermissionGranted</span></strong><span class="kobospan" id="kobo.116.1"> and </span><strong class="source-inline"><span class="kobospan" id="kobo.117.1">PermissionDenied</span></strong><span class="kobospan" id="kobo.118.1">. </span><span class="kobospan" id="kobo.118.2">A user can either grant or </span><span><span class="kobospan" id="kobo.119.1">deny permission.</span></span></p></li> <li class="calibre15"><span class="kobospan" id="kobo.120.1">Next, let us create </span><a id="_idIndexMarker469" class="calibre3 pcalibre pcalibre1"/><span class="kobospan" id="kobo.121.1">the dialog that will be used to request permission from the user. </span><span class="kobospan" id="kobo.121.2">Head back to the </span><strong class="source-inline1"><span class="kobospan" id="kobo.122.1">PermissionDialog.kt</span></strong><span class="kobospan" id="kobo.123.1"> file and add the following code to </span><span><span class="kobospan" id="kobo.124.1">the file:</span></span><pre class="source-code"><span class="kobospan1" id="kobo.125.1">
@Composable
fun PermissionDialog(
    context: Context,
    permission: String,
    permissionAction: (PermissionAction) -&gt; Unit
) {
    val isPermissionGranted = checkIfPermissionGranted(context, permission)
    if (isPermissionGranted) {
        permissionAction(PermissionAction.PermissionGranted)
        return
    }
    val permissionsLauncher = rememberLauncherForActivityResult(
        ActivityResultContracts.RequestPermission()
    ) { isGranted: Boolean -&gt;
        if (isGranted) {
            permissionAction(PermissionAction.PermissionGranted)
        } else {
            permissionAction(PermissionAction.PermissionDenied)
        }
    }
    val showPermissionRationale = shouldShowPermissionRationale(context, permission)
    var isDialogDismissed by remember { mutableStateOf(false) }
    var isPristine by remember { mutableStateOf(true) }
    if ((showPermissionRationale &amp;&amp; !isDialogDismissed) || (!isDialogDismissed &amp;&amp; !isPristine)) {
        isPristine = false
        AlertDialog(
            onDismissRequest = {
                isDialogDismissed = true
                permissionAction(PermissionAction.PermissionDenied)
            },
            title = { Text(text = "Permission Required") },
            text = { Text(text = "This app requires the location permission to be granted.") },
            confirmButton = {
                Button(
                    onClick = {
                        isDialogDismissed = true
                        permissionsLauncher.launch(permission)
                    }
                ) {
                    Text(text = "Grant Access")
                }
            },
            dismissButton = {
                Button(
                    onClick = {
                        isDialogDismissed = true
                        permissionAction(PermissionAction.PermissionDenied)
                    }
                ) {
                    Text(text = "Cancel")
                }
            }
        )
    } else {
        if (!isDialogDismissed) {
            SideEffect {
                permissionsLauncher.launch(permission)
            }
        }
    }
}</span></pre><p class="calibre4"><span class="kobospan" id="kobo.126.1">Let’s break down the </span><span><span class="kobospan" id="kobo.127.1">preceding code:</span></span></p><ul class="calibre17"><li class="calibre15"><span class="kobospan" id="kobo.128.1">We have created a composable, </span><strong class="source-inline1"><span class="kobospan" id="kobo.129.1">PermissionDialog</span></strong><span class="kobospan" id="kobo.130.1">, which takes three parameters, </span><strong class="source-inline1"><span class="kobospan" id="kobo.131.1">context</span></strong><span class="kobospan" id="kobo.132.1">, </span><strong class="source-inline1"><span class="kobospan" id="kobo.133.1">permission</span></strong><span class="kobospan" id="kobo.134.1"> string, and a </span><strong class="source-inline1"><span class="kobospan" id="kobo.135.1">permissionAction</span></strong><span class="kobospan" id="kobo.136.1"> callback, which passed the option the user selected to the </span><span><span class="kobospan" id="kobo.137.1">call site.</span></span></li><li class="calibre15"><span class="kobospan" id="kobo.138.1">Inside the </span><a id="_idIndexMarker470" class="calibre3 pcalibre pcalibre1"/><span class="kobospan" id="kobo.139.1">composable, the first thing we do is check whether permission has been granted. </span><span class="kobospan" id="kobo.139.2">If permission has been granted, we call the </span><strong class="source-inline1"><span class="kobospan" id="kobo.140.1">permissionAction</span></strong><span class="kobospan" id="kobo.141.1"> callback with the </span><strong class="source-inline1"><span class="kobospan" id="kobo.142.1">PermissionGranted</span></strong><span class="kobospan" id="kobo.143.1"> state </span><span><span class="kobospan" id="kobo.144.1">and return.</span></span></li><li class="calibre15"><span class="kobospan" id="kobo.145.1">Next, we also created </span><strong class="source-inline1"><span class="kobospan" id="kobo.146.1">permissionsLauncher</span></strong><span class="kobospan" id="kobo.147.1">, which is used to request permission from the user. </span><span class="kobospan" id="kobo.147.2">We use the </span><strong class="source-inline1"><span class="kobospan" id="kobo.148.1">rememberLauncherForActivityResult()</span></strong><span class="kobospan" id="kobo.149.1"> function to create a launcher for the contract. </span><span class="kobospan" id="kobo.149.2">We then use the launcher to request permission from the user. </span><span class="kobospan" id="kobo.149.3">If the user grants the permission, we call the </span><strong class="source-inline1"><span class="kobospan" id="kobo.150.1">permissionAction</span></strong><span class="kobospan" id="kobo.151.1"> callback with the </span><strong class="source-inline1"><span class="kobospan" id="kobo.152.1">PermissionGranted</span></strong><span class="kobospan" id="kobo.153.1"> state. </span><span class="kobospan" id="kobo.153.2">If the user denies the permission, we call the </span><strong class="source-inline1"><span class="kobospan" id="kobo.154.1">permissionAction</span></strong><span class="kobospan" id="kobo.155.1"> callback with the </span><span><strong class="source-inline1"><span class="kobospan" id="kobo.156.1">PermissionDenied</span></strong></span><span><span class="kobospan" id="kobo.157.1"> state.</span></span></li><li class="calibre15"><span class="kobospan" id="kobo.158.1">If the permission has not been granted, we check whether we need to show the rationale to the user. </span><span class="kobospan" id="kobo.158.2">If we need to, we show the rationale with explanations and then request permission from the user. </span><span class="kobospan" id="kobo.158.3">If we do not need to show the rationale, we must request permission from the user. </span><span class="kobospan" id="kobo.158.4">In our case, the rationale is </span><strong class="source-inline1"><span class="kobospan" id="kobo.159.1">AlertDialog</span></strong><span class="kobospan" id="kobo.160.1">, with two action items and a message explaining why we need the permission. </span><span class="kobospan" id="kobo.160.2">The first action item is used to request permission from the user. </span><span class="kobospan" id="kobo.160.3">The second action item is used to cancel the permission request. </span><span class="kobospan" id="kobo.160.4">If we tap the </span><strong class="bold"><span class="kobospan" id="kobo.161.1">Grant Access</span></strong><span class="kobospan" id="kobo.162.1"> option, we launch the permission request once again, and a dialog will pop up again, asking them to allow permission. </span><span class="kobospan" id="kobo.162.2">If we tap </span><strong class="bold"><span class="kobospan" id="kobo.163.1">Cancel</span></strong><span class="kobospan" id="kobo.164.1">, the </span><strong class="source-inline1"><span class="kobospan" id="kobo.165.1">permissionAction</span></strong><span class="kobospan" id="kobo.166.1"> callback is called with the </span><strong class="source-inline1"><span class="kobospan" id="kobo.167.1">PermissionDenied</span></strong><span class="kobospan" id="kobo.168.1"> state, and the dialog is dismissed. </span><span class="kobospan" id="kobo.168.2">We also have two mutable states, </span><strong class="source-inline1"><span class="kobospan" id="kobo.169.1">isDialogDismissed</span></strong><span class="kobospan" id="kobo.170.1"> and </span><strong class="source-inline1"><span class="kobospan" id="kobo.171.1">isPristine</span></strong><span class="kobospan" id="kobo.172.1">. </span><span class="kobospan" id="kobo.172.2">The first is used to check whether the dialog has been dismissed. </span><span class="kobospan" id="kobo.172.3">The second one let’s know whether the dialog was shown before. </span><span class="kobospan" id="kobo.172.4">We use these states combined to know whether to show the dialog </span><span><span class="kobospan" id="kobo.173.1">or not.</span></span></li><li class="calibre15"><span class="kobospan" id="kobo.174.1">Lastly, if we do not need to show the rationale, we just request permission from the user. </span><span class="kobospan" id="kobo.174.2">We</span><a id="_idIndexMarker471" class="calibre3 pcalibre pcalibre1"/><span class="kobospan" id="kobo.175.1"> use </span><strong class="source-inline1"><span class="kobospan" id="kobo.176.1">SideEffect</span></strong><span class="kobospan" id="kobo.177.1"> to request permission from the user because we want to request permission from the user as soon as the dialog </span><span><span class="kobospan" id="kobo.178.1">is shown.</span></span></li></ul><p class="calibre4"><span class="kobospan" id="kobo.179.1">Since we do not have an actual feature in our app currently that uses location, we are going to simulate permission flow with our </span><span><strong class="source-inline"><span class="kobospan" id="kobo.180.1">PetsScreen</span></strong></span><span><span class="kobospan" id="kobo.181.1"> composable.</span></span></p></li> <li class="calibre15"><span class="kobospan" id="kobo.182.1">Let’s head to the </span><strong class="source-inline1"><span class="kobospan" id="kobo.183.1">PetsScreen.kt</span></strong><span class="kobospan" id="kobo.184.1"> file and modify it to </span><span><span class="kobospan" id="kobo.185.1">the following:</span></span><pre class="source-code"><span class="kobospan1" id="kobo.186.1">
@Composable
fun PetsScreen(
    onPetClicked: (Cat) -&gt; Unit,
    contentType: ContentType,
) {
    val petsViewModel: PetsViewModel = koinViewModel()
    val petsUIState by petsViewModel.petsUIState.collectAsStateWithLifecycle()
    val context = LocalContext.current
    var showContent by rememberSaveable { mutableStateOf(false) }
    PermissionDialog(
        context = context,
        permission = Manifest.permission.ACCESS_COARSE_LOCATION
    ) { permissionAction -&gt;
        when (permissionAction) {
            is PermissionAction.PermissionDenied -&gt; {
                showContent = false
            }
            is PermissionAction.PermissionGranted -&gt; {
                showContent = true
                Toast.makeText(
                    context,
                    "Location permission granted!",
                    Toast.LENGTH_SHORT
                ).show()
            }
        }
    }
    if (showContent) {
        PetsScreenContent(
            modifier = Modifier
                .fillMaxSize(),
            onPetClicked = onPetClicked,
            contentType = contentType,
            petsUIState = petsUIState,
            onFavoriteClicked = {
                petsViewModel.updatePet(it)
            }
        )
    }
}</span></pre><p class="calibre4"><span class="kobospan" id="kobo.187.1">We have only made a few changes to </span><span><span class="kobospan" id="kobo.188.1">this file:</span></span></p><ul class="calibre17"><li class="calibre15"><span class="kobospan" id="kobo.189.1">First, we have added a </span><strong class="source-inline1"><span class="kobospan" id="kobo.190.1">showContent</span></strong><span class="kobospan" id="kobo.191.1"> mutable state that is used to check whether we should show the content of the screen. </span><span class="kobospan" id="kobo.191.2">We have also set the initial value of the state to </span><strong class="source-inline1"><span class="kobospan" id="kobo.192.1">false</span></strong><span class="kobospan" id="kobo.193.1">. </span><span class="kobospan" id="kobo.193.2">We will use this state to show the content of the screen if</span><a id="_idIndexMarker472" class="calibre3 pcalibre pcalibre1"/><span class="kobospan" id="kobo.194.1"> the user grants permission. </span><span class="kobospan" id="kobo.194.2">We also have the </span><strong class="source-inline1"><span class="kobospan" id="kobo.195.1">context</span></strong><span class="kobospan" id="kobo.196.1"> variable used to get the </span><span><span class="kobospan" id="kobo.197.1">screen’s context.</span></span></li><li class="calibre15"><span class="kobospan" id="kobo.198.1">We have also added the </span><strong class="source-inline1"><span class="kobospan" id="kobo.199.1">PermissionDialog</span></strong><span class="kobospan" id="kobo.200.1"> composable to the </span><strong class="source-inline1"><span class="kobospan" id="kobo.201.1">PetsScreen</span></strong><span class="kobospan" id="kobo.202.1"> composable. </span><span class="kobospan" id="kobo.202.2">We have passed the context and the permission – in this case, the </span><strong class="source-inline1"><span class="kobospan" id="kobo.203.1">ACCESS_COARSE_LOCATION</span></strong><span class="kobospan" id="kobo.204.1"> permission – to the composable. </span><span class="kobospan" id="kobo.204.2">We have also passed a callback to the composable that is used to get the state of the permission request. </span><span class="kobospan" id="kobo.204.3">If the user grants the permission, we set the </span><strong class="source-inline1"><span class="kobospan" id="kobo.205.1">showContent</span></strong><span class="kobospan" id="kobo.206.1"> state to </span><strong class="source-inline1"><span class="kobospan" id="kobo.207.1">true</span></strong><span class="kobospan" id="kobo.208.1"> and show a toast with the </span><strong class="bold"><span class="kobospan" id="kobo.209.1">Location permission granted</span></strong><span class="kobospan" id="kobo.210.1"> message. </span><span class="kobospan" id="kobo.210.2">If the user denies the permission, we set the </span><strong class="source-inline1"><span class="kobospan" id="kobo.211.1">showContent</span></strong><span class="kobospan" id="kobo.212.1"> state </span><span><span class="kobospan" id="kobo.213.1">to </span></span><span><strong class="source-inline1"><span class="kobospan" id="kobo.214.1">false</span></strong></span><span><span class="kobospan" id="kobo.215.1">.</span></span></li><li class="calibre15"><span class="kobospan" id="kobo.216.1">Lastly, we have added a check to see whether the </span><strong class="source-inline1"><span class="kobospan" id="kobo.217.1">showContent</span></strong><span class="kobospan" id="kobo.218.1"> state is </span><strong class="source-inline1"><span class="kobospan" id="kobo.219.1">true</span></strong><span class="kobospan" id="kobo.220.1">. </span><span class="kobospan" id="kobo.220.2">If the state is </span><strong class="source-inline1"><span class="kobospan" id="kobo.221.1">true</span></strong><span class="kobospan" id="kobo.222.1">, we show the content of the screen. </span><span class="kobospan" id="kobo.222.2">If the state is </span><strong class="source-inline1"><span class="kobospan" id="kobo.223.1">false</span></strong><span class="kobospan" id="kobo.224.1">, we do not show the content of </span><span><span class="kobospan" id="kobo.225.1">the screen.</span></span></li></ul></li> <li class="calibre15"><span class="kobospan" id="kobo.226.1">Build and run the app. </span><span class="kobospan" id="kobo.226.2">At first, we</span><a id="_idIndexMarker473" class="calibre3 pcalibre pcalibre1"/><span class="kobospan" id="kobo.227.1"> will see the permission dialog, as shown in the </span><span><span class="kobospan" id="kobo.228.1">following screenshot:</span></span></li>
</ol>
<div class="calibre2">
<div class="img---figure" id="_idContainer111">
<span class="kobospan" id="kobo.229.1"><img alt="Figure 9.2 – The permission dial﻿og" src="image/B19779_09_02.jpg" class="calibre5"/></span>
</div>
</div>
<p class="img---caption" lang="en-US" xml:lang="en-US"><span class="kobospan" id="kobo.230.1">Figure 9.2 – The permission dial</span><a id="_idTextAnchor117" class="calibre3 pcalibre pcalibre1"/><span class="kobospan" id="kobo.231.1">og</span></p>
<ol class="calibre14">
<li value="7" class="calibre15"><span class="kobospan" id="kobo.232.1">Tap the </span><strong class="bold"><span class="kobospan" id="kobo.233.1">Don’t allow</span></strong><span class="kobospan" id="kobo.234.1"> option, which will show an empty white screen, since we don’t show any content when the user has not granted the </span><span><span class="kobospan" id="kobo.235.1">app permission.</span></span></li>
</ol>
<div class="calibre2">
<div class="img---figure" id="_idContainer112">
<span class="kobospan" id="kobo.236.1"><img alt="Figure 9.3 – The no permission screen" src="image/B19779_09_03.jpg" class="calibre5"/></span>
</div>
</div>
<p class="img---caption" lang="en-US" xml:lang="en-US"><span class="kobospan" id="kobo.237.1">Figure 9.3 – The no permission screen</span></p>
<p class="calibre4"><span class="kobospan" id="kobo.238.1">The next time we run the</span><a id="_idIndexMarker474" class="calibre3 pcalibre pcalibre1"/><span class="kobospan" id="kobo.239.1"> app, we will see the rationale dialog showing why the app </span><span><span class="kobospan" id="kobo.240.1">needs permission.</span></span></p>
<div class="calibre2">
<div class="img---figure" id="_idContainer113">
<span class="kobospan" id="kobo.241.1"><img alt="Figure 9.4 – The permission rationale" src="image/B19779_09_04.jpg" class="calibre5"/></span>
</div>
</div>
<p class="img---caption" lang="en-US" xml:lang="en-US"><span class="kobospan" id="kobo.242.1">Figure 9.4 – The permission rationale</span></p>
<p class="calibre4"><span class="kobospan" id="kobo.243.1">On this rationale dialog, we can either cancel the request or grant access. </span><span class="kobospan" id="kobo.243.2">Tapping the </span><strong class="bold"><span class="kobospan" id="kobo.244.1">Grant Access</span></strong><span class="kobospan" id="kobo.245.1"> option should bring up the permission dialog shown in </span><span><em class="italic"><span class="kobospan" id="kobo.246.1">Figure 9</span></em></span><em class="italic"><span class="kobospan" id="kobo.247.1">.2</span></em><span class="kobospan" id="kobo.248.1">, and by tapping the </span><strong class="bold"><span class="kobospan" id="kobo.249.1">While using the app</span></strong><span class="kobospan" id="kobo.250.1"> option, we grant the app the location </span><a id="_idIndexMarker475" class="calibre3 pcalibre pcalibre1"/><span class="kobospan" id="kobo.251.1">permission, and now, we should be able to see the list of cute cats o</span><a id="_idTextAnchor118" class="calibre3 pcalibre pcalibre1"/><span class="kobospan" id="kobo.252.1">nce again. </span><span class="kobospan" id="kobo.252.2">Running the app again does not show the dialogs, since we have already granted the app the </span><span><span class="kobospan" id="kobo.253.1">location permission.</span></span></p>
<div class="calibre2">
<div class="img---figure" id="_idContainer114">
<span class="kobospan" id="kobo.254.1"><img alt="Figure 9.5 – Cute cats" src="image/B19779_09_05.jpg" class="calibre5"/></span>
</div>
</div>
<p class="img---caption" lang="en-US" xml:lang="en-US"><span class="kobospan" id="kobo.255.1">Figure 9.5 – Cute cats</span></p>
<h1 id="_idParaDest-105" class="calibre6"><a id="_idTextAnchor119" class="calibre3 pcalibre pcalibre1"/><span class="kobospan" id="kobo.256.1">Summary</span></h1>
<p class="calibre4"><span class="kobospan" id="kobo.257.1">In this chapter, we explored what runtime permissions are and why we should declare and request permissions in our apps. </span><span class="kobospan" id="kobo.257.2">Step by step, we learned how to request runtime permissions in our app and how to show permission rationale dialogs, explaining to users why we need access to runtime permissions in cases where they have denied apps access </span><span><span class="kobospan" id="kobo.258.1">to permissions.</span></span></p>
<p class="calibre4"><span class="kobospan" id="kobo.259.1">In the next chapter, we will learn debugging tips and tricks, how to detect leaks using LeakCanary, how to inspect HTTPS requests/responses fired by our app using Chucker, and how to inspect the </span><span><span class="kobospan" id="kobo.260.1">Room database.</span></span></p>
</div>
</body></html>