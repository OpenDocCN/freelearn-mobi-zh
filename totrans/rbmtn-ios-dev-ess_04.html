<html><head></head><body><div class="chapter" title="Chapter&#xA0;4.&#xA0;Mastering MVC Paradigm"><div class="titlepage"><div><div><h1 class="title"><a id="ch04"/>Chapter 4. Mastering MVC Paradigm</h1></div></div></div><p>
<span class="emphasis"><em>"Model-View-Controller is not an inescapable law of purity, but a pragmatic principle of effectiveness."</em></span>
</p><p>
<span class="emphasis"><em>—Anonymous</em></span>
</p><p>In this chapter we will learn about Model-View-Controller, popularly abbreviated as MVC, which is a design principle based on the ideas of code reusability and <span class="strong"><strong>separation of concerns</strong></span> <a id="id192" class="indexterm"/> (<span class="strong"><strong>SoC</strong></span>). This architecture imposes serious constraints on the structure of an application, however, surprisingly these restrictions make it considerably easier to design and maintain the application. In this chapter we will be covering the following topics:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">Understanding the Model-View-Controller paradigm</li><li class="listitem" style="list-style-type: disc">Creating a RubyMotion application using MVC</li><li class="listitem" style="list-style-type: disc">Connecting to an external API</li><li class="listitem" style="list-style-type: disc">Enhancing the application with search and images</li><li class="listitem" style="list-style-type: disc">The do-it-yourself exercise</li></ul></div><div class="section" title="Model-View-Controller (MVC)"><div class="titlepage"><div><div><h1 class="title"><a id="ch04lvl1sec26"/>Model-View-Controller (MVC)</h1></div></div></div><p>
<span class="strong"><strong>Model-View-Controller</strong></span> (<span class="strong"><strong>MVC</strong></span>) is a design principle<a id="id193" class="indexterm"/> that separates the representation of information from the user's interaction. The main purpose of MVC is to make the code more modular and reusable, which increases the product quality.</p><p>Most of the popular commercial and noncommercial application frameworks are created to enforce the MVC design pattern. However, RubyMotion does not force you to use MVC style, but this way of programming is central to a good design for application development. If we make use of MVC while developing our application, it will be beneficial for us later on, as we will be able to add new features more easily.</p><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="note19"/>Note</h3><p>Apple's Cocoa framework is also based on Model-View-Controller.</p></div></div><p>As the name implies, the application is divided into three distinct parts: model, view, and controller, <a id="id194" class="indexterm"/>where model encapsulates application data, view displays and allows editing the data, and controller is the place where logic of the interaction between the two (model and view) resides. Let's understand each of them individually.</p><div class="section" title="Model"><div class="titlepage"><div><div><h2 class="title"><a id="ch04lvl2sec41"/>Model</h2></div></div></div><p>The model contains<a id="id195" class="indexterm"/> the application data and business rules. The model could just be the actual data store, either in-memory (maybe as an <code class="literal">NSArray</code> or <code class="literal">NSDictionary</code> class)<a id="id196" class="indexterm"/> or to-and-from disk. In a more complex app, you may choose to use a SQLite database or Core Data, and your model would be a simple instance or one piece of data.</p></div><div class="section" title="View"><div class="titlepage"><div><div><h2 class="title"><a id="ch04lvl2sec42"/>View</h2></div></div></div><p>A view is that part of an application that outputs information from the model via the controller. The logic<a id="id197" class="indexterm"/> should never be written in the view; the sole purpose of the view is only to present information. In iOS, and also in RubyMotion, most views are <a id="id198" class="indexterm"/>subclasses of the <code class="literal">UIView</code> class that provide the capability for handling touch events and drawings. The <code class="literal">UIKit</code> framework contains classes to draw typical interface elements such as tables (lists), buttons, text fields, and sliders.</p></div><div class="section" title="Controller"><div class="titlepage"><div><div><h2 class="title"><a id="ch04lvl2sec43"/>Controller</h2></div></div></div><p>A controller is a link between the model and view. A controller acts as an intermediary between one<a id="id199" class="indexterm"/> or more application views, and one or more of its models. In iOS, the controller is generally a subclass of <code class="literal">UIViewController</code> that also manages a view; this class is also <a id="id200" class="indexterm"/>responsible for responding to delegation messages and target-action messages.</p><p>The Model-View-Controller layers are very closely coupled, as shown in the following diagram:</p><div class="mediaobject"><img src="graphics/5220OT_04_01.jpg" alt="Controller"/></div><p>The <span class="strong"><strong>View</strong></span> and <span class="strong"><strong>Controller</strong></span> layers<a id="id201" class="indexterm"/> interact through <span class="strong"><strong>User Action</strong></span> <a id="id202" class="indexterm"/>and <span class="strong"><strong>Update</strong></span><a id="id203" class="indexterm"/> as shown in the diagram. Whenever the <span class="strong"><strong>View</strong></span> layer<a id="id204" class="indexterm"/> creates or modifies data, it is communicated to <span class="strong"><strong>Controller</strong></span>
<a id="id205" class="indexterm"/> through <span class="strong"><strong>User Action</strong></span><a id="id206" class="indexterm"/>. Similarly, whenever <span class="strong"><strong>Model</strong></span> updates<a id="id207" class="indexterm"/> any change it will first <span class="strong"><strong>Notify</strong></span>
<a id="id208" class="indexterm"/> the <span class="strong"><strong>Controller</strong></span> and will then be reflected on the <span class="strong"><strong>View</strong></span><a id="id209" class="indexterm"/> by an <span class="strong"><strong>Update</strong></span>
<a id="id210" class="indexterm"/>.</p></div></div></div>
<div class="section" title="The restaurant application"><div class="titlepage"><div><div><h1 class="title"><a id="ch04lvl1sec27"/>The restaurant application</h1></div></div></div><p>Now to better<a id="id211" class="indexterm"/> understand MVC we will create a <code class="literal">restro</code> application. This application will search restaurants in a city. Does the world need another restaurant application? No, but that won't stop us from writing one. On a serious note, it will help us to explore many features of RubyMotion and will also help us learn and master MVC.</p><p>Let's understand what we are going to do in this application. A restaurant application will list out the eat outs, which we can search based on the city. The list of places will have a thumbnail image along with information related to the restaurant.</p><p>It's good practice to imagine views of your application in the form of a mockup. The best way to do this is by using a white board with illustrations that you envision for your application.</p><div class="mediaobject"><img src="graphics/5220OT_04_02.jpg" alt="The restaurant application"/></div><p>You must be wondering where all this data will come from. Do I need to hardcode it right into my application? That does not make sense! To begin with, we will hardcode the values;<a id="id212" class="indexterm"/> but later on, as we proceed and evolve, we will learn how to use an external API to fetch information, which is something often done in real-world applications. We have created a backend API exclusively for this book, having all the data available for practice.</p><p>Let's now create a <code class="literal">restro</code> project with RubyMotion, using the magical <code class="literal">motion</code> command:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>&gt;motion create restro</strong></span>
<span class="strong"><strong>    Create restro</strong></span>
<span class="strong"><strong>    Create restro/.gitignore</strong></span>
<span class="strong"><strong>    Create restro/Rakefile</strong></span>
<span class="strong"><strong>    Create restro/app</strong></span>
<span class="strong"><strong>    Create restro/app/app_delegate.rb</strong></span>
<span class="strong"><strong>    Create restro/resources</strong></span>
<span class="strong"><strong>    Create restro/spec</strong></span>
<span class="strong"><strong>    Create restro/spec/main_spec.rb</strong></span>
</pre></div><p>As discussed in earlier chapters, the<a id="id213" class="indexterm"/> <code class="literal">motion</code> command will create the basic structure for a RubyMotion project.</p><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="tip19"/>Tip</h3><p>Feel free to choose your IDE. If you are using RubyMine, you can also create and run the application from the IDE.</p></div></div><div class="section" title="Creating a model"><div class="titlepage"><div><div><h2 class="title"><a id="ch04lvl2sec44"/>Creating a model</h2></div></div></div><p>For our <code class="literal">restro</code> application, let's brainstorm what entities and attributes will be required. The<a id="id214" class="indexterm"/> first thing that comes to mind is a restaurant entity having the following attributes:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><code class="literal">name</code>: This will contain the name of the application</li><li class="listitem" style="list-style-type: disc"><code class="literal">thumb_url_image</code>: This will contain the image URL for the restaurant</li><li class="listitem" style="list-style-type: disc"><code class="literal">food_type</code>: This will contain the type of food the restaurant serves</li><li class="listitem" style="list-style-type: disc"><code class="literal">desc</code>: This will contain a small description about the restaurant</li></ul></div><p>Looks good! Let's create a model, <code class="literal">Restaurant</code>, that will store all the information related to restaurants.</p><p>Create a ruby (<code class="literal">.rb</code>) file, which will be our model inside the <code class="literal">app</code> folder, and name it <code class="literal">restaurant.rb</code>:</p><div class="informalexample"><pre class="programlisting">class Restaurant
attr_accessor :name,:thumb_url_image, :food_type, :desc
  def initialize(restaurant)
    @name =restaurant['name']
    @thumb_url_image = restaurant['thumb_url_image']
    @food_type = restaurant['food_type']
    @desc = restaurant['desc']
  end
end</pre></div><p>We have created a class called <code class="literal">Restaurant</code>. Generally we need to first create getter and setter methods for the variables. However, in Ruby we don't need to separately create getters and setters, instead we use a single method called <code class="literal">attr_accessor</code> to do that; this idea of syntactic sugar is commonly used in various trivial jobs in Ruby, which indeed saves a lot of time.</p><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="note20"/>Note</h3><p>
<span class="strong"><strong>Syntactic sugar</strong></span>
<a id="id215" class="indexterm"/> is a syntax within a programming language that is designed to make things easier to read or express. An example of syntactic sugar is as follows:</p><div class="informalexample"><pre class="programlisting">attr_accessor :name,:thumb_url_image, :food_type, :desc</pre></div></div></div><p>After setting up <code class="literal">attr_accessor</code>, in order to assign values while creating an object of the <code class="literal">Restaurant</code> <a id="id216" class="indexterm"/>class, we have created an <code class="literal">initialize</code> method. This gives us a chance to write code that sets up our object's state.</p><div class="informalexample"><pre class="programlisting">  def initialize(restaurant)
    @name =restaurant['name']
    @thumb_url_image = restaurant['thumb_url_image']
    @food_type = restaurant['food_type']
    @desc = restaurant['desc']
  end</pre></div><p>Whenever we create an object of the <code class="literal">Restaurant</code> class, it will call the <code class="literal">name</code> method, and initialize and execute it. We have to pass a hash of restaurants while creating the object. To test the model, let's fire up our terminal in the <code class="literal">application</code> directory and run <code class="literal">rake</code>:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>&gt;restaurant = Restaurant.new({'name'=&gt; "Pizza madness", 'thumb_url_image'=&gt; nil, 'food_type'=&gt;"italian", 'desc'=&gt;"Pizza at your door step in 30 min"})</strong></span>
<span class="strong"><strong>=&gt; #&lt;Restaurant:0xb5376a0 @name="Pizza madness" @thumb_url_image=nil @food_type="italian" @desc="Pizza at your door step in 30 min"&gt;</strong></span>

<span class="strong"><strong>&gt; restaurant.name</strong></span>
<span class="strong"><strong>=&gt; "Pizza madness"</strong></span>
</pre></div><p>Great! Our <code class="literal">Restaurant</code> class is created and we can now create objects of this class.</p></div><div class="section" title="Writing more code"><div class="titlepage"><div><div><h2 class="title"><a id="ch04lvl2sec45"/>Writing more code</h2></div></div></div><p>A lot of iOS<a id="id217" class="indexterm"/> applications use table structure to represent their information. This method of design is best for information-based applications, like the one we have in our example. So let's create a table view for our landing page, which will populate a list of restaurants.</p><p>Let's now update the <code class="literal">app_delegate.rb</code> file inside the <code class="literal">app</code> folder:</p><div class="informalexample"><pre class="programlisting">class AppDelegate
  def application(application,
                 didFinishLaunchingWithOptions:launchOptions)
      @window = UIWindow.alloc.initWithFrame(UIScreen.mainScreen.applicationFrame)
      @window.rootViewController = RestroController.alloc.initWithStyle(UITableViewStylePlain)
      @window.rootViewController.wantsFullScreenLayout = true
      @window.makeKeyAndVisible
      true
  end
end</pre></div><p>The <a id="id218" class="indexterm"/>
<code class="literal">UIWindow</code> class defines an object known as <code class="literal">window</code>, which manages and coordinates different views <a id="id219" class="indexterm"/>of your application, and displays them on the device screen. A <code class="literal">UIScreen</code> object contains the bounding rectangle of the device's entire screen. So <code class="literal">UIScreen.mainScreen.applicationFrame</code> returns the rectangle size according to the screen size and orientation of the device. Also we need to tell the <code class="literal">UIWindow</code> object which controller to load:</p><div class="informalexample"><pre class="programlisting">@window.rootViewController = RestroController.alloc.initWithStyle(UITableViewStylePlain)</pre></div><p>We have assigned the <code class="literal">RestroController</code> class as the root controller for our application in <code class="literal">AppDelegate</code>. So let's create <code class="literal">restro_controller.rb</code> in the <code class="literal">app</code> folder:</p><div class="informalexample"><pre class="programlisting">class RestroController &lt; UITableViewController
  def viewDidLoad
    super
    @restaurant1 = Restaurant.new({'name'=&gt; "Pizza madness",'thumb_url_image'=&gt; nil, 'food_type'=&gt;"italian", 'desc'=&gt;"Pizza at your door step in 30 min"})
    @restaurant2 = Restaurant.new({'name'=&gt; "Lavasa", 'thumb_url_image' =&gt; nil,'food_type'=&gt;"italian",
            'desc'=&gt;"best Coffee house in town"})
    @restaurants = [@restaurant1,@restaurant2]
    view.backgroundColor = UIColor.whiteColor
    @myTableView = UITableView.alloc.initWithFrame(view.bounds, style:UITableViewStylePlain)
    @myTableView.dataSource = self
    @myTableView.delegate = self
    view.addSubview(@myTableView)
  end

  def tableView(tableView, numberOfRowsInSection:section)
    @restaurants.count
  end

  def tableView(tableView, cellForRowAtIndexPath:indexPath)

    @reuseIdentifier ||= "CELL_IDENTIFIER"

    cell = tableView.dequeueReusableCellWithIdentifier(@reuseIdentifier) || begin
        UITableViewCell.alloc.initWithStyle(UITableViewCellStyleDefault, reuseIdentifier:@reuseIdentifier)
    end
    cell.textLabel.text = @restaurants[indexPath.row].name
    cell
  end

end</pre></div><p>Now let's fire up <a id="id220" class="indexterm"/>our terminal again and see what we have done:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>&gt;rake</strong></span>
</pre></div><div class="mediaobject"><img src="graphics/5220OT_04_03.jpg" alt="Writing more code"/></div><p>The previous screenshot shows a table structure with a list of restaurants. Now that's some impressive<a id="id221" class="indexterm"/> work. Let's now understand what we did in the previous section. Our code has three parts—model, view, and controller. We have already explained about the restaurant model. We first created an object for the model and assigned some value to it:</p><div class="informalexample"><pre class="programlisting">@restaurant1 = Restaurant.new({
    'name'=&gt; "Pizza madness", 'thumb_url_image'=&gt; nil,
    'food_type'=&gt;"italian",
    'desc'=&gt;"Pizza at your door step in 30 min"})
 
@restaurant2 = Restaurant.new({
    'name'=&gt; "Lavasa",
    'thumb_url_image' =&gt; nil,
    'food_type'=&gt;"italian",
    'desc'=&gt;"best Coffee house in town"})</pre></div><p>We have created two objects and passed a hash to them, as we have explained in the previous <a id="id222" class="indexterm"/>section. The remaining code has two parts, a controller and a view; let's understand them one by one.</p><div class="section" title="Restaurant controller"><div class="titlepage"><div><div><h3 class="title"><a id="ch04lvl3sec07"/>Restaurant controller</h3></div></div></div><p>In the previous example, the <code class="literal">Restaurant</code> controller inherits from <code class="literal">UITableViewController</code>, which is a subclass of <code class="literal">UIViewController</code>. The <code class="literal">UIViewController</code> class <a id="id223" class="indexterm"/>provides the fundamental view-management model for your apps.</p><p>We rarely instantiate the <code class="literal">UIViewController</code> objects directly. Instead, it is generally instantiated via a class that is a subclass of the <code class="literal">UIViewController</code> class<a id="id224" class="indexterm"/>, as we did in the previous example. It manages a set of views that make up a portion of your app's user interface. The most important thing in an iOS controller is its lifecycle. There are various actions that are called at different phases of the application. The lifecycle includes actions such as <code class="literal">Initialize</code>, <code class="literal">ViewDidLoad</code>, <code class="literal">ViewWillAppear</code>, <code class="literal">ViewDidAppear</code>, <code class="literal">ViewWillDisappear</code>, <code class="literal">ViewDidDisappear</code>, <code class="literal">ViewDidUnload</code>, and <code class="literal">Dispose</code>. So these events are called automatically and dynamically. Whenever we create an object of the controller it calls <code class="literal">Initialize</code>, before loading the view for the controller, <code class="literal">ViewDidLoad</code> will be called. The complete lifecycle of a controller can be seen in the following diagram:</p><div class="mediaobject"><img src="graphics/5220OT_04_04.jpg" alt="Restaurant controller"/></div><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="note21"/>Note</h3><p>
<code class="literal">viewDidUnload</code> and <code class="literal">viewWillUnload</code> are deprecated in iOS 6.0.</p></div></div><p>You can see<a id="id225" class="indexterm"/> in our restro controller that we have written a lot of logic in <code class="literal">ViewDidLoad</code>, so all the code written in this block will execute before the loading of the view.</p><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="note22"/>Note</h3><p>It's important to note that these methods are attached to <code class="literal">UIViewController</code> and not to <code class="literal">UIViews</code>.</p></div></div></div><div class="section" title="Restaurant view"><div class="titlepage"><div><div><h3 class="title"><a id="ch04lvl3sec08"/>Restaurant view</h3></div></div></div><p>The <code class="literal">UITableView</code> class is used to create one of the most common types of views used in iOS applications, that is, the table view. We can see only one column in our application. This is because the <code class="literal">UITableView</code> instance is limited to a single column as it is designed for a device with a small screen. <code class="literal">UITableView</code> is a subclass of <code class="literal">UIScrollView</code>, which allows users to scroll <a id="id226" class="indexterm"/>through the table, although <code class="literal">UITableView</code> allows vertical scrolling only.</p><p>Table views can have one of two styles, <code class="literal">UITableViewStylePlain</code> (for example, iOS contacts) or <code class="literal">UITableViewStyleGrouped</code> (for example, iOS settings). When you create a <code class="literal">UITableView</code> instance, you must specify the table style; this style cannot be changed. For our application, since we do not require to group the restaurants we will use <code class="literal">UITableViewStylePlain</code>.</p><div class="informalexample"><pre class="programlisting">@myTableView = UITableView.alloc.initWithFrame(view.bounds, style:UITableViewStylePlain)</pre></div><p>A view is bound to return <code class="literal">CGRect</code> with an empty origin point. The <code class="literal">CGRect</code> class is very commonly used in iOS apps. Its data structure represents the location and dimensions of a rectangle, which is used to set the size of the table view.</p><p>The <code class="literal">UITableView</code> class<a id="id227" class="indexterm"/> provides a lot of options, but it needs to know what data we are trying to show and what to do when the user interacts with that data. This is where the <code class="literal">datasource</code> and <code class="literal">delegate</code> properties come in:</p><div class="informalexample"><pre class="programlisting">    @myTableView.dataSource = self
    @myTableView.delegate = self</pre></div><p>We have to return the number of rows to be created using <code class="literal">numberOfRowsInSection</code>:</p><div class="informalexample"><pre class="programlisting">  def tableView(tableView, numberOfRowsInSection:section)
    @restaurants.count
  end</pre></div><p>The <code class="literal">tableView:numberOfRowsInSection</code> property <a id="id228" class="indexterm"/>tells the <code class="literal">UITableview</code> datasource to return the number of rows in a given section of a table view. So in our example, the number of rows will be equal to the total restaurant count.</p><p>Moving forward, let's <a id="id229" class="indexterm"/>understand <code class="literal">UITableViewCell</code>, which is the subclass of <code class="literal">UIView</code>; using this class our rows are displayed in table form. To access the contents of the cell, we have properties, such as <code class="literal">textLabel</code> and <code class="literal">imageView</code>, to use them for setting their attributes such as text color, font, image, and highlighted image. You can also easily give a custom look to tables by using different iOS methods. Another property <code class="literal">cellForRowAtIndexPath</code> either creates a new cell or recycles an offscreen one and populates it with the data corresponding to <code class="literal">indexPath</code>, and returns the cell. The following code snippet shows how a more complete implementation looks:</p><div class="informalexample"><pre class="programlisting">  def tableView(tableView, cellForRowAtIndexPath:indexPath)

    @reuseIdentifier ||= "CELL_IDENTIFIER"

    cell = tableView.dequeueReusableCellWithIdentifier(@reuseIdentifier) || begin
      UITableViewCell.alloc.initWithStyle(UITableViewCellStyleDefault, reuseIdentifier:@reuseIdentifier)
    end
    cell.textLabel.text = @restaurants[indexPath.row].name
    cell
  end</pre></div><p>The <code class="literal">UITableView</code> class<a id="id230" class="indexterm"/> only displays enough data to fill the iPhone screen—it does not really matter how much data you might have in total. The <code class="literal">UITableView</code> class does this by reusing cells that scrolled off the screen. When cells scroll off the screen (either the top or the bottom) the table view will queue up cells that are no longer needed. When it asks the datasource for the cell of a particular row, you can check that queue of cells to see if there are any available for use:</p><div class="mediaobject"><img src="graphics/5220OT_04_05.jpg" alt="Restaurant view"/></div><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="note23"/>Note</h3><p>The whole point of <code class="literal">dequeueReusableCell</code> is that the process of creating a new view hierarchy for <code class="literal">UITableViewCell</code> is rather expensive. If you recreated the cell each time you needed it, the scrolling behavior wouldn't be as nice as it is.</p></div></div><p>With <code class="literal">dequeueReusableCellWithIdentifier</code> for <code class="literal">tableView</code>, you can greatly speed things up. Instead <a id="id231" class="indexterm"/>of instantiating a lot of cells, you can just instantiate the ones that are needed, which means only those cells that are visible (this is handled automatically). When scrolling to an area in the list for which the cells are not yet visually represented, instead of instantiating new ones, you can reuse the already existing ones.</p><div class="informalexample"><pre class="programlisting">cell = tableView.dequeueReusableCellWithIdentifier(@reuseIdentifier) || begin
        UITableViewCell.alloc.initWithStyle(UITableViewCellStyleDefault, reuseIdentifier:@reuseIdentifier)
    end</pre></div><p>Next we have assigned a display value for each row in the following way:</p><div class="informalexample"><pre class="programlisting">cell.textLabel.text = @restaurants[indexPath.row].name</pre></div><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="note24"/>Note</h3><p>In Ruby, <span class="emphasis"><em>a ||= b</em></span> means if <span class="emphasis"><em>a</em></span> is nil/false, assign it the value of <span class="emphasis"><em>b</em></span>.<a id="id232" class="indexterm"/>
</p></div></div></div></div></div>
<div class="section" title="Connecting to an external API"><div class="titlepage"><div><div><h1 class="title"><a id="ch04lvl1sec28"/>Connecting to an external API</h1></div></div></div><p>Right now we<a id="id233" class="indexterm"/> have hardcoded the object values, which usually never happens in a real-world application; let's get these values from an external API. For practicing purposes we have created an external API to get the data in JSON format.</p><p>If you visit<a class="ulink" href="http:// http://restro.nalwaya.com/restaurants/search.json?city=Chicago"> http://restro.nalwaya.com/restaurants/search.json?city=Chicago</a> or use the <code class="literal">curl</code> command instead, it will return the restaurants we have seeded for Chicago in JSON format (note that this is fictitious data, you might not actually find them in Chicago city).</p><p>Let's run the following <code class="literal">curl</code> command to get the data:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>&gt; curl "http://restro.nalwaya.com/restaurants/search.json?city=Chicago"</strong></span>
<span class="strong"><strong>[{</strong></span>
<span class="strong"><strong>  "name":"Polka Dots", </strong></span>
<span class="strong"><strong>    "thumb_url_image":"http://restro.nalwaya.com/system/</strong></span>
<span class="strong"><strong>    restaurants/avatars/000/000/001/thumb/hotel.jpg?1352812187",</strong></span>
<span class="strong"><strong>  "food_type":"Italian",</strong></span>
<span class="strong"><strong>  "desc":"Best Italian food in city"</strong></span>
<span class="strong"><strong>},</strong></span>
<span class="strong"><strong>{</strong></span>
<span class="strong"><strong>  "name":"Striker", </strong></span>
<span class="strong"><strong>    "thumb_url_image":"http://restro.nalwaya.com/system/</strong></span>
<span class="strong"><strong>    restaurants/avatars/000/000/002/thumb/</strong></span>
<span class="strong"><strong>    20121111_135450.jpg?1353424527",</strong></span>
<span class="strong"><strong>  "food_type":"Italian",</strong></span>
<span class="strong"><strong>  "desc":"Best food in the town"</strong></span>
<span class="strong"><strong>},</strong></span>
<span class="strong"><strong>{</strong></span>
<span class="strong"><strong>  "name":"Pizza madness", </strong></span>
<span class="strong"><strong>    thumb_url_image":"http://restro.nalwaya.com/system/</strong></span>
<span class="strong"><strong>    restaurants/avatars/000/000/003/thumb/</strong></span>
<span class="strong"><strong>    restaurant-icon-96da9e9f58682c8035c4fa4ee04bdcca.gif?1353425778",</strong></span>
<span class="strong"><strong>  "food_type": "Pizza Mania",</strong></span>
<span class="strong"><strong>  "desc":"Pizza in 30 min"}, </strong></span>
<span class="strong"><strong>{</strong></span>
<span class="strong"><strong>  "name":"Dollaly", </strong></span>
<span class="strong"><strong>    "thumb_url_image":"http://restro.nalwaya.com/system/</strong></span>
<span class="strong"><strong>    restaurants/avatars/000/000/004/thumb/</strong></span>
<span class="strong"><strong>    restaurant_table3.jpg?1353425829", "food_type":"Indian",</strong></span>
<span class="strong"><strong>  "desc":"Best beer in town"</strong></span>
<span class="strong"><strong>}]</strong></span>
</pre></div><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="note25"/>Note</h3><p>
<code class="literal">curl</code> is a command-line tool for transferring data using various protocols.</p></div></div><p>Now we <a id="id234" class="indexterm"/>will show the list of restaurants in Chicago city, which we are getting from our source in our <code class="literal">restro</code> application. Since we are getting data in JSON format, we need to convert this JSON object to a Ruby object.</p><p>Create a file by the name <code class="literal">json_parser.rb</code> in the <code class="literal">app</code> folder:</p><div class="informalexample"><pre class="programlisting">class JSONParser
  def self.parse_from_url(url)
    data = DataParser.parse(url)
    
    error_ptr = Pointer.new(:object)
    json = NSJSONSerialization.JSONObjectWithData(data, options:0, error:error_ptr)
    unless json
      alert = UIAlertView.new··
      alert.message = error_ptr[0]
      alert.show 
    end
    json
  end
end</pre></div><p>The <code class="literal">NSJSONSerialization</code> class<a id="id235" class="indexterm"/> converts JSON to Foundation objects and converts Foundation objects to JSON.</p><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="note26"/>Note</h3><p>RubyMotion has the <code class="literal">Pointer</code> class in order to create and manipulate pointers. The type of pointer to create must be provided in the new constructor. So <code class="literal">Pointer.new(:object)</code> will create a new pointer with the object class.</p></div></div><p>We need to fetch the JSON object by sending a request to the server; for that we will create a <code class="literal">DataParser</code> class.<a id="id236" class="indexterm"/>
</p><p>Let's create a file by the name <code class="literal">data_parser.rb</code> in the <code class="literal">app</code> folder:</p><div class="informalexample"><pre class="programlisting">class DataParser
  def self.parse(url)
    error_ptr = Pointer.new(:object)
    data = NSData.alloc.initWithContentsOfURL(NSURL.URLWithString(url), options:NSDataReadingUncached, error:error_ptr)
    unless data
      alert = UIAlertView.new··
      alert.message = error_ptr[0]
      alert.show 

    end  
    data
  end  
end</pre></div><p>We will fetch data using the <code class="literal">NSUrl</code> class that will pass this data to <code class="literal">NSData</code>. <code class="literal">NSData</code> and its mutable subclass <code class="literal">NSMutableData</code> provides the data objects with an object-oriented wrapping for byte buffers.</p><p>Now let's refactor the logic in <code class="literal">restro_controller.rb</code>, which will fetch data from the API instead of the hardcoded <code class="literal">Restaurant</code> object we had created in the previous section.</p><p>Update the <code class="literal">viewDidLoad</code> section of <code class="literal">restro_controller.rb</code>:</p><div class="informalexample"><pre class="programlisting">url = "http://restro.nalwaya.com/restaurants/search.json?city=Chicago"
    json = nil
    begin
      json = JSONParser.parse_from_url(url)
    rescue RuntimeError =&gt; e
      presentError e.message
    end

    @restaurants = []
    json.each do |restaurant|
      @restaurants &lt;&lt; Restaurant.new(restaurant)
    end

    
    view.backgroundColor = UIColor.whiteColor
    @myTableView = UITableView.alloc.initWithFrame(view.bounds, style:UITableViewStylePlain)
    @myTableView.dataSource = self
    @myTableView.delegate = self
    view.addSubview(@myTableView)</pre></div><p>In case<a id="id237" class="indexterm"/> of an error, let's face it gracefully by displaying the error message using a pop-up. So let's create a <code class="literal">presentError</code> method in <code class="literal">restaurant_controller.rb</code>, and print the error on pop-up:</p><div class="informalexample"><pre class="programlisting">def presentError error_msg
  alert = UIAlertView.new··
  alert.message = error_msg
  alert.show·

end</pre></div><p>Go to the terminal and start the application with the<a id="id238" class="indexterm"/> <code class="literal">rake</code> command.</p><div class="mediaobject"><img src="graphics/5220OT_04_06.jpg" alt="Connecting to an external API"/></div><p>We can see that the<a id="id239" class="indexterm"/> list of restaurants is shown dynamically from the JSON API.</p></div>
<div class="section" title="Search restaurant by city"><div class="titlepage"><div><div><h1 class="title"><a id="ch04lvl1sec29"/>Search restaurant by city</h1></div></div></div><p>In the previous section we were only showing restaurants in Chicago. If you noticed, it was hardcoded in<a id="id240" class="indexterm"/> the URL itself and was not generic. In this section we will make the application more generic and allow the user to search data based on a parameter city.</p><p>Update <code class="literal">restro_controller.rb</code> as follows:</p><div class="informalexample"><pre class="programlisting">class RestroController &lt; UITableViewController
  def viewDidLoad
    super
    @restaurants = []
    searchBar = UISearchBar.alloc.initWithFrame(CGRectMake(0, 0, self.tableView.frame.size.width, 0))
    searchBar.delegate = self;
    searchBar.showsCancelButton = true;
    searchBar.sizeToFit
    view.tableHeaderView = searchBar
    view.dataSource = view.delegate = self
    searchBar.text = 'Chicago'

    searchBarSearchButtonClicked(searchBar)

  end
  def searchBarSearchButtonClicked(searchBar)
    query = searchBar.text.stringByAddingPercentEscapesUsingEncoding(NSUTF8StringEncoding)
    url = "http://restro.nalwaya.com/restaurants/search.json?city=#{query}"
    @restaurants.clear
    json = nil
    begin
      json = JSONParser.parse_from_url(url)
    rescue RuntimeError =&gt; e
      presentError e.message
    end

    @restaurants = []
    json.each do |restaurant|
      @restaurants &lt;&lt; Restaurant.new(restaurant)
    end

    view.reloadData
    searchBar.resignFirstResponder
  end
  def searchBarCancelButtonClicked(searchBar)
    searchBar.resignFirstResponder
  end
  def tableView(tableView, numberOfRowsInSection:section)
    @restaurants.count
  end

  def tableView(tableView, cellForRowAtIndexPath:indexPath)
    @reuseIdentifier ||= "CELL_IDENTIFIER"
    cell = tableView.dequeueReusableCellWithIdentifier(@reuseIdentifier) || begin
      UITableViewCell.alloc.initWithStyle(UITableViewCellStyleDefault, reuseIdentifier:@reuseIdentifier)
    end
    cell.textLabel.text = @restaurants[indexPath.row].name
    cell
  end
end</pre></div><div class="mediaobject"><img src="graphics/5220OT_04_07.jpg" alt="Search restaurant by city"/></div><p>Start the simulator by<a id="id241" class="indexterm"/> the <code class="literal">rake</code> command, and you can see that your toolbar is replaced with a search box with the default value <span class="strong"><strong>Chicago</strong></span>.</p><div class="section" title="What just happened"><div class="titlepage"><div><div><h2 class="title"><a id="ch04lvl2sec46"/>What just happened</h2></div></div></div><p>The <code class="literal">UISearchBar</code> class<a id="id242" class="indexterm"/> implements a text field control for text-based searches. The <code class="literal">UISearchBar</code> object does not actually perform any search; it is just a view, which we can see on the device. To make the search work, we use a delegate, which is an object conforming to the <code class="literal">UISearchBarDelegate</code> protocol, to implement the actions when text is entered and buttons are clicked. The <code class="literal">UISearchBarDelegate</code> protocol defines the optional methods you implement to make a <code class="literal">UISearchBar</code> control functional.</p><p>The <code class="literal">UISearchBar</code> object<a id="id243" class="indexterm"/> provides the user interface for a search field on a bar, but it's the application's<a id="id244" class="indexterm"/> responsibility to implement the actions when buttons are tapped. We can implement this using various methods available, which are explained next.</p><p>The methods used for editing text are as follows:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><code class="literal">searchBar:textDidChange</code>: This tells the delegate that the user changed the search text</li><li class="listitem" style="list-style-type: disc"><code class="literal">searchBar:shouldChangeTextInRange:replacementText</code>: This asks the delegate if text in a specified range should be replaced with the given text</li><li class="listitem" style="list-style-type: disc"><code class="literal">searchBarShouldBeginEditing</code>: This asks the delegate if editing should begin in the specified search bar</li><li class="listitem" style="list-style-type: disc"><code class="literal">searchBarTextDidBeginEditing</code>: This tells the delegate when the user begins editing the search text</li><li class="listitem" style="list-style-type: disc"><code class="literal">searchBarShouldEndEditing</code>: This asks the delegate if editing should stop in the specified search bar</li><li class="listitem" style="list-style-type: disc"><code class="literal">searchBarTextDidEndEditing</code>: This tells the delegate that the user finished editing the search text</li></ul></div><p>The methods used for different click events on various buttons in the search bar are as follows:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><code class="literal">searchBarBookmarkButtonClicked</code>: This tells <a id="id245" class="indexterm"/>the delegate that the bookmark button was tapped</li><li class="listitem" style="list-style-type: disc"><code class="literal">searchBarCancelButtonClicked</code>: This tells <a id="id246" class="indexterm"/>the delegate that the cancel button was tapped</li><li class="listitem" style="list-style-type: disc"><code class="literal">searchBarSearchButtonClicked</code>: This<a id="id247" class="indexterm"/> tells the delegate that the search results list button was tapped</li><li class="listitem" style="list-style-type: disc"><code class="literal">searchBarResultsListButtonClicked</code>: This tells<a id="id248" class="indexterm"/> the delegate that the search button was tapped</li></ul></div><p>The method used for the scope button is as follows:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><code class="literal">searchBar:selectedScopeButtonIndexDidChange</code>: This<a id="id249" class="indexterm"/> tells the delegate that the scope button selection changed</li></ul></div><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="tip20"/>Tip</h3><p>As a minimum, the delegate needs to perform the actual search when the text is entered in the text field.</p></div></div><p>We have implemented <code class="literal">searchBarSearchButtonClicked(searchBar)</code>, and whenever the search<a id="id250" class="indexterm"/> button is clicked this action will be called:</p><div class="informalexample"><pre class="programlisting">  def searchBarSearchButtonClicked(searchBar)
    query = searchBar.text.stringByAddingPercentEscapesUsingEncoding(NSUTF8StringEncoding)
    url = "http://restro.nalwaya.com/restaurants/search.json?city=#{query}"
    @restaurants.clear
    json = nil
    begin
      json = JSONParser.parse_from_url(url)
    rescue RuntimeError =&gt; e
      presentError e.message
    end

    @restaurants = []
    json.each do |restaurant|
      @restaurants &lt;&lt; Restaurant.new(restaurant)
    end

    view.reloadData
    searchBar.resignFirstResponder
  end</pre></div><p>So, all the results that we have fetched from our web service are stored in the <code class="literal">json</code> variable. We will loop through this object and store the information in our restaurant model, which we have created in the previous section.</p><p>We have to reload the view once we complete the entire task, and this can be done by using the <code class="literal">view.reloadData</code> class.<a id="id251" class="indexterm"/>
</p></div></div>
<div class="section" title="Picture speaks louder than words"><div class="titlepage"><div><div><h1 class="title"><a id="ch04lvl1sec30"/>Picture speaks louder than words</h1></div></div></div><p>Let's now show a <a id="id252" class="indexterm"/>thumbnail image of a restaurant next to its name. In the JSON API call, we also see that we are getting the link for the restaurant image. So, we use this URL to display the image with the restaurant name in the table view.</p><p>Update <code class="literal">restaurant_controller.rb</code> as follows:</p><div class="informalexample"><pre class="programlisting">  def tableView(tableView, cellForRowAtIndexPath:indexPath)

    @reuseIdentifier ||= "CELL_IDENTIFIER"

    cell = tableView.dequeueReusableCellWithIdentifier(@reuseIdentifier) || begin
      UITableViewCell.alloc.initWithStyle(UITableViewCellStyleDefault, reuseIdentifier:@reuseIdentifier)
    end
    cell.textLabel.text = @restaurants[indexPath.row].name
    cell.imageView.image = UIImage.alloc.initWithData(NSData.alloc.initWithContentsOfURL(NSURL.URLWithString(@restaurants[indexPath.row].thumb_url_image)))
    cell
  end</pre></div><p>
<code class="literal">UIImage.alloc.initWithData</code> initializes and returns the image object with the specified data, and <code class="literal">NSData.alloc.initWithContentsOfURL</code> initializes a newly allocated data object <a id="id253" class="indexterm"/>initialized with the data from the location specified by a URL.</p><p>Once again let's fire up our simulator to see the progress. Run <code class="literal">rake</code> from the <code class="literal">app</code> folder.</p><div class="mediaobject"><img src="graphics/5220OT_04_10.jpg" alt="Picture speaks louder than words"/></div><p>Isn't that simple! <a id="id254" class="indexterm"/>We can now see an image displayed next to the restaurant name.</p></div>
<div class="section" title="Play time"><div class="titlepage"><div><div><h1 class="title"><a id="ch04lvl1sec31"/>Play time</h1></div></div></div><p>It's time for a small <a id="id255" class="indexterm"/>do-it-yourself exercise. In the same application put some description about the restaurant in each row of the table.</p><div class="mediaobject"><img src="graphics/5220OT_04_09.jpg" alt="Play time"/></div><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="tip21"/>Tip</h3><p>We get the description in our API and it is already stored in the <code class="literal">Restaurant</code> object. To display this in the view you can use <code class="literal">detailTextLabel</code> on the cell object, as we have<a id="id256" class="indexterm"/> used in <code class="literal">textLabel</code>.</p></div></div></div>
<div class="section" title="Summary"><div class="titlepage"><div><div><h1 class="title"><a id="ch04lvl1sec32"/>Summary</h1></div></div></div><p>Let's recap what we have learned in this iteration:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">Model-View-Controller architecture</li><li class="listitem" style="list-style-type: disc">Using an MVC design with RubyMotion</li><li class="listitem" style="list-style-type: disc">Connecting our application with an external API</li><li class="listitem" style="list-style-type: disc">Augmenting our app with search and images</li></ul></div><p>In the next chapter, we will turn our attention to user interface (UI) for mobile applications. UI is a key area in mobile application development, and we will learn about various Objective-C classes, which make user interface more interactive, and how they can be used in our RubyMotion application.</p></div></body></html>