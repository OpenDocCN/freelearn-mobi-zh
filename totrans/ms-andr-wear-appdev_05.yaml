- en: Chapter 5. Synchronizing Data
  id: totrans-0
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 第5章。数据同步
- en: '|   | *"How we need another soul to cling to."* |   |'
  id: totrans-1
  prefs: []
  type: TYPE_TB
  zh: '|    | *"我们需要另一个灵魂来依靠。" |    |'
- en: '|   | --*Sylvia Plath* |'
  id: totrans-2
  prefs: []
  type: TYPE_TB
  zh: '|    | --*西尔维亚·普拉斯* |    |'
- en: In the previous chapter, we walked you through creating a standalone wearable
    app. In this chapter, we introduce the idea of a companion handheld app, and why
    it is needed. We then walk you through the steps required to pair a handheld device
    with an Android Wear emulator to expand your environment for wearable app development.
  id: totrans-3
  prefs: []
  type: TYPE_NORMAL
  zh: 在前一章中，我们向您介绍了创建独立可穿戴应用的过程。在本章中，我们介绍了伴侣手持应用的概念，以及为什么需要它。然后，我们向您介绍了将手持设备与Android
    Wear模拟器配对所需的步骤，以扩展您的可穿戴应用开发环境。
- en: We will then augment the `Today` app we started in the previous chapter with
    the ability to display *this day in history* by having it pull content from a
    public feed page via the companion app.
  id: totrans-4
  prefs: []
  type: TYPE_NORMAL
  zh: 然后，我们将在前一章中开始的`Today`应用增强功能，使其能够显示*历史上的今天*，通过伴侣应用从公共内容页面获取内容。
- en: Note
  id: totrans-5
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: 注意
- en: The code samples for this chapter are available on GitHub ([https://github.com/siddii/mastering-android-wear/tree/master/Chapter_5](https://github.com/siddii/mastering-android-wear/tree/master/Chapter_5)).
    Please use the actual code for reference as you follow along.
  id: totrans-6
  prefs: []
  type: TYPE_NORMAL
  zh: 本章的代码示例可在GitHub上找到（[https://github.com/siddii/mastering-android-wear/tree/master/Chapter_5](https://github.com/siddii/mastering-android-wear/tree/master/Chapter_5)）。请参考实际代码进行操作。
- en: What is a companion app anyway?
  id: totrans-7
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 究竟什么是伴侣应用？
- en: Wearable apps run directly on the wearable device and in this way let you access
    the device's hardware, activities, and services all on the device itself. The
    breadth of operations that may be performed on a wearable device is limited by
    design, owing to the smaller scale and the need to efficiently manage processing
    power and memory. In addition to that, wearables don't support the Google Play
    store. In addition to that, Android Wear 1.x does not allow direct install of
    apps from the Google Play Store.
  id: totrans-8
  prefs: []
  type: TYPE_NORMAL
  zh: 可穿戴应用直接在可穿戴设备上运行，这样您就可以在设备本身上访问设备的硬件、活动和服务。由于规模较小以及需要高效管理处理能力和内存，可穿戴设备上可能执行的操作范围受到设计限制。此外，可穿戴设备不支持Google
    Play商店。此外，Android Wear 1.x版本不允许直接从Google Play商店安装应用。
- en: 'A companion handheld app addresses these concerns to let us benefit from a
    rich user experience on our wearable device. The point to remember is that a wearable
    app is packaged within a companion handheld app. The companion app is what gets
    published to the Google Play store, as described in the following figure:'
  id: totrans-9
  prefs: []
  type: TYPE_NORMAL
  zh: 伴侣手持应用解决了这些问题，让我们能够在可穿戴设备上获得丰富的用户体验。需要记住的是，可穿戴应用是打包在伴侣手持应用中的。伴侣应用是发布到Google
    Play商店的内容，如以下图所示：
- en: '![What is a companion app anyway?](img/image00166.jpeg)'
  id: totrans-10
  prefs: []
  type: TYPE_IMG
  zh: '![究竟什么是伴侣应用？](img/image00166.jpeg)'
- en: 'When users download the companion app to a handheld device, the wearable app
    within it is automatically pushed to all connected wearables, as described in
    the following figure:'
  id: totrans-11
  prefs: []
  type: TYPE_NORMAL
  zh: 当用户将伴侣应用下载到手持设备时，其中的可穿戴应用会自动推送到所有已连接的可穿戴设备，如以下图所示：
- en: '![What is a companion app anyway?](img/image00167.jpeg)'
  id: totrans-12
  prefs: []
  type: TYPE_IMG
  zh: '![究竟什么是伴侣应用？](img/image00167.jpeg)'
- en: Furthermore, the companion app running on the handheld device is better suited
    to doing the heavy lifting involved when an app performs network actions, intensive
    computation, and other resource-intensive work. The companion app then sends results
    to the wearable, thus communicating the outcome of its operations.
  id: totrans-13
  prefs: []
  type: TYPE_NORMAL
  zh: 此外，在手持设备上运行的伴侣应用更适合执行应用执行网络操作、密集计算和其他资源密集型工作时所需的繁重工作。然后，伴侣应用将结果发送到可穿戴设备，从而传达其操作的结果。
- en: Before we can create a project housing a companion app module along with its
    wearable app module, we need to set up our development environment to let us work
    with a wearable device on our handheld device.
  id: totrans-14
  prefs: []
  type: TYPE_NORMAL
  zh: 在我们能够创建包含伴侣应用模块及其可穿戴应用模块的项目之前，我们需要设置我们的开发环境，以便我们可以在手持设备上与可穿戴设备一起工作。
- en: Tip
  id: totrans-15
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: 小贴士
- en: It is expected that Android Wear 2.0 will change the way Wear apps are packaged
    and installed from Google Play store. The auto-installation for Wear apps in Wear
    1.x is to be retired. Instead, Wear 2.0 apps are expected to have full network
    access and their installation is to be completely separate from that of handheld
    apps. Google is moving towards standalone wearable apps as the preferred packaging
    approach, but it is not clear yet whether standalone apps will be required (with
    no option for auto-installation) or if they will simply be supported as an additional
    feature.
  id: totrans-16
  prefs: []
  type: TYPE_NORMAL
  zh: 预计Android Wear 2.0将改变从Google Play商店打包和安装Wear应用的方式。Wear 1.x中Wear应用的自动安装将被淘汰。相反，预计Wear
    2.0应用将拥有完整的网络访问权限，并且它们的安装将完全独立于手持应用。Google正在转向独立可穿戴应用作为首选的打包方法，但尚不清楚是否需要独立应用（没有自动安装选项）或者它们是否仅仅作为附加功能得到支持。
- en: Setting up an Android Wear virtual device
  id: totrans-17
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 设置Android Wear虚拟设备
- en: These steps are published on the Android Developers site ([https://developer.android.com/training/wearables/apps/creating.html](https://developer.android.com/training/wearables/apps/creating.html)),
    in the **Creating and Running a Wearable App** section. They are repeated here
    and expanded upon for convenience.
  id: totrans-18
  prefs: []
  type: TYPE_NORMAL
  zh: 这些步骤发布在Android开发者网站上（[https://developer.android.com/training/wearables/apps/creating.html](https://developer.android.com/training/wearables/apps/creating.html)），在**创建和运行可穿戴应用**部分。这里重复并扩展了这些步骤以方便使用。
- en: 'To set up an Android Wear virtual device, click **Tools** | **Android** | **AVD
    Manager** in Android Studio and perform the following steps:'
  id: totrans-19
  prefs: []
  type: TYPE_NORMAL
  zh: 要设置Android Wear虚拟设备，在Android Studio中点击**工具**|**Android**|**AVD管理器**，并执行以下步骤：
- en: Click on the **Create virtual device...** option.
  id: totrans-20
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 点击**创建虚拟设备...**选项。
- en: 'Click **Wear** in the Category list:'
  id: totrans-21
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 在类别列表中点击**Wear**：
- en: Select **Android Wear Square** or **Android Wear Round**.
  id: totrans-22
  prefs:
  - PREF_IND
  - PREF_OL
  type: TYPE_NORMAL
  zh: 选择**Android Wear Square**或**Android Wear Round**。
- en: Click on the **Next** button.
  id: totrans-23
  prefs:
  - PREF_IND
  - PREF_OL
  type: TYPE_NORMAL
  zh: 点击**下一步**按钮。
- en: Select a release name (for example, KitKat Wear).
  id: totrans-24
  prefs:
  - PREF_IND
  - PREF_OL
  type: TYPE_NORMAL
  zh: 选择一个发布名称（例如，KitKat Wear）。
- en: Click **Next**.
  id: totrans-25
  prefs:
  - PREF_IND
  - PREF_OL
  type: TYPE_NORMAL
  zh: 点击**下一步**。
- en: Change any preferences for your virtual device (optional).
  id: totrans-26
  prefs:
  - PREF_IND
  - PREF_OL
  type: TYPE_NORMAL
  zh: 更改虚拟设备的任何偏好设置（可选）。
- en: Click **Finish**.
  id: totrans-27
  prefs:
  - PREF_IND
  - PREF_OL
  type: TYPE_NORMAL
  zh: 点击**完成**。
- en: 'Start the emulator:'
  id: totrans-28
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 启动模拟器：
- en: Select the virtual device you just created.
  id: totrans-29
  prefs:
  - PREF_IND
  - PREF_OL
  type: TYPE_NORMAL
  zh: 选择您刚刚创建的虚拟设备。
- en: Click the green play button.
  id: totrans-30
  prefs:
  - PREF_IND
  - PREF_OL
  type: TYPE_NORMAL
  zh: 点击绿色的播放按钮。
- en: Wait until the emulator initializes and shows the Android Wear home screen.
  id: totrans-31
  prefs:
  - PREF_IND
  - PREF_OL
  type: TYPE_NORMAL
  zh: 等待模拟器初始化并显示Android Wear主屏幕。
- en: 'Pair the Android handheld device with the Wearable emulator:'
  id: totrans-32
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 将Android手持设备与可穿戴模拟器配对：
- en: On your handheld device, install the Android Wear app provided by Google from
    Google Play.
  id: totrans-33
  prefs:
  - PREF_IND
  - PREF_OL
  type: TYPE_NORMAL
  zh: 在您的手持设备上安装Google提供的Android Wear应用从Google Play。
- en: Connect the handheld device to your machine via USB.
  id: totrans-34
  prefs:
  - PREF_IND
  - PREF_OL
  type: TYPE_NORMAL
  zh: 通过USB将手持设备连接到您的计算机。
- en: Forward the AVD's communication port to the connected handheld device (you must
    do this every time the device is connected). If we don't see any errors after
    the following command run, then everything is fine:![Setting up an Android Wear
    virtual device](img/image00168.jpeg)
  id: totrans-35
  prefs:
  - PREF_IND
  - PREF_OL
  type: TYPE_NORMAL
  zh: 将AVD的通信端口转发到已连接的手持设备（每次设备连接时都必须这样做）。如果在以下命令运行后我们没有看到任何错误，那么一切正常：![设置Android
    Wear虚拟设备](img/image00168.jpeg)
- en: Start the Android Wear app on your handheld device and connect to the emulator
    by selecting **Connect Emulator***,* as shown in the following image:![Setting
    up an Android Wear virtual device](img/image00169.jpeg)
  id: totrans-36
  prefs:
  - PREF_IND
  - PREF_OL
  type: TYPE_NORMAL
  zh: 在您的手持设备上启动Android Wear应用并通过选择**连接模拟器**连接到模拟器，如图所示：![设置Android Wear虚拟设备](img/image00169.jpeg)
- en: 'A successful connection is depicted in the following image:'
  id: totrans-37
  prefs:
  - PREF_IND
  - PREF_IND
  type: TYPE_NORMAL
  zh: 以下图像展示了成功的连接：
- en: '![Setting up an Android Wear virtual device](img/image00170.jpeg)'
  id: totrans-38
  prefs:
  - PREF_IND
  - PREF_IND
  type: TYPE_IMG
  zh: '![设置Android Wear虚拟设备](img/image00170.jpeg)'
- en: Launch the Settings menu and select  **Try out watch notifications***:*![Setting
    up an Android Wear virtual device](img/image00171.jpeg)
  id: totrans-39
  prefs:
  - PREF_IND
  - PREF_OL
  type: TYPE_NORMAL
  zh: 打开设置菜单并选择**尝试手表通知**：![设置Android Wear虚拟设备](img/image00171.jpeg)
- en: 'Select **Reminder (by time)** option from the list:'
  id: totrans-40
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 从列表中选择**提醒（按时间）**选项：
- en: '![Setting up an Android Wear virtual device](img/image00172.jpeg)'
  id: totrans-41
  prefs: []
  type: TYPE_IMG
  zh: '![设置Android Wear虚拟设备](img/image00172.jpeg)'
- en: 'The following screen appears on the wearable emulator:'
  id: totrans-42
  prefs: []
  type: TYPE_NORMAL
  zh: 在可穿戴模拟器上出现以下屏幕：
- en: '![Setting up an Android Wear virtual device](img/image00173.jpeg)'
  id: totrans-43
  prefs: []
  type: TYPE_IMG
  zh: '![设置Android Wear虚拟设备](img/image00173.jpeg)'
- en: Revisiting the Today app
  id: totrans-44
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 回顾Today应用
- en: Now that we have the ability to work with a wearable device on our handheld,
    let's revisit the `Today` app we developed in the previous chapter.
  id: totrans-45
  prefs: []
  type: TYPE_NORMAL
  zh: 现在我们有了在手持设备上与可穿戴设备工作的能力，让我们回顾一下在前一章中开发的`Today`应用。
- en: That simplistic version of the app helped gets us started, no doubt. But it
    doesn't really cut it for us. In order to enjoy a fuller experience of a wearable
    device's capabilities, we need to expand our requirements. So, we've decided to
    devote the rest of this chapter to augmenting our `Today` app significantly.
  id: totrans-46
  prefs: []
  type: TYPE_NORMAL
  zh: 那个简化的应用版本无疑帮助我们开始了，但对我们来说这还不够。为了更全面地体验可穿戴设备的功能，我们需要扩展我们的需求。因此，我们决定将本章的其余部分用于显著增强我们的
    `Today` 应用。
- en: We'll describe the features of the new app in a bit, but first, let's get started
    by creating a new project in Android Studio—one that includes a wearable app as
    well as a companion app; and setting it up with the sample code for this chapter.
  id: totrans-47
  prefs: []
  type: TYPE_NORMAL
  zh: 我们将在稍后描述新应用的功能，但首先，让我们在 Android Studio 中创建一个新的项目——该项目包括一个可穿戴应用以及一个伴侣应用；并使用本章的示例代码进行设置。
- en: 'We thought it might be refreshing to start over; that is why our new app is
    still named `Today`. Feel free to call it whatever you like:'
  id: totrans-48
  prefs: []
  type: TYPE_NORMAL
  zh: 我们认为从头开始可能会有所清新；这就是为什么我们的新应用仍然命名为 `Today`。请随意称它为任何你喜欢的名字：
- en: '![Revisiting the Today app](img/image00174.jpeg)'
  id: totrans-49
  prefs: []
  type: TYPE_IMG
  zh: '![重访 Today 应用](img/image00174.jpeg)'
- en: 'Be sure to select the form factors for the app as shown in the following screenshot—**Phone
    and Tablet**, and **Wear** :'
  id: totrans-50
  prefs: []
  type: TYPE_NORMAL
  zh: 请确保选择以下截图所示的应用形式因素——**手机和平板**，以及 **Wear**：
- en: '![Revisiting the Today app](img/image00175.jpeg)'
  id: totrans-51
  prefs: []
  type: TYPE_IMG
  zh: '![重访 Today 应用](img/image00175.jpeg)'
- en: 'Add an empty activity to the **Mobile** module by clicking on **Empty Activity** :'
  id: totrans-52
  prefs: []
  type: TYPE_NORMAL
  zh: 通过点击 **Empty Activity** 在 **Mobile** 模块中添加一个空活动：
- en: '![Revisiting the Today app](img/image00176.jpeg)'
  id: totrans-53
  prefs: []
  type: TYPE_IMG
  zh: '![重访 Today 应用](img/image00176.jpeg)'
- en: 'Give a suitable name to your activity in the following screen:'
  id: totrans-54
  prefs: []
  type: TYPE_NORMAL
  zh: 在以下屏幕中给你的活动起一个合适的名字：
- en: '![Revisiting the Today app](img/image00177.jpeg)'
  id: totrans-55
  prefs: []
  type: TYPE_IMG
  zh: '![重访 Today 应用](img/image00177.jpeg)'
- en: 'For now, choose the **Add No Activity** option in the **Wear** module, and
    click **Finish** :'
  id: totrans-56
  prefs: []
  type: TYPE_NORMAL
  zh: 目前，请在 **Wear** 模块中选择 **Add No Activity** 选项，然后点击 **Finish**：
- en: '![Revisiting the Today app](img/image00178.jpeg)'
  id: totrans-57
  prefs: []
  type: TYPE_IMG
  zh: '![重访 Today 应用](img/image00178.jpeg)'
- en: 'Android Studio creates the **Wear** and **Mobile** modules depicted in the
    following screenshot:'
  id: totrans-58
  prefs: []
  type: TYPE_NORMAL
  zh: Android Studio 创建了以下截图所示的 **Wear** 和 **Mobile** 模块：
- en: '![Revisiting the Today app](img/image00179.jpeg)'
  id: totrans-59
  prefs: []
  type: TYPE_IMG
  zh: '![重访 Today 应用](img/image00179.jpeg)'
- en: The preceding screenshot shows the state of our project. Note that Android Studio
    created two modules—mobile and wear. It also created Gradle scripts for them and
    added the necessary dependencies. Furthermore, the *run target* configuration
    for both modules was created as well.
  id: totrans-60
  prefs: []
  type: TYPE_NORMAL
  zh: 上述截图显示了我们的项目状态。请注意，Android Studio 为它们创建了两个模块——移动和可穿戴。它还为它们创建了 Gradle 脚本并添加了必要的依赖项。此外，还为这两个模块创建了
    *run target* 配置。
- en: We copied our code (that is, activities, resources, icons, and so on) from the
    `Today` project we created in [Chapter 4](part0034.xhtml#aid-10DJ41 "Chapter 4. 
    Developing Watch UI"), *Developing Watch UI*, into the wear module of this newly
    created project, and then augmented it to meet our expanded requirements. This
    is a good time to examine what those requirements are.
  id: totrans-61
  prefs: []
  type: TYPE_NORMAL
  zh: 我们将代码（即活动、资源、图标等）从[第 4 章](part0034.xhtml#aid-10DJ41 "第 4 章。开发手表 UI")中创建的 `Today`
    项目复制到这个新创建的项目中的可穿戴模块，然后扩展它以满足我们的扩展需求。现在是检查这些需求的好时机。
- en: Scope of the new Today app
  id: totrans-62
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 新 Today 应用的范围
- en: We all know how important dates are. Who doesn't get a kick out of learning
    that their significant other shares a birthday with a famous celebrity, or better
    yet, an infamous one? With that in mind, let's spruce up our `Today` app to do
    more than simply display the current date. Let's have it pull content from a public
    feed paged named *On This Day* ([https://en.wikipedia.org/wiki/Special:FeedItem/onthisday/20160615000000/en](https://en.wikipedia.org/wiki/Special:FeedItem/onthisday/20160615000000/en)),
    which shares one or more historically important events/occurrences whose anniversary
    happens to coincide with today.
  id: totrans-63
  prefs: []
  type: TYPE_NORMAL
  zh: 我们都知道日期的重要性。谁不喜欢了解到他们的另一半与一个著名或更糟糕的是臭名昭著的明星共享生日呢？考虑到这一点，让我们让我们的 `Today` 应用不仅仅显示当前日期。让它从名为
    *On This Day* 的公共内容源中获取内容（[https://en.wikipedia.org/wiki/Special:FeedItem/onthisday/20160615000000/en](https://en.wikipedia.org/wiki/Special:FeedItem/onthisday/20160615000000/en)），它分享一个或多个历史上重要事件/发生的周年纪念日，恰好与今天相符。
- en: This seems like a larger enough bite into the Wearable API stack that will let
    us study the interplay between a wearable device and its companion app without
    too much additional complexity.
  id: totrans-64
  prefs: []
  type: TYPE_NORMAL
  zh: 这似乎足够深入地咬进了可穿戴 API 栈，这将让我们能够在不过多增加复杂性的情况下研究可穿戴设备和其伴侣应用之间的交互。
- en: Before we dive into the application code, it behooves us to cover a few concepts,
    tools, and API objects that are essential to our application. The intent here
    is to get you enough information to understand the core portions of the sample
    code. You can always come back and refer to this chapter and the documentation
    referenced in it.
  id: totrans-65
  prefs: []
  type: TYPE_NORMAL
  zh: 在我们深入应用程序代码之前，我们有必要介绍一些概念、工具和API对象，这些对于我们的应用程序至关重要。本意是提供足够的信息，让您理解示例代码的核心部分。您随时可以返回并参考本章以及其中引用的文档。
- en: The Wearable data layer API
  id: totrans-66
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 可穿戴数据层API
- en: Google Play services include a Wearable data layer API ([https://developer.android.com/training/wearables/data-layer/index.html](https://developer.android.com/training/wearables/data-layer/index.html)),
    through which your handheld and wearable apps may communicate with each other.
  id: totrans-67
  prefs: []
  type: TYPE_NORMAL
  zh: Google Play服务包括一个可穿戴数据层API ([https://developer.android.com/training/wearables/data-layer/index.html](https://developer.android.com/training/wearables/data-layer/index.html))，通过该API，您的手持设备和可穿戴应用可以相互通信。
- en: We encourage you to study the data layer API documentation located at the preceding
    page on Android developers site, but certain key data objects in the API deserve
    special attention.
  id: totrans-68
  prefs: []
  type: TYPE_NORMAL
  zh: 我们鼓励您研究位于前述页面的Android开发者网站上可穿戴数据层API文档，但API中的某些关键数据对象值得特别注意。
- en: MessageApi
  id: totrans-69
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: MessageApi
- en: This interface exposes methods for the wearables and handheld device to send
    messages to each other. Messages sent to connected network nodes (that is, paired
    devices) are queued for delivery. It is important to keep in mind that a message
    created by an application is private to that application and accessible only by
    that application running on other nodes.
  id: totrans-70
  prefs: []
  type: TYPE_NORMAL
  zh: 此接口公开了可穿戴设备和手持设备相互发送消息的方法。发送到连接的网络节点（即配对设备）的消息将排队等待发送。重要的是要记住，由应用程序创建的消息仅对该应用程序是私有的，并且只能由运行在其他节点上的该应用程序访问。
- en: WearableListenerService
  id: totrans-71
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: WearableListenerService
- en: This class should be extended by applications that expect to be notified of
    events while running in the background. Events include when a message is received,
    when data changes, and when nodes connect to or disconnect from the Android Wear
    network, which is the constantly shifting network of wearable devices and the
    handheld devices that they can connect to and/or interact with.
  id: totrans-72
  prefs: []
  type: TYPE_NORMAL
  zh: 此类应由希望在后台运行时接收事件通知的应用程序扩展。事件包括收到消息、数据变化以及节点连接到或断开与Android Wear网络（即不断变化的可穿戴设备和它们可以连接到或与之交互的手持设备网络）的连接。
- en: DataListener
  id: totrans-73
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: DataListener
- en: While the `WearableListenerService` class notifies applications while they run
    in the background, the `DataListener` interface notifies applications implementing
    it of data layer events while they run in the foreground.
  id: totrans-74
  prefs: []
  type: TYPE_NORMAL
  zh: 虽然`WearableListenerService`类在后台运行时通知应用程序，但`DataListener`接口在应用程序在前台运行时通知实现它的应用程序关于数据层事件。
- en: Cloud Node
  id: totrans-75
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: 云节点
- en: 'Along with all of the user''s connected devices (nodes), Google''s servers
    implicitly host a cloud node in the network of devices. The purpose of the cloud
    nodes is to synchronize data between directly connected devices. Changes to an
    application''s state on a handheld device are pushed to all of the user''s wearable
    devices and vice versa as depicted in the following figure:'
  id: totrans-76
  prefs: []
  type: TYPE_NORMAL
  zh: 除了所有用户的连接设备（节点）之外，Google的服务器在网络中隐式地托管一个云节点。云节点的作用是在直接连接的设备之间同步数据。手持设备上应用程序状态的变化会推送到所有用户的可穿戴设备，反之亦然，如下面的图所示：
- en: '![Cloud Node](img/image00180.jpeg)'
  id: totrans-77
  prefs: []
  type: TYPE_IMG
  zh: '![云节点](img/image00180.jpeg)'
- en: The GoogleApiClient class
  id: totrans-78
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: GoogleApiClient 类
- en: We need to create an instance of the `GoogleApiClient` class, any time you want
    to make a connection to one of the Google APIs provided in the Google Play services
    library. The Google API client provides a common entry point to all Google Play
    services and manages the network connection between the user's device and each
    Google service.
  id: totrans-79
  prefs: []
  type: TYPE_NORMAL
  zh: 每次您想要连接到Google Play服务库中提供的Google API之一时，都需要创建`GoogleApiClient`类的实例。Google API客户端为所有Google
    Play服务提供了一个共同的入口点，并管理用户设备与每个Google服务之间的网络连接。
- en: We use this class to let our mobile device connect to the Wearable API in the
    Google Play services library in order to get access to connected wearables.
  id: totrans-80
  prefs: []
  type: TYPE_NORMAL
  zh: 我们使用此类让我们的移动设备连接到Google Play服务库中的可穿戴API，以便访问连接的可穿戴设备。
- en: The Volley library
  id: totrans-81
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: Volley库
- en: We will be using Volley to fetch HTML content from Wikipedia. You can read all
    about this HTTP library on the developer's web page ([https://developer.android.com/training/volley/index.html](https://developer.android.com/training/volley/index.html)).
  id: totrans-82
  prefs: []
  type: TYPE_NORMAL
  zh: 我们将使用Volley从维基百科获取HTML内容。你可以在开发者的网页上阅读有关这个HTTP库的所有信息（[https://developer.android.com/training/volley/index.html](https://developer.android.com/training/volley/index.html)）。
- en: The JSoup library
  id: totrans-83
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: JSoup库
- en: The JSoup library ([https://jsoup.org](https://jsoup.org)) will be our preferred
    library to parse the HTML content feed that we pull from Wikipedia. Now, let's
    take a look at the code.
  id: totrans-84
  prefs: []
  type: TYPE_NORMAL
  zh: JSoup库([https://jsoup.org](https://jsoup.org))将是我们首选的库来解析我们从维基百科拉取的HTML内容源。现在，让我们看看代码。
- en: The Build Script
  id: totrans-85
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 构建脚本
- en: 'Study the dependencies specified in the `build.gradle` file of the mobile and
    companion apps respectively. Note how the mobile app''s `build.gradle` file has
    the additional dependencies for `Volley` and `JSoup` libraries. Remember that
    the companion app has to do the heavy lifting:'
  id: totrans-86
  prefs: []
  type: TYPE_NORMAL
  zh: 研究移动和伴随应用`build.gradle`文件中指定的依赖项。注意移动应用的`build.gradle`文件为`Volley`和`JSoup`库添加了额外的依赖项。记住，伴随应用必须承担繁重的工作：
- en: '[PRE0]'
  id: totrans-87
  prefs: []
  type: TYPE_PRE
  zh: '[PRE0]'
- en: Companion app's Android manifest file
  id: totrans-88
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 伴随应用的Android清单文件
- en: 'Please have a look at the `AndroidManifest.xml` fileof the companion app with
    a basic `TodayMobileActivity` and `HandheldListenerService` activities:'
  id: totrans-89
  prefs: []
  type: TYPE_NORMAL
  zh: 请查看伴随应用的基本`TodayMobileActivity`和`HandheldListenerService`活动的`AndroidManifest.xml`文件：
- en: '[PRE1]'
  id: totrans-90
  prefs: []
  type: TYPE_PRE
  zh: '[PRE1]'
- en: The TodayMobileActivity class
  id: totrans-91
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: '`TodayMobileActivity`类'
- en: 'The `TodayMobileActivity` class is a convenience activity at this time, intended
    only to connect to any existing wearable devices paired with the mobile device.
    We will be running the mobile/companion app target on a mobile device:'
  id: totrans-92
  prefs: []
  type: TYPE_NORMAL
  zh: '`TodayMobileActivity`类目前是一个便利活动，旨在仅连接到与移动设备配对的任何现有可穿戴设备。我们将运行移动/伴随应用的目标在移动设备上：'
- en: '[PRE2]'
  id: totrans-93
  prefs: []
  type: TYPE_PRE
  zh: '[PRE2]'
- en: 'Once we successfully connect with the wearable device, we should be able to
    see a confirmation that at least one device is connected, as shown in the following
    figure:'
  id: totrans-94
  prefs: []
  type: TYPE_NORMAL
  zh: 一旦我们成功连接到可穿戴设备，我们应该能够看到至少有一个设备已连接的确认，如下面的图所示：
- en: '![The TodayMobileActivity class](img/image00181.jpeg)'
  id: totrans-95
  prefs: []
  type: TYPE_IMG
  zh: '![The TodayMobileActivity class](img/image00181.jpeg)'
- en: Users can launch the `TodayMobileActivity` class to see if the devices are connected
    or not. If the value shown against Devices connected is not greater than zero,
    then the mobile device is not paired successfully, meaning it is not connected
    to the wearable device or emulator. We will be expanding this activity more in
    future chapters.
  id: totrans-96
  prefs: []
  type: TYPE_NORMAL
  zh: 用户可以启动`TodayMobileActivity`类来查看设备是否已连接。如果显示的“设备连接”值不大于零，则表示移动设备未成功配对，这意味着它未连接到可穿戴设备或模拟器。我们将在未来的章节中扩展此活动。
- en: Wearable app's Android manifest file
  id: totrans-97
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 可穿戴应用的Android清单文件
- en: 'Here is the `AndroidManifest.xml` file for the wearable app with the three
    activities for the menu items, such as the `TodayActivity`, `DayOfYearActivity`,
    and `OnThisDayActivity` activities:'
  id: totrans-98
  prefs: []
  type: TYPE_NORMAL
  zh: 这里是带有三个菜单项活动（如`TodayActivity`、`DayOfYearActivity`和`OnThisDayActivity`活动）的`AndroidManifest.xml`文件的可穿戴应用：
- en: '[PRE3]'
  id: totrans-99
  prefs: []
  type: TYPE_PRE
  zh: '[PRE3]'
- en: The OnThisDayActivity class
  id: totrans-100
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: '`OnThisDayActivity`类'
- en: The `OnThisDayActivity` class sends a message to the mobile device (that is,
    the companion app) using the `GoogleApiClient` API, saying that it needs to fetch
    content from Wikipedia.
  id: totrans-101
  prefs: []
  type: TYPE_NORMAL
  zh: '`OnThisDayActivity`类使用`GoogleApiClient` API向移动设备（即伴随应用）发送消息，表示它需要从维基百科获取内容。'
- en: 'Take note of the `onDataChanged` handler method defined in this activity. The `onDataChanged` method
    is the callback listener that gets processed when the companion app sends data
    packets back to the wearable device:'
  id: totrans-102
  prefs: []
  type: TYPE_NORMAL
  zh: 注意在此活动中定义的`onDataChanged`处理程序方法。`onDataChanged`方法是当伴随应用向可穿戴设备发送数据包时被处理的回调监听器：
- en: '[PRE4]'
  id: totrans-103
  prefs: []
  type: TYPE_PRE
  zh: '[PRE4]'
- en: The HandheldListenerService class
  id: totrans-104
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: '`HandheldListenerService`类'
- en: 'The `HandheldListenerService` class listens for messages coming from the wearable
    device. When a message is received, the `onMessageReceived` handler checks to
    see if the message is a request for content and if it is, it invokes a helper
    to read the feed and parse the response accordingly:'
  id: totrans-105
  prefs: []
  type: TYPE_NORMAL
  zh: '`HandheldListenerService`类监听来自可穿戴设备的消息。当接收到消息时，`onMessageReceived`处理程序会检查该消息是否为内容请求，如果是，则调用辅助程序读取源并相应地解析响应：'
- en: '[PRE5]'
  id: totrans-106
  prefs: []
  type: TYPE_PRE
  zh: '[PRE5]'
- en: As you can see, the code snippets provided here are incomplete and are intended
    only as a quick reference. You are encouraged to download and play with the latest
    code from GitHub.
  id: totrans-107
  prefs: []
  type: TYPE_NORMAL
  zh: 如你所见，这里提供的代码片段是不完整的，仅作为快速参考。我们鼓励你下载并尝试从GitHub获取最新的代码。
- en: 'If you run the app on your wearable device, this is what you will see:'
  id: totrans-108
  prefs: []
  type: TYPE_NORMAL
  zh: 如果你将应用运行在你的可穿戴设备上，你将看到以下内容：
- en: '![The HandheldListenerService class](img/image00182.jpeg)'
  id: totrans-109
  prefs: []
  type: TYPE_IMG
  zh: '![手持监听服务类](img/image00182.jpeg)'
- en: 'As you can see in the preceding screenshot, we show a *Toast* message while
    requesting to fetch *On This Day* content from Wikipedia using the handheld device''s
    companion app:'
  id: totrans-110
  prefs: []
  type: TYPE_NORMAL
  zh: 如您在前面的截图中所见，我们在使用手持设备的伴侣应用请求从维基百科获取“这一天”内容时显示了一个*Toast*消息：
- en: '![The HandheldListenerService class](img/image00183.jpeg)'
  id: totrans-111
  prefs: []
  type: TYPE_IMG
  zh: '![手持监听服务类](img/image00183.jpeg)'
- en: Note that in our `activity_on_this_day` XML layout, we nest our `TextView` layout
    within a `ScrollView` layout, which effectively allows us to scroll through all
    of our feed items. This begs a discussion of the UX aspects of wearable app development.
    We can certainly utilize better UI components to do what we just did. More on
    this in future chapters.
  id: totrans-112
  prefs: []
  type: TYPE_NORMAL
  zh: 注意，在我们的`activity_on_this_day` XML布局中，我们将`TextView`布局嵌套在`ScrollView`布局中，这有效地允许我们滚动查看所有内容项。这引发了对可穿戴应用开发UX方面的讨论。我们当然可以利用更好的UI组件来完成我们刚才所做的。更多内容将在未来的章节中介绍。
- en: Messages not coming through to your Wear app?
  id: totrans-113
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 消息未传达到您的穿戴应用？
- en: 'This can be frustrating, which is why we thought to mention it. If you see
    any synchronization issues whereby messages are not coming through to your wear
    application, check that the version of your Google Play services module matches
    between your companion app and wearable app `AndroidManifest.xml` files. Having
    different versions can lead to this sort of unexpected behavior and cost you hours
    in wasteful debugging. Consider the following screenshot of the Android Studio
    window:'
  id: totrans-114
  prefs: []
  type: TYPE_NORMAL
  zh: 这可能会让人感到沮丧，这就是我们提到它的原因。如果您看到任何同步问题，即消息未传达到您的穿戴应用，请检查您的Google Play服务模块版本是否在您的伴侣应用和可穿戴应用`AndroidManifest.xml`文件之间匹配。版本不匹配可能导致这种意外的行为，并让您浪费数小时进行无效的调试。考虑以下Android
    Studio窗口的截图：
- en: '![Messages not coming through to your Wear app?](img/image00184.jpeg)'
  id: totrans-115
  prefs: []
  type: TYPE_IMG
  zh: '![消息未传达到您的穿戴应用？](img/image00184.jpeg)'
- en: Summary
  id: totrans-116
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 摘要
- en: We described the need for a companion handheld app and stepped through creating
    an Android Wear virtual device and pairing a handheld device with it. We then
    created a new `Today` app that pulls content from a public feed page via the companion
    app and pushes results to the wearable device.
  id: totrans-117
  prefs: []
  type: TYPE_NORMAL
  zh: 我们描述了需要伴侣手持应用的需求，并逐步介绍了创建Android Wear虚拟设备和将手持设备与其配对的过程。然后我们创建了一个新的`Today`应用，该应用通过伴侣应用从公共内容页获取内容，并将结果推送到可穿戴设备。
- en: In the next chapter, we will introduce context-aware notifications and voice
    interactions, which power a rich user experience with Android Wear.
  id: totrans-118
  prefs: []
  type: TYPE_NORMAL
  zh: 在下一章中，我们将介绍上下文感知通知和语音交互，这些功能为Android Wear提供了丰富的用户体验。
