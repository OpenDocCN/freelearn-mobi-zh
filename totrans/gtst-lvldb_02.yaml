- en: Chapter 2. Installing LevelDB and Building for iOS
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: The basics of getting LevelDB downloaded and unpacked are the same as in the
    beginning of [Chapter 1](ch01.html "Chapter 1. Downloading LevelDB and Building
    with OS X"), *Downloading LevelDB and Building with OS X*, but we will be rebuilding
    the library and need to vary the build steps a bit for iOS. Building for iOS is
    referred to as **cross-compilation** as the code being generated is for a different
    processor architecture from that running the compiler.
  prefs: []
  type: TYPE_NORMAL
- en: Building the static LevelDB library for iOS
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: 'To start with, we are going to rebuild the `libleveldb.a` file. This time,
    we are building without snappy and building for multiple architectures: the 32
    bit x86 for the simulator and armv6 and armv7 for iOS devices. We''ll finish by
    renaming it for iOS.'
  prefs: []
  type: TYPE_NORMAL
- en: 'First up, remove snappy compression in a terminal in your snappy directory:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE0]'
  prefs: []
  type: TYPE_PRE
- en: 'Now change the directory back to your LevelDB source and clean, then try making
    for iOS. If you are using LevelDB 1.10, this will fail due to a bug in the makefile:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE1]'
  prefs: []
  type: TYPE_PRE
- en: Note
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
- en: The bug that occurs in LevelDB 1.10 is fixed in LevelDB 1.14.0
  prefs: []
  type: TYPE_NORMAL
- en: 'The makefile included with LevelDB v1.10 has a bug (logged as issue 177 [https://code.google.com/p/leveldb/issues/detail?id=177](https://code.google.com/p/leveldb/issues/detail?id=177)),
    because the command-line compilers moved after Xcode 4.3\. Apple moved these several
    times and so different vintages of open source projects run into this problem.
    You can grab the associated `MakefileASD` from the Packt Publishing website or
    edit a copy of makefile as described:'
  prefs: []
  type: TYPE_NORMAL
- en: 'Open makefile in a text editor and go down to the end where there is a section
    starting with:'
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: '[PRE2]'
  prefs:
  - PREF_IND
  type: TYPE_PRE
- en: 'You need to change the two lines starting with:'
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: '[PRE3]'
  prefs:
  - PREF_IND
  type: TYPE_PRE
- en: And just remove the `$(DEVICEROOT)/usr/bin/` so they start with `$(CC)` and
    `$(CXX)`.
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: 'Assuming you save this file as `MakefileASD`, you can repeat the make:'
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: '[PRE4]'
  prefs:
  - PREF_IND
  type: TYPE_PRE
- en: 'This generates and then copies the static library `libleveldb_IOS.a` with the
    standard C++11 libc++ library, instead of the default, so it matches a default
    Xcode project. If you look at the log, you will see the `lipo` command is used
    to combine binaries of different processor type. You can also use `lipo` to check
    a library:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE5]'
  prefs: []
  type: TYPE_PRE
- en: Lipo can inspect or operate on either individual object files or compiled libraries.
  prefs: []
  type: TYPE_NORMAL
- en: Creating a minimal iOS Testbed
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: To start with, we're going to create the simplest iOS program possible that
    can run and show feedback on the device. It will just display an alert to indicate
    we have made a database.
  prefs: []
  type: TYPE_NORMAL
- en: If you're keeping things together with a workspace, as recommended in an earlier
    chapter, open up that workspace in Xcode.
  prefs: []
  type: TYPE_NORMAL
- en: Now navigate to **File** | **New** | **Project…** which presents a template
    chooser. Choose an iOS application in the left panel and click on **Empty Application**
    in the icons provided, then click on **Next**. Leave the **Use Automatic Reference
    Counting** checkbox checked and uncheck **Include Unit Tests**. Make sure you
    specify the **Product Name** and **Company Identifier**. You will see as you type
    in those entries that the Bundle Identifier is being generated from them, for
    example, `Packt.LevelDB-iOS-Sample02`.
  prefs: []
  type: TYPE_NORMAL
- en: Click in the project navigator to select the **AppDelegate** (for example, `GSwLDBAppDelegate.m`)
    source. This is the only program source we're going to customize for this test.
  prefs: []
  type: TYPE_NORMAL
- en: 'For a simple test like this we just need to customize the method `application:
    didFinishLaunchingWithOptions` which initially contains:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE6]'
  prefs: []
  type: TYPE_PRE
- en: 'Before the `return` statement, add the lines:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE7]'
  prefs: []
  type: TYPE_PRE
- en: Choose one of the **Simulator** schemes from the pop-up near the **Run** button.
    And click on **Run** to compile and see the app run and show the little alert.
  prefs: []
  type: TYPE_NORMAL
- en: Adding LevelDB to the iOS Testbed
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: 'We basically repeat the steps done for the OS X project:'
  prefs: []
  type: TYPE_NORMAL
- en: Add the include paths to find the LevelDB headers, `/usr/local/include`, into
    the **User Header Search Paths**
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Add the library `/usr/local/lib/libleveldb_IOS.a` into the **Link Binary With
    Libraries** panel
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Add `/usr/local/lib` to the **Library Search Paths**
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: To include some C++ code into our Objective-C file we need to tell the compiler
    to treat it as Objective-C++ which is done by changing the file extension from
    `.m` to `.mm`. Click on the filename in the project navigator and hit *Enter*
    to be able to edit the name.
  prefs: []
  type: TYPE_NORMAL
- en: 'Now you can add the `#include` statements as we did in `Sample01`:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE8]'
  prefs: []
  type: TYPE_PRE
- en: 'Add the same database statements as we did in OS X, so the entire method looks
    like the following code:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE9]'
  prefs: []
  type: TYPE_PRE
- en: You can again click on **Run** and see that this runs within the simulator.
    After it runs, go and have a look in the directory `/tmp/testdbios` and you will
    see your files created there. However, this works only because the simulator is
    running with full access to your OS X filesystem. You can't create files in arbitrary
    directories in this way on an iOS device.
  prefs: []
  type: TYPE_NORMAL
- en: 'Plug in a registered iOS device and change the **Scheme** to point to that
    device so you can run on the device. Now run the application. You will see the
    application appear but not the expected alert. The Xcode **Output** window shows
    an error message like:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE10]'
  prefs: []
  type: TYPE_PRE
- en: This is because the app can't access the path `/tmp`. The iOS filesystem is
    guarded with a **sandbox** for every application and within that are some directories
    with different significance to the OS. Some are caches that can be flushed without
    your application being told if space runs low. Some are synchronized to iCloud.
  prefs: []
  type: TYPE_NORMAL
- en: For now, we will put our data into the standard cache area `NSCachesDirectory`
    (which currently maps to `Library/Caches`). This is for temporary data and may
    be flushed.
  prefs: []
  type: TYPE_NORMAL
- en: 'Add the following helper method earlier in your `GSwLDBAppDelegate.mm` source
    file:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE11]'
  prefs: []
  type: TYPE_PRE
- en: 'Now fix our database opening code, replacing the line:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE12]'
  prefs: []
  type: TYPE_PRE
- en: 'With these two lines, which use our helper to find the cache directory:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE13]'
  prefs: []
  type: TYPE_PRE
- en: 'Running on the device now will work and show the alert. Running on the simulator
    still works but is putting the file in a location that will vary. If you put a
    breakpoint on the last line you can see the value of `tempPath` in the debugger
    on a device, which will appear as:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE14]'
  prefs: []
  type: TYPE_PRE
- en: 'But in the simulator, it''s an absolute path on your desktop, like:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE15]'
  prefs: []
  type: TYPE_PRE
- en: In this path, the simulator type varies and the next directory down is the iOS
    version, then eventually the library directory from which it's the same as on
    a device.
  prefs: []
  type: TYPE_NORMAL
- en: Summary
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: Once again we built the LevelDB static library and learned how to choose a different
    standard C++ library to match Xcode's defaults. Creating a trivial iOS application,
    we were able to link it with a LevelDB library suitable for both simulator and
    iOS devices. We then saw how that runs in the simulator compared to the sandboxed
    filesystem of a device.
  prefs: []
  type: TYPE_NORMAL
