<html><head></head><body><div class="chapter" title="Chapter&#xA0;3.&#xA0;Bluetooth Weather Station"><div class="titlepage"><div><div><h1 class="title"><a id="ch03"/>Chapter 3. Bluetooth Weather Station</h1></div></div></div><p>In this chapter, we will build the first complete application of this book using Arduino and Android. We will build a small weather station using Arduino, which will be accessed by an Android app via Bluetooth.</p><p>On the Arduino side, we <a id="id135" class="indexterm"/>will build a simple weather station using a temperature and humidity sensor along with an ambient light-level sensor. We will connect a <span class="strong"><strong>Bluetooth Low Energy</strong></span> (<span class="strong"><strong>BLE</strong></span>)<a id="id136" class="indexterm"/> module to the project so that the Android phone can access the measurements wirelessly.</p><p>We will develop a simple Android app with an interface that allows us to:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">Access all the measurements performed by the weather station with the tap of a button</li><li class="listitem" style="list-style-type: disc">Display each measurement within an enlarged text view</li></ul></div><div class="section" title="Hardware and software requirements"><div class="titlepage"><div><div><h1 class="title"><a id="ch03lvl1sec19"/>Hardware and software requirements</h1></div></div></div><p>The first <a id="id137" class="indexterm"/>thing you will need for this project is an Arduino Uno board.</p><p>Then, you need a BLE module. We <a id="id138" class="indexterm"/>chose the Adafruit nRF8001 chip because it comes with a nice Arduino library, and it already has existing examples of Android apps to control the module. This is the same module that we used in the previous chapter.</p><p>For the sensors, I chose a DHT11 sensor to measure the temperature and the ambient humidity. DHT11 is a digital temperature and humidity sensor that is really easy to integrate with Arduino. There are several solutions available for Arduino, but this sensor was chosen because it is one of the easiest to interface with Arduino. To make the sensor work with Arduino, we will also need a 4.7K Ohm resistor.</p><p>We will also use a photocell in series with a 10K Ohm resistor to measure the ambient light level. The photocell is basically a resistor that will change its resistance depending on the incoming light <a id="id139" class="indexterm"/>on <a id="id140" class="indexterm"/>the cell. It will be connected to the Arduino analog input to measure the ambient light level.</p><p>Finally, you will need a breadboard and some jumper wires to make the different connections.</p><p>The following is a list of all hardware parts you will need for this project, along with links to find these parts on the Web:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">The <a id="id141" class="indexterm"/>Arduino Uno board (<a class="ulink" href="http://www.adafruit.com/product/50">http://www.adafruit.com/product/50</a>)</li><li class="listitem" style="list-style-type: disc">The<a id="id142" class="indexterm"/> DHT11 sensor and <a id="id143" class="indexterm"/>4.7K Ohm resistor (<a class="ulink" href="https://www.adafruit.com/products/386">https://www.adafruit.com/products/386</a>)</li><li class="listitem" style="list-style-type: disc">The photocell<a id="id144" class="indexterm"/> (<a class="ulink" href="https://www.sparkfun.com/products/9088">https://www.sparkfun.com/products/9088</a>)</li><li class="listitem" style="list-style-type: disc">The <a id="id145" class="indexterm"/>10K Ohm resistor (<a class="ulink" href="https://www.sparkfun.com/products/8374">https://www.sparkfun.com/products/8374</a>)</li><li class="listitem" style="list-style-type: disc">Adafruit nRF8001 breakout board<a id="id146" class="indexterm"/> (<a class="ulink" href="https://www.adafruit.com/products/1697">https://www.adafruit.com/products/1697</a>)</li><li class="listitem" style="list-style-type: disc">The breadboard<a id="id147" class="indexterm"/> (<a class="ulink" href="https://www.adafruit.com/product/64">https://www.adafruit.com/product/64</a>)</li><li class="listitem" style="list-style-type: disc">Jumper wires<a id="id148" class="indexterm"/> (<a class="ulink" href="https://www.adafruit.com/product/758">https://www.adafruit.com/product/758</a>)</li></ul></div><p>On the software side, you will need the Arduino IDE as usual, and the <a id="id149" class="indexterm"/>Arduino aREST library, which is found at <a class="ulink" href="https://github.com/marcoschwartz/aREST/">https://github.com/marcoschwartz/aREST/</a>.</p><p>The photocell make measurements from the <a id="id150" class="indexterm"/>DHT11 sensor, you will need the DHT library found at <a class="ulink" href="https://github.com/adafruit/DHT-sensor-library">https://github.com/adafruit/DHT-sensor-library</a>.</p><p>For the BLE chip, you will also need the <a id="id151" class="indexterm"/>nRF8001 Arduino library found at <a class="ulink" href="https://github.com/adafruit/Adafruit_nRF8001">https://github.com/adafruit/Adafruit_nRF8001</a>.</p><p>To install a given library, simply extract the folder in your <code class="literal">Arduino /libraries</code> folder (or create this folder if it doesn't exist yet).</p><div class="section" title="Hardware configuration"><div class="titlepage"><div><div><h2 class="title"><a id="ch03lvl2sec20"/>Hardware configuration</h2></div></div></div><p>We will now build the hardware <a id="id152" class="indexterm"/>for this project. To help you out, here is a schematic of the project:</p><div class="mediaobject"><img src="graphics/0389OS_03_01.jpg" alt="Hardware configuration"/></div><p>Now, we will <a id="id153" class="indexterm"/>perform the following steps:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">The first step is to place the Bluetooth module, the DHT11 sensor, and the photocell on the breadboard.</li><li class="listitem">Then, connect the power supply from the Arduino board to the breadboard: 5V of the Arduino board goes to the red power rail, and <span class="strong"><strong>GND</strong></span> goes to the blue power rail.</li><li class="listitem">We will now connect the BLE module. First, connect the power supply of the module: <span class="strong"><strong>GND</strong></span> goes to the blue power rail, and <span class="strong"><strong>VIN</strong></span> goes to the red power rail.</li><li class="listitem">After that, you need to connect the different wires responsible for the SPI interface: <span class="strong"><strong>SCK</strong></span> to Arduino pin <span class="strong"><strong>13</strong></span>, <span class="strong"><strong>MISO</strong></span> to Arduino pin <span class="strong"><strong>12</strong></span>, and <span class="strong"><strong>MOSI</strong></span> to Arduino pin <span class="strong"><strong>11</strong></span>.</li><li class="listitem">Then, connect the <span class="strong"><strong>REQ</strong></span> pin to Arduino pin <span class="strong"><strong>10</strong></span>. Finally, connect the <span class="strong"><strong>RDY</strong></span> pin to Arduino pin <span class="strong"><strong>2</strong></span>, and the <span class="strong"><strong>RST</strong></span> pin to Arduino pin <span class="strong"><strong>9</strong></span>.<p>For the DHT sensor, this is the function of each pin on the sensor:</p><div class="mediaobject"><img src="graphics/0389OS_03_02.jpg" alt="Hardware configuration"/></div></li><li class="listitem">You need to first connect the power supply: the <span class="strong"><strong>VCC</strong></span> pin goes to the red power rail on the breadboard, and the <span class="strong"><strong>GND</strong></span> pin goes to the blue power rail.</li><li class="listitem">You also <a id="id154" class="indexterm"/>need to connect the <span class="strong"><strong>DATA</strong></span> pin to pin number <span class="strong"><strong>7</strong></span> of the Arduino board.</li><li class="listitem">Finally, place the 4.7K Ohm resistor between the <span class="strong"><strong>VCC</strong></span> and the <span class="strong"><strong>DATA</strong></span> pin of the sensor.</li><li class="listitem">For the photocell, connect the 10K Ohm resistor in series with the photocell. This means that one pin of the photocell should be in contact (on the same row on the breadboard) with one pin of the resistor.</li><li class="listitem">Then, connect the other pin of the resistor to the blue power rail, and the other pin of the photocell to the red power rail of the breadboard.</li><li class="listitem">Finally, connect the common pin between the photocell and resistor to the analog pin <span class="strong"><strong>A0</strong></span> of the Arduino board.<p>This is an image of the completely assembled project:</p><div class="mediaobject"><img src="graphics/0389OS_03_03.jpg" alt="Hardware configuration"/></div></li></ol></div></div><div class="section" title="Testing the sensors"><div class="titlepage"><div><div><h2 class="title"><a id="ch03lvl2sec21"/>Testing the sensors</h2></div></div></div><p>We will now write a<a id="id155" class="indexterm"/> simple Arduino sketch to test all the sensors of the project. This will ensure that all the connections were made correctly before writing our Android app using Bluetooth. This is the complete sketch for testing the sensors:</p><div class="informalexample"><pre class="programlisting">#include "DHT.h"

// DHT sensor
#define DHTPIN 7
#define DHTTYPE DHT11

// DHT instance
DHT dht(DHTPIN, DHTTYPE);

void setup()
{
  // Initialize the Serial port
  Serial.begin(9600);
  
  // Init DHT
  dht.begin();
}

void loop()
{
  // Measure from DHT
  float temperature = dht.readTemperature();
  float humidity = dht.readHumidity();
  
  // Measure light level
  float sensor_reading = analogRead(A0);
  float light = sensor_reading/1024*100;
  
  // Display temperature
  Serial.print("Temperature: ");
  Serial.print((int)temperature);
  Serial.println(" C");
  
   // Display humidity
  Serial.print("Humidity: ");
  Serial.print(humidity);
  Serial.println("%");
  
  // Display light level
  Serial.print("Light: ");
  Serial.print(light);
  Serial.println("%");
  Serial.println("");
  
  // Wait 500 ms
  delay(500);
  
}</pre></div><p>Let's now <a id="id156" class="indexterm"/>look at this sketch in more detail. It starts by including the DHT11 library:</p><div class="informalexample"><pre class="programlisting">#include "DHT.h"</pre></div><p>We also declare that the sensor is attached to pin number 7, and that the DHT sensor we are using is a DHT11 sensor by declaring constants:</p><div class="informalexample"><pre class="programlisting">#define DHTPIN 7 

#define DHTTYPE DHT11</pre></div><p>After that, we can declare an instance of the DHT sensor:</p><div class="informalexample"><pre class="programlisting">DHT dht(DHTPIN, DHTTYPE);</pre></div><p>In the <code class="literal">setup()</code> function of the sketch, we will start the serial communications:</p><div class="informalexample"><pre class="programlisting">Serial.begin(9600);</pre></div><p>We will also initialize the DHT sensor:</p><div class="informalexample"><pre class="programlisting">dht.begin();</pre></div><p>In the <code class="literal">loop()</code> function of the sketch, we will perform the temperature and humidity measurements from the sensor:</p><div class="informalexample"><pre class="programlisting">float temperature = dht.readTemperature();
float humidity = dht.readHumidity();</pre></div><p>We will also <a id="id157" class="indexterm"/>read out from the photocell, and convert this reading to a percentage of illumination. To do so, we must know that the analog input of the Arduino returns a value going from 0 to 1,023 (10 bits). Therefore, we need to divide the reading from the input by 1,023. Then, to get a result in percent, we will multiply this value by 100:</p><div class="informalexample"><pre class="programlisting">float sensor_reading = analogRead(A0);
float light = sensor_reading/1024*100;</pre></div><p>When the measurements are done, we print out the value of each of them on the serial port so that we can visualize the data. This is for example the code that prints out the temperature:</p><div class="informalexample"><pre class="programlisting">Serial.print("Temperature: ");
Serial.print((int)temperature);
Serial.println(" C");</pre></div><p>We will also repeat each <code class="literal">loop()</code> function every 500 ms:</p><div class="informalexample"><pre class="programlisting">delay(500);</pre></div><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="note04"/>Note</h3><p>Note that all the<a id="id158" class="indexterm"/> code for this chapter can be found inside the GitHub repository of the book at <a class="ulink" href="https://github.com/marcoschwartz/arduino-android-blueprints">https://github.com/marcoschwartz/arduino-android-blueprints</a>.</p></div></div><p>It's now time to test this simple Arduino sketch to check if our sensors are working. Upload the sketch to the Arduino board, and open the serial monitor (making sure the serial speed is set to 9,600). You should get a similar result inside the serial monitor, depending on your surroundings:</p><div class="informalexample"><pre class="programlisting">Temperature: 26 C
Humidity: 35%
Light: 75.42%</pre></div></div></div></div>
<div class="section" title="Writing the Arduino sketch"><div class="titlepage"><div><div><h1 class="title"><a id="ch03lvl1sec20"/>Writing the Arduino sketch</h1></div></div></div><p>Now that <a id="id159" class="indexterm"/>we know that our <a id="id160" class="indexterm"/>sensors are working correctly, we can write the final sketch that allows the Arduino board to be accessed by the Android application we will write later on. The following is the complete sketch for this part:</p><div class="informalexample"><pre class="programlisting">// Control Arduino board from BLE

// Enable lightweight
#define LIGHTWEIGHT 1

// Libraries
#include &lt;SPI.h&gt;
#include "Adafruit_BLE_UART.h"
#include &lt;aREST.h&gt;
#include "DHT.h"

// Pins
#define ADAFRUITBLE_REQ 10
#define ADAFRUITBLE_RDY 2
#define ADAFRUITBLE_RST 9

// DHT sensor
#define DHTPIN 7
#define DHTTYPE DHT11

// DHT instance
DHT dht(DHTPIN, DHTTYPE);

// Create aREST instance
aREST rest = aREST();

// BLE instance
Adafruit_BLE_UART BTLEserial = Adafruit_BLE_UART(ADAFRUITBLE_REQ, ADAFRUITBLE_RDY, ADAFRUITBLE_RST);

// Variables to be exposed to the API
int temperature;
int humidity;
int light;

void setup(void)
{  
  // Start Serial
  Serial.begin(9600);

  // Start BLE
  BTLEserial.begin();
 
  // Give name and ID to device
  rest.set_id("001");
  rest.set_name("weather_station");
  
  // Expose variables to API
  rest.variable("temperature",&amp;temperature);
  rest.variable("humidity",&amp;humidity);
  rest.variable("light",&amp;light);
  
   // Init DHT
  dht.begin();
  
  // Welcome message
  Serial.println("Weather station started");
}

void loop() {  
  
  // Measure from DHT
  float t = dht.readTemperature();
  float h = dht.readHumidity();
  temperature = (int)t;
  humidity = (int)h;

  // Measure light level
  float sensor_reading = analogRead(A0);
  light = (int)(sensor_reading/1024*100);
  
  // Tell the nRF8001 to do whatever it should be working on.
  BTLEserial.pollACI();
  
  // Ask what is our current status
  aci_evt_opcode_t status = BTLEserial.getState();
  
  // Handle REST calls
  if (status == ACI_EVT_CONNECTED) {
    rest.handle(BTLEserial);
  }
 }</pre></div><p>Now, let's<a id="id161" class="indexterm"/> look at this sketch in more detail. Some<a id="id162" class="indexterm"/> of the parts are similar to the sketch we saw earlier to test the sensor; we will not detail these parts again. It starts by declaring that we want to use the lightweight mode of the aREST library:</p><div class="informalexample"><pre class="programlisting">#define LIGHTWEIGHT 1</pre></div><p>Then, we will define that we want to use the library for the Bluetooth chip, the aREST library, and the library for the DHT sensor:</p><div class="informalexample"><pre class="programlisting">#include &lt;SPI.h&gt;
#include "Adafruit_BLE_UART.h"
#include &lt;aREST.h&gt;
#include "DHT.h"</pre></div><p>After this, we will define the pins on which we connected the BLE module:</p><div class="informalexample"><pre class="programlisting">#define ADAFRUITBLE_REQ 10
#define ADAFRUITBLE_RDY 2    
#define ADAFRUITBLE_RST 9</pre></div><p>We need to create an instance of the aREST library:</p><div class="informalexample"><pre class="programlisting">aREST rest = aREST();</pre></div><p>We also need to create an instance of the BLE module:</p><div class="informalexample"><pre class="programlisting">Adafruit_BLE_UART BTLEserial = Adafruit_BLE_UART(ADAFRUITBLE_REQ, ADAFRUITBLE_RDY, ADAFRUITBLE_RST);</pre></div><p>Just before the <code class="literal">setup()</code> function of the sketch, we will declare the following three variables that contain the measurements coming from the sensor:</p><div class="informalexample"><pre class="programlisting">int temperature;
int humidity;
int light;</pre></div><p>Then, in the <code class="literal">setup()</code> function of the sketch, we will initialize the BLE module:</p><div class="informalexample"><pre class="programlisting">BTLEserial.begin();</pre></div><p>After that, we will set an ID and a name for our project:</p><div class="informalexample"><pre class="programlisting">rest.set_id("001");
rest.set_name("weather_station");</pre></div><p>We also have to <a id="id163" class="indexterm"/>expose the different measurement variables to the aREST API so that they can be accessed by the Android app:</p><div class="informalexample"><pre class="programlisting">rest.variable("temperature",&amp;temperature);
rest.variable("humidity",&amp;humidity);
rest.variable("light",&amp;light);</pre></div><p>In the <code class="literal">loop()</code> function <a id="id164" class="indexterm"/>of the sketch, we will poll the status of the BLE module:</p><div class="informalexample"><pre class="programlisting">BTLEserial.pollACI();</pre></div><p>We will also get the state of the module and store it in a variable:</p><div class="informalexample"><pre class="programlisting">aci_evt_opcode_t status = BTLEserial.getState();</pre></div><p>If this status indicates that the Bluetooth module is connected to another device, we will process the incoming request with the aREST library:</p><div class="informalexample"><pre class="programlisting">if (status == ACI_EVT_CONNECTED) {
    rest.handle(BTLEserial);
}</pre></div><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="note05"/>Note</h3><p>Note that all<a id="id165" class="indexterm"/> the code for this chapter can be found inside the GitHub repository of the book at <a class="ulink" href="https://github.com/marcoschwartz/arduino-android-blueprints">https://github.com/marcoschwartz/arduino-android-blueprints</a>.</p></div></div><p>It's now time to upload the sketch to your Arduino board. When this is done, you can move on to the development of the Android app to control the Arduino board via the BLE sketch.</p><div class="section" title="Wireframing our Android application and modifying the layout files"><div class="titlepage"><div><div><h2 class="title"><a id="ch03lvl2sec22"/>Wireframing our Android application and modifying the layout files</h2></div></div></div><p>We will <a id="id166" class="indexterm"/>start off our <a id="id167" class="indexterm"/>BLE weather station project by creating a new project in Android Studio with a blank activity.</p><p>We will target our project for a minimum SDK of 18 and a maximum SDK of 19.</p><p>We will first start off by drawing a paper prototype of how our application will work and the basic user flow, as <a id="id168" class="indexterm"/>shown in the <a id="id169" class="indexterm"/>following image. This will help us understand how the application will work as well as facilitating our development process.</p><div class="mediaobject"><img src="graphics/0389OS_03_04.jpg" alt="Wireframing our Android application and modifying the layout files"/></div><p>Upon analyzing the preceding image, we can see that this design will require two <code class="literal">TextView</code> objects. The upper <code class="literal">TextView</code> object will show all the Bluetooth callbacks, state changes, and characteristics written to the BLE module, while the lower <code class="literal">TextView</code> object will show the output from the temperature, light, and humidity sensor depending on which button was tapped.</p><p>The <code class="literal">TextView</code> objects<a id="id170" class="indexterm"/> will give them the following IDs:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><code class="literal">connectionStatusView</code></li><li class="listitem" style="list-style-type: disc"><code class="literal">dataOutputTextView</code></li></ul></div><p>In the lower part of the layout, we will have three buttons reflecting the three parameters that we will be requesting, that is, temperature, light, and humidity. We will name the buttons as<a id="id171" class="indexterm"/> follows:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">The temperature button will be named as follows:<div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>Text</strong></span>: <code class="literal">Temperature</code></li><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>ID</strong></span>: <code class="literal">temperatureButton</code></li></ul></div></li><li class="listitem" style="list-style-type: disc">The humidity button will be named as follows:<div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>Text</strong></span>: <code class="literal">Humidity</code></li><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>ID</strong></span>: <code class="literal">humidityButton</code></li></ul></div></li><li class="listitem" style="list-style-type: disc">The light <a id="id172" class="indexterm"/>button will be named as follows:<div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>Text</strong></span>: <code class="literal">Light</code></li><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>ID</strong></span>: <code class="literal">lightButton</code></li></ul></div></li></ul></div></div><div class="section" title="Implementing Android layouts in the main activity"><div class="titlepage"><div><div><h2 class="title"><a id="ch03lvl2sec23"/>Implementing Android layouts in the main activity</h2></div></div></div><p>Before we <a id="id173" class="indexterm"/>embark on this project, we will enable the <code class="literal">Auto-Import</code> function, which will enable us to compile our project even more effectively and gives us one thing less to worry about.</p><p>You can enable <code class="literal">Auto-Import</code> by going to the <span class="strong"><strong>Preferences</strong></span> option and selecting all the available options. The <span class="strong"><strong>Auto-Import</strong></span> preferences are available on Mac and Windows as follows:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">On a Mac, navigate to <span class="strong"><strong>Android Studio</strong></span> &gt; <span class="strong"><strong>Preferences</strong></span> &gt; <span class="strong"><strong>Editor</strong></span> &gt; <span class="strong"><strong>Auto-Import</strong></span></li><li class="listitem" style="list-style-type: disc">On Windows, navigate to <span class="strong"><strong>File</strong></span> &gt; <span class="strong"><strong>Settings</strong></span> &gt; <span class="strong"><strong>Editor</strong></span> &gt; <span class="strong"><strong>Auto-Import</strong></span></li></ul></div><p>With all the necessary settings in place, we will first start off by creating a new project, where we will choose the following within the <span class="strong"><strong>New Project</strong></span> setup:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>Name</strong></span>: <code class="literal">Bluetooth Weather Station</code></li><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>Minimum SDK</strong></span>: <code class="literal">18</code></li><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>Project</strong></span>: <code class="literal">Blank Activity</code></li><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>Activity Name</strong></span>: <code class="literal">MainActivity</code></li><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>Domain</strong></span>: <code class="literal">arduinoandroid.com</code></li></ul></div><p>We will build on our previous project in <a class="link" href="ch02.html" title="Chapter 2. Controlling an Arduino Board via Bluetooth">Chapter 2</a>, <span class="emphasis"><em>Controlling an Arduino Board via Bluetooth</em></span>, that is, the Arduino BLE Android project will start off by importing the <code class="literal">arduinoBLE</code> project from the Github repository and clone it to our desktop or download it as a ZIP file as explained in <a class="link" href="ch02.html" title="Chapter 2. Controlling an Arduino Board via Bluetooth">Chapter 2</a>, <span class="emphasis"><em>Controlling an Arduino Board via Bluetooth</em></span>.</p><p>Once imported, we will open <code class="literal">MainActivity.java</code>, select all the code below the <code class="literal">import</code> statement and copy it. When all the code has been copied, we will open our current project (Android Bluetooth Weather Station), go into <code class="literal">MainActivity.java</code>, delete all the code below the <code class="literal">import</code> statement, and paste the code.</p><p>In case you get <a id="id174" class="indexterm"/>stuck at this stage of the project, our code will be available in the repository in two stages, the version with all the necessary code that needs to be modified and the completed project. These are all available in the GitHub repository at <a class="ulink" href="https://github.com/marcoschwartz/arduino-android-blueprints">https://github.com/marcoschwartz/arduino-android-blueprints</a>.</p><p>Once the code is in our project, we will proceed by changing references to the UI elements to reflect our latest additions to the Android layout file in the <code class="literal">onCreate()</code> method:</p><div class="informalexample"><pre class="programlisting">dataOutput = (TextView) findViewById(R.id.dataOutputTextView);
connectionOutput = (TextView) findViewById(R.id.connectionStatusView);

adapter = BluetoothAdapter.getDefaultAdapter();
temperature = (Button) findViewById(R.id.temperatureButton);
light = (Button) findViewById(R.id.lightButton);
humidity = (Button) findViewById(R.id.humidityButton);</pre></div><p>In this project, we will modify <code class="literal">onClickListeners</code> to connect to the buttons that we have included in the Android layout file:</p><div class="informalexample"><pre class="programlisting">temperature.setOnClickListener(new View.OnClickListener() {
            public void onClick(View v) {
                String setTempMessage = "/temperature /";
                tx.setValue(setTempMessage.getBytes(Charset.forName("UTF-8")));
                if (gatt.writeCharacteristic(tx)) {
                    writeLine("Sent: " + setTempMessage);
                } else {
                    writeLine("Couldn't write TX characteristic!");
                }

            }
        });

        light.setOnClickListener(new View.OnClickListener() {
            public void onClick(View v) {
                String setLightMessage = "/light /";
                tx.setValue(setLightMessage.getBytes(Charset.forName("UTF-8")));
                if (gatt.writeCharacteristic(tx)) {
                    writeLine("Sent: " + setLightMessage);
                }
                else {
                    writeLine("Couldn't write TX characteristic!");
                }
            }
        });

        humidity.setOnClickListener(new View.OnClickListener() {
            public void onClick(View v) {
                String setHumidityMessage = "/humidity /";
                tx.setValue(setHumidityMessage.getBytes(Charset.forName("UTF-8")));
                if (gatt.writeCharacteristic(tx)) {
                    writeLine("Sent: " + setHumidityMessage);
                }
                else {
                    writeLine("Couldn't write TX characteristic!");
                }
            }
        });</pre></div><p>We will also modify the <a id="id175" class="indexterm"/>code that deals with writing <code class="literal">remoteCharacteristics</code>, namely, the <code class="literal">writeLine()</code> method, and in addition, we will add another method known as <code class="literal">writeSensorData()</code>, which will deal with the remote data arriving from our different sensors:</p><div class="informalexample"><pre class="programlisting">private void writeLine(final CharSequence text) {
        runOnUiThread(new Runnable() {
            @Override
            public void run() {
                connectionOutput.setText("");
                connectionOutput.append(text);
                connectionOutput.append("\n");
            }
        });
    }

    //Implement the method below to output temperature/humidity/light readings to dataOutputView

    private void writeSensorData(final CharSequence text) {
        runOnUiThread(new Runnable() {
            @Override
            public void run() {
                Log.e(LOG_TAG,text.toString());
                output=text.toString().trim();
                if (output.length() &gt; 0 &amp;&amp; output.length() &lt;=3) {

                    dataOutput.setText(output);
                }
                else {
                    return;
                }
            }
        });
    }</pre></div><p>Before we are able to<a id="id176" class="indexterm"/> move ahead with compiling the project, we need to work on the <code class="literal">onCharacteristicChanged</code> method so that the data that is received from the sensor data will be set to the <code class="literal">dataOutput</code> text view:</p><div class="informalexample"><pre class="programlisting">public void onCharacteristicChanged(BluetoothGatt gatt, BluetoothGattCharacteristic characteristic) {
            super.onCharacteristicChanged(gatt, characteristic);
            writeSensorData(characteristic.getStringValue(0));
        }</pre></div><p>At this point in time, the project will be unable to function as the necessary permissions have not been implemented yet. User permissions are necessary as it allows the application to access different capabilities of the device. In this case, we will need to add the following two permissions within the <code class="literal">AndroidManifest.xml</code> file, which you will find by navigating to <code class="literal">app</code> &gt; <code class="literal">src</code> &gt; <code class="literal">main</code> &gt; <code class="literal">AndroidManifest.xml</code>:</p><div class="informalexample"><pre class="programlisting">&lt;uses-permission android:name="android.permission.BLUETOOTH"/&gt;
      &lt;uses-permission android:name="android.permission.BLUETOOTH_ADMIN"/&gt;</pre></div><p>When we perform all these changes, we should expect the rudimentary user interface to look as follows, with the sensor data showing up after tapping on the different parameters:</p><div class="mediaobject"><img src="graphics/0389OS_03_05.jpg" alt="Implementing Android layouts in the main activity"/></div></div></div>
<div class="section" title="Enhancing the user interface"><div class="titlepage"><div><div><h1 class="title"><a id="ch03lvl1sec21"/>Enhancing the user interface</h1></div></div></div><p>The current user interface requires <a id="id177" class="indexterm"/>further enhancements to make it user friendly. One can easily notice that the sensor data output <a id="id178" class="indexterm"/>needs to be enlarged and centered and the buttons can definitely be more attractive. Also, we want to make sure that our Weather Station app stands out from the user's current list of apps, so our app would definitely benefit from a change in the icon.</p><p>We will work on the following main tasks:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">Creating and adding our very own Android app icon</li><li class="listitem" style="list-style-type: disc">Centering and enlarging the data output text</li><li class="listitem" style="list-style-type: disc">Modifying the buttons and adding some color to our text</li></ul></div><div class="section" title="Creating and adding our very own app icon"><div class="titlepage"><div><div><h2 class="title"><a id="ch03lvl2sec24"/>Creating and adding our very own app icon</h2></div></div></div><p>One of our very<a id="id179" class="indexterm"/> first steps<a id="id180" class="indexterm"/> to enhance the user experience is to have our very own icon.</p><p>First, we will start off by<a id="id181" class="indexterm"/> downloading the image asset. This is available publicly at <a class="ulink" href="http://bit.ly/chapter3-iclauncher">http://bit.ly/chapter3-iclauncher</a>.</p><p>You should navigate using the project tree, followed by a right-click on <code class="literal">app</code>, as shown in the following screenshot:</p><div class="mediaobject"><img src="graphics/0389OS_03_06.jpg" alt="Creating and adding our very own app icon"/></div><p>After you right-click on <code class="literal">app</code>, create a new image asset by going to <span class="strong"><strong>New</strong></span> &gt; <span class="strong"><strong>Image Asset</strong></span>, as shown in the following screenshot:</p><div class="mediaobject"><img src="graphics/0389OS_03_07.jpg" alt="Creating and adding our very own app icon"/></div><p>You will then be shown an <span class="strong"><strong>Asset Studio</strong></span> pop-up window, which will allow you to choose your very <a id="id182" class="indexterm"/>own image file. For <a id="id183" class="indexterm"/>optimization purposes, we recommend going for a <code class="literal">.png</code> file with a resolution of 144 pixels by 144 pixels. Android Studio automatically does all the resizing and resource creation to adapt your graphic to different screens, as shown in the following screenshot:</p><div class="mediaobject"><img src="graphics/0389OS_03_08.jpg" alt="Creating and adding our very own app icon"/></div><p>Once you <a id="id184" class="indexterm"/>choose <a id="id185" class="indexterm"/>the <code class="literal">ic_launcher</code> image file, which we have provided you with, you will be shown a screen with the icon in different sizes. Click on <span class="strong"><strong>Next</strong></span>, where you will see the following screen:</p><div class="mediaobject"><img src="graphics/0389OS_03_09.jpg" alt="Creating and adding our very own app icon"/></div><p>The preceding <a id="id186" class="indexterm"/>screen warns you that previous files will be overwritten and shows you the image launcher file <a id="id187" class="indexterm"/>in a number of different resolutions once again. Click on <span class="strong"><strong>Finish</strong></span>, then compile the app, launch it on your physical device, and you should see something as pleasant as the following in your app tray and in the app's action bar:</p><div class="mediaobject"><img src="graphics/0389OS_03_10.jpg" alt="Creating and adding our very own app icon"/></div><p>Here's what<a id="id188" class="indexterm"/> the <a id="id189" class="indexterm"/>app's action bar will look like:</p><div class="mediaobject"><img src="graphics/0389OS_03_11.jpg" alt="Creating and adding our very own app icon"/></div></div><div class="section" title="Centering and enlarging the data output text"><div class="titlepage"><div><div><h2 class="title"><a id="ch03lvl2sec25"/>Centering and enlarging the data output text</h2></div></div></div><p>In order to<a id="id190" class="indexterm"/> edit the layout <a id="id191" class="indexterm"/>for the main text output where the sensor data will be shown, we will need to open the project tree and navigate towards the layout file, which is available at <code class="literal">app</code> &gt; <code class="literal">src</code> &gt; <code class="literal">main</code> &gt; <code class="literal">res</code> &gt; <code class="literal">layout</code> &gt; <code class="literal">activity_main_screen.xml</code>.</p><p>Once in this view, we recommend that you modify the text using the text view. This will allow you finer control and will also get you used to the different conventions used when editing Android layout files programmatically.</p><p>When opening the <code class="literal">activity_main_screen.xml</code> file, we will be seeing the different XML codes for the buttons and text views. At this point, look out for the code that takes care of the <code class="literal">Sensor Data Output</code> TextView and add the following code:</p><div class="informalexample"><pre class="programlisting">android:textSize="200dp"
    android:gravity="center"</pre></div><p>The whole <a id="id192" class="indexterm"/>block of code responsible for the <code class="literal">Sensor Data Output</code> TextView will now look as follows:</p><div class="informalexample"><pre class="programlisting">&lt;TextView
         android:layout_width="match_parent"
         android:layout_height="wrap_content"             
android:textAppearance="?android:attr/textAppearanceLarge"
            android:id="@+id/dataOutputTextView"
            android:layout_gravity="center_vertical"
            android:textSize="200dp"
            android:gravity="center"
            android:text="99" /&gt;</pre></div><p>In this block of <a id="id193" class="indexterm"/>code, we have temporarily used the placeholder text <code class="literal">99</code> so that we can approximate how it will look with the Android layout designer. With this modification, the sensor data output is now big enough to be seen by the user, thus enhancing the user experience.</p></div><div class="section" title="Modifying the buttons and adding some color to our text"><div class="titlepage"><div><div><h2 class="title"><a id="ch03lvl2sec26"/>Modifying the buttons and adding some color to our text</h2></div></div></div><p>Finally, we <a id="id194" class="indexterm"/>will modify<a id="id195" class="indexterm"/> our buttons and add some color to the text by performing the following steps:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">We will follow these two steps to create new buttons:<div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Create a <code class="literal">drawable</code> folder with a new XML drawable file known as <code class="literal">buttonshape.xml</code>.</li><li class="listitem">We will then connect the drawable resource file to the main Android layout file.</li></ol></div></li><li class="listitem">Create the <code class="literal">drawable</code> folder by right-clicking on the <code class="literal">res</code> folder, which is available by navigating to <code class="literal">App</code> &gt; <code class="literal">src</code> &gt; <code class="literal">main</code> &gt; <code class="literal">res</code>.</li><li class="listitem">After creating the <code class="literal">drawable</code> folder within the <code class="literal">res</code> folder, we need to once again right-click on the new <code class="literal">drawable</code> folder and click on <span class="strong"><strong>New</strong></span> and choose <span class="strong"><strong>Drawable resource file</strong></span>, as shown in the following screenshot:<div class="mediaobject"><img src="graphics/0389OS_03_12.jpg" alt="Modifying the buttons and adding some color to our text"/></div></li><li class="listitem">Name the <a id="id196" class="indexterm"/>file <code class="literal">buttonshape</code> and type down <code class="literal">shape</code> as the <span class="strong"><strong>Root element</strong></span> followed <a id="id197" class="indexterm"/>by clicking on <span class="strong"><strong>OK</strong></span>, as shown in the following screenshot:<div class="mediaobject"><img src="graphics/0389OS_03_13.jpg" alt="Modifying the buttons and adding some color to our text"/></div></li><li class="listitem">Within the <code class="literal">buttonshape.xml</code> file, we will add the following code:<div class="informalexample"><pre class="programlisting">&lt;?xml version="1.0" encoding="utf-8"?&gt;

&lt;shape &gt;
    android:shape="rectangle" &gt;
    &lt;corners
        android:radius="10dp"
        /&gt;
    &lt;solid
        android:color="#FFFFFF"
        /&gt;
    &lt;padding
        android:left="0dp"
        android:top="0dp"
        android:right="0dp"
        android:bottom="0dp"
        /&gt;
    &lt;size
        android:width="85dp"
        android:height="99dp"
        /&gt;
    &lt;stroke
        android:width="2dp"
        android:color="#4A90E2"
        /&gt;
&lt;/shape&gt;</pre></div></li><li class="listitem">Then, we<a id="id198" class="indexterm"/> go towards the <code class="literal">activity_main_screen.xml</code> file and refer to <a id="id199" class="indexterm"/>this drawable by including the following line of code within the button modules:<div class="informalexample"><pre class="programlisting">android:background="@drawable/buttonshape"</pre></div></li><li class="listitem">We will also add some flavor by adding the following line of code to the button and TextView modules within the <code class="literal">activity_main_screen.xml</code> file:<div class="informalexample"><pre class="programlisting">android:textColor="#4A90E2"</pre></div></li></ol></div><p>In the preceding code, <code class="literal">#4A90E2</code> refers to the hex code of the main color used in the app icon so that we maintain some consistency with the main user interface.</p><p>The final layout will look as follows on a Nexus 5 smartphone:</p><div class="mediaobject"><img src="graphics/0389OS_03_14.jpg" alt="Modifying the buttons and adding some color to our text"/></div><p>It's important to note that different Android devices have different dimensions. So, for your specific Android <a id="id200" class="indexterm"/>device, you<a id="id201" class="indexterm"/> might need to do further optimizations within the Android layout files to improve the interface.</p></div><div class="section" title="How to go further"><div class="titlepage"><div><div><h2 class="title"><a id="ch03lvl2sec27"/>How to go further</h2></div></div></div><p>A large <a id="id202" class="indexterm"/>number of improvements could be done towards improving the user interface process within the Android app. Currently, service discovery is refreshed only by physically rotating the device, as the <code class="literal">onResume()</code> method is called upon rotation of the device. This could easily be improved by adding a refresh icon in the action bar and connecting this icon to the code, so that this method is called when the icon is tapped.</p><p>In addition, further user interface customizations can make it possible to personalize the app to your own liking; with regards to this app, you can get an idea of the possibilities by looking at the following links from the Android developers site:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">Button widget documentation <a id="id203" class="indexterm"/>at <a class="ulink" href="http://developer.android.com/reference/android/widget/Button.html">http://developer.android.com/reference/android/widget/Button.html</a></li><li class="listitem" style="list-style-type: disc">TextView documentation<a id="id204" class="indexterm"/> at <a class="ulink" href="http://developer.android.com/reference/android/widget/TextView.html">http://developer.android.com/reference/android/widget/TextView.html</a></li></ul></div><p>You can even expand<a id="id205" class="indexterm"/> the app further with real-time monitoring, statistics, and trends.</p></div></div>
<div class="section" title="Summary"><div class="titlepage"><div><div><h1 class="title"><a id="ch03lvl1sec22"/>Summary</h1></div></div></div><p>In this chapter, we built a simple weather station using Arduino and Android. We attached several sensors to our Arduino board, along with a Bluetooth Low Energy module. We also built the corresponding Android app so that we can access all the data measured by the Arduino board just by tapping on a button of the phone.</p><p>In the next chapter, we will use a different technology to interact with an Arduino board via Android: Wi-Fi. We will build a smart power switch, to control an electrical device remotely, and also to measure the device power consumption via Wi-Fi.</p></div></body></html>