<html><head></head><body>
<div id="_idContainer040" class="calibre2">
<h1 class="chapter-number" id="_idParaDest-88"><a id="_idTextAnchor089" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.1.1">4</span></h1>
<h1 id="_idParaDest-89" class="calibre5"><a id="_idTextAnchor090" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.2.1">Building the Packtagram UI</span></h1>
<p class="calibre3"><span class="kobospan" id="kobo.3.1">As we leave the exciting world of chat applications behind, it’s time to take on another interesting challenge – social networking. </span><span class="kobospan" id="kobo.3.2">Social networking apps have seen an exponential rise in popularity over the last decade, becoming integral to our daily lives. </span><span class="kobospan" id="kobo.3.3">These platforms have changed the way we communicate, share, and interact with each other on a global scale. </span><span class="kobospan" id="kobo.3.4">Among them, Instagram stands out with its simplicity, its emphasis on visuals, and its engaging features, such as its newsfeed </span><span><span class="kobospan" id="kobo.4.1">and stories.</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.5.1">The next few chapters are dedicated to the process of creating an Instagram-like social networking application while leveraging Android’s powerful features and capabilities. </span><span class="kobospan" id="kobo.5.2">We will call </span><span><span class="kobospan" id="kobo.6.1">it Packtagram!</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.7.1">To start this journey, we’ll begin by setting up a solid foundation and structuring our project. </span><span class="kobospan" id="kobo.7.2">The structure of an Android application has a significant impact on the ease of development and the application’s scalability over time. </span><span class="kobospan" id="kobo.7.3">This chapter will cover various aspects of project structuring, such as defining the file hierarchy, segregating modules, and choosing the right architecture pattern for </span><span><span class="kobospan" id="kobo.8.1">our needs.</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.9.1">Once our project structure is robust and scalable, we’ll transition into the realm of UI development. </span><span class="kobospan" id="kobo.9.2">In the case of Instagram, the primary components that catch our attention are its newsfeed and stories. </span><span class="kobospan" id="kobo.9.3">We’ll dive into the process of implementing these critical features, focusing on their user-friendly interfaces and seamless </span><span><span class="kobospan" id="kobo.10.1">navigation flow.</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.11.1">After the UI, we’ll move on to the heart of any dynamic application: data retrieval. </span><span class="kobospan" id="kobo.11.2">We’ll learn how to interact with servers to fetch data, focusing on </span><span><span class="kobospan" id="kobo.12.1">the newsfeed.</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.13.1">In the final part of this chapter, we will venture into the world of data caching. </span><span class="kobospan" id="kobo.13.2">Social media apps often involve a large amount of data transfer, and to provide a seamless and efficient user experience, effective data management strategies, including caching, are necessary. </span><span class="kobospan" id="kobo.13.3">We will explore how to store stories and news items locally, thus reducing network calls and improving the </span><span><span class="kobospan" id="kobo.14.1">app’s performance.</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.15.1">This chapter will cover the </span><span><span class="kobospan" id="kobo.16.1">following topics:</span></span></p>
<ul class="calibre15">
<li class="calibre14"><span class="kobospan" id="kobo.17.1">Setting up Packtagram’s modules </span><span><span class="kobospan" id="kobo.18.1">and dependencies</span></span></li>
<li class="calibre14"><span class="kobospan" id="kobo.19.1">Creating the </span><span><span class="kobospan" id="kobo.20.1">stories screen</span></span></li>
<li class="calibre14"><span class="kobospan" id="kobo.21.1">Creating the newsfeed screen and </span><span><span class="kobospan" id="kobo.22.1">its components</span></span></li>
<li class="calibre14"><span class="kobospan" id="kobo.23.1">Using Retrofit and Moshi to retrieve </span><span><span class="kobospan" id="kobo.24.1">newsfeed information</span></span></li>
<li class="calibre14"><span class="kobospan" id="kobo.25.1">Implementing pagination to </span><span><span class="kobospan" id="kobo.26.1">the newsfeed</span></span></li>
</ul>
<h1 id="_idParaDest-90" class="calibre5"><a id="_idTextAnchor091" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.27.1">Technical requirements</span></h1>
<p class="calibre3"><span class="kobospan" id="kobo.28.1">As in the previous chapter, you will need to have Android Studio (or another editor of your </span><span><span class="kobospan" id="kobo.29.1">preference) installed.</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.30.1">We are going to start a new project in this chapter, so it isn’t necessary to download the changes that you made in the </span><span><span class="kobospan" id="kobo.31.1">previous chapter.</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.32.1">Nonetheless, you can have the complete code that we are going to build through this chapter in this book’s GitHub </span><span><span class="kobospan" id="kobo.33.1">repository: </span></span><a href="https://github.com/PacktPublishing/Thriving-in-Android-Development-using-Kotlin/tree/main/Chapter-4" class="calibre6 pcalibre1 pcalibre"><span><span class="kobospan" id="kobo.34.1">https://github.com/PacktPublishing/Thriving-in-Android-Development-using-Kotlin/tree/main/Chapter-4</span></span></a><span><span class="kobospan" id="kobo.35.1">.</span></span></p>
<h1 id="_idParaDest-91" class="calibre5"><a id="_idTextAnchor092" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.36.1">Setting up Packtagram’s modules and dependencies</span></h1>
<p class="calibre3"><span class="kobospan" id="kobo.37.1">To set up our app</span><a id="_idIndexMarker383" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.38.1"> structure, we are going to create a new project. </span><span class="kobospan" id="kobo.38.2">We could do this by following the same instructions that we covered in </span><a href="B19443_01.xhtml#_idTextAnchor015" class="calibre6 pcalibre1 pcalibre"><span><em class="italic"><span class="kobospan" id="kobo.39.1">Chapter 1</span></em></span></a><span class="kobospan" id="kobo.40.1">, but we are going to introduce a variation here: our Gradle files will be written in Kotlin, and we will also use </span><span><span class="kobospan" id="kobo.41.1">version catalogs.</span></span></p>
<h2 id="_idParaDest-92" class="calibre7"><a id="_idTextAnchor093" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.42.1">Setting up a version catalog</span></h2>
<p class="calibre3"><span class="kobospan" id="kobo.43.1">A </span><strong class="bold"><span class="kobospan" id="kobo.44.1">version catalog</span></strong><span class="kobospan" id="kobo.45.1"> is a </span><a id="_idIndexMarker384" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.46.1">feature that </span><a id="_idIndexMarker385" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.47.1">was introduced in Gradle 7.0 to centralize the declaration of dependencies in a project. </span><span class="kobospan" id="kobo.47.2">This feature provides an organized way to manage dependencies, making it easier to control and update the different versions of libraries across different modules of </span><span><span class="kobospan" id="kobo.48.1">a project.</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.49.1">With a version catalog, you define all the dependencies and their versions in a </span><strong class="bold"><span class="kobospan" id="kobo.50.1">Tom’s Obvious, Minimal Language</span></strong><span class="kobospan" id="kobo.51.1"> (</span><strong class="bold"><span class="kobospan" id="kobo.52.1">TOML</span></strong><span class="kobospan" id="kobo.53.1">) file, usually</span><a id="_idIndexMarker386" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.54.1"> named </span><strong class="source-inline"><span class="kobospan" id="kobo.55.1">libs.versions.toml</span></strong><span class="kobospan" id="kobo.56.1">. </span><span class="kobospan" id="kobo.56.2">This file resides in the Gradle folder of </span><span><span class="kobospan" id="kobo.57.1">your project.</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.58.1">A version catalog offers </span><span><span class="kobospan" id="kobo.59.1">several benefits:</span></span></p>
<ul class="calibre15">
<li class="calibre14"><span class="kobospan" id="kobo.60.1">It simplifies dependency management by providing a single place to define and update </span><span><span class="kobospan" id="kobo.61.1">the dependencies</span></span></li>
<li class="calibre14"><span class="kobospan" id="kobo.62.1">It minimizes errors caused by discrepancies in dependency versions </span><span><span class="kobospan" id="kobo.63.1">across modules</span></span></li>
<li class="calibre14"><span class="kobospan" id="kobo.64.1">It improves the readability of build scripts by removing the need to declare each dependency individually as the declaration is centralized in a </span><span><span class="kobospan" id="kobo.65.1">unique file</span></span></li>
</ul>
<p class="calibre3"><span class="kobospan" id="kobo.66.1">To use version </span><a id="_idIndexMarker387" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.67.1">catalogs, in </span><a id="_idIndexMarker388" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.68.1">Android Studio, fill out the details for a new project, including </span><strong class="bold"><span class="kobospan" id="kobo.69.1">Name</span></strong><span class="kobospan" id="kobo.70.1"> – here, I chose </span><strong class="bold"><span class="kobospan" id="kobo.71.1">Packtagram</span></strong><span class="kobospan" id="kobo.72.1">. </span><span class="kobospan" id="kobo.72.2">For the </span><strong class="bold"><span class="kobospan" id="kobo.73.1">Build configuration language</span></strong><span class="kobospan" id="kobo.74.1"> field, select </span><strong class="bold"><span class="kobospan" id="kobo.75.1">Kotlin </span></strong><span><strong class="bold"><span class="kobospan" id="kobo.76.1">DSL (build.gradle.kts)</span></strong></span><span><span class="kobospan" id="kobo.77.1">:</span></span></p>
<div class="calibre2">
<div class="img---figure" id="_idContainer034">
<span class="kobospan" id="kobo.78.1"><img alt="Figure 4.1: Creating a new project in Android Studio Jellyfish (2023.3.1)" src="image/B19443_04_001.jpg" class="calibre4"/></span>
</div>
</div>
<p class="img---caption" lang="en-US" xml:lang="en-US"><span class="kobospan" id="kobo.79.1">Figure 4.1: Creating a new project in Android Studio Jellyfish (2023.3.1)</span></p>
<p class="calibre3"><span class="kobospan" id="kobo.80.1">With this option, Android Studio will automatically create the file needed to specify the versions. </span><span class="kobospan" id="kobo.80.2">This file </span><a id="_idIndexMarker389" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.81.1">is called </span><strong class="source-inline"><span class="kobospan" id="kobo.82.1">libs.versions.toml</span></strong><span class="kobospan" id="kobo.83.1"> and its default content will look </span><span><span class="kobospan" id="kobo.84.1">like this:</span></span></p>
<pre class="source-code"><span class="kobospan1" id="kobo.85.1">
[versions]
agp = "8.1.0-beta01"
org-jetbrains-kotlin-android = "1.8.10"
core-ktx = "1.9.0"
...
</span><span class="kobospan1" id="kobo.85.2">[libraries]
core-ktx = { group = "androidx.core", name = "core-ktx", version.ref = "core-ktx" }
junit = { group = "junit", name = "junit", version.ref = "junit" }
...
</span><span class="kobospan1" id="kobo.85.3">[plugins]
com-android-application = { id = "com.android.application", version.ref = "agp" }
org-jetbrains-kotlin-android = { id = "org.jetbrains.kotlin.android", version.ref = "org-jetbrains-kotlin-android" }
[bundles]</span></pre> <p class="calibre3"><span class="kobospan" id="kobo.86.1">As shown</span><a id="_idIndexMarker390" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.87.1"> in </span><a id="_idIndexMarker391" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.88.1">the following code (and in the </span><strong class="source-inline"><span class="kobospan" id="kobo.89.1">libs.version.toml</span></strong><span class="kobospan" id="kobo.90.1"> file generated by Android Studio in your project), the file is composed of </span><span><span class="kobospan" id="kobo.91.1">several sections:</span></span></p>
<ul class="calibre15">
<li class="calibre14"><strong class="source-inline1"><span class="kobospan" id="kobo.92.1">versions</span></strong><span class="kobospan" id="kobo.93.1">: This section contains the versions of the dependencies that will be used in your project. </span><span class="kobospan" id="kobo.93.2">You simply assign a reference name to each version number. </span><span class="kobospan" id="kobo.93.3">This is useful to centralize versioning, particularly when the same version of a library is used in </span><span><span class="kobospan" id="kobo.94.1">multiple places.</span></span></li>
<li class="calibre14"><strong class="source-inline1"><span class="kobospan" id="kobo.95.1">libraries</span></strong><span class="kobospan" id="kobo.96.1">: In this block, you define your actual dependencies by assigning them an alias and linking them to the correct version defined in the </span><strong class="source-inline1"><span class="kobospan" id="kobo.97.1">versions</span></strong><span class="kobospan" id="kobo.98.1"> block. </span><span class="kobospan" id="kobo.98.2">This alias can then be used throughout your project to refer to </span><span><span class="kobospan" id="kobo.99.1">the dependency.</span></span></li>
<li class="calibre14"><strong class="source-inline1"><span class="kobospan" id="kobo.100.1">bundles</span></strong><span class="kobospan" id="kobo.101.1">: Bundles are groups of dependencies that are commonly used together. </span><span class="kobospan" id="kobo.101.2">By creating a bundle, you can include multiple dependencies in your build scripts with a single alias. </span><span class="kobospan" id="kobo.101.3">This can simplify your build scripts and make them easier to read </span><span><span class="kobospan" id="kobo.102.1">and manage.</span></span></li>
<li class="calibre14"><strong class="source-inline1"><span class="kobospan" id="kobo.103.1">plugins</span></strong><span class="kobospan" id="kobo.104.1">: This section is where Gradle plugins that are used in the project are defined. </span><span class="kobospan" id="kobo.104.2">Similar to libraries, each plugin is given an alias and linked to a version number from the </span><strong class="source-inline1"><span class="kobospan" id="kobo.105.1">versions</span></strong><span class="kobospan" id="kobo.106.1"> block. </span><span class="kobospan" id="kobo.106.2">This feature makes managing plugins as straightforward as managing </span><span><span class="kobospan" id="kobo.107.1">other dependencies.</span></span></li>
</ul>
<p class="calibre3"><span class="kobospan" id="kobo.108.1">Now, if we open the </span><strong class="source-inline"><span class="kobospan" id="kobo.109.1">gradle.build.kts</span></strong><span class="kobospan" id="kobo.110.1"> file of our app module, we’ll see how the version catalog</span><a id="_idIndexMarker392" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.111.1"> declarations are </span><a id="_idIndexMarker393" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.112.1">used. </span><span class="kobospan" id="kobo.112.2">For example, here, we can see how the plugins are </span><span><span class="kobospan" id="kobo.113.1">now applied:</span></span></p>
<pre class="source-code"><span class="kobospan1" id="kobo.114.1">
plugins {
    alias(libs.plugins.com.android.application)
    alias(libs.plugins.org.jetbrains.kotlin.android)
}</span></pre> <p class="calibre3"><span class="kobospan" id="kobo.115.1">The term </span><strong class="source-inline"><span class="kobospan" id="kobo.116.1">alias</span></strong><span class="kobospan" id="kobo.117.1"> is used here to refer to a predefined plugin dependency that has been specified in the </span><span><strong class="source-inline"><span class="kobospan" id="kobo.118.1">libs.versions.toml</span></strong></span><span><span class="kobospan" id="kobo.119.1"> file.</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.120.1">Here, we can see how the dependencies </span><span><span class="kobospan" id="kobo.121.1">are declared:</span></span></p>
<pre class="source-code"><span class="kobospan1" id="kobo.122.1">
dependencies {
    implementation(libs.core.ktx)
    implementation(libs.lifecycle.runtime.ktx)
    implementation(libs.activity.compose)
    implementation(platform(libs.compose.bom))
    implementation(libs.ui)
    implementation(libs.ui.graphics)
    implementation(libs.ui.tooling.preview)
    implementation(libs.material3)
    ...
</span><span class="kobospan1" id="kobo.122.2">}</span></pre> <p class="calibre3"><span class="kobospan" id="kobo.123.1">As you can see, every dependency is referred to by the name we have given them in the version catalog file (</span><strong class="source-inline"><span class="kobospan" id="kobo.124.1">libs.versions.toml</span></strong><span class="kobospan" id="kobo.125.1">). </span><span class="kobospan" id="kobo.125.2">It is now easier to have all the project dependencies synchronized and included in </span><span><span class="kobospan" id="kobo.126.1">the modules.</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.127.1">Talking about modules, it’s time we also structure our app using modularization. </span><span class="kobospan" id="kobo.127.2">We already learned </span><a id="_idIndexMarker394" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.128.1">about the</span><a id="_idIndexMarker395" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.129.1"> different strategies to modularize our app in </span><a href="B19443_01.xhtml#_idTextAnchor015" class="calibre6 pcalibre1 pcalibre"><span><em class="italic"><span class="kobospan" id="kobo.130.1">Chapter 1</span></em></span></a><span class="kobospan" id="kobo.131.1">, so this is a good time to review </span><span><span class="kobospan" id="kobo.132.1">that information.</span></span></p>
<h2 id="_idParaDest-93" class="calibre7"><a id="_idTextAnchor094" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.133.1">Modularizing our app</span></h2>
<p class="calibre3"><span class="kobospan" id="kobo.134.1">In this case, we will </span><a id="_idIndexMarker396" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.135.1">segment Packtagram into several feature modules, each encapsulating </span><span><span class="kobospan" id="kobo.136.1">distinct functionalities:</span></span></p>
<ul class="calibre15">
<li class="calibre14"><strong class="bold"><span class="kobospan" id="kobo.137.1">Newsfeed module</span></strong><span class="kobospan" id="kobo.138.1">: The </span><a id="_idIndexMarker397" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.139.1">newsfeed module is dedicated to the main feed and is where users see and interact with posts from those they follow. </span><span class="kobospan" id="kobo.139.2">We’ll isolate this functionality because it’s the core user experience and likely the first screen users will see. </span><span class="kobospan" id="kobo.139.3">This module will need to handle rendering posts, managing likes and comments, and refreshing </span><span><span class="kobospan" id="kobo.140.1">the feed.</span></span></li>
<li class="calibre14"><strong class="bold"><span class="kobospan" id="kobo.141.1">Stories module</span></strong><span class="kobospan" id="kobo.142.1">: We’ll separate the stories functionality into its own module because it’s a distinct user experience that requires specific UI elements and data handling. </span><span class="kobospan" id="kobo.142.2">The stories module needs to manage how different user stories are rendered, track the view status, and manage </span><span><span class="kobospan" id="kobo.143.1">story creation.</span></span></li>
<li class="calibre14"><strong class="bold"><span class="kobospan" id="kobo.144.1">Profile module</span></strong><span class="kobospan" id="kobo.145.1">: User profiles are a central part of the Instagram experience, so we’ll house this functionality in the profile module. </span><span class="kobospan" id="kobo.145.2">This module will handle displaying user information, managing posts specific to a user, and editing </span><span><span class="kobospan" id="kobo.146.1">profile details.</span></span></li>
<li class="calibre14"><strong class="bold"><span class="kobospan" id="kobo.147.1">Search module</span></strong><span class="kobospan" id="kobo.148.1">: Search functionality is complex enough to justify its own module. </span><span class="kobospan" id="kobo.148.2">This module will deal with user queries, display search results, and manage interactions with </span><span><span class="kobospan" id="kobo.149.1">search results.</span></span></li>
<li class="calibre14"><strong class="bold"><span class="kobospan" id="kobo.150.1">Messaging module</span></strong><span class="kobospan" id="kobo.151.1">: Direct messaging is a separate feature in Instagram, so we’ll also isolate it in a dedicated module. </span><span class="kobospan" id="kobo.151.2">This module will manage creating and displaying chats, sending and receiving messages, and notifications of </span><span><span class="kobospan" id="kobo.152.1">new messages.</span></span></li>
<li class="calibre14"><strong class="bold"><span class="kobospan" id="kobo.153.1">Core module</span></strong><span class="kobospan" id="kobo.154.1">: This module will contain shared utilities, network interfaces, and other common components used across the application. </span><span class="kobospan" id="kobo.154.2">This prevents code duplication and provides </span><a id="_idIndexMarker398" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.155.1">a central point for managing </span><span><span class="kobospan" id="kobo.156.1">shared resources.</span></span></li>
</ul>
<p class="calibre3"><span class="kobospan" id="kobo.157.1">By choosing this modularization strategy, we’ve effectively separated our app into logical components </span><a id="_idIndexMarker399" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.158.1">that can be developed, tested, and debugged independently. </span><span class="kobospan" id="kobo.158.2">This also aligns well with the idea</span><a id="_idIndexMarker400" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.159.1"> of </span><strong class="bold"><span class="kobospan" id="kobo.160.1">separation of concerns</span></strong><span class="kobospan" id="kobo.161.1">, ensuring that each part of our app has a clear, singular purpose. </span><span class="kobospan" id="kobo.161.2">In the following sections, we’ll explore each of these modules in detail, building the functionalities one by one, culminating in our completed social </span><span><span class="kobospan" id="kobo.162.1">networking app.</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.163.1">So, let’s create the modules while following the same instructions provided in </span><a href="B19443_01.xhtml#_idTextAnchor015" class="calibre6 pcalibre1 pcalibre"><span><em class="italic"><span class="kobospan" id="kobo.164.1">Chapter 1</span></em></span></a><span class="kobospan" id="kobo.165.1">. </span><span class="kobospan" id="kobo.165.2">Our module structure will look </span><span><span class="kobospan" id="kobo.166.1">like this:</span></span></p>
<div class="calibre2">
<div class="img---figure" id="_idContainer035">
<span class="kobospan" id="kobo.167.1"><img alt="Figure 4.2: The modules structure for Packtagram" src="image/B19443_04_002.jpg" class="calibre4"/></span>
</div>
</div>
<p class="img---caption" lang="en-US" xml:lang="en-US"><span class="kobospan" id="kobo.168.1">Figure 4.2: The modules structure for Packtagram</span></p>
<p class="calibre3"><span class="kobospan" id="kobo.169.1">As we can see, we should have a module called </span><strong class="source-inline"><span class="kobospan" id="kobo.170.1">:app</span></strong><span class="kobospan" id="kobo.171.1"> (already created when creating the project), a module called </span><strong class="source-inline"><span class="kobospan" id="kobo.172.1">:core</span></strong><span class="kobospan" id="kobo.173.1"> for the core functionality, and a module called :</span><strong class="source-inline"><span class="kobospan" id="kobo.174.1">feature</span></strong><span class="kobospan" id="kobo.175.1"> that contains all of the feature modules (</span><strong class="source-inline"><span class="kobospan" id="kobo.176.1">:messaging</span></strong><span class="kobospan" id="kobo.177.1">, </span><strong class="source-inline"><span class="kobospan" id="kobo.178.1">:newsfeed</span></strong><span class="kobospan" id="kobo.179.1">, </span><strong class="source-inline"><span class="kobospan" id="kobo.180.1">:profile</span></strong><span class="kobospan" id="kobo.181.1">, </span><strong class="source-inline"><span class="kobospan" id="kobo.182.1">:search</span></strong><span class="kobospan" id="kobo.183.1">, </span><span><span class="kobospan" id="kobo.184.1">and </span></span><span><strong class="source-inline"><span class="kobospan" id="kobo.185.1">:stories</span></strong></span><span><span class="kobospan" id="kobo.186.1">).</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.187.1">As part of this project, we will focus on the </span><strong class="source-inline"><span class="kobospan" id="kobo.188.1">newsfeed</span></strong><span class="kobospan" id="kobo.189.1"> and </span><strong class="source-inline"><span class="kobospan" id="kobo.190.1">stories</span></strong><span class="kobospan" id="kobo.191.1"> modules (we already know how to create messaging functionality as that was covered in the last three chapters, so we don’t need to cover </span><span><span class="kobospan" id="kobo.192.1">that again).</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.193.1">In the case of the feature modules, we will structure them internally using the same approach we </span><a id="_idIndexMarker401" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.194.1">already followed in the WhatsPackt project: organizing the code and dependencies in layers. </span><span class="kobospan" id="kobo.194.2">For example, we could structure the </span><strong class="source-inline"><span class="kobospan" id="kobo.195.1">:newsfeed</span></strong><span class="kobospan" id="kobo.196.1"> module </span><span><span class="kobospan" id="kobo.197.1">like so:</span></span></p>
<div class="calibre2">
<div class="img---figure" id="_idContainer036">
<span class="kobospan" id="kobo.198.1"><img alt="Figure 4.3: Internal structure for the feature modules" src="image/B19443_04_003.jpg" class="calibre4"/></span>
</div>
</div>
<p class="img---caption" lang="en-US" xml:lang="en-US"><span class="kobospan" id="kobo.199.1">Figure 4.3: Internal structure for the feature modules</span></p>
<p class="calibre3"><span class="kobospan" id="kobo.200.1">Here, we can see that we have created four </span><span><span class="kobospan" id="kobo.201.1">internal packages:</span></span></p>
<ul class="calibre15">
<li class="calibre14"><strong class="source-inline1"><span class="kobospan" id="kobo.202.1">data</span></strong><span class="kobospan" id="kobo.203.1">: This is where we will place the logic for the data layer, including the components needed to retrieve the information from the backend and the </span><span><span class="kobospan" id="kobo.204.1">data sources</span></span></li>
<li class="calibre14"><strong class="source-inline1"><span class="kobospan" id="kobo.205.1">di</span></strong><span class="kobospan" id="kobo.206.1">: This is where we will place the logic needed to define the dependency </span><span><span class="kobospan" id="kobo.207.1">injection instructions</span></span></li>
<li class="calibre14"><strong class="source-inline1"><span class="kobospan" id="kobo.208.1">domain</span></strong><span class="kobospan" id="kobo.209.1">: This is where we will place the domain logic, including the repositories and </span><span><span class="kobospan" id="kobo.210.1">use cases</span></span></li>
<li class="calibre14"><strong class="source-inline1"><span class="kobospan" id="kobo.211.1">ui</span></strong><span class="kobospan" id="kobo.212.1">: This is where we will place all the logic related to the user interface, including ViewModels, composables, and other Android </span><span><span class="kobospan" id="kobo.213.1">View components</span></span></li>
</ul>
<p class="calibre3"><span class="kobospan" id="kobo.214.1">We will implement the necessary components that will be part of the modules in this and the </span><span><span class="kobospan" id="kobo.215.1">following chapters.</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.216.1">As part of our module structure, we’ve included an internal module specifically for dependency injection. </span><span class="kobospan" id="kobo.216.2">Previously, in our WhatsPackt project, we used the Dagger Hilt framework for</span><a id="_idIndexMarker402" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.217.1"> dependency injection. </span><span class="kobospan" id="kobo.217.2">However, in this project, we will take a different approach by </span><span><span class="kobospan" id="kobo.218.1">using Koin.</span></span></p>
<h2 id="_idParaDest-94" class="calibre7"><a id="_idTextAnchor095" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.219.1">Getting to know Koin</span></h2>
<p class="calibre3"><span class="kobospan" id="kobo.220.1">Koin was </span><a id="_idIndexMarker403" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.221.1">mentioned</span><a id="_idIndexMarker404" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.222.1"> briefly in </span><a href="B19443_01.xhtml#_idTextAnchor015" class="calibre6 pcalibre1 pcalibre"><span><em class="italic"><span class="kobospan" id="kobo.223.1">Chapter 1</span></em></span></a><span class="kobospan" id="kobo.224.1">, but let’s learn about its main </span><span><span class="kobospan" id="kobo.225.1">features here:</span></span></p>
<ul class="calibre15">
<li class="calibre14"><strong class="bold"><span class="kobospan" id="kobo.226.1">Simplicity</span></strong><span class="kobospan" id="kobo.227.1">: It offers</span><a id="_idIndexMarker405" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.228.1"> an easy setup process and is easy </span><span><span class="kobospan" id="kobo.229.1">to learn</span></span></li>
<li class="calibre14"><strong class="bold"><span class="kobospan" id="kobo.230.1">Efficiency</span></strong><span class="kobospan" id="kobo.231.1">: It is lightweight as it doesn’t rely </span><span><span class="kobospan" id="kobo.232.1">on reflection</span></span></li>
<li class="calibre14"><strong class="bold"><span class="kobospan" id="kobo.233.1">Kotlin-centric</span></strong><span class="kobospan" id="kobo.234.1">: Designed specifically for Kotlin, it leverages Kotlin-specific features such as extension</span><a id="_idIndexMarker406" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.235.1"> functions, </span><strong class="bold"><span class="kobospan" id="kobo.236.1">domain-specific languages</span></strong><span class="kobospan" id="kobo.237.1"> (</span><strong class="bold"><span class="kobospan" id="kobo.238.1">DSLs</span></strong><span class="kobospan" id="kobo.239.1">), and </span><span><span class="kobospan" id="kobo.240.1">property delegation</span></span></li>
<li class="calibre14"><strong class="bold"><span class="kobospan" id="kobo.241.1">Scope management</span></strong><span class="kobospan" id="kobo.242.1">: It has a clear way to manage the life cycle of </span><span><span class="kobospan" id="kobo.243.1">injected instances</span></span></li>
<li class="calibre14"><strong class="bold"><span class="kobospan" id="kobo.244.1">Integration</span></strong><span class="kobospan" id="kobo.245.1">: It provides seamless integration with popular frameworks, such as ViewModel, Coroutines, </span><span><span class="kobospan" id="kobo.246.1">and others</span></span></li>
<li class="calibre14"><strong class="bold"><span class="kobospan" id="kobo.247.1">Testing</span></strong><span class="kobospan" id="kobo.248.1">: It includes tools to simplify testing by allowing dependencies to be mocked </span><span><span class="kobospan" id="kobo.249.1">or overridden</span></span></li>
<li class="calibre14"><strong class="bold"><span class="kobospan" id="kobo.250.1">DSL configuration</span></strong><span class="kobospan" id="kobo.251.1">: Koin uses a more readable and concise form </span><span><span class="kobospan" id="kobo.252.1">of configuration</span></span></li>
</ul>
<p class="calibre3"><span class="kobospan" id="kobo.253.1">Let’s prepare </span><a id="_idIndexMarker407" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.254.1">Koin for this project so that we can use it in the following sections </span><span><span class="kobospan" id="kobo.255.1">and chapters.</span></span></p>
<h2 id="_idParaDest-95" class="calibre7"><a id="_idTextAnchor096" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.256.1">Setting up Koin</span></h2>
<p class="calibre3"><span class="kobospan" id="kobo.257.1">To start </span><a id="_idIndexMarker408" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.258.1">setting </span><a id="_idIndexMarker409" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.259.1">up Koin, we need to add the necessary dependency to our version catalog. </span><span class="kobospan" id="kobo.259.2">To do that, you will add the necessary Koin dependencies to the </span><strong class="source-inline"><span class="kobospan" id="kobo.260.1">libs.versions.toml</span></strong><span class="kobospan" id="kobo.261.1"> file. </span><span class="kobospan" id="kobo.261.2">Be sure to use the latest version of Koin and replace </span><strong class="source-inline"><span class="kobospan" id="kobo.262.1">latest-version</span></strong><span class="kobospan" id="kobo.263.1"> with the actual </span><span><span class="kobospan" id="kobo.264.1">version number:</span></span></p>
<pre class="source-code"><span class="kobospan1" id="kobo.265.1">
[versions]
...
</span><span class="kobospan1" id="kobo.265.2">koin = "latest-version"
[libraries]
...
</span><span class="kobospan1" id="kobo.265.3">koin-core = { group = "io.insert-koin", name = "koin-core", version.ref = "koin" }
koin-android = { group = "io.insert-koin", name = "koin-android", version.ref = "koin" }
koin-androidx-navigation = { group = "io.insert-koin", name = "koin-androidx-navigation", version.ref = "koin" }
koin-androidx-compose = { group = "io.insert-koin", name = "koin-androidx-compose", version.ref = "koin" }
koin-test = { group = "io.insert-koin", name = "koin-test", version.ref = "koin" }
koin-test-junit4 = { group = "io.insert-koin", name = "koin-test-junit4", version.ref = "koin" }</span></pre> <p class="calibre3"><span class="kobospan" id="kobo.266.1">As we can see, we </span><a id="_idIndexMarker410" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.267.1">have added the </span><strong class="source-inline"><span class="kobospan" id="kobo.268.1">koin</span></strong><span class="kobospan" id="kobo.269.1"> version in the </span><strong class="source-inline"><span class="kobospan" id="kobo.270.1">versions</span></strong><span class="kobospan" id="kobo.271.1"> block and the packages we might need in the </span><span><strong class="source-inline"><span class="kobospan" id="kobo.272.1">libraries</span></strong></span><span><span class="kobospan" id="kobo.273.1"> block.</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.274.1">Now, we need to add the dependencies to our module’s Gradle files. </span><span class="kobospan" id="kobo.274.2">To do this, add the following lines to the </span><span><span class="kobospan" id="kobo.275.1">dependency Lambda:</span></span></p>
<pre class="source-code"><span class="kobospan1" id="kobo.276.1">
dependencies {
   …
    implementation(libs.koin.core)
    implementation(libs.koin.android)
    implementation(libs.koin.androidx.compose)
    implementation(libs.koin.androidx.navigation)
    ...
</span><span class="kobospan1" id="kobo.276.2">}</span></pre> <p class="calibre3"><span class="kobospan" id="kobo.277.1">Adding these </span><a id="_idIndexMarker411" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.278.1">dependencies will allow us to use Koin in our modules. </span><span class="kobospan" id="kobo.278.2">As a start, you should add them to the </span><strong class="source-inline"><span class="kobospan" id="kobo.279.1">:app</span></strong><span class="kobospan" id="kobo.280.1">, </span><strong class="source-inline"><span class="kobospan" id="kobo.281.1">:feature:newsfeed</span></strong><span class="kobospan" id="kobo.282.1">, and </span><strong class="source-inline"><span class="kobospan" id="kobo.283.1">:feature:stories</span></strong><span class="kobospan" id="kobo.284.1"> modules, which are the modules we are going to work with in this and the following </span><span><span class="kobospan" id="kobo.285.1">two chapters.</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.286.1">Next, we need to create our </span><strong class="source-inline"><span class="kobospan" id="kobo.287.1">Application</span></strong><span class="kobospan" id="kobo.288.1"> class. </span><span class="kobospan" id="kobo.288.2">Koin is typically initialized in your </span><strong class="source-inline"><span class="kobospan" id="kobo.289.1">Application</span></strong><span class="kobospan" id="kobo.290.1"> class. </span><span class="kobospan" id="kobo.290.2">As we don’t have one already, we will create one as part of the </span><strong class="source-inline"><span class="kobospan" id="kobo.291.1">:app</span></strong><span class="kobospan" id="kobo.292.1"> module and</span><a id="_idIndexMarker412" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.293.1"> add the </span><span><span class="kobospan" id="kobo.294.1">following code:</span></span></p>
<pre class="source-code"><span class="kobospan1" id="kobo.295.1">
class PacktagramApplication : Application() {
    override fun onCreate() {
        super.onCreate()
        startKoin {
            androidLogger()
            androidContext(this@PacktagramApplication)
            modules(appModule)
        }
    }
}</span></pre> <p class="calibre3"><span class="kobospan" id="kobo.296.1">In the </span><strong class="source-inline"><span class="kobospan" id="kobo.297.1">startKoin</span></strong><span class="kobospan" id="kobo.298.1"> block, we’ve specified that we want to use the Android logger (</span><strong class="source-inline"><span class="kobospan" id="kobo.299.1">androidLogger()</span></strong><span class="kobospan" id="kobo.300.1">). </span><span class="kobospan" id="kobo.300.2">The </span><strong class="source-inline"><span class="kobospan" id="kobo.301.1">androidLogger()</span></strong><span class="kobospan" id="kobo.302.1"> function is a part of Koin’s API and configures Koin to use Android’s native logging mechanism. </span><span class="kobospan" id="kobo.302.2">Essentially, it enables Koin to print logs </span><span><span class="kobospan" id="kobo.303.1">to Logcat.</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.304.1">When you initialize Koin with </span><strong class="source-inline"><span class="kobospan" id="kobo.305.1">androidLogger()</span></strong><span class="kobospan" id="kobo.306.1">, you will be able to see important information about Koin’s behavior and operations in Logcat while debugging your application. </span><span class="kobospan" id="kobo.306.2">This includes details such as which dependencies are being created, if any errors occur during the creation of a dependency, the life cycle of scopes, </span><span><span class="kobospan" id="kobo.307.1">and more.</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.308.1">After that, we provided the Android context (</span><strong class="source-inline"><span class="kobospan" id="kobo.309.1">androidContext(this@MyApplication)</span></strong><span class="kobospan" id="kobo.310.1">) to the framework in case we need it to create any of </span><span><span class="kobospan" id="kobo.311.1">our dependencies.</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.312.1">The next line is </span><strong class="source-inline"><span class="kobospan" id="kobo.313.1">modules(appModule)</span></strong><span class="kobospan" id="kobo.314.1">. </span><span class="kobospan" id="kobo.314.2">This function is where you’ll list the modules that contain your </span><a id="_idIndexMarker413" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.315.1">project’s dependencies </span><a id="_idIndexMarker414" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.316.1">and the instructions to provide them. </span><span class="kobospan" id="kobo.316.2">To start, we will only have </span><strong class="source-inline"><span class="kobospan" id="kobo.317.1">appModule</span></strong><span class="kobospan" id="kobo.318.1">, which we can create </span><span><span class="kobospan" id="kobo.319.1">like so:</span></span></p>
<pre class="source-code"><span class="kobospan1" id="kobo.320.1">
import org.koin.dsl.module
val appModule = module {
...
</span><span class="kobospan1" id="kobo.320.2">}</span></pre> <p class="calibre3"><span class="kobospan" id="kobo.321.1">Inside the </span><strong class="source-inline"><span class="kobospan" id="kobo.322.1">module</span></strong><span class="kobospan" id="kobo.323.1"> block, we should define our dependencies once we start building them. </span><span class="kobospan" id="kobo.323.2">Here’s </span><span><span class="kobospan" id="kobo.324.1">an example:</span></span></p>
<pre class="source-code"><span class="kobospan1" id="kobo.325.1">
val exampleModule = module {
    single { MyDataSource(get()) }
    single { MyRepository(get()) }
    factory { MyUseCase(get()) }
    viewModel { MyViewModel(get()) }
}</span></pre> <p class="calibre3"><span class="kobospan" id="kobo.326.1">The </span><strong class="source-inline"><span class="kobospan" id="kobo.327.1">module</span></strong><span class="kobospan" id="kobo.328.1"> function in Koin is used to define a module where you specify how to create your various dependencies. </span><span class="kobospan" id="kobo.328.2">Inside a module, you can use functions such as </span><strong class="source-inline"><span class="kobospan" id="kobo.329.1">single</span></strong><span class="kobospan" id="kobo.330.1">, </span><strong class="source-inline"><span class="kobospan" id="kobo.331.1">factory</span></strong><span class="kobospan" id="kobo.332.1">, and </span><strong class="source-inline"><span class="kobospan" id="kobo.333.1">viewModel</span></strong><span class="kobospan" id="kobo.334.1"> to create instances of </span><span><span class="kobospan" id="kobo.335.1">your dependencies.</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.336.1">Here’s a breakdown of </span><span><span class="kobospan" id="kobo.337.1">these functions:</span></span></p>
<ul class="calibre15">
<li class="calibre14"><strong class="source-inline1"><span class="kobospan" id="kobo.338.1">single</span></strong><span class="kobospan" id="kobo.339.1">: This function creates a singleton object of the specified type. </span><span class="kobospan" id="kobo.339.2">Once this object is created, the same instance will be provided every time this type of object is needed. </span><span class="kobospan" id="kobo.339.3">For example, </span><strong class="source-inline1"><span class="kobospan" id="kobo.340.1">single { MyDataSource(get()) }</span></strong><span class="kobospan" id="kobo.341.1"> defines how to create a single instance of </span><strong class="source-inline1"><span class="kobospan" id="kobo.342.1">MyDataSource</span></strong><span class="kobospan" id="kobo.343.1">. </span><span class="kobospan" id="kobo.343.2">The </span><strong class="source-inline1"><span class="kobospan" id="kobo.344.1">get()</span></strong><span class="kobospan" id="kobo.345.1"> function inside the curly braces is a Koin function that fetches any required dependencies for creating the </span><span><strong class="source-inline1"><span class="kobospan" id="kobo.346.1">MyDataSource</span></strong></span><span><span class="kobospan" id="kobo.347.1"> instance.</span></span></li>
<li class="calibre14"><strong class="source-inline1"><span class="kobospan" id="kobo.348.1">factory</span></strong><span class="kobospan" id="kobo.349.1">: This function is used when you want to create a new instance every time the dependency is needed, instead of reusing the same instance. </span><span class="kobospan" id="kobo.349.2">For instance, </span><strong class="source-inline1"><span class="kobospan" id="kobo.350.1">factory { MyUseCase(get()) }</span></strong><span class="kobospan" id="kobo.351.1"> creates a new </span><strong class="source-inline1"><span class="kobospan" id="kobo.352.1">MyUseCase</span></strong><span class="kobospan" id="kobo.353.1"> object every</span><a id="_idIndexMarker415" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.354.1"> time a </span><strong class="source-inline1"><span class="kobospan" id="kobo.355.1">MyUseCase</span></strong><span class="kobospan" id="kobo.356.1"> instance </span><span><span class="kobospan" id="kobo.357.1">is requested.</span></span></li>
<li class="calibre14"><strong class="source-inline1"><span class="kobospan" id="kobo.358.1">viewModel</span></strong><span class="kobospan" id="kobo.359.1">: This function is used to create instances of </span><strong class="source-inline1"><span class="kobospan" id="kobo.360.1">ViewModel</span></strong><span class="kobospan" id="kobo.361.1"> classes. </span><span class="kobospan" id="kobo.361.2">It works like </span><strong class="source-inline1"><span class="kobospan" id="kobo.362.1">single</span></strong><span class="kobospan" id="kobo.363.1"> but is specialized for Android’s </span><strong class="source-inline1"><span class="kobospan" id="kobo.364.1">ViewModel</span></strong><span class="kobospan" id="kobo.365.1"> instances. </span><span class="kobospan" id="kobo.365.2">All </span><strong class="source-inline1"><span class="kobospan" id="kobo.366.1">ViewModel</span></strong><span class="kobospan" id="kobo.367.1"> instances are tied to an activity or fragment life cycle and can survive configuration changes, such as screen rotation. </span><span class="kobospan" id="kobo.367.2">For instance, </span><strong class="source-inline1"><span class="kobospan" id="kobo.368.1">viewModel { MyViewModel(get()) }</span></strong><span class="kobospan" id="kobo.369.1"> defines how to create an instance </span><span><span class="kobospan" id="kobo.370.1">of </span></span><span><strong class="source-inline1"><span class="kobospan" id="kobo.371.1">MyViewModel</span></strong></span><span><span class="kobospan" id="kobo.372.1">.</span></span></li>
<li class="calibre14"><strong class="source-inline1"><span class="kobospan" id="kobo.373.1">bind</span></strong><span class="kobospan" id="kobo.374.1">: This function is used alongside </span><strong class="source-inline1"><span class="kobospan" id="kobo.375.1">single</span></strong><span class="kobospan" id="kobo.376.1">, </span><strong class="source-inline1"><span class="kobospan" id="kobo.377.1">factory</span></strong><span class="kobospan" id="kobo.378.1">, or </span><strong class="source-inline1"><span class="kobospan" id="kobo.379.1">scoped</span></strong><span class="kobospan" id="kobo.380.1"> to provide additional interfaces this class can fulfill. </span><span class="kobospan" id="kobo.380.2">For example, if the </span><strong class="source-inline1"><span class="kobospan" id="kobo.381.1">MyImplementation</span></strong><span class="kobospan" id="kobo.382.1"> class implements </span><strong class="source-inline1"><span class="kobospan" id="kobo.383.1">MyInterface</span></strong><span class="kobospan" id="kobo.384.1">, you could enter </span><span><span class="kobospan" id="kobo.385.1">the following:</span></span><pre class="source-code"><span class="kobospan1" id="kobo.386.1">
single { MyImplementation() } bind MyInterface::class</span></pre><p class="calibre3"><span class="kobospan" id="kobo.387.1">The </span><strong class="source-inline"><span class="kobospan" id="kobo.388.1">get()</span></strong><span class="kobospan" id="kobo.389.1"> function that you can see in the definitions is a Koin function that automatically fetches the required dependencies. </span><span class="kobospan" id="kobo.389.2">For example, if </span><strong class="source-inline"><span class="kobospan" id="kobo.390.1">MyDataSource</span></strong><span class="kobospan" id="kobo.391.1"> has a dependency on a </span><strong class="source-inline"><span class="kobospan" id="kobo.392.1">MyApi</span></strong><span class="kobospan" id="kobo.393.1"> instance, then </span><strong class="source-inline"><span class="kobospan" id="kobo.394.1">get()</span></strong><span class="kobospan" id="kobo.395.1"> will fetch that </span><strong class="source-inline"><span class="kobospan" id="kobo.396.1">MyApi</span></strong><span class="kobospan" id="kobo.397.1"> instance, provided that it has been defined somewhere in the </span><span><span class="kobospan" id="kobo.398.1">Koin modules.</span></span></p></li> </ul>
<p class="calibre3"><span class="kobospan" id="kobo.399.1">Returning to our project, we are going to leave the </span><strong class="source-inline"><span class="kobospan" id="kobo.400.1">appModule</span></strong><span class="kobospan" id="kobo.401.1"> empty for now – we will complete it</span><a id="_idIndexMarker416" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.402.1"> once we start creating </span><span><span class="kobospan" id="kobo.403.1">new</span></span><span><a id="_idIndexMarker417" class="calibre6 pcalibre1 pcalibre"/></span><span><span class="kobospan" id="kobo.404.1"> components.</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.405.1">Talking of components, let’s start with the UI we need to show the </span><span><span class="kobospan" id="kobo.406.1">stories screen.</span></span></p>
<h1 id="_idParaDest-96" class="calibre5"><a id="_idTextAnchor097" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.407.1">Creating the stories screen</span></h1>
<p class="calibre3"><span class="kobospan" id="kobo.408.1">In this section, we’ll focus </span><a id="_idIndexMarker418" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.409.1">on developing a feature for creating</span><a id="_idIndexMarker419" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.410.1"> and editing new stories within our stories feature. </span><span class="kobospan" id="kobo.410.2">We’ll begin by writing a </span><strong class="source-inline"><span class="kobospan" id="kobo.411.1">StoryEditorScreen</span></strong><span class="kobospan" id="kobo.412.1"> composable, along with its corresponding </span><strong class="source-inline"><span class="kobospan" id="kobo.413.1">ViewModel</span></strong><span class="kobospan" id="kobo.414.1">, aptly named </span><strong class="source-inline"><span class="kobospan" id="kobo.415.1">StoryEditorViewModel</span></strong><span class="kobospan" id="kobo.416.1">. </span><span class="kobospan" id="kobo.416.2">Although this </span><strong class="source-inline"><span class="kobospan" id="kobo.417.1">ViewModel</span></strong><span class="kobospan" id="kobo.418.1"> will initially have limited functionality, we’ll expand upon it in </span><span><span class="kobospan" id="kobo.419.1">subsequent chapters.</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.420.1">Let’s start creating our </span><strong class="source-inline"><span class="kobospan" id="kobo.421.1">ViewModel</span></strong><span class="kobospan" id="kobo.422.1">, </span><span><span class="kobospan" id="kobo.423.1">as follows:</span></span></p>
<pre class="source-code"><span class="kobospan1" id="kobo.424.1">
class StoryEditorViewModel: ViewModel() {
    private val _isEditing = MutableStateFlow(true)
    val isEditing: StateFlow&lt;Boolean&gt; = _isEditing
}</span></pre> <p class="calibre3"><span class="kobospan" id="kobo.425.1">In the preceding code, we are declaring </span><strong class="source-inline"><span class="kobospan" id="kobo.426.1">StoryEditorViewModel</span></strong><span class="kobospan" id="kobo.427.1"> and adding a property that will indicate if our screen is in edit mode or not. </span><span class="kobospan" id="kobo.427.2">Edit mode will be used when the user has taken a photo or a video and wants to add more components </span><span><span class="kobospan" id="kobo.428.1">to it.</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.429.1">Now, we need to take care of the dependency injection of this </span><strong class="source-inline"><span class="kobospan" id="kobo.430.1">ViewModel</span></strong><span class="kobospan" id="kobo.431.1"> as it must be accessible from the screen we are about to create. </span><span class="kobospan" id="kobo.431.2">We can create </span><strong class="source-inline"><span class="kobospan" id="kobo.432.1">storyModule</span></strong><span class="kobospan" id="kobo.433.1"> in</span><strong class="source-inline"><span class="kobospan" id="kobo.434.1">:feature:story</span></strong><span class="kobospan" id="kobo.435.1"> to be able to provide it, </span><span><span class="kobospan" id="kobo.436.1">as follows:</span></span></p>
<pre class="source-code"><span class="kobospan1" id="kobo.437.1">
val storyModule = module {
    viewModel&lt;StoryEditorViewModel&gt;()
}</span></pre> <p class="calibre3"><span class="kobospan" id="kobo.438.1">Here, we </span><a id="_idIndexMarker420" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.439.1">are just</span><a id="_idIndexMarker421" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.440.1"> telling Koin that it needs to provide </span><strong class="source-inline"><span class="kobospan" id="kobo.441.1">StoryEditorViewModel</span></strong><span class="kobospan" id="kobo.442.1"> where it </span><span><span class="kobospan" id="kobo.443.1">is needed.</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.444.1">We also need to add this new module to the </span><strong class="source-inline"><span class="kobospan" id="kobo.445.1">PacktagramApplication</span></strong> <span><span class="kobospan" id="kobo.446.1">Koin initialization:</span></span></p>
<pre class="source-code"><span class="kobospan1" id="kobo.447.1">
class PacktagramApplication : Application() {
    override fun onCreate() {
        super.onCreate()
        startKoin {
            androidLogger()
            androidContext(this@PacktagramApplication)
            modules(appModule, storyModule)
        }
    }
}</span></pre> <p class="calibre3"><span class="kobospan" id="kobo.448.1">In the </span><strong class="source-inline"><span class="kobospan" id="kobo.449.1">modules(appModule, storyModule)</span></strong><span class="kobospan" id="kobo.450.1"> line, we have included </span><strong class="source-inline"><span class="kobospan" id="kobo.451.1">storyModule</span></strong><span class="kobospan" id="kobo.452.1"> to provide all the dependencies that we’ll need in the </span><span><span class="kobospan" id="kobo.453.1">stories feature.</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.454.1">Now, we are ready to start with the Jetpack Compose magic and create </span><strong class="source-inline"><span class="kobospan" id="kobo.455.1">StoryEditorScreen</span></strong><span class="kobospan" id="kobo.456.1">. </span><span class="kobospan" id="kobo.456.2">This screen will have </span><strong class="source-inline"><span class="kobospan" id="kobo.457.1">viewModel</span></strong><span class="kobospan" id="kobo.458.1"> as a dependency and handle </span><strong class="source-inline"><span class="kobospan" id="kobo.459.1">TopAppBar</span></strong><span class="kobospan" id="kobo.460.1"> and a new composable, </span><strong class="source-inline"><span class="kobospan" id="kobo.461.1">StoryContent</span></strong><span class="kobospan" id="kobo.462.1">, that will hold the main functionality of the</span><a id="_idIndexMarker422" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.463.1"> story </span><a id="_idIndexMarker423" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.464.1">creation and edition. </span><span class="kobospan" id="kobo.464.2">We can create </span><strong class="source-inline"><span class="kobospan" id="kobo.465.1">StoryEditorScreen</span></strong> <span><span class="kobospan" id="kobo.466.1">as follows:</span></span></p>
<pre class="source-code"><span class="kobospan1" id="kobo.467.1">
@Preview
@OptIn(ExperimentalMaterial3Api::class)
@Composable
fun StoryEditorScreen(
    viewModel: StoryEditorViewModel = koinViewModel()
) {
    val isEditing = viewModel.isEditing.collectAsState()
    Column(modifier = Modifier.fillMaxSize()) {
        if (isEditing.value) {
            TopAppBar(title = { Text(text = "Create Story") })
        }
        StoryContent(isEditing.value)
    }
}</span></pre> <p class="calibre3"><span class="kobospan" id="kobo.468.1">As we can see, the </span><strong class="source-inline"><span class="kobospan" id="kobo.469.1">StoryEditorScreen</span></strong><span class="kobospan" id="kobo.470.1"> composable receives </span><strong class="source-inline"><span class="kobospan" id="kobo.471.1">StoryEditorViewModel</span></strong><span class="kobospan" id="kobo.472.1"> as a parameter, which provides data and functionality for this screen. </span><span class="kobospan" id="kobo.472.2">This </span><strong class="source-inline"><span class="kobospan" id="kobo.473.1">ViewModel</span></strong><span class="kobospan" id="kobo.474.1"> is provided by Koin, using the </span><span><strong class="source-inline"><span class="kobospan" id="kobo.475.1">koinViewModel</span></strong></span><span><span class="kobospan" id="kobo.476.1"> function.</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.477.1">Next, </span><strong class="source-inline"><span class="kobospan" id="kobo.478.1">isEditing</span></strong><span class="kobospan" id="kobo.479.1"> is a state derived from the </span><strong class="source-inline"><span class="kobospan" id="kobo.480.1">isEditing</span></strong><span class="kobospan" id="kobo.481.1"> state flow of </span><strong class="source-inline"><span class="kobospan" id="kobo.482.1">ViewModel</span></strong><span class="kobospan" id="kobo.483.1">. </span><span class="kobospan" id="kobo.483.2">This state will represent whether the user is in the process of editing a story or not. </span><span class="kobospan" id="kobo.483.3">The </span><strong class="source-inline"><span class="kobospan" id="kobo.484.1">collectAsState()</span></strong><span class="kobospan" id="kobo.485.1"> function collects the latest value from the state flow and represents it as a state in Compose. </span><span class="kobospan" id="kobo.485.2">Whenever the </span><strong class="source-inline"><span class="kobospan" id="kobo.486.1">isEditing</span></strong><span class="kobospan" id="kobo.487.1"> state flow emits a new value, the UI will recompose to reflect the </span><span><span class="kobospan" id="kobo.488.1">new state.</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.489.1">Inside </span><strong class="source-inline"><span class="kobospan" id="kobo.490.1">StoryEditorScreen</span></strong><span class="kobospan" id="kobo.491.1">, there’s a </span><strong class="source-inline"><span class="kobospan" id="kobo.492.1">Column</span></strong><span class="kobospan" id="kobo.493.1"> composable that takes up the maximum size of the screen. </span><span class="kobospan" id="kobo.493.2">A </span><strong class="source-inline"><span class="kobospan" id="kobo.494.1">Column</span></strong><span class="kobospan" id="kobo.495.1"> composable allows us to arrange its children vertically. </span><span class="kobospan" id="kobo.495.2">Inside this </span><strong class="source-inline"><span class="kobospan" id="kobo.496.1">Column</span></strong><span class="kobospan" id="kobo.497.1">, there’s a condition to check the </span><strong class="source-inline"><span class="kobospan" id="kobo.498.1">isEditing</span></strong><span class="kobospan" id="kobo.499.1"> state. </span><span class="kobospan" id="kobo.499.2">If </span><strong class="source-inline"><span class="kobospan" id="kobo.500.1">isEditing</span></strong><span class="kobospan" id="kobo.501.1"> is true, </span><strong class="source-inline"><span class="kobospan" id="kobo.502.1">TopAppBar</span></strong><span class="kobospan" id="kobo.503.1"> will be shown with </span><strong class="bold"><span class="kobospan" id="kobo.504.1">Create Story</span></strong><span class="kobospan" id="kobo.505.1"> as its title. </span><span class="kobospan" id="kobo.505.2">Here, </span><strong class="source-inline"><span class="kobospan" id="kobo.506.1">TopAppBar</span></strong><span class="kobospan" id="kobo.507.1"> is a composable that represents a Material Design App Bar and is generally placed at the top of the screen – this App Bar will only be shown when the user is in the </span><span><span class="kobospan" id="kobo.508.1">editing state.</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.509.1">The </span><strong class="source-inline"><span class="kobospan" id="kobo.510.1">StoryContent</span></strong><span class="kobospan" id="kobo.511.1"> composable is then included in </span><strong class="source-inline"><span class="kobospan" id="kobo.512.1">Column</span></strong><span class="kobospan" id="kobo.513.1">, outside of the condition for </span><strong class="source-inline"><span class="kobospan" id="kobo.514.1">isEditing</span></strong><span class="kobospan" id="kobo.515.1">. </span><span class="kobospan" id="kobo.515.2">This means that </span><strong class="source-inline"><span class="kobospan" id="kobo.516.1">StoryContent</span></strong><span class="kobospan" id="kobo.517.1"> will always be shown, regardless of whether the user is in editing mode or not. </span><span class="kobospan" id="kobo.517.2">The </span><strong class="source-inline"><span class="kobospan" id="kobo.518.1">isEditing</span></strong><span class="kobospan" id="kobo.519.1"> state is passed to </span><strong class="source-inline"><span class="kobospan" id="kobo.520.1">StoryContent</span></strong><span class="kobospan" id="kobo.521.1"> to inform it of the current editing status. </span><span class="kobospan" id="kobo.521.2">Let’s work on this </span><span><span class="kobospan" id="kobo.522.1">composable now.</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.523.1">This composable</span><a id="_idIndexMarker424" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.524.1"> should have a background that </span><a id="_idIndexMarker425" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.525.1">will be the image or the video the user wants to include in the story and will take all the space on the screen. </span><span class="kobospan" id="kobo.525.2">By doing this, the options on the screen will be different, depending on whether we’re capturing the media or editing it. </span><span class="kobospan" id="kobo.525.3">Here’s the code for </span><span><span class="kobospan" id="kobo.526.1">this composable:</span></span></p>
<pre class="source-code"><span class="kobospan1" id="kobo.527.1">
@Composable
fun StoryContent(
    isEditing: Boolean = false,
    modifier: Modifier = Modifier
) {
    Box(modifier = Modifier.fillMaxSize().padding(20.dp)) {
        Box(
            modifier = Modifier
                .fillMaxWidth()
                .wrapContentHeight()
        ) {
            Button(
                onClick = { /*Handle back*/},
                modifier =
                    Modifier.align(Alignment.TopStart)
            ) {
                Image(
                    painter = painterResource(id =
                        R.drawable.ic_arrow_back),
                    contentDescription = "Back button")
            }
            if (isEditing) {
                Button(
                    onClick =
                        { /* Handle create caption */ },
                    modifier =
                        Modifier.align(Alignment.TopEnd)
                ) {
                    Image(
                        painter = painterResource(id =
                            R.drawable.ic_caption),
                        contentDescription = "Create label"
                    )
                }
            }
    }
        Image(
            painter = painterResource(id =
                R.drawable.ic_default_image),
            modifier = Modifier.fillMaxSize(),
            contentDescription = "Default image"
        )
        Row(
            modifier = Modifier
                .wrapContentHeight()
                .align(Alignment.BottomCenter)
        ) {
            if (isEditing) {
                Button(
                    onClick =
                        { /* Handle create caption */ }
                ) {
                    Text(stringResource(id =
                        R.string.share_story))
                }
            } else {
                OutlinedButton(
                    onClick =
                        { /* Handle take a photo */ },
                    modifier= Modifier.size(50.dp),
                    shape = CircleShape,
                    border= BorderStroke(4.dp,
                        MaterialTheme.colorScheme.primary),
                    contentPadding = PaddingValues(0.dp),
                    colors =
                       ButtonDefaults.outlinedButtonColors(
                       contentColor =
                       MaterialTheme.colorScheme.primary)
                ) {
                }
            }
        }
    }
}</span></pre> <p class="calibre3"><span class="kobospan" id="kobo.528.1">Let’s break down </span><span><span class="kobospan" id="kobo.529.1">this code:</span></span></p>
<ul class="calibre15">
<li class="calibre14"><span class="kobospan" id="kobo.530.1">The outermost </span><strong class="source-inline1"><span class="kobospan" id="kobo.531.1">Box</span></strong><span class="kobospan" id="kobo.532.1"> is the main container, which takes up the maximum size of its parent</span><a id="_idIndexMarker426" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.533.1"> and </span><a id="_idIndexMarker427" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.534.1">adds a padding </span><span><span class="kobospan" id="kobo.535.1">of </span></span><span><strong class="source-inline1"><span class="kobospan" id="kobo.536.1">20.dp</span></strong></span><span><span class="kobospan" id="kobo.537.1">.</span></span></li>
<li class="calibre14"><span class="kobospan" id="kobo.538.1">The first child of </span><strong class="source-inline1"><span class="kobospan" id="kobo.539.1">Box</span></strong><span class="kobospan" id="kobo.540.1"> is another </span><strong class="source-inline1"><span class="kobospan" id="kobo.541.1">Box</span></strong><span class="kobospan" id="kobo.542.1"> that is set to take up the full width and wrap the </span><span><span class="kobospan" id="kobo.543.1">content height.</span></span></li>
<li class="calibre14"><span class="kobospan" id="kobo.544.1">Inside this </span><strong class="source-inline1"><span class="kobospan" id="kobo.545.1">Box</span></strong><span class="kobospan" id="kobo.546.1">, there is a </span><strong class="source-inline1"><span class="kobospan" id="kobo.547.1">Button</span></strong><span class="kobospan" id="kobo.548.1"> component aligned to the top-start corner of its parent </span><strong class="source-inline1"><span class="kobospan" id="kobo.549.1">Box</span></strong><span class="kobospan" id="kobo.550.1">. </span><span class="kobospan" id="kobo.550.2">This button is used to handle a back navigation action. </span><span class="kobospan" id="kobo.550.3">Inside this button is an </span><strong class="source-inline1"><span class="kobospan" id="kobo.551.1">Image</span></strong><span class="kobospan" id="kobo.552.1"> component with an </span><span><span class="kobospan" id="kobo.553.1">arrow icon.</span></span></li>
</ul>
<p class="callout-heading"><span class="kobospan" id="kobo.554.1">Note</span></p>
<p class="callout"><span class="kobospan" id="kobo.555.1">The terms “start” and “end” are used for layout positioning to ensure better support for both </span><strong class="bold"><span class="kobospan" id="kobo.556.1">left-to-right</span></strong><span class="kobospan" id="kobo.557.1"> (</span><strong class="bold"><span class="kobospan" id="kobo.558.1">LTR</span></strong><span class="kobospan" id="kobo.559.1">) and </span><strong class="bold"><span class="kobospan" id="kobo.560.1">right-to-left</span></strong><span class="kobospan" id="kobo.561.1"> (</span><strong class="bold"><span class="kobospan" id="kobo.562.1">RTL</span></strong><span class="kobospan" id="kobo.563.1">) languages. </span><span class="kobospan" id="kobo.563.2">When you use the “start” and “end” attributes </span><a id="_idIndexMarker428" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.564.1">in your</span><a id="_idIndexMarker429" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.565.1"> layout, Android automatically adjusts the orientation based on the text direction of the current locale. </span><span class="kobospan" id="kobo.565.2">In LTR languages such as English, “start” maps to “left” and “end” maps to “right,” while in RTL languages such as Arabic, “start” maps to “right” and “end” maps to “left.” </span><span class="kobospan" id="kobo.565.3">This approach simplifies the process of localizing your app for multiple languages and </span><span><span class="kobospan" id="kobo.566.1">text directions.</span></span></p>
<ul class="calibre15">
<li class="calibre14"><span class="kobospan" id="kobo.567.1">If the </span><strong class="source-inline1"><span class="kobospan" id="kobo.568.1">isEditing</span></strong><span class="kobospan" id="kobo.569.1"> flag is true, an additional </span><strong class="source-inline1"><span class="kobospan" id="kobo.570.1">Button</span></strong><span class="kobospan" id="kobo.571.1"> is added to </span><strong class="source-inline1"><span class="kobospan" id="kobo.572.1">Box</span></strong><span class="kobospan" id="kobo.573.1">. </span><span class="kobospan" id="kobo.573.2">This button, which is aligned to the top end (the right, in LTR layouts) of its parent </span><strong class="source-inline1"><span class="kobospan" id="kobo.574.1">Box</span></strong><span class="kobospan" id="kobo.575.1">, allows users to create a caption for their story. </span><span class="kobospan" id="kobo.575.2">The button uses an image of a caption icon to communicate </span><span><span class="kobospan" id="kobo.576.1">its function.</span></span></li>
<li class="calibre14"><span class="kobospan" id="kobo.577.1">The next child of the outermost </span><strong class="source-inline1"><span class="kobospan" id="kobo.578.1">Box</span></strong><span class="kobospan" id="kobo.579.1"> is </span><strong class="source-inline1"><span class="kobospan" id="kobo.580.1">Image</span></strong><span class="kobospan" id="kobo.581.1">, which displays a default image. </span><span class="kobospan" id="kobo.581.2">This </span><strong class="source-inline1"><span class="kobospan" id="kobo.582.1">Image</span></strong><span class="kobospan" id="kobo.583.1"> takes up the maximum size of </span><strong class="source-inline1"><span class="kobospan" id="kobo.584.1">Box</span></strong><span class="kobospan" id="kobo.585.1">, signifying that this image will be the main focus of </span><span><span class="kobospan" id="kobo.586.1">this screen.</span></span></li>
<li class="calibre14"><span class="kobospan" id="kobo.587.1">The last child of the outermost </span><strong class="source-inline1"><span class="kobospan" id="kobo.588.1">Box</span></strong><span class="kobospan" id="kobo.589.1"> is a Row that’s aligned to the bottom center of </span><strong class="source-inline1"><span class="kobospan" id="kobo.590.1">Box</span></strong><span class="kobospan" id="kobo.591.1">. </span><span class="kobospan" id="kobo.591.2">This </span><strong class="source-inline1"><span class="kobospan" id="kobo.592.1">Row</span></strong><span class="kobospan" id="kobo.593.1"> contains two different buttons that are displayed conditionally, based on the </span><span><strong class="source-inline1"><span class="kobospan" id="kobo.594.1">isEditing</span></strong></span><span><span class="kobospan" id="kobo.595.1"> flag.</span></span></li>
<li class="calibre14"><span class="kobospan" id="kobo.596.1">If </span><strong class="source-inline1"><span class="kobospan" id="kobo.597.1">isEditing</span></strong><span class="kobospan" id="kobo.598.1"> is false, </span><strong class="source-inline1"><span class="kobospan" id="kobo.599.1">OutlinedButton</span></strong><span class="kobospan" id="kobo.600.1"> is shown. </span><span class="kobospan" id="kobo.600.2">This button, styled to look like a </span><a id="_idIndexMarker430" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.601.1">circular</span><a id="_idIndexMarker431" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.602.1"> button with a border, allows the user to take a photo. </span><span class="kobospan" id="kobo.602.2">Note that the actual implementation for taking a photo is not included in the provided code and should be handled in the </span><span><strong class="source-inline1"><span class="kobospan" id="kobo.603.1">onClick</span></strong></span><span><span class="kobospan" id="kobo.604.1"> function.</span></span></li>
<li class="calibre14"><span class="kobospan" id="kobo.605.1">If </span><strong class="source-inline1"><span class="kobospan" id="kobo.606.1">isEditing</span></strong><span class="kobospan" id="kobo.607.1"> is true, a </span><strong class="source-inline1"><span class="kobospan" id="kobo.608.1">Button</span></strong><span class="kobospan" id="kobo.609.1"> component appears instead. </span><span class="kobospan" id="kobo.609.2">This button, labeled </span><strong class="bold"><span class="kobospan" id="kobo.610.1">Share Story</span></strong><span class="kobospan" id="kobo.611.1">, is intended to allow the user to share the created story. </span><span class="kobospan" id="kobo.611.2">As you can see, it is using </span><strong class="source-inline1"><span class="kobospan" id="kobo.612.1">stringResource</span></strong><span class="kobospan" id="kobo.613.1"> with a key of </span><strong class="source-inline1"><span class="kobospan" id="kobo.614.1">R.string.share_story</span></strong><span class="kobospan" id="kobo.615.1">, so we should add it to </span><strong class="source-inline1"><span class="kobospan" id="kobo.616.1">string.xml</span></strong><span class="kobospan" id="kobo.617.1">. </span><span class="kobospan" id="kobo.617.2">Again, the actual implementation of the share functionality should be handled in the </span><span><strong class="source-inline1"><span class="kobospan" id="kobo.618.1">onClick</span></strong></span><span><span class="kobospan" id="kobo.619.1"> function.</span></span></li>
</ul>
<p class="calibre3"><span class="kobospan" id="kobo.620.1">With the previous code, when the screen is in editing mode, it should look </span><span><span class="kobospan" id="kobo.621.1">like this:</span></span></p>
<div class="calibre2">
<div class="img---figure" id="_idContainer037">
<span class="kobospan" id="kobo.622.1"><img alt="Figure 4.4: The story screen in edit mode" src="image/B19443_04_004.jpg" class="calibre4"/></span>
</div>
</div>
<p class="img---caption" lang="en-US" xml:lang="en-US"><span class="kobospan" id="kobo.623.1">Figure 4.4: The story screen in edit mode</span></p>
<p class="calibre3"><span class="kobospan" id="kobo.624.1">Otherwise, when it is not</span><a id="_idIndexMarker432" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.625.1"> in </span><a id="_idIndexMarker433" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.626.1">editing mode, it will look </span><span><span class="kobospan" id="kobo.627.1">like this:</span></span></p>
<div class="calibre2">
<div class="img---figure" id="_idContainer038">
<span class="kobospan" id="kobo.628.1"><img alt="Figure 4.5: The story screen when it is not in edit mode" src="image/B19443_04_005.jpg" class="calibre4"/></span>
</div>
</div>
<p class="img---caption" lang="en-US" xml:lang="en-US"><span class="kobospan" id="kobo.629.1">Figure 4.5: The story screen when it is not in edit mode</span></p>
<p class="calibre3"><span class="kobospan" id="kobo.630.1">As we can see, it is easy and intuitive to add or remove composables conditionally from </span><span><span class="kobospan" id="kobo.631.1">a view.</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.632.1">With that, we’ve</span><a id="_idIndexMarker434" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.633.1"> finished </span><a id="_idIndexMarker435" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.634.1">the story screen, until we add more functionality in the next chapters to capture photos and video. </span><span class="kobospan" id="kobo.634.2">Let’s continue with the newsfeed </span><span><span class="kobospan" id="kobo.635.1">user interface.</span></span></p>
<h1 id="_idParaDest-97" class="calibre5"><a id="_idTextAnchor098" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.636.1">Creating the newsfeed screen and its components</span></h1>
<p class="calibre3"><span class="kobospan" id="kobo.637.1">The newsfeed is</span><a id="_idIndexMarker436" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.638.1"> the main screen of our Packtagram </span><a id="_idIndexMarker437" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.639.1">app and is where the user will see the latest posts from their friends. </span><span class="kobospan" id="kobo.639.2">It is structured using </span><span><span class="kobospan" id="kobo.640.1">several components:</span></span></p>
<ul class="calibre15">
<li class="calibre14"><strong class="bold"><span class="kobospan" id="kobo.641.1">Title bar</span></strong><span class="kobospan" id="kobo.642.1">: This is where the user can access the </span><span><span class="kobospan" id="kobo.643.1">messaging feature</span></span></li>
<li class="calibre14"><strong class="bold"><span class="kobospan" id="kobo.644.1">List of posts</span></strong><span class="kobospan" id="kobo.645.1">: The list of posts shown in </span><span><span class="kobospan" id="kobo.646.1">our app</span></span></li>
<li class="calibre14"><strong class="bold"><span class="kobospan" id="kobo.647.1">Bottom bar</span></strong><span class="kobospan" id="kobo.648.1">: This is used to navigate to different sections in </span><span><span class="kobospan" id="kobo.649.1">the app</span></span></li>
</ul>
<p class="calibre3"><span class="kobospan" id="kobo.650.1">We are going to start structuring our newsfeed screen by creating a </span><strong class="source-inline"><span class="kobospan" id="kobo.651.1">MainScreen</span></strong><span class="kobospan" id="kobo.652.1"> composable. </span><span class="kobospan" id="kobo.652.2">Here, we will define the user interface for the main view in our </span><span><span class="kobospan" id="kobo.653.1">Packtagram app.</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.654.1">This </span><strong class="source-inline"><span class="kobospan" id="kobo.655.1">MainScreen</span></strong><span class="kobospan" id="kobo.656.1"> composable will have a </span><strong class="source-inline"><span class="kobospan" id="kobo.657.1">Scaffold</span></strong><span class="kobospan" id="kobo.658.1"> composable as its main component. </span><span class="kobospan" id="kobo.658.2">Here, we will define the title bar and the bottom bar with the different options </span><span><span class="kobospan" id="kobo.659.1">for navigation:</span></span></p>
<pre class="source-code"><span class="kobospan1" id="kobo.660.1">
@Composable
fun MainScreen(
    modifier: Modifier = Modifier,
){
    val tabs = generateTabs()
    val selectedIndex = remember { mutableStateOf(0) }
    val pagerState = rememberPagerState(initialPage = 0)</span></pre> <p class="calibre3"><span class="kobospan" id="kobo.661.1">Here, we are starting with the composable declaration and the properties we need to handle the tabs that we are going to use in the </span><span><strong class="source-inline"><span class="kobospan" id="kobo.662.1">bottomBar</span></strong></span><span><span class="kobospan" id="kobo.663.1"> navigation.</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.664.1">Now, it’s time to add the </span><strong class="source-inline"><span class="kobospan" id="kobo.665.1">Scaffold</span></strong><span class="kobospan" id="kobo.666.1"> composable. </span><span class="kobospan" id="kobo.666.2">This is where we will add the </span><strong class="source-inline"><span class="kobospan" id="kobo.667.1">title</span></strong><span class="kobospan" id="kobo.668.1"> and </span><strong class="source-inline"><span class="kobospan" id="kobo.669.1">bottomBar</span></strong><span class="kobospan" id="kobo.670.1">. </span><span class="kobospan" id="kobo.670.2">Let’s start with </span><span><span class="kobospan" id="kobo.671.1">the </span></span><span><strong class="source-inline"><span class="kobospan" id="kobo.672.1">title</span></strong></span><span><span class="kobospan" id="kobo.673.1">:</span></span></p>
<pre class="source-code"><span class="kobospan1" id="kobo.674.1">
    Scaffold(
        topBar = {
            TopAppBar(
                title = {
                    Text(stringResource(R.string.app_name))
                },
                actions = {
                    IconButton(onClick =
                    { /* Menu action */ }) {
                        Icon(Icons.Rounded.Send,
                        contentDescription = "Messages")
                    }
                }
            )
        },</span></pre> <p class="calibre3"><span class="kobospan" id="kobo.675.1">With that, we have</span><a id="_idIndexMarker438" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.676.1"> created</span><a id="_idIndexMarker439" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.677.1"> the </span><strong class="source-inline"><span class="kobospan" id="kobo.678.1">Scaffold</span></strong><span class="kobospan" id="kobo.679.1"> composable and added </span><strong class="source-inline"><span class="kobospan" id="kobo.680.1">TopAppBar</span></strong><span class="kobospan" id="kobo.681.1">. </span><span class="kobospan" id="kobo.681.2">We used this in </span><a href="B19443_01.xhtml#_idTextAnchor015" class="calibre6 pcalibre1 pcalibre"><span><em class="italic"><span class="kobospan" id="kobo.682.1">Chapter 1</span></em></span></a><span class="kobospan" id="kobo.683.1">, but it is important to remember that a container is generally used to hold the title of the screen and any actions relevant to the screen’s context. </span><span class="kobospan" id="kobo.683.2">Here, </span><strong class="source-inline"><span class="kobospan" id="kobo.684.1">TopAppBar</span></strong><span class="kobospan" id="kobo.685.1"> takes in two </span><span><span class="kobospan" id="kobo.686.1">important lambdas:</span></span></p>
<ul class="calibre15">
<li class="calibre14"><strong class="source-inline1"><span class="kobospan" id="kobo.687.1">title</span></strong><span class="kobospan" id="kobo.688.1">: This is where you define the title of the App Bar. </span><span class="kobospan" id="kobo.688.2">In this case, it’s displaying a </span><strong class="source-inline1"><span class="kobospan" id="kobo.689.1">Text</span></strong><span class="kobospan" id="kobo.690.1"> composable that fetches a string resource – that is, the name of the </span><span><span class="kobospan" id="kobo.691.1">app (Packtagram).</span></span></li>
<li class="calibre14"><strong class="source-inline1"><span class="kobospan" id="kobo.692.1">actions</span></strong><span class="kobospan" id="kobo.693.1">: This is where we define the actions that will appear on the right-hand side of the App Bar. </span><span class="kobospan" id="kobo.693.2">Actions are typically represented with icons and are used to perform functions relevant to the current screen. </span><span class="kobospan" id="kobo.693.3">In this case, there’s a single </span><strong class="source-inline1"><span class="kobospan" id="kobo.694.1">IconButton</span></strong><span class="kobospan" id="kobo.695.1"> with an envelope icon (which, when clicked, would navigate the user to the </span><span><span class="kobospan" id="kobo.696.1">messaging screen).</span></span></li>
</ul>
<p class="calibre3"><span class="kobospan" id="kobo.697.1">The next step is to add </span><span><span class="kobospan" id="kobo.698.1">the </span></span><span><strong class="source-inline"><span class="kobospan" id="kobo.699.1">BottomBar</span></strong></span><span><span class="kobospan" id="kobo.700.1">:</span></span></p>
<pre class="source-code"><span class="kobospan1" id="kobo.701.1">
        bottomBar = {
            TabRow(selectedTabIndex = selectedIndex.value)
            {
                tabs.forEachIndexed { index, _ -&gt;
                    Tab(
                        icon = { Icon(tabs[index].icon,
                            contentDescription = null) },
                        selected = index ==
                            selectedIndex.value,
                        onClick = {
                            selectedIndex.value = index
                        }
                    )
                }
            }
        },</span></pre> <p class="calibre3"><span class="kobospan" id="kobo.702.1">Here, </span><strong class="source-inline"><span class="kobospan" id="kobo.703.1">BottomBar</span></strong><span class="kobospan" id="kobo.704.1"> is usually </span><a id="_idIndexMarker440" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.705.1">where </span><a id="_idIndexMarker441" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.706.1">navigation controls for the app are placed. </span><span class="kobospan" id="kobo.706.2">In this case, </span><strong class="source-inline"><span class="kobospan" id="kobo.707.1">TabRow</span></strong><span class="kobospan" id="kobo.708.1"> is used, which is a container for </span><strong class="source-inline"><span class="kobospan" id="kobo.709.1">Tab</span></strong><span class="kobospan" id="kobo.710.1"> composables. </span><span class="kobospan" id="kobo.710.2">The main Lambda of </span><strong class="source-inline"><span class="kobospan" id="kobo.711.1">TabRow</span></strong><span class="kobospan" id="kobo.712.1"> is used to generate the </span><strong class="source-inline"><span class="kobospan" id="kobo.713.1">Tab</span></strong><span class="kobospan" id="kobo.714.1"> elements. </span><span class="kobospan" id="kobo.714.2">It iterates through each </span><strong class="source-inline"><span class="kobospan" id="kobo.715.1">TabItem</span></strong><span class="kobospan" id="kobo.716.1"> in tabs (which is a list of </span><strong class="source-inline"><span class="kobospan" id="kobo.717.1">TabItem</span></strong><span class="kobospan" id="kobo.718.1"> objects generated by </span><strong class="source-inline"><span class="kobospan" id="kobo.719.1">generateTabs()</span></strong><span class="kobospan" id="kobo.720.1">), and for each one, it creates a </span><strong class="source-inline"><span class="kobospan" id="kobo.721.1">Tab</span></strong><span class="kobospan" id="kobo.722.1"> element. </span><span class="kobospan" id="kobo.722.2">The </span><strong class="source-inline"><span class="kobospan" id="kobo.723.1">Tab</span></strong><span class="kobospan" id="kobo.724.1"> element is provided with an icon from </span><strong class="source-inline"><span class="kobospan" id="kobo.725.1">TabItem</span></strong><span class="kobospan" id="kobo.726.1">, regardless of whether it’s selected (based on if its index matches </span><strong class="source-inline"><span class="kobospan" id="kobo.727.1">selectedIndex.value</span></strong><span class="kobospan" id="kobo.728.1">), and an </span><strong class="source-inline"><span class="kobospan" id="kobo.729.1">onClick</span></strong><span class="kobospan" id="kobo.730.1"> function that sets </span><strong class="source-inline"><span class="kobospan" id="kobo.731.1">selectedIndex.value</span></strong><span class="kobospan" id="kobo.732.1"> to the index of the </span><span><span class="kobospan" id="kobo.733.1">clicked </span></span><span><strong class="source-inline"><span class="kobospan" id="kobo.734.1">Tab</span></strong></span><span><span class="kobospan" id="kobo.735.1">.</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.736.1">Now, we need to add </span><a id="_idIndexMarker442" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.737.1">the</span><a id="_idIndexMarker443" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.738.1"> content to the </span><span><strong class="source-inline"><span class="kobospan" id="kobo.739.1">Scaffold</span></strong></span><span><span class="kobospan" id="kobo.740.1"> composable:</span></span></p>
<pre class="source-code"><span class="kobospan1" id="kobo.741.1">
        content = { innerPadding -&gt;
            HorizontalPager(
                modifier = Modifier.padding(innerPadding),
                pageCount = tabs.size,
                state = pagerState
            ) { index -&gt;
                when (index) {
                    0 -&gt; {
                        NewsFeed()
                    }
                    1 -&gt; {
                        //Search
                    }
                    2-&gt; {
                        // New publication
                    }
                    3-&gt; {
                        // Reels
                    }
                    4-&gt; {
                        // Profile
                    }
                }
            }
            LaunchedEffect(selectedIndex.value) {
                pagerState.animateScrollToPage(
                selectedIndex.value)
            }
        },
    )
}</span></pre> <p class="calibre3"><span class="kobospan" id="kobo.742.1">The </span><strong class="source-inline"><span class="kobospan" id="kobo.743.1">content</span></strong><span class="kobospan" id="kobo.744.1"> section is where the main content of your app goes. </span><span class="kobospan" id="kobo.744.2">In this case, the content is a </span><strong class="source-inline"><span class="kobospan" id="kobo.745.1">HorizontalPager</span></strong><span class="kobospan" id="kobo.746.1"> composable with pages corresponding to the tabs in the </span><span><span class="kobospan" id="kobo.747.1">bottom bar.</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.748.1">The main Lambda in </span><strong class="source-inline"><span class="kobospan" id="kobo.749.1">HorizontalPager</span></strong><span class="kobospan" id="kobo.750.1"> is used to generate each page. </span><span class="kobospan" id="kobo.750.2">The content of the page is determined by the index provided to the Lambda: when </span><strong class="source-inline"><span class="kobospan" id="kobo.751.1">index</span></strong><span class="kobospan" id="kobo.752.1"> is </span><strong class="source-inline"><span class="kobospan" id="kobo.753.1">0</span></strong><span class="kobospan" id="kobo.754.1">, </span><strong class="source-inline"><span class="kobospan" id="kobo.755.1">NewsFeed()</span></strong><span class="kobospan" id="kobo.756.1"> is displayed, and placeholders are left for the rest of the </span><span><span class="kobospan" id="kobo.757.1">navigation options.</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.758.1">There’s another Lambda inside the </span><strong class="source-inline"><span class="kobospan" id="kobo.759.1">content</span></strong><span class="kobospan" id="kobo.760.1"> section: the </span><strong class="source-inline"><span class="kobospan" id="kobo.761.1">LaunchedEffect</span></strong><span class="kobospan" id="kobo.762.1"> block. </span><span class="kobospan" id="kobo.762.2">This is essentially a side effect that is performed when </span><strong class="source-inline"><span class="kobospan" id="kobo.763.1">selectedIndex.value</span></strong><span class="kobospan" id="kobo.764.1"> changes. </span><span class="kobospan" id="kobo.764.2">In this case, it</span><a id="_idIndexMarker444" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.765.1"> triggers</span><a id="_idIndexMarker445" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.766.1"> an animation that scrolls </span><strong class="source-inline"><span class="kobospan" id="kobo.767.1">HorizontalPager</span></strong><span class="kobospan" id="kobo.768.1"> to the page that corresponds to the </span><span><span class="kobospan" id="kobo.769.1">selected index.</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.770.1">Now that </span><strong class="source-inline"><span class="kobospan" id="kobo.771.1">MainScreen</span></strong><span class="kobospan" id="kobo.772.1"> is ready, we can work on the </span><span><strong class="source-inline"><span class="kobospan" id="kobo.773.1">NewsFeed</span></strong></span><span><span class="kobospan" id="kobo.774.1"> list.</span></span></p>
</div>


<div id="_idContainer040" class="calibre2">
<h2 id="_idParaDest-98" class="calibre7"><a id="_idTextAnchor099" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.775.1">Creating the NewsFeed list</span></h2>
<p class="calibre3"><span class="kobospan" id="kobo.776.1">First, we need to</span><a id="_idIndexMarker446" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.777.1"> create the </span><strong class="source-inline"><span class="kobospan" id="kobo.778.1">ViewModel</span></strong><span class="kobospan" id="kobo.779.1"> class </span><a id="_idIndexMarker447" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.780.1">that we are going to use in our </span><strong class="source-inline"><span class="kobospan" id="kobo.781.1">NewsFeed</span></strong><span class="kobospan" id="kobo.782.1"> composable. </span><span class="kobospan" id="kobo.782.2">We will call it </span><strong class="source-inline"><span class="kobospan" id="kobo.783.1">NewsFeedViewModel</span></strong><span class="kobospan" id="kobo.784.1"> and add the </span><span><span class="kobospan" id="kobo.785.1">following code:</span></span></p>
<pre class="source-code"><span class="kobospan1" id="kobo.786.1">
class NewsFeedViewModel : ViewModel() {
    private val _posts =
        MutableStateFlow&lt;List&lt;Post&gt;&gt;(emptyList())
    val posts: StateFlow&lt;List&lt;Post&gt;&gt; get() = _posts
}</span></pre> <p class="calibre3"><span class="kobospan" id="kobo.787.1">Here, we are initializing </span><strong class="source-inline"><span class="kobospan" id="kobo.788.1">NewsFeedViewModel</span></strong><span class="kobospan" id="kobo.789.1">. </span><span class="kobospan" id="kobo.789.2">For now, we will only have a public property. </span><span class="kobospan" id="kobo.789.3">We’ll use this to gather information so that we can render the posts in the </span><span><span class="kobospan" id="kobo.790.1">user interface.</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.791.1">Now, it is time to handle the dependency injection for this </span><strong class="source-inline"><span class="kobospan" id="kobo.792.1">NewsFeedViewModel</span></strong><span class="kobospan" id="kobo.793.1">. </span><span class="kobospan" id="kobo.793.2">We are creating a dependency injection module per app module. </span><span class="kobospan" id="kobo.793.3">So, in this case, since we are working on the newsfeed module, we will create a new dependency injection module to </span><span><span class="kobospan" id="kobo.794.1">provide </span></span><span><strong class="source-inline"><span class="kobospan" id="kobo.795.1">NewsFeedViewModel</span></strong></span><span><span class="kobospan" id="kobo.796.1">:</span></span></p>
<pre class="source-code"><span class="kobospan1" id="kobo.797.1">
val newsFeedModule = module {
    viewModel&lt;NewsFeedViewModel&gt;()
}</span></pre> <p class="calibre3"><span class="kobospan" id="kobo.798.1">Then, we will </span><a id="_idIndexMarker448" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.799.1">add it to the modules</span><a id="_idIndexMarker449" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.800.1"> list </span><span><span class="kobospan" id="kobo.801.1">in </span></span><span><strong class="source-inline"><span class="kobospan" id="kobo.802.1">PacktagramApplication</span></strong></span><span><span class="kobospan" id="kobo.803.1">:</span></span></p>
<pre class="source-code"><span class="kobospan1" id="kobo.804.1">
class PacktagramApplication : Application() {
    override fun onCreate() {
        super.onCreate()
        startKoin {
...
</span><span class="kobospan1" id="kobo.804.2">            modules(
                appModule,
                storyModule,
                </span><strong class="bold1"><span class="kobospan1" id="kobo.805.1">newsFeedModule</span></strong><span class="kobospan1" id="kobo.806.1">
            )
        }
    }
}</span></pre> <p class="calibre3"><span class="kobospan" id="kobo.807.1">Here, we’ve added </span><strong class="source-inline"><span class="kobospan" id="kobo.808.1">newsFeedModule</span></strong><span class="kobospan" id="kobo.809.1"> to the already existing modules list </span><span><span class="kobospan" id="kobo.810.1">in </span></span><span><strong class="source-inline"><span class="kobospan" id="kobo.811.1">PacktagramApplication</span></strong></span><span><span class="kobospan" id="kobo.812.1">.</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.813.1">Now, we need to create the </span><strong class="source-inline"><span class="kobospan" id="kobo.814.1">NewsFeed</span></strong><span class="kobospan" id="kobo.815.1"> composable, which will include the list </span><span><span class="kobospan" id="kobo.816.1">of posts:</span></span></p>
<pre class="source-code"><span class="kobospan1" id="kobo.817.1">
@Composable
fun NewsFeed(
    modifier: Modifier = Modifier,
    viewModel: NewsFeedViewModel = koinViewModel()
) {
    LazyColumn{
        itemsIndexed(viewModel.posts){ _, post -&gt;
            PostItem(post = post)
        }
    }
}</span></pre> <p class="calibre3"><span class="kobospan" id="kobo.818.1">Here, we can use </span><strong class="source-inline"><span class="kobospan" id="kobo.819.1">LazyColumn</span></strong><span class="kobospan" id="kobo.820.1"> to render the list of posts. </span><span class="kobospan" id="kobo.820.2">As we can see, we will need a </span><strong class="source-inline"><span class="kobospan" id="kobo.821.1">PostItem</span></strong><span class="kobospan" id="kobo.822.1"> composable to </span><a id="_idIndexMarker450" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.823.1">draw </span><a id="_idIndexMarker451" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.824.1">every list item. </span><span class="kobospan" id="kobo.824.2">We will build this in the </span><span><span class="kobospan" id="kobo.825.1">following section.</span></span></p>
<h2 id="_idParaDest-99" class="calibre7"><a id="_idTextAnchor100" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.826.1">Creating the PostItem composable</span></h2>
<p class="calibre3"><span class="kobospan" id="kobo.827.1">Our </span><strong class="source-inline"><span class="kobospan" id="kobo.828.1">PostItem</span></strong><span class="kobospan" id="kobo.829.1"> composable </span><a id="_idIndexMarker452" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.830.1">will </span><a id="_idIndexMarker453" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.831.1">include all the components needed to render a post. </span><span class="kobospan" id="kobo.831.2">We will need </span><span><span class="kobospan" id="kobo.832.1">the following:</span></span></p>
<ul class="calibre15">
<li class="calibre14"><span class="kobospan" id="kobo.833.1">A title bar with the picture and name of </span><span><span class="kobospan" id="kobo.834.1">the author</span></span></li>
<li class="calibre14"><span class="kobospan" id="kobo.835.1">The media content (a picture initially but this could also be </span><span><span class="kobospan" id="kobo.836.1">a video)</span></span></li>
<li class="calibre14"><span class="kobospan" id="kobo.837.1">An action bar with several actions (like, share, and </span><span><span class="kobospan" id="kobo.838.1">so on)</span></span></li>
<li class="calibre14"><span class="kobospan" id="kobo.839.1">A label with the </span><span><span class="kobospan" id="kobo.840.1">likes count</span></span></li>
<li class="calibre14"><span class="kobospan" id="kobo.841.1">A caption written by </span><span><span class="kobospan" id="kobo.842.1">the author</span></span></li>
<li class="calibre14"><span class="kobospan" id="kobo.843.1">The timestamp of the </span><span><span class="kobospan" id="kobo.844.1">post’s publication</span></span></li>
</ul>
<p class="calibre3"><span class="kobospan" id="kobo.845.1">Following those requirements, this is what our </span><strong class="source-inline"><span class="kobospan" id="kobo.846.1">PostItem</span></strong><span class="kobospan" id="kobo.847.1"> composable will </span><span><span class="kobospan" id="kobo.848.1">look like:</span></span></p>
<pre class="source-code"><span class="kobospan1" id="kobo.849.1">
@Composable
fun PostItem(
    post: Post
){
    Column{
        Spacer(modifier = Modifier.height(2.dp))
        TitleBar(post = post)
        MediaContent(post = post)
        ActionsBar()
        LikesCount(post = post)
        Caption(post = post)
        Spacer(modifier = Modifier.height(2.dp))
        CommentsCount(post = post)
        Spacer(modifier = Modifier.height(4.dp))
        TimeStamp(post = post)
        Spacer(modifier = Modifier.height(10.dp))
    }
}</span></pre> <p class="calibre3"><span class="kobospan" id="kobo.850.1">As you can see, it is very readable and almost self-explanatory. </span><span class="kobospan" id="kobo.850.2">We will create a </span><strong class="source-inline"><span class="kobospan" id="kobo.851.1">Column</span></strong><span class="kobospan" id="kobo.852.1"> composable </span><a id="_idIndexMarker454" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.853.1">and place </span><a id="_idIndexMarker455" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.854.1">every one of the composables we need vertically, leaving some spaces between </span><span><span class="kobospan" id="kobo.855.1">as needed.</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.856.1">Now, let’s create the composables we’ll need. </span><span class="kobospan" id="kobo.856.2">We will start in order, </span><span><span class="kobospan" id="kobo.857.1">with </span></span><span><strong class="source-inline"><span class="kobospan" id="kobo.858.1">TitleBar</span></strong></span><span><span class="kobospan" id="kobo.859.1">:</span></span></p>
<pre class="source-code"><span class="kobospan1" id="kobo.860.1">
@Composable
fun TitleBar(
    modifier: Modifier = Modifier,
    post: Post
){
    Row(
        modifier = modifier
            .fillMaxWidth()
            .height(56.dp)
        ,
        verticalAlignment = Alignment.CenterVertically
    ) {
        Spacer(modifier = modifier.width(5.dp))
        Image(
            modifier = modifier
                .size(40.dp)
                .weight(1f),
            painter = painterResource(id =
                post.user.image),
            contentDescription =
                "User ${post.user.name} avatar"
        )
        Text(
            text = post.user.name,
            modifier = modifier
                .weight(8f)
                .padding(start = 10.dp),
            fontWeight = FontWeight.Bold
        )
        IconButton(onClick = { /* Menu options */}) {
            Icon(
                Icons.Outlined.MoreVert,
                "More options"
            )
        }
    }
}</span></pre> <p class="calibre3"><span class="kobospan" id="kobo.861.1">The base for this composable will be a </span><strong class="source-inline"><span class="kobospan" id="kobo.862.1">Row</span></strong><span class="kobospan" id="kobo.863.1"> composable as it will arrange its children in a horizontal sequence. </span><span class="kobospan" id="kobo.863.2">The </span><strong class="source-inline"><span class="kobospan" id="kobo.864.1">verticalAlignment</span></strong><span class="kobospan" id="kobo.865.1"> parameter is set to </span><strong class="source-inline"><span class="kobospan" id="kobo.866.1">Alignment.CenterVertically</span></strong><span class="kobospan" id="kobo.867.1"> to align the items in the row vertically in </span><span><span class="kobospan" id="kobo.868.1">the center.</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.869.1">Here’s a description of </span><a id="_idIndexMarker456" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.870.1">the children </span><a id="_idIndexMarker457" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.871.1">composables that </span><span><span class="kobospan" id="kobo.872.1">were used:</span></span></p>
<ul class="calibre15">
<li class="calibre14"><strong class="source-inline1"><span class="kobospan" id="kobo.873.1">Spacer</span></strong><span class="kobospan" id="kobo.874.1">: This is used to provide some space on the interface. </span><span class="kobospan" id="kobo.874.2">Here, it provides a width of </span><strong class="source-inline1"><span class="kobospan" id="kobo.875.1">5.dp</span></strong><span class="kobospan" id="kobo.876.1"> at the start of </span><span><span class="kobospan" id="kobo.877.1">the row.</span></span></li>
<li class="calibre14"><strong class="source-inline1"><span class="kobospan" id="kobo.878.1">Image</span></strong><span class="kobospan" id="kobo.879.1">: This is an image composable that is being used to display the user’s profile picture. </span><span class="kobospan" id="kobo.879.2">The image source is taken from the </span><strong class="source-inline1"><span class="kobospan" id="kobo.880.1">Post</span></strong><span class="kobospan" id="kobo.881.1"> object that was </span><span><span class="kobospan" id="kobo.882.1">passed in.</span></span></li>
<li class="calibre14"><strong class="source-inline1"><span class="kobospan" id="kobo.883.1">Text</span></strong><span class="kobospan" id="kobo.884.1">: This displays the user’s name and takes the name from the </span><strong class="source-inline1"><span class="kobospan" id="kobo.885.1">Post</span></strong><span class="kobospan" id="kobo.886.1"> object that was passed in. </span><span class="kobospan" id="kobo.886.2">The </span><strong class="source-inline1"><span class="kobospan" id="kobo.887.1">fontWeight</span></strong><span class="kobospan" id="kobo.888.1"> parameter is set to </span><strong class="source-inline1"><span class="kobospan" id="kobo.889.1">FontWeight.Bold</span></strong><span class="kobospan" id="kobo.890.1"> to make the </span><span><span class="kobospan" id="kobo.891.1">text bold.</span></span></li>
<li class="calibre14"><strong class="source-inline1"><span class="kobospan" id="kobo.892.1">IconButton</span></strong><span class="kobospan" id="kobo.893.1">: This is a button with an icon. </span><span class="kobospan" id="kobo.893.2">The </span><strong class="source-inline1"><span class="kobospan" id="kobo.894.1">onClick</span></strong><span class="kobospan" id="kobo.895.1"> parameter is a Lambda function that gets called when the button is clicked. </span><span class="kobospan" id="kobo.895.2">In this case, the function is empty, but this is where you would put code to handle the button press. </span><span class="kobospan" id="kobo.895.3">The </span><strong class="source-inline1"><span class="kobospan" id="kobo.896.1">Icon</span></strong><span class="kobospan" id="kobo.897.1"> element inside is used to display the </span><span><strong class="source-inline1"><span class="kobospan" id="kobo.898.1">more-options</span></strong></span><span><span class="kobospan" id="kobo.899.1"> icon.</span></span></li>
</ul>
<p class="calibre3"><span class="kobospan" id="kobo.900.1">Now that </span><strong class="source-inline"><span class="kobospan" id="kobo.901.1">TitleBar</span></strong><span class="kobospan" id="kobo.902.1"> is ready, it’s time for the </span><strong class="source-inline"><span class="kobospan" id="kobo.903.1">MediaContent</span></strong><span class="kobospan" id="kobo.904.1"> composable, which will display the content that the user </span><span><span class="kobospan" id="kobo.905.1">has posted:</span></span></p>
<pre class="source-code"><span class="kobospan1" id="kobo.906.1">
@Composable
fun MediaContent (
    modifier: Modifier = Modifier,
    post: Post
){
    Box(
        modifier = modifier
            .fillMaxWidth()
            .height(300.dp),
        contentAlignment = Alignment.Center,
        ) {
        Image(
            modifier = Modifier
                .fillMaxSize(),
            painter = rememberImagePainter(post.image),
            contentDescription = null
        )
    }
}</span></pre> <p class="calibre3"><span class="kobospan" id="kobo.907.1">The preceding code generates</span><a id="_idIndexMarker458" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.908.1"> a box </span><a id="_idIndexMarker459" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.909.1">that contains an image as this composable is used to display the main image content of a post. </span><span class="kobospan" id="kobo.909.2">These are the </span><span><span class="kobospan" id="kobo.910.1">main components:</span></span></p>
<ul class="calibre15">
<li class="calibre14"><strong class="source-inline1"><span class="kobospan" id="kobo.911.1">Box</span></strong><span class="kobospan" id="kobo.912.1">: This is a layout composable that stacks its children. </span><span class="kobospan" id="kobo.912.2">In this case, it’s used to hold an </span><strong class="source-inline1"><span class="kobospan" id="kobo.913.1">Image</span></strong><span class="kobospan" id="kobo.914.1"> component. </span><span class="kobospan" id="kobo.914.2">The </span><strong class="source-inline1"><span class="kobospan" id="kobo.915.1">contentAlignment</span></strong><span class="kobospan" id="kobo.916.1"> parameter is set to </span><strong class="source-inline1"><span class="kobospan" id="kobo.917.1">Alignment.Center</span></strong><span class="kobospan" id="kobo.918.1"> to center the image in the box and has a modifier applied to it to fill the maximum width and to set a height </span><span><span class="kobospan" id="kobo.919.1">of </span></span><span><strong class="source-inline1"><span class="kobospan" id="kobo.920.1">300.dp</span></strong></span><span><span class="kobospan" id="kobo.921.1">.</span></span></li>
<li class="calibre14"><strong class="source-inline1"><span class="kobospan" id="kobo.922.1">Image</span></strong><span class="kobospan" id="kobo.923.1">: This is an </span><strong class="source-inline1"><span class="kobospan" id="kobo.924.1">Image</span></strong><span class="kobospan" id="kobo.925.1"> composable that’s used to display an image. </span><span class="kobospan" id="kobo.925.2">The image source is taken from the </span><strong class="source-inline1"><span class="kobospan" id="kobo.926.1">Post</span></strong><span class="kobospan" id="kobo.927.1"> object passed in. </span><span class="kobospan" id="kobo.927.2">The modifier is used to ensure the image fills the maximum size of the </span><strong class="source-inline1"><span class="kobospan" id="kobo.928.1">Box</span></strong><span class="kobospan" id="kobo.929.1"> composable. </span><span class="kobospan" id="kobo.929.2">Here, </span><strong class="source-inline1"><span class="kobospan" id="kobo.930.1">rememberImagePainter</span></strong><span class="kobospan" id="kobo.931.1"> is used to load and display the image from a source (such as a URL or a local file), and it’s remembered </span><span><span class="kobospan" id="kobo.932.1">across recompositions.</span></span></li>
</ul>
<p class="calibre3"><span class="kobospan" id="kobo.933.1">Now that we’ve completed the </span><strong class="source-inline"><span class="kobospan" id="kobo.934.1">MediaContent</span></strong><span class="kobospan" id="kobo.935.1"> composable, we will consider </span><strong class="source-inline"><span class="kobospan" id="kobo.936.1">ActionsBar</span></strong><span class="kobospan" id="kobo.937.1">, which </span><a id="_idIndexMarker460" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.938.1">will provide </span><a id="_idIndexMarker461" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.939.1">the instructions to render the </span><span><span class="kobospan" id="kobo.940.1">action buttons:</span></span></p>
<pre class="source-code"><span class="kobospan1" id="kobo.941.1">
@Composable
fun ActionsBar(
    modifier: Modifier = Modifier,
){
    Column(
        modifier = modifier
            .fillMaxWidth()
            .height(40.dp),
        horizontalAlignment = Alignment.CenterHorizontally,
    ) {
        Row(
            modifier = modifier
                .fillMaxSize()
        ) {
            Row(
                modifier = modifier
                    .fillMaxHeight()
                    .weight(1f)
                ,
                verticalAlignment =
                    Alignment.CenterVertically,
            ) {
                IconButton(onClick = { }) {
                    Icon(
                        imageVector =
                            Icons.Outlined.Favorite,
                        contentDescription = "like",
                        modifier = modifier
                    )
                }
                IconButton(onClick = { }) {
                    Icon(
                        imageVector = Icons.Outlined.Edit,
                        contentDescription = "comment",
                        modifier = modifier
                    )
                }
                IconButton(onClick = { }) {
                    Icon(
                        imageVector = Icons.Outlined.Share,
                        contentDescription = "share",
                        modifier = modifier
                    )
                }
                Row(
                    modifier = modifier
                        .fillMaxHeight()
                        .weight(1f)
                ) {
                }
                Row(
                    modifier = modifier
                        .fillMaxHeight()
                        .weight(1f),
                    verticalAlignment =
                        Alignment.CenterVertically,
                    horizontalArrangement = Arrangement.End
                ) {
                    IconButton(onClick = { }) {
                        Icon(
                            imageVector =
                                Icons.Outlined.Star,
                            contentDescription =
                                "bookmark",
                            )
                    }
                }
            }
        }
    }
}</span></pre> <p class="calibre3"><span class="kobospan" id="kobo.942.1">The preceding code generates a UI that represents the action buttons under a post, similar to those on Instagram where you can like, comment, share, and bookmark a post. </span><span class="kobospan" id="kobo.942.2">Here’s what each part of the </span><span><span class="kobospan" id="kobo.943.1">function does:</span></span></p>
<ul class="calibre15">
<li class="calibre14"><strong class="source-inline1"><span class="kobospan" id="kobo.944.1">Column</span></strong><span class="kobospan" id="kobo.945.1">: This creates a column in which you can place other UI elements vertically. </span><span class="kobospan" id="kobo.945.2">The </span><strong class="source-inline1"><span class="kobospan" id="kobo.946.1">horizontalAlignment</span></strong><span class="kobospan" id="kobo.947.1"> parameter is set to </span><strong class="source-inline1"><span class="kobospan" id="kobo.948.1">Alignment.CenterHorizontally</span></strong><span class="kobospan" id="kobo.949.1">, which centers the elements horizontally in </span><span><span class="kobospan" id="kobo.950.1">the column.</span></span></li>
<li class="calibre14"><strong class="source-inline1"><span class="kobospan" id="kobo.951.1">Row</span></strong><span class="kobospan" id="kobo.952.1">: This creates a row in which other UI elements can be placed horizontally. </span><span class="kobospan" id="kobo.952.2">It fills the maximum size of the parent, which </span><span><span class="kobospan" id="kobo.953.1">is </span></span><span><strong class="source-inline1"><span class="kobospan" id="kobo.954.1">Column</span></strong></span><span><span class="kobospan" id="kobo.955.1">.</span></span></li>
<li class="calibre14"><span class="kobospan" id="kobo.956.1">The first group of three </span><strong class="source-inline1"><span class="kobospan" id="kobo.957.1">IconButton</span></strong><span class="kobospan" id="kobo.958.1"> composables are in a </span><strong class="source-inline1"><span class="kobospan" id="kobo.959.1">Row</span></strong><span class="kobospan" id="kobo.960.1"> composable and </span><a id="_idIndexMarker462" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.961.1">are for</span><a id="_idIndexMarker463" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.962.1"> the </span><strong class="source-inline1"><span class="kobospan" id="kobo.963.1">Like</span></strong><span class="kobospan" id="kobo.964.1">, </span><strong class="source-inline1"><span class="kobospan" id="kobo.965.1">Comment</span></strong><span class="kobospan" id="kobo.966.1">, and </span><strong class="source-inline1"><span class="kobospan" id="kobo.967.1">Share</span></strong><span class="kobospan" id="kobo.968.1"> actions. </span><span class="kobospan" id="kobo.968.2">Each </span><strong class="source-inline1"><span class="kobospan" id="kobo.969.1">IconButton</span></strong><span class="kobospan" id="kobo.970.1"> takes a Lambda for the </span><strong class="source-inline1"><span class="kobospan" id="kobo.971.1">onClick</span></strong><span class="kobospan" id="kobo.972.1"> event, which currently </span><span><span class="kobospan" id="kobo.973.1">does nothing.</span></span></li>
<li class="calibre14"><span class="kobospan" id="kobo.974.1">There are then two additional </span><strong class="source-inline1"><span class="kobospan" id="kobo.975.1">Row</span></strong><span class="kobospan" id="kobo.976.1"> composables, both with </span><strong class="source-inline1"><span class="kobospan" id="kobo.977.1">fillMaxHeight().weight(1f)</span></strong><span class="kobospan" id="kobo.978.1">, that appear to be placeholders, perhaps for adding additional icons in </span><span><span class="kobospan" id="kobo.979.1">the future.</span></span></li>
<li class="calibre14"><span class="kobospan" id="kobo.980.1">The final </span><strong class="source-inline1"><span class="kobospan" id="kobo.981.1">Row</span></strong><span class="kobospan" id="kobo.982.1"> composable has an </span><strong class="source-inline1"><span class="kobospan" id="kobo.983.1">IconButton</span></strong><span class="kobospan" id="kobo.984.1"> composable for the </span><strong class="source-inline1"><span class="kobospan" id="kobo.985.1">Bookmark</span></strong><span class="kobospan" id="kobo.986.1"> action. </span><span class="kobospan" id="kobo.986.2">It has </span><strong class="source-inline1"><span class="kobospan" id="kobo.987.1">verticalAlignment</span></strong><span class="kobospan" id="kobo.988.1"> set to </span><strong class="source-inline1"><span class="kobospan" id="kobo.989.1">Alignment.CenterVertically</span></strong><span class="kobospan" id="kobo.990.1"> and </span><strong class="source-inline1"><span class="kobospan" id="kobo.991.1">horizontalArrangement</span></strong><span class="kobospan" id="kobo.992.1"> set to </span><strong class="source-inline1"><span class="kobospan" id="kobo.993.1">Arrangement.End</span></strong><span class="kobospan" id="kobo.994.1"> to position the icon in the center vertically and at the end (right-hand side in LTR layouts) of the available </span><span><span class="kobospan" id="kobo.995.1">space horizontally.</span></span></li>
<li class="calibre14"><strong class="source-inline1"><span class="kobospan" id="kobo.996.1">Icon</span></strong><span class="kobospan" id="kobo.997.1">: Each </span><strong class="source-inline1"><span class="kobospan" id="kobo.998.1">Icon</span></strong><span class="kobospan" id="kobo.999.1"> displays an image and has a </span><strong class="source-inline1"><span class="kobospan" id="kobo.1000.1">contentDescription</span></strong><span class="kobospan" id="kobo.1001.1"> composable for accessibility purposes. </span><span class="kobospan" id="kobo.1001.2">The </span><strong class="source-inline1"><span class="kobospan" id="kobo.1002.1">modifier</span></strong><span class="kobospan" id="kobo.1003.1"> parameter can be used to adjust the layout or other visual properties of </span><span><span class="kobospan" id="kobo.1004.1">the icon.</span></span></li>
</ul>
<p class="calibre3"><span class="kobospan" id="kobo.1005.1">Having configured the </span><strong class="source-inline"><span class="kobospan" id="kobo.1006.1">ActionsBar</span></strong><span class="kobospan" id="kobo.1007.1"> composable to provide a flexible UI layout featuring a range of interactive buttons, our next focus will be the likes count. </span><span class="kobospan" id="kobo.1007.2">It’s very straightforward </span><span><span class="kobospan" id="kobo.1008.1">to implement:</span></span></p>
<pre class="source-code"><span class="kobospan1" id="kobo.1009.1">
@Composable
fun LikesCount(
    modifier: Modifier = Modifier,
    post: Post
){
    Row(
        modifier = modifier
            .fillMaxWidth()
            .height(30.dp)
            .padding(horizontal = 10.dp)
        ,
        verticalAlignment = Alignment.CenterVertically
    ) {
        Text(
            text = post.likesCount.toString().plus(
                «likes"),
            fontWeight = FontWeight.Bold,
            fontSize = 16.sp
        )
    }
}</span></pre> <p class="calibre3"><span class="kobospan" id="kobo.1010.1">The </span><strong class="source-inline"><span class="kobospan" id="kobo.1011.1">LikesCount</span></strong><span class="kobospan" id="kobo.1012.1"> function</span><a id="_idIndexMarker464" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.1013.1"> is a </span><strong class="source-inline"><span class="kobospan" id="kobo.1014.1">Composable</span></strong><span class="kobospan" id="kobo.1015.1"> function that creates a row to display the number of likes that a post has received. </span><span class="kobospan" id="kobo.1015.2">Here’s what each part of the </span><span><span class="kobospan" id="kobo.1016.1">function does:</span></span></p>
<ul class="calibre15">
<li class="calibre14"><strong class="source-inline1"><span class="kobospan" id="kobo.1017.1">Row</span></strong><span class="kobospan" id="kobo.1018.1">: This creates a row in which other UI elements can be placed horizontally. </span><span class="kobospan" id="kobo.1018.2">It uses the provided modifier to fill the maximum width of the parent container, setting its height to </span><strong class="source-inline1"><span class="kobospan" id="kobo.1019.1">30.dp</span></strong><span class="kobospan" id="kobo.1020.1"> and adding a padding of </span><strong class="source-inline1"><span class="kobospan" id="kobo.1021.1">10.dp</span></strong><span class="kobospan" id="kobo.1022.1"> horizontally. </span><span class="kobospan" id="kobo.1022.2">The </span><strong class="source-inline1"><span class="kobospan" id="kobo.1023.1">verticalAlignment</span></strong><span class="kobospan" id="kobo.1024.1"> parameter is set to </span><strong class="source-inline1"><span class="kobospan" id="kobo.1025.1">Alignment.CenterVertically</span></strong><span class="kobospan" id="kobo.1026.1">, which centers the elements vertically in </span><span><span class="kobospan" id="kobo.1027.1">the row.</span></span></li>
<li class="calibre14"><strong class="source-inline1"><span class="kobospan" id="kobo.1028.1">Text</span></strong><span class="kobospan" id="kobo.1029.1">: This creates a text element that displays the number of likes that the post has received. </span><span class="kobospan" id="kobo.1029.2">It gets the </span><strong class="source-inline1"><span class="kobospan" id="kobo.1030.1">likesCount</span></strong><span class="kobospan" id="kobo.1031.1"> field from the </span><strong class="source-inline1"><span class="kobospan" id="kobo.1032.1">Post</span></strong><span class="kobospan" id="kobo.1033.1"> object, converts it into a string, and appends the word </span><strong class="bold"><span class="kobospan" id="kobo.1034.1">likes</span></strong><span class="kobospan" id="kobo.1035.1"> to the end. </span><span class="kobospan" id="kobo.1035.2">It also sets the font weight to bold and the font size </span><span><span class="kobospan" id="kobo.1036.1">to </span></span><span><strong class="source-inline1"><span class="kobospan" id="kobo.1037.1">16.sp</span></strong></span><span><span class="kobospan" id="kobo.1038.1">.</span></span></li>
</ul>
<p class="calibre3"><span class="kobospan" id="kobo.1039.1">The next composable</span><a id="_idIndexMarker465" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.1040.1"> is the</span><a id="_idIndexMarker466" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.1041.1"> caption, which is the text that the user adds to </span><span><span class="kobospan" id="kobo.1042.1">the post:</span></span></p>
<pre class="source-code"><span class="kobospan1" id="kobo.1043.1">
@Composable
fun Caption(
    modifier: Modifier = Modifier,
    post: Post
){
    Row(
        modifier = modifier
            .fillMaxWidth()
            .wrapContentHeight()
            .padding(horizontal = 10.dp)
        ,
        verticalAlignment = Alignment.CenterVertically
    ) {
        Text(
            text = buildAnnotatedString {
                val boldStyle = SpanStyle(
                    fontWeight = Bold,
                    fontSize = 14.sp
                )
                val normalStyle = SpanStyle(
                    fontWeight = FontWeight.Normal,
                    fontSize = 14.sp
                )
                pushStyle(boldStyle)
                append(post.user.name)
                append(" ")
                if (post.caption.isNotEmpty()){
                    pushStyle(normalStyle)
                    append(post.caption)
                }
            }
        )
    }
}</span></pre> <p class="calibre3"><span class="kobospan" id="kobo.1044.1">Here’s what each part </span><a id="_idIndexMarker467" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.1045.1">of the</span><a id="_idIndexMarker468" class="calibre6 pcalibre1 pcalibre"/> <span><span class="kobospan" id="kobo.1046.1">function does:</span></span></p>
<ul class="calibre15">
<li class="calibre14"><strong class="source-inline1"><span class="kobospan" id="kobo.1047.1">Row</span></strong><span class="kobospan" id="kobo.1048.1">: This creates a row in which other UI elements can be placed horizontally. </span><span class="kobospan" id="kobo.1048.2">It uses the provided modifier to fill the maximum width of the parent container, wrap its height to its content, and add a padding of </span><strong class="source-inline1"><span class="kobospan" id="kobo.1049.1">10.dp</span></strong><span class="kobospan" id="kobo.1050.1"> horizontally. </span><span class="kobospan" id="kobo.1050.2">The </span><strong class="source-inline1"><span class="kobospan" id="kobo.1051.1">verticalAlignment</span></strong><span class="kobospan" id="kobo.1052.1"> parameter is set to </span><strong class="source-inline1"><span class="kobospan" id="kobo.1053.1">Alignment.CenterVertically</span></strong><span class="kobospan" id="kobo.1054.1">, which centers the elements vertically in </span><span><span class="kobospan" id="kobo.1055.1">the row.</span></span></li>
<li class="calibre14"><strong class="source-inline1"><span class="kobospan" id="kobo.1056.1">Text</span></strong><span class="kobospan" id="kobo.1057.1">: This creates a text element that displays the caption of the post, preceded by the user’s name. </span><span class="kobospan" id="kobo.1057.2">The </span><strong class="source-inline1"><span class="kobospan" id="kobo.1058.1">buildAnnotatedString</span></strong><span class="kobospan" id="kobo.1059.1"> function is used to build a string with different text styles for different parts. </span><span class="kobospan" id="kobo.1059.2">Thanks to that, the user’s name is styled with a bold font weight, and the caption is styled with a normal </span><span><span class="kobospan" id="kobo.1060.1">font weight.</span></span></li>
</ul>
<p class="calibre3"><span class="kobospan" id="kobo.1061.1">Upon completing the </span><strong class="source-inline"><span class="kobospan" id="kobo.1062.1">Caption</span></strong><span class="kobospan" id="kobo.1063.1"> composable, let’s tackle the </span><span><strong class="source-inline"><span class="kobospan" id="kobo.1064.1">CommentsCount</span></strong></span><span><span class="kobospan" id="kobo.1065.1"> composable:</span></span></p>
<pre class="source-code"><span class="kobospan1" id="kobo.1066.1">
@Composable
fun CommentsCount(
    modifier: Modifier = Modifier,
    post: Post
) {
    Row(
        modifier = modifier
            .fillMaxWidth()
            .wrapContentHeight()
            .padding(horizontal = 10.dp),
        verticalAlignment = Alignment.CenterVertically
    ) {
        Text(
            text = stringResource(R.string.comment_count,
                post.commentsCount),
            fontWeight = FontWeight.Normal,
            fontSize = 14.sp
        )
    }
}</span></pre> <p class="calibre3"><span class="kobospan" id="kobo.1067.1">The </span><strong class="source-inline"><span class="kobospan" id="kobo.1068.1">CommentsCount</span></strong><span class="kobospan" id="kobo.1069.1"> composable </span><a id="_idIndexMarker469" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.1070.1">creates </span><a id="_idIndexMarker470" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.1071.1">a layout to display the number of comments on a post. </span><span class="kobospan" id="kobo.1071.2">Here’s what each part of the </span><span><span class="kobospan" id="kobo.1072.1">function does:</span></span></p>
<ul class="calibre15">
<li class="calibre14"><strong class="source-inline1"><span class="kobospan" id="kobo.1073.1">Row</span></strong><span class="kobospan" id="kobo.1074.1">: This creates a row in which other UI elements can be placed horizontally. </span><span class="kobospan" id="kobo.1074.2">It uses the provided modifier to fill the maximum width of the parent container, wrap its height to its content, and add a padding of </span><strong class="source-inline1"><span class="kobospan" id="kobo.1075.1">10.dp</span></strong><span class="kobospan" id="kobo.1076.1"> horizontally. </span><span class="kobospan" id="kobo.1076.2">The </span><strong class="source-inline1"><span class="kobospan" id="kobo.1077.1">verticalAlignment</span></strong><span class="kobospan" id="kobo.1078.1"> parameter is set to </span><strong class="source-inline1"><span class="kobospan" id="kobo.1079.1">Alignment.CenterVertically</span></strong><span class="kobospan" id="kobo.1080.1">, which centers the elements vertically in </span><span><span class="kobospan" id="kobo.1081.1">the row.</span></span></li>
<li class="calibre14"><strong class="source-inline1"><span class="kobospan" id="kobo.1082.1">Text</span></strong><span class="kobospan" id="kobo.1083.1">: This creates a text element that displays the number of comments. </span><span class="kobospan" id="kobo.1083.2">The </span><strong class="source-inline1"><span class="kobospan" id="kobo.1084.1">stringResource</span></strong><span class="kobospan" id="kobo.1085.1"> function is used to get a string resource, which is a format string that takes a number and inserts it into the correct place to form a string that says </span><strong class="bold"><span class="kobospan" id="kobo.1086.1">Read 3 comments</span></strong><span class="kobospan" id="kobo.1087.1">. </span><span class="kobospan" id="kobo.1087.2">The string format is then filled in with the number of comments from the </span><span><strong class="source-inline1"><span class="kobospan" id="kobo.1088.1">Post</span></strong></span><span><span class="kobospan" id="kobo.1089.1"> object.</span></span></li>
</ul>
<p class="calibre3"><span class="kobospan" id="kobo.1090.1">Now that we’ve finished</span><a id="_idIndexMarker471" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.1091.1"> implementing the </span><strong class="source-inline"><span class="kobospan" id="kobo.1092.1">CommentsCount</span></strong><span class="kobospan" id="kobo.1093.1"> composable, we will create the </span><span><strong class="source-inline"><span class="kobospan" id="kobo.1094.1">TimeStamp</span></strong></span><span><span class="kobospan" id="kobo.1095.1"> composable:</span></span></p>
<pre class="source-code"><span class="kobospan1" id="kobo.1096.1">
fun TimeStamp(
    modifier: Modifier = Modifier,
    post: Post
) {
    Row(
        modifier = modifier
            .fillMaxWidth()
            .wrapContentHeight()
            .padding(horizontal = 10.dp),
        verticalAlignment = Alignment.CenterVertically
    ) {
        Text(
            text = "${post.timeStamp} hours ago ",
            fontSize = 10.sp,
            fontWeight = FontWeight.Light
        )
    }
}</span></pre> <p class="calibre3"><span class="kobospan" id="kobo.1097.1">The </span><strong class="source-inline"><span class="kobospan" id="kobo.1098.1">TimeStamp</span></strong><span class="kobospan" id="kobo.1099.1"> function is a composable that creates a layout to display the timestamp of a post. </span><span class="kobospan" id="kobo.1099.2">Here’s what each part of the </span><span><span class="kobospan" id="kobo.1100.1">function does:</span></span></p>
<ul class="calibre15">
<li class="calibre14"><strong class="source-inline1"><span class="kobospan" id="kobo.1101.1">Row</span></strong><span class="kobospan" id="kobo.1102.1">: This creates a row in which other UI elements can be placed horizontally. </span><span class="kobospan" id="kobo.1102.2">It uses the provided </span><strong class="source-inline1"><span class="kobospan" id="kobo.1103.1">Modifier</span></strong><span class="kobospan" id="kobo.1104.1"> value to fill the maximum width of the parent container, wrap</span><a id="_idIndexMarker472" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.1105.1"> its height to</span><a id="_idIndexMarker473" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.1106.1"> its content, and add a padding of </span><strong class="source-inline1"><span class="kobospan" id="kobo.1107.1">10.dp</span></strong><span class="kobospan" id="kobo.1108.1"> horizontally. </span><span class="kobospan" id="kobo.1108.2">The </span><strong class="source-inline1"><span class="kobospan" id="kobo.1109.1">verticalAlignment</span></strong><span class="kobospan" id="kobo.1110.1"> parameter is set to </span><strong class="source-inline1"><span class="kobospan" id="kobo.1111.1">Alignment.CenterVertically</span></strong><span class="kobospan" id="kobo.1112.1">, centering the elements vertically in </span><span><span class="kobospan" id="kobo.1113.1">the row.</span></span></li>
<li class="calibre14"><strong class="source-inline1"><span class="kobospan" id="kobo.1114.1">Text</span></strong><span class="kobospan" id="kobo.1115.1">: This creates a text element that displays the timestamp. </span><span class="kobospan" id="kobo.1115.2">The </span><strong class="source-inline1"><span class="kobospan" id="kobo.1116.1">text</span></strong><span class="kobospan" id="kobo.1117.1"> parameter of this function is set to a string that includes the </span><strong class="source-inline1"><span class="kobospan" id="kobo.1118.1">timeStamp</span></strong><span class="kobospan" id="kobo.1119.1"> attribute from the </span><strong class="source-inline1"><span class="kobospan" id="kobo.1120.1">Post</span></strong><span class="kobospan" id="kobo.1121.1"> object. </span><span class="kobospan" id="kobo.1121.2">The </span><strong class="source-inline1"><span class="kobospan" id="kobo.1122.1">fontSize</span></strong><span class="kobospan" id="kobo.1123.1"> and </span><strong class="source-inline1"><span class="kobospan" id="kobo.1124.1">fontWeight</span></strong><span class="kobospan" id="kobo.1125.1"> parameters set the size and weight of the font to </span><strong class="source-inline1"><span class="kobospan" id="kobo.1126.1">10.sp</span></strong><span class="kobospan" id="kobo.1127.1"> and </span><span><strong class="source-inline1"><span class="kobospan" id="kobo.1128.1">FontWeight.Light</span></strong></span><span><span class="kobospan" id="kobo.1129.1">, respectively.</span></span></li>
</ul>
<p class="calibre3"><span class="kobospan" id="kobo.1130.1">With this composable, we have finished the </span><strong class="source-inline"><span class="kobospan" id="kobo.1131.1">Post</span></strong><span class="kobospan" id="kobo.1132.1"> composable components. </span><span class="kobospan" id="kobo.1132.2">If we do a preview with fake data, we’ll see the </span><span><span class="kobospan" id="kobo.1133.1">following screen:</span></span></p>
<div class="calibre2">
<div class="img---figure" id="_idContainer039">
<span class="kobospan" id="kobo.1134.1"><img alt="Figure 4.6: Newsfeed screen" src="image/B19443_04_006.jpg" class="calibre4"/></span>
</div>
</div>
<p class="img---caption" lang="en-US" xml:lang="en-US"><span class="kobospan" id="kobo.1135.1">Figure 4.6: Newsfeed screen</span></p>
<p class="calibre3"><span class="kobospan" id="kobo.1136.1">Now, it is time </span><a id="_idIndexMarker474" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.1137.1">to implement</span><a id="_idIndexMarker475" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.1138.1"> a way to populate the information needed from </span><span><span class="kobospan" id="kobo.1139.1">the backend.</span></span></p>
<h1 id="_idParaDest-100" class="calibre5"><a id="_idTextAnchor101" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.1140.1">Using Retrofit and Moshi to retrieve newsfeed information</span></h1>
<p class="calibre3"><span class="kobospan" id="kobo.1141.1">In this section, we’re </span><a id="_idIndexMarker476" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.1142.1">going to </span><a id="_idIndexMarker477" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.1143.1">prepare our app so that it can retrieve the newsfeed information from the backend. </span><span class="kobospan" id="kobo.1143.2">To do that, we’ll need to create an HTTP client that handles the calls to the backend services. </span><span class="kobospan" id="kobo.1143.3">Since we used </span><strong class="source-inline"><span class="kobospan" id="kobo.1144.1">ktor</span></strong><span class="kobospan" id="kobo.1145.1"> in our first project, we are going to take a different approach for this one</span><a id="_idIndexMarker478" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.1146.1"> and </span><span><span class="kobospan" id="kobo.1147.1">use </span></span><span><strong class="bold"><span class="kobospan" id="kobo.1148.1">Retrofit</span></strong></span><span><span class="kobospan" id="kobo.1149.1">.</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.1150.1">Retrofit is a type-safe HTTP client for Android and Java (which is completely compatible with Kotlin). </span><span class="kobospan" id="kobo.1150.2">Retrofit makes it easy to connect to a REST web service by translating the API into Kotlin or Java interfaces. </span><span class="kobospan" id="kobo.1150.3">Here are some of its </span><span><span class="kobospan" id="kobo.1151.1">main features:</span></span></p>
<ul class="calibre15">
<li class="calibre14"><strong class="bold"><span class="kobospan" id="kobo.1152.1">Easy to use</span></strong><span class="kobospan" id="kobo.1153.1">: Retrofit </span><a id="_idIndexMarker479" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.1154.1">turns your HTTP API into a Kotlin or Java interface. </span><span class="kobospan" id="kobo.1154.2">All you have to do is define the API’s URL and method (</span><strong class="source-inline1"><span class="kobospan" id="kobo.1155.1">GET</span></strong><span class="kobospan" id="kobo.1156.1">, </span><strong class="source-inline1"><span class="kobospan" id="kobo.1157.1">POST</span></strong><span class="kobospan" id="kobo.1158.1">, and so on) using annotations. </span><span class="kobospan" id="kobo.1158.2">Retrofit will automatically convert the HTTP responses into </span><span><span class="kobospan" id="kobo.1159.1">data objects.</span></span></li>
<li class="calibre14"><strong class="bold"><span class="kobospan" id="kobo.1160.1">Type conversion</span></strong><span class="kobospan" id="kobo.1161.1">: By default, Retrofit can only deserialize HTTP bodies into OkHttp’s </span><strong class="source-inline1"><span class="kobospan" id="kobo.1162.1">ResponseBody</span></strong><span class="kobospan" id="kobo.1163.1"> type and it can only accept its </span><strong class="source-inline1"><span class="kobospan" id="kobo.1164.1">RequestBody</span></strong><span class="kobospan" id="kobo.1165.1"> type for </span><strong class="source-inline1"><span class="kobospan" id="kobo.1166.1">@Body</span></strong><span class="kobospan" id="kobo.1167.1">. </span><span class="kobospan" id="kobo.1167.2">Converters can be added to support other types. </span><span class="kobospan" id="kobo.1167.3">For example, a JSON converter can be used to convert the API’s responses into Kotlin or Java </span><span><span class="kobospan" id="kobo.1168.1">objects automatically.</span></span></li>
<li class="calibre14"><strong class="bold"><span class="kobospan" id="kobo.1169.1">HTTP methods annotations</span></strong><span class="kobospan" id="kobo.1170.1">: You can use annotations to describe HTTP methods such as </span><strong class="source-inline1"><span class="kobospan" id="kobo.1171.1">GET</span></strong><span class="kobospan" id="kobo.1172.1">, </span><strong class="source-inline1"><span class="kobospan" id="kobo.1173.1">POST</span></strong><span class="kobospan" id="kobo.1174.1">, </span><strong class="source-inline1"><span class="kobospan" id="kobo.1175.1">DELETE</span></strong><span class="kobospan" id="kobo.1176.1">, </span><strong class="source-inline1"><span class="kobospan" id="kobo.1177.1">UPDATE</span></strong><span class="kobospan" id="kobo.1178.1">, and others. </span><span class="kobospan" id="kobo.1178.2">You can also use other annotations, such as </span><strong class="source-inline1"><span class="kobospan" id="kobo.1179.1">Headers</span></strong><span class="kobospan" id="kobo.1180.1">, </span><strong class="source-inline1"><span class="kobospan" id="kobo.1181.1">Body</span></strong><span class="kobospan" id="kobo.1182.1">, </span><strong class="source-inline1"><span class="kobospan" id="kobo.1183.1">Field</span></strong><span class="kobospan" id="kobo.1184.1">, </span><strong class="source-inline1"><span class="kobospan" id="kobo.1185.1">Path</span></strong><span class="kobospan" id="kobo.1186.1">, and more, to make your request exactly </span><span><span class="kobospan" id="kobo.1187.1">as needed.</span></span></li>
<li class="calibre14"><strong class="bold"><span class="kobospan" id="kobo.1188.1">URL parameter replacement and query parameter support</span></strong><span class="kobospan" id="kobo.1189.1">: Add parameters to your request with annotations. </span><span class="kobospan" id="kobo.1189.2">For example, you can add a path parameter by setting the specific value in the URL, or you can add a query parameter at the end of </span><span><span class="kobospan" id="kobo.1190.1">the URL.</span></span></li>
<li class="calibre14"><strong class="bold"><span class="kobospan" id="kobo.1191.1">Synchronous and asynchronous calls</span></strong><span class="kobospan" id="kobo.1192.1">: Retrofit supports both synchronous (blocking) calls and asynchronous (non-blocking) calls. </span><span class="kobospan" id="kobo.1192.2">For Android, asynchronous calls are more important as network operations on the main thread </span><span><span class="kobospan" id="kobo.1193.1">are discouraged.</span></span></li>
<li class="calibre14"><strong class="bold"><span class="kobospan" id="kobo.1194.1">Support for coroutines and RxJava</span></strong><span class="kobospan" id="kobo.1195.1">: Retrofit provides out-of-the-box support for coroutines and RxJava. </span><span class="kobospan" id="kobo.1195.2">This makes it easy to use with these popular libraries for handling </span><span><span class="kobospan" id="kobo.1196.1">asynchronous operations.</span></span></li>
<li class="calibre14"><strong class="bold"><span class="kobospan" id="kobo.1197.1">Interceptors</span></strong><span class="kobospan" id="kobo.1198.1">: Retrofit also allows you to use OkHttp’s interceptors. </span><span class="kobospan" id="kobo.1198.2">You can add headers to every </span><a id="_idIndexMarker480" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.1199.1">request or log the request and response data for </span><span><span class="kobospan" id="kobo.1200.1">debugging purposes.</span></span></li>
</ul>
<p class="calibre3"><span class="kobospan" id="kobo.1201.1">We also need to use a converter to parse the backend responses into objects. </span><span class="kobospan" id="kobo.1201.2">We will use </span><strong class="bold"><span class="kobospan" id="kobo.1202.1">Moshi</span></strong><span class="kobospan" id="kobo.1203.1"> (</span><a href="https://github.com/square/moshi" class="calibre6 pcalibre1 pcalibre"><span class="kobospan" id="kobo.1204.1">https://github.com/square/moshi</span></a><span class="kobospan" id="kobo.1205.1">) for </span><a id="_idIndexMarker481" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.1206.1">that. </span><span class="kobospan" id="kobo.1206.2">Moshi is a modern JSON library for Android and Java, also built by Square. </span><span class="kobospan" id="kobo.1206.3">It aims to be easy to use and efficient, and its design is</span><a id="_idIndexMarker482" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.1207.1"> inspired </span><a id="_idIndexMarker483" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.1208.1">by the well-regarded Gson library, but it seeks to improve upon several design aspects. </span><span class="kobospan" id="kobo.1208.2">Here are some of its </span><span><span class="kobospan" id="kobo.1209.1">main features:</span></span></p>
<ul class="calibre15">
<li class="calibre14"><strong class="bold"><span class="kobospan" id="kobo.1210.1">Easy to use</span></strong><span class="kobospan" id="kobo.1211.1">: Moshi </span><a id="_idIndexMarker484" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.1212.1">provides simple </span><strong class="source-inline1"><span class="kobospan" id="kobo.1213.1">toJson()</span></strong><span class="kobospan" id="kobo.1214.1"> and </span><strong class="source-inline1"><span class="kobospan" id="kobo.1215.1">fromJson()</span></strong><span class="kobospan" id="kobo.1216.1"> methods to convert Java and Kotlin objects into JSON and </span><span><span class="kobospan" id="kobo.1217.1">vice versa.</span></span></li>
<li class="calibre14"><strong class="bold"><span class="kobospan" id="kobo.1218.1">Built-in and custom converters</span></strong><span class="kobospan" id="kobo.1219.1">: Moshi has built-in support for converting many common types and can encode any object graph of these. </span><span class="kobospan" id="kobo.1219.2">For other classes, you can write custom </span><a id="_idIndexMarker485" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.1220.1">converters, called </span><strong class="bold"><span class="kobospan" id="kobo.1221.1">adapters</span></strong><span class="kobospan" id="kobo.1222.1">, that define how these types are converted to and </span><span><span class="kobospan" id="kobo.1223.1">from JSON.</span></span></li>
<li class="calibre14"><strong class="bold"><span class="kobospan" id="kobo.1224.1">Kotlin support</span></strong><span class="kobospan" id="kobo.1225.1">: Moshi supports Kotlin and provides the </span><strong class="source-inline1"><span class="kobospan" id="kobo.1226.1">moshi-kotlin-codegen</span></strong><span class="kobospan" id="kobo.1227.1"> module, which leverages annotation processing to generate adapters for your Kotlin </span><span><span class="kobospan" id="kobo.1228.1">classes automatically.</span></span></li>
<li class="calibre14"><strong class="bold"><span class="kobospan" id="kobo.1229.1">Null safety</span></strong><span class="kobospan" id="kobo.1230.1">: Moshi handles </span><strong class="source-inline1"><span class="kobospan" id="kobo.1231.1">null</span></strong><span class="kobospan" id="kobo.1232.1"> values in the JSON input and can be configured to allow or disallow </span><strong class="source-inline1"><span class="kobospan" id="kobo.1233.1">null</span></strong><span class="kobospan" id="kobo.1234.1"> values in your Java or </span><span><span class="kobospan" id="kobo.1235.1">Kotlin objects.</span></span></li>
<li class="calibre14"><strong class="bold"><span class="kobospan" id="kobo.1236.1">Annotation-based</span></strong><span class="kobospan" id="kobo.1237.1">: Much like Retrofit, Moshi uses annotations to denote special behavior for certain fields (for example, custom names and </span><span><span class="kobospan" id="kobo.1238.1">transient values).</span></span></li>
<li class="calibre14"><strong class="bold"><span class="kobospan" id="kobo.1239.1">Fault-tolerant</span></strong><span class="kobospan" id="kobo.1240.1">: Moshi is fault-tolerant and will not fail the entire operation if it encounters unknown properties or incompatible types in the JSON data. </span><span class="kobospan" id="kobo.1240.2">This can be beneficial when dealing with APIs that may </span><span><span class="kobospan" id="kobo.1241.1">occasionally change.</span></span></li>
<li class="calibre14"><strong class="bold"><span class="kobospan" id="kobo.1242.1">Efficient</span></strong><span class="kobospan" id="kobo.1243.1">: Moshi is designed to be efficient in its operation, minimizing object allocation and garbage </span><a id="_idIndexMarker486" class="calibre6 pcalibre1 pcalibre"/><span><span class="kobospan" id="kobo.1244.1">collection overhead.</span></span></li>
</ul>
<p class="calibre3"><span class="kobospan" id="kobo.1245.1">Now that we know </span><a id="_idIndexMarker487" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.1246.1">the advantages</span><a id="_idIndexMarker488" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.1247.1"> of using Retrofit with Moshi, let’s start integrating them into </span><span><span class="kobospan" id="kobo.1248.1">our project.</span></span></p>
<h2 id="_idParaDest-101" class="calibre7"><a id="_idTextAnchor102" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.1249.1">Adding the Retrofit and Moshi dependencies</span></h2>
<p class="calibre3"><span class="kobospan" id="kobo.1250.1">To use both the </span><a id="_idIndexMarker489" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.1251.1">Retrofit and Moshi libraries, we need to configure their dependencies. </span><span class="kobospan" id="kobo.1251.2">First, we will add them to the versions </span><span><span class="kobospan" id="kobo.1252.1">catalog file:</span></span></p>
<pre class="source-code"><span class="kobospan1" id="kobo.1253.1">
[versions]
...
</span><span class="kobospan1" id="kobo.1253.2">retrofit = "2.9.0"
moshi = "1.12.0"
coroutines = "1.5.1"
moshi-converter = "0.8.0"
...
</span><span class="kobospan1" id="kobo.1253.3">[libraries]
...
</span><span class="kobospan1" id="kobo.1253.4">retrofit = { group = "com.squareup.retrofit2", name = "retrofit", version.ref="retrofit"}
retrofitMoshiConverter = { group = "com.squareup.retrofit2", name = "converter-moshi", version.ref="retrofit"}
moshi = { group = "com.squareup.moshi", name = "moshi", version.ref = "moshi" }
moshiKotlin = { group = "com.squareup.moshi", name = "moshi-kotlin", version.ref = "moshi" }
moshiKotlinCodegen = { group = "com.squareup.moshi", name = "moshi-kotlin-codegen", version.ref = "moshi" }
moshiKotlinCodegen = { group = "com.squareup.retrofit2", name = "retrofit-kotlinx-serialization-converter", version.ref = "moshi-converter" }
coroutinesCore = {  group = "org.jetbrains.kotlinx", name = "kotlinx-coroutines-core", version.ref = "coroutines" }
coroutinesAndroid = {  group = "org.jetbrains.kotlinx", name = "kotlinx-coroutines-android", version.ref = "coroutines" }
[plugins]
...
</span><span class="kobospan1" id="kobo.1253.5">kotlin-kapt = { id = "org.jetbrains.kotlin.kapt", version.ref = "org-jetbrains-kotlin-android" }</span></pre> <p class="calibre3"><span class="kobospan" id="kobo.1254.1">Then, we will include</span><a id="_idIndexMarker490" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.1255.1"> the dependencies in our module’s </span><strong class="source-inline"><span class="kobospan" id="kobo.1256.1">build.gradle.kts</span></strong><span class="kobospan" id="kobo.1257.1"> file, making them available to use in </span><span><span class="kobospan" id="kobo.1258.1">our module:</span></span></p>
<pre class="source-code"><span class="kobospan1" id="kobo.1259.1">
dependencies {
    implementation(libs.retrofit)
    implementation(libs.retrofitMoshiConverter)
    implementation(libs.moshiConverter)
    implementation(libs.moshi)
    implementation(libs.moshiKotlin)
    kapt(libs.moshiKotlinCodegen)
    implementation(libs.coroutinesCore)
    implementation(libs.coroutinesAndroid)
...
</span><span class="kobospan1" id="kobo.1259.2">}</span></pre> <p class="calibre3"><span class="kobospan" id="kobo.1260.1">After adding these dependencies, we should be ready to work with both libraries. </span><span class="kobospan" id="kobo.1260.2">Let’s start creating our</span><a id="_idIndexMarker491" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.1261.1"> data source so that we can obtain the data for </span><span><span class="kobospan" id="kobo.1262.1">the newsfeed.</span></span></p>
<h2 id="_idParaDest-102" class="calibre7"><a id="_idTextAnchor103" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.1263.1">Creating the data source for the newsfeed</span></h2>
<p class="calibre3"><span class="kobospan" id="kobo.1264.1">At this point, we’re ready</span><a id="_idIndexMarker492" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.1265.1"> to create</span><a id="_idIndexMarker493" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.1266.1"> our data source. </span><span class="kobospan" id="kobo.1266.2">We will do this in the </span><strong class="source-inline"><span class="kobospan" id="kobo.1267.1">:feature:newsfeed</span></strong><span class="kobospan" id="kobo.1268.1"> module. </span><span class="kobospan" id="kobo.1268.2">First, we need to create an interface to define our API endpoints using Retrofit. </span><span class="kobospan" id="kobo.1268.3">We can use </span><strong class="source-inline"><span class="kobospan" id="kobo.1269.1">@GET</span></strong><span class="kobospan" id="kobo.1270.1">, </span><strong class="source-inline"><span class="kobospan" id="kobo.1271.1">@POST</span></strong><span class="kobospan" id="kobo.1272.1">, and others to define what kind of HTTP request we want </span><span><span class="kobospan" id="kobo.1273.1">to make:</span></span></p>
<pre class="source-code"><span class="kobospan1" id="kobo.1274.1">
interface NewsFeedService {
    @GET("feed")
    suspend fun getNewsFeed(): List&lt;PostApiData&gt;
}</span></pre> <p class="calibre3"><span class="kobospan" id="kobo.1275.1">This is an interface for the Retrofit library that’s used to turn the HTTP API into a Kotlin interface. </span><span class="kobospan" id="kobo.1275.2">It also defines an endpoint for </span><span><span class="kobospan" id="kobo.1276.1">your API:</span></span></p>
<ul class="calibre15">
<li class="calibre14"><strong class="source-inline1"><span class="kobospan" id="kobo.1277.1">interface NewsFeedService</span></strong><span class="kobospan" id="kobo.1278.1">: This is declaring a new interface </span><span><span class="kobospan" id="kobo.1279.1">named </span></span><span><strong class="source-inline1"><span class="kobospan" id="kobo.1280.1">NewsFeedService</span></strong></span><span><span class="kobospan" id="kobo.1281.1">.</span></span></li>
<li class="calibre14"><strong class="source-inline1"><span class="kobospan" id="kobo.1282.1">@GET("feed")</span></strong><span class="kobospan" id="kobo.1283.1">: This is an annotation that describes an HTTP GET request. </span><span class="kobospan" id="kobo.1283.2">The </span><strong class="source-inline1"><span class="kobospan" id="kobo.1284.1">"feed"</span></strong><span class="kobospan" id="kobo.1285.1"> parameter is the endpoint where the request will be sent. </span><span class="kobospan" id="kobo.1285.2">So, the full URL for this request would be something like </span><a href="https://packtagram.com/feed" class="calibre6 pcalibre1 pcalibre"><span class="kobospan" id="kobo.1286.1">https://packtagram.com/feed</span></a><span class="kobospan" id="kobo.1287.1"> if the base URL of your Retrofit client </span><span><span class="kobospan" id="kobo.1288.1">is </span></span><a href="https://packtagram.com/" class="calibre6 pcalibre1 pcalibre"><span><span class="kobospan" id="kobo.1289.1">https://packtagram.com/</span></span></a><span><span class="kobospan" id="kobo.1290.1">.</span></span></li>
<li class="calibre14"><strong class="source-inline1"><span class="kobospan" id="kobo.1291.1">suspend fun getNewsFeed(): List&lt;PostApiData&gt;</span></strong><span class="kobospan" id="kobo.1292.1">: This is declaring a function named </span><strong class="source-inline1"><span class="kobospan" id="kobo.1293.1">getNewsFeed</span></strong><span class="kobospan" id="kobo.1294.1"> that is expected to return a list of </span><strong class="source-inline1"><span class="kobospan" id="kobo.1295.1">Post</span></strong><span class="kobospan" id="kobo.1296.1"> objects. </span><span class="kobospan" id="kobo.1296.2">The </span><strong class="source-inline1"><span class="kobospan" id="kobo.1297.1">suspend</span></strong><span class="kobospan" id="kobo.1298.1"> keyword means that this function is a suspending function, which is a type of function that can be paused and resumed at a later time. </span><span class="kobospan" id="kobo.1298.2">This will be called later from </span><span><span class="kobospan" id="kobo.1299.1">a coroutine.</span></span></li>
</ul>
<p class="calibre3"><span class="kobospan" id="kobo.1300.1">So, to put it all together, when </span><strong class="source-inline"><span class="kobospan" id="kobo.1301.1">getFeed</span></strong><span class="kobospan" id="kobo.1302.1"> is called, it will make a </span><strong class="source-inline"><span class="kobospan" id="kobo.1303.1">GET</span></strong><span class="kobospan" id="kobo.1304.1"> request to the </span><a href="https://packtagram.com/feed" class="calibre6 pcalibre1 pcalibre"><span class="kobospan" id="kobo.1305.1">https://packtagram.com/feed</span></a><span class="kobospan" id="kobo.1306.1"> URL and expect to receive a JSON array of </span><strong class="source-inline"><span class="kobospan" id="kobo.1307.1">PostApiData</span></strong><span class="kobospan" id="kobo.1308.1"> objects, which are then parsed into a list of </span><strong class="source-inline"><span class="kobospan" id="kobo.1309.1">Post</span></strong><span class="kobospan" id="kobo.1310.1"> objects in your </span><span><span class="kobospan" id="kobo.1311.1">Kotlin code.</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.1312.1">To see an example of a JSON file that contains the expected fields, check </span><span><span class="kobospan" id="kobo.1313.1">out </span></span><a href="https://api.mockfly.dev/mocks/09e4e43e-7992-4dd7-b99f-e168667a240e/feed" class="calibre6 pcalibre1 pcalibre"><span><span class="kobospan" id="kobo.1314.1">https://api.mockfly.dev/mocks/09e4e43e-7992-4dd7-b99f-e168667a240e/feed</span></span></a><span><span class="kobospan" id="kobo.1315.1">.</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.1316.1">Now, we need to </span><a id="_idIndexMarker494" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.1317.1">generate a </span><a id="_idIndexMarker495" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.1318.1">client from this interface. </span><span class="kobospan" id="kobo.1318.2">For that, we will use the </span><span><span class="kobospan" id="kobo.1319.1">Retrofit builder:</span></span></p>
<pre class="source-code"><span class="kobospan1" id="kobo.1320.1">
object RetrofitInstance {
    private const val BASE_URL = "https://packtagram.com/"
    fun getNewsFeedApi(): NewsFeedService = run {
        Retrofit.Builder()
            .baseUrl(BASE_URL)
            .addConverterFactory(
                MoshiConverterFactory.create())
            .build()
            .create(NewsFeedService::class.java)
    }
}</span></pre> <p class="calibre3"><span class="kobospan" id="kobo.1321.1">Here, we are creating a function called </span><strong class="source-inline"><span class="kobospan" id="kobo.1322.1">getNewsFeedApi()</span></strong><span class="kobospan" id="kobo.1323.1"> that will build the </span><strong class="source-inline"><span class="kobospan" id="kobo.1324.1">NewsFeedService</span></strong><span class="kobospan" id="kobo.1325.1"> client. </span><span class="kobospan" id="kobo.1325.2">For that, we need a </span><strong class="source-inline"><span class="kobospan" id="kobo.1326.1">BASE_URL</span></strong><span class="kobospan" id="kobo.1327.1"> function that we can hardcode in this same file. </span><span class="kobospan" id="kobo.1327.2">The recommendation is to store this information in a configuration file so that we can easily change it if we need to have different </span><strong class="source-inline"><span class="kobospan" id="kobo.1328.1">buildTypes</span></strong><span class="kobospan" id="kobo.1329.1"> of the app, </span><span><span class="kobospan" id="kobo.1330.1">for example.</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.1331.1">We are also adding the Moshi converter using </span><span><span class="kobospan" id="kobo.1332.1">the </span></span><span><strong class="source-inline"><span class="kobospan" id="kobo.1333.1">.addConverterFactory</span></strong></span><strong class="source-inline"><span class="kobospan" id="kobo.1334.1">
(MoshiConverterFactory.create())</span></strong><span class="kobospan" id="kobo.1335.1"> function. </span><span class="kobospan" id="kobo.1335.2">This will allow Retrofit to deserialize the backend responses </span><span><span class="kobospan" id="kobo.1336.1">using Moshi.</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.1337.1">Now, we need to </span><span><span class="kobospan" id="kobo.1338.1">create </span></span><span><strong class="source-inline"><span class="kobospan" id="kobo.1339.1">NewsFeedRemoteDataSource</span></strong></span><span><span class="kobospan" id="kobo.1340.1">:</span></span></p>
<pre class="source-code"><span class="kobospan1" id="kobo.1341.1">
class NewsFeedRemoteDataSource(private val api:
NewsFeedService) {
    suspend fun getNewsFeed(): List&lt;PostApiData&gt; {
        return api.getNewsFeed()
    }
}</span></pre> <p class="calibre3"><span class="kobospan" id="kobo.1342.1">As we can see, we have created a </span><strong class="source-inline"><span class="kobospan" id="kobo.1343.1">NewsFeedRemoteDataSource</span></strong><span class="kobospan" id="kobo.1344.1"> composable. </span><span class="kobospan" id="kobo.1344.2">Here, we will have one function, </span><strong class="source-inline"><span class="kobospan" id="kobo.1345.1">getNewsFeed(</span></strong><span class="kobospan" id="kobo.1346.1">). </span><span class="kobospan" id="kobo.1346.2">This function will call </span><strong class="source-inline"><span class="kobospan" id="kobo.1347.1">NewsFeedService</span></strong><span class="kobospan" id="kobo.1348.1"> to obtain </span><span><span class="kobospan" id="kobo.1349.1">the newsfeed.</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.1350.1">Now, let’s</span><a id="_idIndexMarker496" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.1351.1"> create</span><a id="_idIndexMarker497" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.1352.1"> the repository for </span><span><span class="kobospan" id="kobo.1353.1">this newsfeed.</span></span></p>
<h2 id="_idParaDest-103" class="calibre7"><a id="_idTextAnchor104" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.1354.1">Creating the repository</span></h2>
<p class="calibre3"><span class="kobospan" id="kobo.1355.1">The next step is to </span><a id="_idIndexMarker498" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.1356.1">define</span><a id="_idIndexMarker499" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.1357.1"> the repository that will orchestrate the information gathering and storage using the different data sources (for now, we only have one, </span><strong class="source-inline"><span class="kobospan" id="kobo.1358.1">NewsFeedRemoteDataSource</span></strong><span class="kobospan" id="kobo.1359.1">). </span><span class="kobospan" id="kobo.1359.2">It will also map the information into the new layer: the </span><span><span class="kobospan" id="kobo.1360.1">domain layer.</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.1361.1">First, we’ll define its interface as part of the </span><span><span class="kobospan" id="kobo.1362.1">domain layer:</span></span></p>
<pre class="source-code"><span class="kobospan1" id="kobo.1363.1">
interface NewsFeedRepository {
    suspend fun getNewsFeed():List&lt;Post&gt;
}</span></pre> <p class="calibre3"><span class="kobospan" id="kobo.1364.1">Second, we’ll implement its functionality as part of the </span><span><span class="kobospan" id="kobo.1365.1">data layer:</span></span></p>
<pre class="source-code"><span class="kobospan1" id="kobo.1366.1">
class NewsFeedRepositoryImpl(
    private val remoteDataSource: NewsFeedRemoteDataSource
): NewsFeedRepository {
    override suspend fun getNewsFeed(): List&lt;Post&gt; {
        return remoteDataSource
            .getNewsFeed()
            .map { it.toDomain() }
    }
}</span></pre> <p class="calibre3"><span class="kobospan" id="kobo.1367.1">As we can see, for now, it will only have a </span><strong class="source-inline"><span class="kobospan" id="kobo.1368.1">getNewsFeed()</span></strong><span class="kobospan" id="kobo.1369.1"> function that will obtain a list of </span><strong class="source-inline"><span class="kobospan" id="kobo.1370.1">Post</span></strong><span class="kobospan" id="kobo.1371.1">. </span><span class="kobospan" id="kobo.1371.2">objects It will obtain the newsfeed from the remote</span><a id="_idIndexMarker500" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.1372.1"> data source and map the </span><strong class="source-inline"><span class="kobospan" id="kobo.1373.1">PostApiData</span></strong><span class="kobospan" id="kobo.1374.1"> objects </span><a id="_idIndexMarker501" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.1375.1">into </span><span><strong class="source-inline"><span class="kobospan" id="kobo.1376.1">Post</span></strong></span><span><span class="kobospan" id="kobo.1377.1"> objects.</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.1378.1">Now, let’s create the use case to obtain </span><span><span class="kobospan" id="kobo.1379.1">this data.</span></span></p>
<h2 id="_idParaDest-104" class="calibre7"><a id="_idTextAnchor105" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.1380.1">Creating the GetTheNewsFeedUseCase</span></h2>
<p class="calibre3"><span class="kobospan" id="kobo.1381.1">As we</span><a id="_idIndexMarker502" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.1382.1"> progress </span><a id="_idIndexMarker503" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.1383.1">through the layers, the next step will be to create the use cases needed. </span><span class="kobospan" id="kobo.1383.2">In this case, we will create a use case to obtain the newsfeed – that </span><span><span class="kobospan" id="kobo.1384.1">is, </span></span><span><strong class="source-inline"><span class="kobospan" id="kobo.1385.1">GetTheNewsFeedUseCase</span></strong></span><span><span class="kobospan" id="kobo.1386.1">:</span></span></p>
<pre class="source-code"><span class="kobospan1" id="kobo.1387.1">
class GetTheNewsFeedUseCase(
    private val repository: NewsFeedRepository
) {
    suspend operator fun invoke(): List&lt;Post&gt; {
        return repository.getNewsFeed()
    }
}</span></pre> <p class="calibre3"><span class="kobospan" id="kobo.1388.1">Here, we are using </span><strong class="source-inline"><span class="kobospan" id="kobo.1389.1">repository</span></strong><span class="kobospan" id="kobo.1390.1"> to get the newsfeed in the </span><span><strong class="source-inline"><span class="kobospan" id="kobo.1391.1">invoke</span></strong></span><span><span class="kobospan" id="kobo.1392.1"> function.</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.1393.1">Before continuing, we need to create the data classes that we will be using in the data and domain layers. </span><span class="kobospan" id="kobo.1393.2">In the case of the domain layer, we will create the </span><strong class="source-inline"><span class="kobospan" id="kobo.1394.1">Post</span></strong> <span><span class="kobospan" id="kobo.1395.1">data class:</span></span></p>
<pre class="source-code"><span class="kobospan1" id="kobo.1396.1">
data class Post(
    val id: String,
    val user: UserData,
    val imageUrl: String,
    val caption: String,
    val likesCount: Int,
    val commentsCount: Int,
    val timeStamp: Long
) {
    data class UserData(
        val id: String,
        val name: String,
        val imageUrl: String
    )
}</span></pre> <p class="calibre3"><span class="kobospan" id="kobo.1397.1">Here, we are declaring all the fields that we need for the </span><strong class="source-inline"><span class="kobospan" id="kobo.1398.1">Post</span></strong><span class="kobospan" id="kobo.1399.1"> object in the </span><span><span class="kobospan" id="kobo.1400.1">domain layer.</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.1401.1">In the case of the</span><a id="_idIndexMarker504" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.1402.1"> data</span><a id="_idIndexMarker505" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.1403.1"> layer, we will create the </span><strong class="source-inline"><span class="kobospan" id="kobo.1404.1">PostApiData</span></strong><span class="kobospan" id="kobo.1405.1"> data class and mapping functions that we’ll need to map to the </span><span><span class="kobospan" id="kobo.1406.1">domain object:</span></span></p>
<pre class="source-code"><span class="kobospan1" id="kobo.1407.1">
data class PostApiData(
    @Json(name = "id")
    val id: String,
    @Json(name = "author")
    val user: UserApiData,
    @Json(name = "image_url")
    val imageUrl: String,
    @Json(name = "caption")
    val caption: String,
    @Json(name = "likes_count")
    val likesCount: Int,
    @Json(name = "comments_count")
    val commentsCount: Int,
    @Json(name = "timestamp")
    val timeStamp: Long
) {
    data class UserApiData(
        @Json(name = "id")
        val id: String,
        @Json(name = "name")
        val name: String,
        @Json(name = "image_url")
        val imageUrl: String
    ) {
        fun toDomain(): Post.UserData {
            return Post.UserData(
                id = id,
                name = name,
                imageUrl = imageUrl
            )
        }
    }
    fun toDomain(): Post {
        return Post(
            id = id,
            user = user.toDomain(),
            imageUrl = imageUrl,
            caption = caption,
            likesCount = likesCount,
            commentsCount = commentsCount,
            timeStamp = timeStamp
        )
    }
}</span></pre> <p class="calibre3"><span class="kobospan" id="kobo.1408.1">Here, we should include the fields that the response from the backend will return to our app. </span><span class="kobospan" id="kobo.1408.2">Note</span><a id="_idIndexMarker506" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.1409.1"> that </span><a id="_idIndexMarker507" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.1410.1">we are using the </span><strong class="source-inline"><span class="kobospan" id="kobo.1411.1">@Json(name = "")</span></strong><span class="kobospan" id="kobo.1412.1"> annotation in the properties to specify the name of the field in the JSON that the backend </span><span><span class="kobospan" id="kobo.1413.1">will return.</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.1414.1">Before jumping to consume the use case in </span><strong class="source-inline"><span class="kobospan" id="kobo.1415.1">ViewModel</span></strong><span class="kobospan" id="kobo.1416.1">, we have to sort out the dependency injection for all the components we have just created. </span><span class="kobospan" id="kobo.1416.2">We will do so </span><span><span class="kobospan" id="kobo.1417.1">in </span></span><span><strong class="source-inline"><span class="kobospan" id="kobo.1418.1">newsFeedModule</span></strong></span><span><span class="kobospan" id="kobo.1419.1">:</span></span></p>
<pre class="source-code"><span class="kobospan1" id="kobo.1420.1">
val newsFeedModule = module {
    single { RetrofitInstance.getNewsFeedApi() }
    single { NewsFeedRemoteDataSource(get()) }
    single&lt;NewsFeedRepository&gt; {
        NewsFeedRepositoryImpl(get()) }
    factory { GetTheNewsFeedUseCase(get()) }
    viewModel&lt;NewsFeedViewModel&gt;()
}</span></pre> <p class="calibre3"><span class="kobospan" id="kobo.1421.1">Now, it is </span><a id="_idIndexMarker508" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.1422.1">time </span><a id="_idIndexMarker509" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.1423.1">to integrate this use case </span><span><span class="kobospan" id="kobo.1424.1">into </span></span><span><strong class="source-inline"><span class="kobospan" id="kobo.1425.1">NewsFeedViewModel</span></strong></span><span><span class="kobospan" id="kobo.1426.1">.</span></span></p>
<h2 id="_idParaDest-105" class="calibre7"><a id="_idTextAnchor106" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.1427.1">Integrating the use case into our ViewModel</span></h2>
<p class="calibre3"><span class="kobospan" id="kobo.1428.1">For the </span><a id="_idIndexMarker510" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.1429.1">ViewModel, we </span><a id="_idIndexMarker511" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.1430.1">will need to create a new function to obtain the posts. </span><span class="kobospan" id="kobo.1430.2">We will call it </span><span><strong class="source-inline"><span class="kobospan" id="kobo.1431.1">loadPosts()</span></strong></span><span><span class="kobospan" id="kobo.1432.1">:</span></span></p>
<pre class="source-code"><span class="kobospan1" id="kobo.1433.1">
    init {
        loadPosts()
    }
    private fun loadPosts() {
        viewModelScope.launch {
            val newPosts = getTheNewsFeedUseCase()
            _posts.value = newPosts
        }
    }</span></pre> <p class="calibre3"><span class="kobospan" id="kobo.1434.1">Here, we are loading the posts as soon as the app shows the view and the ViewModel </span><span><span class="kobospan" id="kobo.1435.1">is created.</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.1436.1">The changes to the </span><strong class="source-inline"><span class="kobospan" id="kobo.1437.1">posts</span></strong><span class="kobospan" id="kobo.1438.1"> property are already being consumed by our </span><strong class="source-inline"><span class="kobospan" id="kobo.1439.1">NewsFeed</span></strong><span class="kobospan" id="kobo.1440.1"> composable, so it will update the UI when it receives </span><span><span class="kobospan" id="kobo.1441.1">any posts.</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.1442.1">We could also add some error handling here, but as we already worked on that topic in the first project, we will leave </span><span><span class="kobospan" id="kobo.1443.1">it here.</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.1444.1">Now, it wouldn’t be realistic (and performant) to load all the existing posts initially. </span><span class="kobospan" id="kobo.1444.2">As we did with the messaging project, we’ll need to paginate so that we can obtain the posts gradually, following</span><a id="_idIndexMarker512" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.1445.1"> the </span><a id="_idIndexMarker513" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.1446.1">user scroll. </span><span class="kobospan" id="kobo.1446.2">We will see how in the </span><span><span class="kobospan" id="kobo.1447.1">next section.</span></span></p>
<h1 id="_idParaDest-106" class="calibre5"><a id="_idTextAnchor107" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.1448.1">Implementing pagination in the newsfeed</span></h1>
<p class="calibre3"><span class="kobospan" id="kobo.1449.1">To implement </span><a id="_idIndexMarker514" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.1450.1">pagination in our app, we</span><a id="_idIndexMarker515" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.1451.1"> will start by modifying the Retrofit service. </span><span class="kobospan" id="kobo.1451.2">Typically you’re required to add parameters to your API endpoint that control the “page” of data you’re requesting. </span><span class="kobospan" id="kobo.1451.3">For instance, we might have a </span><strong class="source-inline"><span class="kobospan" id="kobo.1452.1">pageNumber</span></strong><span class="kobospan" id="kobo.1453.1"> parameter and a </span><strong class="source-inline"><span class="kobospan" id="kobo.1454.1">pageSize</span></strong><span class="kobospan" id="kobo.1455.1"> parameter (though this will depend on the design of your </span><span><span class="kobospan" id="kobo.1456.1">backend endpoints).</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.1457.1">First, let’s adjust </span><strong class="source-inline"><span class="kobospan" id="kobo.1458.1">NewsFeedService</span></strong><span class="kobospan" id="kobo.1459.1"> so that it includes the two parameters we </span><span><span class="kobospan" id="kobo.1460.1">just mentioned:</span></span></p>
<pre class="source-code"><span class="kobospan1" id="kobo.1461.1">
interface NewsFeedService {
    @GET("/feed")
    suspend fun getNewsFeed(
        @Query("pageNumber") pageNumber: Int,
        @Query("pageSize") pageSize: Int
    ): List&lt;PostApiData&gt;
}</span></pre> <p class="calibre3"><span class="kobospan" id="kobo.1462.1">Now, we will need to change the signature of the data source function so that it includes those fields. </span><span class="kobospan" id="kobo.1462.2">In the data source, we will change the </span><span><span class="kobospan" id="kobo.1463.1">following function:</span></span></p>
<pre class="source-code"><span class="kobospan1" id="kobo.1464.1">
    suspend fun getNewsFeed(pageNumber: Int, pageSize:
    Int): List&lt;PostApiData&gt; {
        return api.getNewsFeed(pageNumber, pageSize)
    }</span></pre> <p class="calibre3"><span class="kobospan" id="kobo.1465.1">In the repository, we will handle storing the current page and keeping the desired size of pages (this could also </span><a id="_idIndexMarker516" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.1466.1">be </span><a id="_idIndexMarker517" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.1467.1">a </span><span><span class="kobospan" id="kobo.1468.1">constant somewhere):</span></span></p>
<pre class="source-code"><span class="kobospan1" id="kobo.1469.1">
class NewsFeedRepositoryImpl(
    private val remoteDataSource:
    NewsFeedRemoteDataSource): NewsFeedRepository
{
    private var currentPage = 0
    private val pageSize = 20 // Or whatever page size we
                                 prefer
    override suspend fun getNewsFeed(): List&lt;Post&gt; {
        return remoteDataSource
            .getNewsFeed(currentPage, pageSize)
            .map { it.toDomain() }
            .also { currentPage++ }
    }
    fun resetPagination() {
        currentPage = 0
    }
}</span></pre> <p class="calibre3"><span class="kobospan" id="kobo.1470.1">Here, we are storing the current page so that when we call the data source, we can specify if we want the next one. </span><span class="kobospan" id="kobo.1470.2">We have also added a function called </span><strong class="source-inline"><span class="kobospan" id="kobo.1471.1">resetPagination()</span></strong><span class="kobospan" id="kobo.1472.1"> that will reset the current page so that we can </span><span><span class="kobospan" id="kobo.1473.1">start again.</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.1474.1">Next, we are going to use </span><strong class="source-inline"><span class="kobospan" id="kobo.1475.1">resetPagination()</span></strong><span class="kobospan" id="kobo.1476.1"> in </span><strong class="source-inline"><span class="kobospan" id="kobo.1477.1">UseCase</span></strong><span class="kobospan" id="kobo.1478.1"> when the user navigates to the top and wants to get the first of </span><span><span class="kobospan" id="kobo.1479.1">the publications:</span></span></p>
<pre class="source-code"><span class="kobospan1" id="kobo.1480.1">
    suspend operator fun invoke(fromTheBeginning: Boolean):
    List&lt;Post&gt; {
        if (fromTheBeginning) {
            repository.resetPagination()
        }
        return repository.getNewsFeed()
    }</span></pre> <p class="calibre3"><span class="kobospan" id="kobo.1481.1">The next step is </span><a id="_idIndexMarker518" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.1482.1">to </span><a id="_idIndexMarker519" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.1483.1">handle when we should load the next page and load the next posts. </span><span class="kobospan" id="kobo.1483.2">To do so, we’ll need to modify our </span><strong class="source-inline"><span class="kobospan" id="kobo.1484.1">NewsFeed</span></strong><span class="kobospan" id="kobo.1485.1"> composable </span><span><span class="kobospan" id="kobo.1486.1">and </span></span><span><strong class="source-inline"><span class="kobospan" id="kobo.1487.1">NewsFeedViewModel</span></strong></span><span><span class="kobospan" id="kobo.1488.1">.</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.1489.1">First, we are going to implement the </span><span><strong class="source-inline"><span class="kobospan" id="kobo.1490.1">NewsFeedViewModel</span></strong></span><span><span class="kobospan" id="kobo.1491.1"> part:</span></span></p>
<pre class="source-code"><span class="kobospan1" id="kobo.1492.1">
init {
        loadInitialPosts()
    }
    private fun loadInitialPosts() {
        viewModelScope.launch {
            val newPosts = withContext(dispatcher) {
                getTheNewsFeedUseCase(fromTheBeginning =
                    true)
            }
            _posts.value = newPosts
        }
    }
    fun loadMorePosts() {
        viewModelScope.launch {
            val newPosts = withContext(dispatcher) {
                getTheNewsFeedUseCase(fromTheBeginning =
                    false)
            }
            val updatedPosts = (_posts.value +
                newPosts).takeLast(60)
            _posts.value = updatedPosts
        }
    }</span></pre> <p class="calibre3"><span class="kobospan" id="kobo.1493.1">Here, we’ve renamed our initial function </span><strong class="source-inline"><span class="kobospan" id="kobo.1494.1">loadInitialPosts()</span></strong><span class="kobospan" id="kobo.1495.1"> so that it indicates that it will load the first posts. </span><span class="kobospan" id="kobo.1495.2">Then, we created a new function called </span><strong class="source-inline"><span class="kobospan" id="kobo.1496.1">loadMorePosts()</span></strong><span class="kobospan" id="kobo.1497.1"> that will load the new page. </span><span class="kobospan" id="kobo.1497.2">It will add it to the existing </span><span><span class="kobospan" id="kobo.1498.1">post list.</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.1499.1">Now, we need to </span><a id="_idIndexMarker520" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.1500.1">make a </span><a id="_idIndexMarker521" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.1501.1">few modifications to our </span><strong class="source-inline"><span class="kobospan" id="kobo.1502.1">NewsFeed</span></strong><span class="kobospan" id="kobo.1503.1"> composable so that it will call the ViewModel when a new page is needed. </span><span class="kobospan" id="kobo.1503.2">For that reason, we need to create a </span><strong class="source-inline"><span class="kobospan" id="kobo.1504.1">LazyListState</span></strong><span class="kobospan" id="kobo.1505.1"> extension that we will invoke whenever the user reaches the end of </span><span><span class="kobospan" id="kobo.1506.1">the list:</span></span></p>
<pre class="source-code"><span class="kobospan1" id="kobo.1507.1">
fun LazyListState.OnBottomReached(
    loadMore : () -&gt; Unit
){
    val shouldLoadMore = remember {
        derivedStateOf {
            val lastItemInView =
                layoutInfo.visibleItemsInfo.lastOrNull()
                    ?: return@derivedStateOf true
            lastItemInView.index ==
                layoutInfo.totalItemsCount - 1
        }
    }
    LaunchedEffect(shouldLoadMore){
        snapshotFlow { shouldLoadMore.value }
            .collect {
                if (it) loadMore()
            }
    }
}</span></pre> <p class="calibre3"><span class="kobospan" id="kobo.1508.1">This extension function observes the scrolling state of </span><strong class="source-inline"><span class="kobospan" id="kobo.1509.1">LazyColumn</span></strong><span class="kobospan" id="kobo.1510.1"> or </span><strong class="source-inline"><span class="kobospan" id="kobo.1511.1">LazyRow</span></strong><span class="kobospan" id="kobo.1512.1">. </span><span class="kobospan" id="kobo.1512.2">When the user has scrolled to the bottom, it calls the provided </span><strong class="source-inline"><span class="kobospan" id="kobo.1513.1">loadMore</span></strong><span class="kobospan" id="kobo.1514.1"> function to load more </span><a id="_idIndexMarker522" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.1515.1">items. </span><span class="kobospan" id="kobo.1515.2">This </span><a id="_idIndexMarker523" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.1516.1">pattern is common in implementing “infinite scrolling” or “pagination,” which is what we are </span><span><span class="kobospan" id="kobo.1517.1">currently implementing.</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.1518.1">Now, we need to use it in our </span><strong class="source-inline"><span class="kobospan" id="kobo.1519.1">LazyColumn</span></strong><span class="kobospan" id="kobo.1520.1"> layout. </span><span class="kobospan" id="kobo.1520.2">For that, we need to remember </span><strong class="source-inline"><span class="kobospan" id="kobo.1521.1">LazyListState</span></strong><span class="kobospan" id="kobo.1522.1"> in the </span><span><strong class="source-inline"><span class="kobospan" id="kobo.1523.1">NewsFeed</span></strong></span><span><span class="kobospan" id="kobo.1524.1"> composable:</span></span></p>
<pre class="source-code"><span class="kobospan1" id="kobo.1525.1">
@Composable
fun NewsFeed(
    modifier: Modifier = Modifier,
    viewModel: NewsFeedViewModel = koinViewModel()
) {
    val posts = viewModel.posts.collectAsState()
    val listState = rememberLazyListState()
    LazyColumn{
        itemsIndexed(posts){ _, post -&gt;
            PostItem(post = post)
        }
    }
    listState.OnBottomReached {
        viewModel.loadMorePosts()
    }
}</span></pre> <p class="calibre3"><span class="kobospan" id="kobo.1526.1">With this change, every time our user reaches the bottom of the list, we will call the function to load more posts and get the </span><span><span class="kobospan" id="kobo.1527.1">next page.</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.1528.1">Now that</span><a id="_idIndexMarker524" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.1529.1"> we’ve </span><a id="_idIndexMarker525" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.1530.1">finished our paging implementation, our user experience will be more performant and smoother when navigating </span><span><span class="kobospan" id="kobo.1531.1">the newsfeed.</span></span></p>
<h1 id="_idParaDest-107" class="calibre5"><a id="_idTextAnchor108" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.1532.1">Summary</span></h1>
<p class="calibre3"><span class="kobospan" id="kobo.1533.1">In this chapter, we primarily focused on structuring and modularizing our Packtagram app while enhancing maintainability. </span><span class="kobospan" id="kobo.1533.2">Leveraging Jetpack Compose, we designed the components and screens for some of the features of the interface that we are going to be working on in the </span><span><span class="kobospan" id="kobo.1534.1">next chapters.</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.1535.1">Additionally, this chapter delved into the intricacies of connecting the developed UI to the backend, which is pivotal for data management and operation handling. </span><span class="kobospan" id="kobo.1535.2">We implemented Retrofit for network operations and Moshi for JSON parsing, bridging the gap between the user interface and the data source. </span><span class="kobospan" id="kobo.1535.3">Moreover, we introduced the concept of paging to efficiently manage large datasets. </span><span class="kobospan" id="kobo.1535.4">By doing so, we ensured smoother data load, faster response times, and enhanced app performance overall, significantly improving the </span><span><span class="kobospan" id="kobo.1536.1">user’s experience.</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.1537.1">In the next chapter, we will dive into the photo functionality of our app. </span><span class="kobospan" id="kobo.1537.2">We will use an incredible library called CameraX and take advantage of some of its capabilities. </span><span class="kobospan" id="kobo.1537.3">We will also learn how to apply machine learning to our camera preview using </span><span><span class="kobospan" id="kobo.1538.1">ML Kit.</span></span></p>
</div>
</body></html>