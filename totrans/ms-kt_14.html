<html><head></head><body><div id="book-content"><div id="sbo-rt-content"><div id="_idContainer243">
			<h1 id="_idParaDest-168" class="chapter-number"><a id="_idTextAnchor198"/>14</h1>
			<h1 id="_idParaDest-169"><a id="_idTextAnchor199"/>Continuous Integration and Continuous Deployment</h1>
			<p>After we complete the development and first deployment of our app, we must think of how to <a id="_idIndexMarker722"/>make the process smoother for consecutive deployments, and that’s where <strong class="bold">Continuous integration/Continuous delivery</strong> (<strong class="bold">CI/CD</strong>) <span class="No-Break">comes in.</span></p>
			<p>In this chapter, we will learn how to use GitHub Actions to automate some of the manual tasks, such as deploying new builds to the Google Play Store. We will learn how to run tests on CI/CD pipelines and push builds to the Play Store using <span class="No-Break">GitHub Actions.</span></p>
			<p>In this chapter, we’re going to cover the following <span class="No-Break">main topics:</span></p>
			<ul>
				<li>Setting up <span class="No-Break">GitHub Actions</span></li>
				<li>Running lint checks and tests on <span class="No-Break">GitHub Actions</span></li>
				<li>Deploying to Play Store using <span class="No-Break">GitHub Actions</span></li>
			</ul>
			<h1 id="_idParaDest-170"><a id="_idTextAnchor200"/>Technical requirements</h1>
			<p>To follow the instructions in this chapter, you will need to have Android Studio Hedgehog or later (<a href="https://developer.android.com/studio"><span class="No-Break">https://developer.android.com/studio</span></a><span class="No-Break">) </span><span class="No-Break">downloaded</span><span class="No-Break">.</span></p>
			<p>You can use the previous chapter’s code to follow the instructions in this chapter. You can find the code for this chapter <span class="No-Break">at </span><a href="https://github.com/PacktPublishing/Mastering-Kotlin-for-Android/tree/main/chapterfourteen"><span class="No-Break">https://github.com/PacktPublishing/Mastering-Kotlin-for-Android/tree/main/chapterfourteen</span></a><span class="No-Break">.</span></p>
			<h1 id="_idParaDest-171"><a id="_idTextAnchor201"/>Setting up GitHub Actions</h1>
			<p>Before we <a id="_idIndexMarker723"/>can understand GitHub Actions, we need to understand what CI/CD is. This is a process that allows us to automate the building, testing, and deployment of our code to production. CI/CD not only automates these processes but also integrates them into a single coherent pipeline. This ensures that code changes are more reliable and stable when deployed. The definition should emphasize the role of CI/CD in facilitating frequent and reliable updates. This is an especially <a id="_idIndexMarker724"/>important process as it aims to improve the speed, efficiency, and reliability of how we deliver <span class="No-Break">our software.</span></p>
			<h2 id="_idParaDest-172"><a id="_idTextAnchor202"/>Benefits of CI/CD</h2>
			<p>Let’s go <a id="_idIndexMarker725"/>through some of the benefits <span class="No-Break">of CI/CD:</span></p>
			<ul>
				<li><strong class="bold">Fast release cycles</strong>: CI/CD allows us to release our software faster and more frequently. This is because we are automating the process of building, testing, and deploying <span class="No-Break">our code.</span></li>
				<li><strong class="bold">Increased collaboration</strong>: Since a lot of the processes are automated, we can focus on the code and the features we are building. This allows us to collaborate more effectively with <span class="No-Break">our team.</span></li>
				<li><strong class="bold">Less manual work</strong>: We are reducing the amount of manual work we do due to automation. This means we can focus on the code and the features we <span class="No-Break">are building.</span></li>
				<li><strong class="bold">Improved quality</strong>: Automating the process allows us to test our code more frequently and more effectively. This means we can catch bugs and errors earlier in <span class="No-Break">the process.</span></li>
			</ul>
			<p>Now we have learned about the benefits of CI/CD, let us look at how CI/CD works <span class="No-Break">in detail.</span></p>
			<h2 id="_idParaDest-173"><a id="_idTextAnchor203"/>How CI/CD works</h2>
			<p>Let us <a id="_idIndexMarker726"/>go through how <span class="No-Break">CI/CD works:</span></p>
			<ul>
				<li><strong class="bold">CI</strong>: This is the <a id="_idIndexMarker727"/>process of automating the building and testing of our code. This is done every time we push our code to our repository. This allows us to catch bugs and errors earlier in the process. In this step, once we push or commit code to our remote repository, which can be hosted in GitHub, Gitlab, Bitbucket, and so on, we run checks and tests against these changes to ensure they are functional and meet the code quality standards. If the <a id="_idIndexMarker728"/>tests pass, we can merge the code into the main branch. If the tests fail, we can fix the code and run the <span class="No-Break">tests again.</span></li>
				<li><strong class="bold">CD</strong>: This is the process of automating the deployment of our code to production. This is done every time we push our code to our repository. This allows us <a id="_idIndexMarker729"/>to release our software faster and more frequently. This happens after the CI step. Once the changes are merged to the main or development branch, we can deploy the code to production or whichever environment it needs to be deployed to. This step aims at pushing minor changes to production more frequently. This allows us to release our software faster and <span class="No-Break">more frequently.</span></li>
			</ul>
			<p>With this <a id="_idIndexMarker730"/>background, we can now look at GitHub Actions (<a href="https://docs.github.com/en/actions">https://docs.github.com/en/actions</a>). GitHub Actions is a CI/CD tool that allows us to automate the building, testing, and deployment of our code. It is built into GitHub and is free to use up to certain limits. It is also extremely easy to use and <span class="No-Break">set up.</span></p>
			<p>In the next section, we are going to set up GitHub Actions for our project that is in this <span class="No-Break">repository: </span><a href="https://github.com/PacktPublishing/Mastering-Kotlin-for-Android"><span class="No-Break">https://github.com/PacktPublishing/Mastering-Kotlin-for-Android</span></a></p>
			<h2 id="_idParaDest-174"><a id="_idTextAnchor204"/>Setting up GitHub Actions</h2>
			<p>To enable <a id="_idIndexMarker731"/>GitHub Actions in our project, follow <span class="No-Break">these steps:</span></p>
			<ol>
				<li>Go to the <strong class="bold">Actions</strong> tab of our repository, as shown in the <span class="No-Break">following screenshot:</span></li>
			</ol>
			<div>
				<div id="_idContainer231" class="IMG---Figure">
					<img src="image/B19779_14_01.jpg" alt="Figure 14.1 – GitHub Actions tab" width="690" height="156"/>
				</div>
			</div>
			<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 14.1 – GitHub Actions tab</p>
			<p class="list-inset">This step will bring us to the GitHub Actions <span class="No-Break">landing page:</span></p>
			<div>
				<div id="_idContainer232" class="IMG---Figure">
					<img src="image/B19779_14_02.jpg" alt="Figure 14.2 – GitHub Actions landing page" width="1147" height="871"/>
				</div>
			</div>
			<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 14.2 – GitHub Actions landing page</p>
			<ol>
				<li value="2">As seen <a id="_idIndexMarker732"/>in the preceding image, we have some suggested actions that we can use in our repository. For now, we will set the actions by ourselves, so let us click on the <strong class="bold">set up a workflow yourself</strong> option. This brings us to the <span class="No-Break">following page:</span></li>
			</ol>
			<div>
				<div id="_idContainer233" class="IMG---Figure">
					<img src="image/B19779_14_03.jpg" alt="Figure 14.3 – New GitHub Action" width="842" height="539"/>
				</div>
			</div>
			<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 14.3 – New GitHub Action</p>
			<p class="list-inset">As you can <a id="_idIndexMarker733"/>see in the preceding image, we have an editor for writing our workflow. Notice at the top we now have a new folder called <strong class="source-inline">.github</strong>. This is where we will store our workflow files. The editor saves the workflow file in the <strong class="source-inline">.github/workflows</strong> folder. By default, our workflow is named <strong class="source-inline">main.yml</strong>. On the right, we have templates that we can use to easily create <span class="No-Break">our workflow.</span></p>
			<ol>
				<li value="3">For now, we are going to create our own workflow, so let us add the following code to <span class="No-Break">our workflow:</span><pre class="source-code">
name: Push
on:
  push:
    branches: ["main" ]
  workflow_dispatch:
jobs:
  build:
    name: Build
    runs-on: ubuntu-latest
    steps:
        - run: echo "The job was automatically triggered by a ${{ github.event_name }} event."</pre><p class="list-inset">Let’s understand <a id="_idIndexMarker734"/>the different fields in the preceding <span class="No-Break">workflow file:</span></p><ul><li><strong class="source-inline">name</strong>: This is the name of our workflow. This will be displayed on the GitHub <span class="No-Break">Actions page.</span></li><li><strong class="source-inline">on</strong>: This is the event that will trigger our workflow. In our case, we are triggering our workflow when we push code to the <span class="No-Break">main branch.</span></li><li><strong class="source-inline">workflow_dispatch</strong>: This is a manual trigger that we can use to trigger our workflow from the GitHub Actions page. This is useful when we want to trigger our <span class="No-Break">workflow manually.</span></li><li><strong class="source-inline">jobs</strong>: This is the job that will be run when our workflow is triggered. In our case, we have a job called <strong class="source-inline">build</strong>. This job will run on the latest version of Ubuntu as specified by the <span class="No-Break"><strong class="source-inline">runs-on</strong></span><span class="No-Break"> field.</span></li><li><strong class="source-inline">steps</strong>: This field contains the steps that will be run in our job. In our case, we have a single step that will run a command. This command will print out the event that triggered our workflow. A step can contain a shell command or an action from <span class="No-Break">GitHub Marketplace.</span></li></ul></li>				<li>Click on the <strong class="bold">Commit changes...</strong> button. This will commit our workflow file to our repository and trigger our workflow. We can see the workflow running in the <strong class="bold">Actions</strong> tab, as shown in the <span class="No-Break">following screenshot:</span></li>
			</ol>
			<div>
				<div id="_idContainer234" class="IMG---Figure">
					<img src="image/B19779_14_04.jpg" alt="Figure 14.4 – First GitHub Action" width="836" height="173"/>
				</div>
			</div>
			<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 14.4 – First GitHub Action</p>
			<p class="list-inset">In the preceding image, we can see the commit that triggered the workflow and the workflow itself. We can also see the job that was run and the step that was run. We can <a id="_idIndexMarker735"/>also see the output of the step. Additionally, we can see the time it took to run the workflow. If we tap the action, we can see <span class="No-Break">more details:</span></p>
			<div>
				<div id="_idContainer235" class="IMG---Figure">
					<img src="image/B19779_14_05.jpg" alt="Figure 14.5 – Github Action details" width="687" height="209"/>
				</div>
			</div>
			<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 14.5 – Github Action details</p>
			<p class="list-inset">This shows the steps that were run and the time the job took to run. It also shows the total duration of <span class="No-Break">the workflow.</span></p>
			<p class="list-inset">This was a simple workflow that just printed out the event that triggered the workflow. We can also do more complex things in <span class="No-Break">our workflow.</span></p>
			<p>Let us see how we can set up Android-related actions in <span class="No-Break">our workflow:</span></p>
			<ol>
				<li>Head to the newly created <strong class="source-inline">.github/workflows</strong> folder and edit the <span class="No-Break"><strong class="source-inline">main.yml</strong></span><span class="No-Break"> file.</span></li>
				<li>Let us add the following code to our workflow below the previous command we ran in <em class="italic">step 3 </em>of the <span class="No-Break">previous section:</span><pre class="source-code">
- name: Checkout
  uses: actions/checkout@v3
- name: Set up JDK 17
  uses: actions/setup-java@v3
  with:
    java-version: '17'
    distribution: 'zulu'
    cache: gradle
- name: Grant execute permission for gradlew
  run: chmod +x gradlew
  working-directory: ./chapterfourteen
- name: Build with Gradle
  run: ./gradlew assembleDebug
  working-directory: ./chapterfourteen</pre><p class="list-inset">Let us <a id="_idIndexMarker736"/>understand the <span class="No-Break">preceding code:</span></p><ul><li>We have created another step called <strong class="source-inline">Checkout</strong>. This step will <strong class="source-inline">checkout</strong> our code from our repository. This is done using the <strong class="source-inline">checkout</strong> action, which we specify using the <strong class="source-inline">uses</strong> field. This action is fetched from <span class="No-Break">GitHub Marketplace.</span></li><li>We have <a id="_idIndexMarker737"/>created another step called <strong class="source-inline">Set up JDK 17</strong>. This step will set up JDK 17. <strong class="bold">Java Development Kit</strong> (<strong class="bold">JDK</strong>) is a development environment for building applications and components using the Java programming language. 17 is the version of JDK that we use. We <a id="_idIndexMarker738"/>use this version since the <strong class="bold">Android Gradle Plugin</strong> (<strong class="bold">AGP</strong>) from version 8.0.0 requires JDK 17 to work. Our project runs on <span class="No-Break">AGP 8.2.1.</span></li><li>This is done using the <strong class="source-inline">setup-java</strong> action, which we specify using the <strong class="source-inline">uses</strong> field. We specify the version of Java we want to use using the <strong class="source-inline">java-version</strong> field. We specify the distribution of Java we want to use using the <strong class="source-inline">distribution</strong> field. We also specify that we want to cache Gradle using the <span class="No-Break"><strong class="source-inline">cache</strong></span><span class="No-Break"> field.</span></li><li>We have <a id="_idIndexMarker739"/>created another step called <strong class="source-inline">Grant execute permission for gradlew</strong>. This step will grant execute permission for gradlew. This is done using the <strong class="source-inline">run</strong> command. We specify the command we want to run using the <strong class="source-inline">run</strong> field. We also specify the working directory we want to run the command in using the <strong class="source-inline">working-directory</strong> field. In this case, we want to run the command in the <strong class="source-inline">chapterfourteen</strong> folder since we have a number of folders in our repository. Note that this step is platform-dependent since it is only necessary for Unix-based systems but might be redundant for Windows-based systems. Therefore, it may not be required in all <span class="No-Break">CI/CD setups.</span></li><li>Lastly, we have created another step called <strong class="source-inline">Build with Gradle</strong>. This step will build our project using Gradle. <a id="_idTextAnchor205"/>Here, we run the <strong class="source-inline">./gradlew assembleDebug</strong> command. This command generates a debug Android APK for our project. We also specify the working directory in which we want to run <span class="No-Break">the command.</span></li></ul><p class="list-inset">One thing to note is that <strong class="source-inline">.yml</strong> files are overly sensitive to indentation. So, we need to ensure that we indent our <span class="No-Break">code correctly.</span></p></li>				<li>Commit to the changes and the action will automatically run. We can see the workflow results and, looking at the job build, we can see all the steps that were run, as shown in the <span class="No-Break">following screenshot:</span></li>
			</ol>
			<div>
				<div id="_idContainer236" class="IMG---Figure">
					<img src="image/B19779_14_06.jpg" alt="Figure 14.6 – GitHub Action steps" width="759" height="320"/>
				</div>
			</div>
			<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 14.6 – GitHub Action steps</p>
			<p>We now know <a id="_idIndexMarker740"/>what GitHub Actions are, have created our first action, and have seen how we can run Android-specific workflows on GitHub Actions. In the next section, we will run lint checks and tests in <span class="No-Break">our workflow.</span></p>
			<h1 id="_idParaDest-175"><a id="_idTextAnchor206"/>Running lint checks and tests on GitHub Actions</h1>
			<p>In <a href="B19779_11.xhtml#_idTextAnchor135"><span class="No-Break"><em class="italic">Chapter 11</em></span></a>, we learned how to run lint checks on our project using shell commands on the terminal. We have <a id="_idIndexMarker741"/>also learned how to write tests for our code <a id="_idIndexMarker742"/>base. In this section, we are going to run the format, lint checks, and tests on our newly created actions and we will do all of this step <span class="No-Break">by step:</span></p>
			<ol>
				<li>First, we will add the <span class="No-Break"><strong class="source-inline">ktlintCheck</strong></span><span class="No-Break"> step:</span><pre class="source-code">
- name: Run ktlintCheck
  run: ./gradlew<a id="_idTextAnchor207"/> ktlintCheck
  working-directory: ./chapterfourteen</pre><p class="list-inset">In this code, we have added a step called <strong class="source-inline">Run ktlintCheck</strong>. This step will run the <strong class="source-inline">ktlintCheck</strong> command, which will check whether our code is formatted correctly. This step fails if our code is not <span class="No-Break">formatted correctly.</span></p></li>				<li>Next, we add the <span class="No-Break"><strong class="source-inline">detekt</strong></span><span class="No-Break"> step:</span><pre class="source-code">
- name: Run detekt
  run: ./gradlew detekt
  working-directory: ./chapterfourteen</pre><p class="list-inset">In this step, we run the <strong class="source-inline">detekt</strong> command, which will run the detekt checks on the code that we set up earlier in <a href="B19779_11.xhtml#_idTextAnchor135"><span class="No-Break"><em class="italic">Chapter 11</em></span></a>. This step fails if our code does not pass the <span class="No-Break">detekt checks.</span></p></li>				<li>Next, we add the <span class="No-Break">test step:</span><pre class="source-code">
- name: Run unit tests
  run: ./gradlew testDebugUnitTest
  working-directory: ./chapterfourteen</pre><p class="list-inset">This step <a id="_idIndexMarker743"/>will run all the unit tests in our project. This step <a id="_idIndexMarker744"/>fails if any of the <span class="No-Break">tests fail.</span></p></li>				<li>Lastly, we add the step to run our <span class="No-Break">instrumented tests:</span><pre class="source-code">
- name: Run connected tests
  uses: ReactiveCircus/android-emulator-runner@v2
  with:
    working-directory: ./chapterfourteen
    api-level: 33
    target: google_apis
    arch: x86_64
    disable-animations: true
    script: ./gradlew connectedCheck</pre><p class="list-inset">This step uses the <strong class="source-inline">android-emulator-runner</strong> action to run our instrumented tests on an emulator. This action sets up an emulator to run our instrumented tests in the CI environment. In the action configuration, we set up <span class="No-Break">the following:</span></p><ul><li><strong class="source-inline">working-directory</strong>: This is where our project <span class="No-Break">is located.</span></li><li><strong class="source-inline">api-level</strong>: This is the API level of the platform system image for <span class="No-Break">our emulator.</span></li><li><strong class="source-inline">target</strong>: This is the target for the system image of <span class="No-Break">the emulator.</span></li><li><strong class="source-inline">architecture</strong>: We specify the architecture of the emulator we want to run our <span class="No-Break">tests on.</span></li><li><strong class="source-inline">disable-animations</strong>: We disable animations in <span class="No-Break">the emulator.</span></li><li>Lastly, we specify the command we want to run using the script field. In this case, we run the <strong class="source-inline">connectedCheck</strong> task, which will run our <span class="No-Break">instrumented tests.</span></li></ul></li>				<li>After making <a id="_idIndexMarker745"/>the p<a id="_idTextAnchor208"/>receding changes, commit the changes <a id="_idIndexMarker746"/>and the action will run. We can see the results of the action in the <strong class="bold">Actions</strong> tab, as shown in the <span class="No-Break">following screenshot:</span></li>
			</ol>
			<div>
				<div id="_idContainer237" class="IMG---Figure">
					<img src="image/B19779_14_07.jpg" alt="Figure 14.7 – More Github Actions steps" width="981" height="490"/>
				</div>
			</div>
			<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 14.7 – More Github Actions steps</p>
			<p>We’ve expanded our workflow by incorporating additional steps to perform lint checks and tests. We can see the results of each step. We can also see the time it took to run each step. The <strong class="source-inline">Run connected test</strong> step takes the longest time to run. This is because it must set up the emulator and run <span class="No-Break">the tests.</span></p>
			<p>We need to modify when the <strong class="bold">Push</strong> workflow on the <strong class="source-inline">main.yml</strong> file runs. Currently, our workflow runs when we push code to the main branch. We are going to change this to also run <a id="_idIndexMarker747"/>when we create a pull request to the main branch. This is because <a id="_idIndexMarker748"/>we want to run our checks before we move our code to the main branch. To do this, we are going to add the <strong class="source-inline">pull_request</strong> event just above the <span class="No-Break"><strong class="source-inline">workflow_dispatch</strong></span><span class="No-Break"> event:</span></p>
			<pre class="source-code">
on:
  push:
    branches: ["main" ]
  pull_request:
  workflow_dispatch:</pre>			<p>After making <a id="_idTextAnchor209"/>this change, we can commit the changes and the action will run. Let us now create a pull request to test the changes. Ensure that you pull all the changes that we made in our browser locally before proceeding with the <span class="No-Break">following steps:</span></p>
			<ol>
				<li>First, let us create a new branch <span class="No-Break">called </span><span class="No-Break"><strong class="source-inline">test</strong></span><span class="No-Break">.</span></li>
				<li>Open the terminal in Android Studio and run the <span class="No-Break">following command:</span><pre class="source-code">
<strong class="bold">git checkout -b test</strong></pre><p class="list-inset">This command creates a new branch called <strong class="source-inline">test</strong> and switches to the newly <span class="No-Break">created branch.</span></p></li>				<li>Next, let us modify the app’s <strong class="source-inline">versionName</strong> and <strong class="source-inline">versionCode</strong> in our app-level <span class="No-Break"><strong class="source-inline">build.gradle.kts</strong></span><span class="No-Break"> file:</span><pre class="source-code">
versionCode = 2
versionName = "1.0<a id="_idTextAnchor210"/>.1"</pre></li>				<li>Tap <strong class="bold">Sync Now</strong> to sync these changes to <span class="No-Break">our project.</span></li>
				<li>After making the <strong class="source-inline">versionName</strong> and <strong class="source-inline">versionCode</strong> changes, we can commit the changes and push them to our remote repository. We can do this by running the following command <a id="_idTextAnchor211"/>in <span class="No-Break">the terminal:</span><pre class="source-code">
<strong class="bold">it add .</strong></pre><p class="list-inset">This command stages all the changes we <span class="No-Break">have made.</span></p></li>				<li>Next, we run <a id="_idIndexMarker749"/>the <span class="No-Break">following command:</span><pre class="source-code">
<strong class="bold">git commit -m "Update app version name and code"</strong></pre><p class="list-inset">This <a id="_idIndexMarker750"/>command commits the changes we <span class="No-Break">have made.</span></p></li>				<li>Next, we run the <span class="No-Break">following command:</span><pre class="source-code">
<strong class="bold">git push origin test</strong></pre><p class="list-inset">This command pushes the changes to our <span class="No-Break">remote repository.</span></p></li>				<li>Next, head to our repository in a browser, open the <strong class="bold">Pull requests</strong> tab, and click on the <strong class="bold">New pull request</strong> button. This will open the <span class="No-Break">following page:</span></li>
			</ol>
			<div>
				<div id="_idContainer238" class="IMG---Figure">
					<img src="image/B19779_14_08.jpg" alt="Figure 14.8 – Create a new pull request" width="1093" height="438"/>
				</div>
			</div>
			<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 14.8 – Create a new pull request</p>
			<p class="list-inset">On this page, we set the <strong class="source-inline">base</strong> branch and the <strong class="source-inline">compare</strong> branch. The <strong class="source-inline">base</strong> branch is the branch we want <a id="_idTextAnchor212"/>to merge our changes to. In our case, we want to merge our changes to the <strong class="source-inline">main</strong> branch. The <strong class="source-inline">compare</strong> branch is the branch that has recent changes. In our case, we want to merge changes from the <strong class="source-inline">test</strong> branch to the <strong class="source-inline">main</strong> branch. We can see the changes we have made as soon as we set the <span class="No-Break"><strong class="source-inline">compare</strong></span><span class="No-Break"> branch.</span></p>
			<ol>
				<li value="9">Finalize the <a id="_idIndexMarker751"/>pull request by clicking on the <strong class="bold">Create pull request</strong> button. After <a id="_idIndexMarker752"/>creating the pull request, we can review the pull <span class="No-Break">request details:</span></li>
			</ol>
			<div>
				<div id="_idContainer239" class="IMG---Figure">
					<img src="image/B19779_14_09.jpg" alt="Figure 14.9 – Pull request checks" width="906" height="801"/>
				</div>
			</div>
			<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 14.9 – Pull request checks</p>
			<p class="list-inset">As seen in the preceding image, the workflow checks have started running since we created a pull request and we specified that our workflow should run when we create a pull request. The <strong class="bold">Merge pull request</strong> button is disabled since the workflow is <span class="No-Break">still running.</span></p>
			<p class="list-inset">Once the workflow is done running, we can merge the pull request. We can enforce even further rules per the checks but for now, we are good to go with the default <a id="_idIndexMarker753"/>behavior. Once the workflow completes and all <a id="_idIndexMarker754"/>checks pass, we should see <span class="No-Break">the following:</span></p>
			<div>
				<div id="_idContainer240" class="IMG---Figure">
					<img src="image/B19779_14_10.jpg" alt="Figure 14.10 – Pull request checks complete" width="908" height="809"/>
				</div>
			</div>
			<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 14.10 – Pull request checks complete</p>
			<p>We have now learned how to run lint checks and tests on GitHub Actions. In the next section, we are going to learn how to deploy our app to Google Play Store using <span class="No-Break">GitHub Actions.</span></p>
			<h1 id="_idParaDest-176"><a id="_idTextAnchor213"/>Deploying to Play Store using GitHub Actions</h1>
			<p>In <a href="B19779_13.xhtml#_idTextAnchor175"><span class="No-Break"><em class="italic">Chapter 13</em></span></a>, we learned how to deploy our app to Google Play Store using Google Play Console. However, in that chapter, we did it manually. In this chapter, we are going to learn <a id="_idIndexMarker755"/>how to deploy our app to Google Play Store using GitHub Actions. We are going to use the Google Play Publisher action to <a id="_idIndexMarker756"/>deploy our app to Google Play Store. This action is available in <span class="No-Break">GitHub Marketplace.</span></p>
			<p>Before we can write our workflow, we need to do some setup. We need to create a service account on our Google Play Store account. We can do this by following <span class="No-Break">these steps:</span></p>
			<ol>
				<li>Configure the service account in Google Cloud Platform by following <span class="No-Break">these steps:</span><ol><li class="upper-roman">Navigate <span class="No-Break">to </span><a href="https://cloud.google.com/gcp"><span class="No-Break">https://cloud.google.com/gcp</span></a><span class="No-Break">.</span></li><li class="upper-roman">Navigate to <strong class="bold">IAM and admin</strong> | <strong class="bold">Service accounts</strong> | <strong class="bold">Create </strong><span class="No-Break"><strong class="bold">service account</strong></span><span class="No-Break">.</span></li><li class="upper-roman">Pick a name and add appropriate permissions, for example, <span class="No-Break">owner permissions.</span></li><li class="upper-roman">Open the newly created service account, click on the <strong class="bold">Keys</strong> tab, and add a new JSON <span class="No-Break">type key.</span></li><li class="upper-roman">When the key is successfully created, a JSON file will be automatically downloaded to <span class="No-Break">your machine.</span></li><li class="upper-roman">Store the content of this file in your GitHub repository secrets. You can do this by going to the <strong class="bold">Settings</strong> tab in your repository, clicking on the <strong class="bold">Secrets and variables</strong> section, and selecting the <span class="No-Break"><strong class="bold">Actions</strong></span><span class="No-Break"> option.</span></li><li class="upper-roman">Create a <strong class="bold">New Repository Secret</strong> and upload the JSON file. You can name the secret <strong class="source-inline">GOOGLE_SERVICES_JSON</strong>. This is the name we will use in our workflow to access the <span class="No-Break">JSON file.</span></li></ol></li>
				<li>Add a user to Google Play Console by following <span class="No-Break">these steps:</span><ol><li class="upper-roman" value="8">Open <a href="https://play.google.com/console">https://play.google.com/console</a> and pick your <span class="No-Break">developer account.</span></li><li class="upper-roman">Open <strong class="bold">Users </strong><span class="No-Break"><strong class="bold">and permissions</strong></span><span class="No-Break">.</span></li><li class="upper-roman">Click on <strong class="bold">Invite new user</strong> and add the email of the service account created in <span class="No-Break">step 1.</span></li><li class="upper-roman">Grant permissions to the app to which you want the service account to deploy <span class="No-Break">in-app permissions.</span></li></ol><p class="list-inset">If you need more details on how to do this, you can check out the following <span class="No-Break">link: </span><a href="https://developers.google.com/android/management/service-account"><span class="No-Break">https://developers.google.com/android/management/service-account</span></a></p></li>
			</ol>
			<p>Like how we created the <strong class="source-inline">GOOGLE_SERVICES_JSON</strong> variable in our repository secrets, we need to add the details of our signing certificate to our variables so that we can use <a id="_idIndexMarker757"/>them on our CI/CD pipeline. The first step is to generate a <strong class="source-inline">base64</strong>-encoded version of our signing certificate. We can do <a id="_idIndexMarker758"/>this by running the following command in <span class="No-Break">the terminal:</span></p>
			<pre class="console">
openssl base64 &lt; packt.jks | tr -d '\n' | tee packt.jks.base64.txt</pre>			<p>You should run this command in the directory where you saved your keystore file. You could change the name to match the filename of the keystore file if you named yours differently. This command will generate a <strong class="source-inline">base64</strong>-encoded version of our keystore file. We can then copy the contents of the file and add it to our repository secrets. We need to also add the following secrets to <span class="No-Break">our repository:</span></p>
			<div>
				<div id="_idContainer241" class="IMG---Figure">
					<img src="image/B19779_14_11.jpg" alt="Figure 14.11 – Repository secrets" width="566" height="392"/>
				</div>
			</div>
			<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 14.11 – Repository secrets</p>
			<p>The newly <a id="_idIndexMarker759"/>created secrets are explained <span class="No-Break">as follows:</span></p>
			<ul>
				<li><strong class="source-inline">KEYSTORE_PASSWORD</strong>: This is the password of our <span class="No-Break">keystore file</span></li>
				<li><strong class="source-inline">KEY_ALIAS</strong>: This is the alias of our <span class="No-Break">keystore file</span></li>
				<li><strong class="source-inline">KEY_PASSWORD</strong>: This is the password of our keystore <span class="No-Break">file alias</span></li>
			</ul>
			<p>All these <a id="_idIndexMarker760"/>details should be like the ones we used when we created our keystore file. Now, let us write our workflow. Before writing the workflow, ensure that you have completed the publishing of our app steps in <a href="B19779_13.xhtml#_idTextAnchor175"><span class="No-Break"><em class="italic">Chapter 13</em></span></a>, since this is needed for this action to work. Let us head to the <strong class="source-inline">.github/workflows</strong> folder, create a new file called <strong class="source-inline">deploy-to-playstore.yml</strong>, and add the <span class="No-Break">following code:</span></p>
			<pre class="source-code">
name: Deploy to Playstore
on:
  push:
    branches: [ "main"]
jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - name: set up JDK 17
        uses: actions/setup-java@v3
        with:
          distribution: 'zulu'
          java-version: '17'
  <a href="mailto:chkfung/android-version-actions@v1.1">    - name: Bump version</a>
<a href="mailto:chkfung/android-version-actions@v1.1">        use</a>s: chkfung/android-version-actions@v1.1
        with:
          gradlePath: chapterfourteen/build.gradle.kts
          versionCode: ${{github.run_number}}
          versionName: ${{ format('1.0.{0}', github.run_number ) }}
      - name: Assemble Release Bundle
        working-directory: chapterfourteen
        run: ./gradlew bundleRelease
      - name: De<a href="mailto:r0adkll/upload-google-play@v1.1.1">ploy to Internal Testing</a>
<a href="mailto:r0adkll/upload-google-play@v1.1.1">        </a>uses: r0adkll/upload-google-play@v1.1.1
        with:
          serviceAccountJsonPlainText: ${{ secrets.GOOGLE_SERVICES_JSON }}
          packageName: com.packt.chapterthirteen
          releaseFiles: chapterfourteen/build/outputs/bundle/release/app-release.aab
          track: internal
          whatsNewDirectory: whatsnew/
          status: completed</pre>			<p>The workflow <a id="_idIndexMarker761"/>is remarkably similar to the one we created earlier on in the <em class="italic">Setting up GitHub Actions</em> and <em class="italic">Running lint checks and tests in GitHub Actions</em> sections with only slight differences. We have a step that bumps the <strong class="source-inline">versionName</strong> and <strong class="source-inline">versionCode</strong> for us instead of us having to do this <a id="_idIndexMarker762"/>manually every time. Versioning serves as a structured identifier for different software iterations. Employing semantic versioning aids in communicating the impact of changes, distinguishing major backward-incompatible updates, minor backward-compatible feature additions, and patch-level bug fixes. It plays a crucial role in dependency management, facilitating compatibility between different components. Additionally, versioning supports rollbacks, hotfixes, and efficient testing, ensuring the stability of the application. Release notes and communication are streamlined, providing users and stakeholders with clear insights into each release. Ultimately, versioning contributes to a reliable and predictable user experience, fostering trust and transparency throughout the software development <span class="No-Break">life cycle.</span></p>
			<p>We have <a id="_idIndexMarker763"/>another step that builds a signed <strong class="bold">Android App Bundle</strong> (<strong class="bold">AAB</strong>). We also have another step that deploys the signed AAB to the Google Play Store <strong class="bold">Internal testing</strong> track. We use the <strong class="source-inline">upload-google-play</strong> action, which automates and makes the process easier. We do the configurations on this action, such as specifying our service account, the package name of our app on Play Store, the directory where our signed AAB will be found, and lastly, the track that we want to deploy to. Pushing the changes to the main branch will trigger the actions again and once the <strong class="source-inline">deploy-to-playstore</strong> workflow is complete, we should see a new internal testing release on our Play Store page, as shown in <span class="No-Break">the following:</span></p>
			<div>
				<div id="_idContainer242" class="IMG---Figure">
					<img src="image/B19779_14_12.jpg" alt="Figure 14.12 – New internal testing release" width="527" height="152"/>
				</div>
			</div>
			<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 14.12 – New internal testing release</p>
			<p>We have <a id="_idIndexMarker764"/>completed putting in place our CI/CD process. We <a id="_idIndexMarker765"/>only do this setup once and we can always use it to make deployments and automated testing easier, faster, and more reliable <span class="No-Break">for us.</span></p>
			<h1 id="_idParaDest-177"><a id="_idTextAnchor214"/>Summary</h1>
			<p>In this chapter, we learned how to use GitHub Actions to automate some manual tasks, such as deploying new builds to the Play Store. Additionally, we learned how to run lint checks and tests on CI/CD pipelines and push builds to Google Play Store using <span class="No-Break">GitHub Actions.</span></p>
			<p>In the next chapter, we will learn about techniques to improve our apps by adding analytics, using Firebase Crashlytics, and using cloud messaging to increase user engagement in our apps. Additionally, we will learn some tips and tricks for securing <span class="No-Break">our apps.</span></p>
		</div>
	</div></div></body></html>