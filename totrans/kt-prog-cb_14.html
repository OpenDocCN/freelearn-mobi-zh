<html><head></head><body><div><h1 class="header-title">Web Services with Kotlin</h1>
                
            
            
                
<p class="mce-root">The following recipes will be covered in this chapter:</p>
<ul>
<li style="font-weight: 400">How to run the application on Tomcat</li>
<li style="font-weight: 400">Setting up dependencies for building RESTful services</li>
<li style="font-weight: 400">How to create a REST controller</li>
<li style="font-weight: 400">Creating the Application class for Spring boot</li>
</ul>


            

            
        
    </div>



  
<div><h1 class="header-title">Introduction</h1>
                
            
            
                
<p>Kotlin has been eating up the Java world. It has already become a hit in Android Ecosystem which was dominated by Java and is welcomed with open arms everywhere. Kotlin is not limited to Android development and can be used to develop server-side, client-side web applications. One of the <kbd>use</kbd> cases that we will address in this chapter is creating web-services using Kotlin. Kotlin is 100% compatible with the JVM and so you can use any existing frameworks such as Spring Boot, Vert.x, or JSF for writing Java applications. </p>
<p> </p>


            

            
        
    </div>



  
<div><h1 class="header-title">How to run the application on Tomcat</h1>
                
            
            
                
<p>In this recipe, we will learn how to install, configure, and run the application on Tomcat in IntelliJ IDEA.</p>
<div><strong>Apache Tomcat</strong>, often referred to as Tomcat Server, is an open source Java Servlet Container developed by the Apache Software Foundation (ASF). Tomcat implements several Java EE specifications, including Java Servlet, JavaServer Pages (JSP), Java EL, and WebSocket, and provides a "pure Java" HTTP web server environment in which Java code can run.<br/>
Source: Wikipedia</div>


            

            
        
    </div>



  
<div><h1 class="header-title">How to do it…</h1>
                
            
            
                
<p>Now, let's follow the given steps to run the application on Tomcat:</p>
<ol>
<li>First, you need to download the Tomcat from <a href="http://tomcat.apache.org/download-80.cgi">http://tomcat.apache.org/download-80.cgi</a>.</li>
<li>The downloaded file will be a compressed file, and you can extract it with:</li>
</ol>
<pre style="padding-left: 60px"><strong>tar xvzf apache-tomcat-8.0.9.tar.gz</strong></pre>
<ol start="3">
<li>Next, you need to move it from the downloaded folder to the proper location, at:</li>
</ol>
<pre style="padding-left: 60px"><strong>mv apache-tomcat-8.0.9 /opt/tomcat</strong></pre>
<ol start="4">
<li>You also need to check whether you have JDK set up on your system. You can do that by typing in the following command:</li>
</ol>
<pre style="padding-left: 60px"><strong>java -version</strong></pre>
<ol start="5">
<li>If you see The program 'java' can be found in the following packages:, it means you need to install JDK. You can do it with the following:</li>
</ol>
<pre style="padding-left: 60px"><strong>sudo apt-get install openjdk-7-jdk</strong></pre>
<ol start="6">
<li>After that, add the following lines to the end of the <kbd>.bashrc</kbd> file:</li>
</ol>
<pre style="padding-left: 60px" class="mce-root">export JAVA_HOME=/usr/lib/jvm/java-7-openjdk-amd64<br/>export CATALINA_HOME=/opt/tomcat</pre>
<ol start="7">
<li class="mce-root">Simply save and exit <kbd>.bashrc</kbd>, and then make the changes effective by running the following command:</li>
</ol>
<pre style="padding-left: 60px" class="mce-root"><strong>. ~/.bashrc</strong></pre>
<ol start="8">
<li class="mce-root">Tomcat and Java should now be installed and configured on your server. To activate Tomcat, run the following script:</li>
</ol>
<pre style="padding-left: 60px" class="mce-root"><strong>$CATALINA_HOME/bin/startup.sh</strong></pre>
<p style="padding-left: 60px" class="mce-root">You should get a result similar to the following:</p>
<pre style="padding-left: 60px" class="mce-root"><strong>Using CATALINA_BASE: /opt/tomcat</strong><br/><strong>Using CATALINA_HOME: /opt/tomcat</strong><br/><strong>Using CATALINA_TMPDIR: /opt/tomcat/temp</strong><br/><strong>Using JRE_HOME: /usr/lib/jvm/java-7-openjdk-amd64/</strong><br/><strong>Using CLASSPATH: /opt/tomcat/bin/bootstrap.jar:/opt/tomcat/bin/tomcat-juli.jar</strong><br/><strong>Tomcat started.</strong></pre>
<ol start="9">
<li class="mce-root">Open <kbd>http://127.0.0.1:8080</kbd> to check if it's working.</li>
<li class="mce-root">Now, you'll need IntelliJ IDEA's ultimate edition to be able to use Tomcat in IntelliJ; community edition doesn't provide support for Java EE application.</li>
<li class="mce-root">In order to run the application, we need the corresponding WAR(s) for deploying, which you can do just by adding the following lines in the terminal:</li>
</ol>
<pre style="padding-left: 60px"><strong>gradle war</strong></pre>
<ol start="12">
<li>You need to go to Run | Edit configuration and add Tomcat:</li>
</ol>
<div><img height="715" width="1081" src="img/562221b9-414d-417f-902d-ec4116e12eff.png"/></div>
<ol start="13">
<li> Now if you move to your localhost server, you can see the application hosted there.</li>
</ol>
<p>For instructions on Windows installation of Tomcat, refer to <a href="https://www.ntu.edu.sg/home/ehchua/programming/howto/Tomcat_HowTo.html">https://www.ntu.edu.sg/home/ehchua/programming/howto/Tomcat_HowTo.html</a>.</p>


            

            
        
    </div>



  
<div><h1 class="header-title">Setting up dependencies for building RESTful services</h1>
                
            
            
                
<p>In this recipe, we will lay the foundation for developing the RESTful service. We will see how to set up dependencies and run our first SpringBoot web application. SpringBoot provides great support for Kotlin, which makes it easy to work with Kotlin. So let's get started.</p>


            

            
        
    </div>



  
<div><h1 class="header-title">Getting ready</h1>
                
            
            
                
<p>We will be using IntelliJ IDEA and Gradle build system. If you don't have that, you can get it from <a href="https://www.jetbrains.com/idea/">https://www.jetbrains.com/idea/</a>.</p>


            

            
        
    </div>



  
<div><h1 class="header-title">How to do it…</h1>
                
            
            
                
<p>Let's follow the given steps to set up the dependencies for building RESTful services:</p>
<ol>
<li>First, we will create a new project in IntelliJ IDE. We will be using the Gradle build system for maintaining dependency, so create a <kbd>Gradle</kbd> project:</li>
</ol>
<div><img height="502" width="742" src="img/bbf0f1fe-e506-4ab6-a92d-ea7ddb335373.png"/></div>
<ol start="2">
<li>When you have created the project, just add the following lines to your <kbd>build.gradle</kbd> file. These lines of code contain spring-boot dependencies that we will need to develop the web app:</li>
</ol>
<pre style="padding-left: 60px">buildscript {<br/>    ext.kotlin_version = '1.1.60' // Required for Kotlin integration<br/>    ext.spring_boot_version = '1.5.4.RELEASE'<br/>    repositories {<br/>        jcenter()<br/>    }<br/>    dependencies {<br/>        classpath "org.jetbrains.kotlin:kotlin-gradle-plugin:$kotlin_version" // Required for Kotlin integration<br/>        classpath "org.jetbrains.kotlin:kotlin-allopen:$kotlin_version" // See https://kotlinlang.org/docs/reference/compiler-plugins.html#kotlin-spring-compiler-plugin<br/>        classpath "org.springframework.boot:spring-boot-gradle-plugin:$spring_boot_version"<br/>    }<br/>}<br/><br/>apply plugin: 'kotlin' // Required for Kotlin integration<br/>apply plugin: "kotlin-spring" // See https://kotlinlang.org/docs/reference/compiler-plugins.html#kotlin-spring-compiler-plugin<br/>apply plugin: 'org.springframework.boot'<br/><br/>jar {<br/>    baseName = 'gs-rest-service'<br/>    version = '0.1.0'<br/>}<br/>sourceSets {<br/>    main.java.srcDirs += 'src/main/kotlin'<br/>}<br/><br/>repositories {<br/>    jcenter()<br/>}<br/><br/>dependencies {<br/>    compile "org.jetbrains.kotlin:kotlin-stdlib:$kotlin_version" // Required for Kotlin integration<br/>    compile 'org.springframework.boot:spring-boot-starter-web'<br/>    testCompile('org.springframework.boot:spring-boot-starter-test')<br/>}</pre>
<ol start="3">
<li>Let's now create an <kbd>App.kt</kbd> file in the following directory hierarchy:</li>
</ol>
<div><img height="438" width="260" src="img/7fcf4fc2-9412-4a69-8a28-938d4ed60ad7.png"/></div>
<p style="padding-left: 60px">It is important to keep the <kbd>App.kt</kbd> file in a package (we've used the <kbd>college</kbd> package). Otherwise, you will get an error that says the following:</p>
<pre style="padding-left: 60px">** WARNING ** : Your ApplicationContext is unlikely to start due to a `@ComponentScan` of the default package.</pre>
<p style="padding-left: 60px">The reason for this error is that if you don't include a package declaration, it considers it a "default package," which is discouraged and avoided.</p>
<ol start="4">
<li>Now, let's try to run the <kbd>App.kt</kbd> class. We will put the following code to test if it's running:</li>
</ol>
<pre style="padding-left: 60px" class="graf graf--pre graf-after--p">@SpringBootApplication<br/><strong>open class </strong>App {<br/>}<br/><br/><strong>fun </strong>main(args: Array&lt;String&gt;) {<br/>    SpringApplication.run(App::<strong>class</strong>.<em>java</em>, *args)<br/>}</pre>
<ol start="5">
<li>Now run the project; if everything goes well, you will see output with the following line at the end:</li>
</ol>
<pre style="padding-left: 60px"><strong>Started AppKt in 5.875 seconds (JVM running for 6.445)</strong></pre>
<ol start="6">
<li>We now have our application running on our embedded Tomcat server. If you go to <kbd>http://localhost:8080</kbd>, you will see an error as follows:</li>
</ol>
<div><img height="201" width="574" src="img/bd86b250-5fad-4cdc-9d99-b170c8afb2ef.png"/></div>
<ol start="7">
<li>The preceding error is <kbd>404 error</kbd> and the reason for that is we haven't told our application to do anything when a user is on the <kbd>/</kbd> path.</li>
</ol>


            

            
        
    </div>



  
<div><h1 class="header-title">How to create a REST controller</h1>
                
            
            
                
<p>In the previous recipe, we learned how to set up dependencies for creating RESTful services. Finally, we launched our backend on the <kbd>http://localhost:8080</kbd> endpoint but got <kbd>404 error</kbd> as our application wasn't configured to handle requests at that path (<kbd>/</kbd>). We will start from that point and learn how to create a REST controller. Let's get started!</p>


            

            
        
    </div>



  
<div><h1 class="header-title">Getting ready</h1>
                
            
            
                
<p>We will be using IntelliJ IDE for coding purposes. For setting up of the environment, refer to the previous recipe. You can also find the source in the repository at <a href="https://gitlab.com/aanandshekharroy/kotlin-webservices">https://gitlab.com/aanandshekharroy/kotlin-webservices</a>.</p>


            

            
        
    </div>



  
<div><h1 class="header-title">How to do it…</h1>
                
            
            
                
<p>In this recipe, we will create a REST controller that will fetch us information about students in a college. We will be using an in-memory database using a list to keep things simple:</p>
<ol>
<li>Let's first create a <kbd>Student</kbd> class having a name and roll number properties:</li>
</ol>
<pre style="padding-left: 60px">package college<br/><br/>class Student() {<br/>    lateinit var roll_number: String<br/>    lateinit var name: String<br/>    constructor(<br/>            roll_number: String,<br/>            name: String): this() {<br/>        this.roll_number = roll_number<br/>        this.name = name<br/>    }<br/>}</pre>
<ol start="2">
<li>Next, we will create the <kbd>StudentDatabase</kbd> endpoint, which will act as a database for the application:</li>
</ol>
<pre style="padding-left: 60px">@Component<br/>class StudentDatabase {<br/>    private val students = mutableListOf&lt;Student&gt;()<br/>}</pre>
<p style="padding-left: 60px">Note that we have annotated the <kbd>StudentDatabase</kbd> class with <kbd>@Component</kbd>, which means its lifecycle will be controlled by Spring (because we want it to act as a database for our application).</p>
<ol start="3">
<li>We also need a <kbd>@PostConstruct</kbd> annotation, because it's an in-memory database that is destroyed when the application closes. So we would like to have a filled database whenever the application launches. So we will create an <kbd>init</kbd> method, which will add a few items into the "database" at startup time:</li>
</ol>
<pre style="padding-left: 60px">@PostConstruct<br/>private fun init() {<br/>    students.add(Student("2013001","Aanand Shekhar Roy"))<br/>    students.add(Student("2013165","Rashi Karanpuria"))<br/>}</pre>
<ol start="4">
<li>Now, we will create a few other methods that will help us deal with our database:
<ul>
<li><kbd>getStudent</kbd>: Gets the list of students present in our database:</li>
</ul>
</li>
</ol>
<pre style="padding-left: 120px">fun getStudents()=students</pre>
<ol start="4">
<li style="list-style-type: none">
<ul>
<li><kbd>addStudent</kbd>: This method will add a student to our database:</li>
</ul>
</li>
</ol>
<pre style="padding-left: 120px">fun addStudent(student: Student): Boolean {<br/>    students.add(student)<br/>    return true<br/>}</pre>
<ol start="5">
<li>Now let's put this database to use. We will be creating a REST controller that will handle the request. We will create a <kbd>StudentController</kbd> and annotate it with <kbd>@RestController</kbd>. Using <kbd>@RestController</kbd> is simple, and it's the preferred method for creating MVC RESTful web services.</li>
<li>Once created, we need to provide our database using Spring dependency injection, for which we will need the <kbd>@Autowired</kbd> annotation. Here's how our <kbd>StudentController</kbd> looks:</li>
</ol>
<pre style="padding-left: 60px">@RestController<br/>class StudentController {<br/>    @Autowired<br/>    private lateinit var database: StudentDatabase<br/>}</pre>
<ol start="7">
<li>Now we will set our response to the <kbd>/</kbd> path. We will show the list of students in our database. For that, we will simply create a method that lists out students. We will need to annotate it with <kbd>@RequestMapping</kbd> and provide parameters such as path and request method (GET, POST, and such):</li>
</ol>
<pre style="padding-left: 60px">@RequestMapping("", method = arrayOf(RequestMethod.GET))<br/>fun students() = database.getStudents()</pre>
<ol start="8">
<li>This is what our controller looks like now. It is a simple REST controller:</li>
</ol>
<pre style="padding-left: 60px">package college<br/><br/>import org.springframework.beans.factory.annotation.Autowired<br/>import org.springframework.web.bind.annotation.RequestMapping<br/>import org.springframework.web.bind.annotation.RequestMethod<br/>import org.springframework.web.bind.annotation.RestController<br/><br/>@RestController<br/>class StudentController {<br/>    @Autowired<br/>    private lateinit var database: StudentDatabase<br/>    @RequestMapping("", method = arrayOf(RequestMethod.GET))<br/>    fun students() = database.getStudents()<br/>}</pre>
<ol start="9">
<li>Now when you restart the server and go to <kbd>http://localhost:8080</kbd>, we will see the response as follows:</li>
</ol>
<div><img src="img/f417be77-a4ee-4c73-ae61-a89f24570f3f.png" width="911" height="141"/></div>
<p style="padding-left: 60px">As you can see, Spring is intelligent enough to provide the response in the JSON format, which makes it easy to design APIs.</p>
<ol start="10">
<li>Now let's try to create another endpoint that will fetch a student's details from a roll number:</li>
</ol>
<pre style="padding-left: 60px">@GetMapping("/student/{roll_number}")<br/>fun studentWithRollNumber( @PathVariable("roll_number")  roll_number:String) =<br/>    database.getStudentWithRollNumber(roll_number)</pre>
<ol start="11">
<li>Now, if you try the <kbd>http://localhost:8080/student/2013001</kbd> endpoint, you will see the given output:</li>
</ol>
<pre style="padding-left: 60px">{"roll_number":"2013001","name":"Aanand Shekhar Roy"}</pre>
<ol start="12">
<li>Next, we will try to add a student to the database. We will be doing it via the <kbd>POST</kbd> method:</li>
</ol>
<pre style="padding-left: 60px">@RequestMapping("/add", method = arrayOf(RequestMethod.POST))<br/>fun addStudent(@RequestBody student: Student) =<br/>        if (database.addStudent(student)) student<br/>        else throw Exception("Something went wrong")</pre>


            

            
        
    </div>



  
<div><h1 class="header-title">There's more…</h1>
                
            
            
                
<p>So far, our server has been dependent on IDE. We would definitely want to make it independent of IDE. Thanks to Gradle, it is very easy to create a runnable JAR just with the following:</p>
<pre class="graf graf--pre graf-after--p"><strong>./gradlew clean bootRepackage</strong></pre>
<p>The preceding command is platform independent and uses the Gradle build system to build the application. Now, you just need to type the mentioned command to run it:</p>
<pre><strong>java -jar build/libs/gs-rest-service-0.1.0.jar</strong> </pre>
<p>You can then see the following output as before:</p>
<pre><strong>Started AppKt in 4.858 seconds (JVM running for 5.548)</strong></pre>
<p>This means your server is running successfully.</p>


            

            
        
    </div>



  
<div><h1 class="header-title">Creating the Application class for Spring Boot</h1>
                
            
            
                
<p>The <kbd>SpringApplication</kbd> class is used to bootstrap our application. We've used it in the previous recipes; we will see how to create the <kbd>Application</kbd> class for Spring Boot in this recipe.</p>


            

            
        
    </div>



  
<div><h1 class="header-title">Getting ready</h1>
                
            
            
                
<p>We will be using IntelliJ IDE for coding purposes. To set up the environment, read previous recipes, especially the <em>Setting up dependencies for building RESTful services</em> recipe.</p>


            

            
        
    </div>



  
<div><h1 class="header-title">How to do it…</h1>
                
            
            
                
<p>If you've used Spring Boot before, you must be familiar with using <kbd>@Configuration</kbd>, <kbd>@EnableAutoConfiguration</kbd>, and <kbd>@ComponentScan</kbd> in your main class. These were used so frequently that Spring Boot provides a convenient <kbd>@SpringBootApplication</kbd> alternative. The Spring Boot looks for the <kbd>public static main</kbd> method, and we will use a top-level function outside the <kbd>Application</kbd> class.</p>
<p>If you noted, while setting up the dependencies, we used the <kbd>kotlin-spring</kbd> plugin, hence we don't need to make the <kbd>Application</kbd> class open.</p>
<p>Here's an example of the Spring Boot application:</p>
<pre>package college<br/><br/>import org.springframework.boot.SpringApplication<br/>import org.springframework.boot.autoconfigure.SpringBootApplication<br/><br/>@SpringBootApplication<br/>class Application<br/>fun main(args: Array&lt;String&gt;) {<br/>    SpringApplication.run(Application::class.java, *args)<br/>}<br/><br/></pre>
<p>The Spring Boot application executes the static <kbd>run()</kbd> method, which takes two parameters and starts a autoconfigured Tomcat web server when Spring application is started.</p>
<p>When everything is set, you can start the application by executing the following command:</p>
<pre><strong>./gradlew bootRun</strong></pre>
<p>If everything goes well, you will see the following output in the console:</p>
<p>&gt;<img src="img/d852f79e-749c-48ab-9873-4996248437f0.png" width="1297" height="666"/></p>
<p>This is along with the last message—Started AppKt in xxx seconds. This means that your application is up and running.</p>
<p>In order to run it as an independent server, you need to create a JAR and then you can execute as follows:</p>
<pre class="graf graf--pre graf-after--p"><strong>./gradlew clean bootRepackage</strong></pre>
<p>Now, to run it, you just need to type the following command:</p>
<pre><strong>java -jar build/libs/gs-rest-service-0.1.0.jar</strong> </pre>


            

            
        
    </div>



  </body></html>