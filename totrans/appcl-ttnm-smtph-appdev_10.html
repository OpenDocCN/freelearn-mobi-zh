<html><head></head><body><div><div><div><div><h1 class="title"><a id="ch10"/>Chapter 10. Extending your Apps With Custom Modules</h1></div></div></div><p>In this chapter, we will cover:</p><div><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">Integrating an existing module—the PayPal Mobile Payment Library</li><li class="listitem" style="list-style-type: disc">Preparing your iOS module development environment</li><li class="listitem" style="list-style-type: disc">Developing a new iPhone module using XCode</li><li class="listitem" style="list-style-type: disc">Creating a public API method</li><li class="listitem" style="list-style-type: disc">Packaging and testing your module using the test harness</li><li class="listitem" style="list-style-type: disc">Packaging your module for distribution and sale</li></ul></div><div><div><div><div><h1 class="title"><a id="ch10lvl1sec01"/>Introduction</h1></div></div></div><p>While Titanium allows you to create apps that are almost cross-platform, it is inevitable that some devices will inherently have operating system and hardware differences that are specific to them (particularly between Android and iOS). For example, anyone who has used both Android and iPhone devices would immediately recognize the very different way the notification systems are set up. However, there are other platform-specific limitations that are very specific to the Titanium API.<a id="id356" class="indexterm"/>
</p><p>In this chapter, we will be discussing both building and integrating modules into your Titanium applications, using the iOS platform as an example. The methods of developing Android modules using Java are very similar, however, for our purposes, we will just be concentrating on developing modules for iOS using Objective-C and XCode.</p></div></div>
<div><div><div><div><h1 class="title"><a id="ch10lvl1sec02"/>Integrating an existing module—the PayPal Mobile Payment Library</h1></div></div></div><p>There are already a number of modules written for the Titanium platform, both by Appcelerator themselves and by the community at large. There is even a brand new Open Mobile Marketplace where you can buy (and sell) modules to extend the platform to even newer and greater heights!<a id="id357" class="indexterm"/>
</p><div><div><div><div><h2 class="title"><a id="ch10lvl2sec01"/>Getting ready</h2></div></div></div><p>You will first need to sign up for the Titanium + Commerce program before you can download and use the PayPal Mobile Payment Library. You can do this for free at<a class="ulink" href="http://www.appcelerator.com/products/titaniumcommerce/"> http://www.appcelerator.com/products/titaniumcommerce/</a>. Once you have filled in the required form, simply download the ZIP file titled Titanium+Commerce MPL for Paypal Module for iOS to your computer's hard drive.<a id="id358" class="indexterm"/>
</p><p>You must also register your application with PayPal, and on doing so you will be provided with an Application ID that you must reference inside your Titanium project. You can register for an Application ID from<a class="ulink" href="http://www.paypal.com"> http://www.paypal.com</a>. Note that the registration of an Application ID also requires you to be a PayPal member, so you may be required to sign up first if you have not already done so in the past.</p><div><h3 class="title"><a id="note67"/>Note</h3><p>The complete source code for this recipe can be found in the<code class="literal"> /Chapter 10/Recipe 1</code> folder.</p></div></div><div><div><div><div><h2 class="title"><a id="ch10lvl2sec02"/>How to do it…</h2></div></div></div><p>First, you'll need to copy the Paypal module files to the<code class="literal"> modules</code> folder under your Titanium installation. On OSX, this is normally located at<code class="literal"> /Library/Application Support/Titanium/modules</code>. There should already be a subfolder under modules called "iphone". If there is not, create one now, then unzip the module file so that you end up with a<code class="literal"> ti.paypal</code> folder, located at<code class="literal"> /Library/Application Support/Titanium/modules/iphone/ti.paypal</code>. Take a quick look inside that folder. You should immediately notice that the first subfolder underneath it is named "1.0" or possibly "1.2". This is the version number of the module you just installed. Pay careful attention to note it down as this will be important later on.<a id="id359" class="indexterm"/>
</p><p>Once that is completed, the<code class="literal"> tiapp.xml</code> file for your project needs to be edited so that the modules section includes our<code class="literal"> ti.paypal</code> module. This reference tells the Titanium Studio compiler to add in the module when your project is built. Extend the<code class="literal"> tiapp.xml</code> file by adding the following lines underneath the "guid" element. Make sure the module version number matches the version number of the<code class="literal"> ti.paypal</code> library you just installed.</p><div><pre class="programlisting">&lt;modules&gt;
&lt;module version="1.0"&gt;ti.paypal&lt;/module&gt;
&lt;/modules&gt;
</pre></div><p>Now back in your<code class="literal"> app.js</code> file, we need to include the module reference at the top of the JavaScript like so:</p><div><pre class="programlisting">Ti.Paypal = require('ti.paypal');
</pre></div><p>We can now use this new variable object to create a PayPal payment button object and add it to our window. The PayPal library also includes a number of event listeners to handle payment success, error, and cancellation events. Here is a sample of how you could use the PayPal library to take a payment donation for the American Red Cross, taken from the Appcelerator KitchenSink sample:</p><div><pre class="programlisting">var ppButton = Ti.Paypal.createPaypalButton({
width: 294,
height: 50,
bottom: 50,
appId: "YOUR_PAYPAL_APP_ID",
buttonStyle: Ti.Paypal.BUTTON_294x43,
paypalEnvironment: Ti.Paypal.PAYPAL_ENV_SANDBOX,
feePaidByReceiver: false,
transactionType: Ti.Paypal.PAYMENT_TYPE_DONATION,
enableShipping: false,
payment: {
amount: win.data.amt,
tax: 0.00,
shipping: 0.00,
currency: "USD",
recipient: "osama@x.com",
itemDescription: "Donation",
merchantName: "American Red Cross"
}
});
ppButton.addEventListener("paymentCanceled", function(e){
Ti.API.info("Payment Canceled");
});
ppButton.addEventListener("paymentSuccess", function(e){
Ti.API.info("Success");
win.fireEvent("completeEvent", {data: win.data, transid: e.transactionID});
});
ppButton.addEventListener("paymentError", function(e){
Ti.API.info("Payment Error");
});
</pre></div><p>If you have installed the module correctly and updated your<code class="literal"> tiapp.xml</code> file correctly, you should see a message saying "Detected third-party module: [Module Name]/[Module Version]". In our case, this will say that it has detected the<code class="literal"> ti.paypal</code> module.<a id="id360" class="indexterm"/>
</p><p>The following is an example of the Red Cross app running and using the PayPal module for Titanium. This sample code is available as part of this recipe.</p><div><img src="img/3868_10_01.jpg" alt="How to do it…"/></div></div><div><div><div><div><h2 class="title"><a id="ch10lvl2sec03"/>How it works…</h2></div></div></div><p>Once your module has been copied to the modules directory and referenced in the<code class="literal"> tiapp.xml</code>, you can use it just like any other piece of native Titanium JavaScript. All of the modules public methods and properties have been made available to you by the module's developer.<a id="id361" class="indexterm"/>
</p><p>More specifically to our PayPal module, once the buyer clicks on the "Paypal" purchase button in your app, the Payment checkout process is shown. Whenever an important event occurs (for example, payment success), these events are thrown and caught by Titanium using the event handlers below. Your application needs to incorporate these three handlers:</p><div><pre class="programlisting">ppButton.addEventListener("paymentCanceled", function(e){
Titanium.API.info("Payment Canceled");
});
ppButton.addEventListener("paymentSuccess", function(e){
Titanium.API.info("Payment Success. TransactionID: " +
e.transactionID);
});
ppButton.addEventListener("paymentError", function(e){
Titanium.API.info("Payment Error");
Titanium.API.info("errorCode: " + e.errorCode);
Titanium.API.info("errorMessage: " + e.errorMessage);
});
</pre></div><p>When a payment has been successfully transmitted, a transaction ID will be returned to your "paymentSuccess" event listener. It should be noted that in this example we are using the Paypal Sandbox (Testing) environment, and for a live app you would need to change the<code class="literal"> paypalEnvironment</code> variable to<code class="literal"> Ti.PayPal.PAYPAL_ENV_LIVE</code>. In the sandbox environment, no actual money is transferred.</p></div><div><div><div><div><h2 class="title"><a id="ch10lvl2sec04"/>There's more…</h2></div></div></div><p>Try experimenting with the different properties made available to you in the PayPal module. Here's a list of the most useful properties and their constant values:</p><div><table border="1"><colgroup><col style="text-align: left"/><col style="text-align: left"/></colgroup><tbody><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">buttonStyle</code>
</p>
</td><td style="text-align: left" valign="top">
<p>Size and appearance of the PayPal button, the available values are:</p>
<p>Titanium.Paypal.BUTTON_68x24</p>
<p>Titanium.Paypal.BUTTON_118x24</p>
<p>Titanium.Paypal.BUTTON_152x33</p>
<p>Titanium.Paypal.BUTTON_194x37</p>
<p>Titanium.Paypal.BUTTON_278x43</p>
<p>Titanium.Paypal.BUTTON_294x43</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">paypalEnvironment</code>
</p>
</td><td style="text-align: left" valign="top">
<p>Available values are:</p>
<p>Titanium.Paypal.PAYPAL_ENV_LIVE</p>
<p>Titanium.Paypal.PAYPAL_ENV_SANDBOX</p>
<p>Titanium.Paypal.PAYPAL_ENV_NONE</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">feePaidByReceiver</code>
</p>
</td><td style="text-align: left" valign="top">
<p>This will only be applied when the transaction type is Personal.</p>
<p>Available values are:</p>
<p>true</p>
<p>false</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">transactionType</code>
</p>
</td><td style="text-align: left" valign="top">
<p>The type of payment being made (what the payment is for).</p>
<p>Available values are:</p>
<p>Titanium.Paypal.PAYMENT_TYPE_HARD_GOODS</p>
<p>Titanium.Paypal.PAYMENT_TYPE_DONATION</p>
<p>Titanium.Paypal.PAYMENT_TYPE_PERSONAL</p>
<p>Titanium.Paypal.PAYMENT_TYPE_SERVICE</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">enableShipping</code>
</p>
</td><td style="text-align: left" valign="top">
<p>Whether or not to select/send shipping information.</p>
<p>Available values are:</p>
<p>true</p>
<p>false</p>
</td></tr></tbody></table></div></div></div>
<div><div><div><div><h1 class="title"><a id="ch10lvl1sec03"/>Preparing your iOS module development environment</h1></div></div></div><p>Before you can start to develop your own custom iOS modules, you will first need to set up your environment correctly. This involves setting up an alias to the<code class="literal"> titanium.py</code> script in your Titanium SDK path.<a id="id362" class="indexterm"/>
</p><div><div><div><div><h2 class="title"><a id="ch10lvl2sec05"/>Getting ready</h2></div></div></div><p>The following instructions are for Mac OSX only. It is possible to develop Android modules on Linux and Windows, as well as OSX. However, for this recipe, we will be concentrating on iOS module development, which requires an Apple Mac, running OSX 10.5, or above.</p></div><div><div><div><div><h2 class="title"><a id="ch10lvl2sec06"/>How to do it…</h2></div></div></div><div><ol class="orderedlist"><li class="listitem">Open the<strong> Terminal</strong> application, which you will find under<strong> Applications</strong> |<strong> Utilities</strong> |<strong> Terminal</strong>.</li><li class="listitem">Type in<code class="literal"> cd $HOME</code> and press<em> Enter</em>.</li><li class="listitem">Type in<code class="literal"> vi .bash_profile</code> and press<em> Enter</em>. If you have not created a<code class="literal"> bash_profile</code> before, then you will be creating a new file now, otherwise it will load your existing<code class="literal"> bash_profile</code> script.</li><li class="listitem">Add the following line to your script: "<code class="literal">alias titanium='/Library/Application\ Support/Titanium/mobilesdk/osx/1.7.2/titanium.py'</code>"—where 1.7.2 is the latest version of the Titanium SDK you currently have installed. Pay careful attention and ensure your Titanium SDK path is correct and the path location is surrounded by single quotation characters.</li><li class="listitem">Save the file by pressing the<em> Esc</em> key, and then type "<code class="literal">:wq</code>". This will save your file and then exit the editor.</li><li class="listitem">Back in Terminal, type "<code class="literal">source ~/.bash_profile</code>" and press<em> Enter</em>.</li><li class="listitem">Now type in "<code class="literal">titanium</code>" and press<em> Enter</em>. If you have set up the script correctly, you will see an output from Appcelerator in your Terminal window like the one seen in the following screenshot.</li><li class="listitem">Leave the Terminal window open since it will be required in the next recipes:</li></ol></div><div><img src="img/3968_10_02.jpg" alt="How to do it…"/></div><p>To test that your environment is now set up correctly, type the following into the Terminal window:<a id="id363" class="indexterm"/>
</p><div><pre class="programlisting">titanium create --platform=iphone --type=module --dir=~/tmp --name=test --id=com.packtpub.testmodule
</pre></div><p>If everything has worked, you will see the following output in the Terminal window. You can verify the files this script created by navigating to the<code class="literal"> /tmp/test</code> directory under finder (note that the<code class="literal"> tmp</code> directory will be under your user accounts<code class="literal"> Home</code> folder).</p><div><img src="img/3968_10_03.jpg" alt="How to do it…"/></div></div><div><div><div><div><h2 class="title"><a id="ch10lvl2sec07"/>How it works…</h2></div></div></div><p>Essentially, all we are doing here is setting a way to execute Titanium scripts from the console using an alias. This means we can use simple commands such as "titanium create" instead of attempting to do the same thing manually by executing long-winded commands in the Terminal.</p></div></div>
<div><div><div><div><h1 class="title"><a id="ch10lvl1sec04"/>Developing a new iPhone module using XCode</h1></div></div></div><p>Developing our own custom modules for Titanium allows us to leverage native code and make Titanium do things that it otherwise couldn't, or at least doesn't currently do. For this recipe, we are going to develop a small module that uses<code class="literal"> Bit.ly</code> to shorten a long URL. You can use this module in any of your iOS apps whenever you need to create a short URL (such as when posting a link to Twitter!).<a id="id364" class="indexterm"/>
</p><div><div><div><div><h2 class="title"><a id="ch10lvl2sec08"/>Getting ready</h2></div></div></div><p>You will first need to have set up your Mac using the steps described in the previous recipe. Make sure you follow the steps and that your system is set up correctly, as this recipe relies heavily on those scripts working. You will also need some working knowledge of Objective-C for this recipe. This book doesn't try to teach Objective-C in any way as, there are plenty of weighty tomes for that already. However, you should, be able to follow along with the code in this recipe to get our sample module working.</p></div><div><div><div><div><h2 class="title"><a id="ch10lvl2sec09"/>How to do it…</h2></div></div></div><p>To begin, let's create the basic module using the same script we used in the previous recipe. In the Terminal window, type the following (substituting the<code class="literal"> /Projects</code> directory for whichever directory you wish to create your module in):</p><div><pre class="programlisting">titanium create --platform=iphone --type=module --dir=~/Projects --name=BitlyModule --id=com.packtpub.BitlyModule
</pre></div><p>Now open the<code class="literal"> /Projects/BitlyModule</code> directory in Finder, and what you will see is a list of mostly standard looking XCode project files. Double click the<code class="literal"> BitlyModule.xcodeproj</code> file to open it up in XCode for editing.</p></div><div><div><div><div><h2 class="title"><a id="ch10lvl2sec10"/>How it works…</h2></div></div></div><p>The following information comes straight from the Appcelerator guide (available at<a class="ulink" href="http://wiki.appcelerator.org/display/guides/Module+Developer+Guide+for+iOS)"> http://wiki.appcelerator.org/display/guides/Module+Developer+Guide+for+iOS)</a> and is a good introduction to understanding the architecture of a Titanium module.<a id="id365" class="indexterm"/>
</p><p>The Module architecture contains the following key interface components:<a id="id366" class="indexterm"/>
</p><div><ol class="orderedlist"><li class="listitem"><strong> Proxy:</strong> A base class that represents the native binding between your JavaScript code and native code.<a id="id367" class="indexterm"/></li><li class="listitem"><strong> ViewProxy:</strong> A specialized Proxy that knows how to render Views.<a id="id368" class="indexterm"/></li><li class="listitem"><strong> View:</strong> The visual representation of a UI component that Titanium can render.<a id="id369" class="indexterm"/></li><li class="listitem"><strong> Module:</strong> A special type of Proxy that describes a specific API set, or namespace.<a id="id370" class="indexterm"/></li></ol></div><p>When building a Module, you can only have one Module class but you can have zero or more Proxies, Views, and<code class="literal"> ViewProxies</code>.</p><p>For each<code class="literal"> View</code>, you will need a<code class="literal"> ViewProxy</code>. The<code class="literal"> ViewProxy</code> represents the model data (which is kept inside the proxy itself in case the View needs to be released) and is responsible for exposing the APIs and events that the View supports.</p><p>You create a Proxy when you want to return non-visual data between JavaScript and native. The Proxy knows how to handle any method and property dispatching and event firing.</p></div></div>
<div><div><div><div><h1 class="title"><a id="ch10lvl1sec05"/>Creating a public API method</h1></div></div></div><p>The sample module code that Titanium creates as part of its module create process already provides us with a sample of a public method. We are going to create our own though which accepts a single string input value (the "long" URL) and then processes the short URL via the<code class="literal"> Bit.ly</code> API before returning it to our Titanium app.<a id="id371" class="indexterm"/>
</p><div><div><div><div><h2 class="title"><a id="ch10lvl2sec11"/>Getting ready</h2></div></div></div><p>Before you can use the module, you'll need to sign up for a Bitly API Key, which you can do for free at:<a class="ulink" href="http://https://bitly.com/a/sign_up?rd=/a/your_api_key"> https://bitly.com/a/sign_up?rd=/a/your_api_key</a>.</p><p>Additionally, we're going to need the open source SBJSON framework for Objective-C, which is capable of natively reading and writing JSON formatted data streams. You can download the SBJSON framework from<a class="ulink" href="http://https://github.com/stig/json-framework/"> https://github.com/stig/json-framework/</a>.</p><div><h3 class="title"><a id="note68"/>Note</h3><p>The complete source code for this recipe can be found in the<code class="literal"> /Chapter 10/Recipe 4</code> folder.</p></div></div><div><div><div><div><h2 class="title"><a id="ch10lvl2sec12"/>How to do it…</h2></div></div></div><p>First, unzip the SBJSON framework, and drag all of the files from the<code class="literal"> Classes</code> folder in Finder to the<code class="literal"> Classes</code> folder in your module's XCode project.</p><p>Open up<code class="literal"> ComPacktpubBitlyModuleModule.h</code> and ensure it looks like the following (ignoring the header comments at the top of the file):</p><div><pre class="programlisting">#import "TiModule.h"
#import &lt;Foundation/Foundation.h&gt;
@interface ComPacktpubBitlyModuleModule : TiModule
{
}
@end
</pre></div><p>Now open the<code class="literal"> ComPacktpubBitlyModuleModule.m</code> file and ensure it looks like the following source code (ignoring the header comments at the top of the file). Remember to replace the<code class="literal"> login</code> and<code class="literal"> key</code> values in the<code class="literal"> QueryString</code> section of the URL with those you were assigned by the<code class="literal"> Bit.ly</code> API:<a id="id372" class="indexterm"/>
</p><div><pre class="programlisting">#import "ComPacktpubBitlyModuleModule.h"
#import "TiBase.h"
#import "TiHost.h"
#import "TiUtils.h"
#import "SBJson.h"
#import "SBJsonParser.h"
@implementation ComPacktpubBitlyModuleModule
#pragma mark Internal
// this is generated for your module, please do not change it
-(id)moduleGUID
{
return @"a33e440e-ef62-4ec7-89cd-8939d264e46e";
}
// this is generated for your module, please do not change it
-(NSString*)moduleId
{
return @"com.packtpub.BitlyModule";
}
#pragma mark Lifecycle
-(void)startup
{
// this method is called when the module is first loaded
// you *must* call the superclass
[super startup];
NSLog(@"[INFO] %@ loaded",self);
}
-(void)shutdown:(id)sender
{
// this method is called when the module is being unloaded
// typically this is during shutdown. make sure you don't
do too
// much processing here or the app will be quit forceably
// you *must* call the superclass
[super shutdown:sender];
}
#pragma mark Cleanup
-(void)dealloc
{
// release any resources that have been retained by the module
[super dealloc];
}
#pragma mark Internal Memory Management
-(void)didReceiveMemoryWarning:(NSNotification*)notification
{
// optionally release any resources that can be dynamically
// reloaded once memory is available - such as caches
[super didReceiveMemoryWarning:notification];
}
#pragma mark Listener Notifications
-(void)_listenerAdded:(NSString *)type count:(int)count
{
if (count == 1 &amp;&amp; [type isEqualToString:@"my_event"])
{
// the first (of potentially many) listener is being added
// for event named 'my_event'
}
}
-(void)_listenerRemoved:(NSString *)type count:(int)count
{
if (count == 0 &amp;&amp; [type isEqualToString:@"my_event"])
{
// the last listener called for event named 'my_event' has
// been removed, we can optionally clean up any resources
// since no body is listening at this point for that event
}
}
#pragma Public APIs
-(id)example:(id)args
{
// example method
return @"hello world";
}
///creates the short url from bitly
- (id)getShortUrl:(id)value
{
NSString *baseURLString = @"http://api.bit.ly/shorten?version=2.0.1&amp;longUrl=";
NSString *longUrl = [TiUtils stringValue:value];
longUrl = [longUrl stringByReplacingOccurrencesOfString:@"("
withString:@""];
longUrl = [longUrl stringByReplacingOccurrencesOfString:@—)—
withString:@""];
longUrl = [longUrl stringByReplacingOccurrencesOfString:@"\""
withString:@""];
longUrl = [longUrl
stringByTrimmingCharactersInSet:[NSCharacterSet
whitespaceAndNewlineCharacterSet]];
baseURLString = [baseURLString
stringByAppendingString:longUrl];
baseURLString = [baseURLString
stringByAppendingString:
@"&amp;login=REPLACE_YOUR_LOGIN&amp;apiKey=REPLACE_YOUR_KEY"];
NSURL* baseURL = [[NSURL alloc]
initWithString:baseURLString];
NSMutableURLRequest *req = [[NSMutableURLRequest alloc]
initWithURL:baseURL];
NSHTTPURLResponse* urlResponse = nil;
NSError *error = [[[NSError alloc] init] autorelease];
NSData *data = [NSURLConnection sendSynchronousRequest:req
returningResponse:&amp;urlResponse error:&amp;error];
if ([urlResponse statusCode] &gt;= 200 &amp;&amp; [urlResponse
statusCode] &lt; 300)
{
NSLog(@"Got a response from bit.ly");
SBJsonParser* jsonParser = [SBJsonParser new];
NSString* jsonString = [[NSString alloc]
initWithData:data encoding:NSUTF8StringEncoding];
NSDictionary* dict = (NSDictionary*)[jsonParser
objectWithString:jsonString];
[jsonString release];
[jsonParser release];
NSString *statusCode = [dict
objectForKey:@"statusCode"];
if([statusCode isEqualToString:@"OK"])
{
// retrieve shortURL from results
NSLog([dict description]);
NSString *shortURL = [[[dict
objectForKey:@"results"]
objectForKey:longUrl]
objectForKey:@"shortUrl"];
return shortURL;
}
else
{
return @"Unable to shorten this URL,
please check its format.";
}
}
return baseURLString;
}
@end
</pre></div></div><div><div><div><div><h2 class="title"><a id="ch10lvl2sec13"/>How it works…</h2></div></div></div><p>The main function here is the one we created, called<code class="literal"> getShortUrl</code>. All other methods and properties for the module have been auto-generated for us by the Titanium module creation scripts. This method, in short, executes a request against the<code class="literal"> Bit.ly</code> API using our key and username, and when a response is received, it is parsed using the SBJSON parser. The resulting<code class="literal"> shortURL</code> variable (of type<code class="literal"> NSString)</code> is then pulled out of the shortURL element of the JSON result, and returned back to Titanium.<a id="id373" class="indexterm"/>
</p><p>What we want to concentrate on here is the integration of the Titanium public method, and how the "value" argument is translated. Here we're using the<code class="literal"> (id)</code> declaration, which allows us to easily typecast the incoming value to a parameter type that Objective-C understands. In this case, we are typecasting the "value" parameter to a type of<code class="literal"> NSString</code>, as we know the incoming parameter is going to be a string value in the format of a web address. This conversion process is thanks to<strong> TiUtils</strong>, which we've imported at the top of our file using the<code class="literal"> #import "TiUtils.h"</code> command.<a id="id374" class="indexterm"/>
</p><p>Some of the most common conversion examples are:</p><div><pre class="programlisting">CGFloat f = [TiUtils floatValue:arg];
NSInteger f = [TiUtils intValue:arg];
NSString *value = [TiUtils stringValue:arg];
NSString *value = [TiUtils stringValue:@"key" properties:dict def:@"default"];
TiColor *bgcolor = [TiUtils colorValue:arg];
</pre></div><p>We are also returning a string value which is either an error message (if the<code class="literal"> Bit.Ly</code> conversion process failed) or, hopefully, the new short URL that<code class="literal"> Bit.Ly</code> has kindly provided us. As we are returning a string, we don't need to perform a conversion before returning the parameter.</p><p>The following types can be returned without the need for typecasting:</p><div><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><code class="literal">NSString</code></li><li class="listitem" style="list-style-type: disc"><code class="literal">NSDictionary</code></li><li class="listitem" style="list-style-type: disc"><code class="literal">NSArray</code></li><li class="listitem" style="list-style-type: disc"><code class="literal">NSNumber</code></li><li class="listitem" style="list-style-type: disc"><code class="literal">NSDate</code></li><li class="listitem" style="list-style-type: disc"><code class="literal">NSNull</code></li></ul></div></div></div>
<div><div><div><div><h1 class="title"><a id="ch10lvl1sec06"/>Packaging and testing your module using the test harness</h1></div></div></div><p>Now it's time to build, package, and test our new module! Before you go ahead with this recipe, make sure you've built the XCode project and it has been successful. If not, you will need to fix any errors before continuing.</p><div><h3 class="title"><a id="note69"/>Note</h3><p>The complete source code for this recipe can be found in the<code class="literal"> /Chapter 10/Recipe 5</code> folder.</p></div><div><div><div><div><h2 class="title"><a id="ch10lvl2sec14"/>How to do it…</h2></div></div></div><p>Open up the<code class="literal"> app.js</code> example file for our module, you'll find it within the<code class="literal"> example</code> directory of your module project. Replace the existing sample contents with the following source code:<a id="id375" class="indexterm"/>
</p><div><pre class="programlisting">// This is a test harness for your module
// You should do something interesting in this harness
// to test out the module and to provide instructions
// to users on how to use it by example.
// write your module tests here
var bitlymodule = require('com.packtpub.BitlyModule');
Ti.API.info("module is =&gt; " + bitlymodule);
// open a single window
var window = Ti.UI.createWindow({
backgroundColor:'white'
});
var txtLongUrl = Ti.UI.createTextField({
top: 10,
left: 10,
width: 300,
height: 30,
borderStyle: 1,
hintText: 'Enter your long url...'
});
window.add(txtLongUrl);
var btnShorten = Ti.UI.createButton({
title: 'Shorten it with Bit.ly!',
width: 200,
right: 10,
height: 30,
top: 50
});
btnShorten.addEventListener('click', function(e){
var result = bitlymodule.getShortUrl(txtLongUrl.value);
txtShortUrl.value = result;
});
window.add(btnShorten);
var txtShortUrl = Ti.UI.createTextField({
top: 100,
left: 10,
width: 300,
height: 30,
borderStyle: 1,
hintText: 'Your short url appears here...'
});
window.add(txtShortUrl);
window.open();
</pre></div><p>Now, back in the Terminal, change directory so that you are in your<code class="literal"> BitLyModule</code> directory (assuming you still have the Terminal window open from a previous recipe, you should already be there).</p><p>Type<code class="literal"> ./build.py</code> into the Terminal, and press<em> Enter</em> to execute the command. When it completes, type<code class="literal"> titanium run</code> and press<em> Enter</em>. If all has gone well, you should see the iPhone simulator launch after 20 or 30 seconds, with our example Titanium application visible, which consists of two<code class="literal"> TextFields</code> and the<code class="literal"> BitLy</code> conversion button. Type a long URL into the first<code class="literal"> TextField</code> and press<strong> Shorten it with Bit.ly!</strong> as seen in the following screenshot:<a id="id376" class="indexterm"/>
</p><div><img src="img/3968_10_04.jpg" alt="How to do it…"/></div></div><div><div><div><div><h2 class="title"><a id="ch10lvl2sec15"/>How it works…</h2></div></div></div><p>Let's concentrate on the Titanium code used to build and launch our module via the example project. As you can see, one of the very first lines in our sample JavaScript is the following:</p><div><pre class="programlisting">var bitlymodule = require('com.packtpub.BitlyModule');
</pre></div><p>This code instantiates our module, and defines it as a new variable called<code class="literal"> bitlymodule</code>. We can then use our module just like any other regular Titanium control, by calling our own custom method, and returning the result before displaying it in the<code class="literal"> shortURL</code> text field:<a id="id377" class="indexterm"/>
</p><div><pre class="programlisting">var result = bitlymodule.getShortUrl(txtLongUrl.value);
txtShortUrl.value = result;
</pre></div></div></div>
<div><div><div><div><h1 class="title"><a id="ch10lvl1sec07"/>Packaging your module for distribution and sale</h1></div></div></div><p>Titanium modules are created in a way that allows for easy distribution and re-use, both in your own apps or the Titanium+Plus Marketplace. In this recipe, we will go through the steps required to package your module and then distribute it to the marketplace.</p><div><h3 class="title"><a id="note70"/>Note</h3><p>The complete source code for this chapter can be found in the<code class="literal"> /Chapter 10</code> folder, along with the compiled version of the<code class="literal"> Bit.Ly</code> module.</p></div><div><div><div><div><h2 class="title"><a id="ch10lvl2sec16"/>How to do it…</h2></div></div></div><p>The first requirement is to edit the manifest file that is automatically generated when you created your module. Below is an example taken from our<code class="literal"> BitlyModule:</code>
<a id="id378" class="indexterm"/>
</p><div><pre class="programlisting">version: 0.1
description: My module
author: Your Name
license: Specify your license
copyright: Copyright (c) 2011 by Your Company
# these should not be edited
name: bitlymodule
moduleid: com.packtpub.BitlyModule
guid: a33e440e-ef62-4ec7-89cd-8939d264e46e
platform: iphone
minsdk: 1.7.2
</pre></div><p>Anything below the<code class="literal"> # these should not be edited</code> line should be left alone, but go ahead and replace all of the other key/value pairs with your own name, description, license, version, and copyright text. Once you have completed editing the manifest file, rebuild your module using by typing<code class="literal"> ./build.py</code> into the Terminal, and press<em> Enter</em> to execute the command.</p><p>Your module is now ready for use in your own projects or for manual distribution. Simply copy the contents of the ZIP file to your copied into the<code class="literal"> /Library/Application/ Support/Titanium</code> directory for it to be installed. You will of course still need to include your module using the<code class="literal"> require</code> method call in your<code class="literal"> app.js</code> file, and you'll need to reference it in your<code class="literal"> tiapp.xml</code> file as you did in the first recipe of this chapter for the mobile PayPal library.</p><p>You can distribute your module to the Open Mobile Marketplace using the same ZIP file package that was created in the build process. However, there are several prerequisites you'll need to fulfill before you can distribute:</p><div><ol class="orderedlist"><li class="listitem">You must have a valid Titanium developer account.</li><li class="listitem">You must have fully completed filling our your manifest values.</li><li class="listitem">You must have a valid license text in the LICENSE file in your project.</li><li class="listitem">You must have a valid documentation file in the<code class="literal"> index.md</code> file in your documentation directory of your project.</li><li class="listitem">You must specify some additional metadata upon upload such as the price (which can be free).</li><li class="listitem">If you are charging for your module, you must establish a payment setup with Appcelerator so that you can be paid.</li><li class="listitem">You must accept the Titanium+Plus Marketplace terms of service agreement.</li></ol></div><p>Once you have uploaded your module and completed the necessary submission steps, your module will be made available to the marketplace directory. Note that the first time you submit a module Appcelerator will review your module for the basic requirements above.</p></div><div><div><div><div><h2 class="title"><a id="ch10lvl2sec17"/>How it works…</h2></div></div></div><p>The new Appcelerator marketplace makes it easy for developers to build, sell, and distribute their own custom Titanium modules, for both iOS and Android. All you need to do is set up a profile for your product and provide your PayPal account details in order to be paid for each sale you make.<a id="id379" class="indexterm"/>
</p><p>Developers make 70 percent of all products they sell through the Open Mobile Marketplace, and there are a number of tools available to keep track of your customers, invoices, and feedback. You can sign up today at<a class="ulink" href="http://https://marketplace.appcelerator.com/cms/landing"> https://marketplace.appcelerator.com/cms/landing</a>.</p></div></div></body></html>