<html><head></head><body><h1 id="e-XR2F">Chapter 4. Adding a List View</h1>
<p id="e-zJy9">In this chapter, we finally get to what many of you have been waiting for, developing the user interface. We will walk you through the activities related to creating and populating a <code>ListView</code>, which includes the following topics:</p>
<ul id="e-k6Nd">
<li id="e-aTRk">Creating the POIApp activity layout</li>
<li id="e-tEWA">Creating a custom list row item layout</li>
<li id="e-LGip">The <code>ListView</code> and <code>ListAdapter</code> classes</li>
<li id="e-Zxel">Extending <code>BaseAdapter</code> to provide data to the <code>ListView</code> widget</li>
<li id="e-O2dA">Working with web services in Xamarin.Android</li>
<li id="e-P9CN">Working with the <code>ActionBar</code> menu options</li>
<li id="e-fTNd">Handling list item click events</li>
<li id="e-TXAv">Handling the network state</li>
</ul>
<h1 id="e-AtXM">Creating the POI ListView layout</h1>
<p id="e-S3jK">It is technically possible to create and attach the user interface elements to your activity using C# code. However, it is a bit of a mess. We will go with the most common approach by declaring the XML-based layout. Keeping this in mind, let's begin this chapter by creating a layout to display the POI list items.</p>
<p id="e-XtPH">When we created the new <code>POIApp</code> solution in the previous chapter (Chapter 3, <em>Creating the Points Of Interest App</em>), a default layout and activity was created as part of the Xamarin Studio project template.</p>
<p id="e-J59j">Rather than deleting these files, let's give them more appropriate names and remove unnecessary content as follows:</p>
<ol id="e-AtRK">
<li id="e-A91n">Select the <code>Main.axml</code> file in <strong>Resources</strong> | <strong>Layout</strong> and rename it to <code>POIList.axml</code>.</li>
<li id="e-raKG">Double-click on the <code>POIList.axml</code> file to open it in a layout designer window.<p id="e-XIU7">Currently, the <code>POIList.axml</code> file contains the layout that was created as part of the default Xamarin Studio template. As per our requirement, we need to add a <code>ListView</code> widget that takes the complete screen width and a <code>ProgressBar</code> in the middle of the screen. The indeterminate progress bar will be displayed to the user while the data is being downloaded from the server. Once the download is complete and the data is ready, the indeterminate progress bar will be hidden before the POI data is rendered on the list view.</p>
</li>
<li id="e-G208">Now, open the <strong>Document Outline</strong> tab in the designer window and delete both the button and <code>LinearLayout</code>.</li>
<li id="e-lXpp">Now, in the designer <strong>Toolbox</strong>, search for <code>RelativeLayout</code> and drag it onto the designer layout preview window.</li>
<li id="e-z7ns">Search for <code>ListView</code> in the <strong>Toolbox</strong> search field and drag it over the layout designer preview window. Alternatively, you can drag and drop it over <code>RelativeLayout</code> in the <strong>Document Outline</strong> tab.</li>
</ol>
<p id="e-Ft3v">We have just added a <code>ListView</code> widget to <code>POIList.axml</code>. Let's now open the <strong>Properties</strong> pad view in the designer window and edit some of its attributes:</p>
<img data-width="288" data-height="261" src="img/mxWb8kcH.jpg"/><p id="e-yfQi">As we may recall from Chapter 3, <em>Creating the Points of Interest App</em>, the <strong>Properties</strong> pad allows you to modify the properties of a selected widget. There are five buttons at the top of the pad that switch the set of properties being edited. The <strong>@+id</strong> notation notifies the compiler that a new resource ID needs to be created to identify the widget in API calls, and <code>listView1</code> identifies the name of the constant. Now, perform the following steps:</p>
<ol id="e-LFIU">
<li id="e-F4y8">Change the ID name to <code>poiListView</code> and save the changes. Switch back to the <strong>Document Outline</strong> pad and notice that the <code>ListView</code> ID is updated.</li>
<li id="e-huqN">Again, switch back to the <strong>Properties</strong> pad and click on the <strong>Layout</strong> button.</li>
<li id="e-Urhn">Under the <strong>View Group</strong> section of the layout properties, set both the <strong>Width</strong> and <strong>Height</strong> properties to <code>match_parent</code>.</li>
<li id="e-KYYL">The <code>match_parent</code> value for the <code>Height</code> and <code>Width</code> properties tells us that the <code>ListView</code> can use the entire content area provided by the parent, excluding any margins specified. In our case, the parent would be the top-level <code>RelativeLayout</code>.<h3 id="e-wrfi">Tip</h3>
<p id="e-N2iz">Prior to API level 8, <code>fill_parent</code> was used instead of <code>match_parent</code> to accomplish the same effect. In API level 8, <code>fill_parent</code> was deprecated and replaced with <code>match_parent</code> for clarity. Currently, both the constants are defined as the same value, so they have exactly the same effect. However, <code>fill_ parent</code> may be removed from the future releases of the API; so, going forward, <code>match_parent</code> should be used.</p>
<p id="e-iU6d">So far, we have added a <code>ListView</code> to <code>RelativeLayout</code>, let's now add a <strong>Progress Bar</strong> to the center of the screen.</p>
</li>
<li id="e-XiMn">Search for <strong>Progress Bar</strong> in the <strong>Toolbox</strong> search field. You will notice that several types of progress bars will be listed, including horizontal, large, normal, and small. Drag the normal progress bar onto <code>RelativeLayout</code>.<p id="e-lLJ9">By default, the <strong>Progress Bar</strong>widget is aligned to the top left of its parent layout. To align it to the center of the screen, select the progress bar in the <strong>Document Outline</strong> tab, switch to the <strong>Properties</strong> view, and click on the <strong>Layout</strong> tab. Now select the <strong>Center In Parent</strong> checkbox, and you will notice that the progress bar is aligned to the center of the screen and will appear at the top of the list view.</p>
</li>
<li id="e-x4gB">Currently, the progress bar is visible in the center of the screen. By default, this could be hidden in the layout and will be made visible only while the data is being downloaded.</li>
<li id="e-sO3v">Change the <strong>Progress Bar</strong> ID to <code>progressBar</code> and save the changes.</li>
<li id="e-oWxZ">To hide the <strong>Progress Bar</strong> from the layout, click on the <strong>Behavior</strong> tab in the <strong>Properties</strong> view. From <strong>Visibility</strong>, select <strong>Box</strong>, and then select <strong>gone</strong>.<p id="e-BuDh">This behavior can also be controlled by calling <code>setVisibility()</code> on any view by passing any of the following behaviors. Later in this chapter, we will see how to hide the view programmatically using the activity code.</p>
</li>
</ol>
<p id="e-WIbC">The <code>View.Visibility</code> property allows you to control whether a view is visible or not. It is based on the <code>ViewStates</code> enum, which defines the following values:</p>
<p id="e-yVsw">Value</p>
<p id="e-AgYO">Description</p>
<p id="e-GGKQ"><code>Gone</code></p>
<p id="e-aCoe">This value tells the parent <code>ViewGroup</code> to treat the View as though it does not exist, so no space will be allocated in the layout</p>
<p id="e-sHKZ"><code>Invisible</code></p>
<p id="e-E1Wl">This value tells the parent <code>ViewGroup</code> to hide the content for the View; however, it occupies the layout space</p>
<p id="e-muuW"><code>Visible</code></p>
<p id="e-Ggwu">This value tells the parent <code>ViewGroup</code> to display the content of the View</p>
<p id="e-cYwS">Click on the <strong>Source</strong> tab to switch the IDE context from visual designer to code, and see what we have built so far. Notice that the following code is generated for the <code>POIList.axml</code> layout:</p>
<pre id="e-Gxin">&amp;lt;?xml version="1.0" encoding="utf-8"?&amp;gt;
&amp;lt;RelativeLayout 
    p1:layout_width="match_parent"
    p1:layout_height="match_parent"
    p1:id="@+id/relativeLayout1"&amp;gt;
    &amp;lt;ListView
        p1:minWidth="25px"
        p1:minHeight="25px"
        p1:layout_width="match_parent"
        p1:layout_height="match_parent"
        p1:id="@+id/poiListView" /&amp;gt;
    &amp;lt;ProgressBar
        p1:layout_width="wrap_content"
        p1:layout_height="wrap_content"
        p1:id="@+id/progressBar"
        p1:layout_centerInParent="true"
        p1:visibility="gone" /&amp;gt;
&amp;lt;/RelativeLayout&amp;gt;</pre>

<h1 id="e-yVrg">Creating POIListActivity</h1>
<p id="e-JpAs">When we created the <code>POIApp</code> solution, along with the default layout, a default activity (<code>MainActivity.cs</code>) was created. Let's rename the <code>MainActivity.cs</code> file to <code>POIListActivity.cs</code>:</p>
<ol id="e-uopk">
<li id="e-nP1C">Select the <code>MainActivity.cs</code> file from Solution Explorer and rename to <code>POIListActivity.cs</code>.</li>
<li id="e-n7XZ">Open the <code>POIListActivity.cs</code> file in the code editor and rename the class to <code>POIListActivity</code>.</li>
<li id="e-QIMM">The <code>POIListActivity</code> class currently contains the code that was created automatically while creating the solution using Xamarin Studio. We will write our own activity code, so let's remove all the code from the <code>POIListActivity</code> class.</li>
<li id="e-OXo7">Override the <code>OnCreate()</code> activity life cycle callback method. This method will be used to attach the activity layout, instantiate the views, and write other activity initialization logic. Add the following code blocks to the <code>POIListActivity</code> class:<pre id="e-xFMU">namespace POIApp
{
 [Activity (Label = "POIApp", MainLauncher = true, Icon = "@
drawable/icon")]
 public class POIListActivity : Activity
 {
  protected override void OnCreate (Bundle savedInstanceState)
  {
   base.OnCreate (savedInstanceState);
  }
 }
}</pre>
</li>
<li id="e-GqbW">Now let's set the activity content layout by calling the <code>SetContentView(layoutId)</code> method. This method places the layout content directly into the activity's view hierarchy. Let's provide the reference to the <code>POIList</code> layout created in previous steps.<p id="e-vEb3">At this point, the <code>POIListActivity</code> class looks as follows:</p>
<pre id="e-S6FW">namespace POIApp
{
  [Activity (Label = "POIApp", MainLauncher = true, Icon = "@drawable/icon")]
  public class POIListActivity : Activity
  {
    protected override void OnCreate (Bundle savedInstanceState)
    {
      base.OnCreate (savedInstanceState);
      SetContentView (Resource.Layout.POIList);
    }
  }
}</pre>
</li>
</ol>
<p id="e-sKXi">Notice that in the preceding code snippet, the <code>POIListActivity</code> class uses some of the <code>[Activity]</code> attributes such as <code>Label</code>, <code>MainLauncher</code>, and <code>Icon</code>. During the build process, Xamarin.Android uses these attributes to create an entry in the <code>AndroidManifest.xml</code> file. As we have already learnt form Chapter 1, <em>The Anatomy of an Android App</em>, the <code>AndroidManifest.xml</code> file is one of the simple application configuration files that describes the functionality and requirements of your Android application. Xamarin makes it easier by allowing all of the Manifest properties to set using attributes so that you never have to modify them manually in <code>AndroidManifest.xml</code>.</p>
<p id="e-o84j">So far, we have declared an activity and attached the layout to it. At this point, if you run the app on your Android device or emulator, you will notice that a blank screen will be displayed. The following sections in this chapter will walk you through the magic of making the <code>POIListActivity</code> activity fully functional.</p>

<h1 id="e-cH5d">Creating the POI list row layout</h1>
<p id="e-vN7H">We now turn our attention to the layout for each row in the <code>ListView</code> widget. The Android platform provides a number of default layouts out of the box that can be used with a <code>ListView</code> widget:</p>
<p id="e-oA2Z">Layout</p>
<p id="e-OODT">Description</p>
<p id="e-ezmO"><code>SimpleListItem1</code></p>
<p id="e-M04v">A single line with a single caption field</p>
<p id="e-LQZs"><code>SimpleListItem2</code></p>
<p id="e-KgrX">A two-line layout with a larger font and a brighter text color for the first field</p>
<p id="e-URuw"><code>TwoLineListItem</code></p>
<p id="e-ESts">A two-line layout with an equal sized font for both lines and a brighter text color for the first line</p>
<p id="e-pAwY"><code>ActivityListItem</code></p>
<p id="e-uHe9">A single line of text with an image view</p>
<p id="e-kRGv">All of the preceding three layouts provide a pretty standard design, but for more control over content layout, a custom layout can also be created, which is what is needed for <code>poiListView</code>.</p>
<p id="e-Q6L8">To create a new layout, perform the following steps:</p>
<ol id="e-ruiV">
<li id="e-jcCd">In the <strong>Solution</strong> pad, navigate to <strong>Resources</strong> | <strong>Layout</strong>, right-click on it, and navigate to <strong>Add</strong> | <strong>New File</strong>.</li>
<li id="e-N30p">Select <strong>Android</strong> from the list on the left-hand side, <strong>Android Layout</strong> from the template list, enter <code>POIListItem</code> in the name column, and click on <strong>New</strong>.</li>
</ol>
<p id="e-GVlJ">Before we proceed to lay out the design for each of the row items in the list, we must draw on a piece of paper and analyze how the UI will look like. In our example, the POI data will be organized as follows:</p>
<img data-width="600" data-height="262" src="img/NIUBUsJX.jpg"/><p id="e-s2H9">There are a number of ways to achieve this layout, but we will use <code>RelativeLayout</code> to achieve the same result. There is a lot going on in this diagram. Let's break it down as follows:</p>
<ul id="e-VMqu">
<li id="e-i8y5">A <code>RelativeLayout</code> view group is used as the top-level container; it provides a number of flexible options for positioning relative content, its edges, or other content.</li>
<li id="e-A5xT">An <code>ImageView</code> widget is used to display a photo of the POI, and it is anchored to the left-hand side of the <code>RelativeLayout</code> utility.</li>
<li id="e-aJ8f">Two <code>TextView</code> widgets are used to display the POI name and address information. They need to be anchored to the right-hand side of the <code>ImageView</code> widget and centered within the parent <code>RelativeLayout</code> utility. The easiest way to accomplish this is to place both the <code>TextView</code> classes inside another layout; in this case, a <code>LinearLayout</code> widget with the orientation set to vertical.</li>
<li id="e-Sgs8">An additional <code>TextView</code> widget is used to display the distance, and it is anchored on the right-hand side of the <code>RelativeLayout</code> view group and centered vertically.</li>
</ul>
<p id="e-xZNL">Now, our task is to get this definition into <code>POIListItem.axml</code>. The next few sections describe how to accomplish this using the <code>Content</code> view of the designer when feasible and the <code>Source</code> view when required.</p>
<h2 id="e-xJI1">Adding a RelativeLayout view group</h2>
<p id="e-Q7F9">The <code>RelativeLayout</code> layout manager allows its child views to be positioned relative to each other or relative to the container or another container. In our case, for building the row layout, as shown in the preceding diagram, we can use <code>RelativeLayout</code> as a top-level view group. When the <code>POIListItem.axml</code> layout file was created, by default a top-level <code>LinearLayout</code> was added. First, we need to change the top-level <code>ViewGroup</code> to <code>RelativeLayout</code>. The following section will take you through the steps to complete the layout design for the POI list row:</p>
<ol id="e-BMdg">
<li id="e-SvJU">With <code>POIListItem.axml</code> opened in the content mode, select the entire layout by clicking on the content area. You should see a blue outline going around the edge. Press <em>Delete</em>. The <code>LinearLayout</code> view group will be deleted, and you will see a message indicating that the layout is empty.</li>
<li id="e-Zxk6">Alternatively, you can also select the <code>LinearLayout</code> view group from the <strong>Document Outline</strong> tab and press <em>Delete</em>.</li>
<li id="e-kaHC">Locate the <code>RelativeLayout</code> view group in the toolbox and drag it onto the layout.</li>
<li id="e-ckPN">Select the <code>RelativeLayout</code> view group from <strong>Document Outline</strong>. Open the <strong>Properties</strong> pad and change the following properties:<ul id="e-fKqQ">
<li id="e-Ghsc">The <strong>Padding</strong> option to <code>5dp</code>
</li>
<li id="e-JSwe">The <strong>Layout Height</strong> option to <code>wrap_content</code>
</li>
<li id="e-NV7i">The <strong>Layout Width</strong> option to <code>match_parent</code>
</li>
</ul>
<p id="e-WxmQ">The padding property controls how much space will be placed around each item as a margin, and the height determines the height of each list row. Setting the <strong>Layout Width</strong> option to <code>match_ parent</code> will cause the <code>POIListItem</code> content to consume the entire width of the screen, while setting the <strong>Layout Height</strong> option to <code>wrap_content</code> will cause each row to be equal to the longest control.</p>
</li>
<li id="e-ZDuv">Switch to the <strong>Code</strong> view to see what has been added to the layout. Notice that the following lines of code have been added to <code>RelativeLayout</code>:<pre id="e-dY1q">&amp;lt;RelativeLayout 
    p1:minWidth="25px"
    p1:minHeight="25px"
    p1:layout_width="match_parent"
    p1:layout_height="wrap_content"
    p1:id="@+id/relativeLayout1"
    p1:padding="5dp"/&amp;gt;</pre>
<h3 id="e-A6I0">Tip</h3>
<p id="e-vM3n">Android runs on a variety of devices that offer different screen sizes and densities. When specifying dimensions, you can use a number of different units, including pixels (px), inches (in), and density-independent pixels (dp). Density-independent pixels are abstract units based on 1 dp being 1 pixel on a 160 dpi screen. At runtime, Android will scale the actual size up or down based on the actual screen density. It is a best practice to specify dimensions using density-independent pixels.</p>
</li>
</ol>
<h2 id="e-jc60">Adding an ImageView widget</h2>
<p id="e-zF2H">The <code>ImageView</code> widget in Android is used to display the arbitrary image for different sources. In our case, we will download the images from the server and display them in the list. Let's add an <code>ImageView</code> widget to the left-hand side of the layout and set the following configurations:</p>
<ol id="e-GtbB">
<li id="e-WPjh">Locate the <code>ImageView</code> widget in the toolbox and drag it onto <code>RelativeLayout</code>.</li>
<li id="e-iEBu">With the <code>ImageView</code> widget selected, use the <strong>Properties</strong> pad to set the ID to <code>poiImageView</code>.</li>
<li id="e-cNcf">Now, click on the <strong>Layout</strong> tab in the <strong>Properties</strong> pad and set the <strong>Height</strong> and <strong>Width</strong> values to <code>65 dp</code>.</li>
<li id="e-o3lc">In the property grouping named <code>RelativeLayout</code>, set <strong>Center Vertical</strong> to <strong>true</strong>. Simply clicking on the checkbox does not seem to work, but you can click on the small icon that looks like an edit box, which is to the right-hand side, and just enter <code>true</code>. If everything else fails, just switch to the <strong>Source</strong> view and enter the following code:<pre id="e-r17o">p1:layout_centerVertical="true"</pre>
</li>
<li id="e-IA6r">In the property grouping named <code>ViewGroup</code>, set the <strong>Margin Right</strong> to <code>5dp</code>. This brings some space between the POI image and the POI name.</li>
<li id="e-ZqcD">Switch to the <strong>Code</strong> view to see what has been added to the layout. Notice the following lines of code added to <code>ImageView</code>:<pre id="e-npBW">&amp;lt;ImageView
        p1:src="img/ic_menu_gallery"
        p1:layout_width="65dp"
        p1:layout_height="65dp"
  p1:layout_marginRight="5dp"
        p1:id="@+id/poiImageView" /&amp;gt;</pre>
</li>
</ol>
<h2 id="e-i5iw">Adding a LinearLayout widget</h2>
<p id="e-b14Z"><code>LinearLayout</code> is one of the most basic layout managers that organizes its child views either horizontally or vertically based on the value of its <code>orientation</code> property. Let's add a <code>LinearLayout</code> view group that will be used to lay out the POI name and address data as follows:</p>
<ol id="e-jnxz">
<li id="e-lQ3w">Locate the <code>LinearLayout</code> (vertical) view group in the toolbox.</li>
<li id="e-N5DM">Adding this widget is a little trickier because we want it anchored to the right-hand side of the <code>ImageView</code> widget.</li>
<li id="e-yYxU">Drag the <code>LinearLayout</code> view group to the right-hand side of the <code>ImageView</code> widget until the edge turns to a blue dashed line, and then drop the <code>LinearLayout</code> view group. It will be aligned with the right-hand side of the <code>ImageView</code> widget.</li>
<li id="e-gN6j">In the property grouping named <code>RelativeLayout</code> of the <strong>Layout</strong> section, set <strong>Center Vertical</strong> to <code>true</code>. As before, you will need to enter <code>true</code> in the edit box or manually add it to the <strong>Source</strong> view.</li>
<li id="e-J2cy">Switch to the <strong>Code</strong> view to see what has been added to the layout. Notice the following lines of code added to <code>LinearLayout</code>:<pre id="e-AIPU">&amp;lt;LinearLayout
        p1:orientation="vertical"
        p1:minWidth="25px"
        p1:minHeight="25px"
        p1:layout_width="wrap_content"
        p1:layout_height="wrap_content"
        p1:layout_toRightOf="@id/poiImageView"
        p1:id="@+id/linearLayout1"
        p1:layout_centerVertical="true" /&amp;gt;</pre>
</li>
</ol>
<h2 id="e-Sx23">Adding the name and address TextView classes</h2>
<p id="e-P45a">Add the <code>TextView</code> classes to display the POI name and address:</p>
<ol id="e-B2oV">
<li id="e-J09c">Locate <code>TextView</code> in the <strong>Toolbox</strong> and add a <code>TextView</code> class to the layout. This <code>TextView</code> needs to be added within the <code>LinearLayout</code> view group we just added, so drag <code>TextView</code> over the <code>LinearLayout</code> view group until it turns blue and then drop it.</li>
<li id="e-bY5o">Name the <code>TextView</code> ID as <code>nameTextView</code> and set the <code>text size</code> to <code>20sp</code>. The text size can be set in the <strong>Style</strong> section of the <strong>Properties</strong> pad; you will need to expand the <strong>Text Appearance</strong> group by clicking on the ellipsis (<strong>...</strong>) button on the right-hand side.<h3 id="e-cCqL">Tip</h3>
<p id="e-pwXg"><strong>Scale-independent pixels</strong> (<strong>sp</strong>) are like dp units, but they are also scaled by the user's font size preference. Android allows users to select a font size in the Accessibility section of Settings. When font sizes are specified using sp, Android will not only take into account the screen density when scaling text, but will also consider the user's accessibility settings. It is recommended that you specify font sizes using sp.</p>
</li>
<li id="e-xnuV">Add another <code>TextView</code> to the <code>LinearLayout</code> view group using the same technique except dragging the new widget to the bottom edge of the <code>nameTextView</code> until it changes to a blue dashed line and then drop it. This will cause the second <code>TextView</code> to be added below <code>nameTextView</code>. Set the font size to <code>14sp</code>.</li>
<li id="e-go0A">Change the ID of the newly added <code>TextView</code> to <code>addrTextView</code>.</li>
<li id="e-A9ka">Now change the sample text for both <code>nameTextView</code> and <code>addrTextView</code> to <strong>POI Name</strong> and <strong>City</strong>, <strong>State</strong>, <strong>Postal Code</strong>.</li>
<li id="e-nu4t">To edit the text shown in <code>TextView</code>, just double tap the widget on the content panel. This enables a small editor that allows you to enter the text directly. Alternately, you can change the text by entering a value for the <strong>Text</strong> property in the <strong>Widget</strong> section of the <strong>Properties</strong> pad.</li>
<li id="e-rBbO">It is a design practice to declare all your static strings in the <code>Resources/values/string.xml</code> file. By declaring the strings in the <code>strings.xml</code> file, you can easily translate your whole app to support other languages. Let's add the following strings to <code>string.xml</code>:<pre id="e-Tinl">&amp;lt;string name="poi_name_hint"&amp;gt;POI Name&amp;lt;/string&amp;gt;
&amp;lt;string name="address_hint"&amp;gt;City, State, Postal Code.&amp;lt;/string&amp;gt;</pre>
</li>
<li id="e-oOcL">You can now change the <strong>Text</strong> property of both <code>nameTextView</code> and <code>addrTextView</code> by selecting the ellipsis (<strong>…</strong>) button, which is next to the <strong>Text</strong> property in the <strong>Widget</strong> section of the <strong>Properties</strong> pad. Notice that this will open a dialog window that lists all the strings declared in the <code>string.xml</code> file. Select the appropriate strings for both <code>TextView</code> objects.</li>
<li id="e-seqK">Now let's switch to the <strong>Code</strong> view to see what has been added to the layout. Notice the following lines of code added inside <code>LinearLayout</code>:<pre id="e-wjYg">&amp;lt;TextView
  p1:layout_width="match_parent"
  p1:layout_height="wrap_content"
  p1:id="@+id/nameTextView "
  p1:textSize="20sp"
  p1:text="@string/app_name" /&amp;gt;
&amp;lt;TextView
  p1:text="@string/address_hint"
  p1:layout_width="match_parent"
  p1:layout_height="wrap_content"
  p1:id="@+id/addrTextView "
  p1:textSize="14sp" /&amp;gt;</pre>
</li>
</ol>
<h2 id="e-Y4Np">Adding the distance TextView</h2>
<p id="e-UpYw">Add a <code>TextView</code> to show the distance from POI:</p>
<ol id="e-efXb">
<li id="e-MrtQ">Locate the <code>TextView</code> in the toolbox and add a <code>TextView</code> to the layout. This <code>TextView</code> needs to be anchored to the right-hand side of the <code>RelativeLayout</code> view group, but there is no way to visually accomplish this; so, we will use a multistep process. Initially, align the <code>TextView</code> with the right-hand edge of the <code>LinearLayout</code> view group by dragging it to the left-hand side until the edge changes to a dashed blue line and drop it.</li>
<li id="e-U16j">In the <strong>Widget</strong> section of the <strong>Properties</strong> pad, name the widget as <code>distanceTextView</code> and set the font size to <code>14sp</code>.</li>
<li id="e-JFop">In the <strong>Layout</strong> section of the <strong>Properties</strong> pad, set <strong>Align Parent Right</strong> to <strong>true</strong>, <strong>Center Vertical</strong> to <strong>true</strong>, and clear out the <code>linearLayout1</code> view group name in the <strong>To Right Of</strong> layout property.</li>
<li id="e-fI2w">Change the sample text to <strong>204 miles</strong>. To do this, let's add a new string entry to <code>string.xml</code> and set the <strong>Text</strong> property from the <strong>Properties</strong> pad.</li>
</ol>
<p id="e-WHKn">The following screenshot depicts what should be seen from the Content view at this point:</p>
<img data-width="303" data-height="258" src="img/OejOO7zu.jpg"/><p id="e-c0SM">Switch back to the <strong>Source</strong> tab in the layout designer, and notice the following code generated for the <code>POIListItem.axml</code> layout:</p>
<pre id="e-JVhi">&amp;lt;?xml version="1.0" encoding="utf-8"?&amp;gt;
&amp;lt;RelativeLayout 
    p1:minWidth="25px"
    p1:minHeight="25px"
    p1:layout_width="match_parent"
    p1:layout_height="wrap_content"
    p1:id="@+id/relativeLayout1"
    p1:padding="5dp"&amp;gt;
    &amp;lt;ImageView
        p1:src="img/ic_menu_gallery"
        p1:layout_width="65dp"
        p1:layout_height="65dp"
  p1:layout_marginRight="5dp"
        p1:id="@+id/poiImageView" /&amp;gt;
    &amp;lt;LinearLayout
        p1:orientation="vertical"
        p1:layout_width="wrap_content"
        p1:layout_height="wrap_content"
        p1:layout_toRightOf="@id/poiImageView"
        p1:id="@+id/linearLayout1"
        p1:layout_centerVertical="true"&amp;gt;
        &amp;lt;TextView
            p1:layout_width="match_parent"
            p1:layout_height="wrap_content"
            p1:id="@+id/nameTextView "
            p1:textSize="20sp"
            p1:text="@string/app_name" /&amp;gt;
        &amp;lt;TextView
            p1:text="@string/address_hint"
            p1:layout_width="match_parent"
            p1:layout_height="wrap_content"
            p1:id="@+id/addrTextView "
            p1:textSize="14sp" /&amp;gt;
    &amp;lt;/LinearLayout&amp;gt;
    &amp;lt;TextView
        p1:text="@string/distance_hint"
        p1:layout_width="wrap_content"
        p1:layout_height="wrap_content"
        p1:id="@+id/textView1"
        p1:layout_centerVertical="true"
        p1:layout_alignParentRight="true" /&amp;gt;
&amp;lt;/RelativeLayout&amp;gt;</pre>

<h1 id="e-VhJ8">Creating the PointOfInterest apps entity class</h1>
<p id="e-jB5a">The first class that is needed is the one that represents the primary focus of the application, a <code>PointofInterest</code> class. <code>POIApp</code> will allow the following attributes to be captured for the Point Of Interest app:</p>
<ul id="e-M0KC">
<li id="e-oTbF"><code>Id</code></li>
<li id="e-kje7"><code>Name</code></li>
<li id="e-FsXa"><code>Description</code></li>
<li id="e-Fyvk"><code>Address</code></li>
<li id="e-D3hC"><code>Latitude</code></li>
<li id="e-m68z"><code>Longitude</code></li>
<li id="e-JZEF"><code>Image</code></li>
</ul>
<p id="e-xwoe">The POI entity class can be nothing more than a simple .NET class, which houses these attributes.</p>
<p id="e-bvpl">To create a POI entity class, perform the following steps:</p>
<ol id="e-B60Q">
<li id="e-Tauk">Select the <code>POIApp</code> project from the Solution Explorer in Xamarin Studio. Select the <code>POIApp</code> project and not the solution, which is the top-level node in the <strong>Solution</strong> pad.</li>
<li id="e-RDFh">Right-click on it and select <strong>New File</strong>.</li>
<li id="e-PwLD">On the left-hand side of the <strong>New File</strong> dialog box, select <strong>General</strong>.</li>
<li id="e-gmUi">At the top of the template list, in the middle of the dialog box, select <strong>Empty Class (C#)</strong>.</li>
<li id="e-wtN4">Enter the name <code>PointOfInterest</code> and click on <strong>OK</strong>. The class will be created in the <code>POIApp</code> project folder.</li>
<li id="e-Ghoe">Change the visibility of the class to public and fill in the attributes based on the list previously identified.</li>
</ol>
<p id="e-NNre">The following code snippet is from <code>\POIApp\POIApp\PointOfInterest.cs</code> from the code bundle available for this book:</p>
<pre id="e-ZPwM">public class PointOfInterest
   {
     public int Id { get; set;}
     public string Name { get; set; }
     public string Description { get; set; }
     public string Address { get; set; }
     public string Image  { get; set; }
     public double? Latitude { get; set; }
     public double? Longitude { get; set; }
}</pre>
<p id="e-JRir">Note that the <strong>Latitude</strong> and <strong>Longitude</strong> attributes are all marked as nullable. In the case of latitude and longitude, (0, 0) is actually a valid location so a null value indicates that the attributes have never been set.</p>

<h1 id="e-t072">Populating the ListView item</h1>
<p id="e-N3mT">All the adapter views such as <code>ListView</code> and <code>GridView</code> use an <code>Adapter</code> that acts as a bridge between the data and views. The <code>Adapter</code> iterates through the content and generates Views for each data item in the list.</p>
<p id="e-ElG8">The Android SDK provides three different adapter implementations such as <code>ArrayAdapter</code>, <code>CursorAdapter</code>, and <code>SimpleAdapter</code>. An <code>ArrayAdapter</code> expects an array or a list as input, while <code>CursorAdapter</code> accepts the instance of the <code>Cursor</code>, and <code>SimpleAdapter</code> maps the static data defined in the resources. The type of adapter that suits your app need is purely based on the input data type.</p>
<p id="e-jY5A">The <code>BaseAdapter</code> is the generic implementation for all of the three adapter types, and it implements the <code>IListAdapter</code>, <code>ISpinnerAdapter</code>, and <code>IDisposable</code> interfaces. This means that the <code>BaseAdapter</code> can be used for <code>ListView</code>, <code>GridView</code>, or <code>Spinners</code>.</p>
<p id="e-OBbY">For <code>POIApp</code>, we will create a subtype of <code>BaseAdapter&amp;lt;T&amp;gt;</code> as it meets our specific needs, works well in many scenarios, and allows the use of our custom layout.</p>

<h1 id="e-VyRW">Creating POIListViewAdapter</h1>
<p id="e-RSqc">In order to create POIListViewAdapter, we will start by creating a custom adapter as follows:</p>
<ol id="e-dudw">
<li id="e-Ura9">Create a new class named <code>POIListViewAdapter</code>.</li>
<li id="e-m3II">Open the <code>POIListViewAdapter</code> class file, make the class a public class, and specify that it inherits from <code>BaseAdapter&amp;lt;PointOfInterest&amp;gt;</code>.</li>
</ol>
<p id="e-gNBd">Now that the adapter class has been created, we need to provide a constructor and implement four abstract methods.</p>
<h2 id="e-QRFz">Implementing a constructor</h2>
<p id="e-GYzs">Let's implement a constructor that accepts all the information we will need to work with to populate the list.</p>
<p id="e-I2o2">Typically, you need to pass at least two parameters: an instance of an activity because we need the activity context while accessing the standard common resources and an input data list that can be enumerated to populate the <code>ListView</code>. The following code shows the constructor from the code bundle:</p>
<pre id="e-p0V8">private readonly Activity context;
private List&amp;lt;PointOfInterest&amp;gt; poiListData;
public POIListViewAdapter (Activity _context, List&amp;lt;PointOfInterest&amp;gt; _poiListData)
     :base()
{
    this.context = _context;
    this.poiListData = _poiListData;
}</pre>
<h2 id="e-jDrY">Implementing Count { get }</h2>
<p id="e-m3if">The <code>BaseAdapter&amp;lt;T&amp;gt;</code> class provides an abstract definition for a read-only <code>Count</code> property. In our case, we simply need to provide the count of POIs as provided in <code>poiListData</code>. The following code example demonstrates the implementation from the code bundle:</p>
<pre id="e-B1gE">public override int Count {
      get { 
        return poiListData.Count; 
      }
}</pre>
<h2 id="e-OheK">Implementing GetItemId()</h2>
<p id="e-Weq8">The <code>BaseAdapter&amp;lt;T&amp;gt;</code> class provides an abstract definition for a method that returns a long ID for a row in the data source. We can use the <code>position</code> parameter to access a POI object in the list and return the corresponding ID. The following code example demonstrates the implementation from the code bundle:</p>
<pre id="e-jbD4">public override long GetItemId (int position)
{
     return position;
}</pre>
<h2 id="e-f0jT">Implementing the index getter method</h2>
<p id="e-RxVf">The <code>BaseAdapter&amp;lt;T&amp;gt;</code> class provides an abstract definition for an index getter method that returns a typed object based on a position parameter passed in as an index. We can use the position parameter to access the POI object from <code>poiListData</code> and return an instance. The following code example demonstrates the implementation from the code bundle:</p>
<pre id="e-RDu0">public override PointOfInterest this[int index] {
  get{ 
      return poiListData [index]; 
     }
}</pre>
<h2 id="e-Vlwi">Implementing GetView()</h2>
<p id="e-V5va">The <code>BaseAdapter&amp;lt;T&amp;gt;</code> class provides an abstract definition for <code>GetView()</code>, which returns a view instance that represents a single row in the <code>ListView</code> item. As in other scenarios, you can choose to construct the view entirely in code or to inflate it from a layout file. We will use the layout file we previously created. The following code example demonstrates inflating a view from a layout file:</p>
<pre id="e-k8Fy">view = context.LayoutInflater.Inflate (Resource.Layout.POIListItem, null, false);</pre>
<p id="e-ufI5">The first parameter of <code>Inflate</code> is a resource ID and the second is a root <code>ViewGroup</code>, which in this case can be left <code>null</code> since the view will be added to the <code>ListView</code> item when it is returned.</p>
<h2 id="e-w7CZ">Reusing row Views</h2>
<p id="e-ZDXG">The <code>GetView()</code> method is called for each row in the source dataset. For datasets with large numbers of rows, hundreds, or even thousands, it would require a great deal of resources to create a separate view for each row, and it would seem wasteful since only a few rows are visible at any given time. The <code>AdapterView</code> architecture addresses this need by placing row Views into a queue that can be reused as they scroll out of view of the user. The <code>GetView()</code> method accepts a parameter named <code>convertView</code>, which is of type <code>view</code>. When a view is available for reuse, <code>convertView</code> will contain a reference to the view; otherwise, it will be <code>null</code> and a new view should be created. The following code example depicts the use of <code>convertView</code> to facilitate the reuse of row Views:</p>
<pre id="e-Uy2T">var view = convertView; 
if (view == null){
        view = context.LayoutInflater.Inflate (Resource.Layout.POIListItem, null);
}</pre>

<h1 id="e-YEt8">Populating row Views</h1>
<p id="e-djBG">Now that we have an instance of the view, we need to populate the fields. The <code>View</code> class defines a named <code>FindViewById&amp;lt;T&amp;gt;</code> method, which returns a typed instance of a widget contained in the view. You pass in the resource ID defined in the layout file to specify the control you wish to access.</p>
<p id="e-X1hd">The following code returns access to <code>nameTextView</code> and sets the <strong>Text</strong> property:</p>
<pre id="e-EPp9">PointOfInterest poi = this [position];
view.FindViewById&amp;lt;TextView&amp;gt;(Resource.Id.nameTextView).Text = poi.Name;</pre>
<p id="e-DWIN">Populating <code>addrTextView</code> is slightly more complicated because we only want to use the portions of the address we have, and we want to hide the <code>TextView</code> if none of the address components are present.</p>
<p id="e-jfG0">The <code>View.Visibility</code> property allows you to control the visibility property of a view. In our case, we want to use the <code>ViewState.Gone</code> value if none of the components of the address are present. The following code shows the logic in <code>GetView</code>:</p>
<pre id="e-kwcg">if (String.IsNullOrEmpty (poi.Address)) {
     view.FindViewById&amp;lt;TextView&amp;gt; (Resource.Id.addrTextView).Visibility = ViewStates.Gone;
  } else{
   view.FindViewById&amp;lt;TextView&amp;gt;(Resource.Id.addrTextView).Text = poi.Address;
}</pre>
<p id="e-fj8i">Populating the value for the distance text view requires an understanding of the location services. We need to do some calculation, by considering the user's current location with the POI latitude and longitude. This part will be covered in Chapter 9, <em>Making POIApp Location Aware</em>.</p>
<h2 id="e-qj2X">Populating the list thumbnail image</h2>
<p id="e-f7Cm">Image downloading and processing is a complex task. You need to consider the various aspects, such as network logic, to download images from the server, caching downloaded images for performance, and image resizing for avoiding the memory out conditions. Instead of writing our own logic for doing all the earlier mentioned tasks, we can use <code>UrlImageViewHelper</code>, which is a free component available in the Xamarin Component Store.</p>
<p id="e-NSnV">The Xamarin Component Store provides a set of reusable components, including both free and premium components, that can be easily plugged into any Xamarin-based application.</p>
<h3 id="e-Vnjd">Using UrlImageViewHelper</h3>
<p id="e-NFU2">The following steps will walk you through the process of adding a component from the Xamarin Component Store:</p>
<ol id="e-uda1">
<li id="e-a9jv">To include the <code>UrlImageViewHelper</code> component in <code>POIApp</code>, you can either double-click on the <code>Components</code> folder in the <strong>Solution</strong> pad, or right-click and select <strong>Edit Components</strong>.</li>
<li id="e-vibO">Notice that the component manager will be loaded with the already downloaded components and a <strong>Get More Components</strong> button that allows you to open the <strong>Components</strong> store from the window. Note that to access the component manager, you need to log in to your Xamarin account:<img data-width="800" data-height="293" src="img/SwDRCFYC.jpg"/>
</li>
<li id="e-SU1g">Search for <code>UrlImageViewHelper</code> in the components search box available in the left-hand side pane. Now click on the download button to add your Xamarin Studio solution.</li>
<li id="e-EHiE">Now that we have added the <code>UrlImageViewHelper</code> component, let's go back to the <code>GetView()</code> method in the <code>POIListViewAdapter</code> class. Let's take a look at the following section of the code:<pre id="e-Fymx">var imageView = view.FindViewById&amp;lt;ImageView&amp;gt; (Resource.Id.poiImageView);
if (!String.IsNullOrEmpty (poi.Address)) {
Koush.UrlImageViewHelper.SetUrlDrawable (imageView,  poi.Image, Resource.Drawable.ic_placeholder);
}</pre>
</li>
</ol>
<p id="e-nEyC">Let us examine how the preceding code snippet works:</p>
<ol id="e-RgEM">
<li id="e-HiVN">The <code>SetUrlDrawable()</code> method defined in the <code>UrlImageViewHelper</code> component provides a logic to download an image using a single line of code. It accepts three parameters: an instance of <code>imageView</code>, where the image is to be displayed after the download, the image source URL, and the placeholder image.</li>
<li id="e-sBQm">Add a new image <code>ic_placeholder.png</code> to the <code>drawable Resources</code> directory. While the image is being downloaded, the placeholder image will be displayed on <code>imageView</code>.</li>
<li id="e-SnqT">Downloading the image over the network requires Internet permissions. The following section will walk you through the steps involved in defining permissions in your <code>AndroidManifest.xml</code> file.</li>
</ol>
<h3 id="e-EEat">Adding Internet permissions</h3>
<p id="e-Aqh7">Android apps must be granted permissions while accessing certain features, such as downloading data from the Internet, saving an image in storage, and so on. You must specify the permissions that an app requires in the <code>AndroidManifest.xml</code> file. This allows the installer to show potential users the set of permissions an app requires at the time of installation.</p>
<p id="e-Td3r">To set the appropriate permissions, perform the following steps:</p>
<ol id="e-Dmx3">
<li id="e-Wcr7">Double-click on <code>AndroidManifest.xml</code> in the <strong>Properties</strong> directory in the <strong>Solution</strong> pad. The file will open in the manifest editor. There are two tabs: <strong>Application</strong> and <strong>Source</strong>, at the bottom of the screen, that can be used to toggle between viewing a form for editing the file and the raw XML, as shown in the following screenshot:<img data-width="800" data-height="500" src="img/WwoNP5Zc.jpg"/>
</li>
<li id="e-pZZI">In the <strong>Required permissions</strong> list, check <strong>Internet</strong> and navigate to <strong>File</strong> | <strong>Save</strong>.</li>
<li id="e-nLDU">Switch to the <strong>Source</strong> view to view the XML as follows:<img data-width="748" data-height="200" src="img/TcyeJQCV.jpg"/>
</li>
</ol>

<h1 id="e-g7aP">Hooking up POIListViewAdapter</h1>
<p id="e-joY6">We have the list layout and adapter ready; let's now proceed to hook up the data in <code>poiListView</code>. We need to switch back to the <code>POIListActivity</code> class and add the following changes:</p>
<ol id="e-pOK7">
<li id="e-lxu0">Declare the following variables inside the <code>POIListActivity</code> class:<pre id="e-nBMP">private ListView poiListView;
private ProgressBar progressBar;
private List&amp;lt;PointOfInterest&amp;gt; poiListData;
private POIListViewAdapter poiListAdapter;</pre>
</li>
<li id="e-s2Ro">Now, in the <code>OnCreate</code> method, instantiate the <code>ListView</code> and <code>ProgressBar</code>:<pre id="e-Qs0P">poiListView = FindViewById&amp;lt;ListView&amp;gt; (Resource.Id.poiListView);
progressBar = FindViewById&amp;lt;ProgressBar&amp;gt; (Resource.Id.progressBar);</pre>
</li>
<li id="e-RKBt">For now, we will create an <code>Async</code> method that is responsible for downloading the data from the server and displaying it in <code>POIListActivity</code>. Add the following method to the <code>POIListActivity</code> class:<pre id="e-yzcH">public async void DownloadPoisListAsync(){
 }</pre>
</li>
<li id="e-VM6d">Call the <code>DownloadPoisListAsync()</code> method from the <code>OnCreate()</code> activity life cycle callback.</li>
<li id="e-U9fw">Note that this chapter uses the Android device networking capabilities for downloading the data form a REST web service. The following sections in this chapter will cover how to make a network request fetch data from the server in detail.<p id="e-Tguu">Now for testing purposes, let's add the following method that provides a dummy POI list object. Later in this chapter, we will remove this method while we integrate with a REST web service:</p>
<pre id="e-oSUg">private List&amp;lt;PointOfInterest&amp;gt; GetPoisListTestData(){
  List&amp;lt;PointOfInterest&amp;gt; listData = new List&amp;lt;PointOfInterest&amp;gt; ();
  for(int i=0; i&amp;lt;20; i++){
    PointOfInterest poi = new PointOfInterest ();
    poi.Id = i;
    poi.Name = "Name " + i;
    poi.Address = "Address " + i;
    listData.Add (poi);
  }
  return listData;
}</pre>
</li>
<li id="e-nO2Y">Let's add the following logic to the <code>downloadPoisAsync()</code> method to make our <code>POIApp</code> fully functional:<pre id="e-CDPb">public async void DownloadPoisListAsync(){
  progressBar.Visibility = ViewStates.Visible;
  poiListData = GetPoisListTestData();
  progressBar.Visibility = ViewStates.Gone;
   poiListAdapter = new POIListViewAdapter (this, poiListData);
  poiListView.Adapter = poiListAdapter;
}</pre>
</li>
</ol>
<p id="e-kzoY">Notice the following in the preceding code:</p>
<ul id="e-sjz4">
<li id="e-laZk">The progress bar is shown to the user when the download starts. When the download is complete, the <code>progressBar</code> is hidden.</li>
<li id="e-DD1G">Currently, the <code>GetPoiListTestData()</code> method simulates the network request and provides the list of POI objects.</li>
<li id="e-ePov">Once the data download is complete, the <code>POIListViewAdapter</code> class is instantiated by passing the downloaded POI list result and then it is set to list view.</li>
</ul>
<p id="e-QwHh">We have done a great deal of work so far! Let's just build and run the app on the Android emulator or device. You will see the output, as shown in the following screenshot:</p>
<img data-width="450" data-height="800" src="img/vtcV96G4.jpg"/><p id="e-HP73">The <code>ListView</code> works great with the test data. Now it is the time to worry about consuming the real POI data from the REST web service. The following section will guide you through establishing an HTTP network request form the Android device.</p>

<h1 id="e-vyE7">Consuming the web service</h1>
<p id="e-g2Ba">Until now, we have created the layout for the list view and list adapter; now it is the time to worry about how to consume the web service to download the data and to hook it up to the screen. The following section will walk you through the steps on how to download data asynchronously from the web service.</p>
<h2 id="e-Bb6z">An introduction to web services</h2>
<p id="e-JDlF">Web services are one of the integral parts of the <strong>World Wide Web</strong> (<strong>WWW</strong>) infrastructure. It allows the server application to share the data or logic with connected clients via web protocols such as REST and SOAP using data formats, such as XML and JSON.</p>
<p id="e-upGX">Web services expose a set of <strong>Application Programming Interfaces</strong> (<strong>APIs</strong>) that provides a uniform data access mechanism for client applications. It doesn't matter which programming language the web service is written in; the client applications with different operating systems or different programming languages can access the services seamlessly, as long as they adhere to the web service API specification. For example, a web service that is written in Java and hosted on Apache Tomcat can be used by a .NET web form, iOS, or an Android application.</p>
<p id="e-Rgf5">SOAP and REST are the two standard web service architectures used vastly in the industry by larger players. Microsoft developed SOAP and REST was developed by W3C Technical Architecture Group. While SOAP brings its own protocol with additional security layers, the REST implementation is considerably easier. Companies such as Google and Microsoft are migrating most of their existing services to REST. Which web service architecture is better is an endless debate worth Googling; however, choosing the one that works for you is purely an architectural decision based on your requirements.</p>
<p id="e-ZnRd">The <code>POIApp</code> example code provided in this book will consume the web service developed in Java (JAX-RS) using the REST architecture. The following section will walk you through the steps on how to deploy and set up on your system for testing <code>POIApp</code>.</p>
<h2 id="e-ClhK">Deploying the POI web service</h2>
<p id="e-RGEA">The code bundle provided in this book includes the POI web service project code, which will be used for completing the remaining chapters in this book. The code bundle includes a <em>readme</em> file describing the steps required for deploying the POI Web service. The following section will walk you through the steps provided in the readme file and deploy the web service before you proceed with this chapter.</p>
<p id="e-Kafp">The POI web service sample application provides two APIs: one to fetch the list of POIs available on the server and the other to create a new POI record in the server database.</p>
<p id="e-lulF">In this chapter, we will be using the following API specification for getting the list of POIs from the web server:</p>
<ul id="e-Y9T7">
<li id="e-sPbk">
<strong>Request method</strong>: <code>GET</code>
</li>
<li id="e-EeKl">
<strong>Resource URI</strong>: <code>/com.packet.poiapp/api/poi/pois</code>
</li>
<li id="e-S0ND">
<strong>Content-type</strong>: <code>application/json</code>
</li>
<li id="e-Et7w">
<strong>Accept-type</strong>: <code>application/json</code>
</li>
<li id="e-Ik2h">
<strong>Response Body</strong>:<pre id="e-I9pc">{
  "poi": [
    {
      "description": "The London Eye is a giant Ferris wheel on the South Bank of the River Thames in London",
      "id": "1",
      "image": "http://&amp;lt;YOUR_IP&amp;gt;:8080/poiapp/api/poi/image.png",
      "latitude": "50.59938",
      "longitude": "80.8897",
      "address": "London SE17PB, UK",
      "name": "London Eye"
    }, 
    {
    ...
    ...
    },
    {
    ...
    ...
    } ]
}</pre>
</li>
</ul>
<h2 id="e-r3wY">Consuming REST web services asynchronously</h2>
<p id="e-hPhI">Consuming REST web services in the Xamarin Android application is relatively easier than it looks. There are various framework classes, such as <code>WebClient</code>, <code>WebRequest</code>, <code>HttpWebRequest</code>, <code>HttpClient</code>, and other third-party libraries, such as <code>RestSharp</code> and <code>Service Stack</code>, that are available for Xamarin to consume REST web services.</p>
<p id="e-Crbi">For developing <code>POIApp</code>, we will taper our discussion to <code>HttpClient</code>. The <code>HttpClient</code> is newly introduced in .NET 4.5 and provides some of the advanced features, such as a strong type header, shared cache, cache control, and so on. The following section will walk you through the steps on how to use <code>HttpClient</code> to make an asynchronous web service request from the Xamarin Android application.</p>
<h2 id="e-tKlW">Creating the POIService class</h2>
<p id="e-XgfZ">Now, we will create a standard C# class that abstracts all the logic to consume REST web services and will make our activity look much tidier. To create the new <code>POIService</code> class, perform the following steps:</p>
<ol id="e-WnKO">
<li id="e-o1y2">Select the <code>POIApp</code> project in the <strong>Solution</strong> pad in Xamarin Studio.</li>
<li id="e-ixE5">Right-click on it and select <strong>New File</strong>.</li>
<li id="e-Em1a">On the left-hand side of the <strong>New File</strong> dialog box, select <strong>General</strong>.</li>
<li id="e-kgjw">At the top of the template list, in the middle of the dialog box, select <strong>Empty Class(C#)</strong>.</li>
<li id="e-Nq2m">Enter the name <code>POIService</code> and click on <strong>OK</strong>.</li>
<li id="e-Qw8U">Declare a string constant that represents the resource's URI endpoint to access the POI web service for fetching the list of POIs available in the server. At this stage, I assume that the web service code is hosted on the local computer with port 8080. In real time, your application will use the domain where the endpoint is hosted:<pre id="e-BNBS">private const string GET_POIS = "http://&amp;lt;YOUR_IP&amp;gt;:8080/com.packet.poiapp/api/poi/pois";</pre>
<p id="e-WDI7">For any technical reasons/limitations you couldn't complete the web service installation, you can still continue to test your application with Apiary mock feeds. For testing with mock feeds, you can use the following feed URL:</p>
<pre id="e-MAkt">private const string GET_POIS = "http://private-e451d-poilist.apiary-mock.com/com.packt.poiapp/api/poi/pois";</pre>
</li>
</ol>
<h2 id="e-RTf8">Asynchronous programming with async and await</h2>
<p id="e-Jt2P">Downloading data from the server is a long-running blocking operation, and it is recommended for mobile apps to perform all such long-running tasks off the main thread. For making a responsive and smooth user experience, mobile applications need to create a new thread for any long-running operations. Since the release of <strong>.NET 4.5</strong>, the <code>async</code> and <code>await</code> keywords are used to implement multi-threading easily, without getting your hands dirty in threads. The methods defined by the <code>async</code> and <code>await</code> keywords are often called the <code>async</code> methods.</p>
<p id="e-A8hB">The following are some of the key things you must know before implementing the <code>async</code> methods:</p>
<ul id="e-wGf7">
<li id="e-q2Tu">The <code>async</code> keyword is used to notify the .NET language <strong>Common Language Runtime</strong> (<strong>CLR</strong>) to create a new thread of execution and execute tasks asynchronously.</li>
<li id="e-IWPb">The <code>await</code> keyword automatically pauses the caller thread and executes the tasks on a new thread; once the task is finished, the control is returned. A single <code>async</code> method can have one or more <code>await</code> keywords.</li>
<li id="e-IQv2">The <code>async</code> method always returns <code>Task&amp;lt;T&amp;gt;</code>, where <strong>T</strong> represents the data type of the result expected after the execution. A void return type can be used when no result is expected.</li>
<li id="e-C59F">As a convention, Microsoft recommends the name of the <code>async</code> methods to suffix with async. However, this is not mandatory, but it helps to remind the caller to use the <code>await</code> keyword.</li>
</ul>
<p id="e-lmMu">Now that we understand the basics to create the async method, let's define a method in the <code>POIService</code> class and name it <code>GetPOIListAsync</code>. The <code>GetPOIListAsync</code> method will be used to consume the REST web service asynchronously, deserialize the response in the POI list collection, and return the result back to the activity for displaying results in the list:</p>
<pre id="e-aunf">public async Task&amp;lt;List&amp;lt;PointOfInterest&amp;gt;&amp;gt; GetPOIListAsync() {
  
}</pre>
<p id="e-l7k6">Notice that the return type of the <code>GetPOIListAsync</code> method is <code>Task&amp;lt;List&amp;lt;PointOfInterest&amp;gt;&amp;gt;</code>, and the <code>List&amp;lt;PointOfInterest&amp;gt;</code> is the result expected on <code>POIListActivity</code> for rendering the data on the list view.</p>
<p id="e-mozb">The <code>GetPOIListAsync</code> method now creates an instance of <code>HttpClient</code>, sets the HTTP header accept type as <code>application/json</code>, and calls the <code>GetAsync()</code> method by passing the web service URL. The accept type header metadata tells the server about the response the media format client expects. The <code>GetAsync()</code> method initiates a GET request to the specified endpoint and returns the <code>HttpResponseMessage</code> instance.</p>
<p id="e-bU8l">If the response status code is returned as a success <strong>(</strong> <code>200OK</code> <strong>)</strong>, we are good to proceed to fetch the contents. As we know from the web service specification, the response is a structured JSON string; we can retrieve the values by calling the <code>GetStringAsync</code> method. For the status code other than success, we can place the logic to handle the error case. In order to simplify this example, we will just print the error log on the console:</p>
<pre id="e-ZlsO">HttpClient httpClient = new HttpClient ();
httpClient.DefaultRequestHeaders.Accept.Add (new MediaTypeWithQualityHeaderValue ("application/json"));
HttpResponseMessage response = await httpClient.GetAsync (GET_POIS);
if (response != null || response.IsSuccessStatusCode) {
  string content = await response.Content.ReadAsStringAsync ();
  Console.Out.WriteLine ("Response Body: \r\n {0}", content);
 } else {
  Console.Out.WriteLine("Failed to fetch data. Try again later!");
  return null;
}</pre>
<p id="e-VRiE">Note that the preceding <code>GetPOIListAsync</code> method used for consuming the REST web service requires the Internet permission. As we have already added the Internet permission, while downloading the image using the <code>UrlImageViewHelper</code> Xamarin component, we don't need to add the permission again.</p>
<p id="e-LPkw">The <code>await</code> keyword expects the download results to proceed further and hence, it waits for the ongoing download task to complete. Once the download task is completed, the POI web service response JSON string is assigned to a content variable. At this point, the string result has to be deserialized to the .NET object and the result has to be returned back to <code>POIListActivity</code>. The following section will guide you with the steps to deserialize the content string into a JSON object.</p>
<p id="e-cpuN">While HttpClient in combination with <code>async</code> and <code>await</code> keyword provides a native API support for dealing with asynchronous network request, you can also take advantages of the powerful and yet popular framework such as Service Stack or Rest Sharp. Here are a few links that you can refer to:</p>
<ul id="e-JAnz">
<li id="e-ThYc"><a href="https://msdn.microsoft.com/en-us/library/hh191443.aspx">https://msdn.microsoft.com/en-us/library/hh191443.aspx</a></li>
<li id="e-ReNJ"><a href="https://github.com/restsharp/RestSharp">https://github.com/restsharp/RestSharp</a></li>
<li id="e-Jc3w"><a href="https://servicestack.net/">https://servicestack.net/</a></li>
</ul>
<h2 id="e-n9gz">Serializing and deserializing using Json.NET</h2>
<p id="e-qgNd">Another important decision that we need to make while serializing and deserializing the JSON data is how we will get the response string converted to a .NET object and vice versa. There are a number of options available, including <code>DataContractJsonSerailzier</code> from .NET. Json.NET is an open source component library created by James Newton-King, and this is definitely worth considering because of the following reasons:</p>
<ul id="e-OZiK">
<li id="e-ehaK">It's small, fast, and reliable</li>
<li id="e-ia94">It's available as a free component in the Xamarin Component Store and via NuGet</li>
<li id="e-zlR2">It makes simple tasks extremely simple to accomplish</li>
</ul>
<p id="e-xZKh">With these characteristics in mind, we will proceed by adding the Json.NET component to <code>POIApp</code> from the Xamarin Component Store. To add the Json.NET component, follow the same steps that we performed while adding the <code>UrlImageViewHelper</code> component.</p>
<p id="e-Eg2q">Once the Json.NET component is added to the solution, the next step is to convert the response string and to make a list of <code>PointOfInterest</code> objects.</p>
<ol id="e-ilQO">
<li id="e-Sl3d">Include the following namespace directives in the <code>POIListActivity.cs</code> file:<pre id="e-leCX">using Newtonsoft.Json.Linq;
using System.Collections.Generic;
using Newtonsoft.Json;
using System.Linq;</pre>
</li>
<li id="e-FFFn">Declare a list collection in the <code>GetPOIListAsync()</code> method to hold the POI's list response:<pre id="e-YCBi">private List&amp;lt;PointOfInterest&amp;gt; poiListData = null;</pre>
</li>
<li id="e-BMA0">Initialize the <code>poiListData</code> list collection. Place the following code snippet in the <code>downloadPoisAsync()</code> method after the <code>Console.Out.WriteLine</code> statement:<pre id="e-eSPD">poiListData = new List&amp;lt;PointOfInterest&amp;gt; ();</pre>
</li>
</ol>
<p id="e-qzzQ">Now, it is time to deserialize the JSON string to the .NET object. Notice that the response JSON string is an object with a key <code>pois</code> representing the array of the <code>PointOfInterest</code> objects. Add the following code snippet to the <code>GetPOIListAsync()</code> method to deserialize the string to the .NET object.</p>
<p id="e-Poit">The following line of code will convert the complete JSON response string to <code>JObject</code>:</p>
<pre id="e-DFaP">JObject jsonResponse = JObject.Parse (content);</pre>
<p id="e-G3Zb">Now fetch the values for the <code>pois</code> key and iterate through it to convert to the .NET list:</p>
<pre id="e-OfMZ">IList&amp;lt;JToken&amp;gt; results = jsonResponse ["pois"].ToList ();
foreach (JToken token in results) {
  PointOfInterest poi = token.ToObject&amp;lt;PointOfInterest&amp;gt;(); 
  poiListData.Add (poi);
}
return poiListData;</pre>
<p id="e-WrMz">The <code>JToken</code> is a generic representation of the JSON value of any kind. It could be a string, object, array, property, and so on. The <code>ToList()</code> method returns the collections of the <code>JToken</code> objects. The <code>token.ToObject</code> method converts each of the poiJSON tokens to the <code>PointOfInterest</code> object type and adds it to the <code>poiListData</code> collection. Finally, we return the list result back to the caller.</p>
<h2 id="e-D6xA">Updating POIListActivity</h2>
<p id="e-RbaY">So far, we have downloaded the data, and we are ready to use the data in <code>POIListActivity</code>. Let's do the following changes in <code>POIListActivity</code>:</p>
<ol id="e-mbNZ">
<li id="e-J4sp">Delete the <code>GetPoiListTestData()</code> method from the <code>POIListActivity</code> class.</li>
<li id="e-XALB">Create an instance of <code>POIService</code> in the <code>DownloadPoisListAsync</code> method and call the <code>GetPOIListAsync</code> method:<pre id="e-v2df">public async void DownloadPoisListAsync(){
  progressBar.Visibility = ViewStates.Visible;
  POIService service = new POIService ();
  poiListData = await service.GetPOIListAsync ();
  progressBar.Visibility = ViewStates.Gone;
   poiListAdapter = new POIListViewAdapter (this, poiListData);
  poiListView.Adapter = poiListAdapter;
}</pre>
</li>
</ol>
<p id="e-uAvB">We have done a great deal of work so far; now it's time to compile and run the app. Compile and run the application using the Android emulator based on the procedure we used in the previous chapters.</p>
<p id="e-rRSD">Bingo! You will notice that the app will download the data from the POI web service and display the list of POIs on the scrollable list view:</p>
<img data-width="450" data-height="800" src="img/SlfgXL9q.jpg"/>
<h1 id="e-QJb6">Adding actions to ActionBar</h1>
<p id="e-zsIF">With Android 3.0 (Honeycomb, API level 11), Android introduced a uniform title, such as a widget that docks to the top of the screen, called <strong>ActionBar</strong>. It allows apps to add activity-specific actions to the top of the device screen, just below the status bar. We will define two actions for the <code>POIListActivity</code> class: <code>New</code>, to create a new POI, and <code>Refresh</code>, to refresh the cache of POIs from the device's local storage.</p>
<p id="e-b734">The <code>Activity</code> class provides the following virtual methods that can be overridden to add actions:</p>
<p id="e-thEE">Virtual Method</p>
<p id="e-BCVU">Description</p>
<p id="e-SzB4"><code>OnCreateOptionsMenu</code></p>
<p id="e-Ilim">It allows the creation of the actions either through API calls or through inflating an XML definition</p>
<p id="e-SJL3"><code>OnOptionsItemSelected</code></p>
<p id="e-cxjI">It is called when an action in <code>ActionBar</code> is clicked</p>

<h1 id="e-ZNyy">Defining the menu XML file</h1>
<p id="e-QLV9">Actions can be defined in a menu XML file that resides in the <code>Resources/menu</code> folder, or it can be created programmatically using API calls. We will define the <strong>New</strong> and <strong>Refresh</strong> actions in an XML file named <code>POIListViewMenu.xml</code>.</p>
<p id="e-xSaj">To create <code>POIListViewMenu.xml</code>, perform the following steps:</p>
<ol id="e-qgoT">
<li id="e-FCBv">Select the <code>Resources</code> folder in <code>POIApp</code>, right-click on it, and navigate to <strong>Add</strong> | <strong>New Folder</strong>.</li>
<li id="e-LkeH">Name the folder menu.</li>
<li id="e-t1oU">Select the menu folder, right-click on it, and navigate to <strong>Add</strong> | <strong>New File</strong>.</li>
<li id="e-H7Mc">Navigate to <strong>XML</strong> | <strong>Empty XML</strong> file, enter <code>POIListViewMenu.xml</code> for the name, and click on <strong>New</strong>.</li>
</ol>
<p id="e-Svec">You now need to fill in the definitions for the two actions we identified. Unfortunately, Xamarin Studio does not contain a template for menu XML files, so you have to hunt the format down from the Android documentation or online examples. The following code contains definitions for <code>actionNew</code> and <code>actionRefresh</code>:</p>
<pre id="e-y9l1">&amp;lt;menu &amp;gt;
     &amp;lt;item android:id="@+id/actionNew"
       android:icon="@drawable/ic_new"
       android:title="New"
     android:showAsAction="ifRoom" /&amp;gt;
     &amp;lt;item android:id="@+id/actionRefresh"
       android:icon="@drawable/ic_refresh"
       android:title="Refresh"
     android:showAsAction="ifRoom" /&amp;gt;
&amp;lt;/menu&amp;gt;</pre>
<p id="e-Z95G">Note that from the menu definition, we have referenced two new drawables: <code>ic_new</code> and <code>ic_refresh</code>. We need to add these images to the project in the same way that we did for the <code>ic_app</code> icon in Chapter 3, <em>Creating the Points of Interest App</em>. The images can be found in the <code>drawable</code> folder present in the <code>assets</code> location.</p>

<h1 id="e-LnfD">Setting menus in OnCreateOptionsMenu()</h1>
<p id="e-MeYS">The <code>OnCreateOptionsMenu()</code> method is called to give an opportunity to the <code>Activity</code> parameter to define actions for the <code>ActionBar</code>. The <code>Activity</code> class provides a <code>MenuInflater</code> method, which reads the XML definition file and places the action defined on the ActionBar. The following code shows the implementation from the code bundle:</p>
<pre id="e-QOWP">public override bool OnCreateOptionsMenu(IMenu menu)
{
    MenuInflater.Inflate(Resource.Menu.POIListViewMenu, menu);
    return base.OnCreateOptionsMenu(menu);
}</pre>

<h1 id="e-dc37">Handling selection in OnOptionsItemSelected()</h1>
<p id="e-hZ5U">The <code>OnOptionsItemSelected()</code> method is called whenever an action in the ActionBar is clicked and an instance of <code>IMenuItem</code> is passed in. The <code>IMenuItem ItemId</code> instance corresponds to the ID specified in the item definition and can be used to determine which action was clicked on. The following code shows the implementation of <code>OnOptionsItemSelected()</code> from the code bundle:</p>
<pre id="e-OVhQ">public override bool OnOptionsItemSelected (IMenuItem item)
{
    switch (item.ItemId)
    {
        case Resource.Id.actionNew:
            // place holder for creating new poi
            return true;
        case Resource.Id.actionRefresh:
            DownloadPoisListAsync(url);
            return true;
        default :
            return base.OnOptionsItemSelected(item);
     }
}</pre>
<p id="e-MGUJ">Note that we have simply created a placeholder for <code>actionNew</code> and placed two method calls for <code>actionRefresh</code>.</p>
<p id="e-Wae0">The <code>DownloadPoisListAsync()</code> method is called to download and refresh the data on the list.</p>
<p id="e-GZKq">Let's now run the <code>POIApp</code> and notice the two buttons, <strong>Add</strong> and <strong>Refresh</strong>, on the POI list activity title:</p>
<img data-width="500" data-height="323" src="img/IMUA78SR.jpg"/>
<h1 id="e-mjq4">Handling the ListView click event</h1>
<p id="e-eD50">When a user clicks on a row, the POI app will navigate to a detailed view in order to allow you to view and update the complete set of information. We will build the detailed view in the next chapter but will go ahead and discuss handling clicks now.</p>
<p id="e-O6ay">Clicks can be handled using a traditional event handler. The <code>ListView</code> item provides an <code>ItemClick</code> event handler, which accepts a <code>ListView.ItemClickEventArgs</code> parameter. The <code>ListView.ItemClickEventArgs</code> parameter provides the following information that can be used for processing the event:</p>
<p id="e-HMpb">Property</p>
<p id="e-OFST">Description</p>
<p id="e-WghL"><code>ID</code></p>
<p id="e-hJVl">It is the ID for the data associated with the row that was clicked. This would be the value returned from <code>GetItemId()</code>.</p>
<p id="e-eRVl"><code>Position</code></p>
<p id="e-FZ68">It is the position in the <code>ListView</code> item of the row that was clicked.</p>
<p id="e-WbIO"><code>View</code></p>
<p id="e-mW2r">It is the view associated with the row that was clicked. This would be the view returned from <code>GetView()</code>.</p>
<p id="e-O0lP"><code>Parent</code></p>
<p id="e-xNnB">It is the <code>AdapterView</code> architecture that contains the row that was clicked. In our case, it is <code>ListView</code>.</p>
<p id="e-ZwzA">Create an event handler in <code>POIListActivity</code> to process click events on the <code>ListView</code> item. We are not ready to add the navigation, as we have not yet created our detailed view, so we will just show you a <code>Toast</code> message. The following code is from the code bundle:</p>
<pre id="e-CmpG">protected void POIClicked(object sender, ListView.ItemClickEventArgs e)
{
   // Fetching the object at user clicked position
   PointOfInterest poi = result.poiListData[(int)e.Id];
   Console.Out.WriteLine("POI Clicked: Name is {0}", poi.Name);
}</pre>
<p id="e-ghUF">We also need to hook up the event handler. Add the following line of code to the end of the <code>OnCreate</code> method:</p>
<pre id="e-pdeI">poiListView.ItemClick += POIClicked;</pre>
<p id="e-R6uN">Run the <code>POIApp</code> project and click on a <strong>POI</strong>; notice that the POI name of the corresponding row is printed on the console.</p>

<h1 id="e-ZlWI">Handling no network condition</h1>
<p id="e-tlFS">The network conditions in mobile devices are uncertain. Sometimes, a user manually disables the network connections or they are unavailable due to various external reasons. For applications that use network data, you must handle different network states. Applications should react gracefully by showing an appropriate message to the user.</p>
<p id="e-J38l">In <code>POIApp</code>, before starting the download, we must confirm the availability of the network data connections. If the network is unavailable, we should notify the user with an appropriate message otherwise continue with the download request.</p>
<p id="e-I0Kw">The <code>ConnectivityManager</code> class present in the <code>System.Net</code> package can be used to query the state of device network connectivity. This class can also be used to monitor the network connection and notify when there is a change in the network state. In our case, we will just query the network information just to know that the network is available.</p>
<p id="e-zsei">Accessing the network state using the <code>ConnectivityManager</code> class requires <code>ACCESS_NETWORK_STATE</code> user permission in the <code>AndroidManifest.xml</code> file. Follow the same steps as we did earlier while adding the Internet permission, or alternatively, you can directly add the following code to the <code>AndroidManifest.xml</code> source editor:</p>
<pre id="e-cp6b">&amp;lt;uses-permission android:name="android.permission.ACCESS_NETWORK_STATE" /&amp;gt;</pre>
<p id="e-RaUG">Now add the following utility method to the <code>POIService</code> class that reads the network information and returns <code>true</code> if the device is connected:</p>
<pre id="e-msRk">public bool isConnected(Context activity){
  var connectivityManager = (ConnectivityManager)activity.GetSystemService (Context.ConnectivityService);
  var activeConnection = connectivityManager.ActiveNetworkInfo;
  return (null != activeConnection &amp;amp;&amp;amp; activeConnection.IsConnected);
}</pre>
<p id="e-G7O5">Now do the following changes to the <code>DownloadPoisListAsync</code> method in the <code>POIService</code> class:</p>
<pre id="e-jYTG">public async void DownloadPoisListAsync(){
  POIService service = new POIService ();
  if (!service.isConnected (this)) {
    Toast toast = Toast.MakeText (this, "Not conntected to internet. Please check your device network settings.", ToastLength.Short);
    toast.Show ();
  } else {
    progressBar.Visibility = ViewStates.Visible;
    poiListData = await service.GetPOIListAsync ();
    progressBar.Visibility = ViewStates.Gone;
     poiListAdapter = new POIListViewAdapter (this, poiListData);
    poiListView.Adapter = poiListAdapter;
  }
}</pre>
<p id="e-xrCr">You must be surprised about the <code>Toast</code>. Well, we will learn about it in the next section.</p>

<h1 id="e-Xref">Toast</h1>
<p id="e-UI8u">The <code>Toast</code> is a noninteractive, auto disposable view used to display a short message for a specified period of time and disposes itself. Android recommends that you use <code>Toast</code> only to notify the user, where the user's attention is not mandate. For any such notification that requires the user's attention or interaction, consider using dialog.</p>
<p id="e-nuhX">Creating a <code>Toast</code> is simple, all you have to do is to call the <code>MakeText()</code> static method by passing three parameters: the application context, message to be shown, and the time duration for the <code>Toast</code> to be shown. The time duration is a non-negative integer value in milliseconds, but it is recommended that you use the standard <code>Long</code> and <code>Short</code> constants defined in the <code>ToastLength</code> enum. The <code>MakeText()</code> method initializes the Toast with the given properties and returns a <code>Toast</code> instance on which we can call the <code>Show()</code> method to display <code>Toast</code>.</p>
<p id="e-baBf">In the preceding code snippet, we are displaying the <code>Toast</code> message when the device is offline. The following code depicts calls to the <code>MakeText()</code> and <code>Show()</code> methods to display <code>Toast</code> on the <code>Delete</code> action:</p>
<pre id="e-nfYO">Toast toast = Toast.MakeText (this, "Not conntected to internet. Please check your device network settings.", ToastLength.Short);
toast.Show ();</pre>

<h1 id="e-ECr9">Summary</h1>
<p id="e-JMfh">In this chapter, we covered a lot about how to create user interface elements using different layout managers and widgets such as <code>TextView</code>, <code>ImageView</code>, <code>ProgressBar</code>, and <code>ListView</code>.</p>
<p id="e-C6Z9">We also covered how to consume REST web services using the Xamarin.Android <code>HttpClient</code> class, deserialize the JSON response using the Json.NET component, and populate the data on the screen.</p>
<p id="e-ppy9">The next chapter will introduce you to some more view groups and build more complex UIs. We will continue with <code>POIApp</code> by adding a detailed view and allow the user the option to create or delete a Point Of Interest.</p>
</body></html>