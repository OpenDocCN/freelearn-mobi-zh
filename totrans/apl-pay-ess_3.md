# 第3章。支付授权工作流程

*支付表单*是Apple Pay体验中最重要的面向用户的部分。此外，这也是用户应该花费最少时间的地方。你的应用说服用户购买产品。支付表单是你将用户从*欲望*引导到*获取*的地方，尽可能减少点击次数，两个点击是最理想的。

在上一章中，你学习了如何在支付表单中展示信息，包括你可以提供给客户的发货方式列表以及订单的总价。当支付表单打开时，用户可以更改发货类型（例如，从送货到门店自提），发货地址和支付方式（将用于资助交易的支付卡）。对于用户所做的每个更改，你必须更新支付请求的摘要项以反映它。例如，当用户更改发货方式时，你必须更新显示使用新选定的发货方式发送商品价格的摘要项。

本章将展示如何响应支付表单的消息来更新支付请求上的适当信息。它还展示了如何响应用户授权应用提交支付请求以供所选卡的发行银行审批而启动支付处理工作流程。

本章将完成以下工作：

+   描述支付授权工作流程

+   展示实现方法（由支付表单代理协议声明）的示例，这些方法响应支付表单消息以更新支付请求中的适当信息

+   展示如何在用户授权支付请求或通过点击取消按钮取消交易时关闭支付表单

# 授权工作流程中的参与者和操作

*支付授权工作流程*是一个用户确认或输入你在支付表单中提供或请求的发货信息，并授权应用提交支付请求以供支付请求中指定的支付卡发行银行审批的过程。用户还可以更改用于资助支付请求的支付卡，在这种情况下，你可能需要更新支付请求的摘要项（例如，为特定卡片添加附加费）。

支付授权工作流程从你的应用展示支付表单（一个`PKPaymentAuthorizationViewController`对象）开始，并在用户授权支付请求时结束。（用户可以通过在支付表单上点击**取消**按钮来取消交易。）

本图展示了支付授权工作流程中的参与者和操作：

![授权工作流程中的参与者和操作](img/B05093_03_01.png.jpg)

工作流程包括以下四个步骤：

1.  应用展示支付表单。

1.  用户输入或更改您展示或要求的信息（付款单上显示的信息越少，授权越快）。

1.  应用通过更新支付摘要项来响应付款单的变化。

1.  用户批准支付请求。

这些是更详细的操作：

+   **支付请求** (`PKPaymentRequest`): 这是您用来展示付款单的支付请求。

+   **配送类型** (`PKShippingType`): 这表示客户将如何获得购买的产品。可用的配送类型包括送货（例如，办公用品或披萨）、门店自提（例如，苹果手表或珠宝）和服务自提（例如，当您提供提供家庭取货的运输或配送服务时）。使用门店自提配送类型时，您必须管理配送地址，因为它们不是配送地址，而是取货地址，例如您的门店地址。例如，在这种情况下，您可以设置*配送*地址为您的门店地址或通过将支付请求的 `requiredShippingAddressFields` 属性设置为 `PKAddressFieldNone` 来隐藏配送地址。

+   **支付摘要项** 和 **配送方式** (`PKPaymentSummaryItem`, `PKShippingMethod`): 这表示在订单小计之后显示的摘要项，包括为订单选择的配送方式。

+   **配送方式** (`PKShippingMethod` 对象): 这表示订单中客户可用的配送方式。如果用户更改了配送地址，此列表可能会发生变化。

+   **付款单** (`PKPaymentAuthorizationViewController`): 这是应用向用户展示的界面，让用户在授权支付请求之前验证或输入所需的信息。用户将在该界面上授权支付请求。

+   **付款单交互协议** (`PKPaymentAuthorizationViewControllerDelegate`): 这是应用和付款单之间用来相互通信的API。

# 实现一个共享方法来计算摘要项

要响应付款单的代理方法调用，您应该有一个单一的方法，根据配送信息计算支付摘要项。以下是一个此类方法的可能实现：

[PRE0]

使用此方法，您可以响应付款单的不同代理方法调用，并有一个一致的算法来计算支付摘要项。

# 响应用户与付款单的交互

在确定支付授权工作流程中的主要参与者和操作以及一个计算支付摘要项的单个方法后，我们准备深入了解您对用户更改配送信息所引发的付款单消息的响应。

注意，支付表的正确功能对于支付授权工作流程至关重要；特别是，支付表必须一致地调用其代理方法，以便您能够正确判断这些方法何时被调用，这是由于用户与支付表的交互引起的。如果您使用iOS模拟器测试代码，并注意到支付表的代理方法没有被调用，请退出并重新启动模拟器应用。

## 用户更改运输信息

当用户更改运输地址或联系人时，您的支付表代理会收到`paymentAuthorizationViewController:didSelectShippingContact:completion:`消息，表明用户已更改订单的运输信息。

新的运输详情被封装在一个*联系人*（一个`PKContact`实例）中。这个`contact`对象只包含您在支付请求的`requiredShippingAddressFields`属性中请求的运输信息。`contact`对象的属性有`name`、`emailAddress`、`phoneNumber`和`postalAddress`。所以，如果您通过将`requiredShippingAddressFields`支付请求属性设置为`PKAddressFieldPostalAddress|PKAddressFieldName`来仅请求邮政地址和姓名，支付表将确保在调用此`delegate`方法时，联系人的`name`和`postalAddress`属性被填充。这是此方法的实现：

[PRE1]

此方法所做的只是通过方法的完成块向支付表提供成功状态、标准运输方法和计算出的支付摘要项。在您的应用中，您可能需要根据完成块中`contact`参数包含的信息调整返回的运输方法。

## 用户更改运输方法

当用户更改运输方式时，支付表会调用其代理的`paymentAuthorizationViewController:didSelectShippingMethod:completion:`方法。类似于运输信息的更改，您根据用户选择的运输方式重新计算支付摘要项。在`completion`块中，提供成功授权状态和重新计算后的支付摘要项，如下例所示：

[PRE2]

此方法所做的只是存储所选运输方法的索引，重新计算支付摘要项数组，并通过方法的完成块调用完成块，将`PKPaymentAuthorizationStatusSuccess`作为`status`参数，以及新的支付摘要项数组作为`summary_items`参数。

## 用户授权支付请求

当用户授权支付请求时，支付表单在其代理上调用`paymentAuthorizationViewController:didAuthorizePayment:completion:`方法。在这个方法中，你处理从支付表单获得的支付（`PKPayment`实例），这个过程将在下一章中描述。如果支付处理成功，你将使用`PKPaymentAuthorizationStatusSuccess`作为参数调用`completion`块。如果你的验证检查确定支付请求包含错误信息，你可以返回指定此信息的值，例如：

+   `PKPaymentAuthorizationStatusInvalidBillingPostalAddress`

+   `PKPaymentAuthorizationStatusInvalidShippingPostalAddress`

+   `PKPaymentAuthorizationStatusInvalidShippingContact`

否则，对于一般性失败，包括发行银行未批准交易的情况，你可以返回`PKPaymentAuthorizationStatusFailure`。

这里是一个`payment sheet:payment request, authorizing`方法的示例实现：

[PRE3]

这里是支付表单的示例：

![用户授权支付请求](img/B05093_03_02.png.jpg)

无论支付是否成功处理或用户取消了交易，当它在其代理上调用`paymentAuthorizationViewControllerDidFinish:`方法时，你有责任关闭支付表单。以下是如何做到这一点的示例：

[PRE4]

除了关闭支付表单之外，根据需要，你可以执行其他恢复状态的操作。

# 摘要

在本章中，你学习了你的应用程序支付授权工作流程中的参与者如何协同工作，以帮助用户提供你处理支付和订单（如果支付卡发行银行批准支付）所需的信息。本章展示了如何准备带有基本支付信息的支付请求，例如你支持的支付网络。它描述了如何响应用户在支付表单中对订单所做的更改。最后，本章展示了在用户授权或取消支付请求后如何关闭支付表单。

下一章将描述支付处理工作流程，这是你将处理在此处获得的信息，通过你的支付网关处理支付并在你的订单处理Web应用程序中履行客户订单的地方。我们将考虑获取用户支付卡发行银行批准交易所需的支付信息。
