<html><head></head><body><div class="chapter" title="Chapter&#xA0;1.&#xA0;Getting Started with Apple Pay"><div class="titlepage"><div><div><h1 class="title"><a id="ch01"/>Chapter 1. Getting Started with Apple Pay</h1></div></div></div><p>Apple Pay is a mobile payment <a id="id0" class="indexterm"/>system that lets iPhone users pay for goods and services using Touch ID. Instead of entering or confirming payment card information (credit or debit card) every time they make a purchase, users can authorize payment for items securely by touching the Home button. It is important to note that during an Apple Pay transaction, payment card information never leaves the user's phone; this information is stored securely in the device. Instead, a payment token stores all the information you need to process the payment all the way from authorization to settlement (that is, when the user's funds are transferred to your merchant bank account).</p><p>Using Apple Pay, you do not<a id="id1" class="indexterm"/> have to store your customers' payment card information on your servers. This helps reduce your customers' misgivings about paying for goods within your app; they trust that their payment card information is secure in their devices. You benefit by not having to deal with payment card information at all, at least not for Apple Pay-based transactions. (When a user's device does not support Apple Pay, or the user has not yet added payment cards to the device, you may have to process payment using regular means, which may involve capturing and storing payment card information.)</p><p>Although you are freed from storing payment card details on your systems, you still have to deal with processing the payments, either directly or through a payment gateway. In either case, you need to get an Apple Pay merchant identifier and certificate to decrypt the payment token that Apple Pay creates with a transaction's payment information. To use Apple Pay in your app, you need to enable the Apple Pay capability in your project, which requires the Apple Pay merchant identifier.</p><p>This chapter describes how <a id="id2" class="indexterm"/>online payments work, online payments being a web-centric version of the traditional <span class="strong"><strong>Electronic Draft Capture</strong></span> (<span class="strong"><strong>EDC</strong></span>) system used to process credit card transactions. You will also learn the basics of the Apple Pay payment workflow, starting with displaying the <span class="strong"><strong>Apple Pay</strong></span> button when Apple Pay is available on the user's device, presenting the Apple Pay payment sheet, and processing the transaction on your servers.</p><p>This chapter will do the following:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">Provide an overview of the online payment process</li><li class="listitem" style="list-style-type: disc">Introduce the Apple Pay payment workflow</li><li class="listitem" style="list-style-type: disc">Show you how to create an Apple Pay merchant identifier and certificate</li><li class="listitem" style="list-style-type: disc">Describe how to turn on the Apple Pay capability for an app in Xcode</li></ul></div><div class="section" title="An overview of the online payment process"><div class="titlepage"><div><div><h1 class="title"><a id="ch01lvl1sec12"/>An overview of the online payment process</h1></div></div></div><p>Customers <a id="id3" class="indexterm"/>usually carry payment cards (debit or credit cards) in purses or wallets, which they use to pay for goods and services. When a cardholder pays a merchant with a payment card, the merchant usually uses a payment gateway to process the payment. A payment gateway is an e-commerce service that authorizes payment card-based<a id="id4" class="indexterm"/> transactions. The <span class="emphasis"><em>payment gateway</em></span> performs several tasks to process the transaction, but it's its main task is the encryption of payment card information before submitting the transaction for authorization<a id="id5" class="indexterm"/> to a payment processor. A <span class="emphasis"><em>payment processor</em></span> interacts with the bank that issued the customer's card (known as the <span class="emphasis"><em>issuing bank</em></span> or <span class="emphasis"><em>issuer</em></span>) that ultimately authorizes or declines the transaction. The payment processor may be implemented by the payment gateway, a third party, or the merchant. A merchant <a id="id6" class="indexterm"/>would implement a custom payment processor to, for example, integrate with a custom inventory and ordering system.</p><p>Merchants that do not manage inventory may deal only with a payment gateway. Payment gateways provide libraries or frameworks that apps can link to. When processing a payment, the app hands off a payment token to the library, which processes the payment and <a id="id7" class="indexterm"/>returns the result (<span class="emphasis"><em>authorized</em></span> or <span class="emphasis"><em>declined</em></span>) to the app. The gateway performs all the tasks necessary to authorize the transaction and transfer the payment amount from the card issuer to the merchant's acquiring bank. The <a id="id8" class="indexterm"/>
<span class="emphasis"><em>acquiring bank </em></span> (also known as the <span class="emphasis"><em>acquirer</em></span>) is the bank that receives the cardholder's payments and credits them to the merchant's bank account (which is a special type of account used to receive payment from payment cards, also known as a <span class="emphasis"><em>merchant account</em></span>).</p><p>Merchants that need to integrate with custom ordering and inventory management systems need a more hands-on approach to payment processing. This is the scenario discussed in this book.</p><p>First, let's talk about how<a id="id9" class="indexterm"/> online payment systems work. The payment process takes place in two phases:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">Authorization</li><li class="listitem" style="list-style-type: disc">Settlement</li></ul></div><p>In a successful authorization, an <a id="id10" class="indexterm"/>
<span class="emphasis"><em>authorization hold</em></span> is placed on the customer's card, reserving the funds that finance the transaction. Later, the merchant consumes or settles the transaction to transfer the funds from the customer's card into the merchant's account.</p><p>The following steps describe the authorization process:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">The customer presents a<a id="id11" class="indexterm"/> payment card to pay for a product or service.</li><li class="listitem">The merchant encrypts<a id="id12" class="indexterm"/> the card's information and sends an authorization request to the payment gateway.</li><li class="listitem">The payment gateway then forwards the authorization request to the payment processor.</li><li class="listitem">The payment processor forwards the authorization request to the appropriate payment card association (Visa, MasterCard, American Express, Discover, and so on).</li><li class="listitem">The card association forwards the authorization request to the issuing bank, which ultimately approves or declines the transaction. Some card associations, such as Discover and American Express, are also issuing banks.</li><li class="listitem">The issuing bank receives the authorization request from the payment processor and sends its response (<span class="emphasis"><em>authorized</em></span> or <span class="emphasis"><em>declined</em></span>) to the payment processor. The<a id="id13" class="indexterm"/> issuing bank then holds a <span class="emphasis"><em>transaction authorization</em></span> or authorization hold that links the merchant, payment card, and amount approved (the funds are reserved but not debited from the cardholder's account).</li><li class="listitem">The payment processor forwards the issuing bank's response to the payment gateway.</li><li class="listitem">The payment gateway, in turn, forwards the response to the merchant, who relays the information to the cardholder.</li></ol></div><p>Either immediately, or at the end of the day, the merchant starts the <span class="emphasis"><em>settlement</em></span> process to receive the funds. This process is <a id="id14" class="indexterm"/>similar to the procedure used to request the payment authorization; however, instead of authorizing the transaction, the issuing bank moves the authorization hold to a debit and prepares the transaction for <a id="id15" class="indexterm"/>settlement with the acquiring bank:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">The merchant submits the approved authorization to its acquiring bank through the payment processor.</li><li class="listitem">The acquiring bank makes a settlement request to the issuing bank.</li><li class="listitem">The issuing bank makes a settlement payment to the acquiring bank.</li><li class="listitem">The acquiring bank deposits the approved amount into the merchant's bank account.</li></ol></div></div></div>
<div class="section" title="The Apple Pay payment workflow"><div class="titlepage"><div><div><h1 class="title"><a id="ch01lvl1sec13"/>The Apple Pay payment workflow</h1></div></div></div><p>If you develop an app<a id="id16" class="indexterm"/> that is capable of interacting with a payment gateway to<a id="id17" class="indexterm"/> process payment cards, you or your company is a <span class="emphasis"><em>merchant</em></span>, and the app is a <span class="emphasis"><em>merchant app</em></span>.</p><p>This is an overview of the payment workflow:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem"><span class="strong"><strong>Present the </strong></span><span class="strong"><strong>Apple</strong></span><span class="strong"><strong> Pay button</strong></span>: Present this<a id="id18" class="indexterm"/> button only if the user can make Apple Pay payments.</li><li class="listitem"><span class="strong"><strong>Create the payment request</strong></span>: This request<a id="id19" class="indexterm"/> contains essential payment information and details about the order.</li><li class="listitem"><span class="strong"><strong>Present the payment sheet</strong></span>: This<a id="id20" class="indexterm"/> sheet presents order information that the user can modify, such as shipping information.</li><li class="listitem"><span class="strong"><strong>Respond to changes by the user</strong></span>: As the <a id="id21" class="indexterm"/>user makes changes, update items such as shipping costs and discounts.</li><li class="listitem"><span class="strong"><strong>Submit payment information to payment gateway</strong></span>: When the user authorizes the payment<a id="id22" class="indexterm"/> request, submit the payment and order information to the appropriate systems.</li></ol></div><div class="section" title="Presenting the Apple Pay button"><div class="titlepage"><div><div><h2 class="title"><a id="ch01lvl2sec02"/>Presenting the Apple Pay button</h2></div></div></div><p>When a user<a id="id23" class="indexterm"/> reaches a screen in your app that lets the user purchase something, the app should present the <span class="strong"><strong>Apple</strong></span> <span class="strong"><strong>Pay</strong></span> button (if the user can use<a id="id24" class="indexterm"/> Apple Pay on the device) so that the user can tap the button, verify the purchase details, and authorize the app through Touch ID to complete the order and charge the order amount to the appropriate payment card. Deciding whether the user can use Apple Pay involves two steps:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">Determining whether the device supports Apple Pay</li><li class="listitem" style="list-style-type: disc">Determining whether the user has added payment cards that you support to the device<div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="tip02"/>Tip</h3><p>Your app must make both checks before displaying the <span class="strong"><strong>Apple</strong></span> <span class="strong"><strong>Pay</strong></span> button. If either check fails, the app must not present the <span class="strong"><strong>Apple</strong></span> <span class="strong"><strong>Pay</strong></span> button. Instead, it should offer a traditional payment method (such as obtaining a credit card number and a shipping address) through a Buy button.</p></div></div></li></ul></div></div><div class="section" title="Creating the payment request"><div class="titlepage"><div><div><h2 class="title"><a id="ch01lvl2sec03"/>Creating the payment request</h2></div></div></div><p>If the user can use Apple <a id="id25" class="indexterm"/>Pay, your app prepares a payment request. A <span class="emphasis"><em>payment request</em></span> is an object that describes the items to charge for, the card associations that you support, and billing and shipping information.</p><p>The main components of a<a id="id26" class="indexterm"/> payment request are <span class="emphasis"><em>payment summary items</em></span>, which describe the payment request to the user. A payment summary item represents a component of the transaction, such as the subtotal, a discount, shipping cost, tax, and the grand total. Each item has a label that describes <a id="id27" class="indexterm"/>what each amount means. The last item is the most important because it identifies the payee and the debit amount that the user will see in the next payment card statement. Therefore, this item should have your company's name as its label.</p><p>In addition to the payment summary items, your app sets properties of the payment request that describe which card associations and online payment protocols you support. Your app must support at least<a id="id28" class="indexterm"/> the 3D Secure protocol. The <span class="strong"><strong>EMV</strong></span> (<span class="strong"><strong>Europay, MasterCard, and Visa</strong></span>) protocol is optional.</p><p>The payment request also lets you indicate that you want the user to specify particular order details, such as shipping or billing information. For example, you may require an e-mail or postal address.</p><p>If your ordering system requires additional information, such as the order number, you can include this information in the payment request as custom application data. Apple Pay includes a hash of this information in the payment token you receive when the user authorizes the payment. If your ordering system requires this information later, your app must be able to provide it separately.</p></div><div class="section" title="Presenting the payment sheet"><div class="titlepage"><div><div><h2 class="title"><a id="ch01lvl2sec04"/>Presenting the payment sheet</h2></div></div></div><p>Once your app<a id="id29" class="indexterm"/> creates the payment request and the<a id="id30" class="indexterm"/> user taps the <span class="strong"><strong>Apple Pay</strong></span> button, the app presents a payment sheet to the user. The <span class="emphasis"><em>payment sheet</em></span> (formally known as the <span class="emphasis"><em>payment authorization view controller</em></span>) presents the<a id="id31" class="indexterm"/> payment summary items in the payment request to the user for review. The user can change aspects of the order before authorizing payment. The user may also decide not to purchase the goods and cancel the<a id="id32" class="indexterm"/> transaction.</p></div><div class="section" title="Responding to order changes and payment authorization"><div class="titlepage"><div><div><h2 class="title"><a id="ch01lvl2sec05"/>Responding to order changes and payment authorization</h2></div></div></div><p>Your app implements a <a id="id33" class="indexterm"/>delegate of the payment sheet to<a id="id34" class="indexterm"/> respond to the user's actions by, for example, updating the order shipping cost and grand total when the user chooses a different shipping method.</p><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="note02"/>Note</h3><p>When the user authorizes the payment request with Touch ID, Apple Pay interacts with the device's secure element (the chip that securely stores payment card details on the device, details that not even Apple has access to) and Apple's servers to generate a one-time-use payment token. The <span class="emphasis"><em>payment information</em></span> describes the payment transaction and contains all the information needed to charge the payment amount to the user's payment card (but this does not contain card numbers).</p><p>Apple encrypts the <a id="id35" class="indexterm"/>information in the<a id="id36" class="indexterm"/> token on its servers using your merchant certificate.</p></div></div></div><div class="section" title="Submitting the payment information to the payment gateway"><div class="titlepage"><div><div><h2 class="title"><a id="ch01lvl2sec06"/>Submitting the payment information to the payment gateway</h2></div></div></div><p>When the payment sheet tells its delegate that the user has authorized the payment request and sends the user the <a id="id37" class="indexterm"/>payment information, the delegate calls a synchronous method that forwards the payment information to your payment gateway. When the method returns, it provides the delegate with the result of the payment request. If the payment request is approved, the payment sheet displays a confirmation to the user that the transaction is approved and informs its delegate. The delegate then dismisses the payment sheet and displays a custom confirmation screen; such a screen may display the order number and a <span class="emphasis"><em>thank you</em></span> message. If the payment request is not approved, the delegate must display an appropriate screen and ask the user for another form of payment.</p></div></div>
<div class="section" title="Enabling Apple Pay in your app"><div class="titlepage"><div><div><h1 class="title"><a id="ch01lvl1sec14"/>Enabling Apple Pay in your app</h1></div></div></div><p>For your <a id="id38" class="indexterm"/>app to be able to use Apple Pay, you must have an Apple merchant identifier and merchant certificate. Apple uses the certificate to encrypt payment information<a id="id39" class="indexterm"/> in the payment token. Your payment gateway (Stripe, Worldpay, and so on) uses the certificate to decrypt information in the payment token.</p><div class="section" title="Creating your app's Apple Pay merchant identifier"><div class="titlepage"><div><div><h2 class="title"><a id="ch01lvl2sec07"/>Creating your app's Apple Pay merchant identifier</h2></div></div></div><p>You must have access to your team's <span class="strong"><strong>Member Center</strong></span> portal and your payment gateway's certificate <a id="id40" class="indexterm"/>management facilities.</p><p>Create your merchant<a id="id41" class="indexterm"/> identifier in your team's <span class="strong"><strong>Member Center</strong></span> page through the following steps:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">In <span class="strong"><strong>Member Center</strong></span>, click on <span class="strong"><strong>Certificates, Identifiers &amp; Profiles</strong></span>.</li><li class="listitem">Under <span class="strong"><strong>iOS Apps</strong></span>, click on <span class="strong"><strong>Identifiers</strong></span>.</li><li class="listitem">Under <span class="strong"><strong>Identifiers</strong></span>, click on <span class="strong"><strong>Merchant IDs</strong></span>.</li><li class="listitem">Click on <span class="strong"><strong>Continue</strong></span> (if this is your first merchant identifier) or on the plus sign (<span class="strong"><strong>+</strong></span>) button in the upper-right corner of the page.</li><li class="listitem">Enter a description for the merchant identifier in the <span class="strong"><strong>Description</strong></span> field, for example <code class="literal">MerchantApp merchant identifier</code>.</li><li class="listitem">Enter the identifier string in the ID field, for example <code class="literal">merchant.com.company.merchantapp</code>.</li><li class="listitem">Click on <span class="strong"><strong>Continue</strong></span> and then click on <span class="strong"><strong>Register</strong></span>.</li><li class="listitem">Click on <span class="strong"><strong>Done</strong></span>.</li></ol></div><p>Request an Apple Pay certificate from your payment gateway by performing the following:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">In your payment gateway's certificate management page, create an Apple Pay certificate.</li><li class="listitem">Download the<a id="id42" class="indexterm"/> <span class="strong"><strong>Certificate Signing Request</strong></span> (<span class="strong"><strong>CSR</strong></span>) file to your Mac.</li></ol></div><p>Now, follow these steps to create your app merchant certificate in Member Center:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">In the <span class="strong"><strong>Certificates, Identifiers &amp; Profiles</strong></span> page, under <span class="strong"><strong>iOS Apps</strong></span>, under <span class="strong"><strong>Certificates</strong></span>, click on <span class="strong"><strong>All</strong></span>.</li><li class="listitem">Then, select <span class="strong"><strong>Apple Pay Certificate</strong></span> and click on <span class="strong"><strong>Continue</strong></span>.</li><li class="listitem">Under<span class="strong"><strong> Which Merchant ID would you like to use?</strong></span>, select the appropriate merchant identifier and click on <span class="strong"><strong>Continue</strong></span>.</li><li class="listitem">Under <span class="strong"><strong>Generate your certificate</strong></span>, click on <span class="strong"><strong>Choose File</strong></span>.</li><li class="listitem">Choose the CSR file you obtained from your payment gateway.</li><li class="listitem">Next, click on <span class="strong"><strong>Generate</strong></span> and then click on <span class="strong"><strong>Download</strong></span> to download your app merchant certificate to your Mac.</li></ol></div><p>Upload your app merchant certificate to your payment gateway via the following steps:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">In your payment gateway's certificate management page, upload the merchant certificate you downloaded from the <span class="strong"><strong>Member Center</strong></span> portal.</li><li class="listitem">Confirm that your merchant <a id="id43" class="indexterm"/>certificate is listed in your payment gateway account.</li></ol></div></div><div class="section" title="Installing your app's Apple Pay merchant certificate on your Mac"><div class="titlepage"><div><div><h2 class="title"><a id="ch01lvl2sec08"/>Installing your app's Apple Pay merchant certificate on your Mac</h2></div></div></div><p>Double-click on the <a id="id44" class="indexterm"/>merchant certificate you downloaded <a id="id45" class="indexterm"/>earlier from <span class="strong"><strong>Member Center</strong></span>. <span class="strong"><strong>Keychain Access</strong></span> will then open and install the certificate along with your other <a id="id46" class="indexterm"/>certificates.</p></div><div class="section" title="Enabling Apple Pay in your app's Xcode project"><div class="titlepage"><div><div><h2 class="title"><a id="ch01lvl2sec09"/>Enabling Apple Pay in your app's Xcode project</h2></div></div></div><p>To provide your app <a id="id47" class="indexterm"/>with access to Apple Pay, you need to turn on<a id="id48" class="indexterm"/> the Apple Pay capability in the Xcode project. Perform the following:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">First, open your project in Xcode.</li><li class="listitem">Select the target that builds the app to open the target editor.</li><li class="listitem">Then, click on <span class="strong"><strong>Capabilities</strong></span>.</li><li class="listitem">Find the <span class="strong"><strong>Apple Pay</strong></span> capability and toggle the corresponding switch to its on position.</li><li class="listitem">In the dialog that appears, select the appropriate development team, and click on <span class="strong"><strong>Choose</strong></span>.<div class="mediaobject"><img src="graphics/B05093_01_01.png.jpg" alt="Enabling Apple Pay in your app's Xcode project"/></div></li></ol></div></div></div>
<div class="section" title="Summary"><div class="titlepage"><div><div><h1 class="title"><a id="ch01lvl1sec15"/>Summary</h1></div></div></div><p>In this chapter, you learned about the online payment process followed by merchants to obtain card-based payments. The chapter introduced general online payment concepts to describe how an app uses Apple Pay to perform a similar function but more securely. Finally, you learned how to create the Apple Pay merchant identifier and merchant certificate to enable Apple Pay payment in your apps.</p><p>The next chapter focuses on the payment request workflow, where you present the <span class="strong"><strong>Apple</strong></span>
<span class="strong"><strong> Pay</strong></span> button when Apple Pay is available on the device, create the payment request, and present the payment sheet based on that request.</p></div></body></html>