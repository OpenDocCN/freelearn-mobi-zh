<html><head></head><body>
      
      <section>
         
         
         <header>
            
            <h1 class="header-title">SiriKit</h1>
            
         </header>
         
         
         <article>
            
            
            <p>Last year, Apple announced the addition of a new framework called <strong>SiriKit</strong>. This framework allows developers to leverage Siri in their apps. For the last year,
               SiriKit has been slowly adopted by developers. This year, Apple added even more supported
               domains. In this chapter, we are going to add SiriKit support to our app.
            </p>
            
            <p>My original goal was to have Siri set up restaurant reservations, but unfortunately,
               Apple software requires this feature to be done using MapKit. Using MapKit is not
               the real issue, though. The real issue is that you have to work with Apple to get
               this set up so that we cannot make restaurant reservations. If you are working on
               an app that needs this feature, then you need to contact Apple support. In this chapter,
               we are going to set up the framework so that we have the ability to request money
               from someone. The setup for SiriKit is quite similar, so once you are comfortable
               doing this chapter, you should not have a problem working through the others. Please
               note that to use SiriKit, you must have a developer license to run Siri on your device.
            </p>
            
            <p>We will cover the following topics in this chapter:</p>
            
            <ul>
               
               <li>Understanding SiriKit</li>
               
               <li>Working with SiriKit extensions</li>
               
               <li>Working with SiriKit UI extensions</li>
               
            </ul>
            
            
            
         </article>
         
         
         
      </section>
      
   

      
      <section>
         
         
         <header>
            
            <h1 class="header-title">Understanding SiriKit</h1>
            
         </header>
         
         
         <article>
            
            
            <p><span>We first need to understand how Siri interacts with our app before we get started. Have
                  a look at how it works through this diagram:</span></p>
            
            <div class="packt_figure CDPAlignCenter CDPAlign"><img height="538" src="assets/1a37fc7d-2d68-4cbf-88f3-5e627f694aaf.png" width="792"/></div>
            
            <p>A user interacts with Siri to compose a request. Siri takes the request and looks
               through the intents for the requesting app. If the app is not found, Siri lets you
               know. If the app is found, but cannot do what was requested, Siri will notify you
               that the request cannot be done at this time. If the intent can be handled by the
               app, it will pass the information to your app. Your app does what it needs to do with
               that information and reports back to Siri. If the app needs further information, it
               lets Siri know what to request until the app has everything it needs or the user cancels
               the request.
            </p>
            
            
            
         </article>
         
         
         
      </section>
      
   

      
      <section>
         
         
         <header>
            
            <h1 class="header-title">Supported intents</h1>
            
         </header>
         
         
         <article>
            
            
            <p>As of iOS 11, Apple currently supports the following intents:</p>
            
            <ul>
               
               <li>VoIP Calling (initiate calls and search the user's call history)</li>
               
               <li>Messaging (send messages and search the user's received messages)</li>
               
               <li>Payments (send payments between users or pay bills)</li>
               
               <li>Lists and notes (create and manage notes and to-do list items)</li>
               
               <li>Visual Codes (convey contact and payment information using Quick Response (QR) codes)</li>
               
               <li>Photos (search for and display photos)</li>
               
               <li>Workouts (start, end, and manage fitness routines)</li>
               
               <li>Ride booking (book rides and report their status)</li>
               
               <li>Car commands (manage vehicle door locks and get the vehicle's status)</li>
               
               <li>CarPlay (interact with a vehicle's CarPlay system)</li>
               
               <li>Restaurant reservations (create and manage restaurant reservations with help from
                  the <em>Maps</em> app)
               </li>
               
            </ul>
            
            <p>This API requires you to work with Apple Maps before your app can use it. For information
               on how to get started, go to <a href="http://mapsconnect.apple.com">http://mapsconnect.apple.com</a>.
            </p>
            
            <p>We are going to use the Payment intent, which allows us to send payments between users
               or pay bills. When we are done, we can just say <em>Hey Siri! Send $100 to Jason Clayton for dinner last night using LetsEat</em>. We can hook this up to any banking system, but at the moment, we have everything
               else set up for this. Let's get started.
            </p>
            
            
            
         </article>
         
         
         
      </section>
      
   

      
      <section>
         
         
         <header>
            
            <h1 class="header-title">Enable Siri capabilities</h1>
            
         </header>
         
         
         <article>
            
            
            <p>The first thing we need to do is enable SiriKit:</p>
            
            <ol>
               
               <li>In Xcode, go to your app and select the <span class="packt_screen">LetsEat</span> target:
               </li>
               
            </ol>
            
            <div class="packt_figure CDPAlignCenter CDPAlign"><img height="269" src="assets/e2fa805d-b167-4957-b7d9-db485ff042f5.png" width="475"/></div>
            
            <ol start="2">
               
               <li>Next, click on the <span class="packt_screen">Capabilities</span> tab:
               </li>
               
            </ol>
            
            <div class="packt_figure CDPAlignCenter CDPAlign"><img height="142" src="assets/dc643328-48ea-4c9c-ba38-22da0f50743b.png" width="802"/></div>
            
            <ol start="3">
               
               <li>Then, hit the switch for Siri to switch it to <span class="packt_screen">ON</span>:
               </li>
               
            </ol>
            
            <div class="packt_figure CDPAlignCenter CDPAlign"><img height="204" src="assets/3b32341e-041c-4b65-9c62-2927de84aca4.png" width="816"/></div>
            
            <ol start="4">
               
               <li>You should see the following when you are done:</li>
               
            </ol>
            
            <div class="packt_figure CDPAlignCenter CDPAlign"><img height="209" src="assets/46567912-929b-42e5-86f6-3dabdff93f17.png" width="816"/></div>
            
            <ol start="5">
               
               <li>You need a working developer account to do the following steps. Otherwise, you will
                  see errors when trying to follow along. Next, we need to add a new target to our project.
                  At the bottom of the <span class="packt_screen">TARGETS</span> section, you should see a <span class="packt_screen">+</span> button.
               </li>
               
            </ol>
            
            <div class="packt_figure CDPAlignCenter CDPAlign"><img height="608" src="assets/f521c703-fd52-4903-b2fc-90280d2a87a0.png" width="185"/></div>
            
            <ol start="6">
               
               <li>Click the <span class="packt_screen">+</span> button, and you will see the following screen:
               </li>
               
            </ol>
            
            <div class="packt_figure CDPAlignCenter CDPAlign"><img height="496" src="assets/e050088d-d35f-43da-9047-4666b05bf056.png" width="689"/></div>
            
            <ol start="7">
               
               <li>Next, select <span class="packt_screen">Intents Extension</span> under the <span class="packt_screen">iOS</span> tab. Then hit <span class="packt_screen">Next</span>.
               </li>
               
               <li>In the <span class="packt_screen">Options</span> screen that appears, there are some fields to fill out or choose. Add the following
                  to the <span class="packt_screen">Options</span> screen and then hit <span class="packt_screen">Next</span>:
               </li>
               
            </ol>
            
            <ul>
               
               <li style="list-style-type: none">
                  
                  <ul>
                     
                     <li><span class="packt_screen">Product Name</span>: <kbd>MakePayment</kbd></li>
                     
                     <li><span class="packt_screen">Team</span>: Must have a team
                     </li>
                     
                     <li><span class="packt_screen">Organization Name</span>: Your name/company name
                     </li>
                     
                     <li><span class="packt_screen">Organization Identifier</span>: Your domain name in reverse order
                     </li>
                     
                     <li><span class="packt_screen">Language</span>: <kbd>Swift</kbd></li>
                     
                     <li><span class="packt_screen">Include UI Extension</span>: Checked
                     </li>
                     
                     <li><span class="packt_screen">Project</span>: <kbd>LetsEat</kbd></li>
                     
                     <li><span class="packt_screen">Embed in Application</span>: <kbd>LetsEat</kbd></li>
                     
                  </ul>
                  
               </li>
               
            </ul>
            
            <p style="padding-left: 60px">This is how it should look:</p>
            
            <div class="CDPAlignCenter CDPAlign"><img height="527" src="assets/3b02e56e-ff3b-401c-95bb-94cd998b5838.png" width="732"/></div>
            
            <p>When you have finished, we will have two extensions added to our project: the <kbd>MakePayment</kbd> and <kbd>MakePaymentUI</kbd> extensions. These extensions are what we will use to add SiriKit to your project.
               We need to edit these extensions so that they can accept payments:
            </p>
            
            <ol>
               
               <li>Open the <kbd>MakePayment</kbd> folder and select the <kbd>Info.plist</kbd> file.
               </li>
               
               <li>Open all of the disclosure arrows under <kbd>NSExtension</kbd>. When they are all open, you should see the following:
               </li>
               
            </ol>
            
            <div class="CDPAlignCenter CDPAlign"><img height="329" src="assets/8e6d5710-8066-42e4-98a9-26433f351371.png" width="758"/></div>
            
            <p style="padding-left: 60px">Currently, the app is set up to use the <span class="packt_screen">Send Message</span> intent, and we want to use the <span class="packt_screen">Send Payment</span> intent.
            </p>
            
            <ol start="3">
               
               <li>Under <kbd>IntentsSupported</kbd>, delete <kbd>Item 1 (INSearchForMessagesIntent)</kbd> and <kbd>Item 2 (INSetMessageAttributeIntent)</kbd>:
               </li>
               
            </ol>
            
            <div class="CDPAlignCenter CDPAlign"><img height="320" src="assets/52e6fb1e-f237-42cd-912d-51a69366c45e.png" width="737"/></div>
            
            <ol start="4">
               
               <li>Now, for <kbd>Item 0</kbd>, change <kbd>INSendMessageIntent</kbd> to <kbd>INSendPaymentIntent</kbd>.
               </li>
               
               <li>Under <kbd>IntentsRestrictedWhileLocked</kbd>, add <kbd>INSendPaymentIntent</kbd> by clicking the <span class="packt_screen">+</span> button:
               </li>
               
            </ol>
            
            <div class="packt_figure CDPAlignCenter CDPAlign"><img height="274" src="assets/acecb8b6-1cd9-464b-94d3-d92fc5779b4d.png" width="464"/></div>
            
            <ol start="6">
               
               <li>When finished, you should see the following:</li>
               
            </ol>
            
            <div class="packt_figure CDPAlignCenter CDPAlign"><img height="263" src="assets/78099d80-c50d-45f5-b7aa-75fe1026938c.png" width="499"/></div>
            
            <ol start="7">
               
               <li>Next, open up <kbd>Info.plist</kbd> under the <kbd>MakePaymentUI</kbd> folder, open all the disclosure arrows under <kbd>NSExtension</kbd>, and change <kbd>INSendMessageIntent</kbd> under <kbd>IntentsSupported</kbd> to <kbd>INSendPaymentIntent</kbd>:
               </li>
               
            </ol>
            
            <div class="packt_figure CDPAlignCenter CDPAlign"><img src="assets/84c8e407-a9dd-43ea-bd16-36d928c48a4c.png"/></div>
            
            <p>We have finished setting up our plist. Whenever we access something, we always have
               to ask permission, just like we did earlier when we accessed the user's photos. In
               the <kbd>Info.plist</kbd> file of the <em>LetsEat</em> app, we need to update our plist to let users know that we need access for Siri and
               our reason. Add the <kbd>NSSiriUsageDescription</kbd> key.
            </p>
            
            <p>For the key value, enter anything you want as an alert that the user sees. In the
               following example, the value is set as <kbd>This app uses Siri to send payments.</kbd>:
            </p>
            
            <div class="CDPAlignCenter CDPAlign"><img height="370" src="assets/54f226f0-d50f-4920-a5be-a7511a6674b2.png" width="823"/></div>
            
            <p>Now, inside of your <kbd>AppDelete</kbd>, add the following import after <kbd>import UIKit</kbd>:
            </p>
            <pre>import Intents </pre>
            <p>Next, after <kbd>setupDefaultColors()</kbd>, add the following method:
            </p>
            <pre>func requestSiriPermissions() { 
    INPreferences.requestSiriAuthorization({ (status) in 
        print(status) 
    }) 
} </pre>
            <p>Then, in your <kbd>-application:didFinishLaunchingWithOptions:</kbd> under <kbd>setupDefaultColors()</kbd>, add <kbd>requestSiriPermissions()</kbd>.
            </p>
            
            <p>Adding this asks the user for permission to use Siri. Now, if you are going to use
               this in a real app, I would say that you should add a <span class="packt_screen">Settings</span> section where users can use a switch to turn Siri on or off. You do not want to force
               users to use something without really giving them a reason. In iOS, once you ask a
               user for permission and they decline, they have to go into the <span class="packt_screen">Settings</span> section. If you want to ask, then it is better to have another dialog box that asks
               for permission; if they say yes, then run the request, and if the users say no, then
               you do nothing. This way you do not have to force your users to go to the phone settings
               to turn this feature on. Now that we have our permissions set up, we need to create
               users that we can send money to.
            </p>
            
            
            
         </article>
         
         
         
      </section>
      
   

      
      <section>
         
         
         <header>
            
            <h1 class="header-title">Creating users</h1>
            
         </header>
         
         
         <article>
            
            
            <p>When using SiriKit, it needs to have an <kbd>INPerson</kbd> object. An <kbd>INPerson</kbd> object is used by Siri to send users things—money in our case. Let's create this
               new file:
            </p>
            
            <ol>
               
               <li>Right-click the <kbd>Misc</kbd> folder and select <span class="packt_screen">New File</span>.
               </li>
               
               <li>Inside of the <span class="packt_screen">Choose a template for your new file</span> screen, select <span class="packt_screen">iOS</span> at the top, and then <span class="packt_screen">Swift</span>. Then, hit <span class="packt_screen">Next</span>.
               </li>
               
               <li>Save the file as <kbd>RestaurantContact</kbd>.
               </li>
               
               <li>Click <span class="packt_screen">Create</span>.
               </li>
               
               <li>Add the following code to this file:</li>
               
            </ol>
            <pre>import Intents 
 
struct RestaurantContact { 
    let name: String 
    let email: String 
     
    static func allContacts() -&gt; [RestaurantContact] { 
        return [ 
            RestaurantContact(name: "Jason Clayton", email: "jason@mac.com"), 
            RestaurantContact(name: "Joshua Clayton", email: "joshua@texas.edu"), 
            RestaurantContact(name: "Teena Harris", email: "teena@gmail.com") 
        ] 
    } 
     
    func inPerson() -&gt; INPerson { 
        let formatter = PersonNameComponentsFormatter() 
        let handle = INPersonHandle(value: email, type: .emailAddress) 
         
        if let components = formatter.personNameComponents(from: name) { 
            return INPerson(personHandle: handle, nameComponents: components, displayName: components.familyName, image: nil, contactIdentifier: nil, customIdentifier: nil) 
        } 
        else { 
            return INPerson(personHandle: handle, nameComponents: nil, displayName: nil, image: nil, contactIdentifier: nil, customIdentifier: nil) 
        } 
    } 
} </pre>
            <p>Here, we are creating contacts that we can use to ask Siri to send money. We have
               set up three people to accept money at this time: Jason Clayton, Joshua Clayton, and
               Teena Harris. When we request with Siri, these are the names that it looks for to
               see if the person exists. If the name is not in this list, Siri lets you know that
               the name is not found. This list can have any name you wish to have, so if you want
               to change the names to something else, you can do that now. Just make sure that when
               we get to the requesting section, you change the name there as well. Our <kbd>inPerson()</kbd> method is just formatting into a format that SiriKit needs to be able to read the
               object. We now need to add code that runs when the send payment intent is invoked.
            </p>
            
            
            
         </article>
         
         
         
      </section>
      
   

      
      <section>
         
         
         <header>
            
            <h1 class="header-title">Updating our intent handler</h1>
            
         </header>
         
         
         <article>
            
            
            <p>We can now finally add our code that runs when the <span class="packt_screen">Send Payment</span> intent is invoked. Open the <kbd>IntentHandler</kbd> class inside of the <kbd>MakePayment</kbd> extension folder. After the import intents line deletes everything else from this
               file, add the following code:
            </p>
            <pre>class IntentHandler: INExtension{ 
     
    override func handler(for intent: INIntent) -&gt; Any { 
        if intent is INSendPaymentIntent { 
            return SendMoneyIntent() 
        } 
         
        return self 
    } 
} </pre>
            <p>Here, we are creating a custom intent handler. When the intent is to send payment,
               we want to run our <kbd>SendMoneyIntent</kbd> class. We need to create this file next. In the same file direction under the <kbd>IntentHandler</kbd> class, add the following:
            </p>
            <pre>class SendMoneyIntent: NSObject, INSendPaymentIntentHandling { 
    func handle(intent: INSendPaymentIntent, completion: @escaping (INSendPaymentIntentResponse) -&gt; Void) { 
        if let person = intent.payee, let amount = intent.currencyAmount { 
            //handle payment 
            print("person (person.displayName) - amount (String(describing: amount.amount))") 
             
            completion(INSendPaymentIntentResponse(code: .success, userActivity: nil)) 
        } 
        else { 
            completion(INSendPaymentIntentResponse(code: .failure, userActivity: nil)) 
        } 
    } 
 
} </pre>
            <p>In this class, the <kbd>handle()</kbd> method responds to a <kbd>SendPaymentIntent</kbd>. We are printing the person's display name and amount. We pass a completion block
               here, but in real production code, you would run whatever API you are using to verify
               the payment. Add the following inside of the <kbd>SendMoney</kbd> intent under the <kbd>handle()</kbd> method:
            </p>
            <pre>func resolvePayee(for intent: INSendPaymentIntent, with completion: @escaping (INPersonResolutionResult) -&gt; Void) { 
     
    if let payee = intent.payee { 
        let contacts:[RestaurantContact] = RestaurantContact.allContacts() 
        var result: INPersonResolutionResult? 
        var matchedContacts:[RestaurantContact] = [] 
         
        for contact in contacts { 
            print("checking existing: (contact.name) - (payee.displayName)") 
             
            if contact.name == payee.displayName { 
                matchedContacts.append(contact) 
            } 
             
            switch matchedContacts.count { 
                case 0: 
                    print("no matches") 
                    result = .unsupported() 
                case 1: 
                    print("best matched") 
                    let person = matchedContacts[0].inPerson() 
                    result = INPersonResolutionResult.success(with: person) 
                default: 
                    print("more than one match") 
                    let person:[INPerson] = matchedContacts.map { contact in 
                        return contact.inPerson() 
                    } 
                    result = INPersonResolutionResult.disambiguation(with: person) 
            } 
        } 
         
        completion(result!) 
    } else { 
         
        completion(INPersonResolutionResult.needsValue()) 
    } 
} </pre>
            <p>In this method, we are getting the payee information and checking to see if the person
               matches within our contacts. We are looping through the contacts and looking for a
               match. When completed, we return the result to Siri. If the user is not found, then
               Siri will tell you that the person is not found. If Siri finds the person, then <kbd>PaymentIntent</kbd> continues. Lastly, inside of the <kbd>IntentViewController</kbd>, update the <kbd>desiredSize</kbd> variable to the following:
            </p>
            <pre>var desiredSize: CGSize { 
    return CGSize(width: self.desiredSize.width, height: 150) 
} </pre>
            <p>Here, we are setting the size of the UI to a <kbd>height</kbd> of <kbd>150</kbd>. Let's look at how we can test this.
            </p>
            
            
            
         </article>
         
         
         
      </section>
      
   

      
      <section>
         
         
         <header>
            
            <h1 class="header-title">Testing Siri</h1>
            
         </header>
         
         
         <article>
            
            
            <p>We can test Siri on a device or in the simulator. If you want to test on a device,
               just change the target to the <kbd>MakePayment</kbd> target and plug in your iOS 11 device. If you want to test this in the simulator,
               we need to do the following:
            </p>
            
            <ol>
               
               <li>First, go to <kbd>Settings</kbd> in the iPhone Simulator.
               </li>
               
               <li>Next, select <span class="packt_screen">Siri</span>.
               </li>
               
               <li>Click the switch to enable <span class="packt_screen">Press Home for Siri</span>.
               </li>
               
            </ol>
            
            <p> </p>
            
            <ol start="4">
               
               <li>Select <span class="packt_screen">Enable Siri</span>.
               </li>
               
            </ol>
            
            <p style="padding-left: 60px">Now, you have two options. You can run the app and Siri in the simulator. At this
               point, you can say <kbd>Send $100 to Jason Clayton for dinner last night using LetsEat</kbd> (or you use the name of whomever you added to the contacts we created earlier). Option
               two is that you can enter text that you want to display each time. To set up this
               text, every time you run the app, select the <kbd>MakePayment</kbd> scheme:
            </p>
            
            <div class="packt_figure CDPAlignCenter CDPAlign"><img height="386" src="assets/3fd2a5d1-2938-4db6-96ea-a1fb45c2cd85.png" width="386"/></div>
            
            <ol start="5">
               
               <li>Then, hit the <span class="packt_screen">Scheme</span> dropdown again and select <span class="packt_screen">Edit Scheme...</span>:
               </li>
               
            </ol>
            
            <div class="packt_figure CDPAlignCenter CDPAlign"><img height="63" src="assets/1ae0c8df-1391-496c-9610-4892a7e60063.png" width="392"/></div>
            
            <ol start="6">
               
               <li>Then, under <span class="packt_screen">Siri Intent Query</span>, put in the desired text, such as <kbd>Send $100 to Jason Clayton for dinner last night using LetsEat</kbd>, and then hit <span class="packt_screen">Close</span>:
               </li>
               
            </ol>
            
            <div class="packt_figure CDPAlignCenter CDPAlign"><img height="376" src="assets/01c10095-2700-4278-9dc6-89a21b60cb8d.png" width="780"/></div>
            
            <p style="padding-left: 60px">Remember that we have the <kbd>MakePayment</kbd> scheme. Run the <kbd>MakePayment</kbd> scheme, and the first thing that will happen is that Siri will first ask you for
               permission:
            </p>
            
            <div class="packt_figure CDPAlignCenter CDPAlign"><img height="449" src="assets/b8d1c211-3657-49fe-bb29-6a411f1032cb.png" width="256"/></div>
            
            <ol start="7">
               
               <li>When you accept, Siri will show you your request and ask if you accept it:</li>
               
            </ol>
            
            <div class="packt_figure CDPAlignCenter CDPAlign"><img height="448" src="assets/aaedc26a-1953-4e09-9b45-44e120ba8815.png" width="255"/></div>
            
            <p>When you accept, you will see that your money's been sent. In our example, we are
               not actually sending money, so this step will always goes through:
            </p>
            
            <div class="packt_figure CDPAlignCenter CDPAlign"><img height="438" src="assets/76f6b2b7-6949-498b-995f-640438a04c03.png" width="249"/></div>
            
            <p>Note that the reason Siri is asking for permission is that we are running Siri first
               instead of the app. If we ran the app, we would get the following:
            </p>
            
            <div class="packt_figure CDPAlignCenter CDPAlign"><img height="524" src="assets/a9f2d029-071e-4e91-9ce6-2164e825bda3.png" width="298"/></div>
            
            <p>We are now done. We did not do anything with our UI, but you can add anything you
               want to your UI, such as a logo, a view or display to show to the payee, or whatever
               you decide. Have fun with it and make it your own.
            </p>
            
            
            
         </article>
         
         
         
      </section>
      
   

      
      <section>
         
         
         <header>
            
            <h1 class="header-title">Summary</h1>
            
         </header>
         
         
         <article>
            
            
            <p>In this chapter, we looked at how to integrate Siri into our app. Even though Siri
               is limited to specific intents, we can still find unique ways to use it, such as using
               it for messaging, notes, and lists. The overall setup for each intent is the same—the
               only difference is what you do once the intent hits your app. In the next chapter,
               we will look at how to distribute our app to others for testing, as well as how to
               submit our app to the App Store.
            </p>
            
            
            
         </article>
         
         
         
      </section>
      
   </body></html>