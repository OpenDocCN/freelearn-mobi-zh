<html><head></head><body><div><div><div><div><h1 class="title"><a id="ch05"/>Chapter 5. Designing an Order Management Server</h1></div></div></div><p>If you have a business that provides physical goods to your customers, it is important that you have a reliable order management server. Depending on your customers' needs, you may need to provide access to the server from client apps running on web browsers, web servers, or mobile devices. This book focuses on client apps running on iPhone and iPad devices, and in the Simulator app.</p><p>Generally, a client-/server-based order capture and order processing system has these components:</p><div><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><strong>Server</strong>: This runs<a id="id185" class="indexterm"/> the order processing web app, database management system, and other server-side processes. The web app implements HTTP-based API clients that are used to request and submit information. Through this API, the web app provides product information to clients, and processes payment and order information submitted by clients.</li><li class="listitem" style="list-style-type: disc"><strong>Client</strong>: This runs the<a id="id186" class="indexterm"/> client app. The client app calls the API that the order processing web app provides to request and submit information to the web app.</li></ul></div><p>For the purposes of this book, an <em>order management web app</em> is a process that responds to HTTP requests. In this book's example <a id="id187" class="indexterm"/>project, this process provides inventory and shipping method information to clients and processes the payment information clients submitted to it (which includes information about the item ordered, shipping details, and so on).</p><p>Client apps interact with the server through HTTP requests. In your development environment, the order management web app runs on your development computer, and the client app runs in a simulator or an iOS device that supports Apple Pay.</p><p>This chapter describes the following:</p><div><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">The main characteristics of an order management server</li><li class="listitem" style="list-style-type: disc">Its database structure and client API</li></ul></div><div><div><div><div><h1 class="title"><a id="ch05lvl1sec32"/>Configuring an order management server web app</h1></div></div></div><p>A <em>web server</em> is a <a id="id188" class="indexterm"/>computer that stores information, modifies it, and provides clients with access to it. These clients <a id="id189" class="indexterm"/>can request information or ask the server to process data in a specific way, which can result in a change to the data stored on the server and the client receiving a representation of this data. Practically, any computer can be a web server. A web app is a process that runs on a web server and serves content to clients through HTTP requests. In production environments, web apps run on specially configured web servers, which provide redundancy, replication, and other features to ensure robustness, high performance, and safety, among other characteristics. However, you do not need a fully fledged web server to run a web app. You can run a web app on your development computer.</p><p>An <em>order management server</em> is a web <a id="id190" class="indexterm"/>app that runs on a computer that is accessible to clients. In your development environment (which is comprised of your computer, developer toolset, and iOS devices), the server web app runs on your computer, and the client app runs in a simulator on your computer or an iOS device.</p><div><div><h3 class="title"><a id="note04"/>Note</h3><p>The hardware and software configurations of the server and clients are numerous. This chapter describes a configuration for development on a single Mac using the Simulator app and an iOS device that can send HTTP requests to this computer. This configuration is not suitable for testing or deployment. Consult a deployment engineer when you are ready to test or deploy your apps in more realistic configurations.</p></div></div><p>To exercise all the components of a client app that supports Apple Pay (such as this book's example app, the Merchant app), you must run the client app on an iOS device. In general, client-side payment gateway software does not operate effectively in simulators.</p><p>A client app can access the server web app directly (that is, if both processes are running on the same computer, such as when the client runs in iOS Simulator), through an internal network with the client running on an iOS device (within a subnet), or through the Internet using a web server that is accessible through the public Internet (either for wide-scale testing or production). The example project uses Node.js to implement the server web app. Node.js is an environment used to develop server-side apps.</p></div></div>
<div><div><div><div><h1 class="title"><a id="ch05lvl1sec33"/>Defining order management data structures</h1></div></div></div><p>An order management <a id="id191" class="indexterm"/>system has, as a minimum, data structures representing products available for sale (inventory) and orders. To support the Apple Pay workflow, the system should also have a structure representing the supported shipping methods. The example project uses a MongoDB database to store this data, and the Mongoose data modeling module for Node.js. MongoDB is a document-based database system. Mongoose makes it easier to create documents from schemas and access the data in these documents.</p><p>The database for the example order management system has three collections: <code class="literal">Product</code>, <code class="literal">ShippingMethod</code>, and <code class="literal">Order</code>. A collection is similar to a table in a relational database system.</p><p>The <code class="literal">Product</code> collection stores information about each product offered for sale. The following table shows the fields available for product records within the collection:</p><div><table border="1"><colgroup><col style="text-align: left"/><col style="text-align: left"/></colgroup><thead><tr><th style="text-align: left" valign="bottom">
<p>Field name</p>
</th><th style="text-align: left" valign="bottom">
<p>Description</p>
</th></tr></thead><tbody><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">name</code>
</p>
</td><td style="text-align: left" valign="top">
<p>This is the name<a id="id192" class="indexterm"/> of the product</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">description</code>
</p>
</td><td style="text-align: left" valign="top">
<p>This is a <a id="id193" class="indexterm"/>phrase describing the product</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">image_uri</code>
</p>
</td><td style="text-align: left" valign="top">
<p>This is a <a id="id194" class="indexterm"/>URI identifying an image of the product</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">quantity_on_hand</code>
</p>
</td><td style="text-align: left" valign="top">
<p>This is the <a id="id195" class="indexterm"/>number of units of the product in stock</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">price</code>
</p>
</td><td style="text-align: left" valign="top">
<p>This is the<a id="id196" class="indexterm"/> sale price of each unit of the product</p>
</td></tr></tbody></table></div><p>The <code class="literal">ShippingMethod</code> collection <a id="id197" class="indexterm"/>stores information about the shipping methods available. The following table shows the fields for shipping records:</p><div><table border="1"><colgroup><col style="text-align: left"/><col style="text-align: left"/></colgroup><thead><tr><th style="text-align: left" valign="bottom">
<p>Field name</p>
</th><th style="text-align: left" valign="bottom">
<p>Description</p>
</th></tr></thead><tbody><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">name</code>
</p>
</td><td style="text-align: left" valign="top">
<p>This is<a id="id198" class="indexterm"/> the name of the shipping method</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">description</code>
</p>
</td><td style="text-align: left" valign="top">
<p>This is a phrase <a id="id199" class="indexterm"/>stating the shipment duration in days</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">transit_days</code>
</p>
</td><td style="text-align: left" valign="top">
<p>This is<a id="id200" class="indexterm"/> a number stating the shipment duration in days</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">price</code>
</p>
</td><td style="text-align: left" valign="top">
<p>This is the<a id="id201" class="indexterm"/> price for the shipping method</p>
</td></tr></tbody></table></div><p>The <code class="literal">Order</code> collection stores information about each order processed by the order management system. These are the fields for order records:</p><div><table border="1"><colgroup><col style="text-align: left"/><col style="text-align: left"/></colgroup><thead><tr><th style="text-align: left" valign="bottom">
<p>Field name</p>
</th><th style="text-align: left" valign="bottom">
<p>Description</p>
</th></tr></thead><tbody><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">date</code>
</p>
</td><td style="text-align: left" valign="top">
<p>This is the <a id="id202" class="indexterm"/>date-time group that the order was processed in</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">description</code>
</p>
</td><td style="text-align: left" valign="top">
<p>This is the<a id="id203" class="indexterm"/> name of the product sold (one product per order)</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">shipping_contact</code>
</p>
</td><td style="text-align: left" valign="top">
<p>This is<a id="id204" class="indexterm"/> the name of the person identified as the shipping contact</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">shipping_email</code>
</p>
</td><td style="text-align: left" valign="top">
<p>This is the<a id="id205" class="indexterm"/> e-mail address of the shipping contact</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">shipping_street</code>
</p>
</td><td style="text-align: left" valign="top">
<p>This is the<a id="id206" class="indexterm"/> street of the shipping address</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">shipping_city</code>
</p>
</td><td style="text-align: left" valign="top">
<p>This is<a id="id207" class="indexterm"/> the city of the shipping address</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">shipping_state</code>
</p>
</td><td style="text-align: left" valign="top">
<p>This is<a id="id208" class="indexterm"/> the state of the shipping address</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">shipping_zip</code>
</p>
</td><td style="text-align: left" valign="top">
<p>This is the zip code <a id="id209" class="indexterm"/>of the shipping address</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">shipping_method_name</code>
</p>
</td><td style="text-align: left" valign="top">
<p>This is the name <a id="id210" class="indexterm"/>of the shipping method used for the order</p>
</td></tr></tbody></table></div><p>This is the Node.js code<a id="id211" class="indexterm"/> that defines the structure of the three collections:</p><div><pre class="programlisting">// server_app/lib/inventory_models.js
var mongoose= require('mongoose');
var Schema=   mongoose.Schema;

var Product_schema= new Schema({
   name:             String,
   description:      String,
   image_uri:        String,
   quantity_on_hand: Number,
   price:            String
});

var ShippingMethod_schema= new Schema({
   name:         String,
   description:  String,
   transit_days: Number,
   price:        String
});

var Order_schema= new Schema({
   date                 : String,
   description          : String,
   shipping_contact     : String,
   shipping_email       : String,
   shipping_street      : String,
   shipping_city        : String,
   shipping_state       : String,
   shipping_zip         : String,
   shipping_method_name : String,
   total_price          : String,
   stripe_charge_id     : String
});
   
exports.Product=
   mongoose.model('Product',        Product_schema);
exports.ShippingMethod=
   mongoose.model('ShippingMethod', ShippingMethod_schema);
exports.Order=
   mongoose.model('Order',          Order_schema);</pre></div></div>
<div><div><div><div><h1 class="title"><a id="ch05lvl1sec34"/>Providing inventory information to clients</h1></div></div></div><p>The order <a id="id212" class="indexterm"/>management system implements three REST APIs (known as middleware in Node.js parlance) to provide inventory and shipping method<a id="id213" class="indexterm"/> information to clients. These are as follows:</p><div><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><code class="literal">/shipping_methods</code>: This returns the list of supported shipping methods</li><li class="listitem" style="list-style-type: disc"><code class="literal">/inventory</code>: This returns the product catalog</li><li class="listitem" style="list-style-type: disc"><code class="literal">/product_image/&lt;image_name&gt;</code>: This returns the image used to represent a product to the user</li></ul></div><p>When the client app is launched, it requests the list of shipping methods supported by the system (the <code class="literal">application:didFinishLaunchingWithOptions:</code> method in <code class="literal">AppDelegate.m</code>). Before displaying the list of the available products in the product list screen, the app requests the product catalog (the <code class="literal">viewDidLoad</code> method in <code class="literal">ProductList.m</code>). When the app is about to display the card for a particular product (after the user selects a product in the product list screen), it requests the product's image from the server (the <code class="literal">viewDidLoad</code> method in <code class="literal">ProductCard.m</code>).</p><div><div><h3 class="title"><a id="note05"/>Note</h3><p>For development, the URIs used by the example app (Merchant app) specify a process name (but not a real web address) and port number to access the order management server web app (for example, <code class="literal">http://red:12345/inventory</code>). When you deploy your app to a production environment (that is, the real world), you must use a real, appropriately configured web server to run your web app, and URIs that point to a public web address, such as <code class="literal">http://red.com/inventory</code>.</p></div></div><p>This is the Node.js code that implements the middleware introduced earlier in this section:</p><div><pre class="programlisting">// server_app/red.js

// load required modules
var models=    require('./lib/inventory_models.js');
var assert=    require('assert');
var mongoose=  require('mongoose');
var restify=   require('restify');
var stripe=    require('stripe')('&lt;my_key&gt;')
var server=    restify.createServer();
server.use(restify.bodyParser());

// specify the data models
Product=         models.Product;
ShippingMethod=  models.ShippingMethod;
Order=           models.Order;

// connect to the red MongoDB database
mongoose.connect('mongodb://localhost/red');

protocol=  'http://';
hostname=  'red';
port=      12345;
base_uri=  protocol + hostname + ':' + port;
console.log(base_uri);

// initialize Product collection, if needed
Product.find(function(error, _products)
{
   if (_products.length == 0)
   {
      console.log('initializing product collection');
      models.Product(
      {
         name:             'Clock', 
         description:      'Wooden clock', 
         quantity_on_hand: 10,
         price:            '50.00',
         image_uri:        base_uri + '/product_image/clock.jpeg'
      }).save();
      ...
   }
});

// load Product collection into products
var products= new Array();
Product.find(function(error, _products)
{
   products= _products;
});

// initialize ShippingMethods collection, if needed
ShippingMethod.find(function(error, _shipping_methods)
{
   if (_shipping_methods.length == 0)
   {
      console.log('initializing shipping-method collection');
      models.ShippingMethod({
         name:         'Free',
         description:  'Delivers in seven days',
         transit_days: 7,
         price:        '0.00'
      }).save();
      ...
   }
})

// load ShippingMethod collection into shipping_methods
var shipping_methods= new Array();
ShippingMethod.find(function(error, _shipping_methods)
{
   shipping_methods= _shipping_methods;
});

// ** start middleware (client API) **
//   /product_image/&lt;name&gt; API:
//     provides product image from
//     &lt;project_dir&gt;/public/product_image/&lt;name&gt;
server.get(/\/product_image\/?.*/,
   restify.serveStatic( { directory: '../public' }));

//   /inventory API:
//     provides current inventory from Product document
server.get('/inventory', function(request, response, next)
{
   response.send(products);
   next();
});

//   /shippng_methods API:
//     provides shipping methods from ShippingMethod document
server.get('/shipping_methods', function(request, response, next)
{
   response.send(shipping_methods);
   next();
});
...
// ** end middleware (client API) **

// listen for HTTP requests
server.listen(12345);</pre></div></div>
<div><div><div><div><h1 class="title"><a id="ch05lvl1sec35"/>Processing orders from clients</h1></div></div></div><p>The example order<a id="id214" class="indexterm"/> management system server web app processes orders in a single function, <code class="literal">payment</code> (described in <a class="link" href="ch04.html" title="Chapter 4. Payment Processing Workflow">Chapter 4</a>, <em>Payment Processing Workflow</em>), which clients execute through an HTTP <code class="literal">POST</code> request to the <code class="literal">http://red:12345/payment</code> URI.</p><p>First, the function attempts to charge the customer card. If the charge is successful, the function adds a record to the <code class="literal">Order</code> collection using the order information that the client provided. When<a id="id215" class="indexterm"/> done, the function returns information about the payment transaction and the new order (if it was created) to the client.</p><p>Refer to the <em>Process Phase</em> section in <a class="link" href="ch04.html" title="Chapter 4. Payment Processing Workflow">Chapter 4</a>, <em>Payment Processing Workflow</em>, for details about the implementation of the <code class="literal">payment</code> function.</p></div>
<div><div><div><div><h1 class="title"><a id="ch05lvl1sec36"/>Implementing secure communication</h1></div></div></div><p>The configuration<a id="id216" class="indexterm"/> described in the preceding sections is only for development. There are several things you need to do when deploying an order management system web app for use by real customers. The client apps used by your customers must also be secure.</p><p>Firstly, instead of using a process name and port number in URIs, client apps should use URIs based on a web<a id="id217" class="indexterm"/> address, such as <a class="ulink" href="http://red.com">http://red.com</a>. You should also configure a computer as your publicly accessible web server, which runs your server process. Depending on the expected traffic volume, you may configure your web server to run several instances of the server web app to process requests from several clients concurrently.</p><p>Secondly, you must ensure that the data transmitted between the server and client is secure. By securing data transmission, you ensure that only authorized entities receive the data, that the data is not modified in transit, and that the data cannot be read by third parties. One way to do this is to <a id="id218" class="indexterm"/>use the <strong>HTTPS</strong> (<strong>HTTP Secure</strong>) protocol instead of HTTP to transmit messages and data between server and client.</p><p>You can learn <a id="id219" class="indexterm"/>about adding HTTPS support to client apps in Apple's Developer Library. For information about implementing HTTPS in your web server, consult the appropriate documentation.</p></div>
<div><div><div><div><h1 class="title"><a id="ch05lvl1sec37"/>Summary</h1></div></div></div><p>This chapter has described the design and implementation of a simple web app to serve as an order management system that provides inventory data to client apps and processes orders submitted from the client apps running in the iOS Simulator app, and on iPhone or iPad devices, which support Apple Pay. The chapter has also mentioned the critical security measures you need to implement in web servers and client apps to ensure secure communication between them. The next chapter will provide essential information about the main Apple Pay API used by client apps.</p></div></body></html>