# 第1章. 入门

所以你想为iOS创建游戏？随着**SpriteKit**在**Xcode 5**中的引入，创建iOS二维游戏变得轻而易举。之前，甚至在考虑创建游戏之前，你必须考虑使用哪个框架来创建游戏。有那么多框架可供选择，每个都有自己的优缺点。而且，如果你想创建自己的框架呢？在这种情况下，你必须从头开始使用**OpenGLES**编写它，这需要编写大量的代码仅仅为了显示一个三角形。更不用说使用框架创建三维游戏了，因为大多数框架甚至不支持这一点。

苹果公司通过在Xcode 6中提供所有必需的工具，解决了所有这些问题和难题。在Xcode 6中，你的想象力才是真正的限制。你可以使用**SpriteKit**和**SceneKit**创建2D或3D游戏。如果你想创建自己的2D或3D引擎，Metal可供使用，这使得与**GPU**（即**图形处理单元**）的通信变得容易。但如果你是资深开发者，并且已经使用OpenGL ES创建过游戏，不用担心！这个选项仍然存在，所以你不必局限于只使用Metal。那么，让我们开始使用Xcode 6进行iOS 8游戏开发吧。

本章将涵盖以下主题：

+   下载并安装Xcode

+   创建iOS开发者账号

+   介绍Swift

+   介绍Playground

+   介绍SpriteKit

+   查看默认的SpriteKit项目

+   SpriteKit的新特性

+   查看默认的SceneKit项目

+   理解3D对象

+   2D/3D坐标系

+   探索SceneKit

+   介绍Metal

+   图形管线

# 下载并安装Xcode

如果你有一个苹果账号，你可以打开桌面版的App Store并搜索Xcode。点击**安装**以开始下载。对于这本书，我将使用Xcode 6.1。到这本书出版时，可能会有Xcode 6的新版本。如果你想下载与我使用的相同版本，你可以创建一个免费的Apple Developer Account，进入**下载**部分，并下载之前的版本。

![下载并安装Xcode](img/B04014_01_01.jpg)

### 小贴士

在下载Xcode之前，请确保你正在使用Mac OS X Yosemite 10.10或Maverick 9.4。否则，Xcode 6.1无法安装到你的机器上。

Xcode是苹果公司的**集成开发环境**（**IDE**）。它是开发iOS或Mac OS X上任何类型的应用程序所必需的。它不仅仅是一个IDE；它包含了许多工具和功能，使其成为任何开发者工具箱的重要组成部分。你可以点击Xcode的**App Store**页面上的**更多**按钮，查看它提供的不同工具和功能。我们将在下一章中介绍Xcode的一些功能，当我们介绍Xcode界面时。

要安装Xcode，请点击图标下的**安装**按钮。然后您将被要求输入您的Apple ID和密码。安装将在不久后开始。一旦您点击**安装**按钮，下载将在启动板上开始，如下面的屏幕截图所示：

![下载和安装Xcode](img/B04014_01_02.jpg)

下载并安装后，您可以在启动板上看到它出现。您可以点击应用程序的图标来启动应用程序。

# 创建iOS开发者账号

要创建任何应用程序并在iOS、Mac OS X或Safari的App Store上发布，您需要注册开发者计划。您可以创建一个免费的开发者账户以访问某些部分，如教程和下载，但您将无法访问最新的测试软件。此外，要在您的设备上运行和测试应用程序或游戏，您需要注册此开发者计划。

由于我们确实计划为iOS创建一个小游戏并在App Store上发布，因此我们需要注册iOS开发者计划。我将假设我们还没有开发者账户，所以让我们首先创建一个新的开发者账户，然后我们将注册iOS计划。

要注册为Apple开发者，请访问[https://developer.apple.com/register/index.action](https://developer.apple.com/register/index.action)。将显示以下页面：

![创建iOS开发者账号](img/B04014_01_03.jpg)

如果您已经有了Apple ID，您可以使用它来登录。否则，点击**创建Apple ID**。在这里，您将被要求填写以下标题下的信息：

+   **姓名**：在此处输入以下详细信息：

    +   名字

    +   中间名

    +   姓氏

+   **Apple ID和密码**：在这里输入您首选的Apple ID和密码。请注意以下几点：

    +   **Apple ID**：您选择的任何电子邮件地址。

    +   **密码**：密码应至少包含八个字符；它应至少包含一个小写字母、一个大写字母和一个数字；并且不应包含连续相同的字符。此外，它不应与账户名相同。

    +   **确认密码**：在此处输入与**密码**字段中输入的相同密码。

+   **安全问题**：如果您忘记密码，您将需要回答一些问题以获取对账户的访问权限。您可以选择它们。因此，在选择这些问题时要小心，并记下问题和答案以供将来参考。有三个问题，每个问题都有多个选项。因此，选择一个与您最相关的问题，并选择您容易记住的答案。

    到目前为止提到的所有标题都可以在这个屏幕截图中看到：

    ![创建iOS开发者账号](img/B04014_01_04.jpg)

+   **出生日期**：请输入您的出生日期。

+   **备用电子邮件地址**：这是您可以通过它进行沟通的备用电子邮件地址。

    前两个标题可以在以下屏幕截图中看到：

    ![创建 iOS 开发者账号](img/B04014_01_05.jpg)

+   **邮寄地址**：输入您的邮寄地址。

+   **首选语言**：选择您最舒适的语言。如果您向苹果支持团队提出任何问题，他们将以这种语言回答您。

+   **电子邮件偏好**：如果您想了解最新的苹果新闻、软件更新以及有关产品和服务的最新信息，您可以在本标题下方检查两个复选框。

+   **验证码**：在此截图所示的框中输入验证码图像：![创建 iOS 开发者账号](img/B04014_01_06.jpg)

现在点击**创建 Apple ID**以生成 Apple ID。如果您一切操作都成功，恭喜！您现在是一名苹果开发者。

一旦您进入，您将看到以下屏幕：

![创建 iOS 开发者账号](img/B04014_01_07.jpg)

您将在**技术资源和工具**部分花费大部分时间，尽管您有一个强大的开发者社区和开发者支持，您可以在**社区和支持**部分随时访问。

在**技术资源和工具**部分下，您有两个子部分：**开发中心**和**证书、标识符和配置文件**。在**开发中心**子部分中，您将找到适用于适当开发平台的所有技术资源。通过**证书、标识符和配置文件**链接，您可以生成和管理您的证书，创建配置文件，并管理 App ID 和开发设备。当我们在创建应用程序并希望在我们的设备上运行它时，我们将介绍这个部分。

让我们看看**开发中心**部分。如果您点击**Mac**，您将看到开发适用于 Yosemite 的应用程序的资源链接，例如指向最新 OS X 版本的链接。您还可以获取文章、示例代码、指南等，您可以使用这些资源开发您一直想为 Yosemite 制作的程序。您还可以获得在 WWDC 上展示的开发视频链接。

如果您点击**Safari**，您将看到与您之前看到的类似的布局，包括示例代码和您可以使用来开发 Safari 应用的开发者库链接。

现在点击**开发中心**中的**iOS**。您应该会看到以下屏幕：

![创建 iOS 开发者账号](img/B04014_01_08.jpg)

在这里，您可以找到开发各种 iOS 应用所需的所有资源。您可以下载最新版本的 iOS SDK，或者如果您想下载较旧版本的 Xcode，您可以从**下载**链接中进行。

与 Mac 开发者库类似，您有一个 iOS 开发者库，其中包含如何入门、指南、示例代码、参考和发布说明的链接。在**开发视频**部分下，还有关于 iOS 开发的视频链接。

你可以下载Xcode，将其安装到你的机器上，并测试你的编码技能，但如果你想在一个设备上测试你的出色应用，并将其发布到App Store，你需要注册iOS开发者计划。

如我之前所说，你必须成为该计划的一部分，才能在设备上测试应用或将其发布到App Store。在此期间，你可以在模拟器上运行你制作的SpriteKit和SceneKit应用。所以，如果你愿意，当你对模拟器上的游戏外观满意后，你可以注册。

话虽如此，模拟器只是模拟器而已。游戏在模拟器上的运行方式不应被视为游戏在实际设备上运行的实际情况。游戏在模拟器上会运行得更慢，因为Mac处理器执行两个任务：运行你的操作系统和运行模拟器。

因此，最好在设备上测试应用，以更好地了解它最终将在设备上如何运行，并且你测试的设备越多，效果越好。

### 注意

此外，需要注意的是，在撰写这本书的时候，使用Metal开发的应用程序/游戏无法在模拟器上运行，它们需要在配备A7或A8芯片的设备上运行。如果你尝试在模拟器上运行它们，将会出现错误。

因此，如果你已经准备好注册iOS开发者计划，请点击你当前所在页面右侧“加入iOS开发者计划”标题下的**了解更多**链接。

让我们注册iOS开发者计划。准备好你的信用卡和律师，然后点击顶部的**立即注册**按钮开始流程。接下来，点击**继续**按钮进入下一屏幕。再次点击**继续**，因为你已经创建了一个Apple ID。如果你还没有创建Apple ID，请点击**创建Apple ID**并按照说明操作，然后回到这个页面，并使用你的新Apple ID继续。一旦点击**继续**，你将被重定向到一个页面，你将需要选择你是想以个人身份还是公司身份注册。

如果你以个人身份注册，你的名字将作为卖家显示在App Store上，并且注册时不需要提供任何文件。如果你以公司、非营利组织、合资企业、合伙企业或政府机构身份注册，你应该选择注册为组织的选项。要注册为组织，你需要额外的文件，例如税务识别号、D-U-N-S号码（免费提供）等等。

在组织的情况下，组织的名称将显示为 App Store 上的卖家。你还可以将其他开发者作为团队的一部分添加，与个人注册不同，在个人注册中，每个账户只能添加一个个人，即注册的人。以下截图显示了你可以选择是否作为个人或公司/组织注册的屏幕：

![创建 iOS 开发者账号](img/B04014_01_09.jpg)

对于这本书，我们将以个人身份注册，所以点击屏幕左下角的 **个人** 以进入下一页。

在下一页，你必须选择你想要注册的项目。由于我们将注册 iOS 开发者项目，我们勾选 **iOS 开发者项目** 左侧的复选框，然后点击 **继续**，如以下截图所示：

![创建 iOS 开发者账号](img/B04014_01_10.jpg)

在下一页，你必须同意程序许可协议。请让你的律师过来看看。在他们确认后，点击复选框以同意已阅读协议，并且年龄已满法定年龄。点击页面底部的 **我同意** 以同意并进入下一页。

在这里，你必须输入你的支付信息。提供你的信用卡和账单信息，然后点击 **继续**。现在再次验证信息，然后点击 **下单**。

完成这些后，你就是一个注册的 iOS 开发者。你将得到一个 **感谢** 屏幕和一封电子邮件确认。订单处理可能需要最多 2 个工作日，所以在这期间，我们将提前了解一下 Swift、SpriteKit、SceneKit 和 Metal。

# Swift 简介

在 Xcode 6 中，苹果引入了一种名为 Swift 的新脚本语言。如果你来自 JavaScript 或 ActionScript 背景，你会觉得自己非常熟悉。即使你已经长时间使用 Objective-C，也不要担心。你仍然可以使用 Objective-C 创建游戏。在创建任何项目之前，你将被要求选择你想要创建应用程序/游戏的编程语言。只需选择 **Swift**，然后你就可以开始了。

在 [第 2 章](ch02.html "第 2 章。Swift 基础")，*Swift 基础* 中，你将学习如何在 Swift 中编码，我们将看到它与 Objective-C 的不同之处。在 Swift 中编码时，我们将从绝对开始，包括变量、控制语句、循环和类等高级主题。

# Playground 简介

Playground 是一个你可以用来测试 Swift 代码并立即看到代码结果的文件。让我们实际创建一个新文件并看看它。

如果你从开发者门户而不是 Mac Store 下载了 Xcode，请双击 DMG 文件以打开它。一旦打开，你可以将 Xcode 应用程序拖到你的 `Applications` 文件夹中以安装它。

一旦安装完成，将应用程序拖入 dock，因为我们将会经常使用它。一旦您将其拖入 dock，点击它以打开。打开后，您需要同意条款和条件，因此请同意它们以继续。

您应该在 Xcode 上看到欢迎界面。在这里，您可以点击以下任何一个选项：**使用游乐场开始**、**创建一个新的 Xcode 项目**或**查看现有项目**。这三个选项的详细信息如下：

+   **使用游乐场开始**：使用游乐场，您可以测试您的 Swift 编码技能，并在使用游乐场开发应用程序或游戏之前磨练它们。

+   **创建一个新的 Xcode 项目**：每次您想要创建一个新的 Xcode 项目时，您都必须点击此按钮，然后您还可以选择您想要创建的项目类型。

+   **查看现有项目**：如果您正在使用**源代码管理器**（**SCM**）来管理代码，例如 GitHub、SVN 或 BitBucker，您可以使用此方法查看您那里的项目。

这些选项可以在以下屏幕截图中看到：

![介绍游乐场](img/B04014_01_11.jpg)

现在，点击**使用游乐场开始**按钮。输入文件名（我将其命名为`playgroundTest`），选择**iOS**平台，然后点击**下一步**，如图所示：

![介绍游乐场](img/B04014_01_12.jpg)

在下一屏，您将被询问希望在哪里创建项目文件夹。为了保持整洁，我将所有项目都保存在“文档”文件夹下的`_Projects`文件夹中，该文件夹以下划线（`_`）开头。因此，在这种情况下，我在“文档”文件夹中创建了一个新的`_Projects`文件夹。然后我创建了一个名为`_Playground`的新文件夹，选中它，并点击**创建**。

您将看到在“文档”文件夹的`_Projects/_Playground`文件夹中创建了一个名为`playgroundTest`的文件。一旦文件创建完成，您将看到以下窗口：

![介绍游乐场](img/B04014_01_13.jpg)

您将在左侧面板中编码，您将能够在右侧面板中看到即时结果。您可以看到左侧已经编写了一些代码，而结果在右侧显示。在这里，`Hello, playground`字符串被分配给一个新的变量`str`，而`str`变量的值立即在右侧屏幕上记录。

当您在[第 3 章](ch03.html "第 3 章。Xcode 简介")学习 Swift 时，我们将详细介绍有关游乐场的信息，因为我们将要进行的所有编码实践都需要游乐场文件。

# 探索 SpriteKit

SpriteKit 是一个首次在 iOS 7 和 Xcode 5 中引入的 2D 游戏开发框架。它主要用于创建 2D 游戏，因此对象只能在 *x* 和 *y* 坐标上放置或移动。使用 SpriteKit，您可以创建适用于 iOS 和 OS X 的 2D 游戏。

如果你使用过Cocos2d，你将非常熟悉SpriteKit的架构和语法。由于游戏将主要由精灵组成，因此它被称为SpriteKit。

由于SpriteKit是一个2D游戏开发框架，它提供了从开始到结束创建完整2D游戏所需的所有工具。你可以创建主菜单屏幕、游戏玩法屏幕和选项屏幕。你还可以在每个屏幕上创建按钮。当按钮被按下时，你可以在屏幕之间导航。在游戏玩法屏幕中，你可以添加玩家、敌人、用于显示分数的文本，以及使用粒子编辑器创建的烟雾和爆炸等粒子。

SpriteKit还包括一个执行所有物理相关计算的物理引擎。你只需要将其包含在场景中，你将看到场景中的对象根据物理模拟自动相互交互。此外，SpriteKit还包括一个自动纹理图集生成器，以更好地优化你的游戏资源。

SpriteKit中有些类是创建任何游戏的基本构建块。

## SpriteKit的新特性

在Xcode 6中，SpriteKit添加了许多新酷炫的特性：

+   图形技术：

    +   着色器

    +   灯光和阴影

+   物理模拟技术：

    +   每像素物理

    +   物理场

    +   逆运动学

    +   约束

+   工具和改进：

    +   SpriteKit编辑器

    +   与SceneKit的集成

SpriteKit现在包括你可以用来在游戏中创建新的有趣效果的着色器。你还可以创建光源来投射实时2D阴影。

SpriteKit已经强大的物理引擎通过包含每像素物理以实现像素级碰撞检测而变得更加强大。通过添加物理场，我们可以迅速创建一个《愤怒的小鸟太空版》的克隆，并且通过逆运动学，使你的2D角色的关节运动看起来更加逼真。除此之外，你还可以使用约束来控制场景中任何物理对象沿任何方向或角度的运动或旋转。

SpriteKit还包括一个新编辑器，可以用来创建一个无需编写任何代码的简单游戏。它也可以用作调试工具来检查错误。

SpriteKit也可以与SceneKit一起使用。SceneKit是苹果公司新开发的3D游戏开发框架。如果你想在3D游戏中创建GUI元素，例如2D按钮和雷达，使用SpriteKit可以非常容易地实现这一点。

## 查看默认的SpriteKit项目

让我们看看当我们创建一个新项目时默认创建的SpriteKit项目，这样你就可以理解你在创建游戏时将使用的一些术语。

现在，我们将创建一个新项目。因此，点击中间的**创建新Xcode项目**按钮。一旦点击，你将看到以下窗口：

![查看默认的SpriteKit项目](img/B04014_01_14.jpg)

在左侧面板中，你需要选择你想要为哪个平台创建游戏，iOS或OS X。由于我们将在本书中创建iOS游戏，我们将从iOS部分选择。

在**应用类型**中，你可以选择你想要创建的应用类型：**主从应用**、**页面应用**、**单视图应用**、**标签应用**或**游戏**。由于SpriteKit、SceneKit、Metal和OpenGL ES都是游戏应用的一部分，我们将选择**游戏**。然后点击**下一步**。

在**选择新项目选项**窗口中，你必须填写**产品名称**、**组织名称**、**组织标识符**、**语言**、**游戏技术**和**设备**字段：

![查看默认的SpriteKit项目](img/B04014_01_15.jpg)

上一张截图所示字段的详细信息如下：

+   **产品名称**：当你创建实际项目时，这个字段的输入是你正在创建的游戏名称，例如`AngryBirds`、`CutTheRope`等等。

+   **组织名称**：在这里，你可以输入你为该组织开发游戏的组织名称。为了本书的目的，你可以输入任何你想要的名称。

+   **组织标识符**：这一点非常重要，我无法强调它的重要性。在App Store上，苹果将只通过这个标识符来识别你的应用。这里输入的任何内容都将转换为**包标识符**的值。这必须是唯一的，App Store上的其他应用不能有相同的包名。虽然你可以随意命名，但常用的格式是公司网站反向格式加上产品名称，例如：`com.<公司名称>.<产品名称>`。

    如果你没有公司或网站，不要担心。你只需确保你的包名是唯一的。如果不是，苹果将不会接受这个应用。在这种情况下，你可以尝试不同的包名，稍后你可以在Xcode中将包名更改为苹果批准的包名。

+   **语言**：从这个下拉列表中，你可以选择你想要用哪种语言开发游戏。你可以选择**Objective-C**和**Swift**。由于我们将在本书中使用Swift开发游戏，这里我们将使用**Swift**选项。

+   **游戏技术**：从这个下拉列表中，你可以选择你想要用来开发游戏的科技。你可以选择SceneKit、SpriteKit、Metal和OpenGL ES。由于我们将使用SpriteKit，请从下拉列表中选择它。

+   **设备**：从这个下拉列表中，你可以选择你想要为哪个设备开发游戏。如果你想为iPhone或iPad开发，你可以选择**iPhone**或**iPad**，或者如果你想游戏能在两个平台上运行，你可以选择**通用**。现在你可以选择**iPad**。

点击**下一步**继续。在接下来的屏幕中，你将被询问在哪里创建项目文件夹。为此，在`_Projects`文件夹中创建一个名为`_SpriteKit`的新文件夹。然后选择此文件夹，并点击**创建**。

你会发现`spriteKitTest`项目文件夹在`Documents`文件夹中的`_Projects/_SpriteKit`文件夹内被创建，如下面的截图所示：

![查看默认SpriteKit项目](img/B04014_01_16.jpg)

现在双击`spriteKitTest.xcodeproj`文件以在Xcode中打开你的项目。你的项目应该会打开，如下面的截图所示：

![查看默认SpriteKit项目](img/B04014_01_17.jpg)

Xcode内置了一个模拟器，可以展示游戏或应用在指定设备上的外观。你可以通过点击窗口顶部停止按钮右侧的项目名称来选择设备，如下面的截图所示：

![查看默认SpriteKit项目](img/B04014_01_18.jpg)

点击左上角的播放按钮来构建当前项目。游戏将开始编译所有代码，并自动启动模拟器。一旦模拟器启动，给它一些时间来显示以下屏幕：

![查看默认SpriteKit项目](img/B04014_01_19.jpg)

嗯，它看起来不会完全像前面的截图。首先，你不会看到在`Hello, World`上面的飞机图像。其次，它将是纵向模式，而不是前面截图中的横向模式。

要将视图更改为横向模式，点击左侧面板中的项目名称。中间面板将改变并显示横向、纵向等选项。取消选中纵向选项，并停止并重新构建游戏。现在，每次构建游戏时，视图都会从纵向变为横向。

接下来，你如何将飞机放到屏幕上？这非常简单；要让它出现，你只需在屏幕上的任何地方点击。我在屏幕中心点击，在顶部和显示`Hello, World`的地方之间，这就是为什么飞机出现在那里。要创建更多飞机，你只需继续在你想出现新飞机的地方点击。你会看到，当你添加更多飞机时，屏幕右下角的数字也会改变，飞机开始旋转得越来越慢。为什么会这样？这些数字是什么？在那之前，让我们首先了解一些术语、类和函数，这些是我们需要熟悉的：

+   `SKScene`：这是一个用于创建场景的类，例如，主菜单屏幕、选项屏幕和游戏玩法屏幕。每个场景将包含玩家和按钮等精灵，这些精灵将填充屏幕并帮助你导航到其他屏幕。在左侧面板的项目中，你会找到一个名为`GameScene.swift`的文件。这是游戏构建时立即加载的场景。

+   `SKSpriteNode`：正如我们之前看到的，每个场景都会加载精灵或图像。要将精灵加载到屏幕上，您必须使用`SKSpriteNode`。在这个场景中，每次您触摸屏幕时，您都会在特定位置创建一个精灵。它获取`Spaceship`的图像名称。这可以在同一类的`touchesBegan`函数中看到。

+   `SKLabelNode`：为了在屏幕上显示任何类型的文本，您需要使用`SKLabelNode`来决定应该使用哪种字体来创建文本。您还需要提供需要在屏幕上显示的文本，以及要显示的文本的大小和位置。在这里，我们看到`SKLabelNode`被用来在屏幕上显示`Hello, World`。在`myLabeltext`中，您可以在引号内写下您想要显示的内容，然后重新构建以查看您输入的内容是否在屏幕上显示。

+   `SKAction`：这些用于在一段时间内修改节点的参数。例如，您可以在1秒内将一个对象放大到其大小的两倍，然后将其恢复到正常大小。或者，您可以将对象的位置改变以使其在一段时间内移动或旋转。您可以使用SKAction一起执行这些操作或一个接一个地执行，这里，一旦宇宙飞船被创建，就会对其运行一个动作，告诉它每秒旋转180度。![查看默认的SpriteKit项目](img/B04014_01_20.jpg)

+   `touchesBegan`：SpriteKit内置了可重写的函数，可以用来在屏幕上注册触摸。有四个函数称为`touchesBegan`、`touchesMoved`、`touchesEnded`和`touchesCancelled`。您可以使用这些函数组合在一起来检测手指触摸并创建自己的控制方案，如点击、滑动和双击。

+   `update`：`update`函数是SpriteKit提供的另一个可重写的函数，它会在整个游戏中根据您设置的调用频率反复调用。通常，`update`函数每秒调用60次。我们可以使用这个函数来更新位置、检查碰撞或更新游戏的分数。一旦场景初始化，`update`函数就会自动开始调用。

因此，现在，知道了所有这些，让我们回答之前提出的问题；屏幕右下角的那两个值是什么？

节点代表您添加到场景中的节点数量。这些节点可以是精灵、标签等。这就是为什么每次您在屏幕上添加新的宇宙飞船时，您都会看到节点计数增加。屏幕上添加的对象越多，所需的处理能力就越大。

节点计数旁边的数字是 FPS 或每秒帧数的计算。在 `update` 函数中，我们看到该函数每秒被调用 60 次。所以，每秒 60 次，屏幕被擦除并重新绘制以创建一个新的帧，每个对象的位子和旋转也将被更新。因此，如果你在屏幕上添加更多对象，处理器就必须做更多的工作来绘制屏幕上的所有图像。这就是为什么你会看到 FPS 的下降；也就是说，当你向场景中添加更多飞船时，飞船的旋转会越来越慢。此外，在这种情况下，还需要考虑新飞船也需要旋转，因此处理器必须额外计算飞船每秒需要旋转多少。

对于 SpriteKit 和 `GameScene.swift` 的介绍就到这里。面板上还有其他文件，我们将在下一章中深入探讨 Xcode 时进行讲解。接下来，让我们看看 SceneKit。

# 探索 SceneKit

SceneKit 是一个 3D 游戏开发框架。因此，它可以用来创建 iOS 和 OS X 的 3D 游戏或应用程序。它最初在 OS X 10.8 中发布，现在在 iOS 8 中可用。它是一个基于 OpenGL 和 OpenGL ES 的高级 API，可以与 SpriteKit 集成，就像我们之前看到的。

在 SceneKit 中，就像在任何 3D 游戏开发框架中一样，我们需要为场景提供相机、灯光和对象，以便场景可以从相机的视角进行渲染，并在设备的视口中进行处理和显示。

![探索 SceneKit](img/B04014_01_21.jpg)

所有对象都需要通过为放置的每个对象创建一个节点来添加到节点中，无论是相机、灯光还是对象。

你可以添加预定义的对象，例如盒子、球体、环面和平面，并为其添加纹理；或者导入在 3D 程序中创建的 COLLADA 文件或 Alembic 文件，将其导出为 `.dae` 或 `.abc` 格式，并将其导入到 SceneKit 中。这些可以在 **预览** 中打开，这样你可以在将其导入 SceneKit 项目之前查看和检查文件。除了几何形状之外，你添加到导入场景中的动画、纹理、灯光/相机等也会被导入。你还可以使用 SceneKit 添加 3D 文本和形状到你的游戏中。

如果你将纹理分配给 `COLLADA` 文件中的对象，则需要将纹理映射与文件一起导入。你可以将纹理添加到原始形状、3D 文本和复杂形状中。你还可以通过在代码中将 3D 文本和形状拉伸以赋予它们深度，或者通过倒角角落来修改它们。

通过提供用于创建形状的每个顶点的位置、纹理、坐标和颜色，也可以创建自定义对象和形状。你对多边形数量有完全的自由；如果你想得到更平滑的模型，你可以将多边形分割以获得更平滑的结果——这一切都是通过代码实现的。

SceneKit，连同摄像机一起，还提供了不同的光照类型，如 **环境光**、**泛光灯**、**方向光** 和 **聚光灯**。这些可以附加到节点上，使它们易于放置和移动。

除此之外，还有一个编辑器可以用来查看你的场景以及场景中添加的所有对象。在将对象导入场景后，你还可以查看单个对象的属性，并根据需要对其进行修改。

游戏资源将由资产目录管理，这在构建时将优化资源，类似于 SpriteKit 中的纹理图集创建器。

与 SpriteKit 类似，SceneKit 有可以对对象执行的操作来动画化它们。它还有一个用于物理模拟和碰撞检测的物理引擎。与 SpriteKit 中的物理引擎一样，你可以向你的对象和场景添加关节、约束和逆运动学。

## 查看默认 SceneKit 项目

与创建 SpriteKit 项目的方式类似，创建一个 SceneKit 项目。创建项目时唯一的区别是，在选择下拉列表中的 **游戏技术** 时，选择 **SceneKit** 而不是 **SpriteKit**。将项目命名为 `SceneKitTest`。

一旦创建项目，双击 `SceneKitTest.xcodeproj` 文件。一旦打开，你应该会看到一个类似于 SpriteKit 中的项目结构。

如我们之前所做的那样，你可以点击窗口顶部的播放按钮并选择你选择的模拟器。一旦模拟器加载，你应该会看到一个类似于以下截图的窗口。我再次将视图更改为横幅，以便于操作。

![查看默认 SceneKit 项目](img/B04014_01_22.jpg)

在底部，你将获得比 SpriteKit 更多的调试信息。在左下角，你有一个帧率计数器，与 SpriteKit 中的相同。正如预期的那样，帧率将低于 SpriteKit 项目。这是因为我们现在正在查看 3D 模型，这包括处理器需要计算的大量顶点和多边形，导致帧率下降。这只在模拟器上；在实际设备上，帧率将达到 60。

在屏幕右下角，菱形显示绘制调用的数量，这与 SpriteKit 中的节点类似。由于屏幕上只有一个对象——战斗机，因此只有一个绘制调用。添加的对象越多，绘制调用就越高。

三角形表示构成对象的三角形数量。星号或星号表示对象中存在的顶点数量。你可以点击左侧的 **+** 符号来获取额外的信息，例如 **动画**、**物理**、**约束**、**粒子**、**代理**、**渲染**、**GL Flush** 和 **2D**。

3D物体由顶点组成，这些顶点通过线条连接形成三角形或矩形形状，称为多边形。这些多边形进而形成网格，给物体赋予形状，在这个例子中是战斗机。然后，在形状上绘制2D图像，使其看起来像战斗机。在左侧面板中，您可以打开`art.acnassets`。这是游戏所有艺术资源将被存储的地方。选择它来查看网格和图像，或者放置在网格上的纹理文件。

# 理解3D物体

我已经将`ship.dae` COLLADA文件导入到3D程序中，以展示喷气物体的网格。COLLADA文件可以导入到任何流行的3D软件包中，例如3DSMax、Maya或Blender。

在SceneKit项目中，我们看到了物体在所有纹理的荣耀中。场景中有纹理化的物体，以及相机和投射阴影的光源。在下面的图中，您可以看到物体的实际网格的线框视图。这已被提供，以便您了解3D多边形物体是什么，以及顶点如何组成多边形以创建3D物体的网格。

![理解3D物体](img/B04014_01_23.jpg)

绿色线条是连接点到形成物体多边形表面的线条。您可以看到这些顶点是如何用来形成三角形或多边形以创建所需形状的，例如飞机的机翼、驾驶舱和机身。物体是完全空心的。然后在其上粘贴纹理，使其看起来像刚刚涂上了一层新漆。您还可以指定一个可以反射光的材料，使其看起来闪亮和反光。

在SceneKit中，您可以导入在3D软件包中创建的3D场景，包括纹理、光照、动画和相机，这些都将保持完整。您可以在您喜欢的3D软件包中创建它，并以`.dae`格式导出。您将能够将其导入到SceneKit中，就像喷气物体一样。

如果您的游戏非常简单，不需要这样复杂的形状，那么您可以通过代码在SceneKit中本身创建一个盒子、球体和其他原始对象和形状，并给它们任何您想要的颜色。然而，您仍然需要创建一个相机和光源，以便物体在场景中可见。

返回到模拟器，您可以通过点击并拖动视口来旋转物体，以便更好地观察物体。您也可以在屏幕上双击以将视图重置到初始状态。除了创建3D场景外，SceneKit还允许触摸界面，以便玩家可以与物体交互。我们将在本书稍后深入探讨SceneKit时详细讨论这一点。

# 2D和3D坐标系

在2D游戏开发的情况下，我们只需要关注两个坐标系。第一个是屏幕坐标系，另一个是对象坐标系。

在2D中，无论何时我们在屏幕上放置一个对象，我们总是想知道对象距离屏幕左下角有多远。这是因为屏幕的左下角，而不是屏幕中心，是原点。因此，如果你不改变其位置放置一个精灵，它将在屏幕的左下角创建。屏幕原点或`(0, 0)`位置在屏幕的左下角。如果你想将精灵放置在屏幕中心，你需要将宽度和高度的一半加到位置属性上，因为所有一切都是相对于屏幕的左下角。这被称为屏幕坐标系。

对象坐标系指的是精灵本身。精灵的中心位于对象的中心，与屏幕不同，屏幕的原点在左下角。精灵的中心被称为**锚点**。当你旋转一个精灵时，它将围绕其中心旋转，因为其原点在其中心。你可以通过访问其**锚点**属性来改变精灵的原点。

![2D和3D坐标系统](img/B04014_01_24.jpg)

在3D游戏开发中，存在几个坐标系统。因此，有世界、对象、视图和屏幕坐标系统。除了被称为坐标系统外，它们也被称作空间。

在2D的情况下，世界坐标系与屏幕坐标系相同，但在3D中并非如此。在下面的图中，想象你正在你的设备上看到喷气式飞机：

![2D和3D坐标系统](img/B04014_01_25.jpg)

世界空间的起点是红色、绿色和黄色箭头的起源处。红色箭头代表正*x*轴，绿色是正*y*轴，黄色是正*z*轴。世界空间的起点是`0, 0, 0`。

喷气式飞机放置在世界空间内。与精灵一样，对象坐标系位于对象的中心。

红色方框代表一个朝向喷气式飞机的相机。相机所在的位置被称为视图、眼睛或相机坐标系统。视图视锥体代表相机的视图限制。任何放置在此区域之外的对象都不会被相机渲染。在图形编程中，这被称为**裁剪**。

最后，相机所看到的一切都必须投影到设备的屏幕上。这被称为屏幕坐标系。

# SceneKit的基础

让我们简要地看看在这个项目中场景是如何创建的。打开`GameViewController.swift`文件。在SceneKit中创建场景，你有一个独立的场景创建器，这里称为`SCNScene`，用于创建3D场景。

`GameViewController.swift`文件负责视图。任何创建的应用都必须包含至少一个视图，以便可以在屏幕上显示。每次打开新的应用程序时，都会创建一个视图。一旦视图创建，第一个被调用的函数就是`viewDidLoad`函数，它开始执行其中编写的任何代码：

![SceneKit的基本概念](img/B04014_01_26.jpg)

我们创建了一个新的`SCNScene`类型的场景，并加载了`ship.dae`对象。不需要单独加载飞机的材料；它将自动分配给飞机。由于每个场景首先需要一个相机，我们创建了一个新的相机节点并将其添加到场景中。然后，相机被定位在3D空间中。所以与SpriteKit不同，在SpriteKit中位置是通过*x*和*y*坐标指定的，SceneKit需要其坐标以*x*、*y*和*z*来定义。

原点位于场景中心。在之前的某个截图（显示世界空间的截图）中，红色箭头表示正*x*轴，绿色箭头表示正*y*轴，黄色箭头表示正*z*轴。因此，相机（用红色立方体表示）放置在对象正*z*方向上15像素处。喷气式飞机对象放置在原点。

接下来，我们创建两个光源。首先创建一个泛光灯，然后创建一个环境光来照亮场景。如果您不添加任何光源，场景中将看不到任何东西。您可以尝试注释掉这些行，但由于这是添加光源到场景的地方；您将看到一个黑色屏幕。喷气式飞机仍然在那里，但由于缺少光源，您无法看到它。

然后，我们从场景中获取飞船对象并对其应用旋转动作，类似于在SpriteKit中执行的方式。只是现在，它被称为`SCNAction`而不是`SKAction`。此外，你在所有三个轴上提供了角度，*x*和*z*轴的值为零，并在每秒内绕*y*轴旋转对象。

然后，创建了一个新的`sceneView`变量，将其分配给当前视图，然后将当前场景分配给`sceneView`的场景。然后允许`sceneView`控制相机并显示调试信息，例如FPS。您还应该将背景颜色设置为`black`。

创建了一个新函数，称为`handleTap`，其中处理了双击重置视图。

`GameViewControllerclass`类有其他函数，如`shouldAutoRotate`、`prefersStatusBarHidden`、`supportInterfaceOrientation`和`didReceieveMemoryWarning`。让我们详细看看每个函数：

+   `shouldAutoRotate`：此函数设置为`true`或`false`，取决于您是否希望在设备翻转时旋转视图。如果是`true`，视图将被旋转。

+   `prefersStatusBarHidden`: 如果您想隐藏状态栏，请启用此功能。如果出于某种原因需要显示状态栏，则应禁用此选项。

+   `supportInterfaceOrientation`: 设备将自动检查允许哪些类型的方向。在这种情况下，如果是 iPhone，则接受除了倒置方向之外的所有方向。

+   `didReceiveMemoryWarning`: 如果有您尚未释放的图像和其他数据，并且如果它们正在对内存造成压力，此函数将自动发出警告，表示内存不足，并将关闭应用程序。

所有这些都会相当复杂，但请放心。当我们在本书中稍后介绍 SceneKit 时，我们将将其分解为基本原理。

# 介绍 Metal

Metal 是苹果公司的新低级图形 API。通过它，您可以直接与 GPU 通信并执行图形以及其他计算操作。使用 Metal，您可以从头开发自己的自定义框架，创建 2D 和 3D 应用或游戏，而无需依赖现有的框架，如 SpriteKit 和 SceneKit。

与任何其他图形 API 一样，Metal 有一个具有可编程着色器的图形管道。您还可以分配内存，包括缓冲区和纹理对象。Metal 还有自己的着色器语言，用于编译和应用着色器。

但为什么我们需要 Metal，当 SceneKit 和 SpriteKit 等其他游戏开发框架已经存在时？在 SceneKit、SpriteKit 或任何其他游戏开发框架中，Metal 首先与图形库（如 OpenGL ES）交互，然后该库将信息传递到 GPU。哇！使用 Metal，您拥有直接与 GPU 通信并创建自己框架的绝对权力，这样您就可以创建一个更优化的游戏。

框架始终位于 OpenGL 或 Metal 之上，然后与图形处理器通信，如下面的图所示。使用 Metal，您可以消除一层，直接与 GPU 通信：

![介绍 Metal](img/B04014_01_27.jpg)

您也可以根据自己的需求从头开始创建自己的工具。此外，您还可以访问内存以获取处理器最大的性能。

然而，您可能会说：“哦，OpenGL ES 也提供了所有这些功能。”这是真的，但 OpenGL ES 是跨平台的，将在运行许多其他操作系统的其他设备上工作。因此，您可以想象 OpenGL ES 中有多少额外的材料是为了支持所有设备和操作系统。这就是 Metal 和 OpenGL ES 之间的区别所在。

Metal非常具体地针对苹果设备系列和操作系统编写。实际上，在撰写本书时，它高度依赖于苹果设备和操作系统。您需要一个配备A7或A8芯片并运行iOS 8的苹果设备来运行用Metal制作的游戏。此外，如果您想在开发过程中测试游戏，您不能在模拟器上运行它，因为它不受支持。您需要一个实际设备来运行它，因此您至少需要一个iPad Mini 2、iPad Air或iPhone 5S来测试您的游戏。

使用Metal，开发者们发现与在当前苹果设备上运行的相同OpenGL ES游戏相比，性能至少提高了30%。因此，如果您计划只为最新的苹果设备创建3D游戏，强烈建议您开始使用Metal创建您的游戏。

您可以在设备上创建一个Metal项目并构建它来查看输出。由于需要涵盖许多概念才能开始解释屏幕上所有的代码——并且我们将在本书的后面详细讲解这些内容——因此我们最好在理解了诸如顶点缓冲区、帧缓冲区和索引缓冲区等术语的含义以及它们之间的区别之后，再回头查看代码。

如果您的设备已连接并且已从苹果开发者门户下载了开发者许可证，您可以点击播放按钮来构建应用程序。一旦项目构建完成，您将看到以下屏幕：

![介绍Metal](img/B04014_01_28.jpg)

为了更好地理解Metal或OpenGL，并欣赏渲染屏幕上甚至一个三角形所付出的努力，您需要了解所谓的**图形管线**。

# 图形管线

如果我们查看任何游戏开发框架，我们会意识到几乎每个类中至少都有两个函数。第一个函数是`init`或`start`函数，第二个函数是`update`函数。

`init`函数或启动函数在开始时只调用一次，用于初始化类的所有变量。另一方面，`update`函数通常每秒调用60次，用于更新对象的位置或检测对象之间的碰撞。

除了初始化和更新位置之外，还需要与`update`函数一起调用的另一个函数。就像您挡风玻璃上的雨刷一样，它需要擦除并重新绘制屏幕上的内容。这个函数被称为`draw`函数。在一些框架中，它是第三个函数，称为`draw()`。

每次调用此函数时，都称为一次*绘制调用*。在SceneKit中，我们看到了这个单词。但在SceneKit或SpriteKit中这个函数在哪里？在这两个框架中，类似于Cocos2d和ActionScript，有一个称为显示列表的东西。每次使用`addChild`添加对象时，该对象都会被添加到显示列表中。

显示列表就像任何数组一样，你可以添加或删除对象。显示列表遍历添加到其中的所有对象，然后在屏幕上绘制所有对象。

因此，你不必担心调用 `draw` 函数；你只需通过调用 `addChild` 添加要绘制的对象。否则——也就是说，如果你不想渲染对象——你可以调用 `removeChild` 函数从显示列表中移除该对象，这样它就不会被绘制到屏幕上。

在屏幕上显示事物的过程被称为图形管线。这是一个逐步的过程，将提供给 GPU 的顶点数据和纹理数据转换，以便在屏幕上显示和操作对象。让我们详细看看这个过程。

这里展示了渲染管线中的阶段：

![图形管线](img/B04014_01_29.jpg)

让我们详细看看每个阶段：

+   **顶点**：你可以提供具有每个点坐标的单独顶点，或者整个网格。在喷气式飞机的情况下，我们提供了 `.dae` 文件。提供的顶点信息将包含 3D 空间中的 *x*、*y* 和 *z* 位置。除了位置信息之外，其中一些还可能包含颜色、表面法线和纹理坐标信息。所有这些信息都存储在称为缓冲区的内存空间序列中，类似于数组。

    顶点信息片段，如位置和颜色，作为属性被馈送到 GPU。属性可以想象为特定顶点的一组属性。因此，有位置属性、颜色属性等等。所有这些属性都提供给 GPU 以开始生成对象。

+   **生成原语**：位置缓冲区中提供的顶点位置现在被连接起来形成小三角形，这些三角形进而形成物体的网格。这些三角形是基于作为属性提供的顺序顶点信息形成的。

+   **顶点/几何着色器**：然后信息被传递到顶点着色器。顶点着色器可以通过着色器语言进行编程。这种语言类似于 C 语言。使用这种语言，我们可以在游戏循环中改变位置，使对象移动、缩放和旋转，就像我们的 `update` 函数一样。

+   **光栅化**：在知道哪些顶点位于何处之后，基于由顶点创建的多边形的定位，GPU 开始绘制点之间的像素。

+   **像素/片段着色器**：与顶点着色器类似，在那里你可以进行顶点修改，像素着色器使你能够执行基于像素的操作。所以，既然这也是一个着色器，你知道它也是可编程的。使用像素着色器，你可以创建诸如改变纹理的颜色和透明度等效果。

+   **测试和混合**：这是GPU检查像素是否应该实际显示在屏幕上的阶段。假设当前物体前方有一个物体，当前物体应该只部分可见。GPU只会将那些应该实际可见的像素放置在屏幕上，并忽略重叠的像素。

+   **帧缓冲区**：缓冲区？这又是一个内存空间吗？是的。在图像最终显示在屏幕上之前，整个图像首先存储在一个称为帧缓冲区的内存空间中。当所有计算完成，最终图像准备好在屏幕上显示时，从帧缓冲区取出的数据然后显示在屏幕上。

如果你没有完全理解这些内容，那完全没问题。当我们查看在Metal中创建对象并在屏幕上显示它们时，我们将实际走过这些步骤，所以不用担心。

# 摘要

Xcode 6有很多基础功能和特性，我们在这章中介绍了它们。你看到了如何成为苹果开发者，以便你可以在设备上测试你将要构建的游戏。稍后，你将把游戏上传到App Store。

我们探讨了如何为不同的游戏技术（如SceneKit、SpriteKit和Metal）创建playground文件和项目文件夹，这些技术我们将在接下来的章节中使用。最后，我们探讨了广泛用于在任意设备上渲染屏幕上内容的渲染管线。

在下一章中，我们将探讨Xcode的界面以及它提供的工具和功能。
