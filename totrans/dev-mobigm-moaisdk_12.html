<html><head></head><body><div class="chapter" title="Chapter&#xA0;12.&#xA0;iOS Deployment"><div class="titlepage"><div><div><h1 class="title"><a id="ch12"/>Chapter 12. iOS Deployment</h1></div></div></div><p>Now that we've covered a lot of what is needed to make a game, we can start talking about deploying your game to specific devices. In this chapter we'll modify the default host project for iOS in order to get our game working on it. For this, we'll make a copy of the sample host project that comes with Moai SDK and go through all the things you need to get your own game running.</p><div class="section" title="Xcode project"><div class="titlepage"><div><div><h1 class="title"><a id="ch12lvl1sec62"/>Xcode project</h1></div></div></div><p>First of all, if you <a id="id264" class="indexterm"/>dream about your game making it to the iTunes Store, you're going to have to get the latest Xcode and iOS SDK from Apple. You get access to them by registering to Apple<a id="id265" class="indexterm"/>'s developer website (<a class="ulink" href="https://developer.apple.com/">https://developer.apple.com/</a>).</p><p>If you don't have any <a id="id266" class="indexterm"/>experience using Xcode, it's suggested that you read a quick tutorial, since that's out of the scope of this book. A few basic things you should know about Xcode are how to handle source files, how to manage targets, and some basic Objective-C in order to modify the host to fit your game.</p><p>Go ahead and open the Xcode project that is provided with the Moai SDK download. It's located at <code class="literal">hosts/ios/moai.xcodeproject</code>. If you use the project from that location, it's already configured to use the Moai SDK static libraries in <code class="literal">lib/ios</code>, but if you move it, you'll need to fix the corresponding paths inside the project configuration. We'll see how to do this soon.</p><div class="section" title="The host"><div class="titlepage"><div><div><h2 class="title"><a id="ch12lvl2sec32"/>The host</h2></div></div></div><p>All the code for the<a id="id267" class="indexterm"/> iOS-specific host can be found inside the <code class="literal">Classes</code> folder. If <a id="id268" class="indexterm"/>you take a close look at them, you'll easily understand what they do. Basically they set up an OpenGL view, register all input methods to AKU, and configure other services that you may find handy (or that you can remove if you don't want them).</p><p>There is another folder named <code class="literal">Resources</code> (that contains icons), which is where the compiled source will go (inside another folder called <code class="literal">build</code>).</p><p>You'll see that, by default, the <code class="literal">moai-target</code> file and the <code class="literal">lua</code> folder are displayed in red. The reason for that is that during the build, a script runs and reads the content of <code class="literal">moai-target</code> in <code class="literal">Resources/build</code> to identify all the Lua source code for our game. After finding it, the script <a id="id269" class="indexterm"/>copies every directory referenced by <code class="literal">moai-target</code> into the <code class="literal">lua</code> <a id="id270" class="indexterm"/>folder (the files also get marked as read-only to remind you that they should not be edited, since they'll be deleted during the next build). The files inside the <code class="literal">lua</code> folder are included in the application bundle, so that they can be accessed when packing it for deployment. Take a look at <code class="literal">MoaiAppDelegate.mm</code>, where the code for calling <code class="literal">main.lua</code> to start your game is located. If you want to use a different entry point for <code class="literal">main.lua</code>, you can do it there.</p><p>In the <code class="literal">moai-target</code> file, you should include all the code and asset sources for your game, one per line. For example:</p><div class="informalexample"><pre class="programlisting">../../myGame/src
../../myGameAssets/</pre></div><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="tip20"/>Tip</h3><p>If there are special dependencies on a module that you're installing (check <code class="literal">samples/iphone/app-apsalar</code> for an example), you can use a file called <code class="literal">moai-target-ext</code> to define them. The script will check for this file inside each folder that you define in <code class="literal">moai-target</code> and recursively copy all the contents in it as well.</p></div></div><p>This is crucial for getting things working with the host that is provided.</p><p>You should also take a look at the <code class="literal">Frameworks</code> folder, which has all the static libraries and iOS frameworks needed to build our host.</p></div></div></div>
<div class="section" title="Running an example"><div class="titlepage"><div><div><h1 class="title"><a id="ch12lvl1sec63"/>Running an example</h1></div></div></div><p>Before starting to modify your game code, you should try to run the sample project. It already points to one of Moai SDK's samples, so it should be as easy as checking that the device in the Simulator and hitting <span class="strong"><strong>Build and Debug</strong></span>.</p><p>If you see Moai SDK's logo rotating, you're good to go. If not, check if your Xcode configuration is OK, or join Moai SDK's forum and ask for help, detailing the errors you get.</p><p>Running on an actual device requires you to understand (or at least hack into—who can understand it?) how to handle and set up Apple's provisioning profiles for development. This is carefully explained in the documentation that you can find at Apple's developer portal (<a class="ulink" href="https://developer.apple.com/devcenter/ios/index.action">https://developer.apple.com/devcenter/ios/index.action</a>).</p></div>
<div class="section" title="Setting up our own project"><div class="titlepage"><div><div><h1 class="title"><a id="ch12lvl1sec64"/>Setting up our own project</h1></div></div></div><p>Since the Xcode project<a id="id271" class="indexterm"/> sample that comes with Moai SDK includes a bunch of things that we may not need, it's recommended to do a clean up. We'll start by copying the whole project somewhere in our hard drive. If you have been following all the chapters and have extracted all the code, a good place to put our project is in the same folder as the code samples, so that we can point at them and have our <span class="emphasis"><em>Concentration</em></span> game available on iOS. You can use the source code of <a class="link" href="ch07.html" title="Chapter 7. Concentration Gameplay">Chapter 7</a>, <span class="emphasis"><em>Concentration Gameplay</em></span>.</p><p>Either way, if you downloaded the book's source code, you'll find the iOS project and the <span class="emphasis"><em>Concentration</em></span> gameplay implementation in the code for this chapter.</p><p>Now that we have both the Xcode project and the <span class="emphasis"><em>Concentration</em></span> game in place, double-click on <code class="literal">moai.xcodeproj</code> in order to open Xcode and start configuring it.</p><p>It may take a while to load. Xcode performs file indexing the first time you open a project. Don't worry, that won't happen on subsequent loads (well, except when it decides to index randomly).</p><p>If you run it now, it will probably fail. Learn to take your time to read and understand the errors; that's the only way to solve them.</p><p>Now, let's fix the project step by step.</p><div class="section" title="Pointing to the correct source code"><div class="titlepage"><div><div><h2 class="title"><a id="ch12lvl2sec33"/>Pointing to the correct source code</h2></div></div></div><p>The default project <a id="id272" class="indexterm"/>points to one of Moai SDK's examples using a relative path. Since we moved the project, that path is now broken. We need to make everything point to our own code.</p><div class="mediaobject"><img src="graphics/5064_12_01.jpg" alt="Pointing to the correct source code"/></div><p>In order to do this, expand the <span class="strong"><strong>Resources</strong></span> folder, then the <span class="strong"><strong>build</strong></span> folder, and finally click on <span class="strong"><strong>moai-target</strong></span>.</p><p>The content of <code class="literal">moai-target</code> should be as follows:</p><div class="informalexample"><pre class="programlisting">../../../samples/anim/anim-basic
../../../include/lua-modules lua-modules</pre></div><p>
<code class="literal">moai-target</code> is <a id="id273" class="indexterm"/>pointing to the <code class="literal">anim-basic</code> sample using relative paths. So, in order to run our own game, we need it to point to the correct location.</p><p>In this example, we've moved the game's code to a folder called <code class="literal">concentration-code</code>, so that's where we will point to. The final <code class="literal">moai-target</code> should look as follows:</p><div class="informalexample"><pre class="programlisting">../concentration-code</pre></div><div class="mediaobject"><img src="graphics/5064_12_02.jpg" alt="Pointing to the correct source code"/></div></div><div class="section" title="Fixing source paths"><div class="titlepage"><div><div><h2 class="title"><a id="ch12lvl2sec34"/>Fixing source paths</h2></div></div></div><p>Since we moved the <a id="id274" class="indexterm"/>Xcode project from its original location, now we <a id="id275" class="indexterm"/>need to fix relative paths around the it.</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Collapse the <span class="strong"><strong>Resources</strong></span> folder and expand <span class="strong"><strong>classes</strong></span>. You'll see that <span class="strong"><strong>ParticlePresets.cpp</strong></span> and <span class="strong"><strong>ParticlePresets.h</strong></span> are in red. They can be found in <code class="literal">moai-sdk/hosts/src/</code> (<code class="literal">moai-sdk</code> being the folder where you installed Moai SDK in the initial chapters).<div class="mediaobject"><img src="graphics/5064_12_03.jpg" alt="Fixing source paths"/></div></li><li class="listitem">Select <a id="id276" class="indexterm"/><span class="strong"><strong>ParticlePresets.cpp</strong></span> and <span class="strong"><strong>ParticlePresets.h</strong></span> and<a id="id277" class="indexterm"/> remove them.<div class="mediaobject"><img src="graphics/5064_12_04.jpg" alt="Fixing source paths"/></div></li><li class="listitem">Now <a id="id278" class="indexterm"/>right-click on the <span class="strong"><strong>Classes</strong></span> folder and <a id="id279" class="indexterm"/>choose <span class="strong"><strong>Add Files to "moai"</strong></span>. Go to <code class="literal">moai-sdk/hosts/src/</code> and pick both <span class="strong"><strong>ParticlePresets.cpp</strong></span> and <span class="strong"><strong>ParticlePresets.h</strong></span>. After you accept, they should be in the folder and should not be displayed in red.<div class="mediaobject"><img src="graphics/5064_12_05.jpg" alt="Fixing source paths"/></div></li></ol></div></div><div class="section" title="Fixing include paths"><div class="titlepage"><div><div><h2 class="title"><a id="ch12lvl2sec35"/>Fixing include paths</h2></div></div></div><p>The next thing we <a id="id280" class="indexterm"/>need to do is fix the relative <a id="id281" class="indexterm"/>include paths.</p><p>To do this, click on the top of the folder tree, where it says <span class="strong"><strong>moai</strong></span> and the icon for the Xcode application is displayed. Then, under the <span class="strong"><strong>PROJECT</strong></span> section (not <span class="strong"><strong>TARGETS</strong></span>), select <span class="strong"><strong>moai</strong></span>.</p><p>There are a couple of things to fix here:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Search for the setting named <span class="strong"><strong>Header search paths</strong></span>; it should read <span class="strong"><strong>../../include/</strong></span>. If you double-click on it, a popup will be displayed and you can then double-click the include path and change it to your own include path, which is located at <code class="literal">moai-sdk/include/</code>.<div class="mediaobject"><img src="graphics/5064_12_06.jpg" alt="Fixing include paths"/></div></li><li class="listitem">Search for<a id="id282" class="indexterm"/> <span class="strong"><strong>Other Linker Flags</strong></span>, <a id="id283" class="indexterm"/>and change <span class="strong"><strong>../../../lib/ios/universal/libmoai-ios-tapjoy.a</strong></span> to the correct location (<code class="literal">moai-sdk/lib/ios/universal/libmoai-ios-tapjoy.a</code>). If Xcode still can't find this file, try using an absolute path (in my case it is <code class="literal">/Users/nictuku/moai-sdk/lib/ios/universal/libmoai-ios-tapjoy.a</code>).<div class="mediaobject"><img src="graphics/5064_12_07.jpg" alt="Fixing include paths"/></div></li><li class="listitem">Search <a id="id284" class="indexterm"/>for <span class="strong"><strong>Library Search Paths</strong></span> and<a id="id285" class="indexterm"/> change <span class="strong"><strong>../../../lib/ios/universal</strong></span> to <code class="literal">moai-sdk/lib/ios/universal</code>.<div class="mediaobject"><img src="graphics/5064_12_08.jpg" alt="Fixing include paths"/></div></li><li class="listitem">Now, click on<a id="id286" class="indexterm"/> <span class="strong"><strong>MoaiSample</strong></span> under the <span class="strong"><strong>TARGETS</strong></span> <a id="id287" class="indexterm"/>section. Double-click on <span class="strong"><strong>Library Search Paths</strong></span> and replace the remaining relative paths in the same way we changed the previous ones.<div class="mediaobject"><img src="graphics/5064_12_09.jpg" alt="Fixing include paths"/></div></li></ol></div></div><div class="section" title="Fixing linked libraries"><div class="titlepage"><div><div><h2 class="title"><a id="ch12lvl2sec36"/>Fixing linked libraries</h2></div></div></div><p>The next thing we <a id="id288" class="indexterm"/>need to <a id="id289" class="indexterm"/>fix is the location for all the linked libraries.</p><div class="mediaobject"><img src="graphics/5064_12_10.jpg" alt="Fixing linked libraries"/></div><p>Expand the <span class="strong"><strong>Frameworks</strong></span> folder and identify all the libraries that show up in red.</p><p>You can find them in <code class="literal">moai-sdk/bin/ios/universal</code>. Remove the ones in red, and add all the files in <a id="id290" class="indexterm"/>that path, as we did with the <code class="literal">ParticlePresets</code> files.</p><p>You should end up <a id="id291" class="indexterm"/>with the same files in the directory but they should not be displayed in red anymore.</p><p>Now, if you hit <span class="strong"><strong>Run</strong></span>, the build should succeed and you should see our <span class="emphasis"><em>Concentration</em></span> game on the iOS Simulator.</p><div class="mediaobject"><img src="graphics/5064_12_11.jpg" alt="Fixing linked libraries"/></div><p>But wait! It's not <a id="id292" class="indexterm"/>being displayed correctly, and touches are <a id="id293" class="indexterm"/>not detected! That's because of the way we configured our project locally. So let's try to fix that.</p></div></div>
<div class="section" title="Going multi-platform"><div class="titlepage"><div><div><h1 class="title"><a id="ch12lvl1sec65"/>Going multi-platform</h1></div></div></div><p>The first thing we need to <a id="id294" class="indexterm"/>think about is how we are going to deal with different resolutions in our project. You could do a lot of fancy stuff in this regard, such as changing the UI given different sizes, or loading HD images if the resolution is higher than or equal to 1024 x 768 (or whatever you choose!), and so on. In this example we're going to keep it simple; we will just stretch everything so that it fits on the screen.</p><p>Open the <code class="literal">Concentration</code> project and change the following lines:</p><div class="informalexample"><pre class="programlisting">SCREEN_RESOLUTION_X = 2 * WORLD_RESOLUTION_X
SCREEN_RESOLUTION_Y = 2 * WORLD_RESOLUTION_Y</pre></div><p>To the following:</p><div class="informalexample"><pre class="programlisting">SCREEN_RESOLUTION_X = MOAIEnvironment.horizontalResolution
SCREEN_RESOLUTION_Y = MOAIEnvironment.verticalResolution</pre></div><p>If you run the project now, it should show the stretched version of the game, but it still does not react to touches.</p><div class="mediaobject"><img src="graphics/5064_12_12.jpg" alt="Going multi-platform"/></div><p>In order to fix this, <a id="id295" class="indexterm"/>edit <code class="literal">game.lua</code> and modify <code class="literal">processInput</code> to use <code class="literal">InputManager:getTouch</code> instead of <code class="literal">InputManager:position</code>.</p><p>Where it says <code class="literal">x, y = InputManager:position ()</code>, you should replace that with <code class="literal">x, y = InputManager:getTouch ()</code>.</p><p>Now if you run your project, you'll be able to play our game.</p><p> </p><div class="mediaobject"><img src="graphics/5064_12_13.jpg" alt="Going multi-platform"/></div><p>
</p><p>But it looks stretched. You can learn how to make it work in landscape mode at Moai's wiki page (<a class="ulink" href="http://getmoai.com/wiki/index.php?title=Setup_landscape_in_Moai_Games_For_iOS_Devices">http://getmoai.com/wiki/index.php?title=Setup_landscape_in_Moai_Games_For_iOS_Devices</a>). </p></div>
<div class="section" title="Running on the device"><div class="titlepage"><div><div><h1 class="title"><a id="ch12lvl1sec66"/>Running on the device</h1></div></div></div><p>After all the steps we followed, the game should be able to run on a device. It should just be a matter of setting the correct <span class="strong"><strong>code sign</strong></span> identities<a id="id296" class="indexterm"/> and changing the target device.</p><p>It would be great for you to try this now and ask for help from the Apple community or the Moai forum if you're lost, since setting up an Apple Developer account and certificates exceed the scope of this book.</p></div>
<div class="section" title="Summary"><div class="titlepage"><div><div><h1 class="title"><a id="ch12lvl1sec67"/>Summary</h1></div></div></div><p>In this chapter, we learned how to modify the Xcode project for the iOS host in order to get it working with our own game. We fixed the relative paths that broke when we moved the project and set the resolution correctly.</p><p>We know iOS is not the only platform around there. We'll talk about other platforms in the next chapter!</p></div></body></html>