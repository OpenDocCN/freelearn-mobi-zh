<html><head></head><body>
		<div><h1 id="_idParaDest-285"><em class="italic"><a id="_idTextAnchor362"/>Chapter 21</em>: Understanding Core Data</h1>
			<p>Your app is almost done! Every screen works as shown in the app tour that you went through in <a href="B17469_09_Final_VK_ePub.xhtml#_idTextAnchor133"><em class="italic">Chapter 9</em></a><em class="italic">, Setting Up the User Interface</em>. However, there is one last thing that you need to do. In <a href="B17469_19_Final_VK_ePub.xhtml#_idTextAnchor319"><em class="italic">Chapter 19</em></a><em class="italic">, Getting Started with Custom UIControls</em>, you implemented a <strong class="bold">Review Form</strong> screen, which lets you enter a review for a particular restaurant. In the previous chapter, you implemented a <strong class="bold">Photo Filter </strong>screen, which lets you get a photo from the camera or photo library and add a filter to it. But there is no way at present to save either reviews or photos, and they are lost when the app is closed.</p>
			<p>In this chapter, you will use <strong class="bold">Core Data</strong> to save reviews and photos in your app. First, you'll learn about Core Data and its different components. Next, you'll create a data model for reviews and photos and create corresponding model objects for your app. After that, you'll set up Core Data components for your app.</p>
			<p>You'll then learn about the mechanism used to save reviews and photos for a particular restaurant using the restaurant identifier. After that, you'll update the <code>ReviewFormViewController</code> and <code>PhotoFilterViewController</code> classes to save reviews and photos for a particular restaurant, and modify the <code>RestaurantDetailViewController</code> class to load and display reviews for a particular restaurant. You'll also calculate and display the overall rating for that restaurant.</p>
			<p>Finally, on your own, you'll modify the <code>RestaurantDetailViewController</code> class to load and display photos for a particular restaurant.</p>
			<p>By the end of this chapter, you'll understand how Core Data works. You'll also be able to set up Core Data components, and enable an interface between your app and Core Data components using a data manager class. You'll have also learned to save and load reviews and photos using Core Data, which you will then be able to implement in your own apps.</p>
			<p> The following topics will be covered: </p>
			<ul>
				<li>Introducing Core Data</li>
				<li>Implementing Core Data components for your app</li>
				<li>Understanding how saving and loading works</li>
				<li>Updating the <code>ReviewFormViewController</code> class to save reviews</li>
				<li>Updating the <code>PhotoFilterViewController</code> class to save photos</li>
				<li>Displaying saved reviews and photos in the <strong class="bold">Restaurant Detail</strong> screen</li>
				<li>Calculating a restaurant's overall rating</li>
			</ul>
			<h1 id="_idParaDest-286"><a id="_idTextAnchor363"/>Technical requirements</h1>
			<p>You will continue working on the <code>LetsEat</code> project that you modified in the previous chapter.</p>
			<p>The completed Xcode project for this chapter is in the <code>Chapter21</code> folder of the code bundle for this book, which can be downloaded here:</p>
			<p><a href="https://github.com/PacktPublishing/iOS-15-Programming-for-Beginners-Sixth-Edition">https://github.com/PacktPublishing/iOS-15-Programming-for-Beginners-Sixth-Edition</a></p>
			<p>Check out the following video to see the code in action: </p>
			<p><a href="https://bit.ly/3o81yKK">https://bit.ly/3o81yKK</a></p>
			<p>Let's start by learning about the components of Core Data and how it works. </p>
			<h1 id="_idParaDest-287"><a id="_idTextAnchor364"/>Introducing Core Data</h1>
			<p>Core Data<a id="_idIndexMarker1119"/> is Apple's mechanism for saving app data to your device. It provides persistence, undo/redo, background tasks, view synchronization, versioning, and migration. You can define your data types and relationships using Xcode's data model editor, and Core Data will generate class definitions for your data types automatically. Core Data can then create and manage object instances based on the class definitions.</p>
			<p class="callout-heading">Important Note</p>
			<p class="callout">You can learn more about Core Data at this link:  <a href="https://developer.apple.com/documentation/coredata">https://developer.apple.com/documentation/coredata</a>.</p>
			<p>Core Data provides a set of classes collectively known as the Core Data stack to manage and persist object instances, which<a id="_idIndexMarker1120"/> are as follows:</p>
			<ul>
				<li><code>NSManagedObjectModel</code><p>Describes your app's types, including their properties and relationships.</p></li>
				<li><code>NSManagedObject</code><p>A class used to implement instances of your app's types based on data from the <code>NSManagedObjectModel</code>.</p></li>
				<li><code>NSManagedObjectContext</code><p>Tracks changes to instances of your app's types.</p></li>
				<li><code>NSPersistentStoreCoordinator</code><p>Saves and fetches instances of your app's types from stores.</p></li>
				<li><code>NSPersistentContainer</code><p>Sets up the model, context, and store coordinator simultaneously.</p><p class="callout-heading">Important Note</p><p class="callout">You can learn<a id="_idIndexMarker1121"/> more about the Core Data stack at this link: <a href="https://developer.apple.com/documentation/coredata/core_data_stack">https://developer.apple.com/documentation/coredata/core_data_stack</a>.</p></li>
			</ul>
			<p>In the next section, you'll implement Core Data components required for your app to save reviews or photos.</p>
			<h1 id="_idParaDest-288"><a id="_idTextAnchor365"/>Implementing Core Data components for your app</h1>
			<p>Before you implement <a id="_idIndexMarker1122"/>Core Data components for your app, let's think about what you need to do to save reviews or photos.</p>
			<p>Imagine you're saving a review or photo using Microsoft Word. You first create a new Word document template with the relevant fields for a review or photo. You then create new Word documents based on the templates and fill in the data. You make whatever changes are necessary, perhaps changing the text of the review, or changing the effect you're applying to the photo. At this point, you have not saved the file yet. When you are happy with <a id="_idIndexMarker1123"/>your document, you save it to the hard disk of your computer. The next time you want to view your review or photo, you search your hard disk for the relevant document and double-click it to open it in Word so you can see it once more.</p>
			<p>Now that you have an idea of what you need to do, let's review the steps required to implement it. First, you <a id="_idIndexMarker1124"/>need to create a data model for a review or photo. You do this by creating <strong class="bold">entities</strong> in Xcode's data model editor, which are like Microsoft Word templates. Entities can have <strong class="bold">attributes</strong>, which <a id="_idIndexMarker1125"/>are like fields in the Microsoft Word templates.</p>
			<p>Xcode can then create an <code>NSManagedObjectModel</code> class from this data model. Core Data will then use this <code>NSManagedObjectModel</code> class to create <code>NSManagedObject</code> instances, similar to Microsoft Word templates being used to create Microsoft Word files.</p>
			<p>These <code>NSManagedObject</code> instances are placed in an <code>NSManagedObjectContext</code> instance, where your app has access to them, similar to opening Microsoft Word files in Microsoft Word. Then, when you bring up the <code>NSManagedObject</code> instances, and you can modify them as much as you like, similar to Microsoft Word documents being edited in Microsoft Word.</p>
			<p>When you're done with the review or photo, the <code>NSManagedObject</code> instances in the <code>NSManagedObjectContext</code> instance<a id="_idIndexMarker1126"/> are saved to a file in your iOS device, called the <strong class="bold">persistent store</strong>. This is similar to saving Word documents to your hard disk when you're done with them.</p>
			<p>The <code>NSPersistentStoreCoordinator</code> instance manages the flow of information between the persistent store and the <code>NSManagedObjectContext</code> instance.</p>
			<p>You'll use the <code>NSPersistentContainer</code> class to create instances of <code>NSManagedObjectModel</code>, <code>NSManagedObjectContext</code>, and <code>NSPersistentStoreCoordinator</code> for your app.</p>
			<p class="callout-heading">Important Note</p>
			<p class="callout">You can learn more about how to set up the Core Data stack at this link: <a href="https://developer.apple.com/documentation/coredata/setting_up_a_core_data_stack">https://developer.apple.com/documentation/coredata/setting_up_a_core_data_stack</a>.</p>
			<p>You'll create<a id="_idIndexMarker1127"/> entities and attributes to<a id="_idIndexMarker1128"/> represent a review or photo using Xcode's data model editor in the next section.</p>
			<h2 id="_idParaDest-289"><a id="_idTextAnchor366"/>Creating a data model</h2>
			<p>Currently, when <a id="_idIndexMarker1129"/>you tap <strong class="bold">Save</strong> in the <strong class="bold">Review Form</strong> screen, the data you entered in the fields is just printed to the Debug area, and tapping <strong class="bold">Save</strong> in the <strong class="bold">Photo Filter</strong> screen doesn't do anything. The first step is to create class definitions for objects to store data from the <strong class="bold">Review Form</strong> screen and the photo from the <strong class="bold">Photo Filter</strong> screen. You'll create entities for reviews and photos using Xcode's data model editor, and Xcode will automatically generate the class definitions. Let's create the entity for reviews first. Follow these steps:</p>
			<ol>
				<li>Right-click the <code>Misc</code> folder in the Project navigator and choose <code>Core Data</code>.</li>
				<li>Right-click the <code>Core Data</code> group and choose <strong class="bold">New File</strong>.</li>
				<li><code>data</code> in the filter field, and select <strong class="bold">Data Model</strong>. Click <strong class="bold">Next</strong>:<div><img src="img/Figure_21.01_B17469.jpg" alt="Figure 21.1: Data Model template selected&#13;&#10;"/></div><p class="figure-caption">Figure 21.1: Data Model template selected</p></li>
				<li>Name<a id="_idIndexMarker1130"/> the file <code>LetsEatModel</code> and click <strong class="bold">Create</strong>. The data model editor appears in the Editor area:<div><img src="img/Figure_21.02_B17469.jpg" alt="Figure 21.2: Editor area showing data model editor&#13;&#10;"/></div><p class="figure-caption">Figure 21.2: Editor area showing data model editor</p></li>
				<li>Click<a id="_idIndexMarker1131"/> the <strong class="bold">Add Entity</strong> button:<div><img src="img/Figure_21.03_B17469.jpg" alt="Figure 21.3: Add Entity button&#13;&#10;"/></div><p class="figure-caption">Figure 21.3: Add Entity button</p></li>
				<li>An <strong class="bold">Entity</strong> appears under the <strong class="bold">ENTITIES</strong> section. The <strong class="bold">Attributes</strong> for this entity appear to the right of the entity:<div><img src="img/Figure_21.04_B17469.jpg" alt="Figure 21.4: Data model editor with Entity selected&#13;&#10;"/></div><p class="figure-caption">Figure 21.4: Data model editor with Entity selected</p></li>
				<li>Double-click <code>Review</code>:<div><img src="img/Figure_21.05_B17469.jpg" alt="Figure 21.5: Data model editor with Entity renamed to Review&#13;&#10;"/></div><p class="figure-caption">Figure 21.5: Data model editor with Entity renamed to Review</p></li>
				<li>Click the <code>name</code> and the <code>String</code>:<div><img src="img/Figure_21.06_B17469.jpg" alt="Figure 21.6: Data model editor showing the name attribute for the Review entity&#13;&#10;"/></div><p class="figure-caption">Figure 21.6: Data model editor showing the name attribute for the Review entity</p></li>
				<li>You'll need to create an attribute for each field in the <code>restaurantID</code> as well to associate the review with the restaurant. Add the following attributes and types:<div><img src="img/Figure_21.07_B17469.jpg" alt="Figure 21.7: Attributes to be added to the Review entity&#13;&#10;"/></div><p class="figure-caption">Figure 21.7: Attributes to be added to the Review entity</p><p><code>date</code> will be automatically set when the <code>Review</code> instance is created.</p></li>
				<li>Check <a id="_idIndexMarker1133"/>to see that your <code>Review</code> entity's attributes look like this when done:<div><img src="img/Figure_21.08_B17469.jpg" alt="Figure 21.8: The attributes for Review entity&#13;&#10;"/></div><p class="figure-caption">Figure 21.8: The attributes for Review entity</p></li>
				<li>Add one more attribute, <code>uuid</code>, of type <code>UUID</code>. This is used as a key value for each <code>Review</code> instance. Click the Data Model inspector, and under <code>Review</code> instance must have a key value.<div><img src="img/Figure_21.09_B17469.jpg" alt="Figure 21.9: Data model inspector showing Optional unticked for the uuid attribute&#13;&#10;"/></div><p class="figure-caption">Figure 21.9: Data model inspector showing Optional unticked for the uuid attribute</p></li>
				<li>Add a <a id="_idIndexMarker1134"/>second entity, called <code>RestaurantPhoto</code>, with the following attributes. Core Data can't store <code>UIImage</code> objects, so the <code>photo</code> attribute's type is set to <code>UIImage</code> objects when you need them to be displayed in your app. <code>date</code> will be automatically set when the <code>RestaurantPhoto</code> instance is created. You'll use <code>restaurantID</code> to associate the photo with the restaurant, and <code>uuid</code> as the key value:<div><img src="img/Figure_21.10_B17469.jpg" alt="Figure 21.10: Attributes for the RestaurantPhoto entity&#13;&#10;"/></div><p class="figure-caption">Figure 21.10: Attributes for the RestaurantPhoto entity</p></li>
				<li>For <code>uuid</code>, don't forget to uncheck <strong class="bold">Optional</strong> in the Data Model inspector:</li>
			</ol>
			<div><div><img src="img/Figure_21.11_B17469.jpg" alt="Figure 21.11: Data model inspector showing Optional unticked for the uuid attribute&#13;&#10;"/>
				</div>
			</div>
			<p class="figure-caption">Figure 21.11: Data model inspector showing Optional unticked for the uuid attribute</p>
			<p>You have finished<a id="_idIndexMarker1135"/> creating the entities that you need for your app. Build your app. Class files for the <code>Review</code> and <code>RestaurantPhoto</code> entities will be automatically created by Xcode, but they will not be visible in the Project navigator. To make it easier to work with them, you will create a model object for each entity, starting with <code>ReviewItem</code> in the next section.</p>
			<h2 id="_idParaDest-290"><a id="_idTextAnchor367"/>Creating ReviewItem</h2>
			<p>You have <a id="_idIndexMarker1136"/>created two entities to store reviews and photo data using Xcode's data model editor. Xcode will then automatically generate two <code>NSManagedObject</code> class definitions from the data model, <code>Review</code> and <code>RestaurantPhoto</code>, but you can't see them in the Project navigator.</p>
			<p>You will create two model objects, <code>ReviewItem</code> and <code>RestaurantPhotoItem</code>, that will work hand-in-hand with <code>Review</code> and <code>RestaurantPhoto</code> instances. Let's create <code>ReviewItem</code> now. Follow <a id="_idIndexMarker1137"/>these steps:</p>
			<ol>
				<li value="1">Right-click the <code>ReviewForm</code> folder in the Project navigator and choose <code>Model</code>.</li>
				<li>Right-click the <code>Model</code> folder inside the <code>ReviewForm</code> folder and select <strong class="bold">New File</strong>.</li>
				<li><strong class="bold">iOS</strong> should already be selected. Choose <strong class="bold">Swift File</strong> and then click <strong class="bold">Next</strong>.</li>
				<li>Name this file <code>ReviewItem</code>. Click <code>ReviewItem</code> file appears in the Project navigator.</li>
				<li>Modify the file as<a id="_idTextAnchor368"/><a id="_idTextAnchor369"/> shown:<pre>import <strong class="bold">UIKit</strong>
<strong class="bold">struct ReviewItem {</strong>
<strong class="bold">   var date: Date?</strong>
<strong class="bold">   var rating: Double? </strong>
<strong class="bold">   var title: String? </strong>
<strong class="bold">   var name: String?</strong>
<strong class="bold">   var customerReview: String?</strong>
<strong class="bold">   var restaurantID: Int64?</strong>
<strong class="bold">   var uuid = UUID()</strong>
<strong class="bold">}</strong>
<strong class="bold">extension ReviewItem {</strong>
<strong class="bold">   init(review: Review) {</strong>
<strong class="bold">      self.date = review.date</strong>
<strong class="bold">      self.rating = review.rating</strong>
<strong class="bold">      self.title = review.title</strong>
<strong class="bold">      self.name = review.name</strong>
<strong class="bold">      self.customerReview = review.customerReview </strong>
<strong class="bold">      self.restaurantID = review.restaurantID</strong>
<strong class="bold">      if let reviewUUID = review.uuid { </strong>
<strong class="bold">         self.uuid = reviewUUID</strong>
<strong class="bold">      }</strong>
<strong class="bold">   }</strong>
}</pre></li>
			</ol>
			<p>As you <a id="_idIndexMarker1138"/>can see, the <code>ReviewItem</code> structure's properties are the same as the <code>Review</code> entity's attributes. The initializer creates a <code>ReviewItem</code> instance and maps the attributes from <code>Review</code> to the properties of the <code>ReviewItem</code> instance.</p>
			<p>In the next section, you'll create a second model object, <code>RestaurantPhotoItem</code>, which will be the model object for the <code>RestaurantPhoto</code> entity.</p>
			<h2 id="_idParaDest-291"><a id="_idTextAnchor370"/>Creating RestaurantPhotoItem</h2>
			<p>The process for<a id="_idIndexMarker1139"/> creating <code>RestaurantPhotoItem</code> is similar to creating <code>ReviewItem</code>. Follow these steps:</p>
			<ol>
				<li value="1">Right-click the <code>Model</code> folder inside the <code>PhotoFilter</code> folder and choose <strong class="bold">New File</strong>.</li>
				<li><strong class="bold">iOS</strong> should already be selected. Choose <strong class="bold">Swift File</strong> and then click <strong class="bold">Next</strong>.</li>
				<li>Name this file <code>RestaurantPhotoItem</code>. Click <strong class="bold">Create</strong>.</li>
				<li>Modify the file <a id="_idTextAnchor371"/><a id="_idTextAnchor372"/>as shown:<pre>import <code>ReviewItem</code> structure, the properties of the <code>RestaurantPhotoItem</code> structure are the same as the <code>RestaurantPhoto</code> entity's attributes. There is one additional computed property, <code>photoData</code>, which is used to store the representation of <code>photo</code> in binary data format, as Core Data can't store <code>UIImage</code> instances.</p><p>The<a id="_idIndexMarker1140"/> initializer creates a <code>RestaurantPhotoItem</code> instance and maps the attributes from the <code>RestaurantPhoto</code> entity to properties in <code>RestaurantPhotoItem</code> instance. Note the conversion from binary data to <code>UIImage</code> when setting the value for <code>photo</code>.</p></li>
			</ol>
			<p>Now that you have declared and defined <code>ReviewItem</code> and <code>RestaurantPhotoItem</code>, let's create a Core Data manager, which will set up the Core Data components for your app, in the next section.</p>
			<h2 id="_idParaDest-292"><a id="_idTextAnchor373"/>Creating a Core Data manager</h2>
			<p>At this point, Xcode<a id="_idIndexMarker1141"/> has automatically generated the <code>Review</code> and <code>RestaurantData</code> class definitions from the data model, and you have declared and defined the corresponding model objects, <code>ReviewItem</code> and <code>RestaurantPhotoItem</code>. Now you'll create a <code>CoreDataManager</code> class that will set up the Core Data components for your app. Follow these steps:</p>
			<ol>
				<li value="1">Right-click the <code>Core Data</code> folder inside the <code>Misc</code> folder and choose <strong class="bold">New File</strong>.</li>
				<li><strong class="bold">iOS</strong> should already be selected. Choose <strong class="bold">Swift File</strong> and then click <strong class="bold">Next</strong>.</li>
				<li>Name this file <code>CoreDataManager</code>. Click <code>CoreDataManager</code> file appears in the Project navigator.</li>
				<li>Add the following code after the <code>import</code> statement:<pre>import CoreData</pre><p>This gives you access to the Core Data library.</p></li>
				<li>Add the following code to declare and define the <code>CoreDataManager<a id="_idTextAnchor374"/><a id="_idTextAnchor375"/><a id="_idTextAnchor376"/></code> structure:<pre>struct CoreDataManager { 
   let container: NSPersistentContainer
   init() {
      container = NSPersistentContainer(name: 
      "LetsEatModel")
      container.loadPersistentStores { 
         (storeDesc, error) in 
         error.map {
            print($0)
         }
      }
   }
}</pre><p>This creates and initializes instances of <code>NSManagedObjectModel</code>, <code>NSPersistentStoreCoordinator</code>, and <code>NSManagedObjectContext</code>.</p></li>
				<li>To create<a id="_idIndexMarker1142"/> an instance of the <code>CoreDataManager</code> structure that will be available throughout your app, click the <code>AppDelegate</code> file in the Project navigator and add the following code after the closing <a id="_idTextAnchor377"/><a id="_idTextAnchor378"/>curly brace:<pre>extension CoreDataManager {
   static var shared = CoreDataManager()
}</pre></li>
			</ol>
			<p>Next, you'll add methods to create <code>Review</code> and <code>RestaurantPhoto</code> instances, populate them using <code>ReviewItem</code> and <code>RestaurantPhotoItem</code> instances, and save them to the persistent store. Follow these steps:</p>
			<ol>
				<li value="1">Click<a id="_idIndexMarker1143"/> the <code>CoreDataManager</code> file in the Project navigator. Add the following code after the initializer to implement the <code>addRevie<a id="_idTextAnchor379"/><a id="_idTextAnchor380"/>w(_:)</code> method:<pre>func addReview(_ reviewItem: ReviewItem) {
   let review = Review(context: 
   container.viewContext)
   review.date = Date()
   if let reviewItemRating = reviewItem.rating { 
      review.rating = reviewItemRating
   }
   review.title = reviewItem.title 
   review.name = reviewItem.name
   review.customerReview = 
   reviewItem.customerReview
   if let reviewItemRestID = 
   reviewItem.restaurantID { 
      review.restaurantID = reviewItemRestID  
   }
   review.uuid = reviewItem.uuid
   save()
}</pre><p>This method takes a <code>ReviewItem</code> instance as a parameter and gets an empty <code>Review</code> instance from the <code>NSManagedObjectContext</code> instance. The properties of the <code>ReviewItem</code> instance are assigned to the attributes of the <code>Review</code> instance, and the <code>save()</code> method is called to save the contents of the <code>NSManagedObjectContext</code> instance to the persistent store. Note that you will see an <a id="_idIndexMarker1144"/>error as you have not yet implemented the <code>save()</code> method. Ignore this error for now.</p></li>
				<li>Add the following code after the <code>addReview(_:)</code> method to implement the <code>addPho<a id="_idTextAnchor381"/><a id="_idTextAnchor382"/>to(_:)</code> method:<pre>func addPhoto(_ restPhotoItem: 
RestaurantPhotoItem) {
   let restPhoto = RestaurantPhoto(context: 
   container.viewContext)
   restPhoto.date = Date()
   restPhoto.photo = restPhotoItem.photoData
   if let restPhotoID = 
      restPhotoItem.restaurantID { 
      restPhoto.restaurantID = restPhotoID 
   }
   restPhoto.uuid = restPhotoItem.uuid
   save()
}</pre><p>This method is similar to <code>addReview(_:)</code>. It takes a <code>RestaurantPhotoItem</code> instance as a parameter and gets an empty <code>RestaurantPhoto</code> instance from the <code>NSManagedObjectContext</code> instance. The properties of the <code>RestaurantPhotoItem</code> instance are assigned to the properties of the <code>RestaurantPhoto</code> instance, and the <code>save()</code> method is called to save the contents of the <code>NSManagedObjectContext</code> instance to the persistent store. Note that you will see an error as you have not yet implemented the <code>save()</code> method. Again, ignore this error for now.</p></li>
				<li>Implement the <code>save()</code> method by adding the following code before the fina<a id="_idTextAnchor383"/><a id="_idTextAnchor384"/>l curly brace:<pre>private func save() {
   do {
      if container.viewContext.hasChanges {
         try container.viewContext.save()
      }
   } catch let error {
      print(error.localizedDescription)
   }
}</pre><p>This <code>do-catch</code> block saves the contents of the <code>NSManagedObjectContext</code> instance to the persistent store. If the save was not successful, an error message is printed in the Debug area.</p></li>
			</ol>
			<p>When you want to<a id="_idIndexMarker1145"/> retrieve reviews and photos from the persistent store, you will use <code>restaurantID</code> as an identifier to get reviews and photos for a particular restaurant. Let's implement the methods required for this now. Add the following code after the <code>addPhoto(_:)</code> method to implement the <code>fetchReviews(by:)</code> and <code>fetchPhoto<a id="_idTextAnchor385"/><a id="_idTextAnchor386"/>s(by:)</code> methods:</p>
			<pre>func fetchReviews(by identifier: Int) -&gt; 
[ReviewItem] {
   let moc = container.viewContext
   let request = Review.fetchRequest()
   let predicate = NSPredicate(format: 
   "restaurantID = %i", identifier)
   var reviewItems: [ReviewItem] = []
   request.sortDescriptors = 
   [NSSortDescriptor(key: "date", 
   ascending: false)]
   request.predicate = predicate 
   do {
      for review in try moc.fetch(request) {
         reviewItems.append(ReviewItem(review: 
         review))
      }
      return reviewItems
   } catch {
      fatalError("Failed to fetch reviews: 
      \(error)")
   }
}
 
func fetchRestPhotos(by identifier: Int) -&gt; 
[RestaurantPhotoItem] {
   let moc = container.viewContext
   let request = RestaurantPhoto.fetchRequest()
   let predicate = NSPredicate(format: 
   "restaurantID = %i", identifier) 
   var restPhotoItems: [RestaurantPhotoItem] = [] 
   request.sortDescriptors = 
   [NSSortDescriptor(key: "date", 
   ascending: false)]
   request.predicate = predicate 
   do {
      for restPhoto in try moc.fetch(request) {
         restPhotoItems.append(RestaurantPhotoItem
         (restaurantPhoto: restPhoto))
      }
      return restPhotoItems
   } catch {
      fatalError("Failed to fetch restaurant 
      photos: \(error)")
   }
}</pre>
			<p>Let's break<a id="_idIndexMarker1146"/> this down, starting with <code>fetchReviews(by:)</code>:</p>
			<pre>let moc = container.viewContext</pre>
			<p>This gets a reference to the <code>NSManagedObjectContext</code> instance.</p>
			<pre>let request = Review.fetchRequest() </pre>
			<p>This <a id="_idIndexMarker1147"/>creates a <code>Review</code> instances from the persistent store.</p>
			<pre>let predicate = NSPredicate(format: "restaurantID = %i", identifier)</pre>
			<p>This creates a <code>Review</code> instances with the specified <code>restaurantID</code>.</p>
			<pre>var reviewItems: [ReviewItem] = []</pre>
			<p>This creates an array, <code>reviewItems</code>, that you will use to store the results of the fetch request.</p>
			<pre>request.sortDescriptors = [NSSortDescriptor(key: "date", ascending: false)]</pre>
			<p>This sorts the results of the fetch request by date, with the most recent items first.</p>
			<pre>request.predicate = predicate</pre>
			<p>This sets the<a id="_idIndexMarker1149"/> predicate for the fetch request.</p>
			<pre>do {
   for review in try moc.fetch(request) {
      reviewItems.append(ReviewItem(review: 
      review))
   }
   return reviewItems
} catch {
   fatalError("Failed to fetch reviews: \(error)")
}</pre>
			<p>This <code>do-catch</code> block performs the fetch request and places the results in the <code>items</code> array. If unsuccessful, your app will crash and an error message will be printed in the Debug area.</p>
			<p><code>fetchPhotos(by:)</code> works the same way as <code>fetchReview(by:)</code>, but returns an array of <code>RestaurantPhotoItems</code> instances instead.</p>
			<p>You've created a <code>CoreDataManager</code> class that adds data to and retrieves data from the persistent store. Build and run your app to test for errors. It should work the same way as it did before.</p>
			<p>You've implemented all the components of Core Data in your app. Next, you'll configure <code>RestaurantDetailViewController</code> to use Core Data to display reviews and photos in the <strong class="bold">Restaurant Detail</strong> screen. You'll start by learning how the <strong class="bold">Restaurant Detail</strong> screen will display reviews and photos for a particular restaurant.</p>
			<p class="callout-heading">Tip</p>
			<p class="callout">Since this is a long chapter, you may wish to take a break here.</p>
			<h1 id="_idParaDest-293"><a id="_idTextAnchor387"/>Understanding how saving and loading works</h1>
			<p>Let's review what you have done so far. You have created <code>Review</code> and <code>RestaurantPhoto</code> entities<a id="_idIndexMarker1150"/> using the data model editor, and you have created the corresponding model objects for them, named <code>ReviewItem</code> and <code>RestaurantPhotoItem</code>. You created the <code>CoreDataManager</code> class to add and get <code>Review</code> and <code>RestaurantPhoto</code> instances from the persistent store. The <code>CoreDataManager</code> class uses the restaurant identifier to associate reviews and restaurant photos with a specific restaurant, but where does it come from?</p>
			<p>Open the <code>Misc</code> folder in your project, and open the <code>JSON</code> folder. If you click on any one of the JSON files inside, you'll see that each restaurant has a unique numeric identifier. For example, the identifier for The Tap Trailhouse restaurant is <code>145237</code>, as shown in the screenshot below:</p>
			<div><div><img src="img/Figure_21.12_B17469.jpg" alt="Figure 21.12: Editor area showing contents for Boston.json&#13;&#10;"/>
				</div>
			</div>
			<p class="figure-caption">Figure 21.12: Editor area showing contents for Boston.json</p>
			<p>When you save restaurant photos and reviews to the persistent store, you will save them together with this identifier. Then, when a particular restaurant is displayed in the <code>RestaurantDetailViewController</code> will use a <code>ReviewDataManager</code> instance to retrieve reviews and restaurant photos of that restaurant and display them in collection views, as shown in the screenshot:</p>
			<div><div><img src="img/Figure_21.13_B17469.jpg" alt="Figure 21.13: iOS Simulator showing Restaurant Detail screen with reviews and restaurant photos&#13;&#10;"/>
				</div>
			</div>
			<p class="figure-caption">Figure 21.13: iOS Simulator showing Restaurant Detail screen with reviews and restaurant photos</p>
			<p>If there are no<a id="_idIndexMarker1151"/> reviews or photos, you'll use the <code>NoDataView</code> to inform the user there are no reviews or photos, as shown in the screenshot:</p>
			<div><div><img src="img/Figure_21.14_B17469.jpg" alt="Figure 21.14: iOS Simulator showing Restaurant Detail screen without reviews or restaurant photos&#13;&#10;"/>
				</div>
			</div>
			<p class="figure-caption">Figure 21.14: iOS Simulator showing Restaurant Detail screen without reviews or restaurant photos</p>
			<p><code>RestaurantItem</code> has a <a id="_idIndexMarker1152"/>property, <code>restaurantID</code>, to store restaurant identifiers. When <code>RestaurantDataManager</code> loads a JSON file and creates an array of <code>RestaurantItem</code> instances, the identifier for each restaurant is obtained from the JSON file and stored in the <code>restaurantID</code> property.</p>
			<p>In the next section, you'll update <code>ReviewFormViewController</code> to save a review with a restaurant identifier to the persistent store.</p>
			<h1 id="_idParaDest-294"><a id="_idTextAnchor388"/>Updating the ReviewFormViewController class to save reviews</h1>
			<p>The <code>onSaveTapped(_:)</code> method to save a review to the persistent store when the <strong class="bold">Save </strong>button is tapped. Follow these steps:</p>
			<ol>
				<li value="1">Click the <code>ReviewFormViewController</code> file in the Project navigator. Add the following property to the <code>ReviewFormViewController</code> class before the outlet declarations to store the re<a id="_idTextAnchor389"/><a id="_idTextAnchor390"/>staurant identifier:<pre>var selectedRestaurantID: Int?</pre></li>
				<li>Create a <code>private</code> extension, move the <code>onSaveTapped(_:)</code> method into it, and m<a id="_idTextAnchor391"/><a id="_idTextAnchor392"/>odify it as follows:<pre>private extension ReviewFormViewController {
   @IBAction func onSaveTapped(_ sender: Any) {
<code>onSaveTapped(_:)</code> will now create a <code>ReviewItem</code> instance, assign data obtained from the <code>CoreDataManager.shared.addReview(reviewItem)</code> to save the review to the persistent store.</p></li>
			</ol>
			<p>Note that <a id="_idIndexMarker1154"/>there is no mechanism to pass a restaurant identifier to <code>ReviewFormViewController</code> at present. In the next section, you'll see how to get the restaurant identifier from <code>RestaurantDetailViewController</code> and pass it to <code>ReviewFormViewController</code>.</p>
			<h2 id="_idParaDest-295"><a id="_idTextAnchor393"/>Passing RestaurantID to the ReviewFormViewController instance</h2>
			<p>The <code>ReviewFormViewController</code> get that identifier from? You must pass the identifier value from <code>RestaurantDetailViewController</code> to <code>ReviewFormViewController</code> so that it can save reviews with the restaurant identifier for that restaurant. As you did before in <a href="B17469_17_Final_VK_ePub.xhtml#_idTextAnchor248"><em class="italic">Chapter 17</em></a><em class="italic">, Getting Started with JSONFiles</em>, you'll use segue identifiers to determine which segue is occurring, and then implement methods to pass the identifier value between the two view controllers. Follow these steps:</p>
			<ol>
				<li value="1">Open the <code>RestaurantDetail</code> storyboard file and select the segue used to go to the <strong class="bold">ReviewForm</strong> scene:<div><img src="img/Figure_21.15_B17469.jpg" alt="Figure 21.15: Editor area showing segue between Restaurant Detail and Review Form screens selected&#13;&#10;"/></div><p class="figure-caption">Figure 21.15: Editor area showing segue between Restaurant Detail and Review Form screens selected</p></li>
				<li>In<a id="_idIndexMarker1156"/> the Attributes inspector, set <code>showReview</code> and press <em class="italic">Return</em>:<div><img src="img/Figure_21.16_B17469.jpg" alt="Figure 21.16: Attributes inspector with Identifier set to showReview&#13;&#10;"/></div><p class="figure-caption">Figure 21.16: Attributes inspector with Identifier set to showReview</p></li>
				<li>Click<a id="_idIndexMarker1157"/> the <code>RestaurantDetailViewController</code> file in the Project navigator. Add the following code after <code>viewDidLoad()</code> to implement the<code> prepar<a id="_idTextAnchor394"/><a id="_idTextAnchor395"/>e(for:sender:)</code> method:<pre>override func prepare(for segue: 
UIStoryboardSegue, sender: Any?) {
   if let identifier = segue.identifier {
      switch identifier  {
      case Segue.showReview.rawValue:
         showReview(segue: segue)
      default:
         print("Segue not added")
      }
   }
}</pre><p>The <code>prepare(for:sender:)</code> method checks to see if the segue has the <code>showReview</code> segue identifier. If it does, the <code>showReview(segue:)</code> method is executed prior to transitioning from the <code>showReview(segue:)</code> has not been implemented yet. You'll add that next.</p></li>
				<li>Add <a id="_idIndexMarker1158"/>the <code>showReview(segue:)</code> method inside the <code>private</code> extension, before the<a id="_idTextAnchor396"/><a id="_idTextAnchor397"/> <code>createRating()</code> method:<pre>func showReview(segue: UIStoryboardSegue) {
   guard let navController = segue.destination as? 
   UINavigationController, let viewController = 
   navController.topViewController as? 
   ReviewFormViewController else {
      return
   }
   viewController.selectedRestaurantID = 
   selectedRestaurant?.restaurantID
}</pre><p>This sets the <code>restaurantID</code> property of <code>ReviewFormViewController</code> to the identifier of the selected restaurant.</p></li>
				<li>Click the <code>ReviewFormViewController</code> file in the Project navigator. Add the following code inside the <code>viewDidLoad()</code> method to print the restaurant identifier to the Debug ar<a id="_idTextAnchor398"/><a id="_idTextAnchor399"/>ea:<pre>super.viewDidLoad()
<code>ReviewFormViewController</code>.</p></li>
			</ol>
			<p>Build<a id="_idIndexMarker1159"/> and run your project, set a location, and tap <strong class="bold">All</strong>. Tap a restaurant, and tap the <strong class="bold">Add Review</strong> button. In the <strong class="bold">Review Form</strong> screen, enter a review and tap <strong class="bold">Save</strong>:</p>
			<div><div><img src="img/Figure_21.17_B17469.jpg" alt="Figure 21.17: iOS Simulator showing Review Form screen Save button&#13;&#10;"/>
				</div>
			</div>
			<p class="figure-caption">Figure 21.17: iOS Simulator showing Review Form screen Save button</p>
			<p> The restaurant identifier will appear in the Debug area:</p>
			<p class="figure-caption"> </p>
			<div><div><img src="img/Figure_21.18_B17469.jpg" alt="Figure 21.18: Debug area showing the restaurant identifier&#13;&#10;"/>
				</div>
			</div>
			<p class="figure-caption">Figure 21.18: Debug area showing the restaurant identifier</p>
			<p>You've<a id="_idIndexMarker1160"/> successfully passed the restaurant identifier from <code>RestaurantDetailViewController</code> to <code>ReviewFormViewController</code>. Now, let's do the same for photos. You'll update <code>PhotoFilterViewController</code> to save photos with a restaurant identifier to the persistent store when the <strong class="bold">Save</strong> button is tapped in the next section.</p>
			<h1 id="_idParaDest-296"><a id="_idTextAnchor400"/>Updating the PhotoFilterViewController class to save photos</h1>
			<p>The code <a id="_idIndexMarker1161"/>that enables the <code>PhotoFilterViewController</code> class to save photos to the persistent store is similar to the code you implemented in the <code>ReviewFormViewController</code> class for saving reviews. You will now update the <code>PhotoFilterViewController</code> class to save photos when the <strong class="bold">Save</strong> button is tapped. Follow these steps:</p>
			<ol>
				<li value="1">Click the <code>PhotoFilterViewController</code> file in the Project navigator. Add the following method inside the <code>private</code> extension after t<a id="_idTextAnchor401"/><a id="_idTextAnchor402"/>he <code>initialize()</code> method: <pre>func saveSelectedPhoto() {
   if let mainImage = self.mainImageView.image {
      var restPhotoItem = 
      RestaurantPhotoItem()
      restPhotoItem.date = Date()
      restPhotoItem.photo = 
      mainImage.preparingThumbnail(of: 
      CGSize(width: 100, height: 100))
      if let selRestID = selectedRestaurantID 
      {
         restPhotoItem.restaurantID = 
         Int64(selRestID)
      }
      CoreDataManager.shared
      .addPhoto(restPhotoItem)
   }
   dismiss(animated: true, completion: nil)
}</pre><p>Remember<a id="_idIndexMarker1162"/> that <code>mainImageView</code> is the outlet for the large image view in the <code>saveSelectedPhoto()</code> method first checks to see if the <code>image</code> property of <code>mainImageView</code> is set. If it is, the image is assigned to <code>mainImage</code>. Next, a <code>RestaurantPhotoItem</code> instance is created and assigned to <code>restPhotoItem</code>, and the current date is assigned to the <code>restPhotoItem</code> instance's <code>date</code> property. The <code>mainImage</code> instance's <code>preparingThumbnail(of:)</code> method is used to create a smaller version of the image, which is assigned to the <code>restPhotoItem</code> instance's <code>photo</code> property. After that, the <code>restPhotoItem</code> instance's <code>restaurantID</code> property is set to the selected restaurant's identifier. Finally, the <code>CoreDataManager.shared.addPhoto(_:)</code> method is called to save the photo to the persistent store, and the <strong class="bold">Photo Filter</strong> screen is dismissed.</p></li>
				<li>You need to trigger this method when the <code>private</code> extension after the <code>o<a id="_idTextAnchor403"/><a id="_idTextAnchor404"/>nPhotoTapped(_:)</code> method: <pre>@IBAction func onSaveTapped(_ sender: Any) { 
   saveSelectedPhoto()
}</pre><p>This method will be connected to the <strong class="bold">Save</strong> button later.</p></li>
				<li>To<a id="_idIndexMarker1163"/> assign the <code>onSaveTapped(_:)</code> method to the <code>PhotoFilter</code> storyboard file and click the <strong class="bold">Photo Filter View Controller</strong> icon in the <strong class="bold">Photo Filter View Controller Scene</strong>. Open the Connections inspector. Drag from the <strong class="bold">onSaveTapped</strong> action to the <strong class="bold">Save</strong> button:</li>
			</ol>
			<div><div><img src="img/Figure_21.19_B17469.jpg" alt="Figure 21.19: Connections inspector showing onSaveTapped: being assigned to the Save button&#13;&#10;"/>
				</div>
			</div>
			<p class="figure-caption">Figure 21.19: Connections inspector showing onSaveTapped: being assigned to the Save button</p>
			<p>Before you can save, you need to pass the restaurant identifier to <code>PhotoFilterViewController</code>. As you did before, you'll use segue identifiers to determine which segue is occurring, and then implement methods to pass the identifier value between<a id="_idIndexMarker1164"/> the two view controllers. Follow these steps:</p>
			<ol>
				<li value="1">Click the <code>RestaurantDetail</code> storyboard file in the Project navigator and select the segue used to go to the <strong class="bold">Photo Filter</strong> screen:<p class="figure-caption"> </p><div><img src="img/Figure_21.20_B17469.jpg" alt="Figure 21.20: Editor area showing segue between Restaurant Detail and Photo Filter screens selected&#13;&#10;"/></div><p class="figure-caption">Figure 21.20: Editor area showing segue between Restaurant Detail and Photo Filter screens selected</p></li>
				<li>In the Attributes inspector, set <code>showPhotoFilter</code> and press <em class="italic">Return</em>:<div><img src="img/Figure_21.21_B17469.jpg" alt="Figure 21.21: Attributes inspector with Identifier set to showPhotoFilter&#13;&#10;"/></div><p class="figure-caption">Figure 21.21: Attributes inspector with Identifier set to showPhotoFilter</p></li>
				<li>Click<a id="_idIndexMarker1165"/> the <code>RestaurantDetailViewController</code> file in the Project navigator. Update the <code>prepare(for:sender:)</code> method, as follows:<pre>override func prepare(for segue: UIStoryboardSegue,
sender: Any?){
   if let identifier = segue.identifier {
      switch identifier {
      case Segue.showReview.rawValue:
         showR<a id="_idTextAnchor405"/><a id="_idTextAnchor406"/>eview(segue: segue)
<code>prepare(for:sender:)</code> method check to see if the segue has the <code>showPhotoFilter</code> segue identifier. If it does, the <code>showPhotoFilter(segue:)</code> method is executed prior to transitioning from the <code>showPhotoFilter(segue:)</code> has not been implemented yet.</p></li>
				<li>Add <a id="_idIndexMarker1166"/>the <code>showPhotoFilter(segue:)</code> method after the <code>showReview()</code> method insi<a id="_idTextAnchor407"/><a id="_idTextAnchor408"/>de your <code>private</code> extension:<pre>func showPhotoFilter(segue: UIStoryboardSegue) {
   guard let navController = segue.destination as? 
   UINavigationController, let viewController = 
   navController.topViewController as? 
   PhotoFilterViewController else {
      return
   }
   viewController.selectedRestaurantID = 
   selectedRestaurant?.restaurantID
}</pre><p>This sets <code>PhotoFilterViewController</code>'s <code>restaurantID</code> property to the identifier of the selected restaurant.</p></li>
			</ol>
			<p>Build and run your project, set a location, and tap <strong class="bold">All</strong>. Tap a restaurant, and tap the <strong class="bold">Add Photo</strong> button. Select a photo, apply a filter, and tap <strong class="bold">Save</strong>:</p>
			<div><div><img src="img/Figure_21.22_B17469.jpg" alt="Figure 21.22: iOS Simulator showing Photo Filter screen with Save button selected&#13;&#10;"/>
				</div>
			</div>
			<p class="figure-caption">Figure 21.22: iOS Simulator showing Photo Filter screen with Save button selected</p>
			<p>The photo will <a id="_idIndexMarker1167"/>be saved to the persistent store, and you will be returned to the <strong class="bold">Restaurant Detail</strong> screen.</p>
			<p>At this point, you can save reviews and photos. Fantastic! In the next section, you will add code to load the reviews and photos from the persistent store to be displayed on the <strong class="bold">Restaurant Detail</strong> screen.</p>
			<h1 id="_idParaDest-297"><a id="_idTextAnchor409"/>Displaying saved reviews and photos on the Restaurant Detail screen</h1>
			<p>The <code>RestaurantDetail.storyboard</code>, you'll see that collection<a id="_idIndexMarker1169"/> views have already been set up to display photos and reviews in the static table view cells. All<a id="_idIndexMarker1170"/> you need to do is to implement the respective<a id="_idIndexMarker1171"/> view controllers for the view and collection view cells. You'll start with the view and collection view cells used to display reviews. Follow these steps:</p>
			<ol>
				<li value="1">Right-click the <code>LetsEat</code> folder in the Project navigator and choose <code>Reviews</code>.</li>
				<li>Right-click the folder and select <strong class="bold">New File</strong>.</li>
				<li><strong class="bold">iOS</strong> should already be selected. Choose <strong class="bold">Cocoa Touch Class</strong>, and then click <strong class="bold">Next</strong>.</li>
				<li>Configure the file as follows:<p><code>ReviewCell</code></p><p><code>UICollectionViewCell</code> </p><p><code>Swift</code></p><p>Click <strong class="bold">Next</strong>.</p></li>
				<li>Click <code>ReviewCell</code> file appears in the Project navigator. Enter the following <a id="_idTextAnchor410"/><a id="_idTextAnchor411"/>code between the curly braces:<pre>import UIKit
class ReviewC<a id="_idTextAnchor412"/><a id="_idTextAnchor413"/>ell: UICollectionViewCell {
<strong class="bold">   @IBOutlet var titleLabel: UILabel!</strong>
<strong class="bold">   @IBOutlet var dateLabel: UILabel!</strong>
<strong class="bold">   @IBOutlet var nameLabel: UILabel!</strong>
<strong class="bold">   @IBOutlet var reviewLabel: UILabel!</strong>
<strong class="bold">   @IBOutlet var ratingsView: RatingsView!</strong>
}</pre></li>
			</ol>
			<p><code>ReviewCell</code> now <a id="_idIndexMarker1172"/>has the properties for<a id="_idIndexMarker1173"/> all the outlets <a id="_idIndexMarker1174"/>in the <a id="_idIndexMarker1175"/>collection view cell. Let's create <code>ReviewsViewController</code> next. Follow these steps:</p>
			<ol>
				<li value="1">Right-click the <code>Reviews</code> folder, and select <strong class="bold">New File</strong>.</li>
				<li><strong class="bold">iOS</strong> should already be selected. Choose <strong class="bold">Cocoa Touch Class</strong>, and then click <strong class="bold">Next</strong>.</li>
				<li>Configure the file as follows:<p><code> ReviewsViewController</code></p><p><code>UIViewController </code></p><p><code>Swift</code></p><p>Click <strong class="bold">Next</strong>.</p></li>
				<li>Click <code>ReviewsViewController</code> file appears in the Project navig<a id="_idTextAnchor414"/><a id="_idTextAnchor415"/>ator. Modify this file as follows:<pre>import UIKit
class ReviewsViewController: UIViewController {
   <code>ReviewsViewController</code> is straightforward. You have an outlet for a collection view, <code>collectionView</code>. <code>selectedRestaurantID</code> stores the restaurant <a id="_idIndexMarker1178"/>identifier. <code>reviewItems</code> contains<a id="_idIndexMarker1179"/> an array of <code>ReviewItem</code> instances. <code>dateFormatter</code> is an instance of the <code>DateFormatter</code> class that will be used to format the date for display. Don't worry about the errors, as you'll be typing in the implementation of the <code>initialize()</code> and <code>setupDefaults()</code> methods in the next step.</p><p class="callout-heading">Important Information</p><p class="callout">To learn more <a id="_idIndexMarker1180"/>about the <code>DateFormatter</code> class, visit this link: <a href="https://developer.apple.com/documentation/foundation/dateformatter">https://developer.apple.com/documentation/foundation/dateformatter</a>.</p></li>
				<li>Add a <code>private</code> exten<a id="_idTextAnchor416"/><a id="_idTextAnchor417"/>sion <a id="_idIndexMarker1181"/>with <a id="_idIndexMarker1182"/>the following code, as shown:<pre>private extension ReviewsViewController {
   func initialize() {
      setupCollectionView()
   }
   func setupCollectionView() {
      let flow = UICollectionViewFlowLayout()
      flow.sectionInset = UIEdgeInsets(top: 7,left: 7,
      bottom: 7, right: 7)
      flow.minimumInteritemSpacing = 0 
      flow.minimumLineSpacing = 7 
      flow.scrollDirection = .horizontal 
      collectionView.collectionViewLayout = flow
   }
}</pre><p>The <code>private</code> extension<a id="_idIndexMarker1183"/> contains<a id="_idIndexMarker1184"/> the implementation for <code>initialize()</code> and <code>setupCollectionView()</code> methods. <code>initialize()</code> just calls <code>setupCollectionView()</code>. <code>setupCollectionView()</code> is used to configure the flow and spacing of the collection views and is similar to code you've written before.</p></li>
				<li>Add <a id="_idIndexMarker1185"/>the <a id="_idIndexMarker1186"/>following method <a id="_idIndexMarker1187"/>after <code>setu<a id="_idTextAnchor418"/><a id="_idTextAnchor419"/>pCollectionView()</code> to <a id="_idIndexMarker1188"/>implement <code>checkReviews()</code>:<pre>func checkReviews() {
   let viewController = self.parent as? 
   RestaurantDetailViewController
   if let restaurantID = 
   viewController?.selectedRestaurant?
   .restaurantID {
      reviewItems = 
      CoreDataManager.shared
      .fetchReviews(by: restaurantID)
      if !reviewItems.isEmpty {
         collectionView.backgroundView = nil
      } else {
         let view = NoDataView(frame: 
         CGRect(x: 0, y: 0, width: 
         collectionView.frame.width,
         height: 
         collectionView.frame.height))
      view.set(title: "Reviews", desc: 
      "There are currently no reviews")
      collectionView.backgroundView = view
      }
   }
   collectionView.reloadData()
}</pre><p>This method will retrieve all restaurant reviews for the specified restaurant identifier. Let's break this down:</p><pre>let viewController = self.parent as? 
RestaurantDetailViewController</pre><p>This <a id="_idIndexMarker1189"/>statement assigns <code>RestaurantDetailViewController</code> to a temporary constant, <code>viewController</code>.</p><pre>if let restaurantID = 
viewController?.selectedRestaurant?.restaurantID { </pre><p>This <a id="_idIndexMarker1190"/>statement<a id="_idIndexMarker1191"/> assigns the restaurant<a id="_idIndexMarker1192"/> identifier of the restaurant shown in the <code>restaurantID</code>.</p><pre>reviewItems = CoreDataManager.shared
.fetchReviews(by: restaurantID)</pre><p>This statement gets an array of reviews matching the given <code>restaurantID</code> from the persistent store and assigns it to <code>reviewItems</code>.</p><pre>if !reviewItems.isEmpty {
   collectionView.backgroundView = nil
} else {
   let view = NoDataView(frame: 
   CGRect(x: 0, y: 0, width: 
   collectionView.frame.width,
   height: 
   collectionView.frame.height))
   view.set(title: "Reviews", desc: 
   "There are currently no reviews")
   collectionView.backgroundView = view
}</pre><p>If there<a id="_idIndexMarker1193"/> are reviews for this restaurant, the <a id="_idIndexMarker1194"/>collection view's background view is set to <code>nil</code>; otherwise, you create a <code>NoDataView</code> instance, set the <code>title</code> and <code>desc</code> properties to <code>"Reviews"</code> and <code>"There are currently no reviews"</code> respectively, and assign it to the collection view's background view.</p><pre>collectionView.reloadData()</pre><p>This code tells the collection view to redraw itself onscreen.</p></li>
				<li>Implement <a id="_idIndexMarker1195"/>the data source methods<a id="_idIndexMarker1196"/> for<a id="_idTextAnchor420"/><a id="_idTextAnchor421"/> the collection view by adding the following extension:<pre>extension ReviewsViewController: 
UICollectionViewDataSource {
   func collectionView(_ collectionView: 
   UICollectionView, numberOfItemsInSection 
   section: Int) -&gt; Int {
      reviewItems.count
   }
   func collectionView(_ collectionView: 
   UICollectionView, cellForItemAt indexPath: 
   IndexPath) -&gt; UICollectionViewCell {
      let cell = collectionView
      .dequeueReusableCell 
      (withReuseIdentifier: "reviewCell", 
      for: indexPath) as! ReviewCell
      let reviewItem = reviewItems[indexPath.item] 
      cell.nameLabel.text = reviewItem.name 
      cell.titleLabel.text = reviewItem.title 
      cell.reviewLabel.text = 
      reviewItem.customerReview 
      if let reviewItemDate = reviewItem.date {
         cell.dateLabel.text = 
         dateFormatter.string(from: 
         reviewItemDate)
      }
      if let reviewItemRating = reviewItem.rating 
      {
         cell.ratingsView.rating = 
         reviewItemRating
      }
      return cell
   }
}</pre><p>This is similar to what you've done before. The number of cells to be displayed in the collection view is the same as the number of items in the <code>reviewItems</code> array. You set each cell's contents using the properties of the corresponding <code>ReviewItem</code> instance.</p></li>
				<li>Add the flow <a id="_idIndexMarker1197"/>layout delegate <a id="_idIndexMarker1198"/>methods f<a id="_idTextAnchor422"/><a id="_idTextAnchor423"/>or the collection <a id="_idIndexMarker1199"/>view by adding the<a id="_idIndexMarker1200"/> following extension:<pre>extension ReviewsViewController: UICollectionViewDelegateFlowLayout {
   func collectionView(_ collectionView: 
   UICollectionView, layout collectionViewLayout: 
   UICollectionViewLayout, sizeForItemAt 
   indexPath: IndexPath) -&gt; CGSize {
      let edgeInset = 7.0
      if reviewItems.count == 1 {
         let cellWidth = 
         collectionView.frame.size.width - 
         (edgeInset * 2) 
         return CGSize(width: cellWidth, height: 
         200)
      } else {
         let cellWidth = 
         collectionView.frame.size.width - 
         (edgeInset * 3)
         return CGSize(width: cellWidth, height: 
         200)
      }
   }
}</pre><p>This<a id="_idIndexMarker1201"/> method returns the size of the<a id="_idIndexMarker1202"/> collection view cell to be <a id="_idIndexMarker1203"/>displayed. If there is only <a id="_idIndexMarker1204"/>one item in the <code>reviewItems</code> array, the cell's width is set to the width of the collection view—14 points; otherwise, it is set to the width of the collection view—21 points. The height is set to <code>200</code> points.</p></li>
			</ol>
			<p><code>ReviewsViewController</code> is now complete. Now, you'll finish the implementation of the <code>RestaurantDetail</code> storyboard file. Follow these steps:</p>
			<ol>
				<li value="1">Click the <code>RestaurantDetail</code> storyboard file in the Project navigator. Select the <code>ReviewsViewController,</code> and press <em class="italic">Return</em>:<div><img src="img/Figure_21.23_B17469.jpg" alt="Figure 21.23: Identity inspector with Class set to ReviewsViewController&#13;&#10;"/></div><p class="figure-caption">Figure 21.23: Identity inspector with Class set to ReviewsViewController</p><p>The scene name will change to <strong class="bold">Reviews View Controller Scene</strong>.</p></li>
				<li>Select the <code>ReviewCell,</code> and press <em class="italic">Return</em>:<p class="figure-caption"> </p><div><img src="img/Figure_21.24_B17469.jpg" alt="Figure 21.24: Identity inspector with Class set to ReviewCell&#13;&#10;"/></div><p class="figure-caption">Figure 21.24: Identity inspector with Class set to ReviewCell</p></li>
				<li>Select the<a id="_idIndexMarker1205"/> view in<a id="_idIndexMarker1206"/> the document outline. Click <a id="_idIndexMarker1207"/>the Identity inspector <a id="_idIndexMarker1208"/>button, set <code>RatingsView,</code> and press <em class="italic">Return</em>:<div><img src="img/Figure_21.25_B17469.jpg" alt="Figure 21.25: Identity inspector with Class set to RatingsView&#13;&#10;"/></div><p class="figure-caption">Figure 21.25: Identity inspector with Class set to RatingsView</p></li>
				<li>Select <code>reviewCell</code> if it's not already set:<p class="figure-caption"> </p><div><img src="img/Figure_21.26_B17469.jpg" alt="Figure 21.26: Attributes inspector with Identifier set to reviewCell&#13;&#10;"/></div><p class="figure-caption">Figure 21.26: Attributes inspector with Identifier set to reviewCell</p></li>
				<li>Click <a id="_idIndexMarker1209"/>the<a id="_idIndexMarker1210"/> Connections inspector. Drag from the <code>dateLabel</code> outlet to the <strong class="bold">Label</strong> shown, if it's not <a id="_idIndexMarker1211"/>already set:<div><img src="img/Figure_21.27_B17469.jpg" alt="Figure 21.27: Connections inspector showing dateLabel outlet&#13;&#10;"/></div><p class="figure-caption">Figure 21.27: Connections inspector showing dateLabel outlet</p></li>
				<li>Drag<a id="_idIndexMarker1212"/> from the <code>nameLabel</code> outlet to the <strong class="bold">Label</strong> shown, if it's not already set:<p class="figure-caption"> </p><div><img src="img/Figure_21.28_B17469.jpg" alt="Figure 21.28: Connections inspector showing nameLabel outlet&#13;&#10;"/></div><p class="figure-caption">Figure 21.28: Connections inspector showing nameLabel outlet</p></li>
				<li> Drag<a id="_idIndexMarker1213"/> from the <code>reviewLabel</code> outlet<a id="_idIndexMarker1214"/> to the <strong class="bold">Label</strong> shown, if it's not already set:<div><img src="img/Figure_21.29_B17469.jpg" alt="Figure 21.29: Connections inspector showing reviewLabel outlet&#13;&#10;"/></div><p class="figure-caption">Figure 21.29: Connections inspector showing reviewLabel outlet</p></li>
				<li>Drag<a id="_idIndexMarker1215"/> from the <code>titleLabel</code> outlet<a id="_idIndexMarker1216"/> to the <strong class="bold">Label</strong> shown, if it's not already set:<div><img src="img/Figure_21.30_B17469.jpg" alt="Figure 21.30: Connections inspector shown titleLabel outlet&#13;&#10;"/></div><p class="figure-caption">Figure 21.30: Connections inspector shown titleLabel outlet</p></li>
				<li>Drag <a id="_idIndexMarker1217"/>from the <code>ratingsView</code> outlet to the ratings view shown, if it's not already set:<div><img src="img/Figure_21.31_B17469.jpg" alt="Figure 21.31: Connections inspector showing the ratingsView outlet&#13;&#10;"/></div><p class="figure-caption">Figure 21.31: Connections inspector showing the ratingsView outlet</p></li>
				<li>Select <a id="_idIndexMarker1218"/>the <code>collectionView</code> outlet to the <strong class="bold">Collection View</strong> as shown, if it's not already set:<p class="figure-caption"> </p><div><img src="img/Figure_21.32_B17469.jpg" alt="Figure 21.32: Connections inspector showing the collectionView outlet&#13;&#10;"/></div><p class="figure-caption">Figure 21.32: Connections inspector showing the collectionView outlet</p></li>
				<li>Select <code>delegate</code> and <code>dataSource</code> outlets to the <strong class="bold">Reviews View Controller</strong> icon:</li>
			</ol>
			<p class="figure-caption"> </p>
			<div><div><img src="img/Figure_21.33_B17469.jpg" alt="Figure 21.33: Connections inspector showing the dataSource and delegate outlets&#13;&#10;"/>
				</div>
			</div>
			<p class="figure-caption">Figure 21.33: Connections inspector showing the dataSource and delegate outlets</p>
			<p>Build and run your app. You should see the reviews you added earlier appear:</p>
			<div><div><img src="img/Figure_21.34_B17469.jpg" alt="Figure 21.34: iOS Simulator showing Restaurant Detail screen containing reviews&#13;&#10;"/>
				</div>
			</div>
			<p class="figure-caption">Figure 21.34: iOS Simulator showing Restaurant Detail screen containing reviews</p>
			<p>The<a id="_idIndexMarker1223"/> implementation of view controllers for the collection<a id="_idIndexMarker1224"/> view and collection <a id="_idIndexMarker1225"/>view cells used to display <a id="_idIndexMarker1226"/>reviews is now complete, and your app now can display reviews that were entered using the <strong class="bold">Review Form</strong> screen earlier. If you have more than one review, you can swipe left and right to see each review. Since each review has a rating, you can use them to calculate and add an overall rating for a restaurant. Let's modify the app to do this next.</p>
			<h1 id="_idParaDest-298"><a id="_idTextAnchor424"/>Calculating a restaurant's overall rating</h1>
			<p>The <code>CoreDataManager</code> to do this. Follow these steps:</p>
			<ol>
				<li value="1">Click the <code>CoreDataManager</code> file inside the Project navigator (inside the <code>Core Data</code> folder in t<a id="_idTextAnchor425"/><a id="_idTextAnchor426"/>he <code>Misc</code> folder). Add the following method before the <code>addReview(_:)</code> method:<pre>func fetchRestaurantRating(by identifier: Int) -&gt; 
Double { 
   let reviewItems = fetchReviews(by: identifier)
   let sum = reviewItems.reduce(0, {$0 + 
   ($1.rating ?? 0)}) 
   return sum / Double(reviewItems.count)
}</pre><p>In this<a id="_idIndexMarker1228"/> method, all reviews for a particular restaurant are fetched from the persistent store and assigned to <code>reviews</code>. The <code>reduce()</code> method takes a closure, which is used to add all the review ratings together. Finally, the average rating value is calculated and returned.</p><p class="callout-heading">Important Information</p><p class="callout">You can learn more about<a id="_idIndexMarker1229"/> the <code>reduce()</code> method at this link: <a href="https://developer.apple.com/documentation/swift/array/2298686-reduce">https://developer.apple.com/documentation/swift/array/2298686-reduce</a>.</p></li>
				<li>Click the <code>RestaurantDetailViewController</code> file in the Project navigator (inside<a id="_idTextAnchor427"/><a id="_idTextAnchor428"/> the <code>RestaurantDetail</code> folder). Update the <code>createRating()</code> method, as follows:<pre>func createRating() {
   ratingsView.isEnabled = <code>selectedRestaurant</code> instance's <code>restaurantID</code> property to <code>restaurantID</code>. If successful, the <code>CoreDataManager.shared.fetchRestaurantRating()</code> method is called, which <a id="_idIndexMarker1230"/>gets all the reviews with <code>restaurantID</code>'s restaurant identifier value, and calculates the average rating. <code>ratingValue</code> is then set to the average rating and used to update the ratings view's <code>rating</code> property, which determines the number of stars displayed in the <code>roundedValue</code> is then calculated from <code>ratingValue</code> to return a number with 1 decimal point, and is used to set the <code>text</code> property for <code>overallRatingLabel</code>.</p></li>
				<li>The overall rating will also need to be updated whenever the user adds a new review in the <code>viewDidLoad()</code> method:<pre>override func viewDidAppear(_ animated: Bool) {
   super.viewDidAppear(animated)
   createRating()
}</pre><p>This will recalculate <a id="_idIndexMarker1231"/>the rating when the <strong class="bold">Review Form</strong> screen is dismissed and the <strong class="bold">Restaurant Detail</strong> screen reappears.</p></li>
			</ol>
			<p>Build and run your project, and you should now see an overall rating for restaurants that have reviews, as well as a corresponding star rating as shown:</p>
			<div><div><img src="img/Figure_21.35_B17469.jpg" alt="Figure 21.35: iOS Simulator showing Restaurant Detail screen with overall ratings&#13;&#10;"/>
				</div>
			</div>
			<p class="figure-caption">Figure 21.35: iOS Simulator showing Restaurant Detail screen with overall ratings</p>
			<p>There's still one<a id="_idIndexMarker1232"/> thing left to do, and that's adding photo reviews. Your challenge is to add photo reviews and to display them in the collection view just under the collection view used for reviews. The way to do this is very similar to the way you used to add reviews. This chapter covers all you need to know, and if you get stuck, feel free to use the completed project files for this chapter, which you will find in the <code>Chapter21</code> folder of the code bundle of this book, downloadable from <a href="https://github.com/PacktPublishing/iOS-15-Programming-for-Beginners-Sixth-Edition">https://github.com/PacktPublishing/iOS-15-Programming-for-Beginners-Sixth-Edition</a>. You can also watch the CiA video for this chapter, located at <a href="https://bit.ly/3o81yKK">https://bit.ly/3o81yKK</a>.</p>
			<h1 id="_idParaDest-299"><a id="_idTextAnchor429"/>Summary</h1>
			<p>In this chapter, you learned about Core Data and its different components. You created data models for your app named <code>Review</code> and <code>RestaurantPhoto</code>, and you created the corresponding model objects for your app named <code>ReviewItem</code> and <code>RestaurantPhotoItem</code>. After that, you implemented <code>CoreDataManager</code> to set up Core Data components for your app. </p>
			<p>You updated <code>ReviewFormViewController</code> and <code>PhotoFilterViewController</code> to save reviews and photos together with a restaurant identifier to the persistent store. You modified <code>RestaurantDetailViewController</code> to load reviews for a particular restaurant based on the restaurant identifier, and displayed them in a collection view. You also calculated and displayed the overall rating for that restaurant.</p>
			<p>Finally, on your own, you modified <code>RestaurantDetailViewController</code> to load photos for a particular restaurant based on the restaurant identifier, and displayed them in a collection view.</p>
			<p>You now have a basic understanding of how Core Data works. You're also able to set up Core Data components and enable an interface between your app and Core Data components using a data manager class. You also know how to save and load reviews and photos using Core Data, which you will now be able to implement in your own apps. </p>
			<p>You have come to the end of a long journey, and have now finished building your app's primary functionality. All the screens work, and reviews and photos are persistent. Fantastic job!</p>
			<p>This concludes <em class="italic">Part 3</em> of this book. In the next part, you'll find out about the cool new features Apple has introduced in iOS 15 and how to add them to your app, starting with getting your app ready for Apple Macs in the next chapter.</p>
		</div>
	</body></html>