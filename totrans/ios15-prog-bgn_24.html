<html><head></head><body>
		<div id="_idContainer515">
			<h1 id="_idParaDest-285"><em class="italic"><a id="_idTextAnchor362"/>Chapter 21</em>: Understanding Core Data</h1>
			<p>Your app is almost done! Every screen works as shown in the app tour that you went through in <a href="B17469_09_Final_VK_ePub.xhtml#_idTextAnchor133"><em class="italic">Chapter 9</em></a><em class="italic">, Setting Up the User Interface</em>. However, there is one last thing that you need to do. In <a href="B17469_19_Final_VK_ePub.xhtml#_idTextAnchor319"><em class="italic">Chapter 19</em></a><em class="italic">, Getting Started with Custom UIControls</em>, you implemented a <strong class="bold">Review Form</strong> screen, which lets you enter a review for a particular restaurant. In the previous chapter, you implemented a <strong class="bold">Photo Filter </strong>screen, which lets you get a photo from the camera or photo library and add a filter to it. But there is no way at present to save either reviews or photos, and they are lost when the app is closed.</p>
			<p>In this chapter, you will use <strong class="bold">Core Data</strong> to save reviews and photos in your app. First, you'll learn about Core Data and its different components. Next, you'll create a data model for reviews and photos and create corresponding model objects for your app. After that, you'll set up Core Data components for your app.</p>
			<p>You'll then learn about the mechanism used to save reviews and photos for a particular restaurant using the restaurant identifier. After that, you'll update the <strong class="source-inline">ReviewFormViewController</strong> and <strong class="source-inline">PhotoFilterViewController</strong> classes to save reviews and photos for a particular restaurant, and modify the <strong class="source-inline">RestaurantDetailViewController</strong> class to load and display reviews for a particular restaurant. You'll also calculate and display the overall rating for that restaurant.</p>
			<p>Finally, on your own, you'll modify the <strong class="source-inline">RestaurantDetailViewController</strong> class to load and display photos for a particular restaurant.</p>
			<p>By the end of this chapter, you'll understand how Core Data works. You'll also be able to set up Core Data components, and enable an interface between your app and Core Data components using a data manager class. You'll have also learned to save and load reviews and photos using Core Data, which you will then be able to implement in your own apps.</p>
			<p> The following topics will be covered: </p>
			<ul>
				<li>Introducing Core Data</li>
				<li>Implementing Core Data components for your app</li>
				<li>Understanding how saving and loading works</li>
				<li>Updating the <strong class="source-inline">ReviewFormViewController</strong> class to save reviews</li>
				<li>Updating the <strong class="source-inline">PhotoFilterViewController</strong> class to save photos</li>
				<li>Displaying saved reviews and photos in the <strong class="bold">Restaurant Detail</strong> screen</li>
				<li>Calculating a restaurant's overall rating</li>
			</ul>
			<h1 id="_idParaDest-286"><a id="_idTextAnchor363"/>Technical requirements</h1>
			<p>You will continue working on the <strong class="source-inline">LetsEat</strong> project that you modified in the previous chapter.</p>
			<p>The completed Xcode project for this chapter is in the <strong class="source-inline">Chapter21</strong> folder of the code bundle for this book, which can be downloaded here:</p>
			<p><a href="https://github.com/PacktPublishing/iOS-15-Programming-for-Beginners-Sixth-Edition">https://github.com/PacktPublishing/iOS-15-Programming-for-Beginners-Sixth-Edition</a></p>
			<p>Check out the following video to see the code in action: </p>
			<p><a href="https://bit.ly/3o81yKK">https://bit.ly/3o81yKK</a></p>
			<p>Let's start by learning about the components of Core Data and how it works. </p>
			<h1 id="_idParaDest-287"><a id="_idTextAnchor364"/>Introducing Core Data</h1>
			<p>Core Data<a id="_idIndexMarker1119"/> is Apple's mechanism for saving app data to your device. It provides persistence, undo/redo, background tasks, view synchronization, versioning, and migration. You can define your data types and relationships using Xcode's data model editor, and Core Data will generate class definitions for your data types automatically. Core Data can then create and manage object instances based on the class definitions.</p>
			<p class="callout-heading">Important Note</p>
			<p class="callout">You can learn more about Core Data at this link:  <a href="https://developer.apple.com/documentation/coredata">https://developer.apple.com/documentation/coredata</a>.</p>
			<p>Core Data provides a set of classes collectively known as the Core Data stack to manage and persist object instances, which<a id="_idIndexMarker1120"/> are as follows:</p>
			<ul>
				<li><strong class="source-inline">NSManagedObjectModel</strong><p>Describes your app's types, including their properties and relationships.</p></li>
				<li><strong class="source-inline">NSManagedObject</strong><p>A class used to implement instances of your app's types based on data from the <strong class="source-inline">NSManagedObjectModel</strong>.</p></li>
				<li><strong class="source-inline">NSManagedObjectContext</strong><p>Tracks changes to instances of your app's types.</p></li>
				<li><strong class="source-inline">NSPersistentStoreCoordinator</strong><p>Saves and fetches instances of your app's types from stores.</p></li>
				<li><strong class="source-inline">NSPersistentContainer</strong><p>Sets up the model, context, and store coordinator simultaneously.</p><p class="callout-heading">Important Note</p><p class="callout">You can learn<a id="_idIndexMarker1121"/> more about the Core Data stack at this link: <a href="https://developer.apple.com/documentation/coredata/core_data_stack">https://developer.apple.com/documentation/coredata/core_data_stack</a>.</p></li>
			</ul>
			<p>In the next section, you'll implement Core Data components required for your app to save reviews or photos.</p>
			<h1 id="_idParaDest-288"><a id="_idTextAnchor365"/>Implementing Core Data components for your app</h1>
			<p>Before you implement <a id="_idIndexMarker1122"/>Core Data components for your app, let's think about what you need to do to save reviews or photos.</p>
			<p>Imagine you're saving a review or photo using Microsoft Word. You first create a new Word document template with the relevant fields for a review or photo. You then create new Word documents based on the templates and fill in the data. You make whatever changes are necessary, perhaps changing the text of the review, or changing the effect you're applying to the photo. At this point, you have not saved the file yet. When you are happy with <a id="_idIndexMarker1123"/>your document, you save it to the hard disk of your computer. The next time you want to view your review or photo, you search your hard disk for the relevant document and double-click it to open it in Word so you can see it once more.</p>
			<p>Now that you have an idea of what you need to do, let's review the steps required to implement it. First, you <a id="_idIndexMarker1124"/>need to create a data model for a review or photo. You do this by creating <strong class="bold">entities</strong> in Xcode's data model editor, which are like Microsoft Word templates. Entities can have <strong class="bold">attributes</strong>, which <a id="_idIndexMarker1125"/>are like fields in the Microsoft Word templates.</p>
			<p>Xcode can then create an <strong class="source-inline">NSManagedObjectModel</strong> class from this data model. Core Data will then use this <strong class="source-inline">NSManagedObjectModel</strong> class to create <strong class="source-inline">NSManagedObject</strong> instances, similar to Microsoft Word templates being used to create Microsoft Word files.</p>
			<p>These <strong class="source-inline">NSManagedObject</strong> instances are placed in an <strong class="source-inline">NSManagedObjectContext</strong> instance, where your app has access to them, similar to opening Microsoft Word files in Microsoft Word. Then, when you bring up the <strong class="bold">Review Form</strong> screen or <strong class="bold">Photo Filter</strong> screen, the details of the review or the photo with the filter will be written to <strong class="source-inline">NSManagedObject</strong> instances, and you can modify them as much as you like, similar to Microsoft Word documents being edited in Microsoft Word.</p>
			<p>When you're done with the review or photo, the <strong class="source-inline">NSManagedObject</strong> instances in the <strong class="source-inline">NSManagedObjectContext</strong> instance<a id="_idIndexMarker1126"/> are saved to a file in your iOS device, called the <strong class="bold">persistent store</strong>. This is similar to saving Word documents to your hard disk when you're done with them.</p>
			<p>The <strong class="source-inline">NSPersistentStoreCoordinator</strong> instance manages the flow of information between the persistent store and the <strong class="source-inline">NSManagedObjectContext</strong> instance.</p>
			<p>You'll use the <strong class="source-inline">NSPersistentContainer</strong> class to create instances of <strong class="source-inline">NSManagedObjectModel</strong>, <strong class="source-inline">NSManagedObjectContext</strong>, and <strong class="source-inline">NSPersistentStoreCoordinator</strong> for your app.</p>
			<p class="callout-heading">Important Note</p>
			<p class="callout">You can learn more about how to set up the Core Data stack at this link: <a href="https://developer.apple.com/documentation/coredata/setting_up_a_core_data_stack">https://developer.apple.com/documentation/coredata/setting_up_a_core_data_stack</a>.</p>
			<p>You'll create<a id="_idIndexMarker1127"/> entities and attributes to<a id="_idIndexMarker1128"/> represent a review or photo using Xcode's data model editor in the next section.</p>
			<h2 id="_idParaDest-289"><a id="_idTextAnchor366"/>Creating a data model</h2>
			<p>Currently, when <a id="_idIndexMarker1129"/>you tap <strong class="bold">Save</strong> in the <strong class="bold">Review Form</strong> screen, the data you entered in the fields is just printed to the Debug area, and tapping <strong class="bold">Save</strong> in the <strong class="bold">Photo Filter</strong> screen doesn't do anything. The first step is to create class definitions for objects to store data from the <strong class="bold">Review Form</strong> screen and the photo from the <strong class="bold">Photo Filter</strong> screen. You'll create entities for reviews and photos using Xcode's data model editor, and Xcode will automatically generate the class definitions. Let's create the entity for reviews first. Follow these steps:</p>
			<ol>
				<li>Right-click the <strong class="source-inline">Misc</strong> folder in the Project navigator and choose <strong class="bold">New Group</strong>. Name this group <strong class="source-inline">Core Data</strong>.</li>
				<li>Right-click the <strong class="source-inline">Core Data</strong> group and choose <strong class="bold">New File</strong>.</li>
				<li><strong class="bold">iOS</strong> should already be selected. Type <strong class="source-inline">data</strong> in the filter field, and select <strong class="bold">Data Model</strong>. Click <strong class="bold">Next</strong>:<div id="_idContainer480" class="IMG---Figure"><img src="image/Figure_21.01_B17469.jpg" alt="Figure 21.1: Data Model template selected&#13;&#10;"/></div><p class="figure-caption">Figure 21.1: Data Model template selected</p></li>
				<li>Name<a id="_idIndexMarker1130"/> the file <strong class="source-inline">LetsEatModel</strong> and click <strong class="bold">Create</strong>. The data model editor appears in the Editor area:<div id="_idContainer481" class="IMG---Figure"><img src="image/Figure_21.02_B17469.jpg" alt="Figure 21.2: Editor area showing data model editor&#13;&#10;"/></div><p class="figure-caption">Figure 21.2: Editor area showing data model editor</p></li>
				<li>Click<a id="_idIndexMarker1131"/> the <strong class="bold">Add Entity</strong> button:<div id="_idContainer482" class="IMG---Figure"><img src="image/Figure_21.03_B17469.jpg" alt="Figure 21.3: Add Entity button&#13;&#10;"/></div><p class="figure-caption">Figure 21.3: Add Entity button</p></li>
				<li>An <strong class="bold">Entity</strong> appears under the <strong class="bold">ENTITIES</strong> section. The <strong class="bold">Attributes</strong> for this entity appear to the right of the entity:<div id="_idContainer483" class="IMG---Figure"><img src="image/Figure_21.04_B17469.jpg" alt="Figure 21.4: Data model editor with Entity selected&#13;&#10;"/></div><p class="figure-caption">Figure 21.4: Data model editor with Entity selected</p></li>
				<li>Double-click <strong class="bold">Entity</strong> and <a id="_idIndexMarker1132"/>rename it <strong class="source-inline">Review</strong>:<div id="_idContainer484" class="IMG---Figure"><img src="image/Figure_21.05_B17469.jpg" alt="Figure 21.5: Data model editor with Entity renamed to Review&#13;&#10;"/></div><p class="figure-caption">Figure 21.5: Data model editor with Entity renamed to Review</p></li>
				<li>Click the <strong class="bold">+</strong> button in the <strong class="bold">Attributes</strong> section to create an attribute. Set the <strong class="bold">Attribute</strong> to <strong class="source-inline">name</strong> and the <strong class="bold">Type</strong> to <strong class="source-inline">String</strong>:<div id="_idContainer485" class="IMG---Figure"><img src="image/Figure_21.06_B17469.jpg" alt="Figure 21.6: Data model editor showing the name attribute for the Review entity&#13;&#10;"/></div><p class="figure-caption">Figure 21.6: Data model editor showing the name attribute for the Review entity</p></li>
				<li>You'll need to create an attribute for each field in the <strong class="bold">Review Form</strong> screen, and you'll store the <strong class="source-inline">restaurantID</strong> as well to associate the review with the restaurant. Add the following attributes and types:<div id="_idContainer486" class="IMG---Figure"><img src="image/Figure_21.07_B17469.jpg" alt="Figure 21.7: Attributes to be added to the Review entity&#13;&#10;"/></div><p class="figure-caption">Figure 21.7: Attributes to be added to the Review entity</p><p><strong class="source-inline">date</strong> will be automatically set when the <strong class="source-inline">Review</strong> instance is created.</p></li>
				<li>Check <a id="_idIndexMarker1133"/>to see that your <strong class="source-inline">Review</strong> entity's attributes look like this when done:<div id="_idContainer487" class="IMG---Figure"><img src="image/Figure_21.08_B17469.jpg" alt="Figure 21.8: The attributes for Review entity&#13;&#10;"/></div><p class="figure-caption">Figure 21.8: The attributes for Review entity</p></li>
				<li>Add one more attribute, <strong class="source-inline">uuid</strong>, of type <strong class="source-inline">UUID</strong>. This is used as a key value for each <strong class="source-inline">Review</strong> instance. Click the Data Model inspector, and under <strong class="bold">Attribute</strong>, untick <strong class="bold">Optional</strong>, as every <strong class="source-inline">Review</strong> instance must have a key value.<div id="_idContainer488" class="IMG---Figure"><img src="image/Figure_21.09_B17469.jpg" alt="Figure 21.9: Data model inspector showing Optional unticked for the uuid attribute&#13;&#10;"/></div><p class="figure-caption">Figure 21.9: Data model inspector showing Optional unticked for the uuid attribute</p></li>
				<li>Add a <a id="_idIndexMarker1134"/>second entity, called <strong class="source-inline">RestaurantPhoto</strong>, with the following attributes. Core Data can't store <strong class="source-inline">UIImage</strong> objects, so the <strong class="source-inline">photo</strong> attribute's type is set to <strong class="bold">Binary Data</strong>. You will convert photos to binary data so that Core Data can store them, and convert them back to <strong class="source-inline">UIImage</strong> objects when you need them to be displayed in your app. <strong class="source-inline">date</strong> will be automatically set when the <strong class="source-inline">RestaurantPhoto</strong> instance is created. You'll use <strong class="source-inline">restaurantID</strong> to associate the photo with the restaurant, and <strong class="source-inline">uuid</strong> as the key value:<div id="_idContainer489" class="IMG---Figure"><img src="image/Figure_21.10_B17469.jpg" alt="Figure 21.10: Attributes for the RestaurantPhoto entity&#13;&#10;"/></div><p class="figure-caption">Figure 21.10: Attributes for the RestaurantPhoto entity</p></li>
				<li>For <strong class="source-inline">uuid</strong>, don't forget to uncheck <strong class="bold">Optional</strong> in the Data Model inspector:</li>
			</ol>
			<div>
				<div id="_idContainer490" class="IMG---Figure">
					<img src="image/Figure_21.11_B17469.jpg" alt="Figure 21.11: Data model inspector showing Optional unticked for the uuid attribute&#13;&#10;"/>
				</div>
			</div>
			<p class="figure-caption">Figure 21.11: Data model inspector showing Optional unticked for the uuid attribute</p>
			<p>You have finished<a id="_idIndexMarker1135"/> creating the entities that you need for your app. Build your app. Class files for the <strong class="source-inline">Review</strong> and <strong class="source-inline">RestaurantPhoto</strong> entities will be automatically created by Xcode, but they will not be visible in the Project navigator. To make it easier to work with them, you will create a model object for each entity, starting with <strong class="source-inline">ReviewItem</strong> in the next section.</p>
			<h2 id="_idParaDest-290"><a id="_idTextAnchor367"/>Creating ReviewItem</h2>
			<p>You have <a id="_idIndexMarker1136"/>created two entities to store reviews and photo data using Xcode's data model editor. Xcode will then automatically generate two <strong class="source-inline">NSManagedObject</strong> class definitions from the data model, <strong class="source-inline">Review</strong> and <strong class="source-inline">RestaurantPhoto</strong>, but you can't see them in the Project navigator.</p>
			<p>You will create two model objects, <strong class="source-inline">ReviewItem</strong> and <strong class="source-inline">RestaurantPhotoItem</strong>, that will work hand-in-hand with <strong class="source-inline">Review</strong> and <strong class="source-inline">RestaurantPhoto</strong> instances. Let's create <strong class="source-inline">ReviewItem</strong> now. Follow <a id="_idIndexMarker1137"/>these steps:</p>
			<ol>
				<li value="1">Right-click the <strong class="source-inline">ReviewForm</strong> folder in the Project navigator and choose <strong class="bold">New Group</strong>. Name this group <strong class="source-inline">Model</strong>.</li>
				<li>Right-click the <strong class="source-inline">Model</strong> folder inside the <strong class="source-inline">ReviewForm</strong> folder and select <strong class="bold">New File</strong>.</li>
				<li><strong class="bold">iOS</strong> should already be selected. Choose <strong class="bold">Swift File</strong> and then click <strong class="bold">Next</strong>.</li>
				<li>Name this file <strong class="source-inline">ReviewItem</strong>. Click <strong class="bold">Create</strong>. The <strong class="source-inline">ReviewItem</strong> file appears in the Project navigator.</li>
				<li>Modify the file as<a id="_idTextAnchor368"/><a id="_idTextAnchor369"/> shown:<p class="source-code">import <strong class="bold">UIKit</strong></p><p class="source-code"><strong class="bold">struct ReviewItem {</strong></p><p class="source-code"><strong class="bold">   var date: Date?</strong></p><p class="source-code"><strong class="bold">   var rating: Double? </strong></p><p class="source-code"><strong class="bold">   var title: String? </strong></p><p class="source-code"><strong class="bold">   var name: String?</strong></p><p class="source-code"><strong class="bold">   var customerReview: String?</strong></p><p class="source-code"><strong class="bold">   var restaurantID: Int64?</strong></p><p class="source-code"><strong class="bold">   var uuid = UUID()</strong></p><p class="source-code"><strong class="bold">}</strong></p><p class="source-code"><strong class="bold">extension ReviewItem {</strong></p><p class="source-code"><strong class="bold">   init(review: Review) {</strong></p><p class="source-code"><strong class="bold">      self.date = review.date</strong></p><p class="source-code"><strong class="bold">      self.rating = review.rating</strong></p><p class="source-code"><strong class="bold">      self.title = review.title</strong></p><p class="source-code"><strong class="bold">      self.name = review.name</strong></p><p class="source-code"><strong class="bold">      self.customerReview = review.customerReview </strong></p><p class="source-code"><strong class="bold">      self.restaurantID = review.restaurantID</strong></p><p class="source-code"><strong class="bold">      if let reviewUUID = review.uuid { </strong></p><p class="source-code"><strong class="bold">         self.uuid = reviewUUID</strong></p><p class="source-code"><strong class="bold">      }</strong></p><p class="source-code"><strong class="bold">   }</strong></p><p class="source-code">}</p></li>
			</ol>
			<p>As you <a id="_idIndexMarker1138"/>can see, the <strong class="source-inline">ReviewItem</strong> structure's properties are the same as the <strong class="source-inline">Review</strong> entity's attributes. The initializer creates a <strong class="source-inline">ReviewItem</strong> instance and maps the attributes from <strong class="source-inline">Review</strong> to the properties of the <strong class="source-inline">ReviewItem</strong> instance.</p>
			<p>In the next section, you'll create a second model object, <strong class="source-inline">RestaurantPhotoItem</strong>, which will be the model object for the <strong class="source-inline">RestaurantPhoto</strong> entity.</p>
			<h2 id="_idParaDest-291"><a id="_idTextAnchor370"/>Creating RestaurantPhotoItem</h2>
			<p>The process for<a id="_idIndexMarker1139"/> creating <strong class="source-inline">RestaurantPhotoItem</strong> is similar to creating <strong class="source-inline">ReviewItem</strong>. Follow these steps:</p>
			<ol>
				<li value="1">Right-click the <strong class="source-inline">Model</strong> folder inside the <strong class="source-inline">PhotoFilter</strong> folder and choose <strong class="bold">New File</strong>.</li>
				<li><strong class="bold">iOS</strong> should already be selected. Choose <strong class="bold">Swift File</strong> and then click <strong class="bold">Next</strong>.</li>
				<li>Name this file <strong class="source-inline">RestaurantPhotoItem</strong>. Click <strong class="bold">Create</strong>.</li>
				<li>Modify the file <a id="_idTextAnchor371"/><a id="_idTextAnchor372"/>as shown:<p class="source-code">import <strong class="bold">UIKit</strong></p><p class="source-code"><strong class="bold">struct RestaurantPhotoItem {</strong></p><p class="source-code"><strong class="bold">   var date: Date?</strong></p><p class="source-code"><strong class="bold">   var photo: UIImage?</strong></p><p class="source-code"><strong class="bold">   var photoData: Data {</strong></p><p class="source-code"><strong class="bold">      guard let photo = photo, let photoData =</strong></p><p class="source-code"><strong class="bold">      photo.pngData() else {</strong></p><p class="source-code"><strong class="bold">         return Data()</strong></p><p class="source-code"><strong class="bold">      }</strong></p><p class="source-code"><strong class="bold">      return photoData</strong></p><p class="source-code"><strong class="bold">   }</strong></p><p class="source-code"><strong class="bold">   var restaurantID: Int64?</strong></p><p class="source-code"><strong class="bold">   var uuid = UUID()</strong></p><p class="source-code"><strong class="bold">}</strong></p><p class="source-code"><strong class="bold">extension RestaurantPhotoItem {</strong></p><p class="source-code"><strong class="bold">   init(restaurantPhoto: RestaurantPhoto) {</strong></p><p class="source-code"><strong class="bold">      self.date = restaurantPhoto.date</strong></p><p class="source-code"><strong class="bold">      if let restPhoto = restaurantPhoto.photo {</strong></p><p class="source-code"><strong class="bold">         self.photo = UIImage(data: restPhoto, </strong></p><p class="source-code"><strong class="bold">         scale: 1.0)</strong></p><p class="source-code"><strong class="bold">      }</strong></p><p class="source-code"><strong class="bold">      self.restaurantID = </strong></p><p class="source-code"><strong class="bold">      restaurantPhoto.restaurantID</strong></p><p class="source-code"><strong class="bold">      if let restPhotoUUID = restaurantPhoto.uuid { </strong></p><p class="source-code"><strong class="bold">         self.uuid = restPhotoUUID </strong></p><p class="source-code"><strong class="bold">      }</strong></p><p class="source-code"><strong class="bold">   }</strong></p><p class="source-code"><strong class="bold">}</strong></p><p>Similar to the <strong class="source-inline">ReviewItem</strong> structure, the properties of the <strong class="source-inline">RestaurantPhotoItem</strong> structure are the same as the <strong class="source-inline">RestaurantPhoto</strong> entity's attributes. There is one additional computed property, <strong class="source-inline">photoData</strong>, which is used to store the representation of <strong class="source-inline">photo</strong> in binary data format, as Core Data can't store <strong class="source-inline">UIImage</strong> instances.</p><p>The<a id="_idIndexMarker1140"/> initializer creates a <strong class="source-inline">RestaurantPhotoItem</strong> instance and maps the attributes from the <strong class="source-inline">RestaurantPhoto</strong> entity to properties in <strong class="source-inline">RestaurantPhotoItem</strong> instance. Note the conversion from binary data to <strong class="source-inline">UIImage</strong> when setting the value for <strong class="source-inline">photo</strong>.</p></li>
			</ol>
			<p>Now that you have declared and defined <strong class="source-inline">ReviewItem</strong> and <strong class="source-inline">RestaurantPhotoItem</strong>, let's create a Core Data manager, which will set up the Core Data components for your app, in the next section.</p>
			<h2 id="_idParaDest-292"><a id="_idTextAnchor373"/>Creating a Core Data manager</h2>
			<p>At this point, Xcode<a id="_idIndexMarker1141"/> has automatically generated the <strong class="source-inline">Review</strong> and <strong class="source-inline">RestaurantData</strong> class definitions from the data model, and you have declared and defined the corresponding model objects, <strong class="source-inline">ReviewItem</strong> and <strong class="source-inline">RestaurantPhotoItem</strong>. Now you'll create a <strong class="source-inline">CoreDataManager</strong> class that will set up the Core Data components for your app. Follow these steps:</p>
			<ol>
				<li value="1">Right-click the <strong class="source-inline">Core Data</strong> folder inside the <strong class="source-inline">Misc</strong> folder and choose <strong class="bold">New File</strong>.</li>
				<li><strong class="bold">iOS</strong> should already be selected. Choose <strong class="bold">Swift File</strong> and then click <strong class="bold">Next</strong>.</li>
				<li>Name this file <strong class="source-inline">CoreDataManager</strong>. Click <strong class="bold">Create</strong>. The <strong class="source-inline">CoreDataManager</strong> file appears in the Project navigator.</li>
				<li>Add the following code after the <strong class="source-inline">import</strong> statement:<p class="source-code">import CoreData</p><p>This gives you access to the Core Data library.</p></li>
				<li>Add the following code to declare and define the <strong class="source-inline">CoreDataManager<a id="_idTextAnchor374"/><a id="_idTextAnchor375"/><a id="_idTextAnchor376"/></strong> structure:<p class="source-code">struct CoreDataManager { </p><p class="source-code">   let container: NSPersistentContainer</p><p class="source-code">   init() {</p><p class="source-code">      container = NSPersistentContainer(name: </p><p class="source-code">      "LetsEatModel")</p><p class="source-code">      container.loadPersistentStores { </p><p class="source-code">         (storeDesc, error) in </p><p class="source-code">         error.map {</p><p class="source-code">            print($0)</p><p class="source-code">         }</p><p class="source-code">      }</p><p class="source-code">   }</p><p class="source-code">}</p><p>This creates and initializes instances of <strong class="source-inline">NSManagedObjectModel</strong>, <strong class="source-inline">NSPersistentStoreCoordinator</strong>, and <strong class="source-inline">NSManagedObjectContext</strong>.</p></li>
				<li>To create<a id="_idIndexMarker1142"/> an instance of the <strong class="source-inline">CoreDataManager</strong> structure that will be available throughout your app, click the <strong class="source-inline">AppDelegate</strong> file in the Project navigator and add the following code after the closing <a id="_idTextAnchor377"/><a id="_idTextAnchor378"/>curly brace:<p class="source-code">extension CoreDataManager {</p><p class="source-code">   static var shared = CoreDataManager()</p><p class="source-code">}</p></li>
			</ol>
			<p>Next, you'll add methods to create <strong class="source-inline">Review</strong> and <strong class="source-inline">RestaurantPhoto</strong> instances, populate them using <strong class="source-inline">ReviewItem</strong> and <strong class="source-inline">RestaurantPhotoItem</strong> instances, and save them to the persistent store. Follow these steps:</p>
			<ol>
				<li value="1">Click<a id="_idIndexMarker1143"/> the <strong class="source-inline">CoreDataManager</strong> file in the Project navigator. Add the following code after the initializer to implement the <strong class="source-inline">addRevie<a id="_idTextAnchor379"/><a id="_idTextAnchor380"/>w(_:)</strong> method:<p class="source-code">func addReview(_ reviewItem: ReviewItem) {</p><p class="source-code">   let review = Review(context: </p><p class="source-code">   container.viewContext)</p><p class="source-code">   review.date = Date()</p><p class="source-code">   if let reviewItemRating = reviewItem.rating { </p><p class="source-code">      review.rating = reviewItemRating</p><p class="source-code">   }</p><p class="source-code">   review.title = reviewItem.title </p><p class="source-code">   review.name = reviewItem.name</p><p class="source-code">   review.customerReview = </p><p class="source-code">   reviewItem.customerReview</p><p class="source-code">   if let reviewItemRestID = </p><p class="source-code">   reviewItem.restaurantID { </p><p class="source-code">      review.restaurantID = reviewItemRestID  </p><p class="source-code">   }</p><p class="source-code">   review.uuid = reviewItem.uuid</p><p class="source-code">   save()</p><p class="source-code">}</p><p>This method takes a <strong class="source-inline">ReviewItem</strong> instance as a parameter and gets an empty <strong class="source-inline">Review</strong> instance from the <strong class="source-inline">NSManagedObjectContext</strong> instance. The properties of the <strong class="source-inline">ReviewItem</strong> instance are assigned to the attributes of the <strong class="source-inline">Review</strong> instance, and the <strong class="source-inline">save()</strong> method is called to save the contents of the <strong class="source-inline">NSManagedObjectContext</strong> instance to the persistent store. Note that you will see an <a id="_idIndexMarker1144"/>error as you have not yet implemented the <strong class="source-inline">save()</strong> method. Ignore this error for now.</p></li>
				<li>Add the following code after the <strong class="source-inline">addReview(_:)</strong> method to implement the <strong class="source-inline">addPho<a id="_idTextAnchor381"/><a id="_idTextAnchor382"/>to(_:)</strong> method:<p class="source-code">func addPhoto(_ restPhotoItem: </p><p class="source-code">RestaurantPhotoItem) {</p><p class="source-code">   let restPhoto = RestaurantPhoto(context: </p><p class="source-code">   container.viewContext)</p><p class="source-code">   restPhoto.date = Date()</p><p class="source-code">   restPhoto.photo = restPhotoItem.photoData</p><p class="source-code">   if let restPhotoID = </p><p class="source-code">      restPhotoItem.restaurantID { </p><p class="source-code">      restPhoto.restaurantID = restPhotoID </p><p class="source-code">   }</p><p class="source-code">   restPhoto.uuid = restPhotoItem.uuid</p><p class="source-code">   save()</p><p class="source-code">}</p><p>This method is similar to <strong class="source-inline">addReview(_:)</strong>. It takes a <strong class="source-inline">RestaurantPhotoItem</strong> instance as a parameter and gets an empty <strong class="source-inline">RestaurantPhoto</strong> instance from the <strong class="source-inline">NSManagedObjectContext</strong> instance. The properties of the <strong class="source-inline">RestaurantPhotoItem</strong> instance are assigned to the properties of the <strong class="source-inline">RestaurantPhoto</strong> instance, and the <strong class="source-inline">save()</strong> method is called to save the contents of the <strong class="source-inline">NSManagedObjectContext</strong> instance to the persistent store. Note that you will see an error as you have not yet implemented the <strong class="source-inline">save()</strong> method. Again, ignore this error for now.</p></li>
				<li>Implement the <strong class="source-inline">save()</strong> method by adding the following code before the fina<a id="_idTextAnchor383"/><a id="_idTextAnchor384"/>l curly brace:<p class="source-code">private func save() {</p><p class="source-code">   do {</p><p class="source-code">      if container.viewContext.hasChanges {</p><p class="source-code">         try container.viewContext.save()</p><p class="source-code">      }</p><p class="source-code">   } catch let error {</p><p class="source-code">      print(error.localizedDescription)</p><p class="source-code">   }</p><p class="source-code">}</p><p>This <strong class="source-inline">do-catch</strong> block saves the contents of the <strong class="source-inline">NSManagedObjectContext</strong> instance to the persistent store. If the save was not successful, an error message is printed in the Debug area.</p></li>
			</ol>
			<p>When you want to<a id="_idIndexMarker1145"/> retrieve reviews and photos from the persistent store, you will use <strong class="source-inline">restaurantID</strong> as an identifier to get reviews and photos for a particular restaurant. Let's implement the methods required for this now. Add the following code after the <strong class="source-inline">addPhoto(_:)</strong> method to implement the <strong class="source-inline">fetchReviews(by:)</strong> and <strong class="source-inline">fetchPhoto<a id="_idTextAnchor385"/><a id="_idTextAnchor386"/>s(by:)</strong> methods:</p>
			<p class="source-code">func fetchReviews(by identifier: Int) -&gt; </p>
			<p class="source-code">[ReviewItem] {</p>
			<p class="source-code">   let moc = container.viewContext</p>
			<p class="source-code">   let request = Review.fetchRequest()</p>
			<p class="source-code">   let predicate = NSPredicate(format: </p>
			<p class="source-code">   "restaurantID = %i", identifier)</p>
			<p class="source-code">   var reviewItems: [ReviewItem] = []</p>
			<p class="source-code">   request.sortDescriptors = </p>
			<p class="source-code">   [NSSortDescriptor(key: "date", </p>
			<p class="source-code">   ascending: false)]</p>
			<p class="source-code">   request.predicate = predicate </p>
			<p class="source-code">   do {</p>
			<p class="source-code">      for review in try moc.fetch(request) {</p>
			<p class="source-code">         reviewItems.append(ReviewItem(review: </p>
			<p class="source-code">         review))</p>
			<p class="source-code">      }</p>
			<p class="source-code">      return reviewItems</p>
			<p class="source-code">   } catch {</p>
			<p class="source-code">      fatalError("Failed to fetch reviews: </p>
			<p class="source-code">      \(error)")</p>
			<p class="source-code">   }</p>
			<p class="source-code">}</p>
			<p class="source-code"> </p>
			<p class="source-code">func fetchRestPhotos(by identifier: Int) -&gt; </p>
			<p class="source-code">[RestaurantPhotoItem] {</p>
			<p class="source-code">   let moc = container.viewContext</p>
			<p class="source-code">   let request = RestaurantPhoto.fetchRequest()</p>
			<p class="source-code">   let predicate = NSPredicate(format: </p>
			<p class="source-code">   "restaurantID = %i", identifier) </p>
			<p class="source-code">   var restPhotoItems: [RestaurantPhotoItem] = [] </p>
			<p class="source-code">   request.sortDescriptors = </p>
			<p class="source-code">   [NSSortDescriptor(key: "date", </p>
			<p class="source-code">   ascending: false)]</p>
			<p class="source-code">   request.predicate = predicate </p>
			<p class="source-code">   do {</p>
			<p class="source-code">      for restPhoto in try moc.fetch(request) {</p>
			<p class="source-code">         restPhotoItems.append(RestaurantPhotoItem</p>
			<p class="source-code">         (restaurantPhoto: restPhoto))</p>
			<p class="source-code">      }</p>
			<p class="source-code">      return restPhotoItems</p>
			<p class="source-code">   } catch {</p>
			<p class="source-code">      fatalError("Failed to fetch restaurant </p>
			<p class="source-code">      photos: \(error)")</p>
			<p class="source-code">   }</p>
			<p class="source-code">}</p>
			<p>Let's break<a id="_idIndexMarker1146"/> this down, starting with <strong class="source-inline">fetchReviews(by:)</strong>:</p>
			<p class="source-code">let moc = container.viewContext</p>
			<p>This gets a reference to the <strong class="source-inline">NSManagedObjectContext</strong> instance.</p>
			<p class="source-code">let request = Review.fetchRequest() </p>
			<p>This <a id="_idIndexMarker1147"/>creates a <strong class="bold">fetch request</strong> that gets <strong class="source-inline">Review</strong> instances from the persistent store.</p>
			<p class="source-code">let predicate = NSPredicate(format: "restaurantID = %i", identifier)</p>
			<p>This creates a <strong class="bold">fetch predicate</strong> that <a id="_idIndexMarker1148"/>only gets those <strong class="source-inline">Review</strong> instances with the specified <strong class="source-inline">restaurantID</strong>.</p>
			<p class="source-code">var reviewItems: [ReviewItem] = []</p>
			<p>This creates an array, <strong class="source-inline">reviewItems</strong>, that you will use to store the results of the fetch request.</p>
			<p class="source-code">request.sortDescriptors = [NSSortDescriptor(key: "date", ascending: false)]</p>
			<p>This sorts the results of the fetch request by date, with the most recent items first.</p>
			<p class="source-code">request.predicate = predicate</p>
			<p>This sets the<a id="_idIndexMarker1149"/> predicate for the fetch request.</p>
			<p class="source-code">do {</p>
			<p class="source-code">   for review in try moc.fetch(request) {</p>
			<p class="source-code">      reviewItems.append(ReviewItem(review: </p>
			<p class="source-code">      review))</p>
			<p class="source-code">   }</p>
			<p class="source-code">   return reviewItems</p>
			<p class="source-code">} catch {</p>
			<p class="source-code">   fatalError("Failed to fetch reviews: \(error)")</p>
			<p class="source-code">}</p>
			<p>This <strong class="source-inline">do-catch</strong> block performs the fetch request and places the results in the <strong class="source-inline">items</strong> array. If unsuccessful, your app will crash and an error message will be printed in the Debug area.</p>
			<p><strong class="source-inline">fetchPhotos(by:)</strong> works the same way as <strong class="source-inline">fetchReview(by:)</strong>, but returns an array of <strong class="source-inline">RestaurantPhotoItems</strong> instances instead.</p>
			<p>You've created a <strong class="source-inline">CoreDataManager</strong> class that adds data to and retrieves data from the persistent store. Build and run your app to test for errors. It should work the same way as it did before.</p>
			<p>You've implemented all the components of Core Data in your app. Next, you'll configure <strong class="source-inline">RestaurantDetailViewController</strong> to use Core Data to display reviews and photos in the <strong class="bold">Restaurant Detail</strong> screen. You'll start by learning how the <strong class="bold">Restaurant Detail</strong> screen will display reviews and photos for a particular restaurant.</p>
			<p class="callout-heading">Tip</p>
			<p class="callout">Since this is a long chapter, you may wish to take a break here.</p>
			<h1 id="_idParaDest-293"><a id="_idTextAnchor387"/>Understanding how saving and loading works</h1>
			<p>Let's review what you have done so far. You have created <strong class="source-inline">Review</strong> and <strong class="source-inline">RestaurantPhoto</strong> entities<a id="_idIndexMarker1150"/> using the data model editor, and you have created the corresponding model objects for them, named <strong class="source-inline">ReviewItem</strong> and <strong class="source-inline">RestaurantPhotoItem</strong>. You created the <strong class="source-inline">CoreDataManager</strong> class to add and get <strong class="source-inline">Review</strong> and <strong class="source-inline">RestaurantPhoto</strong> instances from the persistent store. The <strong class="source-inline">CoreDataManager</strong> class uses the restaurant identifier to associate reviews and restaurant photos with a specific restaurant, but where does it come from?</p>
			<p>Open the <strong class="source-inline">Misc</strong> folder in your project, and open the <strong class="source-inline">JSON</strong> folder. If you click on any one of the JSON files inside, you'll see that each restaurant has a unique numeric identifier. For example, the identifier for The Tap Trailhouse restaurant is <strong class="source-inline">145237</strong>, as shown in the screenshot below:</p>
			<div>
				<div id="_idContainer491" class="IMG---Figure">
					<img src="image/Figure_21.12_B17469.jpg" alt="Figure 21.12: Editor area showing contents for Boston.json&#13;&#10;"/>
				</div>
			</div>
			<p class="figure-caption">Figure 21.12: Editor area showing contents for Boston.json</p>
			<p>When you save restaurant photos and reviews to the persistent store, you will save them together with this identifier. Then, when a particular restaurant is displayed in the <strong class="bold">Restaurant Detail</strong> screen, <strong class="source-inline">RestaurantDetailViewController</strong> will use a <strong class="source-inline">ReviewDataManager</strong> instance to retrieve reviews and restaurant photos of that restaurant and display them in collection views, as shown in the screenshot:</p>
			<div>
				<div id="_idContainer492" class="IMG---Figure">
					<img src="image/Figure_21.13_B17469.jpg" alt="Figure 21.13: iOS Simulator showing Restaurant Detail screen with reviews and restaurant photos&#13;&#10;"/>
				</div>
			</div>
			<p class="figure-caption">Figure 21.13: iOS Simulator showing Restaurant Detail screen with reviews and restaurant photos</p>
			<p>If there are no<a id="_idIndexMarker1151"/> reviews or photos, you'll use the <strong class="source-inline">NoDataView</strong> to inform the user there are no reviews or photos, as shown in the screenshot:</p>
			<div>
				<div id="_idContainer493" class="IMG---Figure">
					<img src="image/Figure_21.14_B17469.jpg" alt="Figure 21.14: iOS Simulator showing Restaurant Detail screen without reviews or restaurant photos&#13;&#10;"/>
				</div>
			</div>
			<p class="figure-caption">Figure 21.14: iOS Simulator showing Restaurant Detail screen without reviews or restaurant photos</p>
			<p><strong class="source-inline">RestaurantItem</strong> has a <a id="_idIndexMarker1152"/>property, <strong class="source-inline">restaurantID</strong>, to store restaurant identifiers. When <strong class="source-inline">RestaurantDataManager</strong> loads a JSON file and creates an array of <strong class="source-inline">RestaurantItem</strong> instances, the identifier for each restaurant is obtained from the JSON file and stored in the <strong class="source-inline">restaurantID</strong> property.</p>
			<p>In the next section, you'll update <strong class="source-inline">ReviewFormViewController</strong> to save a review with a restaurant identifier to the persistent store.</p>
			<h1 id="_idParaDest-294"><a id="_idTextAnchor388"/>Updating the ReviewFormViewController class to save reviews</h1>
			<p>The <strong class="bold">Save</strong> button<a id="_idIndexMarker1153"/> in the <strong class="bold">Review Form</strong> screen currently just prints the review to the Debug area when tapped. To save reviews, you'll need to modify the <strong class="source-inline">onSaveTapped(_:)</strong> method to save a review to the persistent store when the <strong class="bold">Save </strong>button is tapped. Follow these steps:</p>
			<ol>
				<li value="1">Click the <strong class="source-inline">ReviewFormViewController</strong> file in the Project navigator. Add the following property to the <strong class="source-inline">ReviewFormViewController</strong> class before the outlet declarations to store the re<a id="_idTextAnchor389"/><a id="_idTextAnchor390"/>staurant identifier:<p class="source-code">var selectedRestaurantID: Int?</p></li>
				<li>Create a <strong class="source-inline">private</strong> extension, move the <strong class="source-inline">onSaveTapped(_:)</strong> method into it, and m<a id="_idTextAnchor391"/><a id="_idTextAnchor392"/>odify it as follows:<p class="source-code">private extension ReviewFormViewController {</p><p class="source-code">   @IBAction func onSaveTapped(_ sender: Any) {</p><p class="source-code"><strong class="bold">      var reviewItem = ReviewItem() </strong></p><p class="source-code"><strong class="bold">      reviewItem.rating = ratingsView.rating</strong></p><p class="source-code"><strong class="bold">      reviewItem.title = titleTextField.text</strong></p><p class="source-code"><strong class="bold">      reviewItem.name = nameTextField.text</strong></p><p class="source-code"><strong class="bold">      reviewItem.customerReview = </strong></p><p class="source-code"><strong class="bold">      reviewTextView.text</strong></p><p class="source-code"><strong class="bold">      if let selRestID = selectedRestaurantID {</strong></p><p class="source-code"><strong class="bold">         reviewItem.restaurantID =</strong></p><p class="source-code"><strong class="bold">         Int64(selRestID)</strong></p><p class="source-code"><strong class="bold">      }</strong></p><p class="source-code"><strong class="bold">      CoreDataManager.shared.addReview(reviewItem)</strong></p><p class="source-code">      dismiss(animated: true, completion: nil)</p><p class="source-code">   }</p><p class="source-code">}</p><p>Instead of printing the review details to the Debug area, <strong class="source-inline">onSaveTapped(_:)</strong> will now create a <strong class="source-inline">ReviewItem</strong> instance, assign data obtained from the <strong class="bold">Review Form</strong> screen to its properties, and call <strong class="source-inline">CoreDataManager.shared.addReview(reviewItem)</strong> to save the review to the persistent store.</p></li>
			</ol>
			<p>Note that <a id="_idIndexMarker1154"/>there is no mechanism to pass a restaurant identifier to <strong class="source-inline">ReviewFormViewController</strong> at present. In the next section, you'll see how to get the restaurant identifier from <strong class="source-inline">RestaurantDetailViewController</strong> and pass it to <strong class="source-inline">ReviewFormViewController</strong>.</p>
			<h2 id="_idParaDest-295"><a id="_idTextAnchor393"/>Passing RestaurantID to the ReviewFormViewController instance</h2>
			<p>The <strong class="bold">Save</strong> button in the <strong class="bold">Review Form</strong> screen can now save a review with a restaurant identifier, but <a id="_idIndexMarker1155"/>where does <strong class="source-inline">ReviewFormViewController</strong> get that identifier from? You must pass the identifier value from <strong class="source-inline">RestaurantDetailViewController</strong> to <strong class="source-inline">ReviewFormViewController</strong> so that it can save reviews with the restaurant identifier for that restaurant. As you did before in <a href="B17469_17_Final_VK_ePub.xhtml#_idTextAnchor248"><em class="italic">Chapter 17</em></a><em class="italic">, Getting Started with JSONFiles</em>, you'll use segue identifiers to determine which segue is occurring, and then implement methods to pass the identifier value between the two view controllers. Follow these steps:</p>
			<ol>
				<li value="1">Open the <strong class="source-inline">RestaurantDetail</strong> storyboard file and select the segue used to go to the <strong class="bold">ReviewForm</strong> scene:<div id="_idContainer494" class="IMG---Figure"><img src="image/Figure_21.15_B17469.jpg" alt="Figure 21.15: Editor area showing segue between Restaurant Detail and Review Form screens selected&#13;&#10;"/></div><p class="figure-caption">Figure 21.15: Editor area showing segue between Restaurant Detail and Review Form screens selected</p></li>
				<li>In<a id="_idIndexMarker1156"/> the Attributes inspector, set <strong class="bold">Identifier</strong> under <strong class="bold">Storyboard Segue</strong> to <strong class="source-inline">showReview</strong> and press <em class="italic">Return</em>:<div id="_idContainer495" class="IMG---Figure"><img src="image/Figure_21.16_B17469.jpg" alt="Figure 21.16: Attributes inspector with Identifier set to showReview&#13;&#10;"/></div><p class="figure-caption">Figure 21.16: Attributes inspector with Identifier set to showReview</p></li>
				<li>Click<a id="_idIndexMarker1157"/> the <strong class="source-inline">RestaurantDetailViewController</strong> file in the Project navigator. Add the following code after <strong class="source-inline">viewDidLoad()</strong> to implement the<strong class="source-inline"> prepar<a id="_idTextAnchor394"/><a id="_idTextAnchor395"/>e(for:sender:)</strong> method:<p class="source-code">override func prepare(for segue: </p><p class="source-code">UIStoryboardSegue, sender: Any?) {</p><p class="source-code">   if let identifier = segue.identifier {</p><p class="source-code">      switch identifier  {</p><p class="source-code">      case Segue.showReview.rawValue:</p><p class="source-code">         showReview(segue: segue)</p><p class="source-code">      default:</p><p class="source-code">         print("Segue not added")</p><p class="source-code">      }</p><p class="source-code">   }</p><p class="source-code">}</p><p>The <strong class="source-inline">prepare(for:sender:)</strong> method checks to see if the segue has the <strong class="source-inline">showReview</strong> segue identifier. If it does, the <strong class="source-inline">showReview(segue:)</strong> method is executed prior to transitioning from the <strong class="bold">Restaurant Detail</strong> screen to the <strong class="bold">Review Form</strong> screen. There will be an error because <strong class="source-inline">showReview(segue:)</strong> has not been implemented yet. You'll add that next.</p></li>
				<li>Add <a id="_idIndexMarker1158"/>the <strong class="source-inline">showReview(segue:)</strong> method inside the <strong class="source-inline">private</strong> extension, before the<a id="_idTextAnchor396"/><a id="_idTextAnchor397"/> <strong class="source-inline">createRating()</strong> method:<p class="source-code">func showReview(segue: UIStoryboardSegue) {</p><p class="source-code">   guard let navController = segue.destination as? </p><p class="source-code">   UINavigationController, let viewController = </p><p class="source-code">   navController.topViewController as? </p><p class="source-code">   ReviewFormViewController else {</p><p class="source-code">      return</p><p class="source-code">   }</p><p class="source-code">   viewController.selectedRestaurantID = </p><p class="source-code">   selectedRestaurant?.restaurantID</p><p class="source-code">}</p><p>This sets the <strong class="source-inline">restaurantID</strong> property of <strong class="source-inline">ReviewFormViewController</strong> to the identifier of the selected restaurant.</p></li>
				<li>Click the <strong class="source-inline">ReviewFormViewController</strong> file in the Project navigator. Add the following code inside the <strong class="source-inline">viewDidLoad()</strong> method to print the restaurant identifier to the Debug ar<a id="_idTextAnchor398"/><a id="_idTextAnchor399"/>ea:<p class="source-code">super.viewDidLoad()</p><p class="source-code"><strong class="bold">print(selectedRestaurantID as Any)</strong></p><p>This will let you know you have successfully passed the identifier value to <strong class="source-inline">ReviewFormViewController</strong>.</p></li>
			</ol>
			<p>Build<a id="_idIndexMarker1159"/> and run your project, set a location, and tap <strong class="bold">All</strong>. Tap a restaurant, and tap the <strong class="bold">Add Review</strong> button. In the <strong class="bold">Review Form</strong> screen, enter a review and tap <strong class="bold">Save</strong>:</p>
			<div>
				<div id="_idContainer496" class="IMG---Figure">
					<img src="image/Figure_21.17_B17469.jpg" alt="Figure 21.17: iOS Simulator showing Review Form screen Save button&#13;&#10;"/>
				</div>
			</div>
			<p class="figure-caption">Figure 21.17: iOS Simulator showing Review Form screen Save button</p>
			<p> The restaurant identifier will appear in the Debug area:</p>
			<p class="figure-caption"> </p>
			<div>
				<div id="_idContainer497" class="IMG---Figure">
					<img src="image/Figure_21.18_B17469.jpg" alt="Figure 21.18: Debug area showing the restaurant identifier&#13;&#10;"/>
				</div>
			</div>
			<p class="figure-caption">Figure 21.18: Debug area showing the restaurant identifier</p>
			<p>You've<a id="_idIndexMarker1160"/> successfully passed the restaurant identifier from <strong class="source-inline">RestaurantDetailViewController</strong> to <strong class="source-inline">ReviewFormViewController</strong>. Now, let's do the same for photos. You'll update <strong class="source-inline">PhotoFilterViewController</strong> to save photos with a restaurant identifier to the persistent store when the <strong class="bold">Save</strong> button is tapped in the next section.</p>
			<h1 id="_idParaDest-296"><a id="_idTextAnchor400"/>Updating the PhotoFilterViewController class to save photos</h1>
			<p>The code <a id="_idIndexMarker1161"/>that enables the <strong class="source-inline">PhotoFilterViewController</strong> class to save photos to the persistent store is similar to the code you implemented in the <strong class="source-inline">ReviewFormViewController</strong> class for saving reviews. You will now update the <strong class="source-inline">PhotoFilterViewController</strong> class to save photos when the <strong class="bold">Save</strong> button is tapped. Follow these steps:</p>
			<ol>
				<li value="1">Click the <strong class="source-inline">PhotoFilterViewController</strong> file in the Project navigator. Add the following method inside the <strong class="source-inline">private</strong> extension after t<a id="_idTextAnchor401"/><a id="_idTextAnchor402"/>he <strong class="source-inline">initialize()</strong> method: <p class="source-code">func saveSelectedPhoto() {</p><p class="source-code">   if let mainImage = self.mainImageView.image {</p><p class="source-code">      var restPhotoItem = </p><p class="source-code">      RestaurantPhotoItem()</p><p class="source-code">      restPhotoItem.date = Date()</p><p class="source-code">      restPhotoItem.photo = </p><p class="source-code">      mainImage.preparingThumbnail(of: </p><p class="source-code">      CGSize(width: 100, height: 100))</p><p class="source-code">      if let selRestID = selectedRestaurantID </p><p class="source-code">      {</p><p class="source-code">         restPhotoItem.restaurantID = </p><p class="source-code">         Int64(selRestID)</p><p class="source-code">      }</p><p class="source-code">      CoreDataManager.shared</p><p class="source-code">      .addPhoto(restPhotoItem)</p><p class="source-code">   }</p><p class="source-code">   dismiss(animated: true, completion: nil)</p><p class="source-code">}</p><p>Remember<a id="_idIndexMarker1162"/> that <strong class="source-inline">mainImageView</strong> is the outlet for the large image view in the <strong class="bold">Photo Filter</strong> screen. The <strong class="source-inline">saveSelectedPhoto()</strong> method first checks to see if the <strong class="source-inline">image</strong> property of <strong class="source-inline">mainImageView</strong> is set. If it is, the image is assigned to <strong class="source-inline">mainImage</strong>. Next, a <strong class="source-inline">RestaurantPhotoItem</strong> instance is created and assigned to <strong class="source-inline">restPhotoItem</strong>, and the current date is assigned to the <strong class="source-inline">restPhotoItem</strong> instance's <strong class="source-inline">date</strong> property. The <strong class="source-inline">mainImage</strong> instance's <strong class="source-inline">preparingThumbnail(of:)</strong> method is used to create a smaller version of the image, which is assigned to the <strong class="source-inline">restPhotoItem</strong> instance's <strong class="source-inline">photo</strong> property. After that, the <strong class="source-inline">restPhotoItem</strong> instance's <strong class="source-inline">restaurantID</strong> property is set to the selected restaurant's identifier. Finally, the <strong class="source-inline">CoreDataManager.shared.addPhoto(_:)</strong> method is called to save the photo to the persistent store, and the <strong class="bold">Photo Filter</strong> screen is dismissed.</p></li>
				<li>You need to trigger this method when the <strong class="bold">Save</strong> button is tapped. Add the following method inside the <strong class="source-inline">private</strong> extension after the <strong class="source-inline">o<a id="_idTextAnchor403"/><a id="_idTextAnchor404"/>nPhotoTapped(_:)</strong> method: <p class="source-code">@IBAction func onSaveTapped(_ sender: Any) { </p><p class="source-code">   saveSelectedPhoto()</p><p class="source-code">}</p><p>This method will be connected to the <strong class="bold">Save</strong> button later.</p></li>
				<li>To<a id="_idIndexMarker1163"/> assign the <strong class="source-inline">onSaveTapped(_:)</strong> method to the <strong class="bold">Save</strong> button, open the <strong class="source-inline">PhotoFilter</strong> storyboard file and click the <strong class="bold">Photo Filter View Controller</strong> icon in the <strong class="bold">Photo Filter View Controller Scene</strong>. Open the Connections inspector. Drag from the <strong class="bold">onSaveTapped</strong> action to the <strong class="bold">Save</strong> button:</li>
			</ol>
			<div>
				<div id="_idContainer498" class="IMG---Figure">
					<img src="image/Figure_21.19_B17469.jpg" alt="Figure 21.19: Connections inspector showing onSaveTapped: being assigned to the Save button&#13;&#10;"/>
				</div>
			</div>
			<p class="figure-caption">Figure 21.19: Connections inspector showing onSaveTapped: being assigned to the Save button</p>
			<p>Before you can save, you need to pass the restaurant identifier to <strong class="source-inline">PhotoFilterViewController</strong>. As you did before, you'll use segue identifiers to determine which segue is occurring, and then implement methods to pass the identifier value between<a id="_idIndexMarker1164"/> the two view controllers. Follow these steps:</p>
			<ol>
				<li value="1">Click the <strong class="source-inline">RestaurantDetail</strong> storyboard file in the Project navigator and select the segue used to go to the <strong class="bold">Photo Filter</strong> screen:<p class="figure-caption"> </p><div id="_idContainer499" class="IMG---Figure"><img src="image/Figure_21.20_B17469.jpg" alt="Figure 21.20: Editor area showing segue between Restaurant Detail and Photo Filter screens selected&#13;&#10;"/></div><p class="figure-caption">Figure 21.20: Editor area showing segue between Restaurant Detail and Photo Filter screens selected</p></li>
				<li>In the Attributes inspector, set <strong class="bold">Identifier</strong> under <strong class="bold">Storyboard Segue</strong> to <strong class="source-inline">showPhotoFilter</strong> and press <em class="italic">Return</em>:<div id="_idContainer500" class="IMG---Figure"><img src="image/Figure_21.21_B17469.jpg" alt="Figure 21.21: Attributes inspector with Identifier set to showPhotoFilter&#13;&#10;"/></div><p class="figure-caption">Figure 21.21: Attributes inspector with Identifier set to showPhotoFilter</p></li>
				<li>Click<a id="_idIndexMarker1165"/> the <strong class="source-inline">RestaurantDetailViewController</strong> file in the Project navigator. Update the <strong class="source-inline">prepare(for:sender:)</strong> method, as follows:<p class="source-code">override func prepare(for segue: UIStoryboardSegue,</p><p class="source-code">sender: Any?){</p><p class="source-code">   if let identifier = segue.identifier {</p><p class="source-code">      switch identifier {</p><p class="source-code">      case Segue.showReview.rawValue:</p><p class="source-code">         showR<a id="_idTextAnchor405"/><a id="_idTextAnchor406"/>eview(segue: segue)</p><p class="source-code"><strong class="bold">      case Segue.showPhotoFilter.rawValue:</strong></p><p class="source-code"><strong class="bold">         showPhotoFilter(segue: segue)</strong></p><p class="source-code">      default:</p><p class="source-code">         print("Segue not added")</p><p class="source-code">      }</p><p class="source-code">   }</p><p class="source-code">}</p><p>This makes the <strong class="source-inline">prepare(for:sender:)</strong> method check to see if the segue has the <strong class="source-inline">showPhotoFilter</strong> segue identifier. If it does, the <strong class="source-inline">showPhotoFilter(segue:)</strong> method is executed prior to transitioning from the <strong class="bold">Restaurant Detail</strong> screen to the <strong class="bold">Photo Filter</strong> screen. There will be an error because <strong class="source-inline">showPhotoFilter(segue:)</strong> has not been implemented yet.</p></li>
				<li>Add <a id="_idIndexMarker1166"/>the <strong class="source-inline">showPhotoFilter(segue:)</strong> method after the <strong class="source-inline">showReview()</strong> method insi<a id="_idTextAnchor407"/><a id="_idTextAnchor408"/>de your <strong class="source-inline">private</strong> extension:<p class="source-code">func showPhotoFilter(segue: UIStoryboardSegue) {</p><p class="source-code">   guard let navController = segue.destination as? </p><p class="source-code">   UINavigationController, let viewController = </p><p class="source-code">   navController.topViewController as? </p><p class="source-code">   PhotoFilterViewController else {</p><p class="source-code">      return</p><p class="source-code">   }</p><p class="source-code">   viewController.selectedRestaurantID = </p><p class="source-code">   selectedRestaurant?.restaurantID</p><p class="source-code">}</p><p>This sets <strong class="source-inline">PhotoFilterViewController</strong>'s <strong class="source-inline">restaurantID</strong> property to the identifier of the selected restaurant.</p></li>
			</ol>
			<p>Build and run your project, set a location, and tap <strong class="bold">All</strong>. Tap a restaurant, and tap the <strong class="bold">Add Photo</strong> button. Select a photo, apply a filter, and tap <strong class="bold">Save</strong>:</p>
			<div>
				<div id="_idContainer501" class="IMG---Figure">
					<img src="image/Figure_21.22_B17469.jpg" alt="Figure 21.22: iOS Simulator showing Photo Filter screen with Save button selected&#13;&#10;"/>
				</div>
			</div>
			<p class="figure-caption">Figure 21.22: iOS Simulator showing Photo Filter screen with Save button selected</p>
			<p>The photo will <a id="_idIndexMarker1167"/>be saved to the persistent store, and you will be returned to the <strong class="bold">Restaurant Detail</strong> screen.</p>
			<p>At this point, you can save reviews and photos. Fantastic! In the next section, you will add code to load the reviews and photos from the persistent store to be displayed on the <strong class="bold">Restaurant Detail</strong> screen.</p>
			<h1 id="_idParaDest-297"><a id="_idTextAnchor409"/>Displaying saved reviews and photos on the Restaurant Detail screen</h1>
			<p>The <strong class="bold">Save</strong> buttons<a id="_idIndexMarker1168"/> inside the <strong class="bold">Review Form</strong> and <strong class="bold">Photo Filter</strong> screens now save reviews and photos with a restaurant identifier. Now you need to configure the <strong class="bold">Restaurant Detail</strong> screen to display them. If you look in <strong class="source-inline">RestaurantDetail.storyboard</strong>, you'll see that collection<a id="_idIndexMarker1169"/> views have already been set up to display photos and reviews in the static table view cells. All<a id="_idIndexMarker1170"/> you need to do is to implement the respective<a id="_idIndexMarker1171"/> view controllers for the view and collection view cells. You'll start with the view and collection view cells used to display reviews. Follow these steps:</p>
			<ol>
				<li value="1">Right-click the <strong class="source-inline">LetsEat</strong> folder in the Project navigator and choose <strong class="bold">New Group</strong>. Name this group <strong class="source-inline">Reviews</strong>.</li>
				<li>Right-click the folder and select <strong class="bold">New File</strong>.</li>
				<li><strong class="bold">iOS</strong> should already be selected. Choose <strong class="bold">Cocoa Touch Class</strong>, and then click <strong class="bold">Next</strong>.</li>
				<li>Configure the file as follows:<p><strong class="bold">Class</strong>: <strong class="source-inline">ReviewCell</strong></p><p><strong class="bold">Subclass</strong>: <strong class="source-inline">UICollectionViewCell</strong> </p><p><strong class="bold">Also create XIB</strong>: Unchecked </p><p><strong class="bold">Language</strong>: <strong class="source-inline">Swift</strong></p><p>Click <strong class="bold">Next</strong>.</p></li>
				<li>Click <strong class="bold">Create</strong>. The <strong class="source-inline">ReviewCell</strong> file appears in the Project navigator. Enter the following <a id="_idTextAnchor410"/><a id="_idTextAnchor411"/>code between the curly braces:<p class="source-code">import UIKit</p><p class="source-code">class ReviewC<a id="_idTextAnchor412"/><a id="_idTextAnchor413"/>ell: UICollectionViewCell {</p><p class="source-code"><strong class="bold">   @IBOutlet var titleLabel: UILabel!</strong></p><p class="source-code"><strong class="bold">   @IBOutlet var dateLabel: UILabel!</strong></p><p class="source-code"><strong class="bold">   @IBOutlet var nameLabel: UILabel!</strong></p><p class="source-code"><strong class="bold">   @IBOutlet var reviewLabel: UILabel!</strong></p><p class="source-code"><strong class="bold">   @IBOutlet var ratingsView: RatingsView!</strong></p><p class="source-code">}</p></li>
			</ol>
			<p><strong class="source-inline">ReviewCell</strong> now <a id="_idIndexMarker1172"/>has the properties for<a id="_idIndexMarker1173"/> all the outlets <a id="_idIndexMarker1174"/>in the <a id="_idIndexMarker1175"/>collection view cell. Let's create <strong class="source-inline">ReviewsViewController</strong> next. Follow these steps:</p>
			<ol>
				<li value="1">Right-click the <strong class="source-inline">Reviews</strong> folder, and select <strong class="bold">New File</strong>.</li>
				<li><strong class="bold">iOS</strong> should already be selected. Choose <strong class="bold">Cocoa Touch Class</strong>, and then click <strong class="bold">Next</strong>.</li>
				<li>Configure the file as follows:<p><strong class="bold">Class</strong>:<strong class="source-inline"> ReviewsViewController</strong></p><p><strong class="bold">Subclass</strong>: <strong class="source-inline">UIViewController </strong></p><p><strong class="bold">Also create XIB</strong>: Unchecked </p><p><strong class="bold">Language</strong>: <strong class="source-inline">Swift</strong></p><p>Click <strong class="bold">Next</strong>.</p></li>
				<li>Click <strong class="bold">Create</strong>. The <strong class="source-inline">ReviewsViewController</strong> file appears in the Project navig<a id="_idTextAnchor414"/><a id="_idTextAnchor415"/>ator. Modify this file as follows:<p class="source-code">import UIKit</p><p class="source-code">class ReviewsViewController: UIViewController {</p><p class="source-code">   <strong class="bold">@IBOutlet var collectionView: UICollectionView!</strong></p><p class="source-code"><strong class="bold">   var selectedRestaurantID: Int? </strong></p><p class="source-code"><strong class="bold">   private var reviewItems: [ReviewItem] = []</strong></p><p class="source-code"><strong class="bold">   private var dateFormatter: DateFormatter = {</strong></p><p class="source-code"><strong class="bold">      let formatter = DateFormatter()</strong></p><p class="source-code"><strong class="bold">      formatter.dateFormat = "MMM dd, yyyy"</strong></p><p class="source-code"><strong class="bold">      return formatter</strong></p><p class="source-code"><strong class="bold">   }()</strong></p><p class="source-code">   override func viewDidLoad() { </p><p class="source-code">      super.viewDidLoad() </p><p class="source-code">     <strong class="bold"> initialize()</strong></p><p class="source-code">   }</p><p class="source-code"><strong class="bold">   override func viewDidAppear(_ animated: Bool) { </strong></p><p class="source-code"><strong class="bold">      super.viewDidAppear(animated) </strong></p><p class="source-code"><strong class="bold">      checkReviews()</strong></p><p class="source-code"><strong class="bold">   }</strong></p><p class="source-code">}</p><p>As you <a id="_idIndexMarker1176"/>can see, the <a id="_idIndexMarker1177"/>implementation of <strong class="source-inline">ReviewsViewController</strong> is straightforward. You have an outlet for a collection view, <strong class="source-inline">collectionView</strong>. <strong class="source-inline">selectedRestaurantID</strong> stores the restaurant <a id="_idIndexMarker1178"/>identifier. <strong class="source-inline">reviewItems</strong> contains<a id="_idIndexMarker1179"/> an array of <strong class="source-inline">ReviewItem</strong> instances. <strong class="source-inline">dateFormatter</strong> is an instance of the <strong class="source-inline">DateFormatter</strong> class that will be used to format the date for display. Don't worry about the errors, as you'll be typing in the implementation of the <strong class="source-inline">initialize()</strong> and <strong class="source-inline">setupDefaults()</strong> methods in the next step.</p><p class="callout-heading">Important Information</p><p class="callout">To learn more <a id="_idIndexMarker1180"/>about the <strong class="source-inline">DateFormatter</strong> class, visit this link: <a href="https://developer.apple.com/documentation/foundation/dateformatter">https://developer.apple.com/documentation/foundation/dateformatter</a>.</p></li>
				<li>Add a <strong class="source-inline">private</strong> exten<a id="_idTextAnchor416"/><a id="_idTextAnchor417"/>sion <a id="_idIndexMarker1181"/>with <a id="_idIndexMarker1182"/>the following code, as shown:<p class="source-code">private extension ReviewsViewController {</p><p class="source-code">   func initialize() {</p><p class="source-code">      setupCollectionView()</p><p class="source-code">   }</p><p class="source-code">   func setupCollectionView() {</p><p class="source-code">      let flow = UICollectionViewFlowLayout()</p><p class="source-code">      flow.sectionInset = UIEdgeInsets(top: 7,left: 7,</p><p class="source-code">      bottom: 7, right: 7)</p><p class="source-code">      flow.minimumInteritemSpacing = 0 </p><p class="source-code">      flow.minimumLineSpacing = 7 </p><p class="source-code">      flow.scrollDirection = .horizontal </p><p class="source-code">      collectionView.collectionViewLayout = flow</p><p class="source-code">   }</p><p class="source-code">}</p><p>The <strong class="source-inline">private</strong> extension<a id="_idIndexMarker1183"/> contains<a id="_idIndexMarker1184"/> the implementation for <strong class="source-inline">initialize()</strong> and <strong class="source-inline">setupCollectionView()</strong> methods. <strong class="source-inline">initialize()</strong> just calls <strong class="source-inline">setupCollectionView()</strong>. <strong class="source-inline">setupCollectionView()</strong> is used to configure the flow and spacing of the collection views and is similar to code you've written before.</p></li>
				<li>Add <a id="_idIndexMarker1185"/>the <a id="_idIndexMarker1186"/>following method <a id="_idIndexMarker1187"/>after <strong class="source-inline">setu<a id="_idTextAnchor418"/><a id="_idTextAnchor419"/>pCollectionView()</strong> to <a id="_idIndexMarker1188"/>implement <strong class="source-inline">checkReviews()</strong>:<p class="source-code">func checkReviews() {</p><p class="source-code">   let viewController = self.parent as? </p><p class="source-code">   RestaurantDetailViewController</p><p class="source-code">   if let restaurantID = </p><p class="source-code">   viewController?.selectedRestaurant?</p><p class="source-code">   .restaurantID {</p><p class="source-code">      reviewItems = </p><p class="source-code">      CoreDataManager.shared</p><p class="source-code">      .fetchReviews(by: restaurantID)</p><p class="source-code">      if !reviewItems.isEmpty {</p><p class="source-code">         collectionView.backgroundView = nil</p><p class="source-code">      } else {</p><p class="source-code">         let view = NoDataView(frame: </p><p class="source-code">         CGRect(x: 0, y: 0, width: </p><p class="source-code">         collectionView.frame.width,</p><p class="source-code">         height: </p><p class="source-code">         collectionView.frame.height))</p><p class="source-code">      view.set(title: "Reviews", desc: </p><p class="source-code">      "There are currently no reviews")</p><p class="source-code">      collectionView.backgroundView = view</p><p class="source-code">      }</p><p class="source-code">   }</p><p class="source-code">   collectionView.reloadData()</p><p class="source-code">}</p><p>This method will retrieve all restaurant reviews for the specified restaurant identifier. Let's break this down:</p><p class="source-code">let viewController = self.parent as? </p><p class="source-code">RestaurantDetailViewController</p><p>This <a id="_idIndexMarker1189"/>statement assigns <strong class="source-inline">RestaurantDetailViewController</strong> to a temporary constant, <strong class="source-inline">viewController</strong>.</p><p class="source-code">if let restaurantID = </p><p class="source-code">viewController?.selectedRestaurant?.restaurantID { </p><p>This <a id="_idIndexMarker1190"/>statement<a id="_idIndexMarker1191"/> assigns the restaurant<a id="_idIndexMarker1192"/> identifier of the restaurant shown in the <strong class="bold">Restaurant Detail</strong> screen to <strong class="source-inline">restaurantID</strong>.</p><p class="source-code">reviewItems = CoreDataManager.shared</p><p class="source-code">.fetchReviews(by: restaurantID)</p><p>This statement gets an array of reviews matching the given <strong class="source-inline">restaurantID</strong> from the persistent store and assigns it to <strong class="source-inline">reviewItems</strong>.</p><p class="source-code">if !reviewItems.isEmpty {</p><p class="source-code">   collectionView.backgroundView = nil</p><p class="source-code">} else {</p><p class="source-code">   let view = NoDataView(frame: </p><p class="source-code">   CGRect(x: 0, y: 0, width: </p><p class="source-code">   collectionView.frame.width,</p><p class="source-code">   height: </p><p class="source-code">   collectionView.frame.height))</p><p class="source-code">   view.set(title: "Reviews", desc: </p><p class="source-code">   "There are currently no reviews")</p><p class="source-code">   collectionView.backgroundView = view</p><p class="source-code">}</p><p>If there<a id="_idIndexMarker1193"/> are reviews for this restaurant, the <a id="_idIndexMarker1194"/>collection view's background view is set to <strong class="source-inline">nil</strong>; otherwise, you create a <strong class="source-inline">NoDataView</strong> instance, set the <strong class="source-inline">title</strong> and <strong class="source-inline">desc</strong> properties to <strong class="source-inline">"Reviews"</strong> and <strong class="source-inline">"There are currently no reviews"</strong> respectively, and assign it to the collection view's background view.</p><p class="source-code">collectionView.reloadData()</p><p>This code tells the collection view to redraw itself onscreen.</p></li>
				<li>Implement <a id="_idIndexMarker1195"/>the data source methods<a id="_idIndexMarker1196"/> for<a id="_idTextAnchor420"/><a id="_idTextAnchor421"/> the collection view by adding the following extension:<p class="source-code">extension ReviewsViewController: </p><p class="source-code">UICollectionViewDataSource {</p><p class="source-code">   func collectionView(_ collectionView: </p><p class="source-code">   UICollectionView, numberOfItemsInSection </p><p class="source-code">   section: Int) -&gt; Int {</p><p class="source-code">      reviewItems.count</p><p class="source-code">   }</p><p class="source-code">   func collectionView(_ collectionView: </p><p class="source-code">   UICollectionView, cellForItemAt indexPath: </p><p class="source-code">   IndexPath) -&gt; UICollectionViewCell {</p><p class="source-code">      let cell = collectionView</p><p class="source-code">      .dequeueReusableCell </p><p class="source-code">      (withReuseIdentifier: "reviewCell", </p><p class="source-code">      for: indexPath) as! ReviewCell</p><p class="source-code">      let reviewItem = reviewItems[indexPath.item] </p><p class="source-code">      cell.nameLabel.text = reviewItem.name </p><p class="source-code">      cell.titleLabel.text = reviewItem.title </p><p class="source-code">      cell.reviewLabel.text = </p><p class="source-code">      reviewItem.customerReview </p><p class="source-code">      if let reviewItemDate = reviewItem.date {</p><p class="source-code">         cell.dateLabel.text = </p><p class="source-code">         dateFormatter.string(from: </p><p class="source-code">         reviewItemDate)</p><p class="source-code">      }</p><p class="source-code">      if let reviewItemRating = reviewItem.rating </p><p class="source-code">      {</p><p class="source-code">         cell.ratingsView.rating = </p><p class="source-code">         reviewItemRating</p><p class="source-code">      }</p><p class="source-code">      return cell</p><p class="source-code">   }</p><p class="source-code">}</p><p>This is similar to what you've done before. The number of cells to be displayed in the collection view is the same as the number of items in the <strong class="source-inline">reviewItems</strong> array. You set each cell's contents using the properties of the corresponding <strong class="source-inline">ReviewItem</strong> instance.</p></li>
				<li>Add the flow <a id="_idIndexMarker1197"/>layout delegate <a id="_idIndexMarker1198"/>methods f<a id="_idTextAnchor422"/><a id="_idTextAnchor423"/>or the collection <a id="_idIndexMarker1199"/>view by adding the<a id="_idIndexMarker1200"/> following extension:<p class="source-code">extension ReviewsViewController: UICollectionViewDelegateFlowLayout {</p><p class="source-code">   func collectionView(_ collectionView: </p><p class="source-code">   UICollectionView, layout collectionViewLayout: </p><p class="source-code">   UICollectionViewLayout, sizeForItemAt </p><p class="source-code">   indexPath: IndexPath) -&gt; CGSize {</p><p class="source-code">      let edgeInset = 7.0</p><p class="source-code">      if reviewItems.count == 1 {</p><p class="source-code">         let cellWidth = </p><p class="source-code">         collectionView.frame.size.width - </p><p class="source-code">         (edgeInset * 2) </p><p class="source-code">         return CGSize(width: cellWidth, height: </p><p class="source-code">         200)</p><p class="source-code">      } else {</p><p class="source-code">         let cellWidth = </p><p class="source-code">         collectionView.frame.size.width - </p><p class="source-code">         (edgeInset * 3)</p><p class="source-code">         return CGSize(width: cellWidth, height: </p><p class="source-code">         200)</p><p class="source-code">      }</p><p class="source-code">   }</p><p class="source-code">}</p><p>This<a id="_idIndexMarker1201"/> method returns the size of the<a id="_idIndexMarker1202"/> collection view cell to be <a id="_idIndexMarker1203"/>displayed. If there is only <a id="_idIndexMarker1204"/>one item in the <strong class="source-inline">reviewItems</strong> array, the cell's width is set to the width of the collection view—14 points; otherwise, it is set to the width of the collection view—21 points. The height is set to <strong class="source-inline">200</strong> points.</p></li>
			</ol>
			<p><strong class="source-inline">ReviewsViewController</strong> is now complete. Now, you'll finish the implementation of the <strong class="source-inline">RestaurantDetail</strong> storyboard file. Follow these steps:</p>
			<ol>
				<li value="1">Click the <strong class="source-inline">RestaurantDetail</strong> storyboard file in the Project navigator. Select the <strong class="bold">View Controller Scene</strong> containing the collection view for reviews. Click the Identity inspector button, set <strong class="bold">Class</strong> to <strong class="source-inline">ReviewsViewController,</strong> and press <em class="italic">Return</em>:<div id="_idContainer502" class="IMG---Figure"><img src="image/Figure_21.23_B17469.jpg" alt="Figure 21.23: Identity inspector with Class set to ReviewsViewController&#13;&#10;"/></div><p class="figure-caption">Figure 21.23: Identity inspector with Class set to ReviewsViewController</p><p>The scene name will change to <strong class="bold">Reviews View Controller Scene</strong>.</p></li>
				<li>Select the <strong class="bold">Collection View Cell</strong> in the document outline. Click the Identity inspector button, set <strong class="bold">Class</strong> to <strong class="source-inline">ReviewCell,</strong> and press <em class="italic">Return</em>:<p class="figure-caption"> </p><div id="_idContainer503" class="IMG---Figure"><img src="image/Figure_21.24_B17469.jpg" alt="Figure 21.24: Identity inspector with Class set to ReviewCell&#13;&#10;"/></div><p class="figure-caption">Figure 21.24: Identity inspector with Class set to ReviewCell</p></li>
				<li>Select the<a id="_idIndexMarker1205"/> view in<a id="_idIndexMarker1206"/> the document outline. Click <a id="_idIndexMarker1207"/>the Identity inspector <a id="_idIndexMarker1208"/>button, set <strong class="bold">Class</strong> to <strong class="source-inline">RatingsView,</strong> and press <em class="italic">Return</em>:<div id="_idContainer504" class="IMG---Figure"><img src="image/Figure_21.25_B17469.jpg" alt="Figure 21.25: Identity inspector with Class set to RatingsView&#13;&#10;"/></div><p class="figure-caption">Figure 21.25: Identity inspector with Class set to RatingsView</p></li>
				<li>Select <strong class="bold">reviewCell</strong> in the document outline. Click the Attributes inspector button. Set <strong class="bold">Identifier</strong> to <strong class="source-inline">reviewCell</strong> if it's not already set:<p class="figure-caption"> </p><div id="_idContainer505" class="IMG---Figure"><img src="image/Figure_21.26_B17469.jpg" alt="Figure 21.26: Attributes inspector with Identifier set to reviewCell&#13;&#10;"/></div><p class="figure-caption">Figure 21.26: Attributes inspector with Identifier set to reviewCell</p></li>
				<li>Click <a id="_idIndexMarker1209"/>the<a id="_idIndexMarker1210"/> Connections inspector. Drag from the <strong class="source-inline">dateLabel</strong> outlet to the <strong class="bold">Label</strong> shown, if it's not <a id="_idIndexMarker1211"/>already set:<div id="_idContainer506" class="IMG---Figure"><img src="image/Figure_21.27_B17469.jpg" alt="Figure 21.27: Connections inspector showing dateLabel outlet&#13;&#10;"/></div><p class="figure-caption">Figure 21.27: Connections inspector showing dateLabel outlet</p></li>
				<li>Drag<a id="_idIndexMarker1212"/> from the <strong class="source-inline">nameLabel</strong> outlet to the <strong class="bold">Label</strong> shown, if it's not already set:<p class="figure-caption"> </p><div id="_idContainer507" class="IMG---Figure"><img src="image/Figure_21.28_B17469.jpg" alt="Figure 21.28: Connections inspector showing nameLabel outlet&#13;&#10;"/></div><p class="figure-caption">Figure 21.28: Connections inspector showing nameLabel outlet</p></li>
				<li> Drag<a id="_idIndexMarker1213"/> from the <strong class="source-inline">reviewLabel</strong> outlet<a id="_idIndexMarker1214"/> to the <strong class="bold">Label</strong> shown, if it's not already set:<div id="_idContainer508" class="IMG---Figure"><img src="image/Figure_21.29_B17469.jpg" alt="Figure 21.29: Connections inspector showing reviewLabel outlet&#13;&#10;"/></div><p class="figure-caption">Figure 21.29: Connections inspector showing reviewLabel outlet</p></li>
				<li>Drag<a id="_idIndexMarker1215"/> from the <strong class="source-inline">titleLabel</strong> outlet<a id="_idIndexMarker1216"/> to the <strong class="bold">Label</strong> shown, if it's not already set:<div id="_idContainer509" class="IMG---Figure"><img src="image/Figure_21.30_B17469.jpg" alt="Figure 21.30: Connections inspector shown titleLabel outlet&#13;&#10;"/></div><p class="figure-caption">Figure 21.30: Connections inspector shown titleLabel outlet</p></li>
				<li>Drag <a id="_idIndexMarker1217"/>from the <strong class="source-inline">ratingsView</strong> outlet to the ratings view shown, if it's not already set:<div id="_idContainer510" class="IMG---Figure"><img src="image/Figure_21.31_B17469.jpg" alt="Figure 21.31: Connections inspector showing the ratingsView outlet&#13;&#10;"/></div><p class="figure-caption">Figure 21.31: Connections inspector showing the ratingsView outlet</p></li>
				<li>Select <a id="_idIndexMarker1218"/>the <strong class="bold">Reviews View Controller</strong> icon<a id="_idIndexMarker1219"/> for the <strong class="bold">Reviews View Controller Scene </strong>in the document outline. Drag<a id="_idIndexMarker1220"/> from the <strong class="source-inline">collectionView</strong> outlet to the <strong class="bold">Collection View</strong> as shown, if it's not already set:<p class="figure-caption"> </p><div id="_idContainer511" class="IMG---Figure"><img src="image/Figure_21.32_B17469.jpg" alt="Figure 21.32: Connections inspector showing the collectionView outlet&#13;&#10;"/></div><p class="figure-caption">Figure 21.32: Connections inspector showing the collectionView outlet</p></li>
				<li>Select <strong class="bold">Collection View</strong> in<a id="_idIndexMarker1221"/> the<a id="_idIndexMarker1222"/> document outline. Drag from the <strong class="source-inline">delegate</strong> and <strong class="source-inline">dataSource</strong> outlets to the <strong class="bold">Reviews View Controller</strong> icon:</li>
			</ol>
			<p class="figure-caption"> </p>
			<div>
				<div id="_idContainer512" class="IMG---Figure">
					<img src="image/Figure_21.33_B17469.jpg" alt="Figure 21.33: Connections inspector showing the dataSource and delegate outlets&#13;&#10;"/>
				</div>
			</div>
			<p class="figure-caption">Figure 21.33: Connections inspector showing the dataSource and delegate outlets</p>
			<p>Build and run your app. You should see the reviews you added earlier appear:</p>
			<div>
				<div id="_idContainer513" class="IMG---Figure">
					<img src="image/Figure_21.34_B17469.jpg" alt="Figure 21.34: iOS Simulator showing Restaurant Detail screen containing reviews&#13;&#10;"/>
				</div>
			</div>
			<p class="figure-caption">Figure 21.34: iOS Simulator showing Restaurant Detail screen containing reviews</p>
			<p>The<a id="_idIndexMarker1223"/> implementation of view controllers for the collection<a id="_idIndexMarker1224"/> view and collection <a id="_idIndexMarker1225"/>view cells used to display <a id="_idIndexMarker1226"/>reviews is now complete, and your app now can display reviews that were entered using the <strong class="bold">Review Form</strong> screen earlier. If you have more than one review, you can swipe left and right to see each review. Since each review has a rating, you can use them to calculate and add an overall rating for a restaurant. Let's modify the app to do this next.</p>
			<h1 id="_idParaDest-298"><a id="_idTextAnchor424"/>Calculating a restaurant's overall rating</h1>
			<p>The <strong class="bold">Restaurant Detail</strong> screen's overall rating label displays <strong class="bold">0.0</strong>, and the ratings view displays 3.5 stars, regardless<a id="_idIndexMarker1227"/> of the actual rating. To add an overall rating, you need to get the ratings from all the reviews and average them. Let's add a new method to <strong class="source-inline">CoreDataManager</strong> to do this. Follow these steps:</p>
			<ol>
				<li value="1">Click the <strong class="source-inline">CoreDataManager</strong> file inside the Project navigator (inside the <strong class="source-inline">Core Data</strong> folder in t<a id="_idTextAnchor425"/><a id="_idTextAnchor426"/>he <strong class="source-inline">Misc</strong> folder). Add the following method before the <strong class="source-inline">addReview(_:)</strong> method:<p class="source-code">func fetchRestaurantRating(by identifier: Int) -&gt; </p><p class="source-code">Double { </p><p class="source-code">   let reviewItems = fetchReviews(by: identifier)</p><p class="source-code">   let sum = reviewItems.reduce(0, {$0 + </p><p class="source-code">   ($1.rating ?? 0)}) </p><p class="source-code">   return sum / Double(reviewItems.count)</p><p class="source-code">}</p><p>In this<a id="_idIndexMarker1228"/> method, all reviews for a particular restaurant are fetched from the persistent store and assigned to <strong class="source-inline">reviews</strong>. The <strong class="source-inline">reduce()</strong> method takes a closure, which is used to add all the review ratings together. Finally, the average rating value is calculated and returned.</p><p class="callout-heading">Important Information</p><p class="callout">You can learn more about<a id="_idIndexMarker1229"/> the <strong class="source-inline">reduce()</strong> method at this link: <a href="https://developer.apple.com/documentation/swift/array/2298686-reduce">https://developer.apple.com/documentation/swift/array/2298686-reduce</a>.</p></li>
				<li>Click the <strong class="source-inline">RestaurantDetailViewController</strong> file in the Project navigator (inside<a id="_idTextAnchor427"/><a id="_idTextAnchor428"/> the <strong class="source-inline">RestaurantDetail</strong> folder). Update the <strong class="source-inline">createRating()</strong> method, as follows:<p class="source-code">func createRating() {</p><p class="source-code">   ratingsView.isEnabled = <strong class="bold">false</strong></p><p class="source-code">   <strong class="bold">if let restaurantID =</strong></p><p class="source-code"><strong class="bold">   selectedRestaurant?.restaurantID {</strong></p><p class="source-code"><strong class="bold">      let ratingValue = </strong></p><p class="source-code"><strong class="bold">      CoreDataManager.shared.</strong></p><p class="source-code"><strong class="bold">      fetchRestaurantRating(by: </strong></p><p class="source-code"><strong class="bold">      restaurantID)</strong></p><p class="source-code"><strong class="bold">      ratingsView.rating = ratingValue</strong></p><p class="source-code"><strong class="bold">      if ratingValue.isNaN {</strong></p><p class="source-code"><strong class="bold">         overallRatingLabel.text = "0.0"</strong></p><p class="source-code"><strong class="bold">      } else {</strong></p><p class="source-code"><strong class="bold">         let roundedValue = ((ratingValue *</strong></p><p class="source-code"><strong class="bold">         10).rounded() / 10)</strong></p><p class="source-code"><strong class="bold">         overallRatingLabel.text = </strong></p><p class="source-code"><strong class="bold">         "\(roundedValue)"</strong></p><p class="source-code"><strong class="bold">      }</strong></p><p class="source-code"><strong class="bold">   }</strong></p><p class="source-code">}</p><p>The method first assigns the <strong class="source-inline">selectedRestaurant</strong> instance's <strong class="source-inline">restaurantID</strong> property to <strong class="source-inline">restaurantID</strong>. If successful, the <strong class="source-inline">CoreDataManager.shared.fetchRestaurantRating()</strong> method is called, which <a id="_idIndexMarker1230"/>gets all the reviews with <strong class="source-inline">restaurantID</strong>'s restaurant identifier value, and calculates the average rating. <strong class="source-inline">ratingValue</strong> is then set to the average rating and used to update the ratings view's <strong class="source-inline">rating</strong> property, which determines the number of stars displayed in the <strong class="bold">Restaurant Detail</strong> screen. <strong class="source-inline">roundedValue</strong> is then calculated from <strong class="source-inline">ratingValue</strong> to return a number with 1 decimal point, and is used to set the <strong class="source-inline">text</strong> property for <strong class="source-inline">overallRatingLabel</strong>.</p></li>
				<li>The overall rating will also need to be updated whenever the user adds a new review in the <strong class="bold">Review Form</strong> screen. Add the following code after the <strong class="source-inline">viewDidLoad()</strong> method:<p class="source-code">override func viewDidAppear(_ animated: Bool) {</p><p class="source-code">   super.viewDidAppear(animated)</p><p class="source-code">   createRating()</p><p class="source-code">}</p><p>This will recalculate <a id="_idIndexMarker1231"/>the rating when the <strong class="bold">Review Form</strong> screen is dismissed and the <strong class="bold">Restaurant Detail</strong> screen reappears.</p></li>
			</ol>
			<p>Build and run your project, and you should now see an overall rating for restaurants that have reviews, as well as a corresponding star rating as shown:</p>
			<div>
				<div id="_idContainer514" class="IMG---Figure">
					<img src="image/Figure_21.35_B17469.jpg" alt="Figure 21.35: iOS Simulator showing Restaurant Detail screen with overall ratings&#13;&#10;"/>
				</div>
			</div>
			<p class="figure-caption">Figure 21.35: iOS Simulator showing Restaurant Detail screen with overall ratings</p>
			<p>There's still one<a id="_idIndexMarker1232"/> thing left to do, and that's adding photo reviews. Your challenge is to add photo reviews and to display them in the collection view just under the collection view used for reviews. The way to do this is very similar to the way you used to add reviews. This chapter covers all you need to know, and if you get stuck, feel free to use the completed project files for this chapter, which you will find in the <strong class="source-inline">Chapter21</strong> folder of the code bundle of this book, downloadable from <a href="https://github.com/PacktPublishing/iOS-15-Programming-for-Beginners-Sixth-Edition">https://github.com/PacktPublishing/iOS-15-Programming-for-Beginners-Sixth-Edition</a>. You can also watch the CiA video for this chapter, located at <a href="https://bit.ly/3o81yKK">https://bit.ly/3o81yKK</a>.</p>
			<h1 id="_idParaDest-299"><a id="_idTextAnchor429"/>Summary</h1>
			<p>In this chapter, you learned about Core Data and its different components. You created data models for your app named <strong class="source-inline">Review</strong> and <strong class="source-inline">RestaurantPhoto</strong>, and you created the corresponding model objects for your app named <strong class="source-inline">ReviewItem</strong> and <strong class="source-inline">RestaurantPhotoItem</strong>. After that, you implemented <strong class="source-inline">CoreDataManager</strong> to set up Core Data components for your app. </p>
			<p>You updated <strong class="source-inline">ReviewFormViewController</strong> and <strong class="source-inline">PhotoFilterViewController</strong> to save reviews and photos together with a restaurant identifier to the persistent store. You modified <strong class="source-inline">RestaurantDetailViewController</strong> to load reviews for a particular restaurant based on the restaurant identifier, and displayed them in a collection view. You also calculated and displayed the overall rating for that restaurant.</p>
			<p>Finally, on your own, you modified <strong class="source-inline">RestaurantDetailViewController</strong> to load photos for a particular restaurant based on the restaurant identifier, and displayed them in a collection view.</p>
			<p>You now have a basic understanding of how Core Data works. You're also able to set up Core Data components and enable an interface between your app and Core Data components using a data manager class. You also know how to save and load reviews and photos using Core Data, which you will now be able to implement in your own apps. </p>
			<p>You have come to the end of a long journey, and have now finished building your app's primary functionality. All the screens work, and reviews and photos are persistent. Fantastic job!</p>
			<p>This concludes <em class="italic">Part 3</em> of this book. In the next part, you'll find out about the cool new features Apple has introduced in iOS 15 and how to add them to your app, starting with getting your app ready for Apple Macs in the next chapter.</p>
		</div>
	</body></html>