<html><head></head><body><div class="chapter" title="Chapter&#xA0;6.&#xA0;Implementing Fonts, User Interfaces, and Localization"><div class="titlepage"><div><div><h1 class="title"><a id="ch06"/>Chapter 6. Implementing Fonts, User Interfaces, and Localization</h1></div></div></div><p>Now that we have the knowledge to create 3D worlds populated with animated characters, we really need to start thinking about how to improve the look of the user interface we present to the player.</p><p>In this chapter we'll be covering the following:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">Creating fonts that can be used in a Marmalade project</li><li class="listitem" style="list-style-type: disc">Drawing and formatting of text</li><li class="listitem" style="list-style-type: disc">Discussing ways of implementing your game's user interface</li><li class="listitem" style="list-style-type: disc">Localizing your game into multiple languages</li></ul></div><div class="section" title="Implementing fonts"><div class="titlepage"><div><div><h1 class="title"><a id="ch06lvl1sec37"/>Implementing fonts</h1></div></div></div><p>The first step<a id="id797" class="indexterm"/> toward improving the look of our game is to say goodbye to the debug font and replace it with something a little more stylish. The Marmalade SDK comes complete with an API called IwGxFont dedicated to font rendering, so let's put it to good use.</p><div class="section" title="Adding the IwGxFont API to a project"><div class="titlepage"><div><div><h2 class="title"><a id="ch06lvl2sec90"/>Adding the IwGxFont API to a project</h2></div></div></div><p>By now I'm <a id="id798" class="indexterm"/>
<a id="id799" class="indexterm"/>sure you must be able to hazard a guess as to how this is done. That's right, just add <code class="literal">iwgxfont</code> to the subprojects section in the MKB file, and then make a call to <code class="literal">IwGxFontInit</code> <a id="id800" class="indexterm"/>to initialize the API, and <code class="literal">IwGxFontTerminate</code> <a id="id801" class="indexterm"/>to free it at shutdown time.</p><p>As the name of this API suggests, it requires IwGx in order to work. We also need IwResManager so we can load the font data into memory, so the initialization call for IwGxFont must occur after these two modules have been initialized, as shown in the following code <a id="id802" class="indexterm"/>
<a id="id803" class="indexterm"/>snippet:</p><div class="informalexample"><pre class="programlisting">IwGxInit();
IwResManagerInit();
IwGxFontInit();</pre></div></div><div class="section" title="Creating a font resource"><div class="titlepage"><div><div><h2 class="title"><a id="ch06lvl2sec91"/>Creating a font resource</h2></div></div></div><p>The first thing we need to do is create a <code class="literal">CIwGxFont</code> resource describing the font that we want to use. This is easily done thanks to the <span class="strong"><strong>Marmalade Studio - Font Builder</strong></span> utility<a id="id804" class="indexterm"/> that is installed as part of the Marmalade SDK. The following image shows a screenshot of this program in action:</p><div class="mediaobject"><img src="graphics/3363_06_01.jpg" alt="Creating a font resource"/></div><p>The IwGxFont API renders text by drawing each character individually by using sections of a large bitmap that contains an image of all the characters we need to render. Generating the bitmap itself is fairly trivial and could be done with any art package, but we need to somehow be able to specify which part of the bitmap represents which character. This is where IwGxFont and the font builder utility come to our aid.</p><p>Here are the basic steps <a id="id805" class="indexterm"/>needed to generate a font resource:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Start the <span class="strong"><strong>Marmalade Studio - Font </strong></span><a id="id806" class="indexterm"/><span class="strong"><strong>Builder</strong></span> utility. You can find a Windows Start button menu shortcut for it under <span class="strong"><strong>Marmalade</strong></span> | <span class="strong"><strong>x.x</strong></span> | <span class="strong"><strong>Tools</strong></span>, where <span class="strong"><strong>x.x</strong></span> represents the version number of the Marmalade SDK you have installed.</li><li class="listitem">In the top-left panel labeled <span class="strong"><strong>Input</strong></span>, first click on the <span class="strong"><strong>Select…</strong></span> button to display a font selection dialog. Choose the font, size, and style you require and click on <span class="strong"><strong>OK</strong></span>. You can choose any installed Windows font, whether it be a scalable TrueType font or a fixed-size bitmapped font.</li><li class="listitem">The <span class="strong"><strong>Characters</strong></span> textbox allows you to specify a list of the characters you require in your font. A default selection covering most European languages is present, but you can add or remove as many characters as you want. Fewer characters is obviously better though, as it will reduce the size of the bitmap that gets generated and thus take up less memory. It is also possible to populate this textbox by loading a text file using <span class="strong"><strong>File</strong></span> | <span class="strong"><strong>Load Character Map</strong></span>. The <span class="strong"><strong>Characters</strong></span> textbox will then contain every unique character present in the text file, minus formatting characters such as tabs or newlines.</li><li class="listitem">Moving on to the <a id="id807" class="indexterm"/>section labeled <span class="strong"><strong>Output Options</strong></span>, you can choose a color for the font using the numeric entry boxes or by clicking on the <span class="strong"><strong>Select…</strong></span> button to display a color selection dialog. It is recommended that you keep the color set to the default of bright white as the text color can then easily be set at runtime.</li><li class="listitem">There are also some other settings here that allow you to adjust the look of the font. There are checkboxes to force all characters to be in capitals and to enable the addition of a drop shadow to the font. If this checkbox is ticked, a textbox allows the pixel offset of the drop shadow to be specified.</li><li class="listitem">Next, look at the top right panel labeled <span class="strong"><strong>Output</strong></span>. Here we can see a preview of what the generated font characters will look like. Just click on the <span class="strong"><strong>Redraw</strong></span> button and after a short delay the characters will appear in the view area. You can then use the two sets of <span class="strong"><strong>Prev</strong></span> and <span class="strong"><strong>Next</strong></span> buttons to cycle through each character.</li><li class="listitem">We're nearly ready to export the font; but before we can, we need to specify where we want the font files to be created, which is done in the <span class="strong"><strong>Saving and Loading</strong></span> panel. Click on the <span class="strong"><strong>Browse…</strong></span> button to display a file requester to choose the required directory or enter it directly into the <span class="strong"><strong>Save Path</strong></span> textbox. The last part of this filename is the base filename that will be used to export the font data.</li><li class="listitem">To create the font files, ensure that the two checkboxes labeled <span class="strong"><strong>Save .TGA</strong></span> and <span class="strong"><strong>Save .gxfont</strong></span> are checked, then click on the <span class="strong"><strong>Create</strong></span> button.</li></ol></div><p>There are a number of options we haven't explored in this run-through, as most of the time you won't need to worry <a id="id808" class="indexterm"/>about them. In particular, we skipped the panel labeled <span class="strong"><strong>Input (per range) Options</strong></span> entirely.</p><p>This panel provides control over font features such as kerning, which is the offset between the characters of a font. Kerning can sometimes be useful for bringing certain character combinations closer together. For example, consider the capital letters A and V. The shapes of these characters mean you may want to draw them slightly closer to provide a more natural looking result when they are displayed next to each other.</p><p>You can also declare subranges of characters, which allow you to apply different global settings to certain ranges of characters. You can use this facility to use completely different sizes of characters or even completely different source fonts, for different character ranges. This can be particularly useful if we want to create a font that contains characters from the standard ASCII set and characters from another language. The font we use for the ASCII characters may not contain the characters for the other language, so we can create a sub range that allows us to pick a completely different font for those characters.</p></div><div class="section" title="The GXFONT file format"><div class="titlepage"><div><div><h2 class="title"><a id="ch06lvl2sec92"/>The GXFONT file format</h2></div></div></div><p>The font builder utility creates two types of files to define a font resource. The first of these is the actual font bitmap, which is exported in the<a id="id809" class="indexterm"/> Targa file format, an image file format usually identified by the file <a id="id810" class="indexterm"/>extension <code class="literal">.tga</code>.</p><p>The second file exported is a <a id="id811" class="indexterm"/> <span class="strong"><strong>GXFONT file</strong></span>, which acts as both a way of allowing the font to be reloaded into the font builder for further editing, and a way of loading the font into our own programs.</p><p>The following is an example GXFONT file<a id="id812" class="indexterm"/> for a font containing only numeric characters drawn using the standard Windows font Arial Black at 20 points:</p><div class="informalexample"><pre class="programlisting">//Temp file created by AS Font Builder (User: Sean At: 06/29/12 18:00:06)
//Command Line:
//: -fontdesc "0;-27;0;0;0;900;0;0;0;0;3;2;1;34;Arial Black" 0 4 0 -pad 0 0 
//: -col #FFFFFF -shadow 0 -spacing 4 -force16 0

CIwGxFont
{
  utf8 1
  image numbers.tga
  charmap "0123456789"
}</pre></div><p>As you can see, it's fairly self-explanatory. The comments at the start of the file are primarily used by the font builder utility to know what settings were used to create the font, so you should leave these values well alone if you want to edit the font later.</p><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="note34"/>Note</h3><p>We can edit a font in the font builder utility at a later date by using <span class="strong"><strong>File</strong></span> | <span class="strong"><strong>Load Font</strong></span> or by pressing the <span class="strong"><strong>Load…</strong></span> button. A file requester will appear allowing us to choose the GXFONT file we wish to edit.</p></div></div><p>he part of the <a id="id813" class="indexterm"/> GXFONT file we're really interested in is the definition of the <code class="literal">CIwGxFont</code> instance. The three parameters we see here indicate that the character encoding to be used with this font should be UTF-8, the bitmap image to use is called <code class="literal">numbers.tga</code>, and the characters present in the font are the numerals zero through nine.</p><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="note35"/>Note</h3><p>By default, UTF-8 character encoding is chosen, as this format often provides the most compact memory representation of text strings, at least as far as European languages are concerned.</p></div></div><p>If we've specified any other font settings in the font builder utility, such as character subranges or kerning information, this will also be represented in both the comments at the top of the file and the <code class="literal">CIwGxFont</code> structure. We won't cover this here though, since the font builder takes care of all the hard work for us.</p></div><div class="section" title="Loading and accessing font resources"><div class="titlepage"><div><div><h2 class="title"><a id="ch06lvl2sec93"/>Loading and accessing font resources</h2></div></div></div><p>As with all the<a id="id814" class="indexterm"/> resource types we've seen, we load a font resource into our <a id="id815" class="indexterm"/>program by adding a reference to it into a GROUP file, loading the GROUP file using the resource manager, and then searching for the font resource.</p><p>For completeness, here is a code snippet showing how to do this:</p><div class="informalexample"><pre class="programlisting">CIwResGroup* lpResGroup = IwGetResManager()-&gt;
LoadGroup("fonts/fonts.group");
CIwGxFont* lpSmallFont = static_cast&lt;CIwGxFont*&gt;(IwGetResManager()-&gt;
GetResNamed("small", "CIwGxFont"));</pre></div></div><div class="section" title="Drawing text using a font resource"><div class="titlepage"><div><div><h2 class="title"><a id="ch06lvl2sec94"/>Drawing text using a font resource</h2></div></div></div><p>With a font <a id="id816" class="indexterm"/>
<a id="id817" class="indexterm"/>resource loaded and a pointer to it obtained, we can start to draw some text on screen with it. First we'll look at the basics of drawing a string of text, then we'll take a look at how <a id="id818" class="indexterm"/>
<a id="id819" class="indexterm"/>we can justify the text, change its size, and how we can make drawing it a little more optimized.</p><div class="section" title="Drawing text on screen"><div class="titlepage"><div><div><h3 class="title"><a id="ch06lvl3sec66"/>Drawing text on screen</h3></div></div></div><p>When we <a id="id820" class="indexterm"/>
<a id="id821" class="indexterm"/>were looking at how to create a font resource, it was mentioned that a color could be chosen for the font. It is recommended to choose white so we can change the color of our text at runtime to any color we want. We change the color of the font by modulating the font bitmap with our chosen color, so if the font bitmap is not white this will not produce the desired color change.</p><p>We'll be seeing how to change the font color in a moment, but in order for font coloring to work there is one quirk of IwGxFont that must be mentioned first.</p><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="note36"/>Note</h3><p>When attempting to recolor a font at runtime, we must ensure that emissive lighting is enabled using the function call<a id="id822" class="indexterm"/> <code class="literal">IwGxLightingEmissive(true)</code>. IwGxFont affects the color of a font by using the emissive lighting component, which will not be applied if it is disabled.</p></div></div><p>With the note about lighting out of the way, the first step in rendering text is to indicate which font we want to use to draw it. This is done by passing a pointer to the relevant <code class="literal">CIwGxFont</code> instance into the <a id="id823" class="indexterm"/>function <code class="literal">IwGxFontSetFont</code>.</p><p>Next, we can set the color we want to use with<a id="id824" class="indexterm"/> <code class="literal">IwGxFontSetCol</code>. There are two versions of this function, one that takes a reference to a <code class="literal">const CIwColour</code> instance, and another that takes the color value as a uint32 value. When using the latter, bear in mind that the color is specified as ABGR—that is, alpha in the most significant byte, then blue, green, and red in the least significant byte.</p><p>We now need to indicate where on the screen we want the text to appear, which we do by defining a rectangular area in which the text should appear. This is specified by using a <code class="literal">CIwRect</code> instance that contains x and y values for the top left of the rectangle, plus a width and height value. The function call we use is <code class="literal">IwGxFontSetRect</code>.</p><p>Drawing the text is now possible using the<a id="id825" class="indexterm"/> <code class="literal">IwGxFontDrawText</code> function. The first parameter is the string of text to print and is specified as a <code class="literal">const CIwChar</code> pointer. <code class="literal">CIwChar</code> is just a <code class="literal">typedef</code> type for the standard C <code class="literal">char</code> type.</p><p>The default encoding for text is UTF-8. For text comprising of characters from the ASCII set, this means we don't have to do anything to the text data at all.</p><p>The function also takes a second parameter, which is the length of the text to be drawn. This has a default parameter value of <code class="literal">-1</code>, which indicates the entire string should be drawn. Any other value will draw the specified number of characters. This is handy if you want to implement a system common in many games where text appears on screen one character at a time.</p><p>Putting this <a id="id826" class="indexterm"/>
<a id="id827" class="indexterm"/>all together, here's an example that draws "Hello World" on the screen in yellow:</p><div class="informalexample"><pre class="programlisting">IwGxLightingEmissve(true);
IwGxFontSetFont(lpSmallFont);
IwGxFontSetCol(0xFF00FFFF);
IwGxFontSetRect(CIwRect(0, 0,IwGxGetScreenWidth(), 100));
IwGxFontDrawText("Hello World");</pre></div></div><div class="section" title="Text wrapping and justification"><div class="titlepage"><div><div><h3 class="title"><a id="ch06lvl3sec67"/>Text wrapping and justification</h3></div></div></div><p>Wondering why we specified a rectangular area for our text rather than just a screen position? The reason is so that IwGxFont<a id="id828" class="indexterm"/>
<a id="id829" class="indexterm"/>
<a id="id830" class="indexterm"/>
<a id="id831" class="indexterm"/> can wrap and justify our text for us.</p><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="note37"/>Note</h3><p>While Marmalade does allow us to include the line feed character in our code to force a new line in our text, it does not provide support for other formatting characters such as tabs or backspace. It is far better to allow Marmalade to word wrap text for us than to insert line feeds in our text by hand, because if we change the font size or the dimension of the rectangular draw area we won't have to change the text itself in any way.</p></div></div><p>The default behavior when rendering text is to word wrap whenever a line of text exceeds the bounds of the rectangular area set with <code class="literal">IwGxFontSetRect</code>. We can alter this behavior using the<a id="id832" class="indexterm"/> <code class="literal">IwGxFontSetFlags</code> function, which can take a combination of the following values OR'ed together:</p><div class="informaltable"><table border="1"><colgroup><col style="text-align: left"/><col style="text-align: left"/></colgroup><thead><tr><th style="text-align: left" valign="bottom">
<p>Value</p>
</th><th style="text-align: left" valign="bottom">
<p>Definition</p>
</th></tr></thead><tbody><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">IW_GX_FONT_DEFAULT_F     </code>
<a id="id833" class="indexterm"/>
</p>
</td><td style="text-align: left" valign="top">
<p>Uses default font settings.</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">IW_GX_FONT_NOWRAP_F</code>
<a id="id834" class="indexterm"/>
</p>
</td><td style="text-align: left" valign="top">
<p>Does not wrap text at the edge of the rectangle's boundary.</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">IW_GX_FONT_NOWORDWRAP_F</code>
<a id="id835" class="indexterm"/>
</p>
</td><td style="text-align: left" valign="top">
<p>Does not perform full word wrapping on text.</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">IW_GX_FONT_ONELINE_F</code>
<a id="id836" class="indexterm"/>
</p>
</td><td style="text-align: left" valign="top">
<p>Only renders a single line of text. Rendering stops when a newline character (<code class="literal">'\n'</code>) is reached.</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">IW_GX_FONT_NUMBER_ALIGN_F</code>
<a id="id837" class="indexterm"/>
</p>
</td><td style="text-align: left" valign="top">
<p>Forces all numbers to be displayed with the same width.</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">IW_GX_FONT_UNDERLINE_F</code>
<a id="id838" class="indexterm"/>
</p>
</td><td style="text-align: left" valign="top">
<p>Draws the text with underlining.</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">IW_GX_FONT_ITALIC_F</code>
<a id="id839" class="indexterm"/>
</p>
</td><td style="text-align: left" valign="top">
<p>Draws the text in italics.</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">IW_GX_FONT_RIGHTTOLEFT_F</code>
<a id="id840" class="indexterm"/>
</p>
</td><td style="text-align: left" valign="top">
<p>Draws characters from right to left. Useful for drawing languages such as Arabic.</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">IW_GX_FONT_NOWORDSPLIT_F</code>
<a id="id841" class="indexterm"/>
</p>
</td><td style="text-align: left" valign="top">
<p>Wraps text at the end of words. A word can overlap the end of the rectangle boundary, but the next word will start on the next line.</p>
</td></tr></tbody></table></div><p>Flags can be <a id="id842" class="indexterm"/>
<a id="id843" class="indexterm"/>
<a id="id844" class="indexterm"/>
<a id="id845" class="indexterm"/>cleared again using<a id="id846" class="indexterm"/> <code class="literal">IwGxFontClearFlags</code>.</p><p>We can also specify whether text is drawn left aligned, right aligned, or centered in the rectangular bounding area using the function<a id="id847" class="indexterm"/> <code class="literal">IwGxFontSetAlignmentHor</code>, which takes one of the following values:</p><div class="informaltable"><table border="1"><colgroup><col style="text-align: left"/><col style="text-align: left"/></colgroup><thead><tr><th style="text-align: left" valign="bottom">
<p>Value</p>
</th><th style="text-align: left" valign="bottom">
<p>Definition</p>
</th></tr></thead><tbody><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">IW_GX_FONT_ALIGN_LEFT</code>
<a id="id848" class="indexterm"/>
</p>
</td><td style="text-align: left" valign="top">
<p>Aligns text to the left of the bounding box.</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">IW_GX_FONT_ALIGN_CENTRE</code>
<a id="id849" class="indexterm"/>
</p>
</td><td style="text-align: left" valign="top">
<p>Centres text horizontally in the bounding box.</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">IW_GX_FONT_ALIGN_RIGHT</code>
<a id="id850" class="indexterm"/>
</p>
</td><td style="text-align: left" valign="top">
<p>Aligns text to the right edge of the bounding box.</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">IW_GX_FONT_ALIGN_PARAGRAPH</code>
<a id="id851" class="indexterm"/>
</p>
</td><td style="text-align: left" valign="top">
<p>Performs left or right alignment, as defined by the device's localization settings.</p>
</td></tr></tbody></table></div><p>We can do similar alignments vertically as well using <code class="literal">IwGxFontSelAlignmentVer</code> with one of these values:</p><div class="informaltable"><table border="1"><colgroup><col style="text-align: left"/><col style="text-align: left"/></colgroup><thead><tr><th style="text-align: left" valign="bottom">
<p>Value</p>
</th><th style="text-align: left" valign="bottom">
<p>Definition</p>
</th></tr></thead><tbody><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">IW_GX_FONT_ALIGN_TOP</code>
<a id="id852" class="indexterm"/>
</p>
</td><td style="text-align: left" valign="top">
<p>Text is drawn so that the top line of text touches the top of the bounding box.</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">IW_GX_FONT_ALIGN_MIDDLE</code>
<a id="id853" class="indexterm"/>
</p>
</td><td style="text-align: left" valign="top">
<p>Text is centered vertically in the bounding box.</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">IW_GX_FONT_ALIGN_BOTTOM</code>
<a id="id854" class="indexterm"/>
</p>
</td><td style="text-align: left" valign="top">
<p>Text is <a id="id855" class="indexterm"/>
<a id="id856" class="indexterm"/>
<a id="id857" class="indexterm"/>
<a id="id858" class="indexterm"/>drawn so the bottom of the last line of text touches the bottom of the bounding box.</p>
</td></tr></tbody></table></div></div><div class="section" title="Changing font size at runtime"><div class="titlepage"><div><div><h3 class="title"><a id="ch06lvl3sec68"/>Changing font size at runtime</h3></div></div></div><p>Sometimes it is <a id="id859" class="indexterm"/>
<a id="id860" class="indexterm"/>desirable to be able to animate text by making changes in its size. For example, in a shooting game the score awarded for killing an enemy might appear at the position of the enemy then gradually grow larger and fade out.</p><p>The function <code class="literal">IwGxFontSetScale</code> <a id="id861" class="indexterm"/>enables us to do this. It takes two parameters so the font can be scaled by different amounts, both horizontally and vertically. The scaling factors are passed in as fixed point values, with <code class="literal">IW_GEOM_ONE</code> indicating a scaling factor of <code class="literal">1</code> and therefore no change in size.</p><p>IwGxFont draws text by rendering a rectangular polygon for each character in our text, with the relevant part of the font image mapped on to it. By specifying a scaling factor we can change the size of the polygons used to render the individual characters, though this can yield poor results if we scale up by a large factor (for example, more than double the original size <a id="id862" class="indexterm"/>
<a id="id863" class="indexterm"/>of the font).</p></div><div class="section" title="Optimizing drawing by preparing text"><div class="titlepage"><div><div><h3 class="title"><a id="ch06lvl3sec69"/>Optimizing drawing by preparing text</h3></div></div></div><p>One of the problems with rendering text is that in order to perform alignment, word wrapping, and the like, it is necessary to format the text by considering it one character at a time to see if the next character crosses the rectangular bounding box area.</p><p>If we need to <a id="id864" class="indexterm"/>draw a piece of fixed text, such as an instructions screen, we can prevent having to calculate the formatting information in every frame by preparing the text for rendering once and then using some cached data to draw it from then on.</p><p>To do this we use the function<a id="id865" class="indexterm"/> <code class="literal">IwGxFontPrepareText</code>. This function takes a reference to a <code class="literal">CIwGxFontPreparedData</code> class instance, the string of text to prepare, and optionally the number of characters in the string that we want to consider. If this parameter is omitted, the entire string is processed.</p><p>With the text prepared we can then draw it using another version of the<a id="id866" class="indexterm"/> <code class="literal">IwGxFontDrawText</code> function. This version takes a reference to the <code class="literal">CIwGxFontPreparedData</code> instance<a id="id867" class="indexterm"/> and two optional parameters that indicate the first character from the prepared data to draw and the number of characters to draw. Here's a code example:</p><div class="informalexample"><pre class="programlisting">CIwGxFontPreparedData lFontData;
IwGxFontSetRect(CIwRect(100, 100, 200, 100));
IwGxFontPrepareText(lFontData, "This is the text to be prepared!");
IwGxFontDrawText(lFontData);</pre></div><p>Note that the text will be drawn on screen at the position indicated by the formatting rectangle set in the call to <code class="literal">IwGxFontSetRect</code>.</p></div></div></div></div>
<div class="section" title="Implementing user interfaces"><div class="titlepage"><div><div><h1 class="title"><a id="ch06lvl1sec38"/>Implementing user interfaces</h1></div></div></div><p>Every game will <a id="id868" class="indexterm"/>need some kind of user interface, even if it is just a button that can be pressed to start a new game. In this section we will take a look at how a user interface can be implemented for your own game.</p><div class="section" title="The IwUI API"><div class="titlepage"><div><div><h2 class="title"><a id="ch06lvl2sec95"/>The IwUI API</h2></div></div></div><p>The Marmalade SDK ships with an API called<a id="id869" class="indexterm"/> IwUI, which allows us to create user interfaces for our projects consisting of buttons, labels, and other common controls.</p><p>This API is very feature-rich and allows interfaces to be created not just for games, but also for more serious applications. Marmalade used to ship with a tool called the Marmalade Studio UI Builder, but this is sadly no longer a supported part of the SDK. However, it is still possible to access this tool by either installing an older version of Marmalade (one of the v5.2.x releases is probably best) or by downloading its source code from <a class="ulink" href="https://github.com/marmalade/UI-Builder">https://github.com/marmalade/UI-Builder</a>.</p><p>It is also possible to use IwUI without using the UI creation tool by constructing ITX files that describe our interface layouts, by hand. These layout files can end up being quite verbose and therefore hard to maintain, so the Marmalade Studio UI Builder made editing layouts a bit more manageable.</p><p>The <a id="id870" class="indexterm"/>Marmalade documentation states that the reason for dropping the UI Builder from the SDK was to allow a standardized UI markup system to be used that is supported by a number of other third party tools. At the time of writing this book, no further announcement had been made regarding exactly what form this will take.</p><p>There seems no doubt that the IwUI API will remain a part of Marmalade for the foreseeable future. However, we won't be delving any deeper into the API itself in this book as it seems likely that a new UI system will be making its way into Marmalade soon. If you are interested in what IwUI can do, take a look at the Marmalade documentation and the plethora of sample code that ships with the SDK.</p></div><div class="section" title="The IwNUI API"><div class="titlepage"><div><div><h2 class="title"><a id="ch06lvl2sec96"/>The IwNUI API</h2></div></div></div><p>Marmalade provides a <a id="id871" class="indexterm"/>second user interface API called IwNUI. The "N" stands for Native, as this API allows you to construct user interfaces using the standard UI controls for the platform that your application runs on.</p><p>This may sound like a good idea but the main drawback is that it is only supported on iOS and Android. All other platforms will use a default style implemented using the previously mentioned IwUI API.</p><p>At any rate most games tend to implement their own UI that is in keeping with the style of the game, and this normally means we don't want to use standard OS user interface controls, but IwNUI is a good choice if you happen to want to develop a utility or other application type.</p></div><div class="section" title="Implementing our own user interface solution"><div class="titlepage"><div><div><h2 class="title"><a id="ch06lvl2sec97"/>Implementing our own user interface solution</h2></div></div></div><p>Given that we're effectively <a id="id872" class="indexterm"/>starting from square one with our user interface implementation, let's consider how we could go about creating our own solution.</p><p>The following sections highlight some of the issues to be aware of when developing user interface code. One of the example projects accompanying this chapter implements a user interface library <a id="id873" class="indexterm"/>that tries to take most of the following into account.</p><div class="section" title="Using a generic approach"><div class="titlepage"><div><div><h3 class="title"><a id="ch06lvl3sec70"/>Using a generic approach</h3></div></div></div><p>It really is <a id="id874" class="indexterm"/>worth taking the time to develop as generic a solution as possible when dealing with user interface code. While implementing the frontend of a game isn't particularly difficult to code, it is far too easy to find yourself writing UI code from scratch for each project.</p><p>By investing in a generic approach, you can quickly put together a functional UI for all your projects. Frontend menu systems actually tend to be little more than a collection of buttons and labels; so why write this code multiple times? Implement these types of controls once and you can then spend more time creating customized controls when your game demands it.</p><p>It is recommended that you implement your UI code by creating a separate subproject, as this will help ensure that your solution is as generic and self-contained as possible.</p><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="note38"/>Note</h3><p>Marmalade makes it easy for us to create our own library modules by using the same system the SDK uses for including its component parts. Simply create an MKB file referencing all the source files that are part of the library, but save it with the extension <code class="literal">.mkf</code> <a id="id875" class="indexterm"/>instead of<a id="id876" class="indexterm"/> <code class="literal">.mkb</code>. You can then reference this module by adding the name of the MKF file (minus the extension) to the <code class="literal">subprojects</code> section of the main project MKB file. Library module directories should be placed in the same place as the main project directory so that they can be located when creating the project from the MKB file.</p></div></div></div><div class="section" title="Making good use of class inheritance"><div class="titlepage"><div><div><h3 class="title"><a id="ch06lvl3sec71"/>Making good use of class inheritance</h3></div></div></div><p>A good class hierarchy can <a id="id877" class="indexterm"/>
<a id="id878" class="indexterm"/>make implementing your UI a much more pleasant experience and it is well worth taking a look at existing systems to see how they have been constructed.</p><p>Most modern UI implementations will normally start with a base level class from which all other control types are derived, which for discussion purposes in this chapter we will call an <a id="id879" class="indexterm"/>
<span class="strong"><strong>element</strong></span>. An element will take care of things such as the positioning of a control and internal naming so that the handling of UI events can be standardized.</p><p>When implementing a class representing an element, we should make use of virtual methods that can be overridden by child classes to change default behavior. At the very least this normally means that we should have methods that can be called to update and render the control.</p><p>Another extremely useful concept is that of a <a id="id880" class="indexterm"/>
<span class="strong"><strong>frame</strong></span>, which has the ability to group several elements together so they can be moved, enabled, or hidden at the same time.</p><p>When updating <a id="id881" class="indexterm"/>
<a id="id882" class="indexterm"/>or rendering the user interface, the frame is responsible for deciding whether or not to update or render the child elements it contains.</p><p>The positioning and sizing of all elements contained within a frame should also be calculated relative to the position and size of the frame itself.</p><p>Having implemented classes representing both elements and frames, it is possible to implement most common UI controls very simply. Here are a few examples to illustrate this:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">A <span class="strong"><strong>label</strong></span> control<a id="id883" class="indexterm"/> simply displays a line of text on screen. It can be derived from the element class and at its simplest all we need to define are member variables to store the text to be drawn, and some font and color information. We can then override the virtual render method to allow the text to be drawn at the position indicated by the element class.</li><li class="listitem" style="list-style-type: disc">A <span class="strong"><strong>bitmap</strong></span> control <a id="id884" class="indexterm"/>is very similar to a label but displays an image instead of text. We just need to store a pointer to the image we want to draw (perhaps as a <code class="literal">CIwTexture</code> or <code class="literal">CIwMaterial</code> pointer) and then implement the render method to draw it on screen.</li><li class="listitem" style="list-style-type: disc">A <span class="strong"><strong>button</strong></span> control<a id="id885" class="indexterm"/> can be derived from a frame. Most UI systems allow an image or a text string (or both) to be displayed on the button, so we can implement this just by adding label or bitmap controls to the list of elements contained within the frame.</li><li class="listitem" style="list-style-type: disc">A <span class="strong"><strong>slider</strong></span> control<a id="id886" class="indexterm"/> could also use the frame as a basis and could include two bitmap controls, one for the backing of the slider and another for the selection knob. A label could also be included if you want to display the current position of the slider as a numeric value.</li></ul></div><p>Hopefully this gives you an idea of how, with a little initial planning, implementing a diverse range of user interface controls actually becomes very easy.</p></div><div class="section" title="Implementing a data-driven system"><div class="titlepage"><div><div><h3 class="title"><a id="ch06lvl3sec72"/>Implementing a data-driven system</h3></div></div></div><p>With a good class hierarchy<a id="id887" class="indexterm"/>
<a id="id888" class="indexterm"/> in place, the next step is to ensure that your UI can be created easily from a configuration datafile. While it is perfectly possible to create all your controls in code, this is hard to maintain and, most crucially, can then only be edited by a programmer.</p><p>Allowing your UI to be constructed from a datafile means that other members of your team can help with designing the UI. Having a datafile format also makes it easier to develop a user interface layout tool if you want to make the process even easier for people to use.</p><p>We've already seen how we can use the ITX file format to construct our own custom classes from a file at runtime, so it makes sense to employ this methodology to our UI code (refer back to <a class="link" href="ch02.html" title="Chapter 2. Resource Management and 2D Graphics Rendering">Chapter 2</a>, <span class="emphasis"><em>Resource Management and 2D Graphics Rendering</em></span>, if you want to refresh your memory on this). No point in writing more code than we have to!</p></div><div class="section" title="Responding to user input events"><div class="titlepage"><div><div><h3 class="title"><a id="ch06lvl3sec73"/>Responding to user input events</h3></div></div></div><p>The user interface of a<a id="id889" class="indexterm"/> game must solve two main issues. The first is relaying information to the player, and we've already discussed how this can be done earlier. The second is responding to user inputs.</p><p>As discussed earlier in this book, modern mobile devices allow a great many ways of allowing the player to interact with a game. Which of these you support, depends on the devices you are trying to target, but by far the most popular choice is the touch screen. Pressing on-screen buttons is just a very natural way of interacting with a application, so it is pretty much guaranteed you will end up supporting touch screens for your own UI.</p><p>Obviously not all controls need to respond to being touched. For example, a label is unlikely to do anything, so it makes sense to provide some mechanism that allows us to indicate which controls should respond to touches and which shouldn't.</p><p>While we could just add some virtual methods to the element class that gets called whenever a touch has been detected within its bounding area, this is probably not the best solution as it starts to make the element class a little cluttered.</p><p>We really want to encapsulate this sort of functionality somehow, and a good way of doing this is by using an Event system. Such a system works by having a central event manager whose sole job is to receive event messages from one part of the code and pass those messages on to any class instance that has registered itself with the event manager to be notified of a particular event.</p><p>To implement such a system, we can introduce two new base classes. An <a id="id890" class="indexterm"/>Event class, which is the base class for all event message types, and an <code class="literal">EventHandler</code> class, which contains a single virtual method called <code class="literal">Execute</code> <a id="id891" class="indexterm"/>that will be called in order to respond to an Event.</p><p>At its most basic level, the <a id="id892" class="indexterm"/>Event class will just contain a single member that is used as a unique identifier for a particular type of event, for example, an enumerated type. We can declare our own event types by deriving them from an Event and adding members for any information we might want to pass along with the message. For example, a touch screen event might contain the screen coordinates of where the touch occurred.</p><p>Any class that wants to respond to a particular event can then derive from the <code class="literal">EventHandler</code> class <a id="id893" class="indexterm"/>and provide an implementation for the virtual method. When a new instance of a class is constructed, it registers its interest in any event by passing the unique identifier of the event and a pointer to itself (cast as an <code class="literal">EventHandler</code> pointer) to the event handler.</p><p>Now, whenever an event occurs we create an instance of the event type in question, populate its members with information about that event, and pass it to the event manager. The event manager will compare the unique identifier of the event against its list of registered instances and then call the <code class="literal">Execute</code> method<a id="id894" class="indexterm"/> of <code class="literal">EventHandler</code> for any of registered instance that wanted to be notified about the type of event that has just occurred. The event message will be passed into the <code class="literal">Execute</code> method of the instance so that its data can then be acted upon accordingly.</p></div><div class="section" title="Screen resolution and orientation"><div class="titlepage"><div><div><h3 class="title"><a id="ch06lvl3sec74"/>Screen resolution and orientation</h3></div></div></div><p>Chances are that <a id="id895" class="indexterm"/>
<a id="id896" class="indexterm"/>your game could well be executed on a number of different devices that have different screen resolutions and aspect ratios, which can make creating a nice looking user interface a real chore.</p><p>It is therefore important to provide a very flexible way in which the position and size of UI controls can be specified.</p><p>When specifying screen coordinates, widths, and heights for controls, consider allowing both exact pixel sizes and ratios of the width and height of the containing frame to be used.</p><p>It is also good to allow a control to be conformed to a particular aspect ratio when using ratios to define sizes. Being able to ensure that the control has a particular aspect ratio makes it much easier to keep a consistent layout of any child control and is particularly important when drawing bitmapped images that will look strange if they end up stretched. When fixing a control to a particular aspect ratio, you will want to be able to indicate whether the width or the height should change to keep the control in the correct shape.</p><p>Being able to lay out controls relative to each other is also a useful thing to be able to do. One way of doing this is by specifying that a control should take in its position by adding an offset to the position of another control.</p><p>Another thing<a id="id897" class="indexterm"/>
<a id="id898" class="indexterm"/> that can throw a spanner in the works is when the user rotates the device and the screen changes between portrait and landscape orientations. For most games we will want screen orientation changes to be ignored, since most games are designed to either be played in portrait or landscape and not both.</p><p>Ignoring screen orientation changes is made simple by adding the<a id="id899" class="indexterm"/> <code class="literal">DispFixRot</code> setting to the application's ICF file, as follows:</p><div class="informalexample"><pre class="programlisting">[S3E]
DispFixRot=Landscape</pre></div><p>This setting can take the following values:</p><div class="informaltable"><table border="1"><colgroup><col style="text-align: left"/><col style="text-align: left"/></colgroup><thead><tr><th style="text-align: left" valign="bottom">
<p>Value</p>
</th><th style="text-align: left" valign="bottom">
<p>Description</p>
</th></tr></thead><tbody><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">Free</code>
<a id="id900" class="indexterm"/>
</p>
</td><td style="text-align: left" valign="top">
<p>Screen will rotate when the user rotates the device. This is the default value if <code class="literal">DispFixRot</code> is not used.</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">Portrait</code>
<a id="id901" class="indexterm"/>
</p>
</td><td style="text-align: left" valign="top">
<p>Screen will always be kept in portrait aspect but can rotate when the device is held in either of the possible portrait orientations. It is easy to miss the fact that there are two possible portrait orientations since the phone could be held upside down!</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">Landscape</code>
<a id="id902" class="indexterm"/>
</p>
</td><td style="text-align: left" valign="top">
<p>Screen will always be kept in landscape aspect but can rotate when the device is held in either of the possible landscape orientations. Again, note that there are two possible landscape orientations depending on which direction you rotate the phone from its normal portrait position.</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">FixedPortrait</code>
<a id="id903" class="indexterm"/>
</p>
</td><td style="text-align: left" valign="top">
<p>Screen will be fixed in the device's default portrait orientation and will not rotate at all.</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">FixedLandscape</code>
<a id="id904" class="indexterm"/>
</p>
</td><td style="text-align: left" valign="top">
<p>Screen will be fixed in the device's default landscape orientation and will not rotate at all.</p>
</td></tr></tbody></table></div><p>If we do choose to support screen orientation changes, we need some way of detecting when the orientation has changed. We can do this by setting up a callback function as follows:</p><div class="informalexample"><pre class="programlisting">// This is the callback function
int32 OnOrientationChanged(s3eSurfaceOrientation* apOrientation,
void* apUserData)
{
  if (apOrientation-&gt;m_OrientationChanged)
  {
    if (apOrientation-&gt;m_Width &gt; apOrientation-&gt;m_Height)
    {
      // Switch to landscape
    }
    else
    {
      // Switch to portrait
    }
  }
  return 0;
}

// Call this somewhere in our set up code
s3eSurfaceRegister(S3E_SURFACE_SCREENSIZE, (s3eCallback)
   OnOrientationChanged, NULL);</pre></div><p>It is highly <a id="id905" class="indexterm"/>
<a id="id906" class="indexterm"/>recommended, if you are supporting both portrait and landscape in your game, that you define specific layouts of your controls for each orientation and switch between them when the device is rotated. Trying to accommodate both orientations with a single layout is possible but tends to yield uninspiring results in both orientations, so make the most of the available screen space by providing custom layouts for each.</p></div><div class="section" title="Adding template functionality"><div class="titlepage"><div><div><h3 class="title"><a id="ch06lvl3sec75"/>Adding template functionality</h3></div></div></div><p>Consistency is an <a id="id907" class="indexterm"/>
<a id="id908" class="indexterm"/>important part of the user interface design. We expect controls of a similar type to look the same. If they don't, the design starts to look sloppy and unprofessional. It's therefore useful to be able to provide a way of defining certain aspects of our UI once, and <span class="strong"><strong>Template</strong></span> definitions allow us to do just that.</p><p>A relatively easy way of implementing templates is to be able to copy the settings of one UI control into another. We can create a control that will never actually be displayed, but will act as a template for other controls. When creating a new control we can copy all member settings from the template and then proceed to make changes to the settings so that the control displays whatever we need it to.</p><p>One way of implementing this is to add a virtual method to the element class, which is given a pointer to the template control. Each class can override this method to set its member variables based on the values contained in the template. By calling the virtual method in the parent class, we can copy all member variable settings from the template right down to the <a id="id909" class="indexterm"/>
<a id="id910" class="indexterm"/>base element class.</p></div></div></div>
<div class="section" title="Localizing your project"><div class="titlepage"><div><div><h1 class="title"><a id="ch06lvl1sec39"/>Localizing your project</h1></div></div></div><p>As the progress<a id="id911" class="indexterm"/> of technology marches on, the world seems to become a smaller place and your game may well end up being played on devices all across the globe. It's therefore well worth considering localizing your game so that players across the world can experience your game in their own language.</p><p>While supporting <a id="id912" class="indexterm"/>every language known to man would be impractical, many best-selling games now offer support for at least the <span class="strong"><strong>EFIGS</strong></span> languages<a id="id913" class="indexterm"/> (English, French, Italian, German, and Spanish), and you can often add Portuguese, Russian, Polish, Japanese, Korean, and both Simplified and Traditional Chinese to the list as well.</p><p>Supporting other languages other than your own native tongue is well worth it, as players would much rather play a game they can read and understand than one they can't.</p><p>Whether or not you decide to support other languages, there is still a benefit in implementing your game's text in the manner I am about to describe, since it allows you to remove all the text from your source code and put it all in one place, which makes changing the text a much easier process.</p><div class="section" title="Creating a text spreadsheet"><div class="titlepage"><div><div><h2 class="title"><a id="ch06lvl2sec98"/>Creating a text spreadsheet</h2></div></div></div><p>The first step in <a id="id914" class="indexterm"/>
<a id="id915" class="indexterm"/>localizing the text in your game is to use a program such as Microsoft Excel<a id="id916" class="indexterm"/> or OpenOffice Calc<a id="id917" class="indexterm"/> to create a spreadsheet containing all the text for your game. By using a spreadsheet it is very easy to add or insert new strings of text, and the columns of the spreadsheet can be used to provide translations of the strings for each language you want to support. The following screenshot shows an example of such a spreadsheet:</p><div class="mediaobject"><img src="graphics/3363_06_02.jpg" alt="Creating a text spreadsheet"/></div><p>In this spreadsheet the first column is used as a text identifier field. This is just a string of text that we can use in our source code and datafiles to represent a particular string of text.</p><p>The first row is used to <a id="id918" class="indexterm"/>
<a id="id919" class="indexterm"/>indicate which language each column of the spreadsheet represents. In the example, we have used the standard two letter ISO country codes to represent the supported languages, namely English (EN) and French (FR).</p><p>The rest of the spreadsheet is then just the actual text that we want to appear in the game.</p></div><div class="section" title="Getting the text into the game"><div class="titlepage"><div><div><h2 class="title"><a id="ch06lvl2sec99"/>Getting the text into the game</h2></div></div></div><p>With the text for our <a id="id920" class="indexterm"/>game now in a spreadsheet, how do we access it from inside our game code? The answer is to process the spreadsheet into a format that is easy for us to load and use in game code.</p><div class="section" title="Comma-separated values files"><div class="titlepage"><div><div><h3 class="title"><a id="ch06lvl3sec76"/>Comma-separated values files</h3></div></div></div><p>One option would be to export the <a id="id921" class="indexterm"/>
<a id="id922" class="indexterm"/>text as a <span class="strong"><strong>Comma-Separated Values</strong></span> (<span class="strong"><strong>CSV</strong></span>)<a id="id923" class="indexterm"/> file from our spreadsheet program. This is a simple text-only format that outputs each row of the database as a separate line in the file, with the contents of each cell listed separated by commas.</p><p>The trouble with this approach is it can be error-prone. Having a comma in the text of one of your strings can play havoc with the output since the comma is already used to indicate the end of one string and the beginning of the next. This is often gotten around by enclosing each string in quote marks, but then this can cause further problems if a string needs to include a quote mark too!</p><p>Remember also<a id="id924" class="indexterm"/>
<a id="id925" class="indexterm"/> that IwGxFont expects text to be supplied in UTF-8 format by default. If you are supporting languages such as Japanese or Korean, this becomes very important and some spreadsheet programs do not support exporting a CSV File in UTF-8 format.</p></div><div class="section" title="Processing using a Python script"><div class="titlepage"><div><div><h3 class="title"><a id="ch06lvl3sec77"/>Processing using a Python script</h3></div></div></div><p>A much better method of getting the text out of a spreadsheet and into our game is to process the spreadsheet into a simple <a id="id926" class="indexterm"/>
<a id="id927" class="indexterm"/>
<a id="id928" class="indexterm"/>
<a id="id929" class="indexterm"/>datafile, which can be easily loaded into our game. To demonstrate this, we'll be making use of the Python scripting language.</p><p>Python<a id="id930" class="indexterm"/> may have a rather strange approach to code layout (the scoping level of your code is indicated by how much it is indented, rather than using notation such as curly braces to indicate the start and end of a section of code), but there is no denying that it is extremely good at this kind of task.</p><p>You can get hold of an installer for Python from the following URL:</p><p>
<a class="ulink" href="http://www.python.org/download/">http://www.python.org/download/</a>
</p><p>The approach we will be using is to access the data from the text spreadsheet by accessing it directly. If we save the spreadsheet in Excel 97 format (file extension <code class="literal">.xls</code>, supported by most spreadsheet programs), there is an excellent Python library <a id="id931" class="indexterm"/>called <code class="literal">xlrd</code> that can be downloaded here:</p><p>
<a class="ulink" href="http://pypi.python.org/pypi/xlrd/">http://pypi.python.org/pypi/xlrd/</a>
</p><p>Install Python first and then install the <code class="literal">xlrd</code> library. It's a good idea to ensure that the Python executable can be easily found by adding the Python install directory to your path environment variable. An easy way to check if the Python directory is already in your path variable is to open up a command prompt window and enter <code class="literal">path</code> to display the current list of directories that will be searched.</p><p>To illustrate just how simple accessing data from a spreadsheet file is, using Python and xlrd, the following script will open a spreadsheet file and output all the rows and columns it contains:</p><div class="informalexample"><pre class="programlisting">import xlrd

lXLS = xlrd.open_workbook("StringList.xls")
lSheet = lXLS.sheet_by_index(0)
for lRow in range(lSheet.nrows):
  lCells = lSheet.row_values(lRow, 0, lSheet.ncols)
  print lCells</pre></div><p>Even if you've never set eyes on a Python script before, this should be fairly easy to follow, but here's a brief <a id="id932" class="indexterm"/>
<a id="id933" class="indexterm"/>
<a id="id934" class="indexterm"/>
<a id="id935" class="indexterm"/>explanation.</p><p>The <code class="literal">import xlrd</code> line is equivalent to the <code class="literal">#include</code> directive in C/C++. It's just stating that we want to make use of the <code class="literal">xlrd</code> library.</p><p>Next we open the spreadsheet file by calling the <code class="literal">xlrd.open_workbook</code> method, passing in the filename of the spreadsheet we want to use. This returns an instance of a Python class defined by <code class="literal">xlrd</code> that represents the spreadsheet file. Note that Python is a loosely typed language and there is no need to declare what type the variable must be.</p><p>We call the <code class="literal">sheet_by_index</code> method<a id="id936" class="indexterm"/> on the spreadsheet object to retrieve the first worksheet from the spreadsheet. This yields another Python object representing the worksheet.</p><p>We then enter a <code class="literal">for</code> loop<a id="id937" class="indexterm"/> that causes the <code class="literal">lRow</code> variable<a id="id938" class="indexterm"/> to iterate between <code class="literal">0</code> and the number of populated rows in the spreadsheet. Within the loop we use the worksheet object to access the spreadsheet cells an entire row at a time using the<a id="id939" class="indexterm"/> <code class="literal">row_values</code> method.</p><p>Python has a built-in list type and this is what is being used to access all the cells on the row in one go. The <code class="literal">lCells</code> variable<a id="id940" class="indexterm"/> will contain a list whose elements are each cell in the row.</p><p>Finally we use the Python <code class="literal">print</code> command<a id="id941" class="indexterm"/> to display the entire list to standard output. You can use <code class="literal">print</code> in Python to display just about any type, including lists, in a human-readable form.</p><p>The UI example project that accompanies this chapter includes a Python script that will take a spreadsheet as input and convert it into a simple datafile for each language contained in the spreadsheet.</p><p>The datafiles list the number of strings in the file followed by a hash value generated from the text identifier field (the first column of the spreadsheet) and the string itself. It is fairly trivial to write C++ code to load this file into memory.</p><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="note39"/>Note</h3><p>The use of a hashing function<a id="id942" class="indexterm"/> here means it is possible for two strings to end up with the same hash value, causing a collision in the string table that means the wrong string may get returned. In practice a good hashing function will mean this hardly ever happens, but if you start getting the wrong string returned this might be the cause. The easiest way to rectify such a problem is just to rename one of the text identifiers in the collision!</p></div></div><p>To access a particular text string, we use the identifier field in our code. A hash value is generated from the identifier field and the list of string data is searched for that hash value. If a match is found, the corresponding text string is returned, otherwise an assert can be raised and a default string of text returned. The default text can be something like "Missing String!", which makes it easier to track down problems such as getting the identifier field <a id="id943" class="indexterm"/>
<a id="id944" class="indexterm"/>
<a id="id945" class="indexterm"/>
<a id="id946" class="indexterm"/>wrong in code, or the string just not being present in the text datafile when it should be.</p></div><div class="section" title="Selecting the correct language to use at runtime"><div class="titlepage"><div><div><h3 class="title"><a id="ch06lvl3sec78"/>Selecting the correct language to use at runtime</h3></div></div></div><p>We now have <a id="id947" class="indexterm"/>the ability to supply our game with strings of text in multiple languages, but how do we decide which of those languages to actually use? One method of course is to implement a language select screen during startup of our game and then load the relevant string table depending on the user's input. However, there is a much nicer way available to us.</p><p>The s3eDevice API allows us to find out which language is currently in use on the device we are running on. Simply insert the following line of code during the startup portion of your game code:</p><div class="informalexample"><pre class="programlisting">int32 lLanguage = s3eDeviceGetInt(S3E_DEVICE_LANGUAGE);</pre></div><p>The return value will be a member of the <code class="literal">s3eDeviceLanguage</code> enumeration, for example <code class="literal">S3E_DEVICE_LANGUAGE_ENGLISH</code> or <code class="literal">S3E_DEVICE_LANGUAGE_GERMAN</code>. A full list of all possible language codes can be found in <code class="literal">s3eDevice.h</code>.</p><p>With the language type determined by this call, we can then load the correct table of strings and the user will magically get to see your game in their own language, assuming you've supported it of course!</p></div></div></div>
<div class="section" title="Example code"><div class="titlepage"><div><div><h1 class="title"><a id="ch06lvl1sec40"/>Example code</h1></div></div></div><p>There are three example projects associated with this chapter, which are described in the following sections.</p><div class="section" title="The Font project"><div class="titlepage"><div><div><h2 class="title"><a id="ch06lvl2sec100"/>The Font project</h2></div></div></div><p>The first example project <a id="id948" class="indexterm"/>demonstrates the use of the IwGxFont API and can be seen in the following screenshot. This example demonstrates how to use multiple fonts in a project, preparing <a id="id949" class="indexterm"/>text for printing, and scaling a font up and down in size:</p><div class="mediaobject"><img src="graphics/3363_06_03.jpg" alt="The Font project"/></div></div><div class="section" title="The UI project"><div class="titlepage"><div><div><h2 class="title"><a id="ch06lvl2sec101"/>The UI project</h2></div></div></div><p>The <a id="id950" class="indexterm"/>UI example implements a user interface library that adheres to the discussion on how to implement UI code presented earlier in this chapter. It also presents a fully functional localization library, including a Python script that can convert an XLS spreadsheet into separate language datafiles. The script also produces a file for each language detailing all the characters that were used by any of the strings for that language. This can be very useful when generating a font resource to display the text.</p><p>The UI and localization library have been implemented as Marmalade subprojects (called GUI and <code class="literal">Localise</code>), which makes them very easy to re-use in other projects. If you find either of them useful, feel free to make use of them in your own projects.</p><p>The text strings are contained in an XLS file contained in the <code class="literal">data/text</code> directory. English and French strings have been included, though apologies to any French-speaking readers if these strings are not a 100 percent correct, as they were generated using an online translation engine</p><p>In the <a id="id951" class="indexterm"/>Windows Simulator it is possible to see the program running using both of the supplied language files. With the application running, go to <span class="strong"><strong>Configuration</strong></span> | <span class="strong"><strong>Device…</strong></span>. In the dialog that appears, there is a drop-down box labeled <span class="strong"><strong>Reported Device Language</strong></span>. Choose <span class="strong"><strong>ENGLISH</strong></span> or <span class="strong"><strong>FRENCH</strong></span> in this list and then click on the <span class="strong"><strong>OK</strong></span> button. Quit the program and run it again and the selected language will be used.</p><p>A screenshot of this sample in action is as follows:</p><div class="mediaobject"><img src="graphics/3363_06_04.jpg" alt="The UI project"/></div></div><div class="section" title="The Skiing project"><div class="titlepage"><div><div><h2 class="title"><a id="ch06lvl2sec102"/>The Skiing project</h2></div></div></div><p>Finally <a id="id952" class="indexterm"/>we come to our evolving <span class="strong"><strong>Skiing!</strong></span> game, which now has a simple yet much nicer looking user interface thanks to the GUI and <code class="literal">Localise</code> modules created for the UI example. The following screenshot shows the new main menu screen:</p><div class="mediaobject"><img src="graphics/3363_06_05.jpg" alt="The Skiing project"/></div></div></div>
<div class="section" title="Summary"><div class="titlepage"><div><div><h1 class="title"><a id="ch06lvl1sec41"/>Summary</h1></div></div></div><p>In this chapter we've seen how we can add fonts of any style and size to our projects using the IwGxFont API. We also learnt how to use the Marmalade Studio Font Builder to convert TrueType fonts into bitmapped fonts that can be loaded by IwGxFont.</p><p>We also discussed how to implement our own user interface library and how we can localize our game by adding support for more than one language.</p><p>In the next chapter we'll be looking at how we can stop our games from being silent affairs with the addition of sound effects and music. We'll also be taking a brief look at how to add a video file playback.</p></div></body></html>