<html><head></head><body><div class="chapter" title="Chapter&#xA0;7.&#xA0;Making your Applications Run Smoothly using Instruments"><div class="titlepage"><div><div><h1 class="title"><a id="ch07"/>Chapter 7. Making your Applications Run Smoothly using Instruments</h1></div></div></div><p>Well done for making it to the final chapter of this book. In this chapter, we will focus on how we can effectively use<span class="strong"><strong> Instruments</strong></span> within our applications to track down areas within our iOS applications that could be affecting the overall performance.<a id="id335" class="indexterm"/>
</p><p>These types of issues could potentially cause our applications to run slowly or even crash on the user's iOS device. We will take a look into each of the different types of built-in instruments, which come as a part of the Instruments application, and how we can use the<span class="strong"><strong> System Trace</strong></span> for iOS instruments to help you track down system calls, memory, and threads within your code that may be affecting the application's performance on your iOS applications.<a id="id336" class="indexterm"/>
</p><p>We then take a look at how we can configure instruments to display data differently within the trace document that is being reported.</p><p>In this chapter, we will be covering the following topics:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">Introducing the Instruments environment</li><li class="listitem" style="list-style-type: disc">Learning how to add and profile against different instrument sets</li><li class="listitem" style="list-style-type: disc">Learning how to check performance of your iOS applications</li><li class="listitem" style="list-style-type: disc">Introducing other components of the Instruments family</li><li class="listitem" style="list-style-type: disc">Introducing the new Instruments included with Xcode 4.2</li></ul></div><p>We have got quite a bit to cover. So, let's get started.</p><div class="section" title="Introduction to Instruments"><div class="titlepage"><div><div><h1 class="title"><a id="ch07lvl1sec01"/>Introduction to Instruments</h1></div></div></div><p>The Instruments application is a powerful tool that enables you to collect information about the performance of your application over time. Through the use of the Instruments application, you can gather information based on a variety of different types of data, and view them side-by-side at the same time. This will therefore allow you to spot trends which would be hard to spot otherwise, and this can be used to see code running by your program along with the corresponding memory usage.<a id="id337" class="indexterm"/>
</p><p>The Instruments application comes with a standard library, which you can use to examine various aspects of your code. You can configure Instruments to gather data about the same process or about different processes on the system.<a id="id338" class="indexterm"/>
</p><p>Each instrument collects and displays different types of information relating to file access, memory usage, Network connections, and so on. The following screenshot shows the Instruments application profiling our<code class="literal"> MapKitExample</code>, using a number of different types of instruments to monitor the system behavior:</p><div class="mediaobject"><img src="graphics/2267_07_01.jpg" alt="Introduction to Instruments"/></div><p>The following information in the table outlines each feature of the Instruments application, and provides a description about what each part covers:</p><div class="informaltable"><table border="1"><colgroup><col style="text-align: left"/><col style="text-align: left"/></colgroup><thead><tr><th style="text-align: left" valign="bottom">
<p><span class="strong"><strong>Instruments feature</strong></span></p>
</th><th style="text-align: left" valign="bottom">
<p><span class="strong"><strong>Description</strong></span></p>
</th></tr></thead><tbody><tr><td style="text-align: left" valign="top">
<p>Instruments Pane</p>
</td><td style="text-align: left" valign="top">
<p>This section lists all of the instruments, which have been added for those that you want to profile against. New instruments can be added by selecting and then dragging each one from the instruments library into this pane. Items within this pane can also be deleted.</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>Track Pane</p>
</td><td style="text-align: left" valign="top">
<p>This section displays a graphical summary of the data returned by the current instruments. Each instrument has its own track, which provides a chart of the data that is collected by that instrument. The information within this pane is read-only.</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>Detail Pane</p>
</td><td style="text-align: left" valign="top">
<p>This section shows the details of the data collected by each of the instruments. It displays the set of events gathered and used to create the graphical view in the track pane. Depending on the type of instrument, information that is represented within this pane can be customized to represent the data differently.</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>Extended Detail Pane</p>
</td><td style="text-align: left" valign="top">
<p>This section shows you detailed information about the item that is currently selected in the Detail pane. This pane displays the complete stack trace, timestamp, and other instrument-specific data gathered for the given event.</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>Navigation Bar</p>
</td><td style="text-align: left" valign="top">
<p>This shows you where you are, and the steps you took to get there. It includes two menus the active instrument menu and the detail view menu. You can click on the entries within the navigation bar to select the active instrument, and the level and type of information in the detail view.</p>
</td></tr></tbody></table></div><p>The Instruments trace document toolbar allows you to add and control instruments, open view, and configure the track pane.<a id="id339" class="indexterm"/>
</p><div class="mediaobject"><img src="graphics/2267_07_02.jpg" alt="Introduction to Instruments"/></div><p>The following table provides an explanation for each of the different controls on the toolbar:</p><div class="informaltable"><table border="1"><colgroup><col style="text-align: left"/><col style="text-align: left"/></colgroup><thead><tr><th style="text-align: left" valign="bottom">
<p><span class="strong"><strong>Toolbar item</strong></span></p>
</th><th style="text-align: left" valign="bottom">
<p><span class="strong"><strong>Description</strong></span></p>
</th></tr></thead><tbody><tr><td style="text-align: left" valign="top">
<p>
<span class="strong"><strong>Pause/Resume</strong></span> button</p>
</td><td style="text-align: left" valign="top">
<p>Pauses the gathering of trace data during a recording. Selecting this option does not actually stop the recording; it just simply stops the instruments from gathering data while a recording is in progress. When the<span class="strong"><strong> Pause</strong></span> button has been pressed, in the track pane it will show a gap in the trace data to highlight this.</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<span class="strong"><strong>Record/Stop</strong></span> button</p>
</td><td style="text-align: left" valign="top">
<p>Starts or stops the recording process. You use this button to begin gathering trace data for your application.</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<span class="strong"><strong>Loop</strong></span> button</p>
</td><td style="text-align: left" valign="top">
<p>Enables you to set whether the recorder should loop during playback, to repeat the recorded steps continuously. This can be useful if you want to gather multiple runs for a given set of steps.</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<span class="strong"><strong>Target</strong></span> menu</p>
</td><td style="text-align: left" valign="top">
<p>Selects the trace target for the document. This is the process for which data is gathered.</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<span class="strong"><strong>Inspection Range</strong></span> control</p>
</td><td style="text-align: left" valign="top">
<p>This enables you to select a time range in the track pane. When this has been set, the instrument displays only the data collected within the specified time period. Using the buttons with this control enable you to set the start and end points of the inspection range, and to clear the current range.</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<span class="strong"><strong>Time/Run</strong></span> control</p>
</td><td style="text-align: left" valign="top">
<p>Shows the time elapsed by the current document trace. If the trace document contains multiple data runs associated with it, you can use the arrow controls to choose which run data you want to display in the track pane.</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<span class="strong"><strong>View</strong></span> control</p>
</td><td style="text-align: left" valign="top">
<p>Hides or shows the Instruments pane, Detail pane, and Extended View pane. This control makes it easier to only focus on the area in which you are interested in.</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<span class="strong"><strong>Library</strong></span> button</p>
</td><td style="text-align: left" valign="top">
<p>Hides or shows the instrument library window.</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<span class="strong"><strong>Search</strong></span> field</p>
</td><td style="text-align: left" valign="top">
<p>This option filters information within the Detail pane, based on a search term that you enter.</p>
</td></tr></tbody></table></div><p>The Instruments application comes part of the Xcode 4 Tools installation, and can be found located within the<code class="literal">&lt;Root&gt;/Developer/Applications</code> folder, where<code class="literal">&lt;Root&gt;</code> is the installation folder where Xcode 4 is installed on your system.</p><div class="section" title="Tracing iOS applications"><div class="titlepage"><div><div><h2 class="title"><a id="ch07lvl2sec01"/>Tracing iOS applications</h2></div></div></div><p>One common use for Instruments is the performance of a system trace on your application. This nifty new Instrument, which has been added to the release of Xcode 4.2, helps you track down system calls, memory, and threads which may be affecting application performance on your iOS applications.<a id="id340" class="indexterm"/>
</p><p>To show the use of the System Trace for iOS Instruments, we will use the<code class="literal"> MapKitExample</code> that we created back in<a class="link" href="ch06.html" title="Chapter 6. Xcode Tools - Improvements"> Chapter 6</a>,<span class="emphasis"><em> Xcode Tools Improvements</em></span>. There are many ways in which you can start the instruments application; you can run Instruments and then have it launch the iOS application, or you can use the tools under the<span class="strong"><strong> Product</strong></span> menu from within Xcode. The next section shows you how to run and profilie<code class="literal"> theMapKitExample</code> application project.<a id="id341" class="indexterm"/>
</p></div><div class="section" title="Loading the MapKitExample project"><div class="titlepage"><div><div><h2 class="title"><a id="ch07lvl2sec02"/>Loading the MapKitExample project</h2></div></div></div><p>Before we proceed to profile our<code class="literal"> MapKitExample</code> project, we must first launch the Xcode development environment. This can be located in the<code class="literal"> /Xcode4/Applications</code> folder. Alternatively, you can use spotlight to search for Xcode, by typing Xcode into the search box window.<a id="id342" class="indexterm"/>
</p><div class="orderedlist"><ol class="orderedlist"><li class="listitem"> Choose<span class="strong"><strong> File | Open</strong></span> or<span class="emphasis"><em> Command</em></span> +<span class="emphasis"><em> O</em></span>.<a id="id343" class="indexterm"/></li><li class="listitem"> Double-click into the<span class="strong"><strong> MapKitExample</strong></span> folder, and select the<span class="strong"><strong> MapKitExample.xcodeproj</strong></span> file.<div class="mediaobject"><img src="graphics/2267_07_03.jpg" alt="Loading the MapKitExample project"/></div></li><li class="listitem"> Click on the<span class="strong"><strong> Open</strong></span> button to continue to load and open the file into the Xcode workspace environment.<a id="id344" class="indexterm"/></li></ol></div><p>We now need to start running and profiling our application, which will be used to perform a system trace on what threads and systems calls are being processed.<a id="id345" class="indexterm"/>
</p><div class="section" title="Running and profiling the project"><div class="titlepage"><div><div><h3 class="title"><a id="ch07lvl3sec01"/>Running and profiling the project</h3></div></div></div><p>To run the Instruments application from within the Xcode environment, select the<span class="strong"><strong> Build For Profiling</strong></span> option under the<span class="strong"><strong> Build For</strong></span> menu, or by using the keyboard shortcut<span class="emphasis"><em> Shift</em></span> +<span class="emphasis"><em> Command</em></span> +<span class="emphasis"><em> I</em></span>, and then select the<span class="strong"><strong> Profile</strong></span> option from the<span class="strong"><strong> Product</strong></span> menu to launch the Instruments application. Similarly, you can use the keyboard shortcut<span class="emphasis"><em> Command</em></span> +<span class="emphasis"><em> I.</em></span>
<a id="id346" class="indexterm"/>
</p><div class="mediaobject"><img src="graphics/2267_07_04.jpg" alt="Running and profiling the project"/></div><p>Once this option has been selected, you will eventually see the Instruments application window display on your screen. This is shown in the following screenshot:</p><div class="mediaobject"><img src="graphics/2267_07_05.jpg" alt="Running and profiling the project"/></div><p>The following table gives an overview of each of the templates available, and required for iOS development:<a id="id347" class="indexterm"/>
</p><div class="informaltable"><table border="1"><colgroup><col style="text-align: left"/><col style="text-align: left"/></colgroup><thead><tr><th style="text-align: left" valign="bottom">
<p><span class="strong"><strong>Template</strong></span></p>
</th><th style="text-align: left" valign="bottom">
<p><span class="strong"><strong>Description</strong></span></p>
</th></tr></thead><tbody><tr><td style="text-align: left" valign="top">
<p>
<span class="strong"><strong>Blank</strong></span>
</p>
</td><td style="text-align: left" valign="top">
<p>Creates an empty trace document to which you can add your own combinations of instruments.</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<span class="strong"><strong>Time Profiler</strong></span>
</p>
</td><td style="text-align: left" valign="top">
<p>Performs low-overhead and time-based sampling of one or all processes.</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<span class="strong"><strong>System Trace</strong></span>
</p>
</td><td style="text-align: left" valign="top">
<p>Provides you with the ability to profile against different aspects of the operating system which could be affecting application performance.</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<span class="strong"><strong>Activity Monitor</strong></span>
</p>
</td><td style="text-align: left" valign="top">
<p>This monitors overall CPU, memory, disk, and network activity.</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<span class="strong"><strong>Automation</strong></span>
</p>
</td><td style="text-align: left" valign="top">
<p>Automates user interface tests within your application.</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<span class="strong"><strong>Energy Diagnostics</strong></span>
</p>
</td><td style="text-align: left" valign="top">
<p>Displays diagnostics information regarding the amount of energy being used on the device for GPU activity, display brightness, sleep/wake, bluetooth, Wi-Fi, and GPS.</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<span class="strong"><strong>Network Connections</strong></span>
</p>
</td><td style="text-align: left" valign="top">
<p>With this instrument, it's possible to see how much data is flowing over each connection, for each application, as well as interesting statistics, such as round trip times and retransmission requests. You can use this information to help reduce network traffic and energy consumption.</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<span class="strong"><strong>Allocations</strong></span>
</p>
</td><td style="text-align: left" valign="top">
<p>Monitors memory and object-allocation patterns within your program.</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<span class="strong"><strong>Leaks</strong></span>
</p>
</td><td style="text-align: left" valign="top">
<p>Detects memory leaks within your application.</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<span class="strong"><strong>Threads</strong></span>
</p>
</td><td style="text-align: left" valign="top">
<p>Analyzes thread state transitions within a process, including running and terminated threads, thread state, and associated back traces.</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<span class="strong"><strong>File Activity</strong></span>
</p>
</td><td style="text-align: left" valign="top">
<p>Monitors an application's interaction with the file system.</p>
</td></tr></tbody></table></div><p>The type of instrument that we want to use for this example is the<span class="strong"><strong> System Trace Instrument</strong></span>. Select the<span class="strong"><strong> System Trace</strong></span> option and then click on the<span class="strong"><strong> Profile</strong></span> button to proceed to load the<span class="strong"><strong> Instruments Trace Document</strong></span> window, and start profiling our<code class="literal"> MapKitExample</code> application.<a id="id348" class="indexterm"/>
</p><p>Your application will then be analyzed, and each system call and thread that has been made to memory will be profiled. These also include<span class="strong"><strong> Virtual Memory</strong></span> (<span class="strong"><strong>VM</strong></span>) operations.<a id="id349" class="indexterm"/>
</p><div class="mediaobject"><img src="graphics/2267_07_06.jpg" alt="Running and profiling the project"/></div><p>You will notice that after a number of seconds have passed, your trace information is displayed. This contains information relating to the thread and system calls, and their duration that your application is currently making. Other information, such as Virtual VM faults, is also recorded.</p><p>You can choose to stop the application from profiling by clicking on the red record button, since the Instruments application has already done its full analysis.<a id="id350" class="indexterm"/>
</p><p>The following list items shows the comparison between the various different types of faults you will encounter while developing iOS applications, along with their explanations.</p></div></div><div class="section" title="VM faults"><div class="titlepage"><div><div><h2 class="title"><a id="ch07lvl2sec03"/>VM faults</h2></div></div></div><p>
<span class="strong"><strong>Virtual memory</strong></span> (VM) is an auxiliary storage that is located on a computer's hard disk that the operating system uses when the<span class="strong"><strong> Random Access Memory</strong></span> (RAM) is full. It used for all normal computer applications. Many computers do not have their virtual memory set properly, and as a result, are not getting maximum performance, resulting in a system fault.<a id="id351" class="indexterm"/>
</p></div><div class="section" title="Memory leaks"><div class="titlepage"><div><div><h2 class="title"><a id="ch07lvl2sec04"/>Memory leaks</h2></div></div></div><p>A<span class="strong"><strong> memory leak</strong></span> occurs when memory is allocated by an application, but never released.<a id="id352" class="indexterm"/>
</p><p>Let's take a closer look at the following example:</p><div class="informalexample"><pre class="programlisting">for (int i = 1; I &lt;= 500; i++) {
NSString *MemStatus = [[NSString alloc]
initWithFomat:@"Memory allocating…"];
}
</pre></div><p>In this code snippet, we allocate<code class="literal"> 500</code> strings inside a loop to demonstrate ways in which memory leaks can happen. The code allocates memory for each new string<code class="literal"> MemStatus</code> each time it goes through the loop, and lets the pointer to each string that gets allocated go out of scope. As you can see, the memory that gets allocated never gets released, causing your application to run slowly, and even potentially causing it to crash or simply hang.</p></div><div class="section" title="Run-time errors"><div class="titlepage"><div><div><h2 class="title"><a id="ch07lvl2sec05"/>Run-time errors</h2></div></div></div><p>These types of errors cause your application to stop executing. It can be caused by an unhandled exception due to an<span class="emphasis"><em> out of memory</em></span> issue, or<span class="emphasis"><em> you are writing some data out to a database</em></span>, or<span class="emphasis"><em> you may have exceeded the maximum allowable size that a field can handle</em></span>.<a id="id353" class="indexterm"/>
</p></div><div class="section" title="Compile-time errors"><div class="titlepage"><div><div><h2 class="title"><a id="ch07lvl2sec06"/>Compile-time errors</h2></div></div></div><p>These types of errors are the most obvious, simply because your program will not compile (and therefore won't run) until all of them are fixed. Generally, these come from typographical errors.<a id="id354" class="indexterm"/>
</p><p>The Objective-C compile in Xcode is case-sensitive, which means that<code class="literal"> UIcolor</code> and<code class="literal"> UIColor</code> are treated differently. For example, in Objective-C, the compiler can understand the following:</p><div class="informalexample"><pre class="programlisting">self.view.backgroundColor = [UIColor blueColor];
</pre></div><p>But if you type in:</p><div class="informalexample"><pre class="programlisting">self.view.backgroundColor = [UIColor bluecolor];
</pre></div><p>The compiler will call it a compile-time error, because you've specified a language-specific (syntax) that it can't recognize.</p><p>The<span class="strong"><strong> Trace Highlights</strong></span> section of the Instruments window shows a set of useful graphs, based on the information that has been profiled. It contains graphs that show the overall usage used by the system, as well as the number of Threads and System calls, and VM calls.<a id="id355" class="indexterm"/>
</p><p>Each of the colors within this view indicates information related to each of the different tracks, and to which library each method belongs. Single-clicking on any of the charts will take you into a summary view, showing an overall break-down into each section, including call stack views, duration, and so on.</p><div class="mediaobject"><img src="graphics/2267_07_07.jpg" alt="Compile-time errors"/></div><p>There is also the ability to change and have each of the chart colors displayed in a different color. This can be done by clicking on the<span class="strong"><strong> Scheduling</strong></span> button icon, as shown in this screenshot.<a id="id356" class="indexterm"/>
</p><p>To change any of the colors, click on each color from the pop-up list. This will display the color wheel to the left of the instruments window, where you can change the corresponding color value within the color wheel provided.<a id="id357" class="indexterm"/>
</p><div class="mediaobject"><img src="graphics/2267_07_08.jpg" alt="Compile-time errors"/></div><p>In this section, we looked at how to go about running and profiling an existing project using the Instruments application to help track-down issues with performance within our application, by using the System Trace for iOS instrument.</p><p>We looked at the different views available within the Instruments application, and how to represent the trace document results as a color-coded graph through the Trace Highlights view, to indicate which section each method belongs to.</p></div></div></div>
<div class="section" title="Adding and configuring Instruments"><div class="titlepage"><div><div><h1 class="title"><a id="ch07lvl1sec02"/>Adding and configuring Instruments</h1></div></div></div><p>The Instruments application comes with a wide-range of built-in instruments to make your job easier, by using them to gather data from one or more processes. Most of these instruments require little configuration to use, and are simply added to your trace document to start gathering trace data. We will look at how we add and configure instruments into an existing trace document.<a id="id358" class="indexterm"/>
</p><div class="section" title="Using the Instruments library"><div class="titlepage"><div><div><h2 class="title"><a id="ch07lvl2sec07"/>Using the Instruments library</h2></div></div></div><p>The Instruments library displays all the instruments that you can use and add to your trace document. The library contains all of the built-in instruments that come with the installation of Xcode 4, as well as any custom instruments that you have already created.<a id="id359" class="indexterm"/>
</p><p>To open the<span class="strong"><strong> Instruments</strong></span> window, click on the<span class="strong"><strong> Library</strong></span> button from within your trace document window or choose<span class="strong"><strong> Window | Library</strong></span> from the menu bar. Alternatively, you can use the<span class="emphasis"><em> Command</em></span> +<span class="emphasis"><em> L</em></span> keyboard shortcut.<a id="id360" class="indexterm"/>
</p><div class="mediaobject"><img src="graphics/2267_07_09.jpg" alt="Using the Instruments library"/></div><p>As you can see from this screenshot, the Instruments<span class="strong"><strong> Library</strong></span> list contains a massive number of instruments, which can grow over time especially when you start adding your own custom-built instruments.<a id="id361" class="indexterm"/>
</p><p>The library list provides several options for organizing and finding the instrument that you are looking for, by using the different view modes.<span class="strong"><strong> View modes</strong></span> help you to decide the amount of information that should be displayed at any one time, and the amount of space you want that instrument group to occupy.<a id="id362" class="indexterm"/>
</p><p>In the following table, we describe the view modes supported by the Instruments<span class="strong"><strong> Library</strong></span>.</p><div class="informaltable"><table border="1"><colgroup><col style="text-align: left"/><col style="text-align: left"/></colgroup><thead><tr><th style="text-align: left" valign="bottom">
<p><span class="strong"><strong>View mode types</strong></span></p>
</th><th style="text-align: left" valign="bottom">
<p><span class="strong"><strong>Description</strong></span></p>
</th></tr></thead><tbody><tr><td style="text-align: left" valign="top">
<p>
<span class="strong"><strong>View Icons</strong></span>
</p>
</td><td style="text-align: left" valign="top">
<p>This setting displays only the icon representing each instrument</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<span class="strong"><strong>View Icons And Labels</strong></span>
</p>
</td><td style="text-align: left" valign="top">
<p>This setting displays the icon with the name of the instrument</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<span class="strong"><strong>View Icons And Descriptions</strong></span>
</p>
</td><td style="text-align: left" valign="top">
<p>This setting displays the icon, name, and full description of each of the instruments</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<span class="strong"><strong>View Small Icons And Labels</strong></span>
</p>
</td><td style="text-align: left" valign="top">
<p>This setting displays the name of the instrument, with a small version of its icon</p>
</td></tr></tbody></table></div><p>In addition to setting the view mode of the Instruments<span class="strong"><strong> Library</strong></span>, instruments can be organized into groups, which makes it easier to identify which instrument relates to which group. This is shown in the previous screenshot.</p></div><div class="section" title="Locating an Instrument within the Library"><div class="titlepage"><div><div><h2 class="title"><a id="ch07lvl2sec08"/>Locating an Instrument within the Library</h2></div></div></div><p>There are two ways to locate an instrument within the Instrument<span class="strong"><strong> Library</strong></span>. One common way is to use the group selection criteria controls, which is located at the top of the<span class="strong"><strong> Library</strong></span> window, and can be used to select one or more groups to limit the amount of instruments that are displayed within the<span class="strong"><strong> Library</strong></span> window.<a id="id363" class="indexterm"/>
</p><p>If you drag the split bar between the pop-up menu and the instrument pane downwards, you will notice that the pop-up menu changes from a single selection to an outline view, so that you can select multiple groups, by holding down the<span class="emphasis"><em> Command</em></span> key combinations, and then selecting the desired groups to display with your mouse, as shown in the following screenshot:<a id="id364" class="indexterm"/>
</p><div class="mediaobject"><img src="graphics/2267_07_10.jpg" alt="Locating an Instrument within the Library"/></div><p>Another way to filter the contents of the Instruments<span class="strong"><strong> Library</strong></span> window is to use the<span class="strong"><strong> Search</strong></span> field, which is located at the bottom of the<span class="strong"><strong> Library</strong></span> window. By using this<span class="strong"><strong> Search</strong></span> field, you can quickly narrow-down and display only those instruments that have the search keyword within their name, description, category, list, or keywords.<a id="id365" class="indexterm"/>
</p><p>In the following screenshot, all instruments that contain the search string<code class="literal"> file</code> are displayed.<a id="id366" class="indexterm"/>
</p><div class="mediaobject"><img src="graphics/2267_07_11.jpg" alt="Locating an Instrument within the Library"/></div></div><div class="section" title="Adding and removing instruments"><div class="titlepage"><div><div><h2 class="title"><a id="ch07lvl2sec09"/>Adding and removing instruments</h2></div></div></div><p>There will be times when you want to trace your application against other instruments within the Instruments<span class="strong"><strong> library</strong></span>. This could be because you want to check to see how your application is performing on the device, and how much battery is being consumed by your application.<a id="id367" class="indexterm"/>
</p><p>You can add as many instruments to your trace document as you wish, but be aware that not all instruments included in the library are capable of tracking a wide-range of system processes; you will find that some can only track a single process. To get around this, you can add multiple instances of the instrument, and assign each one to a different process. By doing it this way, you gather similar information for multiple programs running simultaneously.</p><p>To add an instrument to the trace document, select the instrument from the Instrument<span class="strong"><strong> Library</strong></span>, and then drag it either to the<span class="strong"><strong> Instruments</strong></span> pane or directly onto the track pane of your trace document, as shown in the following screenshot:<a id="id368" class="indexterm"/>
</p><div class="mediaobject"><img src="graphics/2267_07_12.jpg" alt="Adding and removing instruments"/></div><p>To remove an instrument from the trace document, select the instrument that you would like to remove from the<span class="strong"><strong> Instruments</strong></span> pane, and then press the<span class="emphasis"><em> Delete</em></span> key on your keyboard. You will then receive a confirmation message. Click on the<span class="strong"><strong> OK</strong></span> button to proceed.<a id="id369" class="indexterm"/>
</p><div class="mediaobject"><img src="graphics/2267_07_13.jpg" alt="Adding and removing instruments"/></div><p>In the next section, we will look at how we go about configuring an instrument that you have added to your trace document.<a id="id370" class="indexterm"/>
</p></div><div class="section" title="Configuring an instrument"><div class="titlepage"><div><div><h2 class="title"><a id="ch07lvl2sec10"/>Configuring an instrument</h2></div></div></div><p>You will find that most of the instruments that you add to your trace document are ready-to-use, out of the box. However, some instruments can be configured using the<span class="strong"><strong> Instruments Inspector</strong></span> and vary depending on the type of instrument being configured.<a id="id371" class="indexterm"/>
</p><p>You will notice that most instruments contain options for configuring the contents of the track pane, while only a small handful contain additional functionality for determining what type of information is gathered by the instrument. To configure an instrument, select the instrument from the<span class="strong"><strong> Instruments</strong></span> pane and then click on the<span class="strong"><strong> Instrument Inspector Icon</strong></span>, which is located to the right of the instrument. This is shown in the following screenshot:<a id="id372" class="indexterm"/>
</p><div class="mediaobject"><img src="graphics/2267_07_14.jpg" alt="Configuring an instrument"/></div><p>When the<span class="strong"><strong> Instrument Inspector Icon</strong></span> is clicked, it displays the inspector configuration dialog box next to the instrument name. To dismiss the inspector, click on the close button highlighted by an<span class="strong"><strong> X</strong></span>. You can similarly use the<span class="emphasis"><em> Command</em></span> +<span class="emphasis"><em> I</em></span> and<span class="strong"><strong> File | Get Info</strong></span> commands to close this window also. Depending on the type of instrument that is being configured, they can either be configured before, during, or after the data within your trace document has been recorded.<a id="id373" class="indexterm"/>
</p><p>The<span class="strong"><strong> Zoom</strong></span> control can be found in most of the inspector controls for those instruments, which you configure. This feature controls the magnification of the trace data that is displayed within the track pane, and adjusts the height of the instrument within the track pane. Alternatively, you can use the<span class="strong"><strong> View | Decrease Deck Size</strong></span> and<span class="strong"><strong> View | Increase Deck Size</strong></span> menu options to do the same thing.<a id="id374" class="indexterm"/>
</p></div><div class="section" title="Other components of the Instruments family explained"><div class="titlepage"><div><div><h2 class="title"><a id="ch07lvl2sec11"/>Other components of the Instruments family explained</h2></div></div></div><p>There are other instruments, which come with the Instruments application, apart from tracking down memory leaks and allocation objects. Although not every instrument works with iOS applications, the list of instruments pertaining to which type is explained in the following table:<a id="id375" class="indexterm"/>
</p><div class="informaltable"><table border="1"><colgroup><col style="text-align: left"/><col style="text-align: left"/><col style="text-align: left"/></colgroup><thead><tr><th style="text-align: left" valign="bottom">
<p><span class="strong"><strong>Instrument</strong></span></p>
</th><th style="text-align: left" valign="bottom">
<p><span class="strong"><strong>Platform</strong></span></p>
</th><th style="text-align: left" valign="bottom">
<p><span class="strong"><strong>Description</strong></span></p>
</th></tr></thead><tbody><tr><td style="text-align: left" valign="top">
<p>Activity Monitor</p>
</td><td style="text-align: left" valign="top">
<p>iOS /Simulator</p>
</td><td style="text-align: left" valign="top">
<p>Correlates the system workload with the virtual memory size.</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>Allocations</p>
</td><td style="text-align: left" valign="top">
<p>iOS / Simulator</p>
</td><td style="text-align: left" valign="top">
<p>This can be used to take snapshots of the heap, as applications perform their tasks. If taken at two different points in time, it can be used to identify situations where memory is being lost, not leaked.</p>
<p>The test case would be to take a snapshot, do something in the application, and then undo that something, returning the state of the application to its prior point. If the memory allocated in the heap is the same, no worries. It's a simple and repeatable test scenario of performing a task, and returning the application to its state prior to performing the task.</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>Automation</p>
</td><td style="text-align: left" valign="top">
<p>iOS / Simulator</p>
</td><td style="text-align: left" valign="top">
<p>Used to automate user interface tests in your iOS application.</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>Core Animation</p>
</td><td style="text-align: left" valign="top">
<p>iOS</p>
</td><td style="text-align: left" valign="top">
<p>Measures the number of Core Animation frames-per-second in a process running on an iOS device, through visual hints that help you understand how content is rendered on the screen.</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>CPU Sampler</p>
</td><td style="text-align: left" valign="top">
<p>iOS / Simulator</p>
</td><td style="text-align: left" valign="top">
<p>Correlates the overall system workload with the work being done specifically by your application.</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>Energy Diagnostics</p>
</td><td style="text-align: left" valign="top">
<p>iOS</p>
</td><td style="text-align: left" valign="top">
<p>Displays diagnostics information regarding the amount of energy being used on the device for GPU activity, display brightness, sleep/wake, bluetooth, WiFi, and GPS.</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>File Activity</p>
</td><td style="text-align: left" valign="top">
<p>Simulator</p>
</td><td style="text-align: left" valign="top">
<p>Examines file usage patterns in the system, by monitoring when files open, close, read, and write operations to files. It also monitors changes in the file system itself, relating to permission and owner changes.</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>Leaks</p>
</td><td style="text-align: left" valign="top">
<p>iOS / Simulator</p>
</td><td style="text-align: left" valign="top">
<p>This instrument looks for situations where memory has been allocated, but is no longer able to be used. These memory leaks can lead to the application crashing or being shut-down.</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>OpenGL ES Driver</p>
</td><td style="text-align: left" valign="top">
<p>iOS</p>
</td><td style="text-align: left" valign="top">
<p>Determines how efficiently you are using OpenGL and the GPU on iOS devices.</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>System Usage</p>
</td><td style="text-align: left" valign="top">
<p>iOS</p>
</td><td style="text-align: left" valign="top">
<p>Records calls to functions that operate on files within a process on the iOS device.</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>Threads</p>
</td><td style="text-align: left" valign="top">
<p>Simulator</p>
</td><td style="text-align: left" valign="top">
<p>Analyzes state transitions within a process, including both running and terminating threads, thread state, and associated back traces.</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>Time Profiler</p>
</td><td style="text-align: left" valign="top">
<p>iOS / Simulator</p>
</td><td style="text-align: left" valign="top">
<p>Performs low-overhead and time-based sampling of one or all processes.</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>Zombies</p>
</td><td style="text-align: left" valign="top">
<p>Simulator</p>
</td><td style="text-align: left" valign="top">
<p>The Zombies instrument keeps an empty or 'dead' object alive (in a sense) in place of objects that have already been released. These 'dead' objects are later accessed by the faulty application logic and halt execution of the application without crashing. The 'zombie' objects receive the call, and point the instrument to the exact location where the application would normally crash.</p>
</td></tr></tbody></table></div></div></div>
<div class="section" title="What's new in Instruments"><div class="titlepage"><div><div><h1 class="title"><a id="ch07lvl1sec03"/>What's new in Instruments</h1></div></div></div><p>The Instruments application which comes with Xcode contains a wide range of built-in instruments to make your job easier, and to gather and display data for one or more processes. In Xcode 4.2, a collection of new instruments has been added and these are explained as follows.<a id="id376" class="indexterm"/>
</p><div class="section" title="Time Profiler with CPU strategy"><div class="titlepage"><div><div><h2 class="title"><a id="ch07lvl2sec12"/>Time Profiler with CPU strategy</h2></div></div></div><p>The<span class="strong"><strong> Time profiler instrument</strong></span> illustrates how much time is being spent in each code segment. This allows developers to prioritize which bit of logic needs to be re-factored prior to release. Although this can be run using the iOS simulator, it is recommended to run this on the iOS devices, as the performance will vary greatly between the two.<a id="id377" class="indexterm"/>
</p><div class="mediaobject"><img src="graphics/2267_07_15.jpg" alt="Time Profiler with CPU strategy"/></div><p>Within the Time Profiler instrument, you can use the buttons at the left end of this bar to display the track view pane, using one of three strategies shown in the following table:</p><div class="informaltable"><table border="1"><colgroup><col style="text-align: left"/><col style="text-align: left"/></colgroup><thead><tr><th style="text-align: left" valign="bottom">
<p><span class="strong"><strong>View mode types</strong></span></p>
</th><th style="text-align: left" valign="bottom">
<p><span class="strong"><strong>Description</strong></span></p>
</th></tr></thead><tbody><tr><td style="text-align: left" valign="top">
<p>CPU strategy</p>
</td><td style="text-align: left" valign="top">
<p>This setting displays CPU activity on each active core. This strategy can help you determine if your application has achieved concurrency.</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>Instruments strategy</p>
</td><td style="text-align: left" valign="top">
<p>This setting displays CPU activity in a single track. This is the default strategy.</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>Threads strategy</p>
</td><td style="text-align: left" valign="top">
<p>This setting displays the CPU activity per-individual-thread.</p>
</td></tr></tbody></table></div><p>The Time Profiler instrument also provides developers with the ability to run the applications that they are developing on the iPad 2 and iPhone 4/4S. You can use the CPU strategy feature to measure activity on each CPU core.<a id="id378" class="indexterm"/>
</p><p>This is highlighted by the red rectangle, show in the previous screenshot. If your application supports concurrency, this should show evidence of activity on both of the iPad 2 cores at the same time.</p><div class="note" title="Note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title"><a id="note37"/>Note</h3><p>The CPU strategy feature is currently only available in the Time Profiler instrument.</p></div><p>There is also the ability to configure the Time Profiler instrument to limit the number of active processor cores. This is to allow you to configure your application to see how it will perform on systems running with fewer cores. An example of this would be, for instance, if you had a MacBook Pro running with four active core processors, but you wanted to limit this to work with two active core processors, to see how this would profile on a MacBook Pro running two cores.<a id="id379" class="indexterm"/>
</p><p>If your CPU supports multi-threading, this is also referred to as<span class="strong"><strong> hyper-threading</strong></span>. This means that for each physical core, there is a second logical core. Take for example: if you have a system that has hyper-threading enabled, and running with four physical cores, this will result in the system running with a total of eight cores.<a id="id380" class="indexterm"/>
</p><div class="mediaobject"><img src="graphics/2267_07_16.jpg" alt="Time Profiler with CPU strategy"/></div><p>This screenshot shows you how to go about configuring the total number of active-processor cores. This screen can be accessed through the<span class="strong"><strong> Instruments | Preferences</strong></span> menu option, or alternatively, you can use the<span class="emphasis"><em> Command</em></span> + key combination.<a id="id381" class="indexterm"/>
</p><p>From this screen, click on the<span class="strong"><strong> General</strong></span> pane, and then select or deselect the<span class="strong"><strong> Hardware Multi-Threading</strong></span> checkbox from the<span class="strong"><strong> Active Processor Cores</strong></span>, provided that this feature is supported by your system. You can also use the slider to specify the number of active cores to use.<a id="id382" class="indexterm"/>
</p><div class="note" title="Note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title"><a id="note38"/>Note</h3><p>Any changes made to the number of active cores doesn't turn off any of the processor cores-instead, the Instruments application tells the system not to schedule work on the cores that are made inactive.</p></div></div><div class="section" title="System Trace for iOS"><div class="titlepage"><div><div><h2 class="title"><a id="ch07lvl2sec13"/>System Trace for iOS</h2></div></div></div><p>The<span class="strong"><strong> System Trace for iOS</strong></span> instrument gives you the ability to profile against different aspects of the operating system which could be affecting application performance. This provides information on any system calls, thread scheduling, and<span class="strong"><strong> Virtual Memory</strong></span> (<span class="strong"><strong>VM</strong></span>) operations.<a id="id383" class="indexterm"/>
</p><p>An example of where this instrument could be useful, would be when you want to find out why your code is not executing on the CPU in a timely fashion, or if you are a game developer, and you wanted to find out why your applications, frame-rate has dropped unexpectedly.</p><p>In Instruments 4.2, you can use the System Trace tool to profile both iOS and Mac OS X.</p><div class="note" title="Note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title"><a id="note39"/>Note</h3><p>For more information on how to use this type of instrument, refer to the section named<span class="emphasis"><em> Tracing iOS applications</em></span>, located within this chapter.</p></div></div><div class="section" title="Network Connections"><div class="titlepage"><div><div><h2 class="title"><a id="ch07lvl2sec14"/>Network Connections</h2></div></div></div><p>The<span class="strong"><strong> Network Connections</strong></span> instrument gives you the ability to inspect how your iOS application is using TCP/IP and UDP/IP connections. When you use this instrument, it automatically takes a snapshot of all open ports available, and reports their cumulative network activity within the detail view, to see how much data is flowing over each connection and for each application.<a id="id384" class="indexterm"/>
</p><p>The following screenshot displays the<span class="strong"><strong> Connection Summary</strong></span> section of the detail view, and shows the incoming and outgoing network connections, as well as all of the open connections for all processes.</p><p>You will also see that you are provided with the ability to view statistic, such as round trip times and re-transmission requests to help reduce network traffic and energy consumption.<a id="id385" class="indexterm"/>
</p><div class="mediaobject"><img src="graphics/2267_07_17.jpg" alt="Network Connections"/></div><p>The detail view also allows you to choose from the following display views; these are explained in the following table:<a id="id386" class="indexterm"/>
</p><div class="informaltable"><table border="1"><colgroup><col style="text-align: left"/><col style="text-align: left"/></colgroup><thead><tr><th style="text-align: left" valign="bottom">
<p><span class="strong"><strong>View mode types</strong></span></p>
</th><th style="text-align: left" valign="bottom">
<p><span class="strong"><strong>Description</strong></span></p>
</th></tr></thead><tbody><tr><td style="text-align: left" valign="top">
<p>
<span class="strong"><strong>Process</strong></span> summary</p>
</td><td style="text-align: left" valign="top">
<p>This setting aggregates the cumulative data for each process only.</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<span class="strong"><strong>Interface</strong></span> summary</p>
</td><td style="text-align: left" valign="top">
<p>This setting aggregates the data by network.</p>
</td></tr></tbody></table></div><p>You can also choose to have the details view display a set of useful graphs, by selecting the<span class="strong"><strong> Trace Highlights</strong></span> option, as shown in the following screenshot:<a id="id387" class="indexterm"/>
</p><div class="mediaobject"><img src="graphics/2267_07_18.jpg" alt="Network Connections"/></div><p>This screenshot shows the<span class="strong"><strong> Port Activity</strong></span> and the<span class="strong"><strong> Process Activity</strong></span> comparisons. The<span class="strong"><strong> Port Activity</strong></span> feature measures the incoming and outgoing connections. The<span class="strong"><strong> Process Activity</strong></span> feature measures the activity used by the application.<a id="id388" class="indexterm"/>
</p></div><div class="section" title="Network activity"><div class="titlepage"><div><div><h2 class="title"><a id="ch07lvl2sec15"/>Network activity</h2></div></div></div><p>The<span class="strong"><strong> Network Activity</strong></span> instrument helps you bridge the gap between networking (cellular and Wi-Fi) and energy usage. You can use this instrument to track the device-wide volume of data flow through each network interface alongside an energy usage level taken directly from the battery, as well as correlate network activity with energy usage in iOS devices, and is also included as part of the Energy Diagnostics template for iOS.<a id="id389" class="indexterm"/>
</p><p>The following screenshot displays the<span class="strong"><strong> Energy Diagnostics</strong></span> trace document, with the run results that show the different<span class="strong"><strong> Energy Usage</strong></span> levels:<a id="id390" class="indexterm"/>
</p><div class="mediaobject"><img src="graphics/2267_07_19.jpg" alt="Network activity"/></div><p>When you run this for the first time, you will notice that the network activity is frequent enough to keep the process active, which will result in much greater energy consumption. If you were to run this again, you will notice that the same data is transmitted in larger, but less frequent bursts, allowing the application to sleep between transmissions.<a id="id391" class="indexterm"/>
</p><p>The<span class="strong"><strong> Energy Diagnostics</strong></span> instrument is the most exciting tool that Apple gave to developers. This instrument will help you identify optimum use of the iOS device resources, by enabling you to test your application as close to real-world scenarios as possible.<a id="id392" class="indexterm"/>
</p><p>The data collected can later be analyzed to see how much of the device's battery life each function consumes, and it will tell the developer how long each of the device's various components are used. If you need to know the user's location, it will tell you which devices were turned on and for how long.<span class="strong"><strong> GPS</strong></span> is a particular resource that consumes much of the device's battery life. Turning off<span class="strong"><strong> location services</strong></span> once a location has been obtained is ideal.<a id="id393" class="indexterm"/>
</p><div class="note" title="Note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title"><a id="note40"/>Note</h3><p>If you are interested in reading more about Instruments, you can refer to the<span class="emphasis"><em> Instruments User Guide Documentation</em></span>, at the following link provided:<a class="ulink" href="http://developer.apple.com/library/ios/#documentation/DeveloperTools/Conceptual/InstrumentsUserGuide/Introduction/Introduction.html"> http://developer.apple.com/library/ios/#documentation/DeveloperTools/Conceptual/InstrumentsUserGuide/Introduction/Introduction.html</a>.</p></div></div></div>
<div class="section" title="Summary"><div class="titlepage"><div><div><h1 class="title"><a id="ch07lvl1sec04"/>Summary</h1></div></div></div><p>In this chapter, we focused on the new additions to the Xcode Instruments application, and how we can use this brilliant tool to ensure that our application runs smoothly, free from bottlenecks that could potentially affect the performance of an application.</p><p>We took a look into each of the different types of built-in instruments that become part of the Instruments application, in particular the Systems Trace for iOS instrument. This helps track-down system calls, memory, and threads that may be affecting application performance on your iOS applications.</p><p>We ended the chapter looking at how we can configure instruments to represent data differently within the trace document.</p><p>I hope you have enjoyed reading it as much as I did writing it. This is certainly not the end of the road for you. There is a lot of stuff to explore in the world of Xcode and iPhone. Don't worry! You won't be on your own. There are many developers out there who are more than willing to help you in case you get stuck at any point in time:<a class="ulink" href="http://developer.apple.com/devforums/"> http://developer.apple.com/devforums/</a>.</p><p>Good luck with your Xcode journey. I hope to see your application on the Apple App Store soon!</p></div></body></html>