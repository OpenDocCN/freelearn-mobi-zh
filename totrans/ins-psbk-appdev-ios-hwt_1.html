<html><head></head><body><div class="chapter" title="Chapter&#xA0;1.&#xA0;Instant Passbook App Development for iOS How-to"><div class="titlepage"><div><div><h1 class="title"><a id="ch01"/>Chapter 1. Instant Passbook App Development for iOS How-to</h1></div></div></div><p>Welcome to <span class="emphasis"><em>Instant Passbook App Development for iOS How-to</em></span>. This book will guide you through creating a Passbook Pass, distributing it to your users, and integrating it in to your existing app.</p><div class="section" title="Understanding Passbook (Simple)"><div class="titlepage"><div><div><h1 class="title"><a id="ch01lvl1sec08"/>Understanding Passbook (Simple)</h1></div></div></div><p>This recipe will help you understand Passbook from the perspective of both, a user and a Pass creator.</p><div class="section" title="Getting ready"><div class="titlepage"><div><div><h2 class="title"><a id="ch01lvl2sec07"/>Getting ready</h2></div></div></div><p>With iOS, Apple introduced the Passbook app as a central digital wallet for all the store cards, coupons, boarding passes, and event tickets that have become a popular feature of apps.</p><p>A company wishing to take advantage of this digital wallet and the extra functionality it provides, can use Apple's developer platform to create a Pass for their users.</p></div><div class="section" title="How to do it…"><div class="titlepage"><div><div><h2 class="title"><a id="ch01lvl2sec08"/>How to do it…</h2></div></div></div><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">To understand Passbook, we need to see a Pass in action. Download the example Pass from:<p>
<a class="ulink" href="http://passkit.pro/example-generic-pkpass">http://passkit.pro/example-generic-pkpass</a>
</p></li><li class="listitem">If you open this link within Mobile Safari, on an iPhone or iPod Touch running iOS, you will be presented with the Pass and the option to add it to your Passbook:<div class="mediaobject"><img src="graphics/7064OT_01_01.jpg" alt="How to do it…"/></div></li><li class="listitem">Alternatively, you can download the Pass on a Mac or PC and e-mail it to yourself, and then open the e-mail within the Mail app on an iPhone or iPod Touch. Tapping the Pass attachment link will present the Pass.</li><li class="listitem">If you choose to add the Pass to your Passbook app, the displayed Pass will disappear, having been filed away within your Passbook. Now, click on the <span class="strong"><strong>home</strong></span> button to return to the home screen and launch the Passbook app. In the app you will now see the Pass that was just added. It contains information specified by the app creator and can be presented when interacting with the company providing the service. Additional information can be placed on the back of the Pass. Tap the <span class="strong"><strong>i</strong></span> button in the top-right hand corner of the Pass, to reveal this information.</li></ol></div></div><div class="section" title="How it works…"><div class="titlepage"><div><div><h2 class="title"><a id="ch01lvl2sec09"/>How it works…</h2></div></div></div><p>The following diagram describes how Passes are delivered to a Passbook, and how these can be updated:</p><div class="mediaobject"><img src="graphics/7064OT_01_02.jpg" alt="How it works…"/></div><p>The process of creating a Pass involves cryptographically signing the Pass using a certificate and key generated from your iOS developer account. For this reason, the generation of the Pass needs to take place on a server, and then be delivered to Passbook either via your own app, as an e-mail attachment, or by embedding it in a website.</p><p>It's important to note that Apple does not provide any system for the Pass providers to authenticate, validate, or invalidate Passes. The Pass can contain barcode information, but it is up to the Pass provider to provide the infrastructure for reading and processing these barcodes.</p><p>Instead of just sitting in the Passbook app, waiting to be used, a Pass can contain location and time triggers, that proactively present the Pass to the user, serving as both a reminder and providing convenient access. For example, an event Pass could be set to appear 15 minutes before the start time, at the time when a user is likely to want to present their event Pass to an attendant. Alternatively, a coupon Pass could be presented as a user approaches their local store where the coupon can be redeemed.</p><p>Passes that have been added to Passbook can also be updated dynamically. For example, if the Pass is for a store card, a change to the card balance may require an update to the Pass. In the case of, for example an airline ticket Pass, a departure gate change should trigger a Pass update.</p><p>When a Pass needs to be updated, your server sends a <span class="strong"><strong>push notification </strong></span>to the Passbook app on the user's device. This push notification is not displayed to the user.</p><p>Upon receiving this Push Notification, the Passbook app then makes a request to your server for the updated Pass information. Your server would then respond to the relevant request, and provide the updated information in the expected format.</p><p>When the Passbook App on the user's device receives the updated information, it silently updates the Pass. The next time the user looks at the Pass contained in the Passbook app, the updated information is displayed.</p></div><div class="section" title="There's more…"><div class="titlepage"><div><div><h2 class="title"><a id="ch01lvl2sec10"/>There's more…</h2></div></div></div><p>Support for Passbook is also built into OSX Mountain Lion (10.8.2). Pass files with the <code class="literal">pkpass</code> file extension will open in a preview window:</p><div class="mediaobject"><img src="graphics/7064OT_01_03.jpg" alt="There's more…"/></div><p>Clicking on the <span class="strong"><strong>Add to Passbook</strong></span> button will place the Pass in the Passbook associated with the iCloud account set up in OSX system preferences.</p><p>The OSX Mail app and Safari also support embedded Passes.</p><p>When building a Pass, you can specify a relevant time and up to 10 relevant locations that will trigger a message to be displayed on the lock screen. The message looks similar to a push notification, however a Pass notification is less intrusive. When it is relevant to display, it doesn't vibrate the iPhone and it doesn't wake up the screen. The notification only becomes visible when the phone wakes up from sleep:</p><div class="mediaobject"><img src="graphics/7064OT_01_04.jpg" alt="There's more…"/></div><p>The option to specify relevant times and locations, and how far from the location the notification is triggered, is determined by the Pass type, as we will see later.</p><div class="section" title="Apps using Passbook"><div class="titlepage"><div><div><h3 class="title"><a id="ch01lvl3sec01"/>Apps using Passbook</h3></div></div></div><p>Some of the apps in the App Store using Passbook are as follows:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>Hotels.com</strong></span>: This uses Passbook for room reservation details. It can be downloaded from <a class="ulink" href="http://appstore.com/hotelscom/hotelscom">http://appstore.com/hotelscom/hotelscom</a>.</li><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>Starbucks</strong></span>: This uses Passbook for a store card. It can be downloaded from <a class="ulink" href="http://appstore.com/starbuckscoffeecompany">http://appstore.com/starbuckscoffeecompany</a>.</li><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>Ticketmaster</strong></span>: This uses Passbook for event tickets. It can be downloaded from <a class="ulink" href="http://appstore.com/ticketmaster/ticketmaster">http://appstore.com/ticketmaster/ticketmaster</a>.</li><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>United Airlines</strong></span>: This uses Passbook for boarding passes. It can be downloaded from <a class="ulink" href="http://appstore.com/unitedairlines">http://appstore.com/unitedairlines</a>.</li></ul></div></div><div class="section" title="Further documentation"><div class="titlepage"><div><div><h3 class="title"><a id="ch01lvl3sec02"/>Further documentation</h3></div></div></div><p>For more details refer to Apple's Passbook documentation at <a class="ulink" href="https://developer.apple.com/passbook/">https://developer.apple.com/passbook/</a>.</p></div></div></div></div>
<div class="section" title="Setting up your environment (Simple)"><div class="titlepage"><div><div><h1 class="title"><a id="ch01lvl1sec09"/>Setting up your environment (Simple)</h1></div></div></div><p>This recipe shows how to set up your Pass type in Apple's provisioning Portal and generate the required files for code signing.</p><div class="section" title="Getting ready"><div class="titlepage"><div><div><h2 class="title"><a id="ch01lvl2sec11"/>Getting ready</h2></div></div></div><p>To get started with creating your own Pass, you will need a paid iOS developer account. If you intend to present the Passes within an existing iOS app, you will need access to the iOS developer account that publishes this existing app. In addition, many of these steps require apps and utilities only available on OSX, Keychain Access for example, which is used in the certificate creation process. Therefore, these steps should be undertaken using a Mac, running OSX.</p></div><div class="section" title="How to do it…"><div class="titlepage"><div><div><h2 class="title"><a id="ch01lvl2sec12"/>How to do it…</h2></div></div></div><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">If you intend to present Passes within an iOS App, but have not yet created the app, you will need to create an App ID within the <span class="strong"><strong>Identifiers</strong></span> section of the iOS Developer Center.</li><li class="listitem">Log in to the iOS Developer Center and navigate to <span class="strong"><strong>Certificates</strong></span> | I<span class="strong"><strong>dentifiers &amp; Profiles</strong></span> | <span class="strong"><strong>Identifiers</strong></span>, or follow this link:<p>
<a class="ulink" href="https://developer.apple.com/account/ios/identifiers/bundle/bundleList.action">https://developer.apple.com/account/ios/identifiers/bundle/bundleList.action</a>
</p></li><li class="listitem">Click the <span class="strong"><strong>+</strong></span> button at the top-right hand corner.</li><li class="listitem">Enter an app name in the <span class="strong"><strong>App ID Description</strong></span> field:<div class="mediaobject"><img src="graphics/7064OT_01_05.jpg" alt="How to do it…"/></div></li><li class="listitem">Under <span class="strong"><strong>Application Services</strong></span>, ensure that <span class="strong"><strong>Passbook</strong></span> is enabled.</li><li class="listitem">Under <span class="strong"><strong>App ID Prefix</strong></span>, use Team ID unless you have a reason to explicitly specify this.</li><li class="listitem">An App ID Suffix is a string identifier that is unique to your app. The provisioning portal will not allow you to specify a Bundle Identifier being used in another app. The suggestion is to use a reverse domain name style string. For example, throughout this book I have used the domain name <a class="ulink" href="http://passkit.pro">http://passkit.pro</a>, therefore the Bundle Identifier I have chosen is <code class="literal">pro.passkit.example</code> as this will be the app ID for the example app.</li><li class="listitem">If you have a pre-existing app ID, you will need to enable Passbook for this app ID. From the app ID section of the provisioning portal, select the app ID, and note down the prefix, as we need it when specifying the Team Identifier of your Pass. Having done this, choose <span class="strong"><strong>Settings</strong></span>:<div class="mediaobject"><img src="graphics/7064OT_01_06.jpg" alt="How to do it…"/></div></li><li class="listitem">Check the checkbox next to Passbook and click on <span class="strong"><strong>Done</strong></span>. A warning will be displayed, informing that all new provisioning profiles created for this app ID will be enabled for Passes. This is presented as a reminder that pre-existing provisioning profiles will not be enabled for Passbook, until they are re-created. Therefore, if you have a pre-existing App published to the App Store, you will need to re-generate the App's distribution provisioning profile, re-build the App with this new provisioning profile, and submit an update of the App to the App Store. Until you do this, your App will not be able to add Passes into Passbook. When Passes have been correctly enabled for an app ID the Passes' indicator will turn green and be labeled as <span class="strong"><strong>Enabled</strong></span> in the app ID summary screen:<div class="mediaobject"><img src="graphics/7064OT_01_07.jpg" alt="How to do it…"/></div></li><li class="listitem">Regardless of whether you intend to present your Pass in an app, you will now need to create a Pass Type ID. Follow the link on the left menu for Pass Type IDs or visit:<p>
<a class="ulink" href="https://developer.apple.com/account/ios/identifiers/passTypeId/passTypeIdList.action">https://developer.apple.com/account/ios/identifiers/passTypeId/passTypeIdList.action</a>
</p></li><li class="listitem">Click on the <span class="strong"><strong>+</strong></span> button to create a new Pass Type ID. You will need to create a Pass Type ID for each type of Pass you intend to create. The types of Passes currently available to create are Boarding Pass, Coupon, Event Ticket, Store Card, and Generic. The Pass types are presented differently and have different functionality, as we will see. In our examples we will focus on building a Generic Pass. If you intend to create a Store Card type Pass and a Coupon type Pass, you will need to create a Pass Type ID for each:<div class="mediaobject"><img src="graphics/7064OT_01_08.jpg" alt="How to do it…"/></div></li><li class="listitem">For the description, choose a name that defines the type of Pass you are creating. For the main example later in the book, a Generic type Pass will be created, therefore in the example Pass Type ID above, the description <span class="strong"><strong>Generic</strong></span> is used.</li><li class="listitem">The Identifier has to start with <code class="literal">pass.</code>, then a reverse domain name string is suggested, with the type of Pass placed on the end. In the example above, I use the full app ID created earlier, with Pass Type of generic, giving the full Pass Type Identifier as follows:<div class="informalexample"><pre class="programlisting">pass.pro.passkit.example.generic</pre></div><p>With the Pass Type ID created, we will generate an associated cryptographic key and certificate, which is needed for authentication of the Pass. Select the Pass Type ID and note down the Pass Type ID, as this will be needed later when creating the Pass:</p><div class="mediaobject"><img src="graphics/7064OT_01_09.jpg" alt="How to do it…"/></div></li><li class="listitem">Click on the <span class="strong"><strong>Settings</strong></span> button and follow the instructions to create a Certificate Signing Request. I will repeat the instructions below, with some suggestions to help avoid confusion later.</li><li class="listitem">Launch the Keychain Access utility.</li><li class="listitem">From the menu, select <span class="strong"><strong>Keychain Access</strong></span> | <span class="strong"><strong>Certificate Assistant </strong></span>| <span class="strong"><strong>Request a Certificate from a Certificate Authority</strong></span>. In the <span class="strong"><strong>Certificate Information</strong></span> window, enter the following:<div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>User Email Address</strong></span>: Enter the e-mail address associated with your iOS developer account.</li><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>Common Name</strong></span>: Choose a name that relates to the Pass Type ID. This will be displayed next to the key in Keychain Access, so a common name that isn't specific enough can cause confusion. See the following screenshot, which is how this will be presented in Keychain Access after step 18.</li><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>CA Email Address</strong></span>: Leave this field blank</li><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>Request is</strong></span>: Choose <span class="strong"><strong>Saved to Disk</strong></span></li></ul></div><div class="mediaobject"><img src="graphics/7064OT_01_10.jpg" alt="How to do it…"/></div></li><li class="listitem">Click on <span class="strong"><strong>Continue</strong></span> and save your Certificate Signing Request. Then, in Safari (other browsers may have problems or incompatibilities that prevent you from choosing a file), click on <span class="strong"><strong>Choose File</strong></span> and select the Certificate Signing Request that has just been generated. Click on <span class="strong"><strong>Generate</strong></span> and wait for the pass Type certificate to be generated:<div class="mediaobject"><img src="graphics/7064OT_01_11.jpg" alt="How to do it…"/></div></li><li class="listitem">Once generated, click on <span class="strong"><strong>Done</strong></span> and download your certificate. Open your downloaded certificate, which will launch Keychain Access and attach the certificate to the associated private key, which was created during the generation of the Certificate Signing Request:<div class="mediaobject"><img src="graphics/7064OT_01_12.jpg" alt="How to do it…"/></div></li></ol></div><p>The certificate and key pair should now be visible in Keychain Access. These now need to be converted into a format that can be used to correctly sign the Passes you will create. Select the certificate in Keychain Access, and from the menu choose <span class="strong"><strong>File</strong></span> | <span class="strong"><strong>Export Items</strong></span>, and choose an export location. You will be asked to provide a password to protect the exported items, you may also be asked for the administrator password as you are performing a task that requires administrator privileges.</p><p>You will need to use a command-line tool called OpenSSL to use the exported file to generate the key and certificate files that will be needed. This command line tool can be run from a built-in OSXutility called <span class="strong"><strong>Terminal</strong></span>. To open Terminal, go to your <code class="literal">Applications</code> folder in <code class="literal">Finder</code>. Terminal is located in the <code class="literal">Utilities</code> folder.</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Use the following Terminal commands to generate a <code class="literal">certificate.pem</code> file and a <code class="literal">key.pem</code> file.<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>openssl pkcs12 -in &lt;Path to exported .p12&gt; -clcerts -nokeys -out certificate.pem</strong></span>
<span class="strong"><strong>openssl pkcs12 -in &lt;Path to exported .p12&gt; -nocerts -out key.pem</strong></span>
</pre></div></li><li class="listitem">On generating the <code class="literal">key.pem</code>, you will be prompted to enter an import passport, which is the password that was set when exporting from Keychain Access. You will then be prompted for a pass phrase; this can be the same as the import password, but note that this pass phrase will need to provided when signing your Passes and so may form part of an automated script.</li><li class="listitem">In addition to the <code class="literal">certificate.pem</code> file and <code class="literal">key.pem</code> file generated above, the Apple WWDR intermediate certificate is also required. This can be found by going to the provisioning portal, in the <span class="strong"><strong>Certificates</strong></span> section, click on the <span class="strong"><strong>+</strong></span> button, or visit the following. The certificate is labeled <span class="emphasis"><em>Worldwide Developer Relations Certificate Authority</em></span> under Intermediate Certificates.<p>
<a class="ulink" href="https://developer.apple.com/account/ios/certificate/certificateCreate.action">https://developer.apple.com/account/ios/certificate/certificateCreate.action</a>
</p></li><li class="listitem">Once this has been downloaded, it also needs to be converted into a <code class="literal">.pem</code> file. Double-click on the WWDR certificate file, to load it into Keychain Access, and select the certificate in Keychain Access:<div class="mediaobject"><img src="graphics/7064OT_01_13.jpg" alt="How to do it…"/></div></li><li class="listitem">Then, from the menu choose <span class="strong"><strong>File</strong></span> | <span class="strong"><strong>Export Items</strong></span>, change the file format to <span class="strong"><strong>Privacy Enhanced Mail</strong></span> <code class="literal">(.pem</code>) and save as it <code class="literal">wwdr.pem</code>.</li></ol></div></div><div class="section" title="How it works…"><div class="titlepage"><div><div><h2 class="title"><a id="ch01lvl2sec13"/>How it works…</h2></div></div></div><p>Apple's security model ensures that only registered iOS developers can create Passes and that Passes cannot be altered by a third party while being delivered to a user's device, without being detected, and rejected by Passbook.</p><p>The certificate creation process produces a Pass Type certificate that is tied to the Pass Type ID that it was created from, which in turn ties it to your developer account. This provides a method for verifying the contents of a Pass signed using this certificate, and therefore, a way of detecting any manipulation of the Pass by anyone other than the registered Pass creator.</p></div></div>
<div class="section" title="Creating your Pass (Medium)"><div class="titlepage"><div><div><h1 class="title"><a id="ch01lvl1sec10"/>Creating your Pass (Medium)</h1></div></div></div><p>Passes are built and customized by specifying the relevant information in JSON format. Certain graphical assets can also be provided to further customize the look and feel of the Pass.</p><p>As an example, we will build a Pass of a Generic type, to be used as an employee identification card. Once we understand the JSON structure of this type, we will see how other Pass types differ.</p><div class="section" title="Getting ready"><div class="titlepage"><div><div><h2 class="title"><a id="ch01lvl2sec14"/>Getting ready</h2></div></div></div><p>You can get the full JSON code, which we will use, from the following link:</p><p>
<a class="ulink" href="http://passkit.pro/example-generic-json">http://passkit.pro/example-generic-json</a>
</p><p>This will create a Pass that looks like the following two images.</p><p>The following screenshot shows the front of the Pass:</p><div class="mediaobject"><img src="graphics/7064OT_01_14.jpg" alt="Getting ready"/></div><p>The back of the Pass is shown in the following screenshot:</p><div class="mediaobject"><img src="graphics/7064OT_01_15.jpg" alt="Getting ready"/></div></div><div class="section" title="How to do it…"><div class="titlepage"><div><div><h2 class="title"><a id="ch01lvl2sec15"/>How to do it…</h2></div></div></div><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Save the following JSON code to a file called <code class="literal">pass.json</code>:<div class="informalexample"><pre class="programlisting">{
"passTypeIdentifier" : "pass.pro.passkit.example.generic",
  "formatVersion" : 1,
  "teamIdentifier" : "YAXJZJ267E",
  "organizationName" : "Passbook Example Company",
  "serialNumber" : "0000001",
  "description" : "Staff Pass for Employee Number 001",
  "associatedStoreIdentifiers" : [
    375380948
  ],
  "locations" : [
    {
  "latitude" : 51.50506, 
  "longitude" : -0.01960, 
  "relevantText" : "Company Offices"
}
  ],
  "foregroundColor" : "rgb(255, 255, 255)",
  "backgroundColor" : "rgb(90, 90, 90)",
  "labelColor" : "rgb(255, 255, 255)",
  "logoText" : "Company Staff ID",
  "barcode" : {
    "format" : "PKBarcodeFormatQR",
    "message" : "0000001",
    "messageEncoding" : "iso-8859-1",
    "altText" : "Staff ID 0000001"
   },
  "generic" : {
    "headerFields" : [
      {
        "key" : "staffNumber",
  "label" : "Staff Number",
  "value" : "001"
      }
    ],
  "primaryFields" : [
    {
  "key" : "staffName",
  "label" : "Name",
  "value" : "Peter Brooke"
  }
  ],
  "secondaryFields" : [
  {
  "key" : "telephoneExt",
  "label" : "Extension",
  "value" : "9779"
  },
  {
  "key" : "jobTitle",
  "label" : "Job Title",
  "value" : "Chief Pass Creator"
  }
  ],
  "backFields" : [
  {
  "key" : "managersName",
  "label" : "Manager's Name",
  "value" : "Paul Bailey"
  },
  {
  "key" : "managersExt",
  "label" : "Manager's Extension",
  "value" : "9673"
  },
  {
  "key" : "expiryDate",
  "dateStyle" : "PKDateStyleShort",
  "label" : "Expiry Date",
  "value" : "2013-12-31T00:00-23:59"
  }
  ]
  }
}</pre></div></li><li class="listitem">Replace the value for <code class="literal">passTypeIdentifier</code> (currently <code class="literal">pass.pro.passkit.example.generic</code>) with your own Pass Type Identifier created previously.</li><li class="listitem">Replace the value for <code class="literal">teamIdentifier</code> (currently <code class="literal">YAXJZJ267E</code>) with your own Team Identifier, noted previously as the App ID Prefix.</li><li class="listitem">A number of graphical assets can be added to further customise the Pass. The only required graphical asset is an icon, which is used when displaying the Pass on the lock screen. </li><li class="listitem">Create an icon for retina screens with dimensions of 58 px by 58 px, this should be named <code class="literal">icon@2x.png</code>. Create a non-retina version with dimensions 29 px by 29 px, this should be named <code class="literal">icon.png</code>. Example assets can downloaded from <a class="ulink" href="http://passkit.pro/example-generic-package">http://passkit.pro/example-generic-package</a>.</li></ol></div></div><div class="section" title="How it works…"><div class="titlepage"><div><div><h2 class="title"><a id="ch01lvl2sec16"/>How it works…</h2></div></div></div><p>The <code class="literal">pass.json</code> file we've just created contains the following top-level key/value pairs:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><code class="literal">passTypeIdentifier</code>: This ties the Pass to your developer account.</li><li class="listitem" style="list-style-type: disc"><code class="literal">formatVersion</code>: Currently this is always 1, but it will allow Apple to vary the format in the future, while maintaining backwards compatibility.</li><li class="listitem" style="list-style-type: disc"><code class="literal">teamIdentifier</code>: This identifier allows separate apps, by the same developer, to share data through the iOS keychain. For our purposes, this just needs to match the App ID Prefix specified when the Pass Type Identifier was created.</li><li class="listitem" style="list-style-type: disc"><code class="literal">organizationName</code>: This is the name of your company or app, this should be how your users know and refer to you. It will be displayed as the title of the notification when a Pass is presented on the lock screen.</li><li class="listitem" style="list-style-type: disc"><code class="literal">serialNumber</code>: This should contain a unique reference to the Pass, when updating a Pass, this serial number will be used to request the updated information from your server, and therefore this should uniquely identify only one Pass of this type. In the example of a staff identification Pass, this could be the employee reference number. While it's represented as a number in the example, it can be any text value.</li><li class="listitem" style="list-style-type: disc"><code class="literal">description</code>: Used for accessibility features and so should briefly describe the Pass's use and should include enough information to distinguish it from other Passes of the same type.</li><li class="listitem" style="list-style-type: disc"><code class="literal">associatedStoreIdentifiers</code>: An array of iTunes Store App Identifiers for Apps that are associated with this Pass. If you already have an app in the App Store, through which Passes will be provided, this should be included. An app's identifier can be found in iTunes Connect. If multiple identifiers are provided, the first one that is available for the device is used. This will present an App information banner on the back of the Pass. This banner will prompt the user to install your app or open the app if it is already installed.</li></ul></div><p>The following two top-level key/value pairs determine under what circumstances the Pass is presented to the user on their lock screen.</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><code class="literal">locations</code>: This is a list of locations that are relevant to the use of the Pass. This is represented as an array of dictionaries containing the location information. Only one location is provided in the example, however up to 10 may be specified. If the user is within a certain distance of this location, they may be presented with the Pass on their lock screen. The distance from the location that triggers this behavior varies depending on the Pass type, for a generic Pass type the distance is approximately 100 meters. Each <code class="literal">locations</code> dictionary contains latitude, longitude, and relevant text that will be displayed on the lock screen when triggered. In the <code class="literal">locations</code> dictionary you can optionally specify altitude as well.</li><li class="listitem" style="list-style-type: disc"><code class="literal">relevantDate</code>: Not included in the example above, as it didn't fit with the employer ID use case. This determines a time period within which the Pass is relevant. The value for this key should be text in the form of a W3C timestamp, for example, "2013-12-31T00:00-23:59", and can also include seconds if necessary. No timezone information should be included, as the timezone set in the device's settings is used.</li></ul></div><p>The behavior of the two relevancy keys described above varies depending on the Pass type. The Pass type determines that for <code class="literal">locations</code> and <code class="literal">relevantDate</code>, which are required and which are options, it also determines the triggering criteria used in presenting a Pass on the user's lock screen.</p><p>An explanation of the differing behavior can be found in Apple's Passbook Programming Guide (Apple Developer account signin required) at:</p><p>
<a class="ulink" href="https://developer.apple.com/library/ios/#documentation/UserExperience/Conceptual/PassKit_PG/Chapters/Creating.html">https://developer.apple.com/library/ios/#documentation/UserExperience/Conceptual/PassKit_PG/Chapters/Creating.html#//apple_ref/doc/uid/TP40012195-CH4-SW53</a>
</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><code class="literal">foregroundColor</code>: The foreground color of the Pass, value provided as an RGB triple.</li><li class="listitem" style="list-style-type: disc"><code class="literal">backgroundColor</code>: The background color of the Pass, value provided as an RGB triple.</li><li class="listitem" style="list-style-type: disc"><code class="literal">labelColor</code>: The color of the text displayed in the Pass, value provided as an RGB triple.</li><li class="listitem" style="list-style-type: disc"><code class="literal">logoText</code>: The text shown in the top-left hand corner of the Pass. This will mostly likely be the name of your company, or an indication of the Pass's use.</li><li class="listitem" style="list-style-type: disc"><code class="literal">barcode</code>: This dictionary contains the information to display in a barcode and how to display it. The Pass format supports automatic creation of 2D barcodes in one of the following formats:<div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><code class="literal">PKBarcodeFormatQR</code></li><li class="listitem" style="list-style-type: disc"><code class="literal">PKBarcodeFormatPDF417</code></li><li class="listitem" style="list-style-type: disc"><code class="literal">PKBarcodeFormatAztec</code></li></ul></div><p>Message encoding will typically be <code class="literal">iso-8859-1</code>, unless you know that another encoding format is supported by your barcode scanner.</p><p>The value to be encoded into the barcode should be defined with the message key and the <code class="literal">altText</code> key used to optionally display a more human readable description of the barcode information.</p></li><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>generic</strong></span>: This top-level key determines the type of Pass that you will be creating. The types currently available are:<div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><code class="literal">generic</code></li><li class="listitem" style="list-style-type: disc"><code class="literal">boardingPass</code></li><li class="listitem" style="list-style-type: disc"><code class="literal">coupon</code></li><li class="listitem" style="list-style-type: disc"><code class="literal">eventTicket</code></li><li class="listitem" style="list-style-type: disc"><code class="literal">storeCard</code></li></ul></div></li></ul></div><p>Your choice of Pass type effects many things about the Pass, including overall style, text layout, available graphical asset options, and lock screen behavior. Apple has optimized the Pass types for their individual use cases, so try to pick a Pass type that most closely represents your Pass's use case. If none of the specific Pass types are appropriate, then the generic Pass type can be used.</p><p>The Passbook Programming Guide describes the different layout configurations for each Pass type:</p><p>
<a class="ulink" href="https://developer.apple.com/library/ios/#documentation/UserExperience/Conceptual/PassKit_PG/Chapters/Creating.html">https://developer.apple.com/library/ios/#documentation/UserExperience/Conceptual/PassKit_PG/Chapters/Creating.html#//apple_ref/doc/uid/TP40012195-CH4-SW1</a>
</p><p>Within the Pass type top-level key is a dictionary, containing arrays of various display groups, including <code class="literal">headerFields</code>, <code class="literal">primaryFields</code>, <code class="literal">secondaryFields</code>, and <code class="literal">backFields</code>, which are displayed according to Pass type. Each group contains an array of dictionaries, specifying key, label, and value. The label and value fields are displayed on the Pass, while the key field should be unique within your Pass format, and will be used when updating a Pass.</p></div><div class="section" title="There's more…"><div class="titlepage"><div><div><h2 class="title"><a id="ch01lvl2sec17"/>There's more…</h2></div></div></div><p>Graphical assets can be provided to further visually customize your Pass. The <code class="literal">icon.png</code> asset is required, but the following assets can optionally be included in the Pass package:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><code class="literal">logo.png</code></li><li class="listitem" style="list-style-type: disc"><code class="literal">background.png</code></li><li class="listitem" style="list-style-type: disc"><code class="literal">thumbnail.png</code></li><li class="listitem" style="list-style-type: disc"><code class="literal">footer.png</code></li><li class="listitem" style="list-style-type: disc"><code class="literal">strip.png</code></li></ul></div><p>All assets should include a retina version that is twice as wide and twice as high, with <code class="literal">@2x</code> at the end of the filename. Therefore, for the icon, you provide the following files:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><code class="literal">icon.png</code>: 29 px width x 29 px height</li><li class="listitem" style="list-style-type: disc"><code class="literal">icon@2x.png</code>: 58 px width x 58 px height</li></ul></div><p>The following table provides the available size of each asset, and the space available for each Pass type. The sizes are provided as pixels width x pixels height:</p><div class="informaltable"><table border="1"><colgroup><col style="text-align: left"/><col style="text-align: left"/><col style="text-align: left"/><col style="text-align: left"/><col style="text-align: left"/><col style="text-align: left"/><col style="text-align: left"/></colgroup><thead><tr><th style="text-align: left" valign="bottom">
<p>Pass Type</p>
</th><th style="text-align: left" valign="bottom">
<p>icon</p>
<p>29 x 29</p>
</th><th style="text-align: left" valign="bottom">
<p>logo</p>
<p>160 x 50</p>
</th><th style="text-align: left" valign="bottom">
<p>background</p>
<p>180 x 220</p>
</th><th style="text-align: left" valign="bottom">
<p>thumbnail</p>
<p>90 x 90*</p>
</th><th style="text-align: left" valign="bottom">
<p>strip</p>
<p>**</p>
</th><th style="text-align: left" valign="bottom">
<p>footer</p>
<p>286x15</p>
</th></tr></thead><tbody><tr><td style="text-align: left" valign="top">
<p>Generic</p>
</td><td style="text-align: left" valign="top">
<p>Required</p>
</td><td style="text-align: left" valign="top">
<p>Optional</p>
</td><td style="text-align: left" valign="top">
<p>Not used</p>
</td><td style="text-align: left" valign="top">
<p>Optional</p>
</td><td style="text-align: left" valign="top">
<p>Not used</p>
</td><td style="text-align: left" valign="top">
<p>Not used</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>Boarding pass</p>
</td><td style="text-align: left" valign="top">
<p>Required</p>
</td><td style="text-align: left" valign="top">
<p>Optional</p>
</td><td style="text-align: left" valign="top">
<p>Not used</p>
</td><td style="text-align: left" valign="top">
<p>Not used</p>
</td><td style="text-align: left" valign="top">
<p>Not used</p>
</td><td style="text-align: left" valign="top">
<p>Optional</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>Coupon</p>
</td><td style="text-align: left" valign="top">
<p>Required</p>
</td><td style="text-align: left" valign="top">
<p>Optional</p>
</td><td style="text-align: left" valign="top">
<p>Not used</p>
</td><td style="text-align: left" valign="top">
<p>Not used</p>
</td><td style="text-align: left" valign="top">
<p>Optional</p>
</td><td style="text-align: left" valign="top">
<p>No</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>Event ticket</p>
</td><td rowspan="2" style="text-align: left" valign="middle">
<p>Required</p>
</td><td rowspan="2" style="text-align: left" valign="middle">
<p>Optional</p>
</td><td style="text-align: left" valign="top">
<p>Optional</p>
</td><td style="text-align: left" valign="top">
<p>Optional</p>
</td><td style="text-align: left" valign="top">
<p>Not used</p>
</td><td rowspan="2" style="text-align: left" valign="middle">
<p>Not used</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>(with strip)</p>
</td><td style="text-align: left" valign="top">
<p>Not used</p>
</td><td style="text-align: left" valign="top">
<p>Not used</p>
</td><td style="text-align: left" valign="top">
<p>Optional</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>Store card</p>
</td><td style="text-align: left" valign="middle">
<p>Required</p>
</td><td style="text-align: left" valign="top">
<p>Optional</p>
</td><td style="text-align: left" valign="top">
<p>Not used</p>
</td><td style="text-align: left" valign="top">
<p>Not used</p>
</td><td style="text-align: left" valign="top">
<p>Optional</p>
</td><td style="text-align: left" valign="top">
<p>Not used</p>
</td></tr></tbody></table></div><p>* 90px x 90px is the space available, but the graphic must be either 60px x 90px, or 90px x 60px</p><p>** Allowed size for the strip asset is 312 x 84 for Event tickets, 312 x 110 when a square barcode is used and 312 x 123 otherwise.</p><div class="section" title="Further documentation"><div class="titlepage"><div><div><h3 class="title"><a id="ch01lvl3sec03"/>Further documentation</h3></div></div></div><p>Further details of Pass type layout structures can be found in the Apple Passbook Package Format Reference (Apple Developer account signin required) at:</p><p>
<a class="ulink" href="https://developer.apple.com/library/ios/#documentation/UserExperience/Reference/PassKit_Bundle/Chapters/Introduction.html">https://developer.apple.com/library/ios/#documentation/UserExperience/Reference/PassKit_Bundle/Chapters/Introduction.html#//apple_ref/doc/uid/TP40012026</a>
</p></div></div></div>
<div class="section" title="Signing your Pass (Simple)"><div class="titlepage"><div><div><h1 class="title"><a id="ch01lvl1sec11"/>Signing your Pass (Simple)</h1></div></div></div><p>Now that you have built and customized your Pass, you will need to digitally sign the Pass package contents, so that it will be accepted by the Passbook app.</p><p>We will make use of the certificate and keys generated previously. This will sign the Pass with your developer identity, allowing your Pass to be validated and used with the Passbook app:</p><div class="mediaobject"><img src="graphics/7064OT_01_16.jpg" alt="Signing your Pass (Simple)"/></div><div class="section" title="Getting ready"><div class="titlepage"><div><div><h2 class="title"><a id="ch01lvl2sec18"/>Getting ready</h2></div></div></div><p>The graphical assets for your Pass and the <code class="literal">pass.json</code> file should be in their own folder, with the <code class="literal">.pem</code> files created earlier, in a higher level folder.</p><p>Here is an example of the folder structure:</p></div><div class="section" title="How to do it…"><div class="titlepage"><div><div><h2 class="title"><a id="ch01lvl2sec19"/>How to do it…</h2></div></div></div><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Save the following JSON code into a file called <code class="literal">manifest.json</code>.<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>{</strong></span>
<span class="strong"><strong>  "pass.json":"4f5cef0afe8171f736de367b202ca054abfb3663",</strong></span>
<span class="strong"><strong>  "icon.png":"8c58c1fbf11f944c03b5cd5e41dc6d301263c1f7", "icon@2x.png":"ae3395b5e252610b02d51d52a534c700837ced2d"</strong></span>
<span class="strong"><strong>}</strong></span>
</pre></div></li><li class="listitem">This file should contain a JSON dictionary, where each key is the filename of a contained in your Pass package, and the value is the SHA1 hash of that file. To determine the SHA1 value, open your Terminal App, and enter the following commands:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>cd [Path to the folder containing the Pass package]</strong></span>
<span class="strong"><strong>opensslsha1 *</strong></span>
</pre></div></li><li class="listitem">Place the resulting hash values into the <code class="literal">manifest.json</code> file.</li><li class="listitem">The manifest file then needs to be digitally signed, to produce a signature file, which will verify that the contents of the Pass have not been modified. This can be done using the following Terminal command. (Note that this requires administrator privileges, so you will need to enter your administrator password.):<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>sudo open sslsmime -binary -sign -certfile ../signing/wwdr.pem -signer ../sgning/certificate.pem -inkey ../signing/key.pem -in manifest.json -out signature -outform DER -passin pass:[Pass phrase provided when creating the key.pem]</strong></span>
</pre></div></li><li class="listitem">If your folder differs from the preceding suggestion, you will need to alter the paths to the <code class="literal">.pem</code> files accordingly. </li><li class="listitem">Your package folder should now include:<div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">Graphical assets</li><li class="listitem" style="list-style-type: disc"><code class="literal">pass.json</code></li><li class="listitem" style="list-style-type: disc"><code class="literal">manifest.json</code></li><li class="listitem" style="list-style-type: disc">The <code class="literal">signature</code> file</li></ul></div><p>Place the files in your package folder into a ZIP file. This can be done by selecting all the files and navigating to <span class="strong"><strong>File</strong></span> | <span class="strong"><strong>Compress</strong></span> from the <span class="strong"><strong>Finder</strong></span> menu.</p></li><li class="listitem">Rename the resulting ZIP file to change the file extension to <code class="literal">.pkpass</code>. If you have filenames set to be hidden, you may be changing the filename and not the extension. To show filename extensions, select <span class="strong"><strong>Finder</strong></span> | <span class="strong"><strong>Preferences</strong></span> from the menu and enable <span class="strong"><strong>Show all filename extensions</strong></span>.</li></ol></div><p>Congratulations! You now have a customized and signed Pass.</p></div><div class="section" title="How it works…"><div class="titlepage"><div><div><h2 class="title"><a id="ch01lvl2sec20"/>How it works…</h2></div></div></div><p>The goal of the signing process is to prevent the Pass from being modified by a third party between leaving your servers and being received by the user. When the <code class="literal">manifest.json</code> file is created, each file in the Pass package has its hash value calculated and stored. If the contents of any of the files were to change, its hash value would also change, therefore this <code class="literal">manifest.json</code> file represents an easy way of checking that the Pass package files have not been modified.</p><p>However, this on it's own is not enough, as a third party could modify the <code class="literal">manifest.json</code> file when they modify other files in the package. To guard against this, public/private key encryption is used to produce a signature file from the <code class="literal">manifest.json</code>. Your private key, to which only you have access, was used to generate the file, but anyone with access to the public key can use it to verify that the manifest file hasn't been tampered with.</p><p>Using this process, the user's device can be sure that the source of the Pass it receives is genuine and hasn't been altered in transit.</p><p>Because of this verification, it is important that only files specified in the <code class="literal">manifest.json</code> file are included in the zipped file. Individually selecting the files in Finder, and then choosing compress from the menu, is a good way to ensure this. Be careful if you choose to zip the entire contents of a folder, possibly through a Terminal command, as this can include additional hidden files like <code class="literal">.DS_Store</code>.</p><p>Changing the file extension tells the system that it should be treated as a Pass instead of a regular ZIP file.</p></div><div class="section" title="There's more…"><div class="titlepage"><div><div><h2 class="title"><a id="ch01lvl2sec21"/>There's more…</h2></div></div></div><p>It's important to understand the process and steps involved in signing a Pass, however it is unlikely that it will be feasible to manually perform these steps for every Pass that you create. Instead they should form part of an automated system for producing your user's Passes.</p><p>Pre-built Pass creation implementations are starting to emerge, including this PHPserver code:</p><p>
<a class="ulink" href="https://github.com/tschoffelen/PHP-Passkit">https://github.com/tschoffelen/PHP-Passkit</a>
</p></div></div>
<div class="section" title="Delivering your Pass via e-mail (Medium)"><div class="titlepage"><div><div><h1 class="title"><a id="ch01lvl1sec12"/>Delivering your Pass via e-mail (Medium)</h1></div></div></div><p>Passes can be delivered as an e-mail attachment, allowing the recipient to view the Pass and add it to their Passbook app.</p><div class="section" title="Getting ready"><div class="titlepage"><div><div><h2 class="title"><a id="ch01lvl2sec22"/>Getting ready</h2></div></div></div><p>The Pass e-mail creation script, used below, can be downloaded from the following location:</p><p>
<a class="ulink" href="http://passkit.pro/ruby-email-script">http://passkit.pro/ruby-email-script</a>
</p></div><div class="section" title="How to do it…"><div class="titlepage"><div><div><h2 class="title"><a id="ch01lvl2sec23"/>How to do it…</h2></div></div></div><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Save the following code into a file named <code class="literal">send_pass_by_email.rb</code>.<div class="informalexample"><pre class="programlisting">require 'net/smtp'

# This script accepts the following arguments: recipients name, recipients email address, path to Pass.
# Example usage: 
# ruby send_pass_by_email.rb "Peter Brooke" pbrooke@passkit.pro ../Pass-Example-Generic/Pass-Example-Generic.pkpass

# Retrieve command line arguments
recipientName = ARGV[0]
recipientEmail = ARGV[1]
passFilePath = ARGV[2]

# Setup template email values
senderName = "Passbook Example Company"
senderEmail = "info@passkit.pro" 
emailSubjectText = "New Employee Pass"
emailBodyText = "Please find attached your new employee Pass"

# Setup SMTP settings
smtpDomain = "TO DEFINE. Eg. gmail.com"
smtpLogin = "TO DEFINE. Eg. ......@gmail.com"
smtpPassword = "TO DEFINE" 

# Read file and base64 encode
fileContent = File.read(passFilePath)
encodedContent = [fileContent].pack("m")

# The is used to separate the MIME parts, it can be anything
# as long as it does not appear elsewhere in the email text
boundaryMarker = "SEPARATINGSTRINGNOTFOUNDELSEWHERE"

# Setup the email headers.
headers =&lt;&lt;EOF
From: #{senderName} &lt;#{senderEmail}&gt;
To: #{recipientName} &lt;#{recipientEmail}&gt;
Subject: #{emailSubjectText}
MIME-Version: 1.0
Content-Type: multipart/mixed; boundary=#{boundaryMarker}
--#{boundaryMarker}
EOF

# Setup the email body
body =&lt;&lt;EOF
Content-Type: text/plain
Content-Transfer-Encoding:8bit

#{emailBodyText}
--#{boundaryMarker}
EOF

# Setup the Pass attachment with the correct MIME Encoding
attachment =&lt;&lt;EOF
Content-Type: application/vnd.apple.pkpass; name=\"#{passFilePath}\"
Content-Transfer-Encoding:base64
Content-Disposition: attachment; filename="#{passFilePath}"

#{encodedContent}
--#{boundaryMarker}--
EOF

completeEmail = headers + body + attachment

# Send email using your SMTP settings
smtp = Net::SMTP.new 'smtp.gmail.com', 587
smtp.enable_starttls
smtp.start(smtpDomain, smtpLogin, smtpPassword, :login) do
  smtp.send_message(completeEmail, senderEmail, recipientEmail)
end</pre></div></li><li class="listitem">Under the section headed <span class="strong"><strong># Setup template email values</strong></span>, enter relevant values for the sender name, sender e-mail address, subject, and e-mail body.</li><li class="listitem">Under the section header <span class="strong"><strong># Setup SMTP settings</strong></span>, enter the details of the SMTP e-mail server and account details that will be used to send the e-mail. These can be found from the setting of your e-mail client, or you can use a free e-mail service like Gmail.</li><li class="listitem">This Ruby script accepts three arguments, the recipient's name, the recipient's e-mail address and the path to the Pass to be attached. Open the Terminal and send a Pass-enabled e-mail by calling the script with appropriate arguments, as shown in the following example:<div class="informalexample"><pre class="programlisting">ruby &lt;Path to send_pass_by_email.rb&gt; "Peter Brooke" pbrooke@passkit.pro &lt;Path to Pass to attach .pkpass&gt;</pre></div><p>The following screenshot shows what the resulting e-mail will look like on iOS:</p><p>,</p><div class="mediaobject"><img src="graphics/7064OT_02_01.jpg" alt="How to do it…"/></div><p>
</p></li><li class="listitem">If you sent this e-mail to an e-mail account you have access to, open this e-mail in the Mail app on an iPhone running iOS 6 or Mail on OSX 10.8.2, and you will be given the option to open and view the Pass and add it to Passbook.</li></ol></div></div><div class="section" title="How it works…"><div class="titlepage"><div><div><h2 class="title"><a id="ch01lvl2sec24"/>How it works…</h2></div></div></div><p>The script used above is written in Ruby, as the Ruby interpreter is installed by default on OSX.</p><p>Sending a Pass as an attachment that will be understood by iOS and OSX, and presented to the user, requires it to have a specific MIME Type specified in the attachment. This MIME type is the following:</p><p>application/vnd.apple.pkpass</p><p>This script, or something similar could be used to automate the delivery of Passes to a large number of users, through email.</p></div></div>
<div class="section" title="Delivering your Pass via a web link (Medium)"><div class="titlepage"><div><div><h1 class="title"><a id="ch01lvl1sec13"/>Delivering your Pass via a web link (Medium)</h1></div></div></div><p>You can deliver a Pass to your users by linking to it from your website, for instance, from a confirmation page.</p><div class="section" title="Getting ready"><div class="titlepage"><div><div><h2 class="title"><a id="ch01lvl2sec25"/>Getting ready</h2></div></div></div><p>You will need access to your own web server, or shared hosting space with FTP access. The following instructions are for an Apache web server. Mac OSX does come with an Apache web server built in, which can be used. This used to be available under the <span class="strong"><strong>Sharing</strong></span> menu in <span class="strong"><strong>System Preferences</strong></span>, however since OSX 10.8 it can only be activated by the command line. You can run the following command from the Terminal, to start the web server:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>sudoapachectl start</strong></span>
</pre></div><p>The root for this server can be found at <code class="literal">/Library/WebServer/Documents/</code>.</p><p>The files we will create can be downloaded from the following location:</p><p>
<a class="ulink" href="http://passkit.pro/apache-mime-type">http://passkit.pro/apache-mime-type</a>
</p></div><div class="section" title="How to do it…"><div class="titlepage"><div><div><h2 class="title"><a id="ch01lvl2sec26"/>How to do it…</h2></div></div></div><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Save the following MIME type instruction into a file named <code class="literal">htaccess</code>:<div class="informalexample"><pre class="programlisting">AddType application/vnd.apple.pkpass pkpass</pre></div></li><li class="listitem">Create an HTML page linking to a Pass, shown as follows, and save it as <code class="literal">index.html</code>:<div class="informalexample"><pre class="programlisting">Get your employee pass &lt;a href='Pass-Example-Generic.pkpass'&gt;HERE&lt;/a&gt;</pre></div></li><li class="listitem">Upload your <code class="literal">htaccess</code> file, the <code class="literal">index.html</code> file and the Pass file to a publicly accessible directory on your web sever. If you are running your web server locally, place these files within the web server's root folder.</li><li class="listitem">Rename the <code class="literal">htaccess</code> file to <code class="literal">.htaccess</code>. (The file may disappear, as files starting with a <code class="literal">.</code> are treated as hidden files.)</li><li class="listitem">With Mobile Safari on your iPhone, visit the URL for the <code class="literal">index.html</code> file on your web server.</li><li class="listitem">Follow the link to your Pass and Mobile Safari will display the Pass so it can be added to Passbook.</li></ol></div></div><div class="section" title="How it works…"><div class="titlepage"><div><div><h2 class="title"><a id="ch01lvl2sec27"/>How it works…</h2></div></div></div><p>For the Safari or Mobile Safari browser to understand a Pass file and display it to the user, your Web server needs to present the files with the MIME type of <code class="literal">application/vnd.apple.pkpass</code>.</p><p>The <code class="literal">.htaccess</code> file tells the web server how to treat files in the folder in which resides. In this case it is instructing the web server to inform any visiting web browser that files with the file extension <code class="literal">pkpass</code> are to be treated as Passes. The <code class="literal">.htaccess</code> must be placed in each folder that contains a Pass.</p><p>Only users of a browser that supports this MIME type will be present with the Pass dialog, the rest will be prompted to download the Pass. While Safari and Mobile Safari support Passes, other third party browsers may not. However, the current versions of Chrome on iOS and the in-app browser from the Facebook app do support Pass display.</p></div><div class="section" title="There's more…"><div class="titlepage"><div><div><h2 class="title"><a id="ch01lvl2sec28"/>There's more…</h2></div></div></div><p>If you wish to add server-wide support of the Pass MIME type, you can add an entry to your Apache web server's <code class="literal">mimes.type</code> file, this is located in the <code class="literal">conf</code> directory. Open up the file in a text editor and add the following line in the correct alphabetical position:</p><div class="informalexample"><pre class="programlisting">application/vnd.apple.pkpass pkpass</pre></div><p>You will need to restart the server for this to take effect.</p></div></div>
<div class="section" title="Delivering your Pass via an app (Medium)"><div class="titlepage"><div><div><h1 class="title"><a id="ch01lvl1sec14"/>Delivering your Pass via an app (Medium)</h1></div></div></div><p>Passes can be delivered through a companion iOS app. The app will provide a UI, using Apple's PassKit framework, allowing the user to view a Pass and choose to add it to their Passbook.</p><div class="section" title="Getting ready"><div class="titlepage"><div><div><h2 class="title"><a id="ch01lvl2sec29"/>Getting ready</h2></div></div></div><p>To follow these steps, it is assumed that you have some experience of Objective-C and creating iOS apps.</p><p>The example project, created as follows, can be downloaded from the following location:</p><p>
<a class="ulink" href="http://passkit.pro/example-app">http://passkit.pro/example-app</a>
</p><p>This app does not use <span class="strong"><strong>Automatic Reference Counting</strong></span> (<span class="strong"><strong>ARC</strong></span>), if you are using the code in an ARC environment, remove any calls to releasing objects.</p></div><div class="section" title="How to do it…"><div class="titlepage"><div><div><h2 class="title"><a id="ch01lvl2sec30"/>How to do it…</h2></div></div></div><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Open Xcode and create a new, single view project. The setup options used for the example project are shown in the following screenshot:<div class="mediaobject"><img src="graphics/7064OT_02_02.jpg" alt="How to do it…"/></div></li><li class="listitem">In the Target settings, under <span class="strong"><strong>Build Phases</strong></span>, expand the <span class="strong"><strong>Link Binaries With Libraries</strong></span> section, and click on the <span class="strong"><strong>+</strong></span> button. Search for the PassKit framework and add it. After this, the list of linked libraries should look like this:<div class="mediaobject"><img src="graphics/7064OT_02_03.jpg" alt="How to do it…"/></div></li><li class="listitem">Add your previously created Pass to the project by dragging the file to the project navigator, in the example, this Pass is called <code class="literal">Pass-Example-Generic.pkpass</code>.<div class="informalexample"><pre class="programlisting">In <span class="strong"><strong>PKEViewController.h</strong></span>, replace the existing code with the following:
#import &lt;UIKit/UIKit.h&gt;
#import &lt;PassKit/PassKit.h&gt;

@interface PKEViewController : UIViewController&lt;PKAddPassesViewControllerDelegate&gt;

@property (nonatomic, retain) IBOutletUIButton *addPassButton;

- (IBAction)addPassButtonPressed:(id)sender;

@end</pre></div></li><li class="listitem">In <span class="strong"><strong>PKEViewController.m</strong></span> replace the existing code with the following:<div class="informalexample"><pre class="programlisting">#import "PKEViewController.h"

@interface PKEViewController ()

@property (nonatomic, retain) PKPass *genericPass;

@end

@implementation PKEViewController

- (void)viewDidLoad
{
    [super viewDidLoad];
  // Do any additional setup after loading the view, typically from a nib.

    // Create the PKPass from the bundled file
    // In a real App this may be retrive from the network.

NSString *passFilePath = [[NSBundle mainBundle] pathForResource:@"Pass-Example-Generic" ofType:@"pkpass"];
NSData *passData = [[NSDataalloc] initWithContentsOfFile:passFilePath];
NSError *passError;
    _genericPass = [[PKPass alloc] initWithData:passData error:&amp;passError];
    [passData release];

}

- (void)didReceiveMemoryWarning
{
    [super didReceiveMemoryWarning];
    // Dispose of any resources that can be recreated.
}

- (void)dealloc {

    [_addPassButton release];
    [_genericPass release];

    [super dealloc];
}

#pragma mark - IBAction Methods

- (IBAction)addPassButtonPressed:(id)sender {

    if (![PKPassLibrary isPassLibraryAvailable]) {

NSLog(@"Passbook not available on this device");
        return;

    }

PKAddPassesViewController *addPassViewController = [[PKAddPassesViewController alloc] initWithPass:self.genericPass];
addPassViewController.delegate = self;

    [self presentViewController:addPassViewController animated:YES completion:^{

  NSLog(@"Add Pass view controller presented");

    }];

    [addPassViewController release];
}

#pragma mark - PKAddPassesViewControllerDelegate Methods

- (void)addPassesViewControllerDidFinish:(PKAddPassesViewController *)controller {

    // Check if the Pass is now in the Pass Library

PKPassLibrary *passLibrary = [[PKPassLibrary alloc] init];

    if ([passLibrary containsPass:self.genericPass]) {

        // If the Pass is now in the Library, we can't re-add it, only view it.
        [self.addPassButton setTitle:@"View Pass in Passbook" forState:UIControlStateNormal];

    } 

    [self dismissViewControllerAnimated:YES completion:^{

  NSLog(@"Add Pass view controller dismissed");

    }];

}

@end</pre></div><p>Open <span class="strong"><strong>PKEViewController.xib</strong></span>, place a <code class="literal">UIButton</code> with the title <span class="strong"><strong>Add Pass to Passbook</strong></span> on the view and connect it to <code class="literal">IBOutlet</code> <span class="strong"><strong>addPassButton</strong></span> and IBAction<span class="strong"><strong>addPassButtonPressed</strong></span> for the sent event Touch Up Inside:</p><div class="mediaobject"><img src="graphics/7064OT_02_04.jpg" alt="How to do it…"/></div></li><li class="listitem">Run the project in the iPhone Simulator. Tapping on the<span class="strong"><strong> Add Pass To Passbook</strong></span> button will launch the PassKit UI, which displays the Pass and would allow the user to add the Pass to the Passbook app. At this stage however, the Pass will not be successfully added to the Passbook app as we need to use the correct provisioning profile.</li><li class="listitem">To build the app to an iPhone, we will need an appropriate provisioning profile. Therefore, you need to log in to the Apple Developer Center:<p>
<a class="ulink" href="https://developer.apple.com/account/ios/profile/profileList.action">https://developer.apple.com/account/ios/profile/profileList.action</a>
</p></li><li class="listitem">Under <span class="strong"><strong>Provisioning</strong></span>, click on the <span class="strong"><strong>New Profile</strong></span> button, and follow these steps:</li><li class="listitem">Choose a name for the development profile.</li><li class="listitem">Tick next to your certificate.</li><li class="listitem">Select the App ID in which you enabled Passes and generated certificates for previously.</li><li class="listitem">Choose the devices you will be using.</li><li class="listitem">Click on<span class="strong"><strong> Submit</strong></span>.</li><li class="listitem">Once generated, download the provisioning profile and open it to load it into Xcode.</li><li class="listitem">In <span class="strong"><strong>Target</strong></span> settings, under <span class="strong"><strong>Info</strong></span>, ensure that the Bundle Identifier matches the app ID that was previously created and chosen in the profile creation.</li><li class="listitem">In <span class="strong"><strong>Build Settings</strong></span>, under <span class="strong"><strong>Code Signing Identity</strong></span>, ensure the profile created above is selected under <span class="strong"><strong>Debug</strong></span>.</li><li class="listitem">Build to the device, and test that the presented Pass is successfully added to Passbook.</li></ol></div></div><div class="section" title="How it works…"><div class="titlepage"><div><div><h2 class="title"><a id="ch01lvl2sec31"/>How it works…</h2></div></div></div><p>The example app uses the PassKit framework to present a framework supplied view controller to the user, listen for a delegate callback when the user finishes interacting with the view controller and changes the button's title if the Pass was successfully added to Passbook.</p><p>Using the following code, the <code class="literal">PKPass</code> object is created from a <code class="literal">NSData</code> object:</p><div class="informalexample"><pre class="programlisting">NSString *passFilePath = [[NSBundle mainBundle] pathForResource:@"Pass-Example-Generic" ofType:@"pkpass"];
NSData *passData = [[NSDataalloc] initWithContentsOfFile:passFilePath];
NSError *passError;
_genericPass = [[PKPassalloc] initWithData:passData error:&amp;passError];
[passData release];</pre></div><p>For the sake of simplicity, in this example, the Pass is loaded from a file bundled with the app. It is much more likely in a real-world app that a Pass will be downloaded from a network resource.</p><p>
<code class="literal">PKPassLibrary</code> provides access to the Passes contained in Passbook. It also provides a class method called <code class="literal">isPassLibraryAvailable</code> that will tell you if Passbook exists on that device, for example Passbook is not present on iPads. This method is used in the example app to decide whether to show the Pass view controller.</p><div class="informalexample"><pre class="programlisting">if (![PKPassLibrary isPassLibraryAvailable]) {
    NSLog(@"Passbook not available on this device");
    return;       
}</pre></div></div><div class="section" title="There's more…"><div class="titlepage"><div><div><h2 class="title"><a id="ch01lvl2sec32"/>There's more…</h2></div></div></div><p>Further documentation of the PassKit framework can be found in the following location:</p><p>
<a class="ulink" href="https://developer.apple.com/library/ios/#documentation/UserExperience/Reference/PassKit_Framework/">https://developer.apple.com/library/ios/#documentation/UserExperience/Reference/PassKit_Framework/</a>
</p></div></div>
<div class="section" title="Updating a Pass within the Passbook app (Advanced)"><div class="titlepage"><div><div><h1 class="title"><a id="ch01lvl1sec15"/>Updating a Pass within the Passbook app (Advanced)</h1></div></div></div><p>Apple provides a mechanism for updating a Pass that has been added to Passbook by a user. This process involves sending a push notification to the user's device, and implementing a REST API that will respond to the device's requests and provide the relevant updated Pass information.</p><div class="section" title="Getting ready"><div class="titlepage"><div><div><h2 class="title"><a id="ch01lvl2sec33"/>Getting ready</h2></div></div></div><p>The first stage in updating a Pass is to send a Push Notification to the user's device to prompt the Pass update process. The process for sending <span class="strong"><strong>Apple Push Notifications</strong></span> (<span class="strong"><strong>APNs</strong></span>) is outside the scope for this book, and the assumption will made that the facility to send the appropriate APN is available. Further information on APNs can be found in Apple's documentation:</p><p>
<a class="ulink" href="https://developer.apple.com/library/ios/#documentation/NetworkingInternet/Conceptual/RemoteNotificationsPG/Introduction/Introduction.html">https://developer.apple.com/library/ios/#documentation/NetworkingInternet/Conceptual/RemoteNotificationsPG/Introduction/Introduction.html</a>
</p><p>In implementing the required REST API, we will be making use of the GIT source control management tool. If you don't already have GIT installed and setup, follow the GitHub tutorial:</p><p>
<a class="ulink" href="https://help.github.com/articles/set-up-git">https://help.github.com/articles/set-up-git</a>
</p></div><div class="section" title="How to do it…"><div class="titlepage"><div><div><h2 class="title"><a id="ch01lvl2sec34"/>How to do it…</h2></div></div></div><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Open Terminal and change the directory to the directory that is to contain the server code.</li><li class="listitem">We will be using the open source example Passbook server built in Ruby on Rails by Mattt Thompson (<a class="ulink" href="https://github.com/mattt">https://github.com/mattt</a>), so we first need to clone the server code from the repository, with the following command:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>git clone https://github.com/keefmoon/passbook_rails_example.git</strong></span>
</pre></div></li><li class="listitem">You will need to install Xcode command-line tools, you can do this by opening Xcode and on the menu, going to <span class="strong"><strong>Xcode</strong></span> | <span class="strong"><strong>Preferences</strong></span> | <span class="strong"><strong>Download</strong></span> and clicking on <span class="strong"><strong>Install</strong></span> next to <span class="strong"><strong>Command Line Tools</strong></span>.</li><li class="listitem">Change to the directory containing the code and prepare the Ruby App:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>cd passbook_rails_example</strong></span>
<span class="strong"><strong>bundle</strong></span>
</pre></div></li><li class="listitem">If you get an error related to Postgres, use the following command to install it separately and run the <code class="literal">bundle</code> command again. (This command will require administrator access.)<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>sudo env ARCHFLAGS="-arch x86_64" gem install pg</strong></span>
</pre></div></li><li class="listitem">Depending on the version of Ruby installed, you may have an extra command to enter. Mountain Lion comes bundled with Ruby 1.8.7 and will require the extra command, but if you have updated to version 1.9.2 or greater, then the following command is not required. (Administration access will be required.):<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>sudo gem installrdoc-data</strong></span>
<span class="strong"><strong>sudo rdoc-data --install</strong></span>
</pre></div></li><li class="listitem">Open <code class="literal">[path to server code]/db/seeds.rb</code> in a text editor. The content in this file will be used to populate the database initially, therefore replace the example data with details that match your previously created Pass, ensure that the pass type identifier and serial number are correct, but change at least one part of the Pass data. In the following example, I have changed Peter Brooke's job title from <code class="literal">Chief Pass Creator</code>, to <code class="literal">CTO</code>.<div class="informalexample"><pre class="programlisting">pass = Passbook::Pass.create(pass_type_identifier: "pass.pro.passkit.example.generic", serial_number: "0000001", authentication_token: "UniqueAuthTokenABCD1234")
pass.data = {
  staffName: "Peter Brooke",
  telephoneExt: "9779",
  jobTitle: "CTO",
  managersName: "Paul Bailey",
  managersExt: "9673",
  expiryDate: "2013-12-31T00:00-23:59"
}
pass.save

pass.registrations.create(device_library_identifier: "123456789", push_token: "00000000 00000000 00000000 00000000 00000000 00000000 00000000 00000000")</pre></div></li><li class="listitem">In the <code class="literal">seeds.rb</code> file, specify a unique authentication token for each Pass you add. in the preceding example <span class="strong"><strong>UniqueAuthTokenABCD1234</strong></span> is used, although this would be automatically generated in a real-world use.</li><li class="listitem">Deploying this server code to the free Heroku service is the quickest and easiest way to make it available for testing. Visit <a class="ulink" href="http://www.heroku.com">http://www.heroku.com</a> and sign up for an account.</li><li class="listitem">Download and install the HerokuToolbelt for OSX:<div class="mediaobject"><img src="graphics/7064OT_02_05.jpg" alt="How to do it…"/></div></li><li class="listitem">Open Terminal and log in to Heroku. Then create a new Heroku App and push the server code to it. Heroku will generate a name for your App; for example <a class="ulink" href="http://frozen-bayou-9500.herokuapp.com/">http://frozen-bayou-9500.herokuapp.com/</a>.<div class="informalexample"><pre class="programlisting">heroku create
git push heroku master
heroku run rake db:createdb:migratedb:seed</pre></div></li><li class="listitem">For the Passes we have previously created to update using the server, we need to include the relevant information in the Pass. (In the following code sample, note that the sample web server has the additional path component of <code class="literal">passbook</code> in the <code class="literal">webServiceURL.</code>) Open the <code class="literal">pass.json</code> previously created and add two top-level keys with the relevant values, reproduce the <code class="literal">manifest.json</code>, reproduce the <code class="literal">signature</code> file, and re-zip the package files.<div class="informalexample"><pre class="programlisting">"authenticationToken" : "UniqueAuthTokenABCD1234",
"webServiceURL" : "http://frozen-bayou-9500.herokuapp.com/passbook",</pre></div></li></ol></div></div><div class="section" title="How it works…"><div class="titlepage"><div><div><h2 class="title"><a id="ch01lvl2sec35"/>How it works…</h2></div></div></div><p>The server we have implemented above is to facilitate the Pass update process, which involves back and forth communication between the user's device and your server.</p><p>When a user adds a Pass to Passbook that contains <code class="literal">webServiceURL</code> and <code class="literal">authenticationToken</code> keys, the device registers with your server, passing a device library ID that is used to authenticate further communication, the authentication token to authenticate this initial communication, and a push token to be used when sending an APN.</p><p>When information contained in the Pass changes, in our example this may be Peter Brooke being promoted, your server sends an APN to the device, using the push token it received. (The sending of this push notification is outside the scope of this book.) This prompts the device to ask your server for a list of all the updated Passes since it last asked. From this list, the device asks for updated information for each of the Passes in turn. Finally, the server responds with the updated Pass information and the updated Pass is presented to the user.</p></div><div class="section" title="There's more…"><div class="titlepage"><div><div><h2 class="title"><a id="ch01lvl2sec36"/>There's more…</h2></div></div></div><p>Further information on the Pass update process can be found in the Apple documentation:</p><p>
<a class="ulink" href="https://developer.apple.com/library/ios/#documentation/UserExperience/Conceptual/PassKit_PG/Chapters/Updating.html">https://developer.apple.com/library/ios/#documentation/UserExperience/Conceptual/PassKit_PG/Chapters/Updating.html</a>
</p><p>There is also a full specification for the REST API that the server above implements:</p><p>
<a class="ulink" href="https://developer.apple.com/library/ios/#documentation/PassKit/Reference/PassKit_WebService/WebService.html">https://developer.apple.com/library/ios/#documentation/PassKit/Reference/PassKit_WebService/WebService.html</a>
</p><p>When testing the web service endpoints in a browser, it is necessary to include the following request header in addition to any authorization header described in the specification:</p><div class="informalexample"><pre class="programlisting">Accept: application/json</pre></div><p>In a live production setting, the web service must use HTTPS, however you can allow Passbook on your device to use HTTP for development testing. If your device has been enabled for development using Xcode, you will have an additional <span class="strong"><strong>Developer</strong></span> section under the app settings. In the <span class="strong"><strong>Developer</strong></span> section, under <span class="strong"><strong>PassKit Testing</strong></span>, switch on <span class="strong"><strong>Allow HTTP Services</strong></span>:</p><div class="mediaobject"><img src="graphics/7064OT_02_06.jpg" alt="There's more…"/></div></div></div></body></html>