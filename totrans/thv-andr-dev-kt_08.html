<html><head></head><body>
<div id="_idContainer052" class="calibre2">
<h1 class="chapter-number" id="_idParaDest-125"><a id="_idTextAnchor126" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.1.1">6</span></h1>
<h1 id="_idParaDest-126" class="calibre5"><a id="_idTextAnchor127" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.2.1">Adding Video and Editing Functionality to Packtagram</span></h1>
<p class="calibre3"><span class="kobospan" id="kobo.3.1">Having already mastered the art of capturing stunning photographs and applying mesmerizing filters with CameraX, it’s time to elevate our Packtagram app to new heights. </span><span class="kobospan" id="kobo.3.2">Now, we will embark on an exciting new venture: diving into the world </span><span><span class="kobospan" id="kobo.4.1">of video.</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.5.1">Videos are not just moving pictures; they are powerful storytelling tools that breathe life into our apps. </span><span class="kobospan" id="kobo.5.2">They create dynamic interactions, keeping users engaged and offering them a canvas to express creativity. </span><span class="kobospan" id="kobo.5.3">In this chapter, we’ll guide you through the process of integrating video capabilities into your app, akin to adding a new dimension to the Instagram-like experience we have </span><span><span class="kobospan" id="kobo.6.1">been crafting.</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.7.1">We will start by exploring how to capture high-quality videos using the CameraX library, an extension of the skills you’ve already honed for photo capture. </span><span class="kobospan" id="kobo.7.2">Then, we’ll delve</span><a id="_idIndexMarker656" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.8.1"> into the world of </span><strong class="bold"><span class="kobospan" id="kobo.9.1">Fast Forward Moving Picture Expert Group</span></strong><span class="kobospan" id="kobo.10.1"> (</span><strong class="bold"><span class="kobospan" id="kobo.11.1">Ffmpeg</span></strong><span class="kobospan" id="kobo.12.1">), a robust library for video processing, to add layers of creativity to your videos – from simple captions that convey messages to sophisticated filters that transform the </span><span><span class="kobospan" id="kobo.13.1">visual mood.</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.14.1">You’ll learn to not only capture and edit videos but also to efficiently upload them to Firebase Storage, ensuring that your app can handle large files seamlessly and provide a smooth </span><span><span class="kobospan" id="kobo.15.1">user experience.</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.16.1">By the end of this chapter, you will have added a significant feature to your app, making it not just a photo-sharing platform but a comprehensive </span><span><span class="kobospan" id="kobo.17.1">multimedia experience.</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.18.1">To accomplish that, in this chapter, we will cover the </span><span><span class="kobospan" id="kobo.19.1">following topics:</span></span></p>
<ul class="calibre15">
<li class="calibre14"><span class="kobospan" id="kobo.20.1">Adding video functionality to </span><span><span class="kobospan" id="kobo.21.1">our app</span></span></li>
<li class="calibre14"><span class="kobospan" id="kobo.22.1">Getting to </span><span><span class="kobospan" id="kobo.23.1">know FFmpeg</span></span></li>
<li class="calibre14"><span class="kobospan" id="kobo.24.1">Adding a caption to a video </span><span><span class="kobospan" id="kobo.25.1">with FFmpeg</span></span></li>
<li class="calibre14"><span class="kobospan" id="kobo.26.1">Adding a filter to a video </span><span><span class="kobospan" id="kobo.27.1">with FFmpeg</span></span></li>
<li class="calibre14"><span class="kobospan" id="kobo.28.1">Uploading </span><span><span class="kobospan" id="kobo.29.1">the video</span></span></li>
</ul>
<h1 id="_idParaDest-127" class="calibre5"><a id="_idTextAnchor128" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.30.1">Technical requirements</span></h1>
<p class="calibre3"><span class="kobospan" id="kobo.31.1">As in the previous chapter, you will need to have installed Android Studio (or another editor of </span><span><span class="kobospan" id="kobo.32.1">your preference).</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.33.1">You can find the complete code that we will be using in this chapter in this book’s GitHub </span><span><span class="kobospan" id="kobo.34.1">repository: </span></span><a href="https://github.com/PacktPublishing/Thriving-in-Android-Development-using-Kotlin/tree/main/Chapter-6" class="calibre6 pcalibre1 pcalibre"><span><span class="kobospan" id="kobo.35.1">https://github.com/PacktPublishing/Thriving-in-Android-Development-using-Kotlin/tree/main/Chapter-6</span></span></a><span><span class="kobospan" id="kobo.36.1">.</span></span></p>
<h1 id="_idParaDest-128" class="calibre5"><a id="_idTextAnchor129" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.37.1">Adding video functionality to our app</span></h1>
<p class="calibre3"><span class="kobospan" id="kobo.38.1">In this section, we will extend</span><a id="_idIndexMarker657" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.39.1"> the functionality</span><a id="_idIndexMarker658" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.40.1"> of our Android app so that it includes video-capturing capabilities through CameraX. </span><span class="kobospan" id="kobo.40.2">This powerful library not only simplifies the process of capturing photos but also provides an efficient way to record videos. </span><span class="kobospan" id="kobo.40.3">We’ll start by adapting our existing CameraX setup, which is designed for capturing photos, to also handle video recording. </span><span class="kobospan" id="kobo.40.4">The aim is to provide a seamless integration, maintaining the simplicity and robustness </span><span><span class="kobospan" id="kobo.41.1">of CameraX.</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.42.1">First, we need to set up the preview for the video recording. </span><span class="kobospan" id="kobo.42.2">In the previous chapter, we created a </span><strong class="source-inline"><span class="kobospan" id="kobo.43.1">CameraPreview</span></strong><span class="kobospan" id="kobo.44.1"> composable. </span><span class="kobospan" id="kobo.44.2">We’ll reuse the same </span><span><span class="kobospan" id="kobo.45.1">composable here:</span></span></p>
<pre class="source-code"><span class="kobospan1" id="kobo.46.1">
@Composable
fun CameraPreview(cameraController:
LifecycleCameraController, modifier: Modifier = Modifier) {
    AndroidView(
        factory = { context -&gt;
            PreviewView(context).apply {
                implementationMode =
                  PreviewView.ImplementationMode.COMPATIBLE
            }
        },
        modifier = modifier,
        update = { previewView -&gt;
            previewView.controller = cameraController
        }
    )
}</span></pre> <p class="calibre3"><span class="kobospan" id="kobo.47.1">Now, we need to create</span><a id="_idIndexMarker659" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.48.1"> a new button composable to record images</span><a id="_idIndexMarker660" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.49.1"> and sound from the preview (instead of just capturing </span><span><span class="kobospan" id="kobo.50.1">the image):</span></span></p>
<pre class="source-code"><span class="kobospan1" id="kobo.51.1">
@Composable
fun CaptureVideoButton(
    cameraController: LifecycleCameraController,
    onRecordingFinished: (String) -&gt; Unit,
) {
    val context = LocalContext.current
    val recording = remember {
        mutableStateOf&lt;Recording?&gt;(null) }
    IconButton(
        onClick = {
            cameraController.setEnabledUseCases(
                LifecycleCameraController.VIDEO_CAPTURE)
            if (recording.value == null) {
                recording.value =
                    startRecording(cameraController,
                        context, onRecordingFinished)
            } else {
                stopRecording(recording.value)
                recording.value = null
            }
        },
        modifier = Modifier
            .size(60.dp)
            .padding(8.dp),
    ) {
        Icon(
            painter = if (recording.value == null)
                painterResource(id =
                    R.drawable.ic_videocam) else
                        painterResource(id =
                            R.drawable.ic_stop),
            contentDescription = "Capture video",
            tint = MaterialTheme.colorScheme.onPrimary
        )
    }
}</span></pre> <p class="calibre3"><span class="kobospan" id="kobo.52.1">Here, we are creating a new composable called </span><strong class="source-inline"><span class="kobospan" id="kobo.53.1">CaptureVideoButton</span></strong><span class="kobospan" id="kobo.54.1">. </span><span class="kobospan" id="kobo.54.2">It is similar to the </span><strong class="source-inline"><span class="kobospan" id="kobo.55.1">CaptureButton</span></strong><span class="kobospan" id="kobo.56.1"> composable but with some modifications. </span><span class="kobospan" id="kobo.56.2">For example, now, we’ll need to create a variable recording. </span><span class="kobospan" id="kobo.56.3">The </span><strong class="source-inline"><span class="kobospan" id="kobo.57.1">Recording</span></strong><span class="kobospan" id="kobo.58.1"> class in CameraX is responsible for managing an active video recording session. </span><span class="kobospan" id="kobo.58.2">It encapsulates the state and operations needed to start, pause, resume, and stop the recording. </span><span class="kobospan" id="kobo.58.3">In our code, the </span><strong class="source-inline"><span class="kobospan" id="kobo.59.1">recording</span></strong><span class="kobospan" id="kobo.60.1"> variable will be used to manage the current </span><span><span class="kobospan" id="kobo.61.1">recording session.</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.62.1">Once the user clicks the button, we’ll configure the video capture use case, </span><strong class="source-inline"><span class="kobospan" id="kobo.63.1">cameraController.setEnabledUseCases(LifecycleCameraController.VIDEO_CAPTURE)</span></strong><span class="kobospan" id="kobo.64.1">, so that </span><strong class="source-inline"><span class="kobospan" id="kobo.65.1">cameraController</span></strong><span class="kobospan" id="kobo.66.1"> can start and manage the video recording process, ensuring that the camera is correctly set up for capturing high-quality video and enabling the necessary configurations and resources for the recording session to proceed smoothly. </span><span class="kobospan" id="kobo.66.2">Then, if a recording hasn’t been already initiated, we’ll start a new recording. </span><span class="kobospan" id="kobo.66.3">If it has already been initiated, we’ll </span><span><span class="kobospan" id="kobo.67.1">stop it.</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.68.1">The icon of the button</span><a id="_idIndexMarker661" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.69.1"> will show a camera prior to the recording</span><a id="_idIndexMarker662" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.70.1"> being initiated and a stop button if the recording is already in progress, to indicate to the user that they should click it to stop </span><span><span class="kobospan" id="kobo.71.1">the recording.</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.72.1">To finish this recording functionality, we need to implement the </span><span><strong class="source-inline"><span class="kobospan" id="kobo.73.1">startRecording</span></strong></span><span><span class="kobospan" id="kobo.74.1"> function:</span></span></p>
<pre class="source-code"><span class="kobospan1" id="kobo.75.1">
@SuppressLint("MissingPermission")
private fun startRecording(
    cameraController: LifecycleCameraController,
    context: Context,
    onRecordingFinished: (String) -&gt; Unit
): Recording {
    val videoFile = File(context.filesDir,
        "video_${System.currentTimeMillis()}.mp4")
    val outputOptions =
        FileOutputOptions.Builder(videoFile).build()
    val audioConfig = AudioConfig.create(true)
    val executor = Executors.newSingleThreadExecutor()
    return cameraController.startRecording(
        outputOptions,
        audioConfig,
        executor
    ) { recordEvent -&gt;
        when (recordEvent) {
            is VideoRecordEvent.Finalize -&gt; {
                if (recordEvent.hasError()) {
                    Log.e("CaptureVideoButton",
                        "Video recording error:
                            ${recordEvent.error}")
                } else {
                    onRecordingFinished(
                        videoFile.absolutePath)
                }
            }
        }
    }
}</span></pre> <p class="calibre3"><span class="kobospan" id="kobo.76.1">This function is marked</span><a id="_idIndexMarker663" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.77.1"> with the </span><strong class="source-inline"><span class="kobospan" id="kobo.78.1">@SuppressLint("MissingPermission")</span></strong><span class="kobospan" id="kobo.79.1"> annotation, indicating</span><a id="_idIndexMarker664" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.80.1"> an assumption that the necessary runtime permissions, such as access to the camera and microphone, have already been granted. </span><span class="kobospan" id="kobo.80.2">We will handle these permissions the same way we did with the photo capture, so the annotation is safe to use here as the permissions would have already </span><span><span class="kobospan" id="kobo.81.1">been granted.</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.82.1">The function begins by defining the location and filename for the video recording. </span><span class="kobospan" id="kobo.82.2">It uses the </span><strong class="source-inline"><span class="kobospan" id="kobo.83.1">File</span></strong><span class="kobospan" id="kobo.84.1"> class to create a reference to a </span><strong class="source-inline"><span class="kobospan" id="kobo.85.1">video_${System.currentTimeMillis()}.mp4</span></strong><span class="kobospan" id="kobo.86.1"> file, which is stored in the app-specific directory on the external storage. </span><span class="kobospan" id="kobo.86.2">This approach to file storage is advantageous as it does not require additional permissions and ensures that the stored data is private to </span><span><span class="kobospan" id="kobo.87.1">the application.</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.88.1">Next, the code sets up </span><strong class="source-inline"><span class="kobospan" id="kobo.89.1">FileOutputOptions</span></strong><span class="kobospan" id="kobo.90.1"> using the previously defined file. </span><span class="kobospan" id="kobo.90.2">This step is crucial as it configures how the recorded video data will be written to the filesystem. </span><span class="kobospan" id="kobo.90.3">The </span><strong class="source-inline"><span class="kobospan" id="kobo.91.1">FileOutputOptions</span></strong><span class="kobospan" id="kobo.92.1"> class, part of the CameraX library, offers an intuitive API to set these parameters efficiently – for example, it allows us to specify the video location using </span><strong class="source-inline"><span class="kobospan" id="kobo.93.1">ContentResolver</span></strong><span class="kobospan" id="kobo.94.1"> (you can find additional information about </span><strong class="source-inline"><span class="kobospan" id="kobo.95.1">FileOutputOptions</span></strong><span class="kobospan" id="kobo.96.1"> here: </span><a href="https://developer.android.com/reference/androidx/camera/video/FileOutputOptions" class="calibre6 pcalibre1 pcalibre"><span class="kobospan" id="kobo.97.1">https://developer.android.com/reference/androidx/camera/video/FileOutputOptions</span></a><span class="kobospan" id="kobo.98.1">). </span><span class="kobospan" id="kobo.98.2">Next, the audio configuration</span><a id="_idIndexMarker665" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.99.1"> is created, in this case to allow audio </span><span><span class="kobospan" id="kobo.100.1">using </span></span><span><strong class="source-inline"><span class="kobospan" id="kobo.101.1">AudioConfig.create(true)</span></strong></span><span><span class="kobospan" id="kobo.102.1">.</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.103.1">Then, an executor is created using </span><strong class="source-inline"><span class="kobospan" id="kobo.104.1">Executors.newSingleThreadExecutor()</span></strong><span class="kobospan" id="kobo.105.1">, which facilitates the execution of tasks in a background thread, thereby keeping the UI thread unblocked and responsive. </span><span class="kobospan" id="kobo.105.2">With these parameters defined (</span><strong class="source-inline"><span class="kobospan" id="kobo.106.1">fileOutputOptions</span></strong><span class="kobospan" id="kobo.107.1">, </span><strong class="source-inline"><span class="kobospan" id="kobo.108.1">AudioConfig</span></strong><span class="kobospan" id="kobo.109.1">, and </span><strong class="source-inline"><span class="kobospan" id="kobo.110.1">Executor</span></strong><span class="kobospan" id="kobo.111.1">), we can execute the </span><strong class="source-inline"><span class="kobospan" id="kobo.112.1">cameraController.startRecording</span></strong><span class="kobospan" id="kobo.113.1"> function, which will initiate </span><span><span class="kobospan" id="kobo.114.1">the recording.</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.115.1">Additionally, an event listener is defined using the </span><strong class="source-inline"><span class="kobospan" id="kobo.116.1">Consumer&lt;VideoRecordEvent&gt;</span></strong><span class="kobospan" id="kobo.117.1"> interface. </span><span class="kobospan" id="kobo.117.2">This listener uses a </span><strong class="source-inline"><span class="kobospan" id="kobo.118.1">when</span></strong><span class="kobospan" id="kobo.119.1"> statement to handle different types of </span><strong class="source-inline"><span class="kobospan" id="kobo.120.1">VideoRecordEvent</span></strong><span class="kobospan" id="kobo.121.1">, such as </span><strong class="source-inline"><span class="kobospan" id="kobo.122.1">VideoRecordEvent.Finalize</span></strong><span class="kobospan" id="kobo.123.1">, which indicates the completion of the recording. </span><span class="kobospan" id="kobo.123.2">The event listener also checks for errors during the recording process, ensuring robust </span><span><span class="kobospan" id="kobo.124.1">error handling.</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.125.1">Then, a </span><strong class="source-inline"><span class="kobospan" id="kobo.126.1">Recording</span></strong><span class="kobospan" id="kobo.127.1"> object</span><a id="_idIndexMarker666" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.128.1"> is returned, representing the ongoing</span><a id="_idIndexMarker667" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.129.1"> recording session. </span><span class="kobospan" id="kobo.129.2">This recording object is crucial for the </span><span><span class="kobospan" id="kobo.130.1">next step.</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.131.1">Now, let’s implement the </span><span><strong class="source-inline"><span class="kobospan" id="kobo.132.1">stopRecording</span></strong></span><span><span class="kobospan" id="kobo.133.1"> function:</span></span></p>
<pre class="source-code"><span class="kobospan1" id="kobo.134.1">
fun stopRecording(recording: Recording?) {
    recording?.stop()
}</span></pre> <p class="calibre3"><span class="kobospan" id="kobo.135.1">In this concise and straightforward function, we only have one line of code, but it does something essential. </span><span class="kobospan" id="kobo.135.2">The function takes a single parameter, </span><strong class="source-inline"><span class="kobospan" id="kobo.136.1">recording</span></strong><span class="kobospan" id="kobo.137.1">, which is our instance of the </span><strong class="source-inline"><span class="kobospan" id="kobo.138.1">Recording</span></strong><span class="kobospan" id="kobo.139.1"> class from the </span><span><span class="kobospan" id="kobo.140.1">CameraX library.</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.141.1">The core action in this function is to invocate </span><strong class="source-inline"><span class="kobospan" id="kobo.142.1">stop()</span></strong><span class="kobospan" id="kobo.143.1"> on the </span><strong class="source-inline"><span class="kobospan" id="kobo.144.1">recording</span></strong><span class="kobospan" id="kobo.145.1"> object. </span><span class="kobospan" id="kobo.145.2">When this method is called, it tells the </span><strong class="source-inline"><span class="kobospan" id="kobo.146.1">recording</span></strong><span class="kobospan" id="kobo.147.1"> instance to terminate the current video recording session. </span><span class="kobospan" id="kobo.147.2">This involves stopping video frames from being captured and finalizing the video file that’s being recorded. </span><span class="kobospan" id="kobo.147.3">The video file is then saved to the location that’s specified when the recording </span><span><span class="kobospan" id="kobo.148.1">has finished.</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.149.1">Now, we will include</span><a id="_idIndexMarker668" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.150.1"> the new button in </span><strong class="source-inline"><span class="kobospan" id="kobo.151.1">CaptureModeContent</span></strong><span class="kobospan" id="kobo.152.1">, which we built</span><a id="_idIndexMarker669" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.153.1"> previously for the </span><span><span class="kobospan" id="kobo.154.1">capture feature:</span></span></p>
<pre class="source-code"><span class="kobospan1" id="kobo.155.1">
@Composable
private fun CaptureModeContent(
    cameraController: LifecycleCameraController,
    onImageCaptured: (Bitmap) -&gt; Any,
    onVideoCaptured: (String) -&gt; Any
) {
    Box(modifier = Modifier.fillMaxSize()) {
        CameraPermissionRequester {
            Box(
                contentAlignment = Alignment.BottomCenter,
                modifier = Modifier.fillMaxSize()
            ) {
                CameraPreview(...)
                Row {
                    CaptureButton(...)
                    CaptureVideoButton(
                       cameraController =
                           cameraController,
                       onRecordingFinished = { videoPath -&gt;
                           onVideoCaptured(videoPath)
                       }
                    )
                }
            }
        }
    }
}</span></pre> <p class="calibre3"><span class="kobospan" id="kobo.156.1">Here, we have added</span><a id="_idIndexMarker670" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.157.1"> a </span><strong class="source-inline"><span class="kobospan" id="kobo.158.1">Row</span></strong><span class="kobospan" id="kobo.159.1"> composable to show both buttons horizontally</span><a id="_idIndexMarker671" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.160.1"> side by side. </span><span class="kobospan" id="kobo.160.2">We have also added a new Lambda (</span><strong class="source-inline"><span class="kobospan" id="kobo.161.1">onVideoCaptured</span></strong><span class="kobospan" id="kobo.162.1">) that we will use to pass the video file path when the recording </span><span><span class="kobospan" id="kobo.163.1">has finished.</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.164.1">With these changes, we should be able to see the newly </span><span><span class="kobospan" id="kobo.165.1">implemented button:</span></span></p>
<div class="calibre2">
<div class="img---figure" id="_idContainer046">
<span class="kobospan" id="kobo.166.1"><img alt="Figure 6.1: The video capture button already integrated into the StoryContent screen when the video is not being recorded" src="image/B19443_06_01.jpg" class="calibre4"/></span>
</div>
</div>
<p class="img---caption" lang="en-US" xml:lang="en-US"><span class="kobospan" id="kobo.167.1">Figure 6.1: The video capture button already integrated into the StoryContent screen when the video is not being recorded</span></p>
<p class="calibre3"><span class="kobospan" id="kobo.168.1">When we click the video capture button, we should see its icon change to the </span><span><span class="kobospan" id="kobo.169.1">stop symbol:</span></span></p>
<div class="calibre2">
<div class="img---figure" id="_idContainer047">
<span class="kobospan" id="kobo.170.1"><img alt="Figure 6.2: Video recording in progress" src="image/B19443_06_02.jpg" class="calibre4"/></span>
</div>
</div>
<p class="img---caption" lang="en-US" xml:lang="en-US"><span class="kobospan" id="kobo.171.1">Figure 6.2: Video recording in progress</span></p>
<p class="calibre3"><span class="kobospan" id="kobo.172.1">And with this, we are ready </span><a id="_idIndexMarker672" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.173.1">to record</span><a id="_idIndexMarker673" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.174.1"> our videos using CameraX! </span><span class="kobospan" id="kobo.174.2">Now, it is time for us to learn how to modify or edit the recorded videos. </span><span class="kobospan" id="kobo.174.3">With these aspects in mind, let me introduce you to the </span><span><span class="kobospan" id="kobo.175.1">FFmpeg library.</span></span></p>
<h1 id="_idParaDest-129" class="calibre5"><a id="_idTextAnchor130" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.176.1">Getting to know FFmpeg</span></h1>
<p class="calibre3"><strong class="bold"><span class="kobospan" id="kobo.177.1">FFmpeg</span></strong><span class="kobospan" id="kobo.178.1"> is an open-source multimedia framework</span><a id="_idIndexMarker674" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.179.1"> that has become a cornerstone in the world of audio and video processing. </span><span class="kobospan" id="kobo.179.2">Renowned for its versatility and power, FFmpeg offers a comprehensive suite of libraries and tools to handle video, audio, and other multimedia files and streams. </span><span class="kobospan" id="kobo.179.3">At its core, FFmpeg is a command-line tool, enabling users to convert media files from one format into another, manipulate video and audio recordings, and perform a wide array of other multimedia </span><span><span class="kobospan" id="kobo.180.1">processing tasks.</span></span></p>
<p class="callout-heading"><span class="kobospan" id="kobo.181.1">Note</span></p>
<p class="callout"><span class="kobospan" id="kobo.182.1">You can find</span><a id="_idIndexMarker675" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.183.1"> the official FFmpeg documentation </span><span><span class="kobospan" id="kobo.184.1">here: </span></span><a href="https://ffmpeg.org/" class="calibre6 pcalibre1 pcalibre"><span><span class="kobospan" id="kobo.185.1">https://ffmpeg.org/</span></span></a><span><span class="kobospan" id="kobo.186.1">.</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.187.1">Through the following subsections, we will learn what components are part of FFmpeg, its key features, and how to integrate this powerful library in our </span><span><span class="kobospan" id="kobo.188.1">Android apps.</span></span></p>
<h2 id="_idParaDest-130" class="calibre7"><a id="_idTextAnchor131" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.189.1">The components of FFmpeg</span></h2>
<p class="calibre3"><span class="kobospan" id="kobo.190.1">The FFmpeg project is composed</span><a id="_idIndexMarker676" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.191.1"> of several components, each serving a specific role in </span><span><span class="kobospan" id="kobo.192.1">multimedia processing:</span></span></p>
<ul class="calibre15">
<li class="calibre14"><strong class="source-inline1"><span class="kobospan" id="kobo.193.1">libavcodec</span></strong><span class="kobospan" id="kobo.194.1">: A library containing decoders and encoders for </span><span><span class="kobospan" id="kobo.195.1">audio/video codecs</span></span></li>
<li class="calibre14"><strong class="source-inline1"><span class="kobospan" id="kobo.196.1">libavformat</span></strong><span class="kobospan" id="kobo.197.1">: This library deals with the container formats, managing the multiplexing and demultiplexing aspects of </span><span><span class="kobospan" id="kobo.198.1">multimedia streams</span></span></li>
<li class="calibre14"><strong class="source-inline1"><span class="kobospan" id="kobo.199.1">libavutil</span></strong><span class="kobospan" id="kobo.200.1">: A utility library that provides a range of helper functions and </span><span><span class="kobospan" id="kobo.201.1">data structures</span></span></li>
<li class="calibre14"><strong class="source-inline1"><span class="kobospan" id="kobo.202.1">libavfilter</span></strong><span class="kobospan" id="kobo.203.1">: Used for applying various audio and </span><span><span class="kobospan" id="kobo.204.1">video filters</span></span></li>
<li class="calibre14"><strong class="source-inline1"><span class="kobospan" id="kobo.205.1">libswscale</span></strong><span class="kobospan" id="kobo.206.1">: Dedicated to handling</span><a id="_idIndexMarker677" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.207.1"> image scaling and color </span><span><span class="kobospan" id="kobo.208.1">format conversions</span></span></li>
</ul>
<p class="calibre3"><span class="kobospan" id="kobo.209.1">Together, these components provide a robust foundation for handling a wide array of multimedia </span><span><span class="kobospan" id="kobo.210.1">processing tasks.</span></span></p>
<h2 id="_idParaDest-131" class="calibre7"><a id="_idTextAnchor132" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.211.1">Key features of FFmpeg</span></h2>
<p class="calibre3"><span class="kobospan" id="kobo.212.1">FFmpeg stands out for its extensive</span><a id="_idIndexMarker678" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.213.1"> range of capabilities. </span><span class="kobospan" id="kobo.213.2">Some of its key features include </span><span><span class="kobospan" id="kobo.214.1">the following:</span></span></p>
<ul class="calibre15">
<li class="calibre14"><strong class="bold"><span class="kobospan" id="kobo.215.1">Format support</span></strong><span class="kobospan" id="kobo.216.1">: FFmpeg supports a vast number of audio and video formats, both in terms of encoding and decoding, making it incredibly versatile for </span><span><span class="kobospan" id="kobo.217.1">multimedia processing</span></span></li>
<li class="calibre14"><strong class="bold"><span class="kobospan" id="kobo.218.1">Conversion</span></strong><span class="kobospan" id="kobo.219.1">: It can convert media files between various formats with high efficiency, a feature that’s widely used in various applications </span><span><span class="kobospan" id="kobo.220.1">and services</span></span></li>
<li class="calibre14"><strong class="bold"><span class="kobospan" id="kobo.221.1">Streaming</span></strong><span class="kobospan" id="kobo.222.1">: FFmpeg excels in streaming capabilities, allowing for audio and video to be captured, encoded, and streamed in </span><span><span class="kobospan" id="kobo.223.1">real time</span></span></li>
<li class="calibre14"><strong class="bold"><span class="kobospan" id="kobo.224.1">Filtering</span></strong><span class="kobospan" id="kobo.225.1">: With its powerful filtering capabilities, users can apply various transformations, overlays, and effects to </span><span><span class="kobospan" id="kobo.226.1">their media</span></span></li>
</ul>
<h2 id="_idParaDest-132" class="calibre7"><a id="_idTextAnchor133" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.227.1">Integrating mobile-ffmpeg into our project</span></h2>
<p class="calibre3"><span class="kobospan" id="kobo.228.1">In the context of Android</span><a id="_idIndexMarker679" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.229.1"> development, FFmpeg can be used as a powerful</span><a id="_idIndexMarker680" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.230.1"> tool for video editing functionalities, such as applying filters, transcoding, or even adding subtitles. </span><span class="kobospan" id="kobo.230.2">However, integrating FFmpeg into Android applications</span><a id="_idIndexMarker681" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.231.1"> while using C++ code requires using </span><strong class="bold"><span class="kobospan" id="kobo.232.1">Java Native Interface</span></strong><span class="kobospan" id="kobo.233.1"> (</span><strong class="bold"><span class="kobospan" id="kobo.234.1">JNI</span></strong><span class="kobospan" id="kobo.235.1">). </span><span class="kobospan" id="kobo.235.2">Luckily, there is an easier option, which is leveraging an Android-compatible wrapper of FFmpeg, such </span><span><span class="kobospan" id="kobo.236.1">as </span></span><span><strong class="source-inline"><span class="kobospan" id="kobo.237.1">mobile-ffmpeg</span></strong></span><span><span class="kobospan" id="kobo.238.1">.</span></span></p>
<p class="calibre3"><strong class="source-inline"><span class="kobospan" id="kobo.239.1">mobile-ffmpeg</span></strong><span class="kobospan" id="kobo.240.1"> is a specialized port of Ffmpeg that’s designed for mobile platforms such as Android and iOS. </span><span class="kobospan" id="kobo.240.2">It provides pre-built binaries, mobile-specific APIs, and optimizations tailored to the constraints of mobile hardware. </span><span class="kobospan" id="kobo.240.3">This makes it easier to integrate FFmpeg’s powerful capabilities into mobile applications, allowing developers to leverage advanced multimedia processing features with </span><span><span class="kobospan" id="kobo.241.1">less complexity.</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.242.1">To integrate the </span><strong class="source-inline"><span class="kobospan" id="kobo.243.1">mobile-ffmpeg</span></strong><span class="kobospan" id="kobo.244.1"> library into our project, we will start by opening our </span><strong class="source-inline"><span class="kobospan" id="kobo.245.1">libs.versions.toml</span></strong><span class="kobospan" id="kobo.246.1"> file. </span><span class="kobospan" id="kobo.246.2">There, we will add the version and the library group </span><span><span class="kobospan" id="kobo.247.1">and name:</span></span></p>
<pre class="source-code"><span class="kobospan1" id="kobo.248.1">
[versions]
...
</span><span class="kobospan1" id="kobo.248.2">mobileffmpeg = "4.4"
[libraries]
...
</span><span class="kobospan1" id="kobo.248.3">mobileffmpeg = { group = "com.arthenica", name = "mobile-ffmpeg-full", version.ref = "mobileffmpeg" }</span></pre> <p class="calibre3"><span class="kobospan" id="kobo.249.1">Here, we have just added the latest </span><strong class="source-inline"><span class="kobospan" id="kobo.250.1">mobile-ffmpeg</span></strong><span class="kobospan" id="kobo.251.1"> version and the library reference to our </span><span><span class="kobospan" id="kobo.252.1">version catalog.</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.253.1">As always, to use it in any of our modules, we will have to add the dependency in the </span><span><strong class="source-inline"><span class="kobospan" id="kobo.254.1">build.gradle.kts</span></strong></span><span><span class="kobospan" id="kobo.255.1"> file:</span></span></p>
<pre class="source-code"><span class="kobospan1" id="kobo.256.1">
dependencies {
    ....
</span><span class="kobospan1" id="kobo.256.2">    implementation(libs.mobileffmpeg)
}</span></pre> <p class="calibre3"><span class="kobospan" id="kobo.257.1">Once it’s added to our</span><a id="_idIndexMarker682" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.258.1"> dependencies, we will have to sync our Gradle</span><a id="_idIndexMarker683" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.259.1"> files so that it’s ready to be used in our code. </span><span class="kobospan" id="kobo.259.2">But first, let’s learn how FFmpeg works and can </span><span><span class="kobospan" id="kobo.260.1">be used.</span></span></p>
<h2 id="_idParaDest-133" class="calibre7"><a id="_idTextAnchor134" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.261.1">Understanding the FFmpeg command-line syntax</span></h2>
<p class="calibre3"><span class="kobospan" id="kobo.262.1">As we have seen, FFmpeg</span><a id="_idIndexMarker684" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.263.1"> is a powerful multimedia framework that’s capable of decoding, encoding, transcoding, multiplexing (joining, for example, audio and video in a single file), demultiplexing (separating audio and video in different files), streaming, filtering, and playing almost any type of media file. </span><span class="kobospan" id="kobo.263.2">Understanding its command-line syntax is crucial for effective video processing, especially in </span><span><span class="kobospan" id="kobo.264.1">Android environments.</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.265.1">Keep in mind that we will not be executing these commands in a terminal, but the </span><strong class="source-inline"><span class="kobospan" id="kobo.266.1">mobile-ffmpeg</span></strong><span class="kobospan" id="kobo.267.1"> library uses the same syntax to allow us to execute them using a function called </span><strong class="source-inline"><span class="kobospan" id="kobo.268.1">FFmpeg.execute()</span></strong><span class="kobospan" id="kobo.269.1">, as we will </span><span><span class="kobospan" id="kobo.270.1">see now.</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.271.1">At its core, an FFmpeg command follows a </span><span><span class="kobospan" id="kobo.272.1">basic structure:</span></span></p>
<pre class="source-code"><span class="kobospan1" id="kobo.273.1">
FFmpeg.execute("[global_options] {[input_file_options] [flags] input_url} ... </span><span class="kobospan1" id="kobo.273.2">{[output_file_options] output_url} ...")</span></pre> <p class="calibre3"><span class="kobospan" id="kobo.274.1">Let’s take a closer look</span><a id="_idIndexMarker685" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.275.1"> at the components of </span><span><span class="kobospan" id="kobo.276.1">this syntax:</span></span></p>
<ul class="calibre15">
<li class="calibre14"><strong class="source-inline1"><span class="kobospan" id="kobo.277.1">global_options</span></strong><span class="kobospan" id="kobo.278.1">: These are settings that can be applied throughout the command, such as configuring logging levels or overriding </span><span><span class="kobospan" id="kobo.279.1">default configurations.</span></span></li>
<li class="calibre14"><strong class="source-inline1"><span class="kobospan" id="kobo.280.1">input_file_options</span></strong><span class="kobospan" id="kobo.281.1">: These are options that specifically affect the input file, such as the format, codec, or </span><span><span class="kobospan" id="kobo.282.1">frame rate.</span></span></li>
<li class="calibre14"><strong class="source-inline1"><span class="kobospan" id="kobo.283.1">input_url</span></strong><span class="kobospan" id="kobo.284.1">: The path to the </span><span><span class="kobospan" id="kobo.285.1">input file.</span></span></li>
<li class="calibre14"><strong class="source-inline1"><span class="kobospan" id="kobo.286.1">output_file_options</span></strong><span class="kobospan" id="kobo.287.1">: These are similar to input file options but they affect the output file, such as the format, codec, </span><span><span class="kobospan" id="kobo.288.1">or bitrate.</span></span></li>
<li class="calibre14"><strong class="source-inline1"><span class="kobospan" id="kobo.289.1">output_url</span></strong><span class="kobospan" id="kobo.290.1">: The path for the </span><span><span class="kobospan" id="kobo.291.1">output file.</span></span></li>
<li class="calibre14"><strong class="source-inline1"><span class="kobospan" id="kobo.292.1">options</span></strong><span class="kobospan" id="kobo.293.1">/</span><strong class="source-inline1"><span class="kobospan" id="kobo.294.1">flags</span></strong><span class="kobospan" id="kobo.295.1">: These start with a dash (</span><strong class="source-inline1"><span class="kobospan" id="kobo.296.1">-</span></strong><span class="kobospan" id="kobo.297.1">) and modify how FFmpeg processes files. </span><span class="kobospan" id="kobo.297.2">The most used options and flags are </span><span><span class="kobospan" id="kobo.298.1">as follows:</span></span><ul class="calibre16"><li class="calibre14"><strong class="source-inline1"><span class="kobospan" id="kobo.299.1">-i</span></strong><span class="kobospan" id="kobo.300.1">: Specifies the </span><span><span class="kobospan" id="kobo.301.1">input file</span></span></li><li class="calibre14"><strong class="source-inline1"><span class="kobospan" id="kobo.302.1">-c</span></strong><span class="kobospan" id="kobo.303.1">: Indicates the codec; use </span><strong class="source-inline1"><span class="kobospan" id="kobo.304.1">-c:v</span></strong><span class="kobospan" id="kobo.305.1"> for video and </span><strong class="source-inline1"><span class="kobospan" id="kobo.306.1">-c:a</span></strong> <span><span class="kobospan" id="kobo.307.1">for audio</span></span></li><li class="calibre14"><strong class="source-inline1"><span class="kobospan" id="kobo.308.1">-b</span></strong><span class="kobospan" id="kobo.309.1">: Sets the bitrate; </span><strong class="source-inline1"><span class="kobospan" id="kobo.310.1">-b:v</span></strong><span class="kobospan" id="kobo.311.1"> for video and </span><strong class="source-inline1"><span class="kobospan" id="kobo.312.1">-b:a</span></strong> <span><span class="kobospan" id="kobo.313.1">for audio</span></span></li><li class="calibre14"><strong class="source-inline1"><span class="kobospan" id="kobo.314.1">-s</span></strong><span class="kobospan" id="kobo.315.1">: Defines the frame </span><span><span class="kobospan" id="kobo.316.1">size (resolution)</span></span></li><li class="calibre14"><strong class="source-inline1"><span class="kobospan" id="kobo.317.1">-r</span></strong><span class="kobospan" id="kobo.318.1">: Sets the </span><span><span class="kobospan" id="kobo.319.1">frame rate</span></span></li><li class="calibre14"><strong class="source-inline1"><span class="kobospan" id="kobo.320.1">-f</span></strong><span class="kobospan" id="kobo.321.1">: Indicates</span><a id="_idIndexMarker686" class="calibre6 pcalibre1 pcalibre"/> <span><span class="kobospan" id="kobo.322.1">the format</span></span></li></ul></li>
</ul>
<p class="calibre3"><span class="kobospan" id="kobo.323.1"> Let’s see how we can use this syntax to complete some </span><span><span class="kobospan" id="kobo.324.1">basic operations.</span></span></p>
<h3 class="calibre9"><span class="kobospan" id="kobo.325.1">Basic conversion</span></h3>
<p class="calibre3"><span class="kobospan" id="kobo.326.1">Converting a video file</span><a id="_idIndexMarker687" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.327.1"> from one format into another is a fundamental task in video editing. </span><span class="kobospan" id="kobo.327.2">For example, converting an MP4 file into an AVI file can be done </span><span><span class="kobospan" id="kobo.328.1">like so:</span></span></p>
<pre class="source-code"><span class="kobospan1" id="kobo.329.1">
FFmpeg.execute("-i input.mp4 output.avi")</span></pre> <p class="calibre3"><span class="kobospan" id="kobo.330.1">This command tells FFmpeg to take </span><strong class="source-inline"><span class="kobospan" id="kobo.331.1">input.mp4</span></strong><span class="kobospan" id="kobo.332.1"> and convert it into </span><strong class="source-inline"><span class="kobospan" id="kobo.333.1">output.avi</span></strong><span class="kobospan" id="kobo.334.1"> using the default settings for codecs and quality (the default values are used here because we didn’t specify </span><span><span class="kobospan" id="kobo.335.1">any settings).</span></span></p>
<h3 class="calibre9"><span class="kobospan" id="kobo.336.1">Specifying codecs</span></h3>
<p class="calibre3"><strong class="bold"><span class="kobospan" id="kobo.337.1">Codecs</span></strong><span class="kobospan" id="kobo.338.1"> are algorithms that</span><a id="_idIndexMarker688" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.339.1"> are used</span><a id="_idIndexMarker689" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.340.1"> for encoding (compressing) or decoding (decompressing) video and audio streams. </span><span class="kobospan" id="kobo.340.2">In FFmpeg, you can specify different codecs for the video and audio components of </span><span><span class="kobospan" id="kobo.341.1">a file:</span></span></p>
<ul class="calibre15">
<li class="calibre14"><strong class="bold"><span class="kobospan" id="kobo.342.1">Video codec</span></strong><span class="kobospan" id="kobo.343.1">: A video codec processes</span><a id="_idIndexMarker690" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.344.1"> the visual data in the file. </span><span class="kobospan" id="kobo.344.2">Choosing the right video codec affects the video’s quality, size, and compatibility with different players </span><span><span class="kobospan" id="kobo.345.1">and devices.</span></span></li>
<li class="calibre14"><strong class="bold"><span class="kobospan" id="kobo.346.1">Audio codec</span></strong><span class="kobospan" id="kobo.347.1">: An audio codec deals with the sound</span><a id="_idIndexMarker691" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.348.1"> component. </span><span class="kobospan" id="kobo.348.2">It determines the audio quality, file size, and compatibility with audio </span><span><span class="kobospan" id="kobo.349.1">playback systems.</span></span></li>
</ul>
<p class="calibre3"><span class="kobospan" id="kobo.350.1">To specify codecs in FFmpeg, use the </span><strong class="source-inline"><span class="kobospan" id="kobo.351.1">-c</span></strong><span class="kobospan" id="kobo.352.1"> flag followed by a colon, then either </span><strong class="source-inline"><span class="kobospan" id="kobo.353.1">v</span></strong><span class="kobospan" id="kobo.354.1"> for video or </span><strong class="source-inline"><span class="kobospan" id="kobo.355.1">a</span></strong><span class="kobospan" id="kobo.356.1"> for audio, and then specify the </span><span><span class="kobospan" id="kobo.357.1">codec’s name:</span></span></p>
<pre class="source-code"><span class="kobospan1" id="kobo.358.1">
ffmpeg -i input.file -c:v [video_codec] -c:a [audio_codec] output.file</span></pre> <p class="calibre3"><span class="kobospan" id="kobo.359.1">So, for example, to specify the H.264 and AAC codecs, you can run the </span><span><span class="kobospan" id="kobo.360.1">following command:</span></span></p>
<pre class="source-code"><span class="kobospan1" id="kobo.361.1">
ffmpeg -i input.mp4 -c:v libx264 -c:a aac output.mp4</span></pre> <p class="calibre3"><span class="kobospan" id="kobo.362.1">Let’s understand what the values of this </span><span><span class="kobospan" id="kobo.363.1">command mean:</span></span></p>
<ul class="calibre15">
<li class="calibre14"><strong class="source-inline1"><span class="kobospan" id="kobo.364.1">-i</span></strong><span class="kobospan" id="kobo.365.1">: This indicates that the next parameter is going to be the </span><span><span class="kobospan" id="kobo.366.1">input file.</span></span></li>
<li class="calibre14"><strong class="source-inline1"><span class="kobospan" id="kobo.367.1">input.mp4</span></strong><span class="kobospan" id="kobo.368.1">: This is the route to the </span><span><span class="kobospan" id="kobo.369.1">input file.</span></span></li>
<li class="calibre14"><strong class="source-inline1"><span class="kobospan" id="kobo.370.1">-c:v libx264</span></strong><span class="kobospan" id="kobo.371.1">: This value sets the video codec to </span><strong class="source-inline1"><span class="kobospan" id="kobo.372.1">libx264</span></strong><span class="kobospan" id="kobo.373.1">, a popular codec for H.264 video encoding. </span><span class="kobospan" id="kobo.373.2">It’s known for its efficiency and compatibility with most </span><span><span class="kobospan" id="kobo.374.1">video platforms.</span></span></li>
<li class="calibre14"><strong class="source-inline1"><span class="kobospan" id="kobo.375.1">-c:a aac</span></strong><span class="kobospan" id="kobo.376.1">: This value sets the audio codec to </span><strong class="source-inline1"><span class="kobospan" id="kobo.377.1">aac</span></strong><span class="kobospan" id="kobo.378.1"> (which stands for Advanced Audio Coded), known for good quality audio at lower bitrates, making it ideal for </span><span><span class="kobospan" id="kobo.379.1">web videos.</span></span></li>
<li class="calibre14"><strong class="source-inline1"><span class="kobospan" id="kobo.380.1">output.mp4</span></strong><span class="kobospan" id="kobo.381.1">: This indicates the route to the </span><span><span class="kobospan" id="kobo.382.1">output file.</span></span></li>
</ul>
<p class="calibre3"><span class="kobospan" id="kobo.383.1">Note that higher-quality codecs often result in larger file sizes – the balance between quality and file size can be key, depending on the </span><span><span class="kobospan" id="kobo.384.1">use case.</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.385.1">Also, it is important to know</span><a id="_idIndexMarker692" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.386.1"> that some codecs require licensing</span><a id="_idIndexMarker693" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.387.1"> for commercial use (for example, H.264), whereas others are open source and free (for example, VP9 </span><span><span class="kobospan" id="kobo.388.1">and Opus).</span></span></p>
<h3 class="calibre9"><span class="kobospan" id="kobo.389.1">Adjusting video quality</span></h3>
<p class="calibre3"><span class="kobospan" id="kobo.390.1">In video processing, one of the most</span><a id="_idIndexMarker694" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.391.1"> crucial aspects</span><a id="_idIndexMarker695" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.392.1"> to manage is the quality of the output video. </span><span class="kobospan" id="kobo.392.2">The quality is often directly influenced by the bitrate. </span><span class="kobospan" id="kobo.392.3">The </span><strong class="bold"><span class="kobospan" id="kobo.393.1">bitrate</span></strong><span class="kobospan" id="kobo.394.1"> is measured in </span><strong class="bold"><span class="kobospan" id="kobo.395.1">bits per second</span></strong><span class="kobospan" id="kobo.396.1"> (</span><strong class="bold"><span class="kobospan" id="kobo.397.1">bps</span></strong><span class="kobospan" id="kobo.398.1">) and represents the amount</span><a id="_idIndexMarker696" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.399.1"> of video or audio</span><a id="_idIndexMarker697" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.400.1"> data that’s encoded for 1 second of playback. </span><span class="kobospan" id="kobo.400.2">Higher bitrates generally mean better quality but also larger </span><span><span class="kobospan" id="kobo.401.1">file sizes.</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.402.1">There are two types </span><span><span class="kobospan" id="kobo.403.1">of bitrate:</span></span></p>
<ul class="calibre15">
<li class="calibre14"><strong class="bold"><span class="kobospan" id="kobo.404.1">Constant bitrate</span></strong><span class="kobospan" id="kobo.405.1"> (</span><strong class="bold"><span class="kobospan" id="kobo.406.1">CBR</span></strong><span class="kobospan" id="kobo.407.1">): This encodes the file</span><a id="_idIndexMarker698" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.408.1"> at a consistent bitrate throughout, leading to predictable file sizes but potentially </span><span><span class="kobospan" id="kobo.409.1">varying quality</span></span></li>
<li class="calibre14"><strong class="bold"><span class="kobospan" id="kobo.410.1">Variable bitrate</span></strong><span class="kobospan" id="kobo.411.1"> (</span><strong class="bold"><span class="kobospan" id="kobo.412.1">VBR</span></strong><span class="kobospan" id="kobo.413.1">): This adjusts the bitrate</span><a id="_idIndexMarker699" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.414.1"> according to the complexity of each part of the video, balancing quality and file size </span><span><span class="kobospan" id="kobo.415.1">more effectively</span></span></li>
</ul>
<p class="calibre3"><span class="kobospan" id="kobo.416.1">To adjust the bitrate in FFmpeg, we can use the </span><strong class="source-inline"><span class="kobospan" id="kobo.417.1">-b:v</span></strong><span class="kobospan" id="kobo.418.1"> flag for video bitrate and </span><strong class="source-inline"><span class="kobospan" id="kobo.419.1">-b:a</span></strong><span class="kobospan" id="kobo.420.1"> for </span><span><span class="kobospan" id="kobo.421.1">audio bitrate:</span></span></p>
<pre class="source-code"><span class="kobospan1" id="kobo.422.1">
ffmpeg -i input.file -b:v [video_bitrate] -b:a [audio_bitrate] output.file</span></pre> <p class="calibre3"><span class="kobospan" id="kobo.423.1">For example, to set standard definition video with moderate quality, we can run the </span><span><span class="kobospan" id="kobo.424.1">following command:</span></span></p>
<pre class="source-code"><span class="kobospan1" id="kobo.425.1">
ffmpeg -i input.mp4 -b:v 1500k -b:a 128k output.mp4</span></pre> <p class="calibre3"><span class="kobospan" id="kobo.426.1">Let’s see what the values of this </span><span><span class="kobospan" id="kobo.427.1">command mean:</span></span></p>
<ul class="calibre15">
<li class="calibre14"><strong class="source-inline1"><span class="kobospan" id="kobo.428.1">-i</span></strong><span class="kobospan" id="kobo.429.1">: This indicates that the next parameter is going to be the </span><span><span class="kobospan" id="kobo.430.1">input file</span></span></li>
<li class="calibre14"><strong class="source-inline1"><span class="kobospan" id="kobo.431.1">input.mp4</span></strong><span class="kobospan" id="kobo.432.1">: This is the route to the </span><span><span class="kobospan" id="kobo.433.1">input file</span></span></li>
<li class="calibre14"><strong class="source-inline1"><span class="kobospan" id="kobo.434.1">-b:v 1500k</span></strong><span class="kobospan" id="kobo.435.1">: Sets the video bitrate to 1,500 kbps, which is suitable for </span><span><span class="kobospan" id="kobo.436.1">standard-definition content</span></span></li>
<li class="calibre14"><strong class="source-inline1"><span class="kobospan" id="kobo.437.1">-b:a 128k</span></strong><span class="kobospan" id="kobo.438.1">: Sets the audio bitrate to 128 kbps, providing decent audio quality without excessive </span><span><span class="kobospan" id="kobo.439.1">file size</span></span></li>
<li class="calibre14"><strong class="source-inline1"><span class="kobospan" id="kobo.440.1">output.mp4</span></strong><span class="kobospan" id="kobo.441.1">: Indicates the route to the </span><span><span class="kobospan" id="kobo.442.1">output file</span></span></li>
</ul>
<p class="calibre3"><span class="kobospan" id="kobo.443.1">It’s worth noting that lower bitrates may lead to noticeable compression artifacts, especially in fast-moving or complex scenes. </span><span class="kobospan" id="kobo.443.2">On the other hand, higher bitrates offer better quality but at the expense of larger</span><a id="_idIndexMarker700" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.444.1"> file sizes, which might be an issue for online streaming</span><a id="_idIndexMarker701" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.445.1"> or </span><span><span class="kobospan" id="kobo.446.1">limited storage.</span></span></p>
<h3 class="calibre9"><span class="kobospan" id="kobo.447.1">Resizing video</span></h3>
<p class="calibre3"><span class="kobospan" id="kobo.448.1">Resizing or scaling videos</span><a id="_idIndexMarker702" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.449.1"> is a common task</span><a id="_idIndexMarker703" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.450.1"> in video editing, whether it’s to fit different screen sizes, reduce file size, or conform to specific resolution requirements. </span><span class="kobospan" id="kobo.450.2">FFmpeg offers powerful tools to resize videos with ease, but understanding the impact of these changes is crucial for </span><span><span class="kobospan" id="kobo.451.1">maintaining quality.</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.452.1">But what are video resolution and </span><span><span class="kobospan" id="kobo.453.1">aspect ratio?</span></span></p>
<ul class="calibre15">
<li class="calibre14"><strong class="bold"><span class="kobospan" id="kobo.454.1">Resolution</span></strong><span class="kobospan" id="kobo.455.1">: The resolution of a video</span><a id="_idIndexMarker704" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.456.1"> is the dimension in pixels, given as width x height. </span><span class="kobospan" id="kobo.456.2">Standard resolutions include 480p (SD), 720p (HD), 1080p (Full HD), and 4K (</span><span><span class="kobospan" id="kobo.457.1">Ultra HD).</span></span></li>
<li class="calibre14"><strong class="bold"><span class="kobospan" id="kobo.458.1">Aspect ratio</span></strong><span class="kobospan" id="kobo.459.1">: This is the ratio of the width</span><a id="_idIndexMarker705" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.460.1"> to the height of the video. </span><span class="kobospan" id="kobo.460.2">Common aspect ratios are 16:9 (widescreen) and </span><span><span class="kobospan" id="kobo.461.1">4:3 (traditional).</span></span></li>
</ul>
<p class="calibre3"><span class="kobospan" id="kobo.462.1">To resize videos in FFmpeg, the </span><strong class="source-inline"><span class="kobospan" id="kobo.463.1">-s</span></strong><span class="kobospan" id="kobo.464.1"> (size) flag is used. </span><span class="kobospan" id="kobo.464.2">It sets </span><span><span class="kobospan" id="kobo.465.1">the resolution:</span></span></p>
<pre class="source-code"><span class="kobospan1" id="kobo.466.1">
ffmpeg -i input.file -s [width]x[height] output.file</span></pre> <p class="calibre3"><span class="kobospan" id="kobo.467.1">For example, to resize to 1080p, the command will be </span><span><span class="kobospan" id="kobo.468.1">as follows:</span></span></p>
<pre class="source-code"><span class="kobospan1" id="kobo.469.1">
ffmpeg -i input.mp4 -s 1920x1080 output.mp4</span></pre> <p class="calibre3"><span class="kobospan" id="kobo.470.1">Let’s see what the values of this </span><span><span class="kobospan" id="kobo.471.1">command mean:</span></span></p>
<ul class="calibre15">
<li class="calibre14"><strong class="source-inline1"><span class="kobospan" id="kobo.472.1">-i</span></strong><span class="kobospan" id="kobo.473.1">: Indicates that the next parameter is going to be the </span><span><span class="kobospan" id="kobo.474.1">input file</span></span></li>
<li class="calibre14"><strong class="source-inline1"><span class="kobospan" id="kobo.475.1">input.mp4</span></strong><span class="kobospan" id="kobo.476.1">: The route to the </span><span><span class="kobospan" id="kobo.477.1">input file</span></span></li>
<li class="calibre14"><strong class="source-inline1"><span class="kobospan" id="kobo.478.1">-s 1920x1080</span></strong><span class="kobospan" id="kobo.479.1">: Resizes the video to full HD (1080p), which is suitable for high-quality presentations and </span><span><span class="kobospan" id="kobo.480.1">large displays</span></span></li>
<li class="calibre14"><strong class="source-inline1"><span class="kobospan" id="kobo.481.1">output.mp4</span></strong><span class="kobospan" id="kobo.482.1">: Indicates the route to the </span><span><span class="kobospan" id="kobo.483.1">output file</span></span></li>
</ul>
<p class="calibre3"><span class="kobospan" id="kobo.484.1">There are some things to consider when </span><span><span class="kobospan" id="kobo.485.1">resizing videos:</span></span></p>
<ul class="calibre15">
<li class="calibre14"><span class="kobospan" id="kobo.486.1">Choose the resolution based on where and how the video will be viewed. </span><span class="kobospan" id="kobo.486.2">For instance, you should choose a high resolution for TV broadcasts and something lower for web or </span><span><span class="kobospan" id="kobo.487.1">mobile use.</span></span></li>
<li class="calibre14"><span class="kobospan" id="kobo.488.1">Higher resolutions lead to larger files, which can be a concern for storage </span><span><span class="kobospan" id="kobo.489.1">and streaming.</span></span></li>
<li class="calibre14"><span class="kobospan" id="kobo.490.1">Always consider the quality</span><a id="_idIndexMarker706" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.491.1"> of the source video. </span><span class="kobospan" id="kobo.491.2">Upscaling low-quality footage might not yield</span><a id="_idIndexMarker707" class="calibre6 pcalibre1 pcalibre"/> <span><span class="kobospan" id="kobo.492.1">desirable results.</span></span></li>
</ul>
<p class="calibre3"><span class="kobospan" id="kobo.493.1">Now that we are familiar with the basic features of FFmpeg, we will learn about the </span><span><span class="kobospan" id="kobo.494.1">advanced ones.</span></span></p>
<h2 id="_idParaDest-134" class="calibre7"><a id="_idTextAnchor135" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.495.1">Advanced syntax and options in FFmpeg</span></h2>
<p class="calibre3"><span class="kobospan" id="kobo.496.1">FFmpeg’s true power lies</span><a id="_idIndexMarker708" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.497.1"> in its advanced options, allowing for sophisticated manipulation and processing of audio and video files. </span><span class="kobospan" id="kobo.497.2">This section delves deeper into these advanced features, providing insights into how they can be leveraged for </span><span><span class="kobospan" id="kobo.498.1">complex tasks.</span></span></p>
<h3 class="calibre9"><span class="kobospan" id="kobo.499.1">Using filters for enhanced video and audio manipulation</span></h3>
<p class="calibre3"><span class="kobospan" id="kobo.500.1">FFmpeg comes equipped</span><a id="_idIndexMarker709" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.501.1"> with an extensive range of filters</span><a id="_idIndexMarker710" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.502.1"> for both video and audio. </span><span class="kobospan" id="kobo.502.2">These can be applied to tasks such as cropping, rotating, adding watermarks, and adjusting brightness </span><span><span class="kobospan" id="kobo.503.1">or contrast.</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.504.1">To apply filters, you can use the </span><strong class="source-inline"><span class="kobospan" id="kobo.505.1">-vf</span></strong><span class="kobospan" id="kobo.506.1"> (video filters) or </span><strong class="source-inline"><span class="kobospan" id="kobo.507.1">-af</span></strong><span class="kobospan" id="kobo.508.1"> (audio filters) option. </span><span class="kobospan" id="kobo.508.2">Here is the schema of how the filter syntax </span><span><span class="kobospan" id="kobo.509.1">would work:</span></span></p>
<pre class="source-code"><span class="kobospan1" id="kobo.510.1">
ffmpeg -i input.file -vf "[filter1],[filter2]" output.file</span></pre> <p class="calibre3"><span class="kobospan" id="kobo.511.1">For example, imagine a scenario where you need to crop a video and adjust its color properties. </span><span class="kobospan" id="kobo.511.2">You can do this by running the </span><span><span class="kobospan" id="kobo.512.1">following command:</span></span></p>
<pre class="source-code"><span class="kobospan1" id="kobo.513.1">
ffmpeg -i input.mp4 -vf "crop=640:480:0:0, hue=h=60:s=1" -c:a copy output.mp4</span></pre> <p class="calibre3"><span class="kobospan" id="kobo.514.1">Let’s take a closer look at the values of </span><span><span class="kobospan" id="kobo.515.1">this command:</span></span></p>
<ul class="calibre15">
<li class="calibre14"><strong class="source-inline1"><span class="kobospan" id="kobo.516.1">-i</span></strong><span class="kobospan" id="kobo.517.1">: Indicates that the next parameter is going to be the </span><span><span class="kobospan" id="kobo.518.1">input file.</span></span></li>
<li class="calibre14"><strong class="source-inline1"><span class="kobospan" id="kobo.519.1">input.mp4</span></strong><span class="kobospan" id="kobo.520.1">: This is the route to the </span><span><span class="kobospan" id="kobo.521.1">input file.</span></span></li>
<li class="calibre14"><strong class="source-inline1"><span class="kobospan" id="kobo.522.1">-vf</span></strong><span class="kobospan" id="kobo.523.1">: This stands for video filters, and allows you to apply one or more filters to the </span><span><span class="kobospan" id="kobo.524.1">video stream.</span></span></li>
<li class="calibre14"><strong class="source-inline1"><span class="kobospan" id="kobo.525.1">crop=640:480:0:0</span></strong><span class="kobospan" id="kobo.526.1">: This is the crop filter. </span><span class="kobospan" id="kobo.526.2">It crops the video to a width of </span><strong class="source-inline1"><span class="kobospan" id="kobo.527.1">640</span></strong><span class="kobospan" id="kobo.528.1"> pixels and a height of </span><strong class="source-inline1"><span class="kobospan" id="kobo.529.1">480</span></strong><span class="kobospan" id="kobo.530.1"> pixels. </span><span class="kobospan" id="kobo.530.2">The </span><strong class="source-inline1"><span class="kobospan" id="kobo.531.1">0:0</span></strong><span class="kobospan" id="kobo.532.1"> value at the end specifies the </span><em class="italic"><span class="kobospan" id="kobo.533.1">x</span></em><span class="kobospan" id="kobo.534.1"> and </span><em class="italic"><span class="kobospan" id="kobo.535.1">y</span></em><span class="kobospan" id="kobo.536.1"> coordinates of the top-left corner of the crop area. </span><span class="kobospan" id="kobo.536.2">In this case, it’s set to the top-left corner of the original video. </span><span class="kobospan" id="kobo.536.3">So, this filter effectively crops the video to a 640x480 rectangle starting from the </span><span><span class="kobospan" id="kobo.537.1">top-left corner.</span></span></li>
<li class="calibre14"><strong class="source-inline1"><span class="kobospan" id="kobo.538.1">hue=h=60:s=1</span></strong><span class="kobospan" id="kobo.539.1">: There are two parts to </span><span><span class="kobospan" id="kobo.540.1">this code:</span></span><ul class="calibre16"><li class="calibre14"><strong class="source-inline1"><span class="kobospan" id="kobo.541.1">h=60</span></strong><span class="kobospan" id="kobo.542.1"> adjusts the hue of the video. </span><span class="kobospan" id="kobo.542.2">Hue is a color component that allows us to shift colors on a 360-degree color wheel. </span><span class="kobospan" id="kobo.542.3">A value of 60 shifts the colors by 60 degrees. </span><span class="kobospan" id="kobo.542.4">For example, blue might become green, red might become yellow, and </span><span><span class="kobospan" id="kobo.543.1">so on.</span></span></li><li class="calibre14"><strong class="source-inline1"><span class="kobospan" id="kobo.544.1">s=1</span></strong><span class="kobospan" id="kobo.545.1"> sets the saturation level. </span><span class="kobospan" id="kobo.545.2">A saturation of </span><strong class="source-inline1"><span class="kobospan" id="kobo.546.1">1</span></strong><span class="kobospan" id="kobo.547.1"> means that the colors are left as-is in terms of intensity. </span><span class="kobospan" id="kobo.547.2">Decreasing this value would desaturate the colors, leading to a more </span><span><span class="kobospan" id="kobo.548.1">grayscale image.</span></span></li></ul></li>
<li class="calibre14"><strong class="source-inline1"><span class="kobospan" id="kobo.549.1">-c:a</span></strong><span class="kobospan" id="kobo.550.1">: Resizes the video to full </span><span><span class="kobospan" id="kobo.551.1">HD (1080p).</span></span></li>
<li class="calibre14"><strong class="source-inline1"><span class="kobospan" id="kobo.552.1">output.mp4</span></strong><span class="kobospan" id="kobo.553.1">: Indicates the route to the </span><span><span class="kobospan" id="kobo.554.1">output file.</span></span></li>
</ul>
<p class="calibre3"><span class="kobospan" id="kobo.555.1">In summary, this FFmpeg</span><a id="_idIndexMarker711" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.556.1"> command reads </span><strong class="source-inline"><span class="kobospan" id="kobo.557.1">input.mp4</span></strong><span class="kobospan" id="kobo.558.1">, crops the video</span><a id="_idIndexMarker712" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.559.1"> to a 640x480 resolution starting from the top-left corner, shifts the hue of the video colors by 60 degrees on the color wheel, maintains the original saturation, copies the audio without re-encoding, and saves all these changes </span><span><span class="kobospan" id="kobo.560.1">in </span></span><span><strong class="source-inline"><span class="kobospan" id="kobo.561.1">output.mp4</span></strong></span><span><span class="kobospan" id="kobo.562.1">.</span></span></p>
<h3 class="calibre9"><span class="kobospan" id="kobo.563.1">Using an overlay video filter</span></h3>
<p class="calibre3"><span class="kobospan" id="kobo.564.1">The overlay filter in FFmpeg</span><a id="_idIndexMarker713" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.565.1"> is a versatile feature that allows users to superimpose one video or image over another. </span><span class="kobospan" id="kobo.565.2">This is particularly useful for adding logos, watermarks, subtitles, picture-in-picture effects, or any additional visual elements to </span><span><span class="kobospan" id="kobo.566.1">a video.</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.567.1">The overlay filter can be applied with the </span><strong class="source-inline"><span class="kobospan" id="kobo.568.1">-filter_complex</span></strong><span class="kobospan" id="kobo.569.1"> option in FFmpeg, which is used for more complex filtering that involves multiple input streams (such as combining two videos or adding an image to </span><span><span class="kobospan" id="kobo.570.1">a video).</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.571.1">The basic syntax for the overlay filter is </span><span><span class="kobospan" id="kobo.572.1">as follows:</span></span></p>
<pre class="source-code"><span class="kobospan1" id="kobo.573.1">
ffmpeg -i main_video.mp4 -i overlay.mp4 -filter_complex "overlay=x:y" output.mp4</span></pre> <p class="calibre3"><span class="kobospan" id="kobo.574.1">Here, </span><strong class="source-inline"><span class="kobospan" id="kobo.575.1">main_video.mp4</span></strong><span class="kobospan" id="kobo.576.1"> is our primary video, and </span><strong class="source-inline"><span class="kobospan" id="kobo.577.1">overlay.mp4</span></strong><span class="kobospan" id="kobo.578.1"> is the video or image we want to overlay. </span><span class="kobospan" id="kobo.578.2">The </span><strong class="source-inline"><span class="kobospan" id="kobo.579.1">x</span></strong><span class="kobospan" id="kobo.580.1"> and </span><strong class="source-inline"><span class="kobospan" id="kobo.581.1">y</span></strong><span class="kobospan" id="kobo.582.1"> values in the overlay filter specify the position of the overlay image/video on the </span><span><span class="kobospan" id="kobo.583.1">main video.</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.584.1">As an example, let’s say we want to add a company logo to the bottom-right corner of a video. </span><span class="kobospan" id="kobo.584.2">First, we must prepare the files. </span><span class="kobospan" id="kobo.584.3">In this case, we have </span><span><span class="kobospan" id="kobo.585.1">the following:</span></span></p>
<ul class="calibre15">
<li class="calibre14"><span class="kobospan" id="kobo.586.1">The main video file will </span><span><span class="kobospan" id="kobo.587.1">be </span></span><span><strong class="source-inline1"><span class="kobospan" id="kobo.588.1">video.mp4</span></strong></span></li>
<li class="calibre14"><span class="kobospan" id="kobo.589.1">The logo image will be </span><strong class="source-inline1"><span class="kobospan" id="kobo.590.1">logo.png</span></strong><span class="kobospan" id="kobo.591.1"> (preferably with a </span><span><span class="kobospan" id="kobo.592.1">transparent background)</span></span></li>
</ul>
<p class="calibre3"><span class="kobospan" id="kobo.593.1">Then, we will determine the logo’s position. </span><span class="kobospan" id="kobo.593.2">The logo’s position will depend on the resolution of the main video. </span><span class="kobospan" id="kobo.593.3">For example, if the video is 1920x1080 (full HD), and you want to place the logo 10 pixels from the bottom and right edges, the coordinates would be (</span><span><span class="kobospan" id="kobo.594.1">x=1900, y=1060).</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.595.1">With this in mind, we will have to execute the </span><span><span class="kobospan" id="kobo.596.1">following command:</span></span></p>
<pre class="source-code"><span class="kobospan1" id="kobo.597.1">
ffmpeg -i video.mp4 -i logo.png -filter_complex "overlay=1900:1060" -codec:a copy output.mp4</span></pre> <p class="calibre3"><span class="kobospan" id="kobo.598.1">In this command, we have </span><span><span class="kobospan" id="kobo.599.1">the following:</span></span></p>
<ul class="calibre15">
<li class="calibre14"><strong class="source-inline1"><span class="kobospan" id="kobo.600.1">-i video.mp4</span></strong><span class="kobospan" id="kobo.601.1">: Specifies the main </span><span><span class="kobospan" id="kobo.602.1">video file.</span></span></li>
<li class="calibre14"><strong class="source-inline1"><span class="kobospan" id="kobo.603.1">-i logo.png</span></strong><span class="kobospan" id="kobo.604.1">: Specifies the overlay </span><span><span class="kobospan" id="kobo.605.1">file (logo).</span></span></li>
<li class="calibre14"><strong class="source-inline1"><span class="kobospan" id="kobo.606.1">-filter_complex "overlay=1900:1060"</span></strong><span class="kobospan" id="kobo.607.1">: Applies the overlay filter. </span><span class="kobospan" id="kobo.607.2">The logo is positioned at (1900,1060), which is near the </span><span><span class="kobospan" id="kobo.608.1">bottom-right corner.</span></span></li>
<li class="calibre14"><strong class="source-inline1"><span class="kobospan" id="kobo.609.1">-codec:a copy</span></strong><span class="kobospan" id="kobo.610.1">: Copies the audio from the main video </span><span><span class="kobospan" id="kobo.611.1">without re-encoding.</span></span></li>
<li class="calibre14"><strong class="source-inline1"><span class="kobospan" id="kobo.612.1">output.mp4</span></strong><span class="kobospan" id="kobo.613.1">: The output file with the logo overlaid on </span><span><span class="kobospan" id="kobo.614.1">the video.</span></span></li>
</ul>
<p class="calibre3"><span class="kobospan" id="kobo.615.1">Is this all we can do with the overlay</span><a id="_idIndexMarker714" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.616.1"> filter? </span><span class="kobospan" id="kobo.616.2">No, there’s much more! </span><span class="kobospan" id="kobo.616.3">For example, we can move this </span><span><span class="kobospan" id="kobo.617.1">overlay dynamically.</span></span></p>
<h3 class="calibre9"><span class="kobospan" id="kobo.618.1">Dynamic positioning with the overlay filter in FFmpeg</span></h3>
<p class="calibre3"><span class="kobospan" id="kobo.619.1">The overlay filter in FFmpeg</span><a id="_idIndexMarker715" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.620.1"> not only allows</span><a id="_idIndexMarker716" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.621.1"> static placement of images or videos over a main video but also offers dynamic positioning capabilities. </span><span class="kobospan" id="kobo.621.2">This advanced feature enables the overlay to move across the screen or change its appearance over time, adding a dynamic element to </span><span><span class="kobospan" id="kobo.622.1">your videos.</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.623.1">First, let’s explore how to create the effect of moving an overlay across the screen. </span><span class="kobospan" id="kobo.623.2">This technique is particularly effective for adding motion to logos, text, or other </span><span><span class="kobospan" id="kobo.624.1">graphical elements.</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.625.1">Before we dive into the command, it’s important to understand how FFmpeg processes expressions for movement. </span><span class="kobospan" id="kobo.625.2">These expressions allow the position of the overlay to change frame by frame, creating the illusion </span><span><span class="kobospan" id="kobo.626.1">of motion.</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.627.1">The command for moving an overlay is </span><span><span class="kobospan" id="kobo.628.1">as follows:</span></span></p>
<pre class="source-code"><span class="kobospan1" id="kobo.629.1">
ffmpeg -i main_video.mp4 -i logo.png -filter_complex "overlay=x='t*100':y=50" output.mp4</span></pre> <p class="calibre3"><span class="kobospan" id="kobo.630.1">In this command, we have </span><span><span class="kobospan" id="kobo.631.1">the following:</span></span></p>
<ul class="calibre15">
<li class="calibre14"><strong class="source-inline1"><span class="kobospan" id="kobo.632.1">x='t*100'</span></strong><span class="kobospan" id="kobo.633.1">: The horizontal position (</span><strong class="source-inline1"><span class="kobospan" id="kobo.634.1">x</span></strong><span class="kobospan" id="kobo.635.1">) of the overlay starts at 0 and increases by 100 pixels every second. </span><span class="kobospan" id="kobo.635.2">The </span><strong class="source-inline1"><span class="kobospan" id="kobo.636.1">t</span></strong><span class="kobospan" id="kobo.637.1"> variable represents the current time </span><span><span class="kobospan" id="kobo.638.1">in seconds.</span></span></li>
<li class="calibre14"><strong class="source-inline1"><span class="kobospan" id="kobo.639.1">y=50</span></strong><span class="kobospan" id="kobo.640.1">: The vertical position (</span><strong class="source-inline1"><span class="kobospan" id="kobo.641.1">y</span></strong><span class="kobospan" id="kobo.642.1">) is fixed at </span><strong class="source-inline1"><span class="kobospan" id="kobo.643.1">50</span></strong><span class="kobospan" id="kobo.644.1"> pixels from the top of </span><span><span class="kobospan" id="kobo.645.1">the frame.</span></span></li>
</ul>
<p class="calibre3"><span class="kobospan" id="kobo.646.1">We can play with these values to introduce different effects in our video overlay. </span><span class="kobospan" id="kobo.646.2">For example, if we create a complete video editor, we could allow the users to move an element over the video and change its position during the video playback. </span><span class="kobospan" id="kobo.646.3">Then, we could map those different positions</span><a id="_idIndexMarker717" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.647.1"> to the seconds where we want it to be moved using FFmpeg. </span><span class="kobospan" id="kobo.647.2">However, we won’t be doing</span><a id="_idIndexMarker718" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.648.1"> this as it would take another </span><span><span class="kobospan" id="kobo.649.1">book entirely!</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.650.1">If you are curious about this, here</span><a id="_idIndexMarker719" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.651.1"> is the documentation for the </span><strong class="source-inline"><span class="kobospan" id="kobo.652.1">overlay</span></strong> <span><span class="kobospan" id="kobo.653.1">parameter: </span></span><a href="https://ffmpeg.org/ffmpeg-filters.html#overlay-1" class="calibre6 pcalibre1 pcalibre"><span><span class="kobospan" id="kobo.654.1">https://ffmpeg.org/ffmpeg-filters.html#overlay-1</span></span></a><span><span class="kobospan" id="kobo.655.1">.</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.656.1">Another feature we can use is fade-in and fade-out effects, which we can apply to our overlay. </span><span class="kobospan" id="kobo.656.2">Let’s see how </span><span><span class="kobospan" id="kobo.657.1">it works.</span></span></p>
<h3 class="calibre9"><span class="kobospan" id="kobo.658.1">Introducing the fade-in/out command</span></h3>
<p class="calibre3"><span class="kobospan" id="kobo.659.1">To achieve a fade-in/out effect, we combine</span><a id="_idIndexMarker720" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.660.1"> the overlay filter with the fade filter. </span><span class="kobospan" id="kobo.660.2">Let’s break down the command to understand how </span><span><span class="kobospan" id="kobo.661.1">it’s structured:</span></span></p>
<pre class="source-code"><span class="kobospan1" id="kobo.662.1">
ffmpeg -i main_video.mp4 -i logo.png -filter_complex "[1:v]fade=t=in:st=0:d=1,fade=t=out:st=3:d=1[logo];[0:v][logo]overlay=10:10" output.mp4</span></pre> <p class="calibre3"><span class="kobospan" id="kobo.663.1">Let’s understand how this command </span><span><span class="kobospan" id="kobo.664.1">is configured:</span></span></p>
<ul class="calibre15">
<li class="calibre14"><strong class="source-inline1"><span class="kobospan" id="kobo.665.1">[1:v]fade=t=in:st=0:d=1</span></strong><span class="kobospan" id="kobo.666.1">: Applies a fade-in effect to the overlay, starting at </span><strong class="source-inline1"><span class="kobospan" id="kobo.667.1">0</span></strong><span class="kobospan" id="kobo.668.1"> seconds and lasting for </span><span><strong class="source-inline1"><span class="kobospan" id="kobo.669.1">1</span></strong></span><span><span class="kobospan" id="kobo.670.1"> second</span></span></li>
<li class="calibre14"><strong class="source-inline1"><span class="kobospan" id="kobo.671.1">fade=t=out:st=3:d=1[logo]</span></strong><span class="kobospan" id="kobo.672.1">: Subsequently, a fade-out effect starts at </span><strong class="source-inline1"><span class="kobospan" id="kobo.673.1">3</span></strong><span class="kobospan" id="kobo.674.1"> seconds and also lasts for </span><span><strong class="source-inline1"><span class="kobospan" id="kobo.675.1">1</span></strong></span><span><span class="kobospan" id="kobo.676.1"> second</span></span></li>
<li class="calibre14"><strong class="source-inline1"><span class="kobospan" id="kobo.677.1">overlay=10:10</span></strong><span class="kobospan" id="kobo.678.1">: The overlay is placed at the coordinates (10,10) on the </span><span><span class="kobospan" id="kobo.679.1">main video</span></span></li>
</ul>
<p class="calibre3"><span class="kobospan" id="kobo.680.1">But there is more that we can</span><a id="_idIndexMarker721" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.681.1"> do with FFmpeg, apart from using exposed filters. </span><span class="kobospan" id="kobo.681.2">Let’s see how we can use the </span><strong class="source-inline"><span class="kobospan" id="kobo.682.1">mobile-ffmpeg</span></strong><span class="kobospan" id="kobo.683.1"> library that we’ve already integrated into our project to improve the videos we are </span><span><span class="kobospan" id="kobo.684.1">already recording.</span></span></p>
<h2 id="_idParaDest-135" class="calibre7"><a id="_idTextAnchor136" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.685.1">Using mobile-ffmpeg to execute FFmpeg commands</span></h2>
<p class="calibre3"><span class="kobospan" id="kobo.686.1">With </span><strong class="source-inline"><span class="kobospan" id="kobo.687.1">mobile-ffmpeg</span></strong><span class="kobospan" id="kobo.688.1"> integrated, executing </span><a id="_idIndexMarker722" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.689.1">FFmpeg commands</span><a id="_idIndexMarker723" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.690.1"> in Android becomes a </span><span><span class="kobospan" id="kobo.691.1">streamlined process.</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.692.1">The library’s </span><strong class="source-inline"><span class="kobospan" id="kobo.693.1">FFmpeg.execute()</span></strong><span class="kobospan" id="kobo.694.1"> method is the gateway to running FFmpeg commands. </span><span class="kobospan" id="kobo.694.2">For instance, a command such as </span><strong class="source-inline"><span class="kobospan" id="kobo.695.1">-i input.mp4 -c:v libx264 output.mp4</span></strong><span class="kobospan" id="kobo.696.1">, which converts an input video so that it uses the H.264 codec, is seamlessly executed within the Android environment. </span><span class="kobospan" id="kobo.696.2">This function mirrors the command-line syntax of FFmpeg, maintaining familiarity for those accustomed to FFmpeg’s </span><span><span class="kobospan" id="kobo.697.1">command-line interface.</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.698.1">Here’s how it </span><span><span class="kobospan" id="kobo.699.1">would work:</span></span></p>
<pre class="source-code"><span class="kobospan1" id="kobo.700.1">
val command = "-i input.mp4 -c:v libx264 output.mp4"
val returnCode = FFmpeg.execute(command)</span></pre> <p class="calibre3"><span class="kobospan" id="kobo.701.1">In the previous code block, we are building a string with the </span><strong class="source-inline"><span class="kobospan" id="kobo.702.1">command</span></strong><span class="kobospan" id="kobo.703.1"> instruction and storing it in the </span><strong class="source-inline"><span class="kobospan" id="kobo.704.1">command</span></strong><span class="kobospan" id="kobo.705.1"> variable. </span><span class="kobospan" id="kobo.705.2">Then, we are using the </span><strong class="source-inline"><span class="kobospan" id="kobo.706.1">FFmpeg.execute()</span></strong><span class="kobospan" id="kobo.707.1"> method to execute the command. </span><span class="kobospan" id="kobo.707.2">Note that this execution will happen in the current thread, which could be </span><span><span class="kobospan" id="kobo.708.1">undesirable performance-wise.</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.709.1">Managing performance</span><a id="_idIndexMarker724" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.710.1"> and user experience</span><a id="_idIndexMarker725" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.711.1"> is crucial in Android, especially for resource-intensive tasks such as video processing. </span><strong class="source-inline"><span class="kobospan" id="kobo.712.1">mobile-ffmpeg</span></strong><span class="kobospan" id="kobo.713.1"> accommodates this by offering asynchronous execution of commands. </span><span class="kobospan" id="kobo.713.2">Utilizing </span><strong class="source-inline"><span class="kobospan" id="kobo.714.1">FFmpeg.executeAsync()</span></strong><span class="kobospan" id="kobo.715.1"> ensures that longer operations do not block the main thread, thus maintaining the application’s responsiveness. </span><span class="kobospan" id="kobo.715.2">This method becomes instrumental when handling complex transformations or filters, such as scaling </span><span><span class="kobospan" id="kobo.716.1">a video.</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.717.1">Here’s how we can use the </span><span><strong class="source-inline"><span class="kobospan" id="kobo.718.1">executeAsync</span></strong></span><span><span class="kobospan" id="kobo.719.1"> function:</span></span></p>
<pre class="source-code"><span class="kobospan1" id="kobo.720.1">
FFmpeg.executeAsync(command) { executionId, returnCode -&gt;
    when (returnCode) {
        Config.RETURN_CODE_SUCCESS -&gt; {
            // Processing was successful
        }
        Config.RETURN_CODE_CANCEL -&gt; {
            // Command execution was cancelled
        }
        else -&gt; {
            // Command execution failed
        }
    }
}</span></pre> <p class="calibre3"><span class="kobospan" id="kobo.721.1">In this example, the </span><strong class="source-inline"><span class="kobospan" id="kobo.722.1">executeAsync()</span></strong><span class="kobospan" id="kobo.723.1"> method is called with the </span><strong class="source-inline"><span class="kobospan" id="kobo.724.1">FFmpeg</span></strong><span class="kobospan" id="kobo.725.1"> command in string format. </span><span class="kobospan" id="kobo.725.2">This command is what we intend FFmpeg to execute, such as converting a video file, applying filters, or any other media processing task supported by FFmpeg. </span><span class="kobospan" id="kobo.725.3">The execution of this command occurs in a separate thread, preventing any blocking of the main UI thread of </span><span><span class="kobospan" id="kobo.726.1">the application.</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.727.1">When the command has finished executing, a Lambda function is triggered. </span><span class="kobospan" id="kobo.727.2">This function is structured to receive two parameters: </span><strong class="source-inline"><span class="kobospan" id="kobo.728.1">executionId</span></strong><span class="kobospan" id="kobo.729.1"> and </span><strong class="source-inline"><span class="kobospan" id="kobo.730.1">returnCode</span></strong><span class="kobospan" id="kobo.731.1">. </span><span class="kobospan" id="kobo.731.2">The </span><strong class="source-inline"><span class="kobospan" id="kobo.732.1">executionId</span></strong><span class="kobospan" id="kobo.733.1"> parameter is a unique identifier for this particular execution instance of the </span><strong class="source-inline"><span class="kobospan" id="kobo.734.1">FFmpeg</span></strong><span class="kobospan" id="kobo.735.1"> command and can be useful for tracking or managing this specific operation, especially</span><a id="_idIndexMarker726" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.736.1"> if our application handles</span><a id="_idIndexMarker727" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.737.1"> multiple FFmpeg </span><span><span class="kobospan" id="kobo.738.1">processes concurrently.</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.739.1">The </span><strong class="source-inline"><span class="kobospan" id="kobo.740.1">returnCode</span></strong><span class="kobospan" id="kobo.741.1"> parameter is crucial as it indicates the outcome of the executed </span><strong class="source-inline"><span class="kobospan" id="kobo.742.1">FFmpeg</span></strong><span class="kobospan" id="kobo.743.1"> command. </span><span class="kobospan" id="kobo.743.2">The different return codes and their implications are </span><span><span class="kobospan" id="kobo.744.1">as follows:</span></span></p>
<ul class="calibre15">
<li class="calibre14"><strong class="source-inline1"><span class="kobospan" id="kobo.745.1">Config.RETURN_CODE_SUCCESS</span></strong><span class="kobospan" id="kobo.746.1">: This code signifies that the </span><strong class="source-inline1"><span class="kobospan" id="kobo.747.1">FFmpeg</span></strong><span class="kobospan" id="kobo.748.1"> command was executed successfully without any errors. </span><span class="kobospan" id="kobo.748.2">In the corresponding block of the </span><strong class="source-inline1"><span class="kobospan" id="kobo.749.1">when</span></strong><span class="kobospan" id="kobo.750.1"> statement, you might want to implement functionality that deals with the successful completion of the media processing task. </span><span class="kobospan" id="kobo.750.2">This could include updating the user interface, processing or displaying the output file, or triggering subsequent </span><span><span class="kobospan" id="kobo.751.1">application logic.</span></span></li>
<li class="calibre14"><strong class="source-inline1"><span class="kobospan" id="kobo.752.1">Config.RETURN_CODE_CANCEL</span></strong><span class="kobospan" id="kobo.753.1">: This return code indicates that the execution of the </span><strong class="source-inline1"><span class="kobospan" id="kobo.754.1">FFmpeg</span></strong><span class="kobospan" id="kobo.755.1"> command was canceled. </span><span class="kobospan" id="kobo.755.2">This can occur if the execution is programmatically aborted or if certain external conditions pre-emptively stop the command. </span><span class="kobospan" id="kobo.755.3">The handling code block for this return code could involve notifying the user of the cancellation, cleaning up resources, or setting the stage for a potential retry of </span><span><span class="kobospan" id="kobo.756.1">the operation.</span></span></li>
<li class="calibre14"><strong class="source-inline1"><span class="kobospan" id="kobo.757.1">else</span></strong><span class="kobospan" id="kobo.758.1">: This block catches all other cases, which generally suggests that an error occurred during the execution of the </span><strong class="source-inline1"><span class="kobospan" id="kobo.759.1">FFmpeg</span></strong><span class="kobospan" id="kobo.760.1"> command. </span><span class="kobospan" id="kobo.760.2">Here, error-handling strategies come into play, such as logging the error for diagnostic purposes, informing the user of the failure, or attempting to retry the operation under </span><span><span class="kobospan" id="kobo.761.1">certain conditions.</span></span></li>
</ul>
<p class="calibre3"><span class="kobospan" id="kobo.762.1">To further refine the integration, </span><strong class="source-inline"><span class="kobospan" id="kobo.763.1">mobile-ffmpeg</span></strong><span class="kobospan" id="kobo.764.1"> allows us to handle progress and log outputs. </span><span class="kobospan" id="kobo.764.2">This is essential for debugging and enhancing the user experience. </span><span class="kobospan" id="kobo.764.3">Here’s how </span><span><span class="kobospan" id="kobo.765.1">it works:</span></span></p>
<pre class="source-code"><span class="kobospan1" id="kobo.766.1">
FFmpeg.executeAsync(command, ExecuteCallback { executionId,
returnCode -&gt;
    // Handle execution result
}, LogCallback { logMessage -&gt;
    // Handle log message
}, StatisticsCallback { statistics -&gt;
    // Handle progress updates
})</span></pre> <p class="calibre3"><span class="kobospan" id="kobo.767.1">Here, </span><strong class="source-inline"><span class="kobospan" id="kobo.768.1">LogCallback</span></strong><span class="kobospan" id="kobo.769.1"> complements the execution callback that we described before. </span><span class="kobospan" id="kobo.769.2">FFmpeg is known for its verbose logging, providing a wealth of information about the ongoing operation. </span><span class="kobospan" id="kobo.769.3">The </span><strong class="source-inline"><span class="kobospan" id="kobo.770.1">logMessage</span></strong><span class="kobospan" id="kobo.771.1"> parameter in this callback gives you access to these logs, enabling you to handle them as per your application’s needs. </span><span class="kobospan" id="kobo.771.2">Whether it’s displaying these logs for debugging purposes, analyzing them for detailed error reporting, or simply directing them to a file for record-keeping, this callback plays a pivotal role in understanding and managing the intricacies of </span><span><span class="kobospan" id="kobo.772.1">FFmpeg’s operations.</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.773.1">Last but not least, </span><strong class="source-inline"><span class="kobospan" id="kobo.774.1">StatisticsCallback</span></strong><span class="kobospan" id="kobo.775.1"> opens the door to real-time monitoring of the FFmpeg process. </span><span class="kobospan" id="kobo.775.2">This callback, through the </span><strong class="source-inline"><span class="kobospan" id="kobo.776.1">statistics</span></strong><span class="kobospan" id="kobo.777.1"> parameter, provides live data, such as the frame currently being processed, elapsed time, and bitrate, among others. </span><span class="kobospan" id="kobo.777.2">Utilizing this data can significantly enhance the user experience, enabling you to implement dynamic features such as progress bars, estimated-time-to-completion indicators, or even detailed</span><a id="_idIndexMarker728" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.778.1"> reports of the ongoing</span><a id="_idIndexMarker729" class="calibre6 pcalibre1 pcalibre"/> <span><span class="kobospan" id="kobo.779.1">operation’s status.</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.780.1">Now that we know how to execute our FFmpeg commands in Android, let’s build something. </span><span class="kobospan" id="kobo.780.2">We will start by adding a caption to </span><span><span class="kobospan" id="kobo.781.1">the video.</span></span></p>
<h1 id="_idParaDest-136" class="calibre5"><a id="_idTextAnchor137" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.782.1">Adding a caption to the video with FFmpeg</span></h1>
<p class="calibre3"><span class="kobospan" id="kobo.783.1">In this section, we will create</span><a id="_idIndexMarker730" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.784.1"> all the components we’ll need</span><a id="_idIndexMarker731" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.785.1"> to add a caption to a video using FFmpeg. </span><span class="kobospan" id="kobo.785.2">We’ll start this new feature by creating a use case where the business logic of adding the caption to the video will be defined. </span><span class="kobospan" id="kobo.785.3">We will call it </span><strong class="source-inline"><span class="kobospan" id="kobo.786.1">AddCaptionToVideoUseCase</span></strong><span class="kobospan" id="kobo.787.1">, and its responsibility will be to add the caption to the video and return the new video file once it has </span><span><span class="kobospan" id="kobo.788.1">been added.</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.789.1">This is how</span><a id="_idIndexMarker732" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.790.1"> we can </span><a id="_idIndexMarker733" class="calibre6 pcalibre1 pcalibre"/><span><span class="kobospan" id="kobo.791.1">build </span></span><span><strong class="source-inline"><span class="kobospan" id="kobo.792.1">AddCaptionToVideoUseCase</span></strong></span><span><span class="kobospan" id="kobo.793.1">:</span></span></p>
<pre class="source-code"><span class="kobospan1" id="kobo.794.1">
class AddCaptionToVideoUseCase() {
    suspend fun addCaption(videoFile: File, captionText:
    String): Result&lt;File&gt; = withContext(Dispatchers.IO) {
        val outputFile = File(
            videoFile.parent,
                "${videoFile.nameWithoutExtension}
                    _captioned.mp4")
        val fontFilePath =
            "/system/fonts/Roboto-Regular.ttf"
        val ffmpegCommand = arrayOf(
            "-i", videoFile.absolutePath,
            "-vf", "drawtext=fontfile=$fontFilePath:
                text='$captionText':
                    fontcolor=white:
                        fontsize=24:x=(w-text_w)/2:
                            y=(h-text_h)-10",
            "-c:a", "aac",
            "-b:a", "192k",
            outputFile.absolutePath
        )
        try {
            val executionId =
            FFmpeg.executeAsync(ffmpegCommand)
            { _, returnCode -&gt;
                if (returnCode !=
                Config.RETURN_CODE_SUCCESS) {
                    Result.failure&lt;AddCaptionToVideoError&gt;(
                        AddCaptionToVideoError)
                }
            }
            // Optionally handle the executionId, e.g., for
               cancellation
            Result.success(outputFile)
        } catch (e: Exception) {
            Result.failure(e)
        }
    }
}
object AddCaptionToVideoError: Throwable("There was an
error adding the caption to the video") {
    private fun readResolve(): Any = AddCaptionToVideoError
}</span></pre> <p class="calibre3"><span class="kobospan" id="kobo.795.1">In the preceding code, we start by creating a suspend function, </span><strong class="source-inline"><span class="kobospan" id="kobo.796.1">addCaption</span></strong><span class="kobospan" id="kobo.797.1">, which is specifically designed to facilitate asynchronous execution via coroutines. </span><span class="kobospan" id="kobo.797.2">As the action of adding a caption involves intensive tasks such as video processing, we should avoid executing this kind of logic in the main thread to prevent any lag or unresponsiveness in the application. </span><span class="kobospan" id="kobo.797.3">The function takes two parameters: a </span><strong class="source-inline"><span class="kobospan" id="kobo.798.1">File</span></strong><span class="kobospan" id="kobo.799.1"> object representing the video file and a </span><strong class="source-inline"><span class="kobospan" id="kobo.800.1">String</span></strong><span class="kobospan" id="kobo.801.1"> containing the caption text to </span><span><span class="kobospan" id="kobo.802.1">be added.</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.803.1">Inside the </span><strong class="source-inline"><span class="kobospan" id="kobo.804.1">addCaption</span></strong><span class="kobospan" id="kobo.805.1"> function, the execution context is switched to the I/O dispatcher. </span><span class="kobospan" id="kobo.805.2">This is done to optimize for I/O operations, ensuring that the file processing workload is handled appropriately without straining the main thread. </span><span class="kobospan" id="kobo.805.3">The function proceeds to create an </span><strong class="source-inline"><span class="kobospan" id="kobo.806.1">outputFile</span></strong><span class="kobospan" id="kobo.807.1"> object. </span><span class="kobospan" id="kobo.807.2">This object represents the new video file that will be </span><span><span class="kobospan" id="kobo.808.1">generated post-captioning.</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.809.1">The next segment</span><a id="_idIndexMarker734" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.810.1"> in the function involves constructing a command</span><a id="_idIndexMarker735" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.811.1"> string for FFmpeg. </span><span class="kobospan" id="kobo.811.2">This command is carefully crafted to utilize FFmpeg’s </span><strong class="source-inline"><span class="kobospan" id="kobo.812.1">drawtext</span></strong><span class="kobospan" id="kobo.813.1"> filter, enabling the provided caption text to be overlaid on the video. </span><span class="kobospan" id="kobo.813.2">Let’s analyze the command that we used in the previous </span><span><span class="kobospan" id="kobo.814.1">code block:</span></span></p>
<pre class="source-code"><span class="kobospan1" id="kobo.815.1">
val command = "-i ${videoFile.absolutePath} -vf drawtext=text='$captionText':fontcolor=white:fontsize=24:x=(w-text_w)/2:y=(h-text_h)/2 -codec:a copy ${outputFile.absolutePath}"</span></pre> <p class="calibre3"><span class="kobospan" id="kobo.816.1">Let’s break this </span><span><span class="kobospan" id="kobo.817.1">command down:</span></span></p>
<ul class="calibre15">
<li class="calibre14"><strong class="source-inline1"><span class="kobospan" id="kobo.818.1">-i ${videoFile.absolutePath}</span></strong><span class="kobospan" id="kobo.819.1">: This part of the command specifies the input file for FFmpeg to process. </span><span class="kobospan" id="kobo.819.2">The </span><strong class="source-inline1"><span class="kobospan" id="kobo.820.1">-i</span></strong><span class="kobospan" id="kobo.821.1"> flag is used for input files in FFmpeg and </span><strong class="source-inline1"><span class="kobospan" id="kobo.822.1">${videoFile.absolutePath}</span></strong><span class="kobospan" id="kobo.823.1"> dynamically inserts the absolute path of the video file </span><span><span class="kobospan" id="kobo.824.1">you’re processing.</span></span></li>
<li class="calibre14"><strong class="source-inline1"><span class="kobospan" id="kobo.825.1">-vf drawtext=text='$captionText':...</span></strong><span class="kobospan" id="kobo.826.1">: The </span><strong class="source-inline1"><span class="kobospan" id="kobo.827.1">-vf</span></strong><span class="kobospan" id="kobo.828.1"> (video filter) flag is used to apply filters to the video. </span><span class="kobospan" id="kobo.828.2">Here, the </span><strong class="source-inline1"><span class="kobospan" id="kobo.829.1">drawtext</span></strong><span class="kobospan" id="kobo.830.1"> filter is used to add text to </span><span><span class="kobospan" id="kobo.831.1">the video.</span></span></li>
<li class="calibre14"><strong class="source-inline1"><span class="kobospan" id="kobo.832.1">text='$captionText'</span></strong><span class="kobospan" id="kobo.833.1">: This specifies the text to be drawn. </span><span class="kobospan" id="kobo.833.2">Here, </span><strong class="source-inline1"><span class="kobospan" id="kobo.834.1">$captionText</span></strong><span class="kobospan" id="kobo.835.1"> is the variable holding the caption text, which is dynamically inserted into </span><span><span class="kobospan" id="kobo.836.1">the command.</span></span></li>
<li class="calibre14"><strong class="source-inline1"><span class="kobospan" id="kobo.837.1">fontcolor=white</span></strong><span class="kobospan" id="kobo.838.1">: Sets the font color of the text </span><span><span class="kobospan" id="kobo.839.1">to white.</span></span></li>
<li class="calibre14"><strong class="source-inline1"><span class="kobospan" id="kobo.840.1">fontsize=24</span></strong><span class="kobospan" id="kobo.841.1">: Defines the size of the font used for </span><span><span class="kobospan" id="kobo.842.1">the text.</span></span></li>
<li class="calibre14"><strong class="source-inline1"><span class="kobospan" id="kobo.843.1">x=(w-text_w)/2</span></strong><span class="kobospan" id="kobo.844.1">: This sets the horizontal position of the text. </span><span class="kobospan" id="kobo.844.2">Here, </span><strong class="source-inline1"><span class="kobospan" id="kobo.845.1">w</span></strong><span class="kobospan" id="kobo.846.1"> represents the width of the video, and </span><strong class="source-inline1"><span class="kobospan" id="kobo.847.1">text_w</span></strong><span class="kobospan" id="kobo.848.1"> is the width of the text. </span><span class="kobospan" id="kobo.848.2">By setting </span><strong class="source-inline1"><span class="kobospan" id="kobo.849.1">x to (w-text_w)/2</span></strong><span class="kobospan" id="kobo.850.1">, the text is </span><span><span class="kobospan" id="kobo.851.1">horizontally centered.</span></span></li>
<li class="calibre14"><strong class="source-inline1"><span class="kobospan" id="kobo.852.1">y=(h-text_h)/2</span></strong><span class="kobospan" id="kobo.853.1">: Similarly, this sets the vertical position of the text. </span><span class="kobospan" id="kobo.853.2">Here, </span><strong class="source-inline1"><span class="kobospan" id="kobo.854.1">h</span></strong><span class="kobospan" id="kobo.855.1"> is the height of the video, and </span><strong class="source-inline1"><span class="kobospan" id="kobo.856.1">text_h</span></strong><span class="kobospan" id="kobo.857.1"> is the height of the text. </span><span class="kobospan" id="kobo.857.2">This formula vertically centers the text within </span><span><span class="kobospan" id="kobo.858.1">the video.</span></span></li>
<li class="calibre14"><strong class="source-inline1"><span class="kobospan" id="kobo.859.1">-codec:a acc</span></strong><span class="kobospan" id="kobo.860.1">: This part of the command instructs FFmpeg to use </span><strong class="source-inline1"><span class="kobospan" id="kobo.861.1">acc</span></strong><span class="kobospan" id="kobo.862.1"> as the codec for </span><span><span class="kobospan" id="kobo.863.1">audio streaming.</span></span></li>
<li class="calibre14"><strong class="source-inline1"><span class="kobospan" id="kobo.864.1">-b:a=192k</span></strong><span class="kobospan" id="kobo.865.1">: This part of the command sets the bitrate </span><span><span class="kobospan" id="kobo.866.1">to 192k.</span></span></li>
<li class="calibre14"><strong class="source-inline1"><span class="kobospan" id="kobo.867.1">${outputFile.absolutePath}</span></strong><span class="kobospan" id="kobo.868.1">: The last part of the command specifies the output file’s path, where the processed video (with the caption added) will </span><span><span class="kobospan" id="kobo.869.1">be saved.</span></span></li>
</ul>
<p class="calibre3"><span class="kobospan" id="kobo.870.1">Executing this FFmpeg command is handled asynchronously with </span><strong class="source-inline"><span class="kobospan" id="kobo.871.1">FFmpeg.executeAsync()</span></strong><span class="kobospan" id="kobo.872.1">. </span><span class="kobospan" id="kobo.872.2">This method is pivotal for running the command in a non-blocking manner and is accompanied by a Lambda function for handling the execution result. </span><span class="kobospan" id="kobo.872.3">The Lambda function evaluates </span><strong class="source-inline"><span class="kobospan" id="kobo.873.1">returnCode</span></strong><span class="kobospan" id="kobo.874.1"> from the FFmpeg execution. </span><span class="kobospan" id="kobo.874.2">In the case of a non-successful execution (indicated by any return code other than </span><strong class="source-inline"><span class="kobospan" id="kobo.875.1">RETURN_CODE_SUCCESS</span></strong><span class="kobospan" id="kobo.876.1">), the function constructs </span><strong class="source-inline"><span class="kobospan" id="kobo.877.1">Result.failure</span></strong><span class="kobospan" id="kobo.878.1">, wrapping a custom </span><strong class="source-inline"><span class="kobospan" id="kobo.879.1">AddCaptionToVideoError</span></strong><span class="kobospan" id="kobo.880.1"> object. </span><span class="kobospan" id="kobo.880.2">This custom error object, defined as a singleton, provides a specific error message indicating an issue with the </span><span><span class="kobospan" id="kobo.881.1">captioning process.</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.882.1">On the flip side, successful command</span><a id="_idIndexMarker736" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.883.1"> execution results in </span><strong class="source-inline"><span class="kobospan" id="kobo.884.1">Result.success</span></strong><span class="kobospan" id="kobo.885.1">, passing</span><a id="_idIndexMarker737" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.886.1"> along </span><strong class="source-inline"><span class="kobospan" id="kobo.887.1">outputFile</span></strong><span class="kobospan" id="kobo.888.1">. </span><span class="kobospan" id="kobo.888.2">This bifurcation in handling success and failure scenarios ensures robust error management and clear feedback regarding the outcome of the </span><span><span class="kobospan" id="kobo.889.1">captioning process.</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.890.1">Now, we can use </span><strong class="source-inline"><span class="kobospan" id="kobo.891.1">AddCaptionToVideoUseCase</span></strong> <span><span class="kobospan" id="kobo.892.1">in </span></span><span><strong class="source-inline"><span class="kobospan" id="kobo.893.1">StoryEditorViewModel</span></strong></span><span><span class="kobospan" id="kobo.894.1">:</span></span></p>
<pre class="source-code"><span class="kobospan1" id="kobo.895.1">
class StoryEditorViewModel(
    private val saveCaptureUseCase: SaveCaptureUseCase,
    private val addCaptionToVideoUseCase:
    AddCaptionToVideoUseCase
): ViewModel() {
  // Other variables we defined for the photo feature
    var videoFile: File? </span><span class="kobospan1" id="kobo.895.2">= null
  // Other code we already added for the photo feature
    fun addCaptionToVideo(captionText: String) {
        videoFile?.let { file -&gt;
            viewModelScope.launch {
                val result =
                    addCaptionToVideoUseCase.addCaption(
                        file, captionText)
                // Handle the result of the captioning
                   process
            }
        }
    }
}</span></pre> <p class="calibre3"><span class="kobospan" id="kobo.896.1">We start by injecting </span><strong class="source-inline"><span class="kobospan" id="kobo.897.1">AddCaptionToVideoUseCase</span></strong><span class="kobospan" id="kobo.898.1"> into </span><strong class="source-inline"><span class="kobospan" id="kobo.899.1">StoryEditorViewModel</span></strong><span class="kobospan" id="kobo.900.1"> using</span><a id="_idIndexMarker738" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.901.1"> its constructor. </span><span class="kobospan" id="kobo.901.2">Then, we declare</span><a id="_idIndexMarker739" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.902.1"> a </span><strong class="source-inline"><span class="kobospan" id="kobo.903.1">videoFile</span></strong><span class="kobospan" id="kobo.904.1"> variable in </span><strong class="source-inline"><span class="kobospan" id="kobo.905.1">ViewModel</span></strong><span class="kobospan" id="kobo.906.1">, which holds the video we’re working with – it’s nullable because there might be times when we don’t have a video to display or edit. </span><span class="kobospan" id="kobo.906.2">In </span><strong class="source-inline"><span class="kobospan" id="kobo.907.1">videoFile</span></strong><span class="kobospan" id="kobo.908.1">, we should have stored the view we have </span><span><span class="kobospan" id="kobo.909.1">already recorded.</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.910.1">Next, the core function in this </span><strong class="source-inline"><span class="kobospan" id="kobo.911.1">ViewModel</span></strong><span class="kobospan" id="kobo.912.1"> is </span><strong class="source-inline"><span class="kobospan" id="kobo.913.1">addCaptionToVideo</span></strong><span class="kobospan" id="kobo.914.1">. </span><span class="kobospan" id="kobo.914.2">This function takes the caption text as input and uses the video file we have. </span><span class="kobospan" id="kobo.914.3">First, it checks if </span><strong class="source-inline"><span class="kobospan" id="kobo.915.1">videoFile</span></strong><span class="kobospan" id="kobo.916.1"> isn’t </span><strong class="source-inline"><span class="kobospan" id="kobo.917.1">null</span></strong><span class="kobospan" id="kobo.918.1">. </span><span class="kobospan" id="kobo.918.2">If we have a video, it proceeds; if not, </span><span><span class="kobospan" id="kobo.919.1">nothing happens.</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.920.1">Inside </span><strong class="source-inline"><span class="kobospan" id="kobo.921.1">addCaptionToVideo</span></strong><span class="kobospan" id="kobo.922.1">, by launching a coroutine within </span><strong class="source-inline"><span class="kobospan" id="kobo.923.1">viewModelScope</span></strong><span class="kobospan" id="kobo.924.1">, we ensure that our caption-adding process doesn’t freeze the UI. </span><span class="kobospan" id="kobo.924.2">This is crucial for maintaining a smooth </span><span><span class="kobospan" id="kobo.925.1">user experience.</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.926.1">The </span><strong class="source-inline"><span class="kobospan" id="kobo.927.1">addCaption</span></strong><span class="kobospan" id="kobo.928.1"> method of our use case is then called with the video file and caption text. </span><span class="kobospan" id="kobo.928.2">Whatever comes back from this operation – success or failure – is stored in </span><span><span class="kobospan" id="kobo.929.1">the result.</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.930.1">The </span><strong class="source-inline"><span class="kobospan" id="kobo.931.1">// Handle the result of the captioning process</span></strong><span class="kobospan" id="kobo.932.1"> comment is where you’d put our code to update the UI based on the result. </span><span class="kobospan" id="kobo.932.2">This could mean displaying the captioned video, showing an error message, or whatever else makes sense for our app. </span><span class="kobospan" id="kobo.932.3">For simplicity, we won’t be adding it here just yet, but we will learn more about video playback in the last three chapters of this book when we create a </span><span><span class="kobospan" id="kobo.933.1">Netflix-esque app.</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.934.1">But we can still test the effect</span><a id="_idIndexMarker740" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.935.1"> in our video. </span><span class="kobospan" id="kobo.935.2">We just have to look at the internal app</span><a id="_idIndexMarker741" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.936.1"> files using Device Explorer in Android Studio. </span><span class="kobospan" id="kobo.936.2">There, we’ll see two files – one of the original video, and the other a modified one with the </span><span><strong class="source-inline"><span class="kobospan" id="kobo.937.1">_captioned</span></strong></span><span><span class="kobospan" id="kobo.938.1"> suffix:</span></span></p>
<div class="calibre2">
<div class="img---figure" id="_idContainer048">
<span class="kobospan" id="kobo.939.1"><img alt="Figure 6.3: Device Explorer with video files in Android Studio" src="image/B19443_06_03.jpg" class="calibre4"/></span>
</div>
</div>
<p class="img---caption" lang="en-US" xml:lang="en-US"><span class="kobospan" id="kobo.940.1">Figure 6.3: Device Explorer with video files in Android Studio</span></p>
<p class="calibre3"><span class="kobospan" id="kobo.941.1">If we download the captioned</span><a id="_idIndexMarker742" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.942.1"> file video and play it, we should see that a caption</span><a id="_idIndexMarker743" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.943.1"> has been added to </span><span><span class="kobospan" id="kobo.944.1">the video:</span></span></p>
<div class="calibre2">
<div class="img---figure" id="_idContainer049">
<span class="kobospan" id="kobo.945.1"><img alt="Figure 6.4: A video with caption text stating, “This is the caption text”" src="image/B19443_06_04.jpg" class="calibre4"/></span>
</div>
</div>
<p class="img---caption" lang="en-US" xml:lang="en-US"><span class="kobospan" id="kobo.946.1">Figure 6.4: A video with caption text stating, “This is the caption text”</span></p>
<p class="calibre3"><span class="kobospan" id="kobo.947.1">Now that we know how to apply a caption to our video, let’s see how we can apply </span><span><span class="kobospan" id="kobo.948.1">a filter.</span></span></p>
<h1 id="_idParaDest-137" class="calibre5"><a id="_idTextAnchor138" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.949.1">Adding a filter to a video with FFmpeg</span></h1>
<p class="calibre3"><span class="kobospan" id="kobo.950.1">In this section, we will learn</span><a id="_idIndexMarker744" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.951.1"> how to add a filter</span><a id="_idIndexMarker745" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.952.1"> to our video. </span><span class="kobospan" id="kobo.952.2">A popular filter that is visually impactful is the “vignette” effect – this effect typically darkens the edges of the frame, drawing the viewer’s attention toward the center of the image or video, and can add a dramatic or cinematic quality to the footage. </span><span class="kobospan" id="kobo.952.3">FFmpeg has the capability to apply this artistic filter to videos, so let’s try </span><span><span class="kobospan" id="kobo.953.1">it out!</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.954.1">As we did with the caption, we will start by creating the use case: </span><strong class="source-inline"><span class="kobospan" id="kobo.955.1">AddVignetteEffectUseCase</span></strong><span class="kobospan" id="kobo.956.1">. </span><span class="kobospan" id="kobo.956.2">The primary role of </span><strong class="source-inline"><span class="kobospan" id="kobo.957.1">AddVignetteEffectUseCase</span></strong><span class="kobospan" id="kobo.958.1"> is to execute the business logic for applying the vignette effect to a given video file by using </span><strong class="source-inline"><span class="kobospan" id="kobo.959.1">mobile-ffmpeg</span></strong><span class="kobospan" id="kobo.960.1">. </span><span class="kobospan" id="kobo.960.2">We will use a specific </span><strong class="source-inline"><span class="kobospan" id="kobo.961.1">FFmpeg</span></strong><span class="kobospan" id="kobo.962.1"> command, </span><span><span class="kobospan" id="kobo.963.1">as follows:</span></span></p>
<pre class="source-code"><span class="kobospan1" id="kobo.964.1">
class AddVignetteEffectUseCase() {
    suspend fun addVignetteEffect(videoFile: File):
    Result&lt;File&gt; = withContext(Dispatchers.IO) {
        val outputFile = File(videoFile.parent,
            "${videoFile.nameWithoutExtension}
                _vignetted.mp4")
        val command = "-i ${videoFile.absolutePath} -vf
            vignette=angle=PI/4 ${outputFile.absolutePath}"
        try {
            val executionId = FFmpeg.executeAsync(command)
            { _, returnCode -&gt;
                if (returnCode !=
                Config.RETURN_CODE_SUCCESS) {
                    Result.failure&lt;AddVignetteEffectError&gt;(
                        AddVignetteEffectError)
                }
            }
            // Optionally handle the executionId, e.g., for
               cancellation
            Result.success(outputFile)
        } catch (e: Exception) {
            Result.failure(e)
        }
    }
}
object AddVignetteEffectError : Throwable("There was an
error adding the vignette effect to the video") {
    private fun readResolve(): Any = AddVignetteEffectError
}</span></pre> <p class="calibre3"><span class="kobospan" id="kobo.965.1">Let’s walk through </span><a id="_idIndexMarker746" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.966.1">the code in </span><strong class="source-inline"><span class="kobospan" id="kobo.967.1">AddVignetteEffectUseCase</span></strong><span class="kobospan" id="kobo.968.1">. </span><span class="kobospan" id="kobo.968.2">Here, </span><strong class="source-inline"><span class="kobospan" id="kobo.969.1">addVignetteEffect</span></strong><span class="kobospan" id="kobo.970.1"> is a suspend</span><a id="_idIndexMarker747" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.971.1"> function, meaning it’s designed to run asynchronously with Kotlin’s coroutines. </span><span class="kobospan" id="kobo.971.2">In this function, we take the video file that needs the vignette effect and start by defining where to save the processed video. </span><span class="kobospan" id="kobo.971.3">We keep the original video intact and create a new file for the output. </span><span class="kobospan" id="kobo.971.4">The output’s filename keeps the original name but with </span><strong class="source-inline"><span class="kobospan" id="kobo.972.1">_vignetted</span></strong><span class="kobospan" id="kobo.973.1"> added to it so that it’s easy </span><span><span class="kobospan" id="kobo.974.1">to track.</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.975.1">Next up, we build our FFmpeg command. </span><span class="kobospan" id="kobo.975.2">This command tells FFmpeg to apply the vignette effect. </span><span class="kobospan" id="kobo.975.3">Let’s see how this command (already present in the previous code block) works </span><span><span class="kobospan" id="kobo.976.1">in detail:</span></span></p>
<pre class="source-code"><span class="kobospan1" id="kobo.977.1">
val command = "-i ${videoFile.absolutePath} -vf vignette=angle=PI/4 ${outputFile.absolutePath}"</span></pre> <p class="calibre3"><span class="kobospan" id="kobo.978.1">This command is composed of the </span><span><span class="kobospan" id="kobo.979.1">following segments:</span></span></p>
<ul class="calibre15">
<li class="calibre14"><strong class="source-inline1"><span class="kobospan" id="kobo.980.1">-i ${videoFile.absolutePath}</span></strong><span class="kobospan" id="kobo.981.1">: This part of the command specifies the input file for FFmpeg to process. </span><span class="kobospan" id="kobo.981.2">The </span><strong class="source-inline1"><span class="kobospan" id="kobo.982.1">-i</span></strong><span class="kobospan" id="kobo.983.1"> flag is used for input files in FFmpeg and </span><strong class="source-inline1"><span class="kobospan" id="kobo.984.1">${videoFile.absolutePath}</span></strong><span class="kobospan" id="kobo.985.1"> dynamically inserts the absolute path of the video file you want to process. </span><span class="kobospan" id="kobo.985.2">In simple terms, it tells FFmpeg, “Here’s the video I want you to </span><span><span class="kobospan" id="kobo.986.1">work on.”</span></span></li>
<li class="calibre14"><strong class="source-inline1"><span class="kobospan" id="kobo.987.1">-vf vignette=angle=PI/4</span></strong><span class="kobospan" id="kobo.988.1">: This segment is where the vignette effect </span><span><span class="kobospan" id="kobo.989.1">is applied.</span></span></li>
<li class="calibre14"><strong class="source-inline1"><span class="kobospan" id="kobo.990.1">-vf</span></strong><span class="kobospan" id="kobo.991.1"> stands for video filters and is a powerful feature in FFmpeg that allows you to apply various transformations or effects to </span><span><span class="kobospan" id="kobo.992.1">your video.</span></span></li>
<li class="calibre14"><strong class="source-inline1"><span class="kobospan" id="kobo.993.1">vignette=angle=PI/4</span></strong><span class="kobospan" id="kobo.994.1">: This is the specific filter and setting for the vignette effect. </span><span class="kobospan" id="kobo.994.2">The vignette filter in FFmpeg is used to apply the vignette effect, which typically darkens the edges of the video to focus attention on the center. </span><span class="kobospan" id="kobo.994.3">The </span><strong class="source-inline1"><span class="kobospan" id="kobo.995.1">angle=PI/4</span></strong><span class="kobospan" id="kobo.996.1"> part is a parameter of the vignette filter that controls the angle of the effect. </span><span class="kobospan" id="kobo.996.2">This specific setting, </span><strong class="source-inline1"><span class="kobospan" id="kobo.997.1">PI/4</span></strong><span class="kobospan" id="kobo.998.1">, is chosen to give a visually pleasing vignette. </span><span class="kobospan" id="kobo.998.2">It’s a bit of a creative choice, balancing subtlety </span><span><span class="kobospan" id="kobo.999.1">and impact.</span></span></li>
<li class="calibre14"><strong class="source-inline1"><span class="kobospan" id="kobo.1000.1">${outputFile.absolutePath}</span></strong><span class="kobospan" id="kobo.1001.1">: The last part of the command specifies where to save the processed video. </span><span class="kobospan" id="kobo.1001.2">It takes the path where you want the new video (with the vignette effect applied) to be saved. </span><span class="kobospan" id="kobo.1001.3">By placing it here in the command, you’re telling FFmpeg, “Once you’re done adding the effect, save the new </span><span><span class="kobospan" id="kobo.1002.1">video here.”</span></span></li>
</ul>
<p class="calibre3"><span class="kobospan" id="kobo.1003.1">When it comes to running</span><a id="_idIndexMarker748" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.1004.1"> this command, we</span><a id="_idIndexMarker749" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.1005.1"> use </span><strong class="source-inline"><span class="kobospan" id="kobo.1006.1">FFmpeg.executeAsync</span></strong><span class="kobospan" id="kobo.1007.1">. </span><span class="kobospan" id="kobo.1007.2">This method is great because it runs our command without blocking the app. </span><span class="kobospan" id="kobo.1007.3">The method also has a way to check if everything went as planned. </span><span class="kobospan" id="kobo.1007.4">If the command runs successfully, we return the path of our new vignette video. </span><span class="kobospan" id="kobo.1007.5">But if something goes wrong, we catch it and return an error. </span><span class="kobospan" id="kobo.1007.6">Here, </span><strong class="source-inline"><span class="kobospan" id="kobo.1008.1">AddVignetteEffectError</span></strong><span class="kobospan" id="kobo.1009.1"> is a custom error message we throw if the FFmpeg command doesn’t execute properly. </span><span class="kobospan" id="kobo.1009.2">It’s a simple way to know exactly what went wrong when we add</span><a id="_idIndexMarker750" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.1010.1"> our vignette</span><a id="_idIndexMarker751" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.1011.1"> effect. </span><span class="kobospan" id="kobo.1011.2">And with this, </span><strong class="source-inline"><span class="kobospan" id="kobo.1012.1">AddVignetteUseCase</span></strong> <span><span class="kobospan" id="kobo.1013.1">is ready.</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.1014.1">Now, we can integrate this use case </span><span><span class="kobospan" id="kobo.1015.1">into </span></span><span><strong class="source-inline"><span class="kobospan" id="kobo.1016.1">StoryEditorViewModel</span></strong></span><span><span class="kobospan" id="kobo.1017.1">:</span></span></p>
<pre class="source-code"><span class="kobospan1" id="kobo.1018.1">
class StoryEditorViewModel(
    private val saveCaptureUseCase: SaveCaptureUseCase,
    private val addCaptionToVideoUseCase:
        AddCaptionToVideoUseCase,
    private val addVignetteEffectUseCase:
        AddVignetteEffectUseCase
): ViewModel() {
...
</span><span class="kobospan1" id="kobo.1018.2">    var videoFile: File? </span><span class="kobospan1" id="kobo.1018.3">= null
...
</span><span class="kobospan1" id="kobo.1018.4">    fun addVignetteFilterToVideo() {
        videoFile?.let { file -&gt;
            viewModelScope.launch {
                val result =
                    addVignetteEffectUseCase
                        .addVignetteEffect(file)
                // Handle the result of the filter process
            }
        }
    }
}</span></pre> <p class="calibre3"><span class="kobospan" id="kobo.1019.1">Here, </span><strong class="source-inline"><span class="kobospan" id="kobo.1020.1">StoryEditorViewModel</span></strong><span class="kobospan" id="kobo.1021.1"> is structured to receive </span><strong class="source-inline"><span class="kobospan" id="kobo.1022.1">AddVignetteEffectUseCase</span></strong><span class="kobospan" id="kobo.1023.1"> as </span><span><span class="kobospan" id="kobo.1024.1">a dependency.</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.1025.1">Within this ViewModel, we maintain a </span><strong class="source-inline"><span class="kobospan" id="kobo.1026.1">videoFile</span></strong><span class="kobospan" id="kobo.1027.1"> property, which holds a reference to the video file that the vignette effect will be applied to. </span><span class="kobospan" id="kobo.1027.2">The nullable nature of this property allows for scenarios where a video file may not be </span><span><span class="kobospan" id="kobo.1028.1">immediately available.</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.1029.1">The function to execute this functionality is </span><strong class="source-inline"><span class="kobospan" id="kobo.1030.1">addVignetteEffectToVideo</span></strong><span class="kobospan" id="kobo.1031.1">. </span><span class="kobospan" id="kobo.1031.2">When invoked, this function checks whether </span><strong class="source-inline"><span class="kobospan" id="kobo.1032.1">videoFile</span></strong><span class="kobospan" id="kobo.1033.1"> is not null, ensuring that there is a valid file to process. </span><span class="kobospan" id="kobo.1033.2">If a video file is available, the function proceeds to launch a coroutine </span><span><span class="kobospan" id="kobo.1034.1">within </span></span><span><strong class="source-inline"><span class="kobospan" id="kobo.1035.1">viewModelScope</span></strong></span><span><span class="kobospan" id="kobo.1036.1">.</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.1037.1">Inside the coroutine, the </span><strong class="source-inline"><span class="kobospan" id="kobo.1038.1">addVignetteEffectUseCase.addVignetteEffect</span></strong><span class="kobospan" id="kobo.1039.1"> method is called</span><a id="_idIndexMarker752" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.1040.1"> with the video file</span><a id="_idIndexMarker753" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.1041.1"> as its argument. </span><span class="kobospan" id="kobo.1041.2">This is where the vignette effect is applied to the video. </span><span class="kobospan" id="kobo.1041.3">The result of this operation is captured in a variable named </span><strong class="source-inline"><span class="kobospan" id="kobo.1042.1">result</span></strong><span class="kobospan" id="kobo.1043.1">. </span><span class="kobospan" id="kobo.1043.2">This result could indicate either a successful application of the effect or a failure due to </span><span><span class="kobospan" id="kobo.1044.1">some error.</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.1045.1">The commented section within the function, </span><strong class="source-inline"><span class="kobospan" id="kobo.1046.1">// Handle the result of the vignette effect process</span></strong><span class="kobospan" id="kobo.1047.1">, is where we would typically handle the outcome of the operation. </span><span class="kobospan" id="kobo.1047.2">Depending on whether the vignette effect was successfully applied or not, this section could include code for updating the UI to display the processed video or handling any errors that might have occurred during </span><span><span class="kobospan" id="kobo.1048.1">the process.</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.1049.1">As we mentioned when we discussed adding captions, we haven’t implemented video playback yet, but we can still test the effect in our video. </span><span class="kobospan" id="kobo.1049.2">Just like back in </span><span><em class="italic"><span class="kobospan" id="kobo.1050.1">Figure 6</span></em></span><em class="italic"><span class="kobospan" id="kobo.1051.1">.3</span></em><span class="kobospan" id="kobo.1052.1">, we can see two files, but this time one of them has a </span><strong class="source-inline"><span class="kobospan" id="kobo.1053.1">_vignetted</span></strong><span class="kobospan" id="kobo.1054.1"> suffix to indicate it has </span><span><span class="kobospan" id="kobo.1055.1">been modified:</span></span></p>
<div class="calibre2">
<div class="img---figure" id="_idContainer050">
<span class="kobospan" id="kobo.1056.1"><img alt="Figure 6.5: Device Explorer in Android Studio" src="image/B19443_06_05.jpg" class="calibre4"/></span>
</div>
</div>
<p class="img---caption" lang="en-US" xml:lang="en-US"><span class="kobospan" id="kobo.1057.1">Figure 6.5: Device Explorer in Android Studio</span></p>
<p class="calibre3"><span class="kobospan" id="kobo.1058.1">We can download</span><a id="_idIndexMarker754" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.1059.1"> and reproduce both videos</span><a id="_idIndexMarker755" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.1060.1"> to check and test </span><span><span class="kobospan" id="kobo.1061.1">the filter:</span></span></p>
<div class="calibre2">
<div class="img---figure" id="_idContainer051">
<span class="kobospan" id="kobo.1062.1"><img alt="Figure 6.6: Video without (left) and with (right) the vignette filter effect applied" src="image/B19443_06_06.jpg" class="calibre4"/></span>
</div>
</div>
<p class="img---caption" lang="en-US" xml:lang="en-US"><span class="kobospan" id="kobo.1063.1">Figure 6.6: Video without (left) and with (right) the vignette filter effect applied</span></p>
<p class="calibre3"><span class="kobospan" id="kobo.1064.1">Now that we know</span><a id="_idIndexMarker756" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.1065.1"> how to integrate FFmpeg</span><a id="_idIndexMarker757" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.1066.1"> and use its commands to edit the user’s videos, it is time to upload those videos so that they can be shared between </span><span><span class="kobospan" id="kobo.1067.1">their contacts.</span></span></p>
<h1 id="_idParaDest-138" class="calibre5"><a id="_idTextAnchor139" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.1068.1">Uploading the video</span></h1>
<p class="calibre3"><span class="kobospan" id="kobo.1069.1">Now that our video</span><a id="_idIndexMarker758" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.1070.1"> is ready, it’s time to upload it to any service, from where it can be shared with the user contacts. </span><span class="kobospan" id="kobo.1070.2">We’re going to use Firebase Storage for this (to learn how to set up Firebase Storage, please refer to </span><a href="B19443_03.xhtml#_idTextAnchor060" class="calibre6 pcalibre1 pcalibre"><span><em class="italic"><span class="kobospan" id="kobo.1071.1">Chapter 3</span></em></span></a><span><span class="kobospan" id="kobo.1072.1">).</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.1073.1">We’ll start by creating a data source that will be responsible for uploading the video to Firebase Storage. </span><span class="kobospan" id="kobo.1073.2">We will call </span><span><span class="kobospan" id="kobo.1074.1">it </span></span><span><strong class="source-inline"><span class="kobospan" id="kobo.1075.1">VideoStorageDataSource</span></strong></span><span><span class="kobospan" id="kobo.1076.1">:</span></span></p>
<pre class="source-code"><span class="kobospan1" id="kobo.1077.1">
class VideoStorageDataSource {
    fun uploadVideo(videoFile: File, onSuccess: (String) -&gt;
    Unit, onError: (Exception) -&gt; Unit) {
        val storageReference =
            FirebaseStorage.getInstance().reference
        val videoRef = storageReference.child(
            "videos/${videoFile.name}")
        val uploadTask =
            videoRef.putFile(Uri.fromFile(videoFile))
        uploadTask.addOnSuccessListener {
        videoRef.downloadUrl.addOnSuccessListener { uri -&gt;
            onSuccess(uri.toString())
        }
        }.addOnFailureListener { exception -&gt;
            onError(exception)
        }
    }
}</span></pre> <p class="calibre3"><span class="kobospan" id="kobo.1078.1">Inside the </span><strong class="source-inline"><span class="kobospan" id="kobo.1079.1">uploadVideo</span></strong><span class="kobospan" id="kobo.1080.1"> function, we start indicating that we’ll execute the logic in the </span><span><span class="kobospan" id="kobo.1081.1">I/O dispatcher.</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.1082.1">Then, the heart of the function</span><a id="_idIndexMarker759" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.1083.1"> is where we use Firebase Storage. </span><span class="kobospan" id="kobo.1083.2">First, we obtain the reference of the storage using </span><strong class="source-inline"><span class="kobospan" id="kobo.1084.1">FirebaseStorage.getInstance().reference</span></strong><span class="kobospan" id="kobo.1085.1">, after which we set up a reference to where we want our video to be stored in Firebase </span><span><span class="kobospan" id="kobo.1086.1">using </span></span><span><strong class="source-inline"><span class="kobospan" id="kobo.1087.1">storageReference.child("videos/${videoFile.name}")</span></strong></span><span><span class="kobospan" id="kobo.1088.1">.</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.1089.1">Next, we start the upload itself. </span><span class="kobospan" id="kobo.1089.2">The </span><strong class="source-inline"><span class="kobospan" id="kobo.1090.1">putFile</span></strong><span class="kobospan" id="kobo.1091.1"> method is used to upload the video file. </span><span class="kobospan" id="kobo.1091.2">This is where </span><strong class="source-inline"><span class="kobospan" id="kobo.1092.1">await()</span></strong><span class="kobospan" id="kobo.1093.1"> comes into play. </span><span class="kobospan" id="kobo.1093.2">This </span><strong class="source-inline"><span class="kobospan" id="kobo.1094.1">await()</span></strong><span class="kobospan" id="kobo.1095.1"> is a suspending function that patiently waits for the upload to complete without blocking the thread. </span><span class="kobospan" id="kobo.1095.2">It’s part of Kotlin’s coroutines magic and is a game-changer for </span><span><span class="kobospan" id="kobo.1096.1">async operations.</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.1097.1">Once the upload is done, we need to grab the URL of our video. </span><span class="kobospan" id="kobo.1097.2">So, we call </span><strong class="source-inline"><span class="kobospan" id="kobo.1098.1">downloadUrl.await()</span></strong><span class="kobospan" id="kobo.1099.1">. </span><span class="kobospan" id="kobo.1099.2">Just like with the upload, </span><strong class="source-inline"><span class="kobospan" id="kobo.1100.1">await()</span></strong><span class="kobospan" id="kobo.1101.1">suspends the operation until Firebase gives us the </span><span><span class="kobospan" id="kobo.1102.1">video’s URL.</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.1103.1">We’ve also got our error handling covered. </span><span class="kobospan" id="kobo.1103.2">The upload and URL retrieval process is wrapped in a </span><strong class="source-inline"><span class="kobospan" id="kobo.1104.1">try-catch</span></strong><span class="kobospan" id="kobo.1105.1"> block. </span><span class="kobospan" id="kobo.1105.2">If anything goes sideways during the upload or while fetching the URL, we catch the exception and wrap it up in </span><strong class="source-inline"><span class="kobospan" id="kobo.1106.1">Result.failure(e)</span></strong><span class="kobospan" id="kobo.1107.1">. </span><span class="kobospan" id="kobo.1107.2">On the other hand, if all goes well, we return </span><strong class="source-inline"><span class="kobospan" id="kobo.1108.1">Result.success(downloadUrl.toString())</span></strong><span class="kobospan" id="kobo.1109.1">, handing over the URL of the newly </span><span><span class="kobospan" id="kobo.1110.1">uploaded video.</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.1111.1">Next, we will implement the repository that will be responsible for managing and connecting the data sources to the domain layer. </span><span class="kobospan" id="kobo.1111.2">We will call its interface </span><strong class="source-inline"><span class="kobospan" id="kobo.1112.1">VideoRepository</span></strong><span class="kobospan" id="kobo.1113.1"> and the </span><span><span class="kobospan" id="kobo.1114.1">implementation </span></span><span><strong class="source-inline"><span class="kobospan" id="kobo.1115.1">VideoRepositoryImpl</span></strong></span><span><span class="kobospan" id="kobo.1116.1">:</span></span></p>
<pre class="source-code"><span class="kobospan1" id="kobo.1117.1">
interface VideoRepository {
    suspend fun uploadVideo(videoFile: File):
        Result&lt;String&gt;
}
class VideoRepositoryImpl(private val
videoStorageDataSource: VideoStorageDataSource) :
VideoRepository {
    override suspend fun uploadVideo(videoFile: File):
    Result&lt;String&gt; {
        return try {
            var uploadResult: Result&lt;String&gt; =
                Result.failure(RuntimeException("Upload
                    failed"))
            firebaseStorageDataSource.uploadVideo(
            videoFile, { url -&gt;
                uploadResult = Result.success(url)
            }, { exception -&gt;
                uploadResult = Result.failure(exception)
            })
            uploadResult
        } catch (e: Exception) {
            Result.failure(e)
        }
    }
}</span></pre> <p class="calibre3"><span class="kobospan" id="kobo.1118.1">First up, we have our </span><strong class="source-inline"><span class="kobospan" id="kobo.1119.1">VideoRepository</span></strong><span class="kobospan" id="kobo.1120.1"> interface. </span><span class="kobospan" id="kobo.1120.2">This is a straightforward Kotlin interface with one key </span><span><span class="kobospan" id="kobo.1121.1">function: </span></span><span><strong class="source-inline"><span class="kobospan" id="kobo.1122.1">uploadVideo</span></strong></span><span><span class="kobospan" id="kobo.1123.1">.</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.1124.1">Next, we have the </span><strong class="source-inline"><span class="kobospan" id="kobo.1125.1">VideoRepositoryImpl</span></strong><span class="kobospan" id="kobo.1126.1"> class, which implements</span><a id="_idIndexMarker760" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.1127.1"> the </span><strong class="source-inline"><span class="kobospan" id="kobo.1128.1">VideoRepository</span></strong><span class="kobospan" id="kobo.1129.1"> interface. </span><span class="kobospan" id="kobo.1129.2">This class is where the action happens. </span><span class="kobospan" id="kobo.1129.3">It’s initialized with an instance </span><span><span class="kobospan" id="kobo.1130.1">of </span></span><span><strong class="source-inline"><span class="kobospan" id="kobo.1131.1">VideoStorageDataSource</span></strong></span><span><span class="kobospan" id="kobo.1132.1">.</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.1133.1">Then, the </span><strong class="source-inline"><span class="kobospan" id="kobo.1134.1">uploadVideo</span></strong><span class="kobospan" id="kobo.1135.1"> function follows a </span><strong class="source-inline"><span class="kobospan" id="kobo.1136.1">try-catch</span></strong><span class="kobospan" id="kobo.1137.1"> pattern for robust error handling. </span><span class="kobospan" id="kobo.1137.2">Initially, it sets up a default </span><strong class="source-inline"><span class="kobospan" id="kobo.1138.1">uploadResult</span></strong><span class="kobospan" id="kobo.1139.1"> as a failure. </span><span class="kobospan" id="kobo.1139.2">This is a cautious approach, assuming things might go wrong, and we’ll update this only if the </span><span><span class="kobospan" id="kobo.1140.1">upload succeeds.</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.1141.1">Then, we call </span><strong class="source-inline"><span class="kobospan" id="kobo.1142.1">uploadVideo</span></strong><span class="kobospan" id="kobo.1143.1"> on </span><strong class="source-inline"><span class="kobospan" id="kobo.1144.1">videoStorageDataSource</span></strong><span class="kobospan" id="kobo.1145.1">, passing the video file along with two Lambda functions for handling success and failure. </span><span class="kobospan" id="kobo.1145.2">If the upload is successful, the success Lambda updates </span><strong class="source-inline"><span class="kobospan" id="kobo.1146.1">uploadResult</span></strong><span class="kobospan" id="kobo.1147.1"> with the URL of the uploaded video. </span><span class="kobospan" id="kobo.1147.2">If there’s a failure, the failure Lambda updates </span><strong class="source-inline"><span class="kobospan" id="kobo.1148.1">uploadResult</span></strong><span class="kobospan" id="kobo.1149.1"> with the </span><span><span class="kobospan" id="kobo.1150.1">encountered exception.</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.1151.1">Finally, we return </span><strong class="source-inline"><span class="kobospan" id="kobo.1152.1">uploadResult</span></strong><span class="kobospan" id="kobo.1153.1">. </span><span class="kobospan" id="kobo.1153.2">If all goes well, we’ll see the URL</span><a id="_idIndexMarker761" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.1154.1"> of the uploaded video. </span><span class="kobospan" id="kobo.1154.2">If not, we’ll see the error that occurred during the process. </span><span class="kobospan" id="kobo.1154.3">The </span><strong class="source-inline"><span class="kobospan" id="kobo.1155.1">try-catch</span></strong><span class="kobospan" id="kobo.1156.1"> block ensures that if there’s an unexpected exception anywhere in this process, we catch it and return it as </span><span><span class="kobospan" id="kobo.1157.1">a failure.</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.1158.1">Now, it’s time for us to </span><span><span class="kobospan" id="kobo.1159.1">implement </span></span><span><strong class="source-inline"><span class="kobospan" id="kobo.1160.1">UploadVideoUseCase</span></strong></span><span><span class="kobospan" id="kobo.1161.1">:</span></span></p>
<pre class="source-code"><span class="kobospan1" id="kobo.1162.1">
class UploadVideoUseCase(private val videoRepository:
VideoRepository) {
    suspend fun uploadVideo(videoFile: File):
    Result&lt;String&gt; {
        return videoRepository.uploadVideo(videoFile)
    }
}</span></pre> <p class="calibre3"><span class="kobospan" id="kobo.1163.1">Here, we are injecting </span><strong class="source-inline"><span class="kobospan" id="kobo.1164.1">VideoRepository</span></strong><span class="kobospan" id="kobo.1165.1">. </span><span class="kobospan" id="kobo.1165.2">In the </span><strong class="source-inline"><span class="kobospan" id="kobo.1166.1">uploadVideo</span></strong><span class="kobospan" id="kobo.1167.1"> function, we call </span><strong class="source-inline"><span class="kobospan" id="kobo.1168.1">videoRepository</span></strong><span class="kobospan" id="kobo.1169.1"> and pass </span><strong class="source-inline"><span class="kobospan" id="kobo.1170.1">videoFile</span></strong><span class="kobospan" id="kobo.1171.1"> as </span><span><span class="kobospan" id="kobo.1172.1">a parameter.</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.1173.1">Finally, we will include </span><strong class="source-inline"><span class="kobospan" id="kobo.1174.1">UploadVideoUseCase</span></strong><span class="kobospan" id="kobo.1175.1"> in </span><strong class="source-inline"><span class="kobospan" id="kobo.1176.1">StoryEditorViewModel</span></strong><span class="kobospan" id="kobo.1177.1"> and use it </span><span><span class="kobospan" id="kobo.1178.1">from there:</span></span></p>
<pre class="source-code"><span class="kobospan1" id="kobo.1179.1">
class StoryEditorViewModel(
private val saveCaptureUseCase: SaveCaptureUseCase,
private val addCaptionToVideoUseCase:
    AddCaptionToVideoUseCase,
private val addVignetteEffectUseCase:
    AddVignetteEffectUseCase,
private val uploadVideoUseCase: UploadVideoUseCase
) : ViewModel() {
...
</span><span class="kobospan1" id="kobo.1179.2">    fun uploadVideo(videoFile: File) {
        viewModelScope.launch {
            val result =
                uploadVideoUseCase.uploadVideo(videoFile)
            // Handle the result of the upload process
        }
    }
}</span></pre> <p class="calibre3"><span class="kobospan" id="kobo.1180.1">In </span><strong class="source-inline"><span class="kobospan" id="kobo.1181.1">StoryEditorViewModel</span></strong><span class="kobospan" id="kobo.1182.1">, we add a function called </span><strong class="source-inline"><span class="kobospan" id="kobo.1183.1">uploadVideo</span></strong><span class="kobospan" id="kobo.1184.1"> that takes the video file and uses </span><strong class="source-inline"><span class="kobospan" id="kobo.1185.1">uploadVideoUseCase</span></strong><span class="kobospan" id="kobo.1186.1"> to upload it. </span><span class="kobospan" id="kobo.1186.2">The operation is performed within a coroutine to ensure it doesn’t block the </span><span><span class="kobospan" id="kobo.1187.1">UI thread.</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.1188.1">The </span><strong class="source-inline"><span class="kobospan" id="kobo.1189.1">// Handle the result of the upload process</span></strong><span class="kobospan" id="kobo.1190.1"> comment is where we would implement the logic based on the outcome of the upload. </span><span class="kobospan" id="kobo.1190.2">If the upload is successful, we might update the UI to show that the video has been uploaded or display the video URL. </span><span class="kobospan" id="kobo.1190.3">In case of failure, we would handle the error, perhaps by showing an error message to </span><span><span class="kobospan" id="kobo.1191.1">the user.</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.1192.1">And with this change, we are ready to upload</span><a id="_idIndexMarker762" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.1193.1"> the video from our ViewModel. </span><span class="kobospan" id="kobo.1193.2">By doing this, we have completed this chapter, as well as our work </span><span><span class="kobospan" id="kobo.1194.1">on Packtagram!</span></span></p>
<h1 id="_idParaDest-139" class="calibre5"><a id="_idTextAnchor140" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.1195.1">Summary</span></h1>
<p class="calibre3"><span class="kobospan" id="kobo.1196.1">Wrapping up this chapter, you’ve significantly leveled up your Packtagram app’s </span><span><span class="kobospan" id="kobo.1197.1">video capabilities.</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.1198.1">Starting with CameraX, we expanded its use from snapping photos to capturing high-quality videos, but this was just the beginning. </span><span class="kobospan" id="kobo.1198.2">Then, we dived into FFmpeg, an incredibly versatile tool for video editing. </span><span class="kobospan" id="kobo.1198.3">Here, you learned how to add a creative touch to videos, be it through captions that tell a story or filters that change the entire look </span><span><span class="kobospan" id="kobo.1199.1">and feel.</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.1200.1">But what’s a great video if it can’t be shared? </span><span class="kobospan" id="kobo.1200.2">We tackled that too by integrating Firebase Storage for seamless video uploads. </span><span class="kobospan" id="kobo.1200.3">This means your app is now adept at handling large files smoothly, ensuring users enjoy a </span><span><span class="kobospan" id="kobo.1201.1">hiccup-free experience.</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.1202.1">With this chapter, we have finished our work on Packtagram. </span><span class="kobospan" id="kobo.1202.2">Now, it’s time to learn about the project that will be implemented in the last three chapters: a video playback app so that you can view your favorite series </span><span><span class="kobospan" id="kobo.1203.1">and films!</span></span></p>
</div>
</body></html>