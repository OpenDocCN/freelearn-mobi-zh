<html><head></head><body><div class="chapter" title="Chapter&#xA0;3.&#xA0;Managing Assets and Scenes"><div class="titlepage"><div><div><h1 class="title"><a id="ch03"/>Chapter 3. Managing Assets and Scenes</h1></div></div></div><p>
<span class="emphasis"><em>In the previous chapter, we drew our first display objects on the screen, which in our case were quads. We made a cardboard puppet doll out of quads and learned how to use macros. There is one last thing we need to know before developing our pirate game. In this chapter, we will learn about managing our assets, such as images, sound, and other kinds of files. We will also learn how to group elements into scenes and display these scenes.</em></span>
</p><div class="section" title="Working with assets"><div class="titlepage"><div><div><h1 class="title"><a id="ch03lvl1sec37"/>Working with assets</h1></div></div></div><p>When<a id="id109" class="indexterm"/> we develop a game, we load files. We probably load a lot of images too. These images are displayed on the screen and are the graphics of any 2D game.</p><p>We will also need to load sound files for playing music and sound effects. Other general purpose files include text files that are either localization or game information files, such as hit points for enemies, attack strength, or similar data that affects the gameplay of the game.</p><p>Game-relevant data may include saved games and level data. This gameplay-relevant data may not always be plain text; in some cases, they are binary files or they use a markup language such as XML or JSON. In the iOS and Mac world, the PLIST file format is very common and contains a specialized kind of XML format.</p><div class="mediaobject"><img src="graphics/1509OS_03_01.jpg" alt="Working with assets"/></div><p>In some games, game engines and game frameworks go a step further when dealing with gameplay-relevant data in order to be more dynamic. They allow scripting through languages<a id="id110" class="indexterm"/> such as Lua and JavaScript. These scripts are loaded and executed at runtime.</p></div></div>
<div class="section" title="Managing our assets"><div class="titlepage"><div><div><h1 class="title"><a id="ch03lvl1sec38"/>Managing our assets</h1></div></div></div><p>Now that <a id="id111" class="indexterm"/>we know what assets are, how can we manage them for our game? Before we get to that, let's take a look at what we know so far and what the prerequisites to effectively load assets are.</p><p>Firstly, we know that there are different kinds of assets that can either be plain text files or binary.</p><p>One thing to keep in mind is the memory in mobile devices nowadays. While it is the same as the memory in desktop devices from a few years back, not all of this is reserved for our application. We should also keep in mind that the size of an asset on the disk may not be the same in memory as it is for compressed files, especially if the file content is compressed on the disk but has to be uncompressed in memory.</p><p>Consequently, there are a few things we can do, which are as follows:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">Limit the number of assets we are loading; this can prove difficult as a game can require a high amount of assets</li><li class="listitem" style="list-style-type: disc">Limit the number of assets that are currently loaded in memory</li><li class="listitem" style="list-style-type: disc">Cache assets that are already loaded so that we don't have the same content in memory two or more times</li></ul></div><p>Let's create a base class that manages a group of assets.</p></div>
<div class="section" title="Time for action &#x2013; creating a base class"><div class="titlepage"><div><div><h1 class="title"><a id="ch03lvl1sec39"/>Time for action – creating a base class</h1></div></div></div><p>To create <a id="id112" class="indexterm"/>a base class to manage our assets, we need to use the following steps:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Open the Xcode game template if it's not already open, right-click on the <span class="strong"><strong>Classes</strong></span> folder, select <span class="strong"><strong>New Group</strong></span>, and rename the group to <span class="strong"><strong>Assets</strong></span>.</li><li class="listitem">Right-click on the <span class="strong"><strong>Assets</strong></span> group and select <span class="strong"><strong>New File...</strong></span>.</li><li class="listitem">Select <span class="strong"><strong>Objective-C class</strong></span> and click on <span class="strong"><strong>Next</strong></span>.</li><li class="listitem">Enter <code class="literal">AssetsDictionary</code> in the name field, select <span class="strong"><strong>NSObject</strong></span> from the <span class="strong"><strong>Subclass of</strong></span> entry, and click on <span class="strong"><strong>Next</strong></span>.</li><li class="listitem">On the next dialog, click on <span class="strong"><strong>Create</strong></span>.</li><li class="listitem">Open the <code class="literal">AssetsDictionary.h</code> file.</li><li class="listitem">Add an instance variable called <code class="literal">_dict</code>, which is a pointer to <code class="literal">NSMutableDictionary</code>, as shown in the following code:<div class="informalexample"><pre class="programlisting">@interface AssetsDictionary : NSObject {
    NSMutableDictionary *_dict;
}</pre></div></li><li class="listitem">Add a property called <code class="literal">verbose</code>, which is of type <code class="literal">BOOL</code>, as shown in the following code:<div class="informalexample"><pre class="programlisting">@property BOOL verbose;</pre></div></li><li class="listitem">Add an instance method called <code class="literal">registerAsset</code>, as shown in the following code:<div class="informalexample"><pre class="programlisting">-(id) registerAsset:(NSString *)name withContent:(id)content;</pre></div></li><li class="listitem">Add another instance method called <code class="literal">unregisterAsset</code>, as shown in the following code:<div class="informalexample"><pre class="programlisting">-(void) unregisterAsset:(NSString *)name;</pre></div></li><li class="listitem">Add a third instance method called <code class="literal">clear</code>, as shown in the following code:<div class="informalexample"><pre class="programlisting">-(void) clear;</pre></div></li><li class="listitem">Now switch to <code class="literal">AssetsDictionary.m</code>.</li><li class="listitem">Add an initializer with the following content:<div class="informalexample"><pre class="programlisting">- (id)init
{
    if ((self = [super init])) {
        _dict = [[NSMutableDictionary alloc] init];
        _verbose = NO;
    }
    
    return self;
}</pre></div></li><li class="listitem">Implement the <code class="literal">registerAsset</code> method with the following piece of code:<div class="informalexample"><pre class="programlisting">-(id) registerAsset:(NSString *)name withContent:(id)content
{
  id result;

  if ([_dict objectForKey:name] == nil) {
    [_dict setObject:content forKey:name];
    
    result = content;
    
    if (self.verbose) {
      NSLog(@"Asset %@ does not exist. Registering.", name);
    }
  } else {
    result = [_dict objectForKey:name];
    
    if (self.verbose) {
      NSLog(@"Asset %@ already exists. Using cached value.", name);
    }
  }

  return result;
}</pre></div></li><li class="listitem">Implement<a id="id113" class="indexterm"/> the <code class="literal">unregisterAsset</code> method:<div class="informalexample"><pre class="programlisting">-(void) unregisterAsset:(NSString *)name
{
    if ([_dict objectForKey:name] != nil) {
        [_dict removeObjectForKey:name];
    }
}</pre></div></li><li class="listitem">Implement the <code class="literal">clear</code> method that should reset the cache:<div class="informalexample"><pre class="programlisting">-(void) clear
{
    [_dict removeAllObjects];
}</pre></div></li><li class="listitem">Switch to the <code class="literal">Game.m</code> file.</li><li class="listitem">Import the <code class="literal">AssetsDictionary.h</code> file in the <code class="literal">import</code> section:<div class="informalexample"><pre class="programlisting">#import "AssetsDictionary.h"</pre></div></li><li class="listitem">In the <code class="literal">init</code> method, add the following lines:<div class="informalexample"><pre class="programlisting">AssetsDictionary* assets = [[AssetsDictionary alloc] init];
assets.verbose = YES;
[assets registerAsset:@"myAsset" withContent:@"test"];
[assets registerAsset:@"myAsset" withContent:@"test"];</pre></div></li><li class="listitem">Run the<a id="id114" class="indexterm"/> example, and you will get the following output:<div class="mediaobject"><img src="graphics/1509OS_03_02.jpg" alt="Time for action – creating a base class"/></div></li></ol></div><div class="section" title="What just happened?"><div class="titlepage"><div><div><h2 class="title"><a id="ch03lvl2sec38"/>
<span class="emphasis"><em>What just happened?</em></span>
</h2></div></div></div><p>In step 1, we opened our Xcode template from where we left off in the previous chapter. Then, we created a new group where we put everything that relates to the management of our assets. Finally, we renamed the newly created group.</p><p>In step 2, we created a new file. In step 3, we selected <span class="strong"><strong>Objective-C class</strong></span> from the dialog that popped up. We wanted the class name to be <code class="literal">AssetsDictionary</code>, which is what we entered in step 4; we also confirmed the location where it is going to be saved on the hard drive in step 5.</p><p>Next, we opened the header file and an instance variable to store the name and content of an asset. For this, we needed it to be an instance of <code class="literal">NSMutableDictionary</code>. Objective-C Cocoa classes such as <code class="literal">NSDictionary</code> can be mutable or immutable; the contents of mutable classes can change, and the values of immutable classes are fixed to the values used when declaring the object.</p><p>Though we put the interface section in the header, it is also possible to put it right before the implementation section.</p><p>In step 8, we added a property called <code class="literal">verbose</code>, which is of type <code class="literal">BOOL</code>. If this property is set to <code class="literal">YES</code>, once an asset is registered, it should write a message telling us whether the asset is already in cache. It is sufficient to say that its default value should be <code class="literal">NO</code> so that our console message box is not cluttered with messages.</p><p>We needed to define our method that handles the registering and serving of our assets. It takes two parameters: the name of an asset and the content of an asset. It returns the content of the asset. Since the content of the asset can be anything—but is in most cases an instance of some sort—the type <code class="literal">id</code> seems like the best option here. The type <code class="literal">id</code> can stand for any class instance; if put to a technical term, it's called dynamic typing.</p><p>Then, we defined two methods; the first explains how to delete a single asset from the cache (step 10), and the second method explains how to clear all assets (step 11).</p><p>Our header file is done; now, let's get to the actual implementation. First off, switch to the <code class="literal">AssetsDictionary.m</code> file. In step 13, we added an initializer, which does the following two things for us:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">Set up the <code class="literal">_dict</code> dictionary.</li><li class="listitem" style="list-style-type: disc">Set the <code class="literal">verbose</code> property to <code class="literal">NO</code> by using its instance variable <code class="literal">_verbose</code>. This is generally not needed as <code class="literal">NO</code> is the default value for <code class="literal">BOOL</code>.</li></ul></div><p>In the next step, we implemented the <code class="literal">registerAsset</code> method. If the key—our first parameter—does not exist in the dictionary, we add it to the dictionary and return the content of the asset. If it exists, we look up the value from the dictionary and return it. In both cases, if the <code class="literal">verbose</code> property is set to <code class="literal">YES</code>, we will print a fitting message to reflect the current state of the asset.</p><p>In step 15, we defined a method that allows us to delete a single asset from the cache. In step 16 on the other hand, we defined a method to clear the complete cache.</p><p>Now<a id="id115" class="indexterm"/> that the <code class="literal">AssetsDictionary</code> class is ready for action, let's put it up for a test. In step 17, we switched to our <code class="literal">Game.m</code> file and subsequently imported the <code class="literal">AssetsDictionary</code> header in step 18.</p><p>Next, within the initializer of our <code class="literal">Game</code> class, we defined an instance of our <code class="literal">AssetsDictionary</code> class, set the <code class="literal">verbose</code> property to <code class="literal">YES</code>, and registered the same asset twice to see whether it will be cached correctly. In the last step, we ran the example and looked at the output in the console.</p></div><div class="section" title="Have a go hero"><div class="titlepage"><div><div><h2 class="title"><a id="ch03lvl2sec39"/>Have a go hero</h2></div></div></div><p>While this class works for our purposes, we could improve the <code class="literal">AssetsDictionary</code> class further. Here are some suggestions:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">When getting the cached value of an asset, we look for the value from the dictionary twice: the first time when checking whether the key is in the dictionary, and the second time when getting the actual value. This may result in a performance penalty when loading the assets into the game if there is a huge amount of assets.</li><li class="listitem" style="list-style-type: disc">Try to use <code class="literal">NSCache</code> instead of <code class="literal">NSMutableDictionary</code>.</li><li class="listitem" style="list-style-type: disc">If we want to display progress bars to see how far the loading process currently is, we will need a way to get the number of currently registered assets.</li><li class="listitem" style="list-style-type: disc">We can also have an <code class="literal">exists</code> method that checks whether an asset has already been registered and returns the result of this check.</li><li class="listitem" style="list-style-type: disc">We can add more initializers that take <code class="literal">NSDictionary</code>, for example.</li></ul></div></div></div>
<div class="section" title="Creating a texture manager"><div class="titlepage"><div><div><h1 class="title"><a id="ch03lvl1sec40"/>Creating a texture manager</h1></div></div></div><p>When we<a id="id116" class="indexterm"/> load an image in Sparrow, we typically want it to be a texture. A texture is pixel information that makes up an image. It's conceptually similar to how the <code class="literal">BitmapData</code> class works in ActionScript 3. If we want it to be displayed on the screen, it needs to be put on a geometrical representation, which is typically a quad.</p><p>The way we want our texture manager to work is to pass in a filename, which will be converted to a texture and is then available to us.</p><p>Let's use <code class="literal">AssetsDictionary</code> for our texture manager.</p></div>
<div class="section" title="Time for action &#x2013; managing our textures"><div class="titlepage"><div><div><h1 class="title"><a id="ch03lvl1sec41"/>Time for action – managing our textures</h1></div></div></div><p>To create our texture manager, take a look at the following steps:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Add a new Objective-C class called <code class="literal">TextureManager</code> derived from <code class="literal">AssetsDictionary</code> within the <span class="strong"><strong>Assets</strong></span> group.</li><li class="listitem">Add an instance method that will register a texture using its filename and return the correct value, which is the following:<div class="informalexample"><pre class="programlisting">-(SPTexture *) registerTexture:(NSString *)filename;</pre></div></li><li class="listitem">Switch to <code class="literal">TextureManager.m</code> and implement the method with the following content:<div class="informalexample"><pre class="programlisting">-(SPTexture *) registerTexture:(NSString *)filename
{
    if ([_dict objectForKey:filename] == nil) {
    return (SPTexture *) [self registerAsset:filename withContent:[SPTexture textureWithContentsOfFile:filename]];
  } else {
    return (SPTexture *) [self registerAsset:filename withContent:nil];
  }
}</pre></div></li><li class="listitem">Switch to the <code class="literal">Game.m</code> file, and replace the <code class="literal">AssetsDictionary.h</code> import with the <code class="literal">TextureManager.h</code> file in the <code class="literal">import</code> section.</li><li class="listitem">In the <code class="literal">init</code> method, replace the <code class="literal">AssetsDictionary</code> test we did earlier in the chapter with the following lines:<div class="informalexample"><pre class="programlisting">TextureManager* textureAssets = [[TextureManager alloc] init];
textureAssets.verbose = YES;
[textureAssets registerTexture:@"Default.png"];
[textureAssets registerTexture:@"Default.png"];</pre></div></li><li class="listitem">Run the example, and you will get the following output:<div class="mediaobject"><img src="graphics/1509OS_03_03.jpg" alt="Time for action – managing our textures"/></div></li></ol></div><div class="section" title="What just happened?"><div class="titlepage"><div><div><h2 class="title"><a id="ch03lvl2sec40"/>
<span class="emphasis"><em>What just happened?</em></span>
</h2></div></div></div><p>In the first step, we created a <code class="literal">TextureManager</code> class, which is a subclass of <code class="literal">AssetsDictionary</code>. In step 2, we defined the <code class="literal">registerTexture</code> instance method, which we implemented in the next step. A lot happened in this one line, explained as follows:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">We created an instance of <code class="literal">SPTexture</code> with the contents of the filename.</li><li class="listitem">We registered this instance to utilize <code class="literal">registerAsset</code> we implemented earlier.</li><li class="listitem">We returned the result of the called method.</li><li class="listitem">Since the result is of the type <code class="literal">id</code>, we cast it to <code class="literal">SPTexture</code>— the type we want.</li></ol></div><p>Now, we <a id="id117" class="indexterm"/>go ahead and switch to the <code class="literal">Game.m</code> file. We replace the line <code class="literal">#import "AssetsDictionary.h"</code> with <code class="literal">#import "TextureManager.h"</code>.</p><p>Then, we delete the example where we tested out the <code class="literal">registerAsset</code> method from <code class="literal">AssetsDictionary</code>. After this, we set up the same test; however, this time we use the <code class="literal">TextureManager</code> class and the <code class="literal">registerTexture</code> method. We load the <code class="literal">Default.png</code> file, which is in the <code class="literal">Resources</code> folder and is currently just a black image. The <code class="literal">Default.png</code> file is part of the original Sparrow barebone template.</p><p>When we run the example, it loads the image from file the first time, and then it uses the cached result.</p></div></div>
<div class="section" title="Creating a sound manager"><div class="titlepage"><div><div><h1 class="title"><a id="ch03lvl1sec42"/>Creating a sound manager</h1></div></div></div><p>Now that we have the texture manager, let's create the sound manager that is going to be very similar to the previous piece of code.</p></div>
<div class="section" title="Time for action &#x2013; implementing a sound manager"><div class="titlepage"><div><div><h1 class="title"><a id="ch03lvl1sec43"/>Time for action – implementing a sound manager</h1></div></div></div><p>To<a id="id118" class="indexterm"/> implement the sound manager, just follow these simple steps:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Add a new Objective-C class called <code class="literal">SoundManager</code> derived from <code class="literal">AssetsDictionary</code> within the <span class="strong"><strong>Assets</strong></span> group.</li><li class="listitem">Add an instance method that will register a sound using its filename and return the correct value, as shown in the following code:<div class="informalexample"><pre class="programlisting">-(SPSound *) registerSound:(NSString *)filename;</pre></div></li><li class="listitem">Implement the method from the previous step with the following content:<div class="informalexample"><pre class="programlisting">-(SPSound *) registerSound:(NSString *)filename
{
    if ([_dict objectForKey:filename] == nil) {
    return (SPSound *) [self registerAsset:filename withContent:[SPSound soundWithContentsOfFile:filename]];
  } else {
    return (SPSound *) [self registerAsset:filename withContent:nil];
  }
}</pre></div></li></ol></div><div class="section" title="What just happened?"><div class="titlepage"><div><div><h2 class="title"><a id="ch03lvl2sec41"/>
<span class="emphasis"><em>What just happened?</em></span>
</h2></div></div></div><p>In the<a id="id119" class="indexterm"/> first step, we created a <code class="literal">SoundManager</code> class, which is a subclass of <code class="literal">AssetsDictionary</code>. In step 2, we defined the <code class="literal">registerSound</code> method, which we implemented in the next step; this method loads a sound from file and returns the result of the registered asset.</p><p>It is very similar to <code class="literal">TextureManager</code>, but instead of a texture and <code class="literal">SPTexture</code>, we loaded a sound using <code class="literal">SPSound</code>.</p><p>For now, this is all we will do for sounds and sound management since we don't have any sound assets to load.</p></div></div>
<div class="section" title="Creating a file manager"><div class="titlepage"><div><div><h1 class="title"><a id="ch03lvl1sec44"/>Creating a file manager</h1></div></div></div><p>Now, we almost have a manager for all kinds of assets we want to use. The last thing we need is a manager for our data. We know that data assets can be pretty much anything, so we need to descope the use case for managing data assets. Let's take a look at what we'll need right now:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">Loading a plain text file is always a useful piece of functionality. It could contain game texts or a basic level layout.</li><li class="listitem" style="list-style-type: disc"><code class="literal">NSDictionary</code> and <code class="literal">NSMutableDictionary</code> are classes we already used and will be using to store data. How about we load a file and its content is converted to a structure similar to that of <code class="literal">NSDictionary</code>? The JSON format is very similar to a structure we find in <code class="literal">NSDictionary</code>, and luckily, since iOS 5, we have the means of converting a JSON file into <code class="literal">NSDictionary</code> without needing any third-party libraries.</li></ul></div></div>
<div class="section" title="Time for action &#x2013; managing remaining file types"><div class="titlepage"><div><div><h1 class="title"><a id="ch03lvl1sec45"/>Time for action – managing remaining file types</h1></div></div></div><p>To<a id="id120" class="indexterm"/> create an asset manager for <a id="id121" class="indexterm"/>our files, use the following steps:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Add a new Objective-C class called <code class="literal">FileManager</code>, which is derived from <code class="literal">AssetsDictionary</code> within the <span class="strong"><strong>Assets</strong></span> group.</li><li class="listitem">Define an instance method called <code class="literal">registerPlainText</code>, as shown in the following code:<div class="informalexample"><pre class="programlisting">-(NSString *) registerPlainText:(NSString *)filename;</pre></div></li><li class="listitem">Define another instance method called <code class="literal">registerDictionaryFromJSON</code>, as shown in the following code:<div class="informalexample"><pre class="programlisting">-(NSDictionary *) registerDictionaryFromJSON:(NSString *)filename;</pre></div></li><li class="listitem">Implement<a id="id122" class="indexterm"/> the <code class="literal">registerPlainText</code> method <a id="id123" class="indexterm"/>with the following content:<div class="informalexample"><pre class="programlisting">if ([_dict valueForKey:filename] == nil) {
  NSString *path = [[NSBundle mainBundle] pathForResource:filename];
  NSString *content = [NSString stringWithContentsOfFile:path encoding:NSUTF8StringEncoding error:nil];
  
  return (NSString *) [self registerAsset:filename withContent:content];
} else {
  return (NSString *) [self registerAsset:filename withContent:nil];
}</pre></div></li><li class="listitem">Implement the <code class="literal">registerDictionaryFromJSON</code> method with the following content:<div class="informalexample"><pre class="programlisting">if ([_dict valueForKey:filename] == nil) {
  NSString *path = [[NSBundle mainBundle] pathForResource:filename];
  
  NSData *data = [NSData dataWithContentsOfFile:path];
  NSDictionary *dict = [NSJSONSerialization JSONObjectWithData:data options:kNilOptions error:nil];
  
  return (NSDictionary *) [self registerAsset:filename withContent:dict];
} else {
  return (NSDictionary *) [self registerAsset:filename withContent:nil];
}</pre></div></li><li class="listitem">Add the <code class="literal">example.json</code> file to the <code class="literal">Resource</code> folder by right-clicking on the <code class="literal">Resources</code> folder and selecting <span class="strong"><strong>New File...</strong></span>. Select <span class="strong"><strong>Other</strong></span> from the tab and create an empty file. Fill it with the following content:<div class="informalexample"><pre class="programlisting">{
    "name": "example",
    "a": 5,
    "b": 6
}</pre></div></li><li class="listitem">Now, add <code class="literal">example.txt</code> to the <code class="literal">Resource</code> folder, which has the following content:<div class="informalexample"><pre class="programlisting">Hello from text file.</pre></div></li><li class="listitem">Now that all of our data and the <code class="literal">FileManager</code> class is set up, let's give it a spin. Switch to <code class="literal">Game.m</code>, remove the pieces of code that tested our previous asset managers, and import the <code class="literal">FileManager</code> header file.</li><li class="listitem">Add<a id="id124" class="indexterm"/> the following piece of code to the initializer<a id="id125" class="indexterm"/> method:<div class="informalexample"><pre class="programlisting">FileManager* fileAssets = [[FileManager alloc] init];
fileAssets.verbose = YES;
NSDictionary *data = [fileAssets registerDictionaryFromJSON:@"example.json"];

NSLog(@"Printing values from dictionary:");
NSLog(@"%@", data[@"name"]);
NSLog(@"%@", data[@"a"]);
NSLog(@"%@", data[@"b"]);

NSLog(@"Loading from text file and displaying as a string:");
NSLog(@"%@", [fileAssets registerPlainText:@"example.txt"]);
NSLog(@"%@", [fileAssets registerPlainText:@"example.txt"]);</pre></div></li><li class="listitem">Run the example, and see the following output:<div class="mediaobject"><img src="graphics/1509OS_03_04.jpg" alt="Time for action – managing remaining file types"/></div></li></ol></div><div class="section" title="What just happened?"><div class="titlepage"><div><div><h2 class="title"><a id="ch03lvl2sec42"/>
<span class="emphasis"><em>What just happened?</em></span>
</h2></div></div></div><p>In the first step, we created a <code class="literal">FileManager</code> class, which is a subclass of <code class="literal">AssetsDictionary</code>.</p><p>In the next two steps, we defined two instance methods: one for loading plain text files and another for loading JSON files.</p><p>In step 4, we implemented the <code class="literal">registerPlainText</code> method. We could have put it all in a one liner, but that would make it a bit cramped and harder to read. So, if the asset was registered, we returned it using the <code class="literal">registerAsset</code> method. We don't need to<a id="id126" class="indexterm"/> pass in content this time as the content is already<a id="id127" class="indexterm"/> in the dictionary. If it is not registered, we need the path to the filename first. Like every resource we want to load from the <span class="strong"><strong>Resource</strong></span> folder, without the help of third-party libraries, we need to get the exact file location. The <code class="literal">[[NSBundle mainBundle] pathForResource]</code> method gives us the exact file location if we pass a filename. The main bundle represents the application bundle of the current app. In the next line, we loaded the file into an <code class="literal">NSString</code>, and the encoding is UTF-8. We then returned the result that had been passed through the <code class="literal">registerAsset</code> method.</p><p>In the next step, we implemented the <code class="literal">registerDictionaryFromJSON</code> method that works pretty much in the same way as the <code class="literal">registerPlainText</code> method. However, instead of loading the file into an <code class="literal">NSString</code>, we used an <code class="literal">NSData</code> object. We then converted the file contents through the <code class="literal">NSJSONSerialization</code> class, which offers the <code class="literal">JSONObjectWithData</code> method. We don't really need to pass in any kind of special options right now.</p><p>We added an <code class="literal">example.json</code> file, which has one key that is a string value and two keys that have number values. In a JSON structure, a key has to be written in double quotes and is a string. A value can either be an array, a string, a number, a Boolean, a null, or an object. If a value is an object, it can have keys and values by itself. So, it can map the structure of <code class="literal">NSDictionary</code> pretty well.</p><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="note03"/>Note</h3><p>For more<a id="id128" class="indexterm"/> information on the JSON format, take a look at <a class="ulink" href="http://json.org/">http://json.org/</a>.</p></div></div><p>In the next step, we added an <code class="literal">example.txt</code> file and added some content.</p><p>In step 8, we removed all pieces of code from the previous example and imported the <code class="literal">FileManager</code> header file. We set up the file manager like how we did in the previous example. We then called the <code class="literal">registerDictionaryFromJSON</code> method with <code class="literal">example.json</code> as its parameter. We already know that we can access values from an <code class="literal">NSDictionary</code> instance through the <code class="literal">objectForKey</code> method, but we can also use the square bracket notation, which is more terse and easier to read. Just keep in mind that the square bracket notation for keys requires an <code class="literal">NSString</code> instance. Values, on the other hand, can be any object or <code class="literal">@</code> literal such as <code class="literal">@YES</code>, <code class="literal">@1</code>, or <code class="literal">@"MyValue"</code>. Then, we loaded the <code class="literal">example.txt</code> file and displayed it using <code class="literal">NSLog</code>.</p><p>When we ran the example, we saw when and how the assets were being loaded and the results<a id="id129" class="indexterm"/> of the loaded assets.</p><p>Our <code class="literal">FileManager.h</code> file will look like the following:</p><div class="informalexample"><pre class="programlisting">#import "AssetsDictionary.h"

@interface FileManager : AssetsDictionary

-(NSString *) registerPlainText:(NSString *)filename;
-(NSDictionary *) registerDictionaryFromJSON:(NSString *)filename;

@end</pre></div><p>Our <code class="literal">FileManager.m</code> file<a id="id130" class="indexterm"/> will look like the following:</p><div class="informalexample"><pre class="programlisting">#import "FileManager.h"

@implementation FileManager

-(NSString *) registerPlainText:(NSString *)filename
{
    if ([_dict valueForKey:filename] == nil) {
        NSString *path = [[NSBundle mainBundle] pathForResource:filename];
        NSString *content = [NSString stringWithContentsOfFile:path encoding:NSUTF8StringEncoding error:nil];
        
        return (NSString *) [self registerAsset:filename withContent:content];
    } else {
        return (NSString *) [self registerAsset:filename withContent:nil];
    }
}

-(NSDictionary *) registerDictionaryFromJSON:(NSString *)filename
{
    if ([_dict valueForKey:filename] == nil) {
        NSString *path = [[NSBundle mainBundle] pathForResource:filename];
        
        NSData *data = [NSData dataWithContentsOfFile:path];
        NSDictionary *dict = [NSJSONSerialization JSONObjectWithData:data options:kNilOptions error:nil];
        return (NSDictionary *) [self registerAsset:filename withContent:dict];
    } else {
        return (NSDictionary *) [self registerAsset:filename withContent:nil];
    }
}

@end</pre></div></div><div class="section" title="Have a go hero"><div class="titlepage"><div><div><h2 class="title"><a id="ch03lvl2sec43"/>Have a go hero</h2></div></div></div><p>Our file manager works exactly like we want it to work. There is one little problem if we want to load the same asset as plain text and convert it to <code class="literal">NSDictionary</code> from a JSON file. Since we only use a single dictionary for all the file elements, if we load an asset with<a id="id131" class="indexterm"/> the <code class="literal">registerDictionaryFromJSON</code> method first <a id="id132" class="indexterm"/>and later load the same asset with the <code class="literal">registerPlainText</code> method, we will get <code class="literal">NSDictionary</code> converted into an <code class="literal">NSString</code> instead of the text file directly being loaded and added to the dictionary as an <code class="literal">NSString</code>.</p></div><div class="section" title="Basic error handling"><div class="titlepage"><div><div><h2 class="title"><a id="ch03lvl2sec44"/>Basic error handling</h2></div></div></div><p>For the file manager, we haven't set up any error handling. So, if a file does not exist, the application will probably crash and we will be left guessing why nothing is happening, without any clue how to proceed. For now, we will add some error handling to the <code class="literal">registerPlainText</code> method.</p></div></div>
<div class="section" title="Time for action &#x2013; getting started with basic error handling"><div class="titlepage"><div><div><h1 class="title"><a id="ch03lvl1sec46"/>Time for action – getting started with basic error handling</h1></div></div></div><p>To add <a id="id133" class="indexterm"/>some basic error handling, take a look at the following steps:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Open the <code class="literal">FileManager.m</code> file.</li><li class="listitem">Update the <code class="literal">registerPlainText</code> method to match the following piece of code:<div class="informalexample"><pre class="programlisting">-(NSString *) registerPlainText:(NSString *)filename
{
    if ([_dict valueForKey:filename] == nil) {
    <span class="strong"><strong>NSError *error;</strong></span>
  
        NSString *path = [[NSBundle mainBundle] pathForResource:filename];
        NSString *content = [NSString stringWithContentsOfFile:path encoding:NSUTF8StringEncoding error:<code class="literal">&amp;error</code>];
    
    <span class="strong"><strong>if (error != nil) {</strong></span>
<span class="strong"><strong>      NSLog(@"Error while loading plain text file: %@", error);</strong></span>
<span class="strong"><strong>    }</strong></span>
        
        return (NSString *) [self registerAsset:filename withContent:content];
    } else {
        return (NSString *) [self registerAsset:filename withContent:nil];
    }
}</pre></div></li></ol></div><div class="section" title="What just happened?"><div class="titlepage"><div><div><h2 class="title"><a id="ch03lvl2sec45"/>
<span class="emphasis"><em>What just happened?</em></span>
</h2></div></div></div><p>While try-catch blocks are available in Objective-C, it's generally not a good idea to use them as they<a id="id134" class="indexterm"/> are quite slow and they can become quite difficult to handle if they are too nested.</p><p>The first thing we need is an error object that is a pointer to <code class="literal">NSError</code>. When loading the text file, we apply the error handling. If there are any errors when loading the file, the error object is not nil anymore. If this is the case, we log the error.</p></div><div class="section" title="Have a go hero"><div class="titlepage"><div><div><h2 class="title"><a id="ch03lvl2sec46"/>Have a go hero</h2></div></div></div><p>This is the most basic error handling at the moment. Here are some suggestions on how to improve it:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">Catch the case if a JSON file cannot be loaded</li><li class="listitem" style="list-style-type: disc">Catch the case if an invalid JSON file is being processed</li><li class="listitem" style="list-style-type: disc">Add an <code class="literal">NSError</code> parameter to register the assets in the file manager</li></ul></div></div></div>
<div class="section" title="Putting it all together"><div class="titlepage"><div><div><h1 class="title"><a id="ch03lvl1sec47"/>Putting it all together</h1></div></div></div><p>We now have a couple of different asset managers. It's time to put it all together so that we don't have to instantiate the different managers when we want to use an asset.</p></div>
<div class="section" title="Time for action &#x2013; creating an asset container class"><div class="titlepage"><div><div><h1 class="title"><a id="ch03lvl1sec48"/>Time for action – creating an asset container class</h1></div></div></div><p>To put <a id="id135" class="indexterm"/>all of our asset managers into one single class, use the following steps:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Add a new Objective-C class called <code class="literal">Assets</code> derived from <code class="literal">NSObject</code> within the <span class="strong"><strong>Assets</strong></span> group.</li><li class="listitem">Define a static method for each kind of asset, as shown in the following code:<div class="informalexample"><pre class="programlisting">+(SPTexture *) texture:(NSString *)filename;
+(SPSound *) sound:(NSString *)filename;
+(NSString *) plainText:(NSString *)filename;
+(NSDictionary *) dictionaryFromJSON:(NSString *)filename;</pre></div></li><li class="listitem">In the <code class="literal">Asset.m</code> file, import all asset managers, as shown in the following code:<div class="informalexample"><pre class="programlisting">#import "TextureManager.h"
#import "SoundManager.h"
#import "FileManager.h"</pre></div></li><li class="listitem">For each manager, add a static variable with the appropriate type and set its values to <code class="literal">nil</code>:<div class="informalexample"><pre class="programlisting">static TextureManager *textureAssets = nil;
static SoundManager *soundAssets = nil;
static FileManager *fileAssets = nil;</pre></div></li><li class="listitem">We need<a id="id136" class="indexterm"/> to overwrite the internal static <code class="literal">initialize</code> method. Use the following piece of code:<div class="informalexample"><pre class="programlisting">+(void) initialize
{
    if (!textureAssets) {
        textureAssets = [[TextureManager alloc] init];
    }
    
    if (!soundAssets) {
        soundAssets = [[SoundManager alloc] init];
    }
    
    if (!fileAssets) {
        fileAssets = [[FileManager alloc] init];
    }
}</pre></div></li><li class="listitem">Implement each of the static methods by using the correct instance method from each of the asset managers, as shown in the following code:<div class="informalexample"><pre class="programlisting">+(SPTexture *) texture:(NSString *)filename
{
    return [textureAssets registerTexture:filename];
}

+(SPSound *) sound:(NSString *)filename
{
    return [soundAssets registerSound:filename];
}

+(NSString *) plainText:(NSString *)filename
{
    return [fileAssets registerPlainText:filename];
}

+(NSDictionary *) dictionaryFromJSON:(NSString *)filename
{
    return [fileAssets registerDictionaryFromJSON:filename];
}</pre></div></li><li class="listitem">Switch to the <code class="literal">Game.m</code> file and update the previous example to use the static <code class="literal">Assets</code> class:<div class="informalexample"><pre class="programlisting">NSDictionary *data = <span class="strong"><strong>[Assets dictionaryFromJSON:@"example.json"]</strong></span>;

NSLog(@"Printing values from dictionary:");
NSLog(@"%@", data[@"name"]);
NSLog(@"%@", data[@"a"]);
NSLog(@"%@", data[@"b"]);

NSLog(@"Loading from text file and displaying as a string:");
NSLog(@"%@", [Assets plainText:@"example.txt"]);
NSLog(@"%@", <span class="strong"><strong>[Assets plainText:@"example.txt"]</strong></span>);</pre></div></li><li class="listitem">Run the<a id="id137" class="indexterm"/> example. When we check the console, we should see something like what's shown in the following screenshot:<div class="mediaobject"><img src="graphics/1509OS_03_05.jpg" alt="Time for action – creating an asset container class"/></div></li></ol></div><div class="section" title="What just happened?"><div class="titlepage"><div><div><h2 class="title"><a id="ch03lvl2sec47"/>
<span class="emphasis"><em>What just happened?</em></span>
</h2></div></div></div><p>In the first step, we created an <code class="literal">Assets</code> class, which is a subclass of <code class="literal">NSObject</code>.</p><p>We defined a static method for each of the asset manager instance methods, such as <code class="literal">texture</code> for <code class="literal">registerTexture</code> and <code class="literal">sound</code> for <code class="literal">registerSound</code>. Then, we proceeded to the implementation part.</p><p>For each asset manager, we defined a static variable: <code class="literal">textureAssets</code> for our <code class="literal">TextureManager</code> class, <code class="literal">textureSounds</code> for our <code class="literal">SoundManager</code> class, and so on. We set these instances to <code class="literal">nil</code>.</p><p>We had overridden the internal <code class="literal">NSObject</code> initialize method, which is called once internally and does not need to be called by us.</p><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="note04"/>Note</h3><p>More information <a id="id138" class="indexterm"/>about how the initialize method of <code class="literal">NSObject</code> works can be found in the Apple documentation at <a class="ulink" href="https://developer.apple.com/library/mac/documentation/cocoa/reference/foundation/classes/NSObject_Class/Reference/Reference.html#//apple_ref/occ/clm/NSObject/initialize">https://developer.apple.com/library/mac/documentation/cocoa/reference/foundation/classes/NSObject_Class/Reference/Reference.html#//apple_ref/occ/clm/NSObject/initialize</a>.</p></div></div><p>In the <code class="literal">initialize</code> method, we allocated and initialized each of the instances if its value was <code class="literal">nil</code>.</p><p>When<a id="id139" class="indexterm"/> implementing each of the static methods in the next step, we needed to call the corresponding instance method, such as <code class="literal">[textureAssets registerTexture:filename]</code> for the texture method, and we should not forget that we had to return the value of the instance method.</p><p>To use the static <code class="literal">Assets</code> class in our game file, we needed to update the reference to the header file and use the <code class="literal">dictionaryFromJSON</code> and <code class="literal">plainText</code> methods from the static class.</p><p>When we ran the example, we saw an output similar to the previous example, where we loaded files through the <code class="literal">FileManager</code>, but in this case we didn't have any message about the assets' statuses as the <code class="literal">verbose</code> flag was not set to <code class="literal">YES</code>.</p><p>Our <code class="literal">Assets.h</code> file will look like the following:</p><div class="informalexample"><pre class="programlisting">#import &lt;Foundation/Foundation.h&gt;

@interface Assets : NSObject

+(SPTexture *) texture:(NSString *)filename;
+(SPSound *) sound:(NSString *)filename;
+(NSString *) plainText:(NSString *)filename;
+(NSDictionary *) dictionaryFromJSON:(NSString *)filename;

@end</pre></div><p>Our <code class="literal">Assets.m</code> file will look like the following:</p><div class="informalexample"><pre class="programlisting">#import "Assets.h"
#import "TextureManager.h"
#import "SoundManager.h"
#import "FileManager.h"

static TextureManager *textureAssets = nil;
static SoundManager *soundAssets = nil;
static FileManager *fileAssets = nil;

@implementation Assets

+(void) initialize
{
    if (!textureAssets) {
        textureAssets = [[TextureManager alloc] init];
    }
    
    if (!soundAssets) {
        soundAssets = [[SoundManager alloc] init];
    }
    
    if (!fileAssets) {
        fileAssets = [[FileManager alloc] init];
    }
}

+(SPTexture *) texture:(NSString *)filename
{
    return [textureAssets registerTexture:filename];
}

+(SPSound *) sound:(NSString *)filename
{
    return [soundAssets registerSound:filename];
}

+(NSString *) plainText:(NSString *)filename
{
    return [fileAssets registerPlainText:filename];
}

+(NSDictionary *) dictionaryFromJSON:(NSString *)filename
{
    return [fileAssets registerDictionaryFromJSON:filename];
}

@end</pre></div><p>Before we <a id="id140" class="indexterm"/>continue with scene management, let's take a look at how we can use the static <code class="literal">Assets</code> class when displaying an image.</p></div></div>
<div class="section" title="Time for action &#x2013; displaying an image"><div class="titlepage"><div><div><h1 class="title"><a id="ch03lvl1sec49"/>Time for action – displaying an image</h1></div></div></div><p>To display <a id="id141" class="indexterm"/>an image, we just need to follow these steps:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Inside the <code class="literal">Game</code> initializer method, add the following piece of code:<div class="informalexample"><pre class="programlisting">SPImage* image = [SPImage imageWithTexture:[Assets texture:@"Default.png"]]; </pre></div></li><li class="listitem">At the bottom of the initializer method, add the image to the display tree of the <code class="literal">Game</code> class.</li><li class="listitem">Run the example, and you will see the following:<div class="mediaobject"><img src="graphics/1509OS_03_06.jpg" alt="Time for action – displaying an image"/></div></li></ol></div><div class="section" title="What just happened?"><div class="titlepage"><div><div><h2 class="title"><a id="ch03lvl2sec48"/>
<span class="emphasis"><em>What just happened?</em></span>
</h2></div></div></div><p>As we <a id="id142" class="indexterm"/>already know, we need the <code class="literal">SPImage</code> class to display a texture. It can be compared to <code class="literal">SPQuad</code>, but instead of just displaying a color, it displays the texture on itself. We used the <code class="literal">Assets</code> class to get our <code class="literal">Default.png</code> image from the <code class="literal">Resources</code> folder.</p><p>In the next step, we added the image to the display tree of our game class using the <code class="literal">addChild</code> method. Running the example we should see that our cardboard puppet doll is not visible anymore because the black image we just loaded is displayed on top of the cardboard puppet doll.</p><p>Our <code class="literal">Game.m</code> file should have the following content:</p><div class="informalexample"><pre class="programlisting">#import "Game.h" 
#import "Assets.h"

@implementation Game

- (id)init
{
    if ((self = [super init]))
    {
        Sparrow.stage.color = 0xffffff;
        
        SPImage* image = [SPImage imageWithTexture:[Assets texture:@"Default.png"]];
        
    NSDictionary *data = [Assets dictionaryFromJSON:@"example.json"];

    NSLog(@"Printing values from dictionary:");
    NSLog(@"%@", data[@"name"]);
    NSLog(@"%@", data[@"a"]);
    NSLog(@"%@", data[@"b"]);

    NSLog(@"Loading from text file and displaying as a string:");
    NSLog(@"%@", [Assets plainText:@"example.txt"]);
    NSLog(@"%@", [Assets plainText:@"example.txt"]);
        
        // Our whole cardboard puppet doll code here
        
        [self addChild:image];
    }
    return self;
}

@end</pre></div></div><div class="section" title="Have a go hero"><div class="titlepage"><div><div><h2 class="title"><a id="ch03lvl2sec49"/>Have a go hero</h2></div></div></div><p>Now that<a id="id143" class="indexterm"/> our asset management system is done, let's discuss a few ways in which we can improve the setup, which are:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">Right now, if we pass text files into the texture manager, it may load, but it may lead to unexpected results once we try to display the texture on the screen. We can check for the file extension and only load the asset if it has the correct file extension.</li><li class="listitem" style="list-style-type: disc">If we go one step further, we can try to automatically detect which asset we want to load by its mime type or, if that's not enough, we can try to detect the file format through the magic byte.</li><li class="listitem" style="list-style-type: disc">We tested for the functionality of our asset manager, but if we want more thorough tests, we may want to resort to unit tests.</li></ul></div></div></div>
<div class="section" title="What are scenes?"><div class="titlepage"><div><div><h1 class="title"><a id="ch03lvl1sec50"/>What are scenes?</h1></div></div></div><p>In a typical game, we have a main menu, an options menu, possibly a credits screen, and of course the game itself. We can have all this in a single file, but that will become difficult to maintain after a while. So, it will be a good idea to group these elements into separate entities, which in our case are scenes.</p><p>In games that depend on having a lot of levels, such as point'n'click games, it's also a good idea to have scenes for each level.</p></div>
<div class="section" title="Time for action &#x2013; implementing a scene class"><div class="titlepage"><div><div><h1 class="title"><a id="ch03lvl1sec51"/>Time for action – implementing a scene class</h1></div></div></div><p>To create<a id="id144" class="indexterm"/> a scene class, use the following steps:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Create a new group called <span class="strong"><strong>Scene</strong></span>.</li><li class="listitem">Create a new Objective-C class called <code class="literal">Scene</code>, which is derived from the <code class="literal">SPSprite</code> class, and save it in the <span class="strong"><strong>Scene</strong></span> group.</li><li class="listitem">Add a property called <code class="literal">guiLayer</code>, which is a <code class="literal">SPSPrite</code> type, as shown in the following code:<div class="informalexample"><pre class="programlisting">@property SPSprite* guiLayer;</pre></div></li><li class="listitem">Add another property called <code class="literal">name</code>, which is an <code class="literal">NSString</code>, as shown in the following code:<div class="informalexample"><pre class="programlisting">@property NSString* name;</pre></div></li><li class="listitem">Add a third property called <code class="literal">director</code>, which is an <code class="literal">id</code>, as shown in the following code:<div class="informalexample"><pre class="programlisting">@property id director;</pre></div></li><li class="listitem">Add an initializer that initializes the properties of the class:<div class="informalexample"><pre class="programlisting">-(id) init
{
    if ((self = [super init])) {
        self.guiLayer = [[SPSprite alloc] init];
        self.director = nil;
        self.name = @"scene";
    }
    
    return self;
}</pre></div></li><li class="listitem">Add a second initializer that sets the name of the scene; this should be called <code class="literal">initWithName</code>:<div class="informalexample"><pre class="programlisting">-(id) initWithName:(NSString *) name
{
    self = [self init];
    self.name = name;
    
    return self;
}</pre></div></li></ol></div><div class="section" title="What just happened?"><div class="titlepage"><div><div><h2 class="title"><a id="ch03lvl2sec50"/>
<span class="emphasis"><em>What just happened?</em></span>
</h2></div></div></div><p>Right now, we don't have any scenes, so we can't run the example just yet.</p><p>Firstly, we<a id="id145" class="indexterm"/> set up the <code class="literal">Scene</code> class, which needs to be a subclass of <code class="literal">SPSprite</code> because it needs to be added somewhere and we want to allow all kinds of display objects to be added to the <code class="literal">scene</code> instance.</p><p>We defined three properties; <code class="literal">guiLayer</code> should be the sprite where all our user interface-relevant display objects will be added, <code class="literal">name</code> should be the name of the scene itself, and <code class="literal">director</code> should be the reference to its parent object. In the <code class="literal">init</code> method, we set default values for these properties. We also added a second initializer, which takes a parameter that sets the name of the scene.</p></div></div>
<div class="section" title="Creating a scene director"><div class="titlepage"><div><div><h1 class="title"><a id="ch03lvl1sec52"/>Creating a scene director</h1></div></div></div><p>Now<a id="id146" class="indexterm"/> that we have a basic <code class="literal">scene</code> class, we need something that can actually manage all the scenes we want to add.</p></div>
<div class="section" title="Time for action &#x2013; managing our scenes with a scene director"><div class="titlepage"><div><div><h1 class="title"><a id="ch03lvl1sec53"/>Time for action – managing our scenes with a scene director</h1></div></div></div><p>To create the scene director, take a look at the following steps:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Create a new Objective-C class called <code class="literal">SceneDirector</code>, which is derived from the <code class="literal">SPSprite</code> class, and save it in the <span class="strong"><strong>Scene</strong></span> group.</li><li class="listitem">Add an instance variable called <code class="literal">_dict</code>, which is an <code class="literal">NSMutableDictionary</code> type.</li><li class="listitem">Add an instance method that will add a scene to the scene director, as shown in the following code:<div class="informalexample"><pre class="programlisting">-(void) addScene:(Scene *)scene;</pre></div></li><li class="listitem">Add a second instance method that will add a scene, but this time you are also able to define/overwrite the name of the scene:<div class="informalexample"><pre class="programlisting">-(void) addScene:(Scene *)scene withName:(NSString *)name;</pre></div></li><li class="listitem">Add an instance method that will show a scene and take <code class="literal">NSString</code> as its parameter, as shown in the following code:<div class="informalexample"><pre class="programlisting">-(void) showScene:(NSString *)name;</pre></div></li><li class="listitem">Let's switch to the implementation. The initializer should initialize the <code class="literal">_dict</code> variable.</li><li class="listitem">Implement the <code class="literal">addScene:(Scene *)scene withName:(NSString *)name</code> method with the following piece of code:<div class="informalexample"><pre class="programlisting">-(void) addScene:(Scene *)scene withName:(NSString *)name
{
  scene.name = name;
  _dict[name] = scene;

  scene.director = self;
  [self addChild:scene];
}</pre></div></li><li class="listitem">The <code class="literal">addScene:(Scene *)scene</code> method should be implemented as shown in the following<a id="id147" class="indexterm"/> code:<div class="informalexample"><pre class="programlisting">-(void) addScene:(Scene *)scene
{
    [self addScene:scene withName:scene.name];
}</pre></div></li><li class="listitem">The <code class="literal">showScene</code> method should have the following content:<div class="informalexample"><pre class="programlisting">-(void) showScene:(NSString *)name
{
  for (NSString* sceneName in _dict) {
    ((Scene *) _dict[sceneName]).visible = NO;
  }

  if (_dict[name] != nil) {
    ((Scene *) _dict[name]).visible = YES;
  }
}</pre></div></li></ol></div><div class="section" title="What just happened?"><div class="titlepage"><div><div><h2 class="title"><a id="ch03lvl2sec51"/>
<span class="emphasis"><em>What just happened?</em></span>
</h2></div></div></div><p>In the first step, we created the class needed for the scene director. This needs to be a <code class="literal">SPSprite</code> because we want an instance of it to be added to the <code class="literal">Game</code> class, and the scenes that the scene director should mange can be added very easily to the scene director.</p><p>We defined two instance methods that add a scene: the first method takes the scene, and the second method takes the scene and a name.</p><p>We also needed an instance that actually shows the scene; it takes a name as its parameter.</p><p>In the next step, we implemented the initializer of the scene director. We needed to initialize our <code class="literal">NSMutableDictionary</code>. We can do this using the typical <code class="literal">alloc</code>-and-<code class="literal">init</code> combination or, alternatively, with the more terse <code class="literal">@{}</code> notation.</p><p>We implemented the longer <code class="literal">addScene</code> method first; we set the scene name to the <code class="literal">name</code> parameter. This overwrites the scene name, even if one has already been given. We then added the scene to the dictionary, using the square bracket notation which does the same work as <code class="literal">[_dict setObject:scene forKey:name]</code>. In the next line, we set the reference of the <code class="literal">director</code> property within a scene to the current scene director instance. This is needed; in <a id="id148" class="indexterm"/>any other case, we wouldn't have an option to switch from one scene to another within a scene. We also add the scene to the display tree of the current <code class="literal">SceneDirector</code> instance.</p><p>When implementing the shorter <code class="literal">addScene</code>, we can just call the longer <code class="literal">addScene</code> method and pass it in the name from the current scene as its second parameter.</p><p>The last step is all about showing the scene that has been specified as the parameter. First, we iterated through all elements in the dictionary, and set its visibility to <code class="literal">NO</code> so it won't show up on the screen; yes, even the scene we want to show. Then, we specifically looked for our scene in the dictionary and set its visibility to <code class="literal">YES</code>.</p></div><div class="section" title="Have a go hero"><div class="titlepage"><div><div><h2 class="title"><a id="ch03lvl2sec52"/>Have a go hero</h2></div></div></div><p>Currently, we are loading all our scenes at once. This works for now, but as soon as we have a lot of scenes, we may be short on memory. To counteract this behavior, we can just have one scene in the memory at the same time. We may need to have a reference from our asset to our scene so that we know which asset belongs to which scene.</p></div><div class="section" title="Pop quiz"><div class="titlepage"><div><div><h2 class="title"><a id="ch03lvl2sec53"/>Pop quiz </h2></div></div></div><p>Q1. Can a binary data file be considered as an asset?</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Yes</li><li class="listitem">No</li></ol></div><p>Q2. Why should we primarily cache our assets in order to reuse already loaded assets?</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">To reduce CPU cycles</li><li class="listitem">To save memory</li><li class="listitem">To save disk space</li></ol></div><p>Q3. Can a texture (as in <code class="literal">SPTexture</code>) be drawn to the screen directly?</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Yes</li><li class="listitem">No</li></ol></div></div></div>
<div class="section" title="Summary"><div class="titlepage"><div><div><h1 class="title"><a id="ch03lvl1sec54"/>Summary</h1></div></div></div><p>We learned a lot about asset and scene management in this chapter.</p><p>Specifically, we covered how to handle different kinds of assets, cache already loaded files, and implement scenes and mechanisms to manage these scenes.</p><p>We also touched on some topics such as textures and displaying an image on the screen.</p><p>Now that we know how to handle assets and scenes, we're ready to add the basics of our game—which is the topic of the next chapter.</p></div></body></html>