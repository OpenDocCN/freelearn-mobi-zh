<html><head></head><body><div class="chapter" title="Chapter&#xA0;7.&#xA0;Maps, Locations, and Google Services"><div class="titlepage"><div><div><h1 class="title"><a id="ch07"/>Chapter 7. Maps, Locations, and Google Services</h1></div></div></div><p>The Standard SDK APIs that we have used until now provide a powerful set of tools for developing all manner of apps. However, Google also provides a number of mobile services such as Gmail, Translate, and Maps. These, and a dozens of others, are available to us as developers, and Google provides APIs for us to interact with them and incorporate them into our own apps.</p><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="tip19"/>Tip</h3><p>A complete<a id="id291" class="indexterm"/> and up-to-date list of all Google Services APIs can be found at: <a class="ulink" href="https://developers.google.com/apis-explorer/#p/">https://developers.google.com/apis-explorer/#p/</a>.</p></div></div><p>Because apps connecting to Google Services use Google's data and servers, there is a simple authentication process required which is known as an API Key. In this chapter, we will see how to do this as we build a simple map-based app that displays a location of our choice. After this is done, we will use a <code class="literal">LocationListener</code> to track our app as the user moves around.</p><p>In this chapter, you will:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">Obtain an API Key to access Google Maps for Android</li><li class="listitem" style="list-style-type: disc">Understand permissions and how to apply them</li><li class="listitem" style="list-style-type: disc">Access <code class="literal">LocationServices</code> with a <code class="literal">GoogleApiClient</code></li><li class="listitem" style="list-style-type: disc">Acquire a device's last known location</li><li class="listitem" style="list-style-type: disc">Use a <code class="literal">LocationListener</code> to update the location</li><li class="listitem" style="list-style-type: disc">Optimize location update intervals</li><li class="listitem" style="list-style-type: disc">Add Google Maps UI features</li><li class="listitem" style="list-style-type: disc">Set mock locations</li><li class="listitem" style="list-style-type: disc">Acquire a location with a <code class="literal">MapClickListener</code></li></ul></div><div class="section" title="Building a location-aware app with Google Maps"><div class="titlepage"><div><div><h1 class="title"><a id="ch07lvl1sec34"/>Building a location-aware app with Google Maps</h1></div></div></div><p>To get a <a id="id292" class="indexterm"/>very basic Google Map into one of our <a id="id293" class="indexterm"/>apps requires two distinct steps. First, we need to register our app with Google and acquire an API Key to uniquely identify our app; once we have a map up-and-running, we can locate our position using GPS and then zoom in to that, or any other, location. We begin with the first of these steps.</p><div class="section" title="Acquiring an API Key"><div class="titlepage"><div><div><h2 class="title"><a id="ch07lvl2sec35"/>Acquiring an API Key</h2></div></div></div><p>There is<a id="id294" class="indexterm"/> nothing to stop us getting on with this right away, although you will need to first check that, when we were installing all the components of the SDK way back in <a class="link" href="ch01.html" title="Chapter 1. Setting Up the Development Environment">Chapter 1</a>, <span class="emphasis"><em>Setting Up the Development Environment</em></span>, we included the following packages:</p><div class="mediaobject"><img src="graphics/B04321_07_01.jpg" alt="Acquiring an API Key"/></div><p>The only other thing to note before we begin is that, if you intend to test this app using an emulator, then you will need to construct a new one, where the system image target is <span class="strong"><strong>Google APIs (Google Inc.)</strong></span> – <span class="strong"><strong>google_apis [Google APIs]</strong></span>, rather than <span class="strong"><strong>Android 5.x</strong></span>. Third-party virtual devices may require their own configuration to run Play Services. With this done, we are more than ready to create our location-based app:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Start a new Android Studio project.</li><li class="listitem">Select <span class="strong"><strong>Google Maps Activity</strong></span>, where previously we have selected <span class="strong"><strong>Blank Activity</strong></span>, on the appropriate screen.</li><li class="listitem">Leave everything else as suggested by the wizard.</li><li class="listitem">The editor should open with the <code class="literal">google_maps_api.xml</code> file; if not, open it from the <code class="literal">res/values</code> directory.</li><li class="listitem">Examine<a id="id295" class="indexterm"/> the code. Google will have provided a link beginning with <code class="literal">https://console.developers.google.com/flows/</code> and ending in your package name, for example <code class="literal">com.example.kyle.distancefinder</code>.</li><li class="listitem">Follow this link and you will be taken to the Google Developers Console.<div class="mediaobject"><img src="graphics/B04321_07_02.jpg" alt="Acquiring an API Key"/></div></li><li class="listitem">Sign up, if needed.</li><li class="listitem">You will be prompted to create a new project. Call this whatever you choose, as you will be able to use this again for other apps.</li><li class="listitem">From the <span class="strong"><strong>Project Dashboard</strong></span> sidebar under <span class="strong"><strong>APIs &amp; auth</strong></span>, select <span class="strong"><strong>APIs</strong></span>.</li><li class="listitem">Enable the <span class="strong"><strong>Google Maps Android API v2</strong></span> API.</li><li class="listitem">Again, from the <span class="strong"><strong>Dashboard</strong></span> under <span class="strong"><strong>APIs &amp; auth</strong></span>, select credentials and click on the <span class="strong"><strong>Create New Key</strong></span> button.</li><li class="listitem">On the resultant screen, copy the API Key and paste it into the <code class="literal">google_maps_api.xml</code> file, where it says <code class="literal">YOUR KEY HERE</code>, making sure there are no extra spaces at either end.</li><li class="listitem">Now test the app on a handset or Google APIs emulator. The result will resemble the following screenshot:<div class="mediaobject"><img src="graphics/B04321_07_03.jpg" alt="Acquiring an API Key"/></div></li></ol></div><p>Incorporating a basic map into our app is pleasantly simple. However, by using the Maps Activity <a id="id296" class="indexterm"/>wizard, a lot of essential work has been done for us. And it is vital to understand that before being able to include maps anywhere in our app that we choose.</p><p>Take a look at the <code class="literal">build.gradle</code> file and note how the dependencies have been modified for us:</p><div class="informalexample"><pre class="programlisting">dependencies {
  compile fileTree(dir: 'libs', include: ['*.jar'])
  compile 'com.google.android.gms:play-services:6.5.87'
  compile 'com.android.support:appcompat-v7:22.0.0'
}</pre></div><p>When including maps in other projects, we will always need the <code class="literal">gms:play-services</code> libraries built in here. The <code class="literal">support:appcompat</code> library may be less obvious. It is used to make apps backward-compatible. It is not strictly necessary here and we will return to it when we cover how to reach the maximum number of users in the final chapter.</p><p>Now open the project's <code class="literal">Manifest</code> file. You will notice several differences from those of previous projects, the first being the following lines:</p><div class="informalexample"><pre class="programlisting">&lt;uses-permission android:name="android.permission.INTERNET" /&gt;
&lt;uses-permission android:name="android.permission.ACCESS_NETWORK_STATE" /&gt;
&lt;uses-permission android:name="android.permission.WRITE_EXTERNAL_STORAGE" /&gt;
&lt;uses-permission android:name="com.google.android.providers.gsf.permission.READ_GSERVICES" /&gt;
&lt;uses-permission android:name="android.permission.ACCESS_COARSE_LOCATION" /&gt;
&lt;uses-permission android:name="android.permission.ACCESS_FINE_LOCATION" /&gt;</pre></div><p>Anyone <a id="id297" class="indexterm"/>who has downloaded an Android app will be familiar with the way the user has to grant permissions to use various device functions, such as Internet access before installation. These tags, in the manifest, are how this is done, and you will need to apply them any time you include a feature that requires user permission. Thankfully, they all have very self-explanatory references and a full list can be found at <a class="ulink" href="http://developer.android.com/reference/android/Manifest.permission.html">developer.android.com/reference/android/Manifest.permission.html</a>.</p><p>The other elements in the manifest that will be needed in future projects are the two meta-data children of the application element shown below. The first automatically keeps our app running the latest version of play services and the second is where the API Key we acquired earlier is applied:</p><div class="informalexample"><pre class="programlisting">&lt;meta-data
  android:name="com.google.android.gms.version"
  android:value="@integer/google_play_services_version" /&gt;
&lt;meta-data
  android:name="com.google.android.maps.v2.API_KEY"
  android:value="@string/google_maps_key" /&gt;</pre></div><p>Overall, setting up API keys is very straightforward. We only need to register once and individual projects can be reused for apps requiring similar functions; speaking of functions, it is about time we added some functionality to our app. The most widely used, and arguably most useful Google Map APIs are the Location Services, which, among other things, allow the user to locate their device's geographical location using GPS, WiFi, and network signal strength.</p></div><div class="section" title="Acquiring the last known location"><div class="titlepage"><div><div><h2 class="title"><a id="ch07lvl2sec36"/>Acquiring the last known location</h2></div></div></div><p>The first<a id="id298" class="indexterm"/> step in incorporating location-aware technology into our apps is to identify the user's last known location. This, like much location-based work, is done with the help of a GoogleApiClient, and an interface that is a main entry point for these services.</p><p>Before adding the Java code to do this, we will edit the layout itself, so that we can see what is going on. Follow the next few steps to acquire our device's last known location:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Open the <span class="strong"><strong>Distance Finder</strong></span> project.</li><li class="listitem">Open the <code class="literal">activity_maps.xml</code> layout file.</li><li class="listitem">Edit the content so:<div class="informalexample"><pre class="programlisting">&lt;?xml version="1.0" encoding="utf-8"?&gt;
&lt;LinearLayout 
  
  android:layout_width="match_parent"
  android:layout_height="match_parent"
  android:orientation="vertical"&gt;

  &lt;TextView
    android:id="@+id/text_view"
    android:layout_width="wrap_content"
    android:layout_height="wrap_content"
    android:layout_gravity="center_horizontal"
    android:text="No last location" /&gt;

  &lt;fragment
    android:id="@+id/map"
    class="com.google.android.gms.maps.SupportMapFragment"
    android:layout_width="match_parent"
    android:layout_height="match_parent"
    tools:context=".MapsActivity" /&gt;

&lt;/LinearLayout&gt;</pre></div></li><li class="listitem">Open the <code class="literal">MapsActivity.java</code> file.</li><li class="listitem">Along with the <code class="literal">GoogleMap</code> that has been declared for us, include the following fields:<div class="informalexample"><pre class="programlisting">private static final String DEBUG_TAG = "tag";
private TextView textView;
private GoogleApiClient googleApiClient;</pre></div></li><li class="listitem">Add the <a id="id299" class="indexterm"/>following code to the <code class="literal">onCreate()</code> method:<div class="informalexample"><pre class="programlisting">textView = (TextView) findViewById(R.id.text_view);

googleApiClient = new GoogleApiClient.Builder(this)
  .addApi(LocationServices.API)
  .addConnectionCallbacks(this)
  .addOnConnectionFailedListener(this)
  .build();</pre></div></li><li class="listitem">Now, change the class declaration itself, so that it implements the following interfaces:<div class="informalexample"><pre class="programlisting">public class MapsActivity extends FragmentActivity implements GoogleApiClient.ConnectionCallbacks, GoogleApiClient.OnConnectionFailedListener {</pre></div></li><li class="listitem">This will generate an error. Use the quick fix to implement the following methods:<div class="mediaobject"><img src="graphics/B04321_07_04.jpg" alt="Acquiring the last known location"/></div></li><li class="listitem">Complete the <code class="literal">onConnected()</code> callback like so, to display our location:<div class="informalexample"><pre class="programlisting">@Override
public void onConnected(Bundle bundle) {
  Location loc = LocationServices.FusedLocationApi.getLastLocation(googleApiClient);
  Log.d(DEBUG_TAG, "Connected");
  if (loc != null) {
    textView.setText(loc.toString());
  }
}</pre></div></li><li class="listitem">To<a id="id300" class="indexterm"/> report connection status to the LogCat, edit the other two new methods like this:<div class="informalexample"><pre class="programlisting">@Override
public void onConnectionSuspended(int i) {
  Log.d(DEBUG_TAG, "Connection suspended");
}

@Override
public void onConnectionFailed(ConnectionResult connectionResult) {
  Log.d(DEBUG_TAG, "Connection  failed");
}</pre></div></li><li class="listitem">Edit the <code class="literal">onResume()</code> method like this:<div class="informalexample"><pre class="programlisting">@Override
protected void onResume() {
  super.onResume();
  setUpMapIfNeeded();
  googleApiClient.connect();
  Log.d(DEBUG_TAG, "onResume() called - connected");
}</pre></div></li><li class="listitem">Add a new <code class="literal">onPause()</code> method and complete it like so:<div class="informalexample"><pre class="programlisting">@Override
protected void onPause() {
  super.onPause();
  if (googleApiClient.isConnected()) {
    googleApiClient.disconnect();
    Log.d(DEBUG_TAG, "Disconnected");
  }
}</pre></div></li><li class="listitem">Finally, rewrite the <code class="literal">setUpMap()</code> like this:<div class="informalexample"><pre class="programlisting">private void setUpMap() {
  mMap.addMarker(new MarkerOptions()
    .position(new LatLng(51.178844, -1.826189))
    .title("Stonehenge"));
}</pre></div></li><li class="listitem">Run<a id="id301" class="indexterm"/> the project on a handset or AVD. Unless you are running the app on an emulator that you have just created, your location will appear in the text view with the following format:<p>
<span class="strong"><strong>Location[fused 51.507350,-0.127757 acc=4 et=+5m16s558ms alt=19.809023 vel=0.0].</strong></span>
</p></li></ol></div><p>At the beginning of this exercise, we changed the layout a little to include a <code class="literal">TextView</code>. However, we still set the fragment's class as a <code class="literal">SupportMapFragment</code>, and hopefully a little more clearly. The <code class="literal">SupportMapFragment</code> is the obvious choice for any map container we might want in an app. It's simple and handles most map processes almost automatically. With this container, almost everything else we need can be accomplished with a <code class="literal">GoogleApiClient</code>. As can be seen from the code, it allows us to put in place listeners and callbacks to manage the map and connectivity activity. Once the API client has connected us, finding our device's last known location requires nothing more than a call to the single function, <code class="literal">getLastLocation()</code>.</p><p>It is vitally important to ensure that we disconnect from any services we are using, whenever our user may no longer need them. Failure to do this results in apps that use up the device's power and data unnecessarily. By using the <code class="literal">onPause()</code> callback to disconnect the client whenever our Activity loses focus and then <code class="literal">onResume()</code> to re-connect it, we can ensure that our map stays connected when the Activity is visible and also that we won't be wasting our user's battery and data when it is not.</p><p>The <code class="literal">getLastLocation()</code> method is very useful; it doesn't require a network connection, or GPS, and it's instantly available. However, there are many situations where we need to update our app's location as the user moves around. This is done with <code class="literal">LocationListen3er</code> callbacks and the <code class="literal">LocationRequest</code> object, which is laid out in the following section.</p></div><div class="section" title="Requesting location updates"><div class="titlepage"><div><div><h2 class="title"><a id="ch07lvl2sec37"/>Requesting location updates</h2></div></div></div><p>The <code class="literal">LocationRequest</code> object is highly configurable and allows us to control the frequency<a id="id302" class="indexterm"/> of requests and the accuracy of the information received. This means we can design apps that do not use more resources than required, while still allowing us highly accurate and frequent location data when the purpose of the app demands it.</p><p>In the next stage, we will implement a <code class="literal">LocationListener</code> to track our app's location. We will also add one or two features to demonstrate some of the functions the maps APIs provide us with. There are only a few lines of code to this section, and here they are:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Include a <code class="literal">LocationListener</code> in our <code class="literal">FragmentActivity</code> class declaration, like so:<div class="informalexample"><pre class="programlisting">public class MapsActivity extends FragmentActivity implements
  GoogleApiClient.ConnectionCallbacks,
  GoogleApiClient.OnConnectionFailedListener,
  <span class="strong"><strong>LocationListener</strong></span> {</pre></div></li><li class="listitem">This will generate an error. Use the quick fix to import the Google version of the <code class="literal">LocationListener</code>, like so:<div class="mediaobject"><img src="graphics/B04321_07_05.jpg" alt="Requesting location updates"/></div></li><li class="listitem">Create the following class field:<div class="informalexample"><pre class="programlisting">private LocationRequest locationRequest;</pre></div></li><li class="listitem">In the <code class="literal">onCreate()</code> method, create the following <code class="literal">LocationRequest</code>:<div class="informalexample"><pre class="programlisting">locationRequest = LocationRequest.create()
  .setPriority(LocationRequest.PRIORITY_HIGH_ACCURACY)
  .setInterval(30000)
  .setFastestInterval(5000);</pre></div></li><li class="listitem">Next complete the <code class="literal">onLocationChanged()</code> method like this:<div class="informalexample"><pre class="programlisting">@Override
public void onLocationChanged(Location location) {
  LocationServices.FusedLocationApi.requestLocationUpdates(googleApiClient, locationRequest, this);
  textView.setText(location.toString());
}</pre></div></li><li class="listitem">Now <a id="id303" class="indexterm"/>expand the <code class="literal">setUpMap()</code> method like so:<div class="informalexample"><pre class="programlisting">private void setUpMap() {
  mMap.addMarker(new MarkerOptions()
    .position(new LatLng(51.178844, -1.826189))
    .title("Stonehenge")
    .snippet("3000 BC")
    .icon(BitmapDescriptorFactory.fromResource(R.mipmap.ic_launcher)));

  mMap.setMapType(GoogleMap.MAP_TYPE_SATELLITE);

  mMap.setMyLocationEnabled(true);
  mMap.getUiSettings().setMyLocationButtonEnabled(true);
  mMap.getUiSettings().setZoomControlsEnabled(true);
  mMap.getUiSettings().setZoomGesturesEnabled(true);
  mMap.getUiSettings().setCompassEnabled(true);
  mMap.getUiSettings().setRotateGesturesEnabled(true);
}</pre></div></li><li class="listitem">Run the project on your handset or emulator and either go for a short walk or set a mock-location using the Android Device Monitor:<div class="mediaobject"><img src="graphics/B04321_07_06.jpg" alt="Requesting location updates"/></div></li></ol></div><p>As with <a id="id304" class="indexterm"/>other aspects of coding for maps, the additions we made here are nicely straightforward. Although there is an Android version of the <code class="literal">LocationListener</code>, the Google one is easier to use, more powerful, and strongly recommended by Google themselves. We used the built-in icon here, but of course any image would have done. It is unlikely that we would use all the UI controls we set here and they are included more for demonstration purposes than practical use.</p><p>The way we set the intervals is of interest. The units are milliseconds and so here we have set the app to request a new location every 30 seconds. However, the use of <code class="literal">setFastestInterval()</code> allows us to take advantage of other apps that might be requesting a location and so we could have updates as frequently as 5 seconds.</p><p>We set the accuracy to as high as possible, with the <code class="literal">PRIORITY_HIGH_ACCURACY</code> constant. This obviously can be a drain on the user's power. Many apps require location to just within a few hundred feet and in such cases, one would use <code class="literal">PRIORITY_BALANCED_POWER_ACCURACY</code> or, if city level is sufficient, there is <code class="literal">PRIORITY_LOW_POWER</code>. There is also <code class="literal">PRIORITY_NO_POWER</code>, which will attempt to produce the best possible accuracy with no additional power consumption.</p><p>We also set the map to satellite type. We could also have used others, such as <code class="literal">MAP_TYPE_TERRAIN</code>, <code class="literal">MAP_TYPE_HYBRID</code>, or <code class="literal">MAP_TYPE_NORMAL</code>, depending on the purpose of our app.</p><p>Google <a id="id305" class="indexterm"/>provides a very simple way to zoom in on our location with the <code class="literal">MyLocationButton</code>. However, there may well be times when we want to zoom to another location, not zoom at all, or even zoom out. How simple this is to do is demonstrated in the next section, along with how to determine location from a click on the map.</p></div><div class="section" title="Moving around and animating a Google Map"><div class="titlepage"><div><div><h2 class="title"><a id="ch07lvl2sec38"/>Moving around and animating a Google Map</h2></div></div></div><p>The final <a id="id306" class="indexterm"/>section of this chapter requires very<a id="id307" class="indexterm"/> little in the way of coding. Google <a id="id308" class="indexterm"/>provides a specialized click listener for maps and a sort of callback method that we are very familiar with. Here, we will use this to zoom to any point on the map that is clicked.</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Open the <code class="literal">MapsActivity</code> file.</li><li class="listitem">In the declaration, implement this interface:<div class="informalexample"><pre class="programlisting">GoogleMap.OnMapClickListener</pre></div></li><li class="listitem">Next add the following line to the <code class="literal">setUpMap()</code> method:<div class="informalexample"><pre class="programlisting">mMap.setOnMapClickListener(this);</pre></div></li><li class="listitem">Create a method called <code class="literal">onMapClick()</code> and complete it like so:<div class="informalexample"><pre class="programlisting">public void onMapClick(LatLng latLng) {
  textView.setText("Clicked, position = " + latLng);
  CameraPosition position = new CameraPosition.Builder()
    .target(latLng)
    .zoom(6)
    .build();
  mMap.animateCamera(CameraUpdateFactory.newCameraPosition(position));
}</pre></div></li><li class="listitem">That's all there is to it. You can now run the app, which will zoom in on any point that is clicked.<div class="mediaobject"><img src="graphics/B04321_07_07.jpg" alt="Moving around and animating a Google Map"/></div></li></ol></div><p>The use of the <code class="literal">GoogleMap.OnMapClickListener</code> is more or less self-explanatory and provides<a id="id309" class="indexterm"/> us with the location in the form<a id="id310" class="indexterm"/> of a <code class="literal">LatLng</code> object without us having to do any <a id="id311" class="indexterm"/>extra work. The zoom level is all that needs an explanation, which too is simple. There are 12 levels with 12 being street level and 1 showing the entire planet. Being able to obtain locations in this manner opens up the way to all number of useful and interesting functions we can include in our apps.</p></div></div></div>
<div class="section" title="Summary"><div class="titlepage"><div><div><h1 class="title"><a id="ch07lvl1sec35"/>Summary</h1></div></div></div><p>With mobile devices becoming ever more present, being able to include maps in our apps is essential. The Google Maps API makes this task remarkably simple and probably the only complicated part was obtaining the API Key and setting up the permissions in the manifest file.</p><p>Developing with maps is further simplified by being able to set mock locations for real and emulated devices and also including UI components that users of Android devices have become used to.</p><p>In the next chapter, we will delve into what is probably one of the most exciting aspects of Android 5: the ability to develop for wearables, TVs, and cars.</p></div></body></html>