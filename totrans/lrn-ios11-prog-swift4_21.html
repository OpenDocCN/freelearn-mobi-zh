<html><head></head><body>
      
      <section>
         
         
         <header>
            
            <h1 class="header-title">Understanding Core Data</h1>
            
         </header>
         
         
         <article>
            
            
            <p>Our app is coming along nicely and we are close to wrapping it up. In the previous
               chapter, we created a restaurant review form, the Create Review form, which allows
               us to take pictures or use photos from our library. We can apply filters to photos
               and even add more filters quickly by updating our plist file.
            </p>
            
            <p>In this chapter, we finish up working on the Create Review form. We get the form fully
               working where we can save the data entered into the form to what is known as Core
               Data. Core Data is a framework that handles persistent data using what is known as
               <strong>Object-Relational Mapping</strong> (<strong>ORM</strong>). We go much deeper into what Core Data is and how to use it in this chapter.
            </p>
            
            <p>In this chapter we will cover the following topics:</p>
            
            <ul>
               
               <li>What is Core Data?</li>
               
               <li>What are <kbd>NSManagedObjectModel</kbd>, <kbd>NSManagedObjectContext</kbd>, and <kbd>NSPersistentStoreCoordinator</kbd>?
               </li>
               
               <li>Creating our first Core Data model</li>
               
            </ul>
            
            
            
         </article>
         
         
         
      </section>
      
   

      
      <section>
         
         
         <header>
            
            <h1 class="header-title">What is Core Data?</h1>
            
         </header>
         
         
         <article>
            
            
            <p>Let's start by taking a quote directly from Apple: <q>"Core Data is a framework for managing and persisting an object graph."</q> Apple does not call Core Data a database, even though, behind the scenes, it saves
               data to a SQLite file in iOS. Core Data is very hard to explain to someone new to
               programming or to someone who has come from a different programming language. However,
               in iOS 10, Core Data has been dramatically simplified. Having a general understanding
               of what Core Data does and how it works is sufficient for our purposes in this book.
            </p>
            
            <p>When using the Core Data framework, you should be familiar with the <strong>managed object model</strong>, the managed object context, and the <strong>persistent store coordinator</strong>. Let's look at a diagram to get a better understanding of how they interact with
               each other:
            </p>
            
            <div class="CDPAlignCenter CDPAlign"><img height="208" src="assets/9ef91087-0a08-4ef0-9745-929faa308bea.png" width="273"/></div>
            
            <ul>
               
               <li><kbd>NSManagedObjectModel</kbd>: The managed object model represents the data model of your Core Data application.
                  The managed object model interacts with all of the data models (also known as entities)
                  that you create within your app. This model is known for any relationships that your
                  data may have in your app. The managed object model interacts with your data model
                  as well as with the persistent store coordinator.<br/>
                  Entities are just objects that represent your data. In our app, since we are going
                  to be saving customer reviews for restaurants, we need to create a review entity.
               </li>
               
               <li><kbd>NSManagedObjectContext</kbd>: The managed object context manages a collection of model objects, which it receives
                  from the persistent store coordinator. The managed object context is responsible for
                  creating, reading, updating, and deleting models. The context is what you interact
                  with the most.
               </li>
               
               <li><kbd>NSPersistentStoreCoordinator</kbd>: The <span>persistent store coordinator</span> has a reference to the managed object model, as well as the managed object context.
                  The <span>persistent store coordinator</span> communicates with the persistent object store. The <span>persistent store coordinator</span> interacts with an object graph. This graph is where you create your entities and
                  set up relationships within your app.
               </li>
               
            </ul>
            
            <p>Core Data is not an easy topic, so you do not need to worry about the finer details.
               The more you work with Core Data, the easier it becomes to understand it. In this
               chapter, focus on obtaining a high-level understanding and the rest will come.
            </p>
            
            <p>Before iOS 10, you had to create an instance of each of the following: the managed
               object model, the managed object context, and the persistent store coordinator. Now,
               in iOS 10, these have been consolidated into what is called <kbd>NSPersistentContainer</kbd>. We cover this shortly but, first, we need to create our data model.
            </p>
            
            
            
         </article>
         
         
         
      </section>
      
   

      
      <section>
         
         
         <header>
            
            <h1 class="header-title">Creating a data model </h1>
            
         </header>
         
         
         <article>
            
            
            <p>The data model is where you create your app's model objects and their properties.
               For our project, we only need to create one model object, called <strong>Review</strong>. Let's create a managed object model now:
            </p>
            
            <ol>
               
               <li>In the Navigator panel, right-click on the <kbd>Misc</kbd> folder and create a new group, called <kbd>Core Data</kbd>.
               </li>
               
               <li>Next, right-click this new <kbd>Core Data</kbd> folder and click <span class="packt_screen">New File</span>.
               </li>
               
               <li>Inside the <span class="packt_screen">Choose a template for your new file screen</span>, select <span class="packt_screen">iOS</span> at the top and then scroll down to the <span class="packt_screen">Core Data</span> section and select <span class="packt_screen">Data Model</span>. Then, hit <span class="packt_screen">Next</span>:
               </li>
               
            </ol>
            
            <div class="CDPAlignCenter CDPAlign"><img height="333" src="assets/93008a3d-61ec-4403-bae7-be1cd247ae93.png" width="472"/></div>
            
            <ol start="4">
               
               <li>Name the file <kbd>LetsEatModel</kbd> and click <span class="packt_screen">Create</span>.
               </li>
               
               <li>Click <span class="packt_screen">Add Entity</span> in the screen that appears:
               </li>
               
            </ol>
            
            <div class="CDPAlignCenter CDPAlign"><img height="457" src="assets/a3e64f60-7bdd-4a77-8bd2-889a5f50a4ff.png" width="728"/></div>
            
            <p style="padding-left: 60px">Then, in the bottom-right corner <span>of the </span>new<span> screen</span>, change the <span class="packt_screen">Editor Style</span> to the <span class="packt_screen">Graph Style</span>:
            </p>
            
            <div class="CDPAlignCenter CDPAlign"><img height="459" src="assets/33f5329e-51e4-41cf-8090-f3e80d91b565.png" width="731"/></div>
            
            <p style="padding-left: 60px">In the <span class="packt_screen">Graph Style</span>, double-click on <span class="packt_screen">Entity</span> in the box in the middle of the graph to change our entity's name:
            </p>
            
            <div class="CDPAlignCenter CDPAlign"><img height="489" src="assets/375db4e2-0dd9-4254-b3f8-011d5be89f86.png" width="780"/></div>
            
            <ol start="6">
               
               <li>Update the text to say <span class="packt_screen">Review</span> and then hit <em>Enter</em>.
               </li>
               
               <li>Now that we have our first entity created, let's add our first attribute. <span>Select our</span> <span class="packt_screen">Review Entity</span> <span>and click the <span class="packt_screen">Add Attribute</span> button in the bottom-right corner of the screen. The word attribute is under</span> <span class="packt_screen">Attributes</span> <span><span>in the box in the middle of the screen:</span></span></li>
               
            </ol>
            
            <div class="CDPAlignCenter CDPAlign"><img height="530" src="assets/eff0e2c9-109d-48ad-a330-78e326ff5f14.png" width="846"/></div>
            
            <ol start="8">
               
               <li>You see that Xcode has given you an error. The reason for the error is that we created
                  an attribute without giving it a type yet. Let's do this now.
               </li>
               
               <li>Select the word attribute and open your Utilities panel. You only see three icons:
                  the File inspector, the Quick Help inspector, and the Data Model inspector.
               </li>
               
               <li>Select the last icon, the Data Model inspector, and, under <span class="packt_screen">Attribute</span>, click on the drop-down for <span class="packt_screen">Attribute Type</span> and change it from <span class="packt_screen">Undefined</span> to <span class="packt_screen">String</span>. The error should now disappear.
               </li>
               
               <li>Next, under <span class="packt_screen">Attribute</span> in the Data Model inspector, change the <span class="packt_screen">Name</span> from attribute to name and hit <em>Enter</em>.
               </li>
               
            </ol>
            
            <p style="padding-left: 60px">Your first attribute should now look as follows:</p>
            
            <div class="CDPAlignCenter CDPAlign"><img height="455" src="assets/101372a4-8d83-4a96-9d7a-1d0749428f29.png" width="726"/></div>
            
            <p>We have created our first attribute in the <span class="packt_screen">Graph Style</span> and now need to set up the rest of our attributes, which we do in the <span class="packt_screen">Table Style</span>:
            </p>
            
            <ol>
               
               <li>Switch the <span class="packt_screen">Editor Style</span> to the <span class="packt_screen">Table Style</span> and then click <span class="packt_screen">Add Attribute</span>:
               </li>
               
               <li>Update the attribute to date and set its data type to <span class="packt_screen">Date</span>. You do not have to do anything in the Data Model inspector for this attribute.
               </li>
               
               <li>Next, select the <span class="packt_screen">+</span> button in the <span class="packt_screen">Attributes</span> section of the <span class="packt_screen">Table Style</span> screen under the two attributes we just added.
               </li>
               
               <li>Update this third attribute to <kbd>customerReview</kbd> and set its data type to <span class="packt_screen">String</span>.
               </li>
               
               <li>Next, add a fourth attribute, named rating with a data type of <span class="packt_screen">Float</span>.
               </li>
               
               <li>Now, add a fifth attribute, named <kbd>restaurantID</kbd> with a data type of <span class="packt_screen">Integer 32</span>.
               </li>
               
            </ol>
            
            <p> </p>
            
            <ol start="7">
               
               <li>When we save reviews, we save them with their <kbd>restaurantID</kbd>. Whenever we go to a restaurant detail page, we get all of the reviews just for that
                  specific restaurant and then display them. If we do not have any reviews, then we
                  display a default message.
               </li>
               
               <li>Lastly, add a sixth attribute, named <kbd>uuid</kbd> with a data type of <span class="packt_screen">String</span> and, under <span class="packt_screen">Attribute</span> in the Data Model inspector, uncheck the <span class="packt_screen">Optional</span> checkbox. This attribute is our unique ID for each review.
               </li>
               
            </ol>
            
            <p>Your <span class="packt_screen">Attributes</span> table should now look like the following:
            </p>
            
            <div class="CDPAlignCenter CDPAlign"><img height="537" src="assets/07b1dea8-1c30-4b5e-bae0-38d978c86b62.png" width="855"/></div>
            
            <p class="mce-root">Now that we have our attributes set, we need to do a few more things before we start
               working on some code.
            </p>
            
            
            
         </article>
         
         
         
      </section>
      
   

      
      <section>
         
         
         <header>
            
            <h1 class="header-title">Entity auto-generation</h1>
            
         </header>
         
         
         <article>
            
            
            <p>We could have Xcode create a file for our <span class="packt_screen">Review Entity</span>; however, if we wanted to add more attributes, we would have to generate more code.
               Core Data offers the ability to auto-generate our code for us. To take advantage of
               this feature:
            </p>
            
            <ol>
               
               <li>In in the list of entities in the left panel, select our only <span class="packt_screen">Entity</span>, <span class="packt_screen">Review</span>.
               </li>
               
               <li>After you select the entity, select the Data Model inspector in the Utilities panel.
                  You should notice that your Data Model inspector panel has changed from when we were
                  working on our <span class="packt_screen">Attributes</span>.
               </li>
               
            </ol>
            
            <div class="CDPAlignCenter CDPAlign"><img height="440" src="assets/4830e621-3002-4827-97c4-89fcfadf341c.png" width="775"/></div>
            
            <ol start="3">
               
               <li>Now, hit cmd + <em>B</em> to build the project. This will create the <span class="packt_screen">Review</span> class that we created in <span class="packt_screen">Core Data</span>. You will not see the file anywhere, but it has been created.
               </li>
               
            </ol>
            
            <p>We now need to create another entity called <kbd>RestaurantPhoto</kbd>.
            </p>
            
            
            
         </article>
         
         
         
      </section>
      
   

      
      <section>
         
         
         <header>
            
            <h1 class="header-title">Restaurant Photo Entity</h1>
            
         </header>
         
         
         <article>
            
            
            <p>Using the same steps as in the previous section, create a photo entity with the following
               values:
            </p>
            
            <div class="CDPAlignCenter CDPAlign"><img height="486" src="assets/102c8634-26e1-4055-840a-523dbf019416.png" width="723"/></div>
            
            <p>Now, hit <em>cmd</em> + <em>B</em> to build the project; this creates the <kbd>Photo</kbd> class that we created in <span class="packt_screen">Core Data</span>.
            </p>
            
            <div>
               
               <p>We cannot just store images in Core Data, as they have to be converted to data first.
                  Therefore, we take the image used in the review and convert it to binary data for
                  Core Data to save. Then, when we pull the review out of the Core Data, we convert
                  it back to an image to display it.
               </p>
               
            </div>
            
            <p>For learning, we store images in Core Data. I would stay away from doing this as much
               as possible, because images can be large and you can quickly fill up the user's storage.
               If you are using a feed, you can save the URL path to the image instead of the actual
               image. If the user is not online, then you can just display a placeholder in its place.
            </p>
            
            
            
         </article>
         
         
         
      </section>
      
   

      
      <section>
         
         
         <header>
            
            <h1 class="header-title">Review item</h1>
            
         </header>
         
         
         <article>
            
            
            <p>We get this new <kbd>Review</kbd> class back from Core Data when we need to fetch items from it. Instead of passing
               the <kbd>Review</kbd> class around, we create a generic data object that we can use instead.
            </p>
            
            <p>When I work with stored data, I typically like to have two model objects: one used
               when storing data and the other generic. In the past, passing around Core Data objects
               caused a lot of technical issues. These issues were addressed in iOS 10; however,
               in an overabundance of caution, I typically get the items from Core Data and then
               convert those objects into a struct.
            </p>
            
            <p>Let's create this file now:</p>
            
            <ol>
               
               <li>Right-click the <kbd>Review Form</kbd> folder and select <span class="packt_screen">New File</span>.
               </li>
               
               <li>Inside <span class="packt_screen">Choose a template for your new file screen</span>, select <span class="packt_screen">iOS</span> at the top and then <span class="packt_screen">Swift File</span>. Then hit <span class="packt_screen">Next</span>.
               </li>
               
               <li>Name this file <kbd>ReviewItem</kbd> and hit <span class="packt_screen">Create</span>.
               </li>
               
               <li>Update your file to the following:</li>
               
            </ol>
            <pre style="padding-left: 60px">import UIKit<br/>struct ReviewItem {<br/>   var rating:Float?<br/>   var name:String?<br/>   var customerReview:String?<br/>   var date:NSDate?<br/>   var restaurantID:Int?<br/>   var uuid = UUID().uuidString<br/>   var displayDate:String {<br/>          let formatter = DateFormatter()<br/>          formatter.dateFormat = "MMMM dd, yyyy"<br/>          return formatter.string(from: self.date as! Date)<br/>   }<br/>}<br/><br/>extension ReviewItem {<br/>   init(data:Review) {<br/>         self.date = data.date<br/>         self.customerReview = data.customerReview<br/>         self.name = data.name<br/>         self.restaurantID = Int(data.restaurantID)<br/>         self.rating = data.rating<br/>         if let uuid = data.uuid { self.uuid = uuid }<br/>   }<br/>}</pre>
            <p>This file is not doing anything special, other than using a variable to handle dates.</p>
            
            <p>The extension in this file allows us to take the Review from Core Data and map it
               to a <kbd>ReviewItem</kbd>. Our custom <kbd>init()</kbd> method allows us just to pass the <kbd>Review</kbd> object into the <kbd>init</kbd> parameters.
            </p>
            
            <p>We need to create another item for our photos that we are saving. This file has the
               same basic structure as the <kbd>ReviewItem</kbd> does. Let's create this file now:
            </p>
            
            <ol>
               
               <li>Right-click <kbd>Controllers</kbd> to create a new group called <kbd>Photo Reviews</kbd>.
               </li>
               
               <li>Right-click the <kbd>Photo Filter</kbd> folder and select <span class="packt_screen">New File</span>.
               </li>
               
               <li>Inside the <span class="packt_screen">Choose a template for your new file screen</span>, select <span class="packt_screen">iOS</span> at the top and then <span class="packt_screen">Swift File</span>. Then hit <span class="packt_screen">Next</span>.
               </li>
               
               <li>Name this file <kbd>RestaurantPhotoItem</kbd> and hit <span class="packt_screen">Create</span>.
               </li>
               
               <li>Update your file to the following:</li>
               
            </ol>
            <pre style="padding-left: 60px">struct RestaurantPhotoItem {<br/>   var photo:UIImage?<br/>   var date:NSDate?<br/>   var restaurantID:Int?<br/>   var uuid = UUID().uuidString<br/>   var photoData:NSData {<br/>         guard let image = photo else {<br/>               return NSData()<br/>         }<br/>         return NSData(data: UIImagePNGRepresentation(image)!)<br/>   }<br/>}<br/>extension RestaurantPhotoItem {<br/>   init(data:RestaurantPhoto) {<br/>         self.date = data.date<br/>         self.restaurantID = Int(data.restaurantID)<br/>         self.photo = UIImage(data:photo as Data, scale:1.0)<br/>         if let uuid = data.uuid { self.uuid = uuid }<br/>   }<br/>}</pre>
            <p>The first part of this file is exactly what we did for the review item, except for
               the <kbd>photoData</kbd> variable. Since we cannot store an image directly into Core Data, we need to convert
               it into binary data. The <kbd>photoData</kbd> variable handles this for us and makes it easier when we save an item just to pass
               <kbd>photoData</kbd> to Core Data.
            </p>
            
            <p>Now that we have our <kbd>ReviewItem</kbd> and <kbd>RestaurantPhotoItem</kbd>, we need to set up our manager next.
            </p>
            
            
            
         </article>
         
         
         
      </section>
      
   

      
      <section>
         
         
         <header>
            
            <h1 class="header-title">Core Data manager </h1>
            
         </header>
         
         
         <article>
            
            
            <p>As we have done throughout the book, we are going to create a <kbd>Manager</kbd> class. This class will be responsible for getting data in and out of Core Data. Let's
               get started:
            </p>
            
            <ol>
               
               <li>Right-click the <kbd>Core Data</kbd> folder in the <kbd>Common</kbd> folder and select <span class="packt_screen">New File</span>.
               </li>
               
               <li>Inside the <span class="packt_screen">Choose a template for your new file screen</span>, select <span class="packt_screen">iOS</span> at the top and then <span class="packt_screen">Cocoa Touch Class</span>. Then hit <span class="packt_screen">Next</span>.
               </li>
               
               <li>In the options screen that appears, add the following:</li>
               
            </ol>
            
            <p style="padding-left: 60px">New file:</p>
            
            <ul>
               
               <li style="list-style-type: none">
                  
                  <ul>
                     
                     <li><span class="packt_screen">Class</span>: <kbd>CoreDataManager</kbd></li>
                     
                     <li><span class="packt_screen">Subclass</span>: <kbd>NSObject</kbd></li>
                     
                     <li><span class="packt_screen">Also create XIB</span>: Unchecked
                     </li>
                     
                     <li><span class="packt_screen">Language</span>: <kbd>Swift</kbd></li>
                     
                  </ul>
                  
               </li>
               
            </ul>
            
            <ol start="4">
               
               <li>Click <span class="packt_screen">Next</span> and then <span class="packt_screen">Create</span>.
               </li>
               
            </ol>
            
            <p>When the file opens, under your <kbd>import UIKit</kbd>, add the following:
            </p>
            <pre>import CoreData</pre>
            <p>This import allows us to have access to the Core Data library. Next, inside the class
               definition, add the following:
            </p>
            <pre>let container:NSPersistentContainer</pre>
            <p>This constant, which is an <kbd>NSPersistentContainer</kbd>, gives us everything we need within a Core Data stack. As we discussed earlier, the
               <kbd>NSPersistentContainer</kbd> is composed of three things; a persistent store coordinator, a managed object context,
               and a managed object model.
            </p>
            
            <p>You may have noticed an error after adding this variable. The reason for the error
               is that we do not have an <kbd>init()</kbd> method created.
            </p>
            
            <p>Let's add this <kbd>init()</kbd> method after the constant we just added:
            </p>
            <pre>override init() {<br/>   container = NSPersistentContainer(name: "LetsEatModel")<br/>   container.loadPersistentStores { (storeDesc, error) in<br/>         guard error == nil else {<br/>               print(error?.localizedDescription as Any)<br/>               return<br/>         }<br/>   }<br/>   super.init()<br/>}</pre>
            <p>This code is initializing the container and grabbing the managed object model we created
               earlier. The model is now able to see all of our entities and attributes therein.
            </p>
            
            <p>Our <kbd>CoreDataManager</kbd> needs to do two things for us. We need to be able to add new a <kbd>ReviewItem</kbd> and fetch it. When we save a restaurant review, we want to be able to save the review
               with the restaurant. We do not need to save all of the restaurant information, since
               we can simply use the <kbd>restaurantID</kbd>. When we go to restaurant details, we can check Core Data for any reviews for a particular
               restaurant by its <kbd>restaurantID</kbd>. Let's add the following method after our <kbd>init()</kbd> method to accomplish this task for us:
            </p>
            <pre>func fetchReviews(by identifier:Int) -&gt; [ReviewItem] {<br/>    let moc = container.viewContext<br/>    let request:NSFetchRequest&lt;Review&gt; = Review.fetchRequest()<br/>    let predicate = NSPredicate(format: "restaurantID = %i", Int32(identifier))<br/>    var items:[ReviewItem] = []<br/>    request.sortDescriptors = [<br/>      NSSortDescriptor(key: "date", ascending: false)]<br/>    request.predicate = predicate<br/>    do {<br/>        for data in try moc.fetch(request) {<br/>            items.append(ReviewItem(data: data))<br/>        }<br/>        return items<br/>    } catch {<br/>        fatalError("Failed to fetch reviews: \(error)")<br/>    }<br/>}</pre>
            <p>Let's review this code. Our <kbd>fetchReviews(by:)</kbd> method takes an ID and we use it to find reviews for a particular restaurant.
            </p>
            <pre>let moc = container.viewContext<br/>let request:NSFetchRequest&lt;Review&gt; = Review.fetchRequest()<br/>let predicate = NSPredicate(format: "restaurantID = %i", Int32(identifier))</pre>
            <p>In the first line, we are creating an instance of the <strong>managed object context</strong> (<strong>moc</strong>). This variable allows us to interact with Core Data. In the next line, we are creating
               a fetch request. This request is passed to the managed object context and tells it
               what we need. Finally, we are creating a predicate, which allows us to apply some
               search parameters. Specifically, we are saying that we want every <kbd>ReviewItem</kbd> that has the ID that we pass it.
            </p>
            <pre>request.sortDescriptors = [NSSortDescriptor(key: "date", ascending: false)]<br/>request.predicate = predicate</pre>
            <p>Here, we are applying a sort descriptor to our request. Instead of getting reviews
               back in a random order, we sort all of the reviews by date.
            </p>
            <pre>do {<br/>   for data in try moc.fetch(request) {<br/>         items.append(ReviewItem(data: data))<br/>   }<br/>   return items<br/>} catch {<br/>   fatalError("Failed to fetch reviews: \(error)")<br/>}</pre>
            <p>Finally, we are wrapping everything into a <kbd>do...catch</kbd> block. When the search occurs, it returns an array of <kbd>ReviewItems</kbd> or, if there were no <kbd>ReviewItems</kbd>, an empty array. If there was a problem with your setup, then you get a fatal error.
               When the fetch is complete, we then loop through the items and create our <kbd>ReviewItems</kbd>.
            </p>
            
            <p>Here, we are applying a sort descriptor to our request. Instead of getting reviews
               back in a random order, we sort all of the reviews by date.
            </p>
            
            <p>We have added our method to get reviews; we need to do the same for fetching photos.
               Add the following after the <kbd>fetchReviews(identifier:)</kbd> method:
            </p>
            <pre>func fetchPhotos(by identifier:Int) -&gt; [RestaurantPhotoItem] {<br/>    let moc = container.viewContext<br/>    let request:NSFetchRequest&lt;Review&gt; = RestaurantPhoto.fetchRequest()<br/>    let predicate = NSPredicate(format: "restaurantID = %i", Int32(identifier))<br/>    var items:[RestaurantPhotoItem] = []<br/>    request.sortDescriptors = [NSSortDescriptor(key: "date", ascending: false)]<br/>    request.predicate = predicate<br/>    do {<br/>        for data in try moc.fetch(request) {<br/>            items.append(ReviewItem(data: data))<br/>        }<br/>        return items<br/>    } catch {<br/>       fatalError("Failed to fetch photos: \(error)")<br/>    }<br/>}</pre>
            <p>Everything is the same as what we did to fetch review items, except we are fetching
               <kbd>RestaurantPhoto</kbd> items instead. Now we need to add a method to save our data into Core Data. Let's
               add the next two methods by adding the following after our <kbd>init()</kbd> method:
            </p>
            <pre>func addReview(_ item:ReviewItem) {<br/>   let review = Review(context: container.viewContext)<br/>   review.name = item.name<br/>   review.date = NSDate()<br/>   if let rating = item.rating { review.rating = rating }<br/>   review.customerReview = item.customerReview<br/>   review.uuid = item.uuid<br/><br/>   if let id = item.restaurantID {<br/>         review.restaurantID = Int32(id)<br/>         print("restaurant id \(id)")<br/>           save()<br/>   }<br/>}<br/><br/>func addPhoto(_ item:RestarauntPhotoItem) {<br/>   let photo = RestarauntPhoto(context: container.viewContext)<br/>   photo.date = NSDate()<br/>   photo.photo = item.photoData<br/>   photo.uuid = item.uuid<br/><br/>   if let id = item.restaurantID {<br/>         photo.restaurantID = Int32(id)<br/>         print("restaurant id \(id)")<br/>           save()<br/>   }<br/>}</pre>
            <p>You will get an error, because we have not created the <kbd>save()</kbd> method yet. Ignore it for now, as it will be created next.
            </p>
            
            <p>This <kbd>addReview()</kbd> method takes a <kbd>ReviewItem</kbd> in the parameters. We convert the <kbd>ReviewItem</kbd> into a <kbd>Review</kbd> and then call the <kbd>save()</kbd> method.
            </p>
            
            <p>Now, let's add the <kbd>save()</kbd> method after the <kbd>addReview()</kbd> method we just created:
            </p>
            <pre>fileprivate func save() {<br/>   do {<br/>         if container.viewContext.hasChanges {<br/>               try container.viewContext.save()<br/>         }<br/>   }<br/>   catch let error {<br/>         print(error.localizedDescription)<br/>   }<br/>}</pre>
            <p>Once again, we are wrapping everything into a <kbd>do...catch</kbd> block. Inside of the do, we check to see if the managed object context has changed.
               If it has changed, then we call the <kbd>save()</kbd> method. We have now completed our Core Data manager.
            </p>
            
            <p>Next, we need to create another manager class. This manager is responsible for making
               calls to the Core Data manager, similar to how the corresponding manager in the explore
               manager is responsible for getting the data from the plist; this gets us photos and
               reviews. Let's create this manager file now:
            </p>
            
            <ol>
               
               <li>Right-click the <kbd>Misc</kbd> folder and select <span class="packt_screen">New File</span>.
               </li>
               
               <li>Inside the <span class="packt_screen">Choose a template for your new file screen</span>, select <span class="packt_screen">iOS</span> at the top and then <span class="packt_screen">Cocoa Touch Class</span>. Then hit <span class="packt_screen">Next</span>.
               </li>
               
            </ol>
            
            <p> </p>
            
            <ol start="3">
               
               <li>In the options screen that appears, add the following:</li>
               
            </ol>
            
            <p style="padding-left: 60px">New file:</p>
            
            <ul>
               
               <li style="list-style-type: none">
                  
                  <ul>
                     
                     <li><span class="packt_screen">Class</span>: <kbd>ReviewDataManager</kbd></li>
                     
                     <li><span class="packt_screen">Subclass</span>: <kbd>NSObject</kbd></li>
                     
                     <li><span class="packt_screen">Also create XIB</span>: Unchecked
                     </li>
                     
                     <li><span class="packt_screen">Language</span>: <kbd>Swift</kbd></li>
                     
                  </ul>
                  
               </li>
               
            </ul>
            
            <ol start="4">
               
               <li>Hit <span class="packt_screen">Next</span> and then <span class="packt_screen">Create</span>. Update your file to the following:
               </li>
               
            </ol>
            <pre style="padding-left: 60px">import Foundation<br/>class ReviewDataManager: NSObject {<br/>    private var reviewItems:[ReviewItem] = []<br/>    private var photoItems:[RestaurantPhotoItem] = []<br/>    let manager = CoreDataManager()<br/>    func fetchReview(by restaurantID:Int) {<br/>       if reviewItems.count &gt; 0 { reviewItems.removeAll() }<br/>       for data in manager.fetchReviews(by: restaurantID) {<br/>            reviewItems.append(data)<br/>       }<br/>    }<br/><br/>    func fetchPhoto(by restaurantID:Int) {<br/>        if photoItems.count &gt; 0 { photoItems.removeAll() }<br/>        for data in manager.fetchPhotos(by: restaurantID) {<br/>            photoItems.append(data)<br/>        }<br/>    }<br/><br/>    func numberOfReviewItems() -&gt; Int {<br/>        return reviewItems.count<br/>    }<br/><br/>    func numberOfPhotoItems() -&gt; Int {<br/>        return photoItems.count<br/>    }<br/><br/>    func reviewItem(at index:IndexPath) -&gt; ReviewItem {<br/>        return reviewItems[index.item]<br/>    }<br/><br/></pre>
            <pre style="padding-left: 60px">    func photoItem(at index:IndexPath) -&gt; RestaurantPhotoItem {<br/>        return photoItems[index.item]<br/>    }<br/>}</pre>
            <p>This manager class is similar to the other managers that we have created so far. In
               this manager, our fetch method takes an ID in the parameter. This ID represents the
               <kbd>restaurantID</kbd> that we use to search for <kbd>ReviewItems</kbd> in Core Data. If we find any <kbd>ReviewItems</kbd>, we add them to our array.
            </p>
            
            
            
         </article>
         
         
         
      </section>
      
   

      
      <section>
         
         
         <header>
            
            <h1 class="header-title">Summary</h1>
            
         </header>
         
         
         <article>
            
            
            <p>In this chapter, you learned about what Core Data is and how to use it. We also looked
               at <kbd>NSManagedObjectModel</kbd>, <kbd>NSManagedObjectContext</kbd>, and <kbd>NSPersistentStoreCoordinator</kbd> and how they work together inside Core Data. Even if they all do not make sense,
               and they did not work for me the first time, it is all right because it eventually
               clicks. Finally, we created two Core Data models, one for reviews and one for photos.
            </p>
            
            <p>In the next chapter, we work on actually saving the data we create as well as getting
               it back out. We take our reviews and photos and display them inside our restaurant
               details.
            </p>
            
            
            
         </article>
         
         
         
      </section>
      
   </body></html>