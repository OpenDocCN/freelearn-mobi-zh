# 第六章：使我们的游戏更高效

我们已经讨论了很多调试技术，而且有很多。然而，并非所有这些技术都能提高效率。我们所说的效率是什么意思？你的应用可以运行得很好，但这并不意味着它会让设备运行得很好。过热、电池耗尽过快以及其他类似的事情可能会破坏游戏体验。

考虑到这一点，让我们了解一下本章将涵盖的内容：

+   优化我们的游戏

+   防止电池耗尽

+   防止卡顿（或至少最小化它）

这是你游戏开发中的一个关键步骤，因为你不希望人们因为太卡顿（或者因为设备在渲染当前场景时出现问题而导致应用卡顿）或者耗尽电池而抱怨并删除你的应用。

我知道你可能从未遇到过这样的问题，但这种情况比不常见的情况要多。

如果你下载了一个非常卡顿的游戏，在玩了一个小时后电池耗尽，会发生什么？毫无疑问，你会从手机上删除它或要求退款。

那么，让我们深入了解如何优化这些内容！

# 管理效果

到目前为止，我们一直在随意编写代码，没有考虑我们的效果在旧设备上的运行情况。

不要害怕！因为我们可以检测玩家正在使用的设备，并调整屏幕上同时出现的粒子效果和敌人数量。

首先，在我们的 `GameLevelScene.m` 文件中，我们将在顶部添加以下代码行：

[PRE0]

这个框架将允许我们访问检测我们正在工作的确切设备。

在 `@implementation` 行下面，添加以下函数：

[PRE1]

现在，如果你想查看哪个设备出现，你可以在初始化部分将 `deviceName()` 函数添加到 `NSLog` 函数中，它看起来像这样：

[PRE2]

因此，你的日志现在将显示你正在运行的设备，如下图所示：

![管理效果](img/B03553_06_01.jpg)

不确定 **x86_64** 是什么意思？在这种情况下，因为我正在运行模拟器，**x86_64** 将会在 64 位 iMac 上显示，或者如果你正在运行 32 位机器（对于较旧的 Mac），你将看到 **i386**。

下面是每个设备将显示的内容概述：

+   **i386** 在 32 位机器上

+   **x86_64** 在 64 位机器上

+   **iPod1,1** 在第一代 iPod Touch 上

+   **iPod2,1** 在第二代 iPod Touch 上

+   **iPod3,1** 在第三代 iPod Touch 上

+   **iPod4,1** 在第四代 iPod Touch 上

+   **iPhone1,1** 在 iPhone 上

+   **iPhone1,2** 在 iPhone 3G 上

+   **iPhone2,1** 在 iPhone 3GS 上

+   **iPad1,1** 在 iPad 上

+   **iPad2,1** 在 iPad 2

+   **iPad3,1** 在第三代 iPad 上

+   **iPhone3,1** 在 iPhone 4（GSM）

+   **iPhone3,3** 在 iPhone 4（CDMA/Verizon/Sprint）

+   **iPhone4,1** 在 iPhone 4s

+   **iPhone5,1** 在 iPhone 5（型号 A1428，AT&T/Canada）

+   **iPhone5,2** 在 iPhone 5（型号 A1429，其他所有设备）

+   **iPad3,4** 在第四代 iPad 上

+   **iPad2,5** 在 iPad Mini 上

+   **iPhone5,3** 在 iPhone 5c（型号 A1456, A1532 | GSM）

+   **iPhone5,4** 在iPhone 5c（型号A1507、A1516、A1526（中国）、A1529 | 全球）

+   **iPhone6,1** 在iPhone 5s（型号A1433、A1533 | GSM）

+   **iPhone6,2** 在iPhone 5s（型号A1457、A1518、A1528（中国）、A1530 | 全球）

+   **iPad4,1** 在第5代iPad（iPad Air）- Wifi

+   **iPad4,2** 在第5代iPad（iPad Air）- Cellular

+   **iPad4,4** 在第2代iPad Mini - Wifi

+   **iPad4,5** 在第2代iPad Mini - Cellular

+   **iPhone7,1** 在iPhone 6 Plus上

+   **iPhone7,2** 在iPhone 6

非常全面，不是吗？然而，当涉及到为所有设备开发时，它会很有帮助。

现在，我们可以开始设置根据我们运行的设备来改变我们的粒子发射的功能。例如，正如我们在之前的屏幕截图中所看到的，我们正在运行 **x86_64**，换句话说，就是一台Mac电脑。所以，为了测试这个功能（在通过模拟器运行我们的游戏时），在我们的 `GameLevelScene.m` 文件中，向下滚动到 `- (void)touchesBegan:(NSSet *)touches withEvent:(UIEvent *)event` 函数，并在我们创建雨发射器的 `[self addChild:rainEmitter];` 函数之前添加以下代码块：

[PRE3]

你现在可以调整出生率数字，看看什么看起来好，表现良好。如果你调整出生率并测试你的项目，你会看到粒子相应地调整，如下面的屏幕截图所示：

![管理效果](img/B03553_06_02.jpg)

例如，在先前的图像中，出生率设置为 `15,000`。虽然它看起来像是一场倾盆大雨，但帧率会大大下降。请注意，当我截图时，帧率会大幅下降，但你应该明白它平均大约是25fps，因为设备需要渲染的量非常大。

现在，如果我们将其降低到 `1500`，我们会看到相当不同的结果：

![管理效果](img/B03553_06_03.jpg)

它看起来不像之前那么猛烈，但我们看到帧率有显著提高。

不想增加雨量？让我们尝试以相同的方式调整屏幕上的火焰效果，就像我们通过添加以下代码减少雨量一样：

[PRE4]

这将原始的出生率从设置为 `200` 降低到 `100`。虽然100的差异可能看起来像是一个很大的数字，而且我们的粒子看起来不会那么好；但这足以减少延迟，并且不会影响火焰本身的视觉吸引力。

很好！截图时稳定的60 fps！看起来也很不错！

![管理效果](img/B03553_06_04.jpg)

现在，请记住，这是为我们的Mac上的iOS模拟器设置的，所以你甚至可以期待应用程序的运行会有一些不同，但它确实能给你一个很好的想法，了解它将如何表现。

希望我们已经决定在游戏中支持哪些设备，我们现在将添加测试支持设备的函数。对于这个例子，我将只支持iPhone 4S及以上，包括iPad第4代及以上。

测试这些设备要添加的代码如下：

[PRE5]

我知道写和测试这些内容确实很多。这些数字都是估算的，因为我并不拥有所有这些设备。然而，我确实在每个模拟器上测试了它们，并且它们似乎都能以稳定的帧率运行。

我们从一个 `if` 语句开始，检查我们正在运行哪个设备。如果我们没有检测到检查的设备，我们使用 `else if` 语句。这将导致代码检查下一行以查找设备。当它找到正在运行的设备时，它将相应地调整出生率。

当涉及到火焰效果或你在游戏中运行的任何其他效果时，你也可以这样做。

你也可以通过更改你的更新计时器函数来简单地限制生成的敌人数量，如下面的代码所示：

[PRE6]

简单地调整 `if (self.lastSpawnTimeInterval > 2)` 语句到一个更高的数字将减少一次生成的敌人数量，因为我们正在增加生成新敌人的时间。所以，间隔越高，生成敌人所需的时间就越长。

通过减少这些简单的事情，我们将极大地提高设备的性能，特别是那些变得疲惫且无法像以前那样运行的旧设备。

记住，更好的性能（设备运行不那么费力）等于更长的电池寿命、更长的播放时间和更满意的客户。

我们有其他很多方法可以优化事物；例如，正如我们在本书前面提到的，我们可以查看我们创建的精灵，如果它们是大型文件，我们可以尝试保存其他格式以节省空间，并使设备更容易渲染它们。

你来这里是为了掌握 iOS 开发，你想要学习一切！所以，让我来解释一切。

我们首先讨论的是如何防止，或者至少如何限制我们的应用在后台运行的数量。

## 电池管理 – 在后台做更少的事情

当用户没有积极使用你的游戏/应用时，设备会将其置于后台状态。如果应用没有执行重要任务，例如完成用户发起的任务（例如发送照片或更新新闻源）或在特别声明的后台执行模式下运行，设备最终可能会挂起应用。

为了进一步节省电池寿命，你的应用不应该等待被设备挂起。一旦应用通知状态已更改，它应该立即开始暂停活动（参考以下图像）。

当你的应用完成任何排队的任务时，它应该通知设备后台活动已完成。未能这样做会导致应用保持活跃并浪费不必要的能量，这可以从以下图像中完美总结出来：。

![电池管理 – 在后台做更少的事情](img/B03553_06_05.jpg)

为什么电池的续航时间不长？这困扰着我们所有人...好吧，是的，随着每一款新iPhone的发布，它们正在改善电池使用效率，但它们在操作系统中添加了更多消耗电池的功能，所以你实际上并没有真正得到任何好处。

《iOS应用能效指南》中的“*后台应用能耗的常见原因*”部分指出：

> *执行不必要的后台活动（如音乐、Facebook或新闻应用在后台持续运行）会消耗能量。以下是在后台刷新应用中浪费能量的常见原因：*

+   在后台活动完成后不通知系统

+   播放静音音频

+   执行位置更新

+   与蓝牙配件交互

这些都是无论你是在创建游戏还是应用时，都应该在开发时记住的事情：

+   **在后台活动完成后通知系统**：对于应用，如果你正在从网站获取信息，你需要暂停它直到应用恢复，或者设置一个刷新间隔。

+   **播放静音音频**：对于我们的游戏，当应用进入后台时，声音和音乐需要暂停。

+   **执行位置更新**：你是否注意到了状态栏上那个讨厌的箭头图标？那等于电池消耗。当应用进入后台时，关闭位置服务。

+   **与蓝牙配件交互**：这适用于应用和游戏，特别是对于像蓝牙扬声器甚至蓝牙键盘或游戏手柄这样密集型的设备。确保当应用进入后台时，蓝牙断开连接并进入休眠模式。别忘了当应用重新进入前台时恢复！

首先，你可以在需要时扫描外围设备，例如蓝牙控制器或其他设备。为此，请使用以下代码块：

[PRE7]

这很简单，对吧？我知道，这需要吸收很多东西。但请相信我，这些都是非常重要的事情。

然后，当你完成蓝牙设备的操作后，只需使用以下两个方法来断开连接：

[PRE8]

当你的应用变得不活跃或移动到后台时，你如何挂起活动？通过在你的应用代理中实现`UIApplicationDelegate`方法（如果尚未实现，因为我们的应用已经在`AppDelegate.m`文件中实现了这个方法），可以让设备在应用变得不活跃或从前台过渡到后台时接收通知并挂起活动。

当应用进入非活动状态时，会调用`applicationWillResignActive`方法，例如当电话推销员打电话来清理你的通风管道，收到短信，或者玩家切换到另一个应用，你的应用开始过渡到后台状态。

这是你想要暂停任何活动、保存数据并为任何挂起做好准备的地方：

[PRE9]

现在有一个重要的事情需要记住，那就是当应用进入后台时，你不想仅仅依赖于保存数据。你总是希望在游戏过程中在适当的时机保存数据，比如在关卡结束时。如果你严格依赖于在状态变化时保存数据，比如关卡变化，或者玩家暂停或退出游戏，游戏可能无法可靠地保存，玩家可能会丢失一些信息。例如，假设你正在玩你最喜欢的游戏，但游戏只有在完成3个关卡后才会保存，你可能会丢失重要的高分或收集到的物品。此外，玩家也不希望不得不重玩那些已经完成的关卡。

另一个状态，`applicationDidEnterBackground:`在应用进入后台时立即被调用。使用这个方法，你可以立即停止操作、动画和更新方法，以下代码所示：

[PRE10]

这个方法只调用几秒钟，所以如果应用需要更多时间来完成调用的请求，你将不得不使用`beginBackgroundTaskWithExpirationHandler:`方法请求更多的执行时间，这个方法在需要额外时间时被调用。

当后台任务完成后，你需要调用`endBackgroundTask:`方法来让设备知道任务已完成。如果你不调用该方法，iOS会允许应用有更多的时间来完成任何额外的功能。如果在iOS提供的额外时间内，任何保存或卸载方法没有完成，应用将被挂起。

进一步来说，如果你的应用在进入后台时仍然在处理任何方法，并且应用被挂起，所有重要的性能调整、保存游戏可能都不会发生，这可能会破坏用户的体验。

现在我们已经讨论了当应用进入后台时应该做什么，现在是时候讨论当应用恢复时应该做什么（或如何做）了。

我们有两种方法可以让我们调用可能已经断开连接的任何重新连接方法，例如蓝牙设备、位置服务等等：

[PRE11]

这个方法在应用从后台过渡到活动状态之前立即被调用。开始恢复操作、加载数据、重新初始化用户界面，并让应用为用户做好准备：

[PRE12]

`ApplicationDidBecomeActive`函数在应用被设备启动或从后台或非活动状态过渡到活动状态后立即被调用。本质上，我们正在全面恢复任何被中断的操作。

这些功能是在开发计时器、蓝牙连接等时需要记住的几个重要事项。

另一个需要注意的事情是避免使用极端的图形和动画。正如你在我们的游戏中看到的，我们没有使用任何密集的动画。相反，我们的大多数角色每个动画有两到四张图像。

如果你使用的是仅包含标准窗口和控制的程序，比如笔记应用，你实际上不需要担心内容更新，因为系统 API 是以最大效率为前提创建的。

如果你使用的是自定义窗口和控制，比如**Shazam**，你真的必须确保你绘制所有内容的代码是高效的。

例如，你不想总是刷新屏幕上的所有内容，特别是隐藏的项目，或者过度使用动画。我知道它们看起来很好，但它们确实会浪费电池电量。

请记住，每次应用将图像和文本绘制到屏幕上时，都需要 CPU 使用、GPU 使用，并且屏幕需要保持活跃。因此，你显示和刷新的内容越多，电池耗尽得越快，这就是为什么某些应用会耗尽电池寿命的原因。

因此，你应该注意过度更新或甚至低效的内容绘制，因为这会从电池中消耗大量电量。

这里还有一些需要注意的事情。你应该始终减少应用中视图的数量（所有这些都会从电池中消耗电量）。

如果可能的话，你应该减少屏幕上使用的特效数量，例如不透明度、透明度等。如果需要使用特效，应避免在频繁刷新的项目上使用，因为这会再次消耗电池电量，因为不透明度对象和下面的内容都需要更新。

关于动画，每个动画最多使用 60fps，任何更快的速度在渲染时都会带来麻烦，因为它需要更多的 CPU/GPU 来提升帧率。此外，尽量保持所有动画速度在相同的帧率，这样引擎就不会在 60fps 渲染角色和在 30fps 渲染敌人时感到吃力，例如。虽然动画中的额外帧看起来很棒，但这些额外的帧效率低下，需要额外的计算，这会导致更多的电池耗电。

在开发游戏时，甚至建议只使用 SpriteKit、SceneKit 和 Metal，因为这些框架是为了提供最佳性能和效率而设计的。

这并不意味着你不能使用框架，例如 Cocos2d。实际上，Cocos2D 是建立在 SpriteKit 框架之上的，并且同样易于使用且功能强大。

在测试你的应用时，请密切关注我们在上一章中讨论的调试工具。

注意这些迹象：

+   电池耗尽

+   当你期望应用处于空闲状态时的活动

+   响应慢或用户界面不灵敏

+   主线程上的大量工作

+   动画使用量高

+   视图不透明度使用量高

+   交换

+   内存停滞和缓存未命中

+   内存警告

+   锁竞争

+   过度上下文切换

+   定时器使用过度

+   过度绘制到屏幕

+   过度或重复的小磁盘 I/O

+   高开销的通信，例如带有小数据包和缓冲区的网络活动

+   防止设备休眠

在上一章中，我们没有查看使用Xcode中的Instruments测量能量使用情况。

Instruments为我们提供了设备使用的图形时间线。您将能够收集有关应用CPU使用、网络使用、磁盘使用和图形使用的相关信息。

通过查看这个时间线，您将能够分析您应用的性能，并找出可能导致延迟、减速或帧率下降的某些应用中的点，这样您就可以在这些确切的时刻进行调整。

要访问这些能量诊断，启动Instruments，将其连接到您的应用，然后点击**能量诊断**模板。

**能量诊断**模板监控影响iOS设备能量使用的因素，如前所述，包括CPU和网络活动、屏幕亮度等等。然后，您可以看到使用率最高的区域，并检查您是否可以减少这些区域的影响。例如，您可能会发现将某些蓝牙任务推迟到更节能的时间的机会，比如设备插上电源或连接到Wi-Fi时。

这都是可选的；当您开始使用调试Instruments时，您将看到哪些方法适合您，以及何时使用这些方法是最合适的。正如您可以从以下图像中看到的那样，您有如此多的优秀工具可供使用，以使您的应用尽可能高效：

![电池管理 – 在后台做更少的事情](img/B03553_06_07.jpg)

在我们的精彩游戏运行时，点击**选择配置文件模板用于**，然后选择您正在运行的设备（这是测试电池使用的唯一方法），然后选择您的应用。

双击**能量诊断**配置文件模板。然后，在新弹出的窗口顶部，点击红色记录按钮开始记录我们的能量使用。像平时一样玩游戏。不用担心，**Instruments**会在您玩游戏时记录所有数据，这样您就可以在记录能量使用情况的同时寻找bug。

太棒了！

当您完成测试后，只需单击**停止**按钮或按*Command* + *R*键即可停止记录。

现在，您将有一个记录所有已记录数据的完整日志。滚动查看日志中是否有任何峰值。如果有，请返回并检查那些出现峰值的代码区域，以检查是否存在导致峰值的任何问题。

作为一个旁注，能量使用模板显示了从0到20的读数，这将表明您的应用在那时正在使用多少能量：

![电池管理 – 在后台做更少的事情](img/B03553_06_08.jpg)

假设您有一些很棒的粒子在游戏中四处飞舞，并且您在游戏过程中连接了一个蓝牙设备，您无疑会看到您的能量使用始终很高。这并不意味着您的应用有问题。这只意味着您的应用需要更多的电量来运行您所实现的所有功能。

我将以我经常使用的一个应用为例。这个应用来自一个充满有趣照片的网站。无论如何，当我使用这个应用时，我的手机几分钟内就会变热，电池电量开始急剧下降。这难道意味着应用有问题吗？不！尤其是当你开始使用它时了解应用在做什么。

应用不仅需要从服务器加载照片，还使用你的 Wi-Fi 和位置服务，并显示广告——所有这些同时保持你登录到他们的网站，这样你就可以对照片进行评论。

现在，这并不等同于理想的用户体验，但如果你想访问照片，你需要预期这种性能。所以如果你的设备变热或电池消耗得有点多，不要担心——这是设备使用过程中的正常副作用。

没有访问你的电脑并需要记录能量消耗？直接在你的设备上记录使用情况！

如果你已经将你的设备连接到 Xcode，你现在将能够访问设备上的开发者选项，如下面的截图所示：

![电池管理 – 在后台做更少的事情](img/B03553_06_09.jpg)

从这个选项中，你可以在 **Instruments** 部分下选择 **Logging**，然后点击 **Energy** 来启用记录，然后点击 **Start Recording** 按钮开始记录你的能量使用情况，如下面的截图所示：

![电池管理 – 在后台做更少的事情](img/B03553_06_10.jpg)

再次强调，使用你的应用的方式应该和平时一样，**Instruments** 会为你记录数据，在你操作时进行记录。

最后，回到这个设置。你会看到 **Start Recording** 按钮现在已更改为 **Stop Recording**。只需点击 **Stop Recording**。

现在，回到 Xcode Instruments 中，在 **Energy Diagnostics** 选项下，导航到 **File** | **Import Logged Data from Device**。

现在，你将看到与你在 Xcode 中直接运行测试时相同的数据日志。

呼！这有很多需要考虑的！

我知道我一直在说很多，这些都是极其重要的信息。

在我测试应用的过程中，一切运行得都非常完美。事实上，唯一似乎拖慢设备速度的问题就是那些粒子！我们通过检查我们正在运行的设备并相应地调整我们的疯狂粒子来程序化地解决了这个问题。

# 摘要

我们在本章中讨论了很多内容，其中很多是关于如何管理设备性能和电池耗电的最佳实践。

你现在已经做好了应对测试过程并确保你的设备尽可能高效运行的准备，这样就不会有客户因为你的应用对他们的设备造成了极大的影响而退回应用或给出低评分。

男孩们和女孩们，为下一章感到兴奋吧！我们将讨论部署您的应用程序并从中盈利的奇妙之处，这样您就可以赚得数不尽的美元！好吧，可能不会那么多，但至少足够支付您的开发成本就足够了。

准备好，因为现在是最有趣的时候，您将看到所有辛勤工作的成果汇聚在一起。

下一章见，我的朋友们！
