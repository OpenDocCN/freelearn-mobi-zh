<html><head></head><body><div class="chapter" title="Chapter&#xA0;5.&#xA0;Connecting your Apps with Social Media and E-mail"><div class="titlepage"><div><div><h1 class="title"><a id="ch05"/>Chapter 5. Connecting your Apps with Social Media and E-mail</h1></div></div></div><p>In this chapter, we will cover:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">Composing and sending an e-mail</li><li class="listitem" style="list-style-type: disc">Adding attachments to an e-mail</li><li class="listitem" style="list-style-type: disc">Setting up a custom Facebook application</li><li class="listitem" style="list-style-type: disc">Integrating Facebook into your Titanium App</li><li class="listitem" style="list-style-type: disc">Posting on your Facebook wall</li><li class="listitem" style="list-style-type: disc">Connecting to Twitter using OAuth</li><li class="listitem" style="list-style-type: disc">Uploading an image using PHP and HttpRequest</li><li class="listitem" style="list-style-type: disc">Sending a tweet through Birdhouse and OAuth</li></ul></div><div class="section" title="Introduction"><div class="titlepage"><div><div><h1 class="title"><a id="ch05lvl1sec01"/>Introduction</h1></div></div></div><p>Once thought to be the domain of the geeky Gen Y, social media has grown exponentially over the past few years into the hottest area of the web. Facebook now has over 500 million users worldwide, twice the population of the United States! Twitter was once the place where you'd hear about what someone had just eaten for breakfast, now it's the first place many people go to for breaking news. The rise of smartphones and mobile applications has hastened the growth of these social networking services as online socializing is no longer confined to a desktop. People can be seen using Facebook and Twitter, among other services, while on the train, in their cars, and pretty much anywhere.<a id="id197" class="indexterm"/>
</p><p>It's because these services are so ubiquitous that many people now expect them to be a standard service from within an application. A simple app, such as one that lists RSS feeds from news sites, is made that much more useful when the user can tweet, post, or e-mail articles at the touch of a button. In this chapter, we will begin with the original social communication medium, e-mail, before continuing to show you how to integrate the world's largest social networking services, Facebook and Twitter, into your application.<a id="id198" class="indexterm"/>
</p><div class="section" title="Pre-requisites"><div class="titlepage"><div><div><h2 class="title"><a id="ch05lvl2sec01"/>Pre-requisites</h2></div></div></div><p>You should already be familiar with Titanium basics, including creating UI objects and using Titanium Studio. Additionally, to test functionality, you are going to need an account from Twitter and an account from Facebook. You will also need to have an e-mail account set up on your iPhone or Android device.</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">You can signup for Facebook free of charge at:<a class="ulink" href="http://www.facebook.com"> http://www.facebook.com</a></li><li class="listitem" style="list-style-type: disc">You can sign up for Twitter free of charge at:<a class="ulink" href="http://twitter.com"> http://twitter.com</a></li><li class="listitem" style="list-style-type: disc">Google provides free e-mail services that are easily set up on both iPhone and Android. You can sign up at:<a class="ulink" href="http://www.google.com/mail"> http://www.google.com/mail</a></li></ul></div><div class="note" title="Note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title"><a id="note37"/>Note</h3><p>Complete source code for this entire chapter can be found in<code class="literal"> /Chapter 5/PhotoShare</code>.</p></div></div></div></div>
<div class="section" title="Composing and sending an e-mail"><div class="titlepage"><div><div><h1 class="title"><a id="ch05lvl1sec02"/>Composing and sending an e-mail</h1></div></div></div><p>We're going to start this chapter with the simplest form of social communication, both in terms of use and in terms of development—e-mail.<a id="id199" class="indexterm"/>
</p><p>If you are intending to follow the entire chapter and build the PhotoShare app then pay careful attention to the first<span class="emphasis"><em> Getting ready</em></span> section for this recipe, as it will guide you through setting up the project.<a id="id200" class="indexterm"/>
</p><div class="section" title="Getting ready"><div class="titlepage"><div><div><h2 class="title"><a id="ch05lvl2sec02"/>Getting ready</h2></div></div></div><p>To prepare for this recipe, open up Titanium Studio and log in if you have not already done so. If you need to register a new account, you can do so for free directly from within the application. Once you are logged in, click on New Project, and the details window for creating a new project will appear. Enter in<code class="literal"> PhotoShare</code> as the name of the app, and fill in the rest of the details with your own information.<a id="id201" class="indexterm"/>
</p><div class="note" title="Note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title"><a id="note38"/>Note</h3><p>Complete source code for this recipe can be found in the<code class="literal"> /Chapter 5/Recipe 1</code> folder.</p></div></div><div class="section" title="How to do it..."><div class="titlepage"><div><div><h2 class="title"><a id="ch05lvl2sec03"/>How to do it...</h2></div></div></div><p>Our project has now been created using Titanium Studio. Let's get down to business! Open up the<code class="literal"> app.js</code> file in your editor and remove all existing code. After you have done that, type in the following and then hit save:<a id="id202" class="indexterm"/>
</p><div class="informalexample"><pre class="programlisting">// this sets the background color of the master UIView (when there are no windows/tab groups on it)
Titanium.UI.setBackgroundColor('#000');
//this variable will hold our image data blob from the device's gallery
var selectedImage = null;
var win1 = Titanium.UI.createWindow({
title:'Tab 1',
backgroundImage: 'images/background.jpg'
});
var label = Titanium.UI.createLabel({
width: 280,
height: 'auto',
top: 20,
left: 20,
color: '#fff',
font: {fontSize: 18, fontFamily: 'Helvetica', fontWeight: 'bold'},
text: 'Photo Share: \nEmail, Facebook &amp; Twitter'
});
win1.add(label);
var imageThumbnail = Titanium.UI.createImageView({
width: 100,
height: 120,
left: 20,
top: 90,
backgroundColor: '#000',
borderSize: 10,
borderColor: '#fff'
});
win1.add(imageThumbnail);
var buttonSelectImage = Titanium.UI.createButton({
width: 100,
height: 30,
top: 220,
left: 20,
title: 'Choose'
});
buttonSelectImage.addEventListener('click',function(e){
//obtain an image from the gallery
Titanium.Media.openPhotoGallery({
success:function(event)
{
selectedImage = event.media;
// set image view
Ti.API.debug('Our type was: '+event.mediaType);
if(event.mediaType == Ti.Media.MEDIA_TYPE_PHOTO)
{
imageThumbnail.image = selectedImage;
}
},
cancel:function()
{
//user cancelled the action from within
//the photo gallery
}
});
});
win1.add(buttonSelectImage);
var txtTitle = Titanium.UI.createTextField({
width: 160,
height: 35,
left: 140,
top: 90,
value: 'Message title...',
borderStyle: 2,
backgroundColor: '#fff'
});
win1.add(txtTitle);
var txtMessage = Titanium.UI.createTextArea({
width: 160,
height: 120,
left: 140,
top: 130,
value: 'Message text...',
font: {fontSize: 15},
borderStyle: 2,
backgroundColor: '#fff'
});
win1.add(txtMessage);
win1.open();
</pre></div><p>The previous code lays out our basic application and integrates a simple photo gallery selector, much as we did in the previous chapter (<a class="link" href="ch04.html" title="Chapter 4. Enhancing your Apps with Audio, Video, and the Camera">Chapter 4</a>,<span class="emphasis"><em> Enhancing your Apps with Audio, Video, and the Camera)</em></span>. We will now create a new button which will call a function to create and display the e-mail dialog when tapped:<a id="id203" class="indexterm"/>
</p><div class="informalexample"><pre class="programlisting">//create your email
function postToEmail() {
var emailDialog = Titanium.UI.createEmailDialog();
emailDialog.subject = txtTitle.value;
emailDialog.toRecipients = ['info@packtpub.com'];
emailDialog.messageBody = txtMessage.value;
emailDialog.open();
}
var buttonEmail = Titanium.UI.createButton({
width: 280,
height: 35,
top: 280,
left: 20,
title: 'Send Via Email'
});
buttonEmail.addEventListener('click', function(e){
if(selectedImage != null) {
postToEmail();
} else {
alert('You must select an image first!');
}
});
win1.add(buttonEmail);
</pre></div><p>Once you have completed typing in your source code, run your app in the simulator or on your device. You should be able to select an image from the photo gallery, and then type in a title and message for your e-mail using the text fields. This will happen before clicking on the<code class="literal"> buttonEmail</code> object to launch the e-mail dialog window with your message and title attached. Note that if you are using the simulator and you don't have some photos in the gallery already, the best way to obtain some is by visiting<a class="ulink" href="http://images.google.com"> http://images.google.com</a> in mobile Safari, and searching for images. You can then save them to the photo gallery on the simulator by clicking on and holding the image until the <span class="strong"><strong>Save Image</strong></span> pop-up appears.<a id="id204" class="indexterm"/>
</p><div class="mediaobject"><img src="graphics/3968EXP_05_01.jpg" alt="How to do it..."/></div></div><div class="section" title="How it works…"><div class="titlepage"><div><div><h2 class="title"><a id="ch05lvl2sec04"/>How it works…</h2></div></div></div><p>The first block of code is creating our layout view with a single window and a number of basic components, all of which has already been covered in chapters 1 through 4.<a id="id205" class="indexterm"/>
</p><p>The EmailDialog itself is created using the<code class="literal"> Titanium.UI. createEmailDialog()</code> method and only requires a few simple parameters in order to be able to send a basic e-mail message. The<code class="literal"> subject, messageBody</code> and<code class="literal"> toRecipients</code> parameters are standard e-mail fields. While it is not necessary to provide these fields in order to launch an e-mail dialog, you will normally provide at least one or two of these as a matter of course. While the<code class="literal"> subject</code> and<code class="literal"> messageBody</code> fields are both simple strings, it should be noted that the<code class="literal"> toRecipients</code> parameter is actually a basic array. You can add multiple recipients by simply adding another array parameter. For example, if we chose to send our e-mail to two different users, we could write the following:<a id="id206" class="indexterm"/>
</p><div class="informalexample"><pre class="programlisting">emailDialog.toRecipients = ['info@packtpub.com',
'me@boydlee.com'];
</pre></div><p>You can also add BCC or CC recipients in the same manner, using the<code class="literal"> ccRecipients</code> and<code class="literal"> bccRecipients</code> methods of the e-mail dialog respectively. Finally, we launch the e-mail dialog using the<code class="literal"> open()</code> method, at which point you should see something like the following standard e-mail dialog appear in your application:<a id="id207" class="indexterm"/>
</p><div class="mediaobject"><img src="graphics/3968EXP_05_02.jpg" alt="How it works…"/></div></div><div class="section" title="One more thing"><div class="titlepage"><div><div><h2 class="title"><a id="ch05lvl2sec05"/>One more thing</h2></div></div></div><p>You can use the e-mail dialog's event listener,<span class="emphasis"><em> complete</em></span>, in order to tell when an e-mail has been successfully sent or not. The<code class="literal"> result</code> property in your event handler will provide you with the status of your e-mail, which will be one of the following strings:<a id="id208" class="indexterm"/>
</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">CANCELLED (iOS only)</li><li class="listitem" style="list-style-type: disc">FAILED</li><li class="listitem" style="list-style-type: disc">SENT</li><li class="listitem" style="list-style-type: disc">SAVED (iOS only)<a id="id209" class="indexterm"/></li></ul></div></div></div>
<div class="section" title="Adding attachments to an e-mail"><div class="titlepage"><div><div><h1 class="title"><a id="ch05lvl1sec03"/>Adding attachments to an e-mail</h1></div></div></div><p>Now we have a basic e-mail dialog up and running, but ideally what we want to do is attach the photo that we selected from our photo gallery to our new e-mail message. Luckily for us, Titanium makes this easy by exposing a method,<code class="literal"> addAttachment()</code>, that accepts a local path of the file we want to attach.</p><div class="note" title="Note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title"><a id="note39"/>Note</h3><p>Complete source code for this recipe can be found in the<code class="literal"> /Chapter 5/Recipe 2</code> folder.</p></div><div class="section" title="How to do it..."><div class="titlepage"><div><div><h2 class="title"><a id="ch05lvl2sec06"/>How to do it...</h2></div></div></div><p>Adding an attachment is usually as simple as passing the<code class="literal"> addAttachment()</code> method of the e-mail dialog and the location of the file or blob you wish to attach, for example:<a id="id210" class="indexterm"/>
</p><div class="informalexample"><pre class="programlisting">//add an image from the Resource/images directory
emailDialog.addAttachment('images/my_test_photo.png');
</pre></div><p>Our case is a bit trickier than this though. In order to successfully attach our chosen image, we need to first save it temporarily to the file system, and then pass the file system path to<code class="literal"> addAttachment()</code>. Alter your<code class="literal"> postToEmail</code> function to match the following code:<a id="id211" class="indexterm"/>
</p><div class="informalexample"><pre class="programlisting">//create your email
function postToEmail() {
var newDir = Titanium.Filesystem.getFile(
Titanium.Filesystem.applicationDataDirectory,
'attachments');
if(!newDir.exists()) { newDir.createDirectory(); }
//write out the image file to the attachments directory
writeFile = Titanium.Filesystem.getFile(newDir.nativePath,
'temp-image.jpg');
writeFile.write(selectedImage);
var emailDialog = Titanium.UI.createEmailDialog();
emailDialog.subject = txtTitle.value;
emailDialog.toRecipients = ['info@packtpub.com'];
emailDialog.messageBody = txtMessage.value;
//add an image via attaching the saved file
emailDialog.addAttachment(writeFile);
emailDialog.open();
}
</pre></div></div><div class="section" title="How it works..."><div class="titlepage"><div><div><h2 class="title"><a id="ch05lvl2sec07"/>How it works...</h2></div></div></div><p>As you can see from the code, an attachment can be added to your e-mail dialog as a blob object, a file, or from a file path. In our example, we are saving the image from our photo gallery to a temporary file first, before adding it to the e-mail dialog, in order to have it displayed as a proper image attachment (as seen in the following screenshot). You can also call the<code class="literal"> addAttachment</code> method multiple times. However, be aware that multiple attachments are currently only supported on the iPhone.<a id="id212" class="indexterm"/>
</p><div class="mediaobject"><img src="graphics/3968EXP_05_03.jpg" alt="How it works..."/></div></div></div>
<div class="section" title="Setting up a custom Facebook application"><div class="titlepage"><div><div><h1 class="title"><a id="ch05lvl1sec04"/>Setting up a custom Facebook application</h1></div></div></div><p>Integrating Facebook into your Titanium application may seem like a daunting prospect at first. However, once you understand the steps necessary you will see it's not really too hard at all! Before you can allow users to post or retrieve Facebook content from your mobile app, you will first need to set-up an application on Facebook itself. This application will provide you with the necessary API keys you need before the user can authorize your mobile application to post and get content on their behalf.<a id="id213" class="indexterm"/>
</p><div class="section" title="How to do it..."><div class="titlepage"><div><div><h2 class="title"><a id="ch05lvl2sec08"/>How to do it...</h2></div></div></div><p>Firstly, you will need to log in to Facebook using the e-mail address and password you signed up with. If you do not have a Facebook account, you will need to create one for the first time. Don't worry though as it is completely free! You will then need to add the <span class="strong"><strong>Developer App</strong></span> to your Facebook account. You can do this by simply searching for<code class="literal"> Developer</code> in the search bar, and then clicking on through until it is added to your account:<a id="id214" class="indexterm"/>
</p><div class="mediaobject"><img src="graphics/3968EXP_05_04.jpg" alt="How to do it..."/></div><p>Once you have the Developer application added to your account and loaded, simply click on the <span class="strong"><strong>Set Up New App</strong></span> button on the Developer homepage. The <span class="strong"><strong>Create Application</strong></span> screen will then appear, allowing you to give your application a name and requesting that you agree to Facebook's terms and conditions before proceeding. We have called our app<code class="literal"> PhotoShare Titanium</code>, however, you may use whatever name you wish:</p><div class="mediaobject"><img src="graphics/3968EXP_05_05.jpg" alt="How to do it..."/></div><p>On the next screen that appears, give your application a description and fill in the other requested fields as required. When you have finished, simply save your changes. The final screen in the process provides us with the all important information we need in order to connect our Titanium application to the Facebook API. There are three important values here you are going to need in the next recipe, so be sure to write them down somewhere safe!<a id="id215" class="indexterm"/>
</p><p>These fields are:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">Application ID</li><li class="listitem" style="list-style-type: disc">API Key</li><li class="listitem" style="list-style-type: disc">App Secret</li></ul></div><div class="mediaobject"><img src="graphics/3968EXP_05_06.jpg" alt="How to do it..."/></div></div></div>
<div class="section" title="Integrating Facebook into your Titanium App"><div class="titlepage"><div><div><h1 class="title"><a id="ch05lvl1sec05"/>Integrating Facebook into your Titanium App</h1></div></div></div><p>Now that we have a Facebook application set up, we can get down to connecting our Titanium application to it. Luckily for us, Appcelerator has integrated Facebook's new Graph API tightly into Titanium from version 1.6.0 onwards, so connecting and publishing to the Facebook platform is quite easy!<a id="id216" class="indexterm"/>
</p><div class="note" title="Note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title"><a id="note40"/>Note</h3><p>Complete source code for this recipe can be found in the<code class="literal"> /Chapter 5/Recipe 4</code> folder.</p></div><div class="section" title="How to do it..."><div class="titlepage"><div><div><h2 class="title"><a id="ch05lvl2sec09"/>How to do it...</h2></div></div></div><p>The first thing we need to do is create a new button which will authorize our Titanium app to publish data on our user's behalf. Enter in the following code in your<code class="literal"> app.js</code> file to create a new button underneath the existing <span class="strong"><strong>email user</strong></span> button:<a id="id217" class="indexterm"/>
</p><div class="informalexample"><pre class="programlisting">//create your facebook session and post to fb
function postToFacebook() {
//if the user is not logged in, do so, else post to wall
if(Titanium.Facebook.loggedIn == false) {
Titanium.Facebook.appid = '&lt;your app id&gt;';
Titanium.Facebook.permissions = ['publish_stream'];
// Permissions your app needs
Titanium.Facebook.addEventListener('login', function(e)
{
if(e.success) {
alert('You are now logged in!');
} else if(e.error) {
alert('Error: ' + e.error);
} else if(e.cancelled) {
alert('You cancelled the login');
}
});
//call the facebook authorize method to login
Titanium.Facebook.authorize();
}
}
var buttonFacebook = Titanium.UI.createButton({
width: 280,
height: 35,
top: 330,
left: 20,
title: 'Send Via Facebook'
});
buttonFacebook.addEventListener('click', function(e){
if(selectedImage != null) {
postToFacebook();
} else {
alert('You must select an image first!');
}
});
win1.add(buttonFacebook);
</pre></div><p>Now select an image and click on the Facebook button. If you entered in your client ID correctly (which you would have obtained by following the previous recipe) then you should see a login window open up and connect to the Facebook website, showing your application and the permissions it is requesting, as shown in the following example screenshots:<a id="id218" class="indexterm"/>
</p><div class="mediaobject"><img src="graphics/3968EXP_05_07.jpg" alt="How to do it..."/></div></div><div class="section" title="How it works..."><div class="titlepage"><div><div><h2 class="title"><a id="ch05lvl2sec10"/>How it works...</h2></div></div></div><p>We're creating a function that provides Facebook functionality to our application, and allows us to log in to Facebook and let the user accept the permissions we require in order to post to their wall. This function allows us to authenticate against the Facebook API using the App ID that we created in the previous recipe.<a id="id219" class="indexterm"/>
</p><p>This authorization, when successful, allows the user to log in and agree to your request to use certain permissions against their Facebook account. A successful authorization will return and save a Facebook Token. This token is essentially a random string that contains all of the user ID and permission data we will need to execute Facebook Graph requests against the authorized user's account. A successful login will set the<code class="literal"> Titanium.Facebook.loggedIn</code> variable to true, and in the next recipe, we will extend our<code class="literal"> postToFacebook</code> function, using this variable as part of a request to post our chosen photo to our Facebook wall.</p></div></div>
<div class="section" title="Posting on your Facebook wall"><div class="titlepage"><div><div><h1 class="title"><a id="ch05lvl1sec06"/>Posting on your Facebook wall</h1></div></div></div><p>Now that we are able to authenticate against Facebook, it's time to post a photo from the gallery to our wall! To achieve this, we need to use Facebook's Graph API, making a call to the correct graph function, with the correct permissions.<a id="id220" class="indexterm"/>
</p><div class="note" title="Note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title"><a id="note41"/>Note</h3><p>Complete source code for this recipe can be found in the<code class="literal"> /Chapter 5/Recipe 5</code> folder.</p></div><div class="section" title="How to do it..."><div class="titlepage"><div><div><h2 class="title"><a id="ch05lvl2sec11"/>How to do it...</h2></div></div></div><p>Let's extend our new<code class="literal"> postToFacebook()</code> function by writing a new if-else statement which will take a couple of parameters and execute a Graph request against the Facebook API. Extend the<code class="literal"> postToFacebook()</code> function in<code class="literal"> app.js</code>, so that it matches the following code:<a id="id221" class="indexterm"/>
</p><div class="informalexample"><pre class="programlisting">//create your facebook session and post to fb
function postToFacebook() {
//if the user is not logged in, do so, else post to wall
if(Titanium.Facebook.loggedIn == false) {
Titanium.Facebook.appid = '252235321506456';
Titanium.Facebook.permissions = ['publish_stream'];
// Permissions your app needs
Titanium.Facebook.addEventListener('login', function(e)
{
if(e.success) {
alert('You are now logged in!');
} else if(e.error) {
alert('Error: ' + e.error);
} else if(e.cancelled) {
alert('You cancelled the login');
}
});
//call the facebook authorize method to login
Titanium.Facebook.authorize();
}
else {
//Now post the photo after you've confirmed
//that we have an access token
var data = {
caption: 'I am posting a photo to my facebook page!',
picture: selectedImage
};
Titanium.Facebook.requestWithGraphPath('me/photos',
data, "POST", function(e) {
if (e.success) {
alert( "Success! Your image has been posted to
your Facebook wall.");
Ti.API.info("Success! The image you posted has
the new ID: " + e.result);
}
else {
alert('Your image could not be posted to Facebook
at this time. Try again later.');
Ti.API.error(e.error);
}
});
} //end if else loggedIn
}
</pre></div><p>Now run the application in your emulator or device. If you post an image successfully, you should end up seeing an alert dialog appear in your app, the ID of the new image object from the graph API appear in your developer console, and the photo appear as a post on your Facebook wall!<a id="id222" class="indexterm"/>
</p><div class="mediaobject"><img src="graphics/3968EXP_05_08.jpg" alt="How to do it..."/></div></div><div class="section" title="How it works…"><div class="titlepage"><div><div><h2 class="title"><a id="ch05lvl2sec12"/>How it works…</h2></div></div></div><p>We extended the<code class="literal"> postToFacebook()</code> function that we created in our previous recipe, updating it to first log in to the Facebook API, and then on subsequent post attempts to send a graph request along with a photo to our Facebook Wall.<a id="id223" class="indexterm"/>
</p><p>We can now use Facebook's Graph API (encapsulated in our new<code class="literal"> graphRequest</code> function) to execute our request, passing it the session token we retrieved from the authentication dialog in the previous recipe, along with the name of the graph method we want to call (<code class="literal">me/photos</code>), and the data properties that method requires. In the case of the<code class="literal"> me/photos</code> method, these two properties are:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>caption:</strong></span> A string value which will accompany our image file</li><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>picture:</strong></span> A blob/image containing our image data</li></ul></div><p>Using the Graph API and the Facebook login and post function which we have built, it is possible to execute any kind of graph request in your app that Facebook (and your user permissions) will allow. The following screenshot shows an example post:<a id="id224" class="indexterm"/>
</p><div class="mediaobject"><img src="graphics/3968EXP_05_09.jpg" alt="How it works…"/></div></div></div>
<div class="section" title="Connecting to Twitter using OAuth"><div class="titlepage"><div><div><h1 class="title"><a id="ch05lvl1sec07"/>Connecting to Twitter using OAuth</h1></div></div></div><p>Appcelerator doesn't currently provide an integrated method of connecting to Twitter in your Titanium applications. However, there are plenty of other options available. One of the best libraries is provided by Joe Purcell and is called "Birdhouse". In this recipe we are going to set up a Twitter application online, get the necessary API keys together (much the same as we did for Facebook), and then implement the OAuth libraries from Google, and finally, the Birdhouse Titanium module.<a id="id225" class="indexterm"/>
</p><div class="note" title="Note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title"><a id="note42"/>Note</h3><p>Complete source code for this recipe can be found in the<code class="literal"> /Chapter 5/Recipe 6</code> folder.</p></div><div class="section" title="How to do it..."><div class="titlepage"><div><div><h2 class="title"><a id="ch05lvl2sec13"/>How to do it...</h2></div></div></div><p>Before we can try to implement the Birdhouse and OAuth libraries, we first need to create an application through Twitter. If you do not have a Twitter account, you will need to create one for the first time. Don't worry though as it is completely free! Log in to your Twitter account at<a class="ulink" href="http://https://dev.twitter.com/apps/new"> https://dev.twitter.com/apps/new</a> and, once Twitter authenticates your details, you'll be able to create a new Twitter application.<a id="id226" class="indexterm"/>
</p><p>Fill in all of the fields with your own details. For our purposes, we have called the Twitter app<code class="literal"> PhotoShare</code> and set the company and website to that of Packt Publishing. Ensure the application type is set to<code class="literal"> Browser</code>, and that the Default Access Type is set to<code class="literal"> Read &amp; Write</code>. All other fields can either be created as you see fit, or left blank. Enter in the Captcha code and click on <span class="strong"><strong>Register Application</strong></span>, accepting the terms of service as you do.</p><p>Once that is done, your application is ready to receive requests from Titanium. Before we can implement the Birdhouse library though, we first need to grab the<code class="literal"> oauth.js</code> and<code class="literal"> sha1.js</code> source files from Google. You can download these from their SVN repository at<a class="ulink" href="http://oauth.googlecode.com/svn/code/javascript/"> http://oauth.googlecode.com/svn/code/javascript/</a>. Download and save these two files to a new folder called<code class="literal"> lib</code> inside your existing<code class="literal"> Resources</code> folder. Then, navigate your browser to<a class="ulink" href="http://https://github.com/jpurcell/birdhouse"> https://github.com/jpurcell/birdhouse</a> and download the<code class="literal"> birdhouse.js</code> module file, again saving it to your<code class="literal"> Resources</code> folder.</p><div class="mediaobject"><img src="graphics/3968EXP_05_10.jpg" alt="How to do it..."/></div><p>The final step now is including the<code class="literal"> birdhouse.js</code> library into our<code class="literal"> app.js</code> file and executing the Twitter authorization process. First of all, include the library at the top of your<code class="literal"> app.js</code> file:<a id="id227" class="indexterm"/>
</p><div class="informalexample"><pre class="programlisting">Ti.include('birdhouse.js');
</pre></div><p>We then need to create a new button to authorize and eventually post our Tweet. Enter the following code near the bottom of your<code class="literal"> app.js</code> replacing the<code class="literal"> consumer_key</code> and<code class="literal"> consumer_secret</code> values with the ones provided to you on the Twitter app page:</p><div class="informalexample"><pre class="programlisting">//create your twitter session and post a tweet
function postToTwitter()
{
var BH = new BirdHouse({
consumer_key: "your-consumer-key",
consumer_secret: "your-consumer-secret"
});
//call the birdhouse authorize() method
BH.authorize();
}
var buttonTwitter = Titanium.UI.createButton({
width: 280,
height: 35,
top: 375,
left: 20,
title: 'Send Via Twitter'
});
buttonTwitter.addEventListener('click', function(e){
if(selectedImage != null) {
postToTwitter();
} else {
alert('You must select an image first!');
}
});
win1.add(buttonTwitter);
</pre></div><p>That's it! You should now be able to choose an image, and then click on the new <span class="strong"><strong>Post To Twitter</strong></span> button at the bottom of the screen. The authorization screen, with our Twitter applications details, should appear and you should be able to log in to Twitter using your existing username and password, as seen in the following screenshot:<a id="id228" class="indexterm"/>
</p><div class="mediaobject"><img src="graphics/3968EXP_05_11.jpg" alt="How to do it..."/></div></div></div>
<div class="section" title="Uploading an image using PHP and HttpRequest"><div class="titlepage"><div><div><h1 class="title"><a id="ch05lvl1sec08"/>Uploading an image using PHP and HttpRequest</h1></div></div></div><p>There are a number of ways to post an image to Twitter, including using a service such as yfrog or TwitPic. However, for this example we are going to post the image to our own server using PHP and return back the URL. You will need a server running PHP with the GDImage for this recipe to work. There are plenty of cheap or free PHP hosting services online if you don't already have a server. Alternatively, if you are proficient in another web language (such as ASP.NET) you can always rewrite the sample code as you see fit.<a id="id229" class="indexterm"/>
</p><div class="note" title="Note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title"><a id="note43"/>Note</h3><p>Complete source code for this recipe can be found in the<code class="literal"> /Chapter 5/Recipe 7</code> folder.</p></div><div class="section" title="How to do it..."><div class="titlepage"><div><div><h2 class="title"><a id="ch05lvl2sec14"/>How to do it...</h2></div></div></div><p>Create a new file on your server called<code class="literal"> upload.php</code> and save it with the following contents:<a id="id230" class="indexterm"/>
</p><div class="informalexample"><pre class="programlisting">&lt;?php
$target = getcwd();
$target = $target .'/'. $_POST['randomFilename'];
if(move_uploaded_file($_FILES['media']['tmp_name'], $target))
{
$filename = $target;
// Get dimensions of the original image
list($current_width, $current_height) = getimagesize($filename);
// The x and y coordinates on the original image where we
// will begin cropping the image
$left = 0;
$top = 0;
// This will be the final size of the image (e.g. how many pixels
// left and down we will be going)
$crop_width = $current_width;
$crop_height = $current_height;
// Resample the image
$canvas = imagecreatetruecolor($crop_width, $crop_height);
$current_image = imagecreatefromjpeg($filename);
imagecopy($canvas, $current_image, 0, 0, $left, $top, $current_width, $current_height);
imagejpeg($canvas, $filename, 100);
echo 'http://&lt;mysite.com&gt;/'.$_POST['randomFilename'];
}
else
{
echo "0";
}
?&gt;
</pre></div><p>Now in the<code class="literal"> postToTwitter</code> function in your existing<code class="literal"> app.js</code> file, we are going to extend the code in order to accommodate posting an image to our server. However, before performing any post image code, we will perform an authorized method call to the Birdhouse API and ensure that the user is currently logged into Twitter. We'll also generate a random 5-letter filename. It's important to keep this nice and short to keep the number of characters we're using to a minimum as Twitter messages have a 140-character limit!<a id="id231" class="indexterm"/>
</p><div class="informalexample"><pre class="programlisting">function randomString(length,current){
current = current ? current : '';
return length ? randomString( --length , "abcdefghiklmnopqrstuvwxyz".charAt ( Math.floor( Math.random() * 60 ) ) + current ) : current;
}
//create your twitter session and post a tweet
function postToTwitter()
{
var BH = new BirdHouse({
consumer_key: "&lt;your consumer key&gt;",
consumer_secret: "&lt;your consumer secret&gt;"
});
if(!BH.authorized){
BH.authorize();
}
else
{
//create the httpRequest
var xhr = Titanium.Network.createHTTPClient();
//open the httpRequest
xhr.open('POST','http://&lt;mysite&gt;.com/upload.php');
xhr.onload = function(response) {
//the image upload method has finished
if(this.responseText != '0')
{
var imageURL = this.responseText;
alert('Your image was uploaded to ' + imageURL);
//now we have an imageURL we can post a tweet
//using birdhouse!
}
else
{
alert('The upload did not work! Check your PHP server settings.');
}
};
// send the data
var r = randomString(5) + '.jpg';
xhr.send({'media': selectedImage, 'randomFilename': r});
}
}
</pre></div></div><div class="section" title="How it works…"><div class="titlepage"><div><div><h2 class="title"><a id="ch05lvl2sec15"/>How it works…</h2></div></div></div><p>Here we are utilizing some of our existing knowledge in posting via<code class="literal"> HttpRequest</code> and then extending that knowledge to also send across blob data, using PHP and GDImage. This is then used to write that blob data to an image file on our remote server before returning the new URL. You'll notice that we also extended our<code class="literal"> postToTwitter</code> function to check whether the user is already authorized against Twitter or not before performing this post.<a id="id232" class="indexterm"/>
</p></div></div>
<div class="section" title="Sending a tweet through Birdhouse and OAuth"><div class="titlepage"><div><div><h1 class="title"><a id="ch05lvl1sec09"/>Sending a tweet through Birdhouse and OAuth</h1></div></div></div><p>For our final recipe, we're going to put everything together and, using a combination of our previous recipe's "image post" functionality and the Birdhouse API, post a tweet containing a message from our app and the image URL that accompanies it.<a id="id233" class="indexterm"/>
</p><div class="note" title="Note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title"><a id="note44"/>Note</h3><p>Complete source code for this recipe can be found in the<code class="literal"> /Chapter 5/Recipe 8</code> folder.</p><p>Complete source code for this entire chapter can be found in the<code class="literal"> /Chapter 5/PhotoShare</code> folder.</p></div><div class="section" title="How to do it…"><div class="titlepage"><div><div><h2 class="title"><a id="ch05lvl2sec16"/>How to do it…</h2></div></div></div><p>Alter the<code class="literal"> postToTwitter</code> function in your existing<code class="literal"> app.js</code> file to match the following code by adding our new<code class="literal"> BH.tweet</code> method call. If you already integrated the photo upload code from the previous recipe, then this source code snippet should appear in the<code class="literal"> xhr.onload()</code> event handler:</p><div class="informalexample"><pre class="programlisting">BH.tweet(txtMessage.value + ' ' + this.responseText,
function(){
alertDialog = Ti.UI.createAlertDialog({
message:'Tweet posted!'
});
alertDialog.show();
});
</pre></div><p>Try running your application now in the simulator, and after authorization to Twitter (if necessary) your new tweet should get posted directly from your app! Go to<a class="ulink" href="http://twitter.com/yourusername"> http://twitter.com/yourusername</a> to see the tweet posted to your timeline (as seen next). Clicking on the link should then load your uploaded photo!</p><div class="mediaobject"><img src="graphics/3968EXP_05_12.jpg" alt="How to do it…"/></div></div><div class="section" title="How it works…"><div class="titlepage"><div><div><h2 class="title"><a id="ch05lvl2sec17"/>How it works…</h2></div></div></div><p>This recipe is very simple, as all of the hard work in connecting to Twitter and uploading an image to our server has been taken care of. Therefore pushing our final message via Birdhouse to the Twitter API is actually very easy. Here we are calling the Birdhouse<code class="literal"> tweet()</code> function, which accepts both a message (as a string) and a second parameter that acts as the event handler for the response from Twitter. You can also use this tweet function outside of posting an image or file to the server. Try posting a simple message tweet without the image and code and you'll see it works just as well!<a id="id234" class="indexterm"/>
</p><div class="mediaobject"><img src="graphics/3968EXP_05_13.jpg" alt="How it works…"/></div></div></div></body></html>