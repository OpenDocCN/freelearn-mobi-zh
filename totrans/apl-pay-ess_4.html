<html><head></head><body><div><div><div><div><h1 class="title"><a id="ch04"/>Chapter 4. Payment Processing Workflow</h1></div></div></div><p>After the user authorizes the payment request, the <em>user app</em>, the <em>payment gateway</em>, and the <em>order processing web app</em> team up to securely deliver payment information to the issuing bank to transfer the funds from the user's account to the acquiring bank and to inform the user of the transaction status (that is, whether it is approved or declined).</p><p>The payment processing workflow is made up of three phases:</p><div><ol class="orderedlist arabic"><li class="listitem"><strong>Preprocess phase</strong>: In this <a id="id126" class="indexterm"/>phase, the app gets a charge token from the payment gateway and<a id="id127" class="indexterm"/> sends the order information (including the charge token) to the order processing server</li><li class="listitem"><strong>Process phase</strong>: In this<a id="id128" class="indexterm"/> phase, the order processing web app (running on your server) charges the user's card<a id="id129" class="indexterm"/> through the payment gateway, updates the order and inventory data if the charge is successful, and sends the transaction status to the user app</li><li class="listitem"><strong>Postprocess phase</strong>: In this, the<a id="id130" class="indexterm"/> user app informs the user about the status of the transaction and dismisses<a id="id131" class="indexterm"/> the payment sheet</li></ol></div><p>This chapter will do the following:</p><div><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">Introduce the actors and operations in the payment processing workflow</li><li class="listitem" style="list-style-type: disc">Describe each phase of the payment processing workflow and the steps taken within each phase<div><div><h3 class="title"><a id="note03"/>Note</h3><p>As the payment gateway API does not run appropriately in the Simulator app in general, you must use an actual iOS device to test the payment processing workflow in your development environment. </p></div></div></li></ul></div><div><div><div><div><h1 class="title"><a id="ch04lvl1sec27"/>Actors and operations in the processing workflow</h1></div></div></div><p>The <em>payment processing workflow</em> is the process by which the payment information generated by Apple Pay, from<a id="id132" class="indexterm"/> the payment request and the information the user entered into the payment sheet, is transmitted to your payment gateway<a id="id133" class="indexterm"/> and the card's issuing bank in order to charge the card and make the payment's funds available in<a id="id134" class="indexterm"/> your acquiring bank.</p><p>The workflow starts<a id="id135" class="indexterm"/> when the payment sheet calls the <code class="literal">paymentAuthorizationViewController:didAuthorizePayment:completion:</code> delegate method, providing the user app with the general order information (such as the shipping and billing information) and a payment token containing the encrypted payment data.</p><p>This diagram depicts the actors, operations, and data that are part of the payment processing workflow:</p><div><img src="img/B05093_04_01.png.jpg" alt="Actors and operations in the processing workflow"/></div><p>These are the<a id="id136" class="indexterm"/> operations and data that are part of the workflow:</p><div><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><strong>payment authorized</strong>: The<a id="id137" class="indexterm"/> payment sheet tells the app that the user authorized the payment</li><li class="listitem" style="list-style-type: disc"><strong>payment token</strong>: The app<a id="id138" class="indexterm"/> provides the payment token to the payment gateway, which returns a <strong>charge token</strong></li><li class="listitem" style="list-style-type: disc"><strong>order info and charge token</strong>: the app sends information about the order and the charge token<a id="id139" class="indexterm"/> to the order processing web app</li><li class="listitem" style="list-style-type: disc"><strong>charge card</strong>: The<a id="id140" class="indexterm"/> web app charges the card through the payment gateway</li><li class="listitem" style="list-style-type: disc"><strong>approved or declined</strong>: The payment gateway tells the web app whether the payment is approved <a id="id141" class="indexterm"/>or declined</li><li class="listitem" style="list-style-type: disc"><strong>transaction result and order metadata</strong>: The web app provides the user app with the result of the<a id="id142" class="indexterm"/> transaction and order information such as the order number</li><li class="listitem" style="list-style-type: disc"><strong>transaction result</strong>: The <a id="id143" class="indexterm"/>app tells the payment sheet the result of the payment transaction—that is, whether it is approved or declined</li><li class="listitem" style="list-style-type: disc"><strong>payment sheet done</strong>: The <a id="id144" class="indexterm"/>payment sheet tells the<a id="id145" class="indexterm"/> app that the transaction is complete</li><li class="listitem" style="list-style-type: disc"><strong>dismiss</strong>: The app dismisses<a id="id146" class="indexterm"/> the payment sheet</li></ul></div></div></div>
<div><div><div><div><h1 class="title"><a id="ch04lvl1sec28"/>The preprocess phase</h1></div></div></div><p>In the <em>Preprocess</em> phase, the user app <a id="id147" class="indexterm"/>uses the payment information that the payment sheet generates (in the form of a <code class="literal">PKPayment</code> object) as a result of the user's authorization. The app sends this information to the payment gateway and obtains a charge token (this item may be identified using different names, such as the registration ID, depending on the payment gateway; the order processing web app uses the charge token to charge the user's card). The app then packages the charge token along with pertinent information about the order (such as <em>billing information</em>, <em>shipping information</em>, <em>shipping method</em>, and so on) and sends it to the order processing web app on your server.</p><p>The following three<a id="id148" class="indexterm"/> sections describe the steps of the <em>Preprocess</em> phase.</p><div><div><div><div><h2 class="title"><a id="ch04lvl2sec23"/>The merchant app receives the payment token</h2></div></div></div><p>When the user <a id="id149" class="indexterm"/>authorizes the payment request, the payment sheet calls the <code class="literal">paymentAuthorizationViewController:didAuthorizePayment:completion</code>: delegate method (which is part of the <code class="literal">PKPaymentAuthorizationViewControllerDelegate</code> protocol). This method provides the payment information (a <code class="literal">PKPayment</code> object) and a completion block.</p><p>These are the <a id="id150" class="indexterm"/>components of a <code class="literal">PKPayment</code> object:</p><div><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><strong>payment token</strong> (<code class="literal">PKPaymentToken</code>): This<a id="id151" class="indexterm"/> is generated when the user authorizes the payment request</li><li class="listitem" style="list-style-type: disc"><strong>billing contact</strong>: This is the<a id="id152" class="indexterm"/> billing contact information, including the e-mail address (<code class="literal">NSString</code>), name (<code class="literal">NSPersonNameComponents</code>), phone number (<code class="literal">CNPhoneNumber</code>), and postal address (<code class="literal">CNPostalAddress</code>)</li><li class="listitem" style="list-style-type: disc"><strong>shipping contact</strong>: This<a id="id153" class="indexterm"/> is the shipping contact information (which has the same components as the billing contact)</li><li class="listitem" style="list-style-type: disc"><strong>shipping method</strong> (<code class="literal">PKShippingMethod</code>): This is<a id="id154" class="indexterm"/> the shipping method selected by the user</li></ul></div><p>These are the components of a <code class="literal">PKPaymentToken</code> object:</p><div><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><strong>payment data</strong> (an encrypted <code class="literal">NSData</code> object): This is the data used by the payment gateway<a id="id155" class="indexterm"/> and issuing bank to charge the user's card</li><li class="listitem" style="list-style-type: disc"><strong>payment method</strong> (<code class="literal">PKPaymentMethod</code>): This identifies the type of card used for the<a id="id156" class="indexterm"/> transaction, such as debit, credit, prepaid, or store card</li><li class="listitem" style="list-style-type: disc"><strong>transaction identifier</strong> (<code class="literal">NSString</code>): This is a user-friendly identifier for the payment <a id="id157" class="indexterm"/>transaction</li></ul></div><p>The example merchant app implementation of the <code class="literal">paymentAuthorizationViewController:didAuthorizePayment:completion:</code> method is listed here:</p><div><pre class="programlisting">// client_app/merchantapp/ProductCard.m
- (void)
paymentAuthorizationViewController:
   (PKPaymentAuthorizationViewController*)      controller
didAuthorizePayment:
   (PKPayment*)                                 payment_info
completion:
   (void (^)(PKPaymentAuthorizationStatus))     payment_completion
{
<strong>   [self process_ApplePay_payment_with_Stripe:payment_info</strong>
<strong>                                   completion:payment_completion];</strong>
}</pre></div><p>The method calls <code class="literal">process_ApplePay_payment_with_Stripe:completion:</code> to start processing the payment. This method is tailored for a particular payment gateway. The <code class="literal">payment_info</code> parameter contains the payment token, and the shipping and billing information requested<a id="id158" class="indexterm"/> in the payment request. The <code class="literal">payment_completion</code> parameter defines the block that tells the payment sheet that the<a id="id159" class="indexterm"/> transaction is processed.</p></div><div><div><div><div><h2 class="title"><a id="ch04lvl2sec24"/>The merchant app receives the charge token from the payment gateway</h2></div></div></div><p>After the app gets the payment information (a <code class="literal">PKPayment</code> object), it uses the payment gateway API to obtain <a id="id160" class="indexterm"/>a charge token, which is used by the order processing web app to charge the card. (Some payment<a id="id161" class="indexterm"/> gateways provide a native iOS API to issue the charge token; others require that the app makes an HTTP request to their payment server.) The APIs of some payment gateways operate on the payment token (<code class="literal">PKPaymentToken</code>), while others require the <code class="literal">PKPayment</code> object.</p><p>In the example merchant app, the <code class="literal">process_ApplePay_payment_with_Stripe:completion:</code> method of the <code class="literal">ProductCard</code> class calls the native iOS API provided by the Stripe payment gateway, which operates on the <code class="literal">PKPayment</code> object, returning a charge token (an <code class="literal">STPToken</code> object). Other payment gateways have a similar native or web API that provides the same functionality.</p><p>This is the <code class="literal">process_ApplePay_payment_with_Stripe:completion</code>: method in the example merchant app:</p><div><pre class="programlisting">// client_app/merchantapp/ProductCard.m
- (void)
process_ApplePay_payment_with_Stripe:
   (PKPayment*)                                 payment_info 
completion:
   (void (^)(PKPaymentAuthorizationStatus))     payment_completion
{   
<strong>   [[STPAPIClient sharedClient]</strong>
<strong>      createTokenWithPayment: payment_info</strong>
<strong>                  completion: ^</strong>
   (STPToken* <strong>charge_token</strong>, NSError* error)
   {
      if (error)
      {
         NSLog(@"error creating STPToken object");
         payment_completion(PKPaymentAuthorizationStatusFailure);
      }
      else
<strong>         [self backend_process_payment_info: payment_info</strong>
<strong>                                    gateway: @"stripe"</strong>
<strong>                               charge_token: charge_token</strong>
<strong>                                 completion: payment_completion];</strong>
   }];
}</pre></div><p>If the method that <a id="id162" class="indexterm"/>creates the charge token (<code class="literal">createTokenWithPayment:completion:</code> of the <code class="literal">STPAPIClient</code> class) reports <a id="id163" class="indexterm"/>an error, this method calls the payment completion block with the <code class="literal">PKPaymentAuthorizationStatusFailure</code> argument, which effectively ends the transaction. Otherwise, it calls the <code class="literal">backend_process_payment_info:gateway:charge_token:completion:</code> method, which is described in the next section.</p></div><div><div><div><div><h2 class="title"><a id="ch04lvl2sec25"/>The merchant app sends the order information to the order processing system</h2></div></div></div><p>After obtaining the payment information (<code class="literal">PKPayment</code>) from the payment sheet and the charge token from<a id="id164" class="indexterm"/> the payment gateway, the app packages the charge token and other information required by the order <a id="id165" class="indexterm"/>processing web app and sends it to your server through an HTTP request.</p><p>In the example merchant app, the <code class="literal">backend_process_payment_info:gateway:charge_token:completion:</code> method of the <code class="literal">ProductCard</code> class packages the required information into a JSON object (the payload) and sends it to the order processing web app through an HTTP <code class="literal">POST</code> request to the <code class="literal">http://red:12345/payment</code> unique resource identifier (URI). Take a look at the following code:</p><div><pre class="programlisting">// client_app/merchantapp/ProductCard.m
- (void)
backend_process_payment_info:
   (PKPayment*)                                  payment_info
gateway:
   (NSString*)                                   gateway
charge_token:
   (id)                                          charge_token
completion:
   (void (^)(PKPaymentAuthorizationStatus))      payment_completion
{
   RestIO* rest_io= [RestIO sharedRestIO];
   {
      AppDelegate* app_delegate=
         [UIApplication sharedApplication].delegate;
      NSString* payment_charge_uri=
         [NSString stringWithFormat:@"%@%@",
            app_delegate.rest_io_host,
            @"/payment"];
      
      NSNumber* total_in_cents= (NSNumber*)
      [_payment_request
            .paymentSummaryItems
             [_payment_request.paymentSummaryItems.count - 1]
            .amount
          decimalNumberByMultiplyingBy:
             [NSDecimalNumber decimalNumberWithString: @"100"]
      ];
      NSString* currency= _payment_request.currencyCode;
      
      NSString* contact_name=
         [payment_info.shippingContact.name.givenName
             stringByAppendingString:
                [@" " stringByAppendingString:
                   payment_info.shippingContact.name.familyName]];
      
      // collect info required by order processing webapp
<strong>      NSDictionary* order_info_package_dictionary= @</strong>
<strong>      {</strong>
<strong>         @"gateway"     : gateway,</strong>
<strong>         @"source"      : ((STPToken*)charge_token).tokenId,</strong>
<strong>         @"amount"      : total_in_cents,</strong>
<strong>         @"currency"    : currency,</strong>
<strong>         @"description" : </strong>
<strong>            _payment_request.paymentSummaryItems[0].label,</strong>
<strong>         @"shipping_contact"     : contact_name,</strong>
<strong>         @"shipping_email"       :</strong>
<strong>            payment_info.shippingContact.emailAddress,</strong>
<strong>         @"shipping_street"      :</strong>
<strong>            payment_info.shippingContact.postalAddress.street,</strong>
<strong>         @"shipping_city"        :</strong>
<strong>            payment_info.shippingContact.postalAddress.city,</strong>
<strong>         @"shipping_state"       :</strong>
<strong>            payment_info.shippingContact.postalAddress.state,</strong>
<strong>         @"shipping_zip"         :</strong>
<strong>            payment_info.shippingContact.postalAddress.postalCode,</strong>
<strong>         @"shipping_method_name" :</strong>
<strong>            payment_info.shippingMethod.identifier</strong>
<strong>      };</strong>
      
      NSData* order_info_package_json;
      {
<strong>         NSError* error;</strong>
<strong>         order_info_package_json=</strong>
<strong>            [NSJSONSerialization</strong>
<strong>               dataWithJSONObject: order_info_package_dictionary</strong>
<strong>                          options: NSJSONWritingPrettyPrinted </strong>
<strong>                            error: &amp;error];</strong>
         NSAssert(!error, @"error converting %@ to JSON", error);
      }
      
      // send order information to order processing web app
<strong>      [rest_io postResourceAtURI: payment_charge_uri</strong>
<strong>                            body: order_info_package_json</strong>
<strong>                      completion: ^</strong>
<strong>      (NSURLResponse* response, NSData* data)</strong>
      {
         if (((NSHTTPURLResponse*)response).statusCode == 200)
         {
            NSDictionary* result;
            {
               NSError* error;
               result=
                  [NSJSONSerialization
                     JSONObjectWithData: data
                                options: 0
                                  error: &amp;error];
               if (error)
                  [NSException
                      raise: @"JSONDeserializationException"
                     format: @"error deserializing JSON"];
            }
            NSString* status= (NSString*)result[@"status"];
            payment_completion(
               [status isEqual: @"succeeded"]?
                  PKPaymentAuthorizationStatusSuccess :
                  PKPaymentAuthorizationStatusFailure
            );
         }
         else
            payment_completion(
               PKPaymentAuthorizationStatusFailure);
      }];
   }
}</pre></div><p>The <code class="literal">payment_info</code> parameter is the <code class="literal">PKPayment</code> object provided by the payment sheet in the <code class="literal">paymentAuthorizationViewController:didAuthorizePayment:completion:</code> delegate method. The <code class="literal">gateway</code> parameter identifies the payment gateway the app uses to get the charge<a id="id166" class="indexterm"/> token; this could be<a id="id167" class="indexterm"/> useful for merchant apps that use more than one payment gateway but only one order processing web app. The <code class="literal">charge_token</code> parameter is the charge token obtained from the payment gateway API. The <code class="literal">payment_completion</code> parameter is the same completion block provided in the <code class="literal">paymentAuthorizationViewController:didAuthorizePayment:completion:</code> delegate method.</p><p>In the order processing web app, the handler for the <code class="literal">/payment</code> request takes a JSON object (which is <a id="id168" class="indexterm"/>stored in the <code class="literal">order_info_package_json</code> variable in the <code class="literal">backend_process_payment_info:</code> method) with the required information. In the example project's <a id="id169" class="indexterm"/>web app, this information is the name of the payment gateway, the information the payment processor requires to charge the payment card (the payment token, the payment amount, and the payment's currency), and the shipping details.</p></div></div>
<div><div><div><div><h1 class="title"><a id="ch04lvl1sec29"/>The process phase</h1></div></div></div><p>In the <em>Process</em> phase of the payment processing workflow, the order processing web app charges the user's card, updates the ordering and inventory data, and returns the transaction's status (that is, whether it is <a id="id170" class="indexterm"/>approved or declined) to the user app on the user's device as an HTTP response to the app's original HTTP request. This web app uses the payment gateway's server-side API to communicate with it.</p><p>In the example order processing web app (a Node.js web app), the HTTP request from the user app is handled by the middleware, as follows:</p><div><pre class="programlisting">// server_app/red.js
// payment middleware
server.post('/payment', function(request, response, next)
{
<strong>   // 1. parse request</strong>
   var order_info_package= JSON.parse(request.body);
   
   // process charge token
   if (order_info_package.gateway == 'stripe')
   {
<strong>      // 2. charge payment card</strong>
      var charge= stripe.charges.create
      (
         {
            amount      : order_info_package.amount,
            currency    : order_info_package.currency,
            source      : order_info_package.source,
            description : 
               'charge for ' + order_info_package.description
         }, 
         function(error, charge)
         {
            var transaction_info= 
            {
               id     : charge.id,
               status : charge.status
            }
            
            if (error)
               console.log('there's an error creating a charge: '
                  + error);
            else
            {
<strong>               // 3.a update inventory</strong>
               // ...
               
<strong>               // 3.b create order</strong>
               var order= models.Order(
               {
                  date                 : new Date(),
                  description          :
                     order_info_package.description,
                  shipping_email       :
                     order_info_package.shipping_email,
                  shipping_street      :
                     order_info_package.shipping_street,
                  shipping_city        :
                     order_info_package.shipping_city,
                  shipping_state       :
                     order_info_package.shipping_state,
                  shipping_zip         :
                     order_info_package.shipping_zip,
                  shipping_method_name :
                     order_info_package.shipping_method_name,
                  total_price          :
                     order_info_package.amount,
                  stripe_charge_id     : charge.id
               });
               order.save();
               
               transaction_info.order_id= order._id;
            }
            
<strong>            // 4. send transaction result to customer's device </strong>
            response.send(transaction_info);
         }
      );
   }
   next();
});</pre></div><p>This middleware<a id="id171" class="indexterm"/> is divided into four steps:</p><div><ol class="orderedlist arabic"><li class="listitem">Parse the request's JSON content.</li><li class="listitem">Charge the card using the API provided by the payment gateway; in this case, the <code class="literal">charge</code> function is provided in the <code class="literal">Stripe JavaScript</code> module.</li><li class="listitem">If the transaction is approved, create the order and update the quantity on hand of the ordered product.</li><li class="listitem">Send the transaction result (including the order number if the payment was approved) to the user's device.</li></ol></div></div>
<div><div><div><div><h1 class="title"><a id="ch04lvl1sec30"/>The postprocess phase</h1></div></div></div><p>In the <em>Postprocess</em> phase of the payment processing workflow, the app analyzes the response the order<a id="id172" class="indexterm"/> processing web app gave to the HTTP request that the app made in the <em>Preprocess</em> phase. In general terms, the response indicates whether the issuing bank approved or declined the payment. The response may also include an order number, order status, and other details that you deem useful for the user; the app may display a custom confirmation sheet containing this information. Finally, the app dismisses the payment sheet.</p><p>The following three sections describe the steps of the <em>Postprocess</em> phase.</p><div><div><div><div><h2 class="title"><a id="ch04lvl2sec26"/>The merchant app receives the transaction status from the order processing web app</h2></div></div></div><p>The example user app<a id="id173" class="indexterm"/> receives the response from the order processing web app in a block in the <code class="literal">backend_process_payment_info:gateway:charge_token:completion:</code> method. The block's arguments are an <code class="literal">NSURLResponse</code> object and an <code class="literal">NSData</code> object. The code that processes the<a id="id174" class="indexterm"/> response and returned data is highlighted here:</p><div><pre class="programlisting">// client_app/merchantapp/ProductCard.m
- (void)
backend_process_payment_info:
   (PKPayment*)                                  payment_info
gateway:
   (NSString*)                                   gateway
charge_token:
   (id)                                          charge_token
completion:
   (void (^)(PKPaymentAuthorizationStatus))      payment_completion
{
   RestIO* rest_io= [RestIO sharedRestIO];
   {
      ...      
      // send order information to order processing web app
      [rest_io postResourceAtURI: payment_charge_uri
                            body: order_info_package_json
                      completion: ^
<strong>      (NSURLResponse* response, NSData* data)</strong>
<strong>      {</strong>
<strong>         if (((NSHTTPURLResponse*)response).statusCode == 200)</strong>
<strong>         {</strong>
<strong>            NSDictionary* result;</strong>
<strong>            {</strong>
<strong>               NSError* error;</strong>
<strong>               result=</strong>
<strong>                  [NSJSONSerialization</strong>
<strong>                     JSONObjectWithData: data</strong>
<strong>                                options: 0</strong>
<strong>                                  error: &amp;error];</strong>
               if (error)
                  [NSException
                      raise: @"JSONDeserializationException"
                     format: @"error deserializing JSON"];
            }
            NSString* status= (NSString*)result[@"status"];
            payment_completion(
               [status isEqual: @"succeeded"]?
                  PKPaymentAuthorizationStatusSuccess :
                  PKPaymentAuthorizationStatusFailure
            );
         }
         else
            payment_completion(
               PKPaymentAuthorizationStatusFailure);
      }];
   }
}</pre></div><p>If the HTTP<a id="id175" class="indexterm"/> response code is <code class="literal">200</code>, there<a id="id176" class="indexterm"/> were no server-side problems generating the response. In this case, the method transforms the JSON that makes up the returned content into an <code class="literal">NSDictionary</code> object (<code class="literal">result</code>), which contains several entries describing the transaction (refer to the <em>Process</em> Phase section for details). The method focuses on one entry in particular: the <code class="literal">"status"</code> key.</p></div><div><div><div><div><h2 class="title"><a id="ch04lvl2sec27"/>The merchant app conveys the transaction status to the user</h2></div></div></div><p>After the example<a id="id177" class="indexterm"/> merchant app receives the response from the order processing web app (as a JSON object in the HTTP response payload), it determines whether the transaction was approved or declined by examining the returned <a id="id178" class="indexterm"/>data. Then, it calls the <code class="literal">payment_completion</code> block to inform the payment sheet of the transaction status so that the sheet can convey this information to the user. The highlighted code in this listing performs this process:</p><div><pre class="programlisting">// client_app/merchantapp/ProductCard.m
- (void)
backend_process_payment_info:
   (PKPayment*)                                  payment_info
gateway:
   (NSString*)                                   gateway
charge_token:
   (id)                                          charge_token
completion:
   (void (^)(PKPaymentAuthorizationStatus))      payment_completion
{
   RestIO* rest_io= [RestIO sharedRestIO];
   {
      ...      
      // send order information to order processing web app
      [rest_io postResourceAtURI: payment_charge_uri
                            body: order_info_package_json
                      completion: ^
      (NSURLResponse* response, NSData* data)
      {
         if (((NSHTTPURLResponse*)response).statusCode == 200)
         {
            NSDictionary* result;
            {
               NSError* error;
               result=
                  [NSJSONSerialization
                     JSONObjectWithData: data
                                options: 0
                                  error: &amp;error];
               if (error)
                  [NSException
                      raise: @"JSONDeserializationException"
                     format: @"error deserializing JSON"];
            }
<strong>            NSString* status= (NSString*)result[@"status"];</strong>
<strong>            payment_completion(</strong>
<strong>               [status isEqual: @"succeeded"]?</strong>
<strong>                  PKPaymentAuthorizationStatusSuccess :</strong>
<strong>                  PKPaymentAuthorizationStatusFailure</strong>
<strong>            );</strong>
<strong>         }</strong>
<strong>         else</strong>
<strong>            payment_completion(</strong>
<strong>               PKPaymentAuthorizationStatusFailure);</strong>
      }];
   }
}</pre></div><p>If the value for the <code class="literal">"status"</code> key in the returned data is <code class="literal">"succeeded"</code>, it means that the payment was<a id="id179" class="indexterm"/> approved by the issuing bank, and the funds will be available in the acquiring bank sometime in the near future. In this case, the method calls the completion block the payment sheet provided (<code class="literal">payment_completion</code>) to indicate that the payment was approved with <code class="literal">PKPaymentAuthorizationStatusSuccess</code> as the argument. If the HTTP response <a id="id180" class="indexterm"/>code is not <code class="literal">200</code> or the value for the <code class="literal">"status"</code> key in the returned data is not <code class="literal">"succeeded"</code>, the method calls the completion block with <code class="literal">PKPaymentAuthorizationStatusFailure</code> as the argument.</p><p>Calling the <code class="literal">payment_completion</code> block with <code class="literal">PKPaymentAuthorizationStatusSuccess</code> results in the payment sheet displaying a checkmark, indicating that the payment was approved, as shown in the following screenshot:</p><div><img src="img/B05093_04_02.png.jpg" alt="The merchant app conveys the transaction status to the user"/></div><p>You can display an additional sheet providing more information about the transaction, such as the order<a id="id181" class="indexterm"/> number <a id="id182" class="indexterm"/>and estimated delivery date.</p></div><div><div><div><div><h2 class="title"><a id="ch04lvl2sec28"/>The merchant app dismisses the payment sheet</h2></div></div></div><p>When the payment<a id="id183" class="indexterm"/> sheet is done (either because the transaction was approved or declined, or because the user canceled the transaction), it calls the <code class="literal">paymentAuthorizationViewControllerDidFinish:</code> delegate method. Here, you can perform any necessary cleanup or app-state updates.</p><p>This is how the example<a id="id184" class="indexterm"/> merchant app implements the delegate method:</p><div><pre class="programlisting">// client_app/merchantapp/ProductCard.m
- (void) paymentAuthorizationViewControllerDidFinish:
            (PKPaymentAuthorizationViewController*)
                                                 controller
{
   [self dismissViewControllerAnimated:YES completion:nil];
}</pre></div></div></div>
<div><div><div><div><h1 class="title"><a id="ch04lvl1sec31"/>Summary</h1></div></div></div><p>In this chapter, you have learned how Apple Pay payments are processed. The chapter has described each of the phases of the payment processing workflow, identifying the steps that make up each phase. The <em>Processing phase</em>, in particular, is where all the components are linked to securely charge the user's card and make the funds available in your acquiring bank.</p><p>The chapter has based its explanations on the example project that accompanies this book. This project will be described in the next chapter.</p></div></body></html>