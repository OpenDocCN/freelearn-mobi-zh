<html><head></head><body><div class="chapter" title="Chapter&#xA0;2.&#xA0;Controlling an Arduino Board via Bluetooth"><div class="titlepage"><div><div><h1 class="title"><a id="ch02"/>Chapter 2. Controlling an Arduino Board via Bluetooth</h1></div></div></div><p>This second <a id="id79" class="indexterm"/>chapter of the book will be about putting things together and writing our first app to control an Arduino board via<a id="id80" class="indexterm"/> <span class="strong"><strong>Bluetooth Low Energy</strong></span> (<span class="strong"><strong>BLE</strong></span>). We chose to use BLE for all the Bluetooth projects of this book as it is the latest standard for Bluetooth communication at the time of publication. Compared to previous Bluetooth modules, BLE modules have low energy consumption as the standard works in bursts rather than maintaining a persistent connection. In addition, BLE offers low latency and has a comparable range to the older Bluetooth standards.</p><p>We will connect a BLE module to Arduino as well as an LED that we will control via an Android app. Then, we will write an Arduino sketch that uses the aREST library so that we can receive commands via Bluetooth coming from a smartphone or tablet.</p><p>The Android app will also be able to control the board remotely and we will have the opportunity to enhance the user experience by learning how to include buttons to switch the LED on and off.</p><p>The following will be the main takeaways from this chapter:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">Connecting a BLE module to an Arduino board</li><li class="listitem" style="list-style-type: disc">Writing an Arduino sketch to enable Bluetooth communications on the Arduino board</li><li class="listitem" style="list-style-type: disc">Writing an Android application to send commands to the Arduino board via Bluetooth</li></ul></div><div class="section" title="Hardware and software requirements"><div class="titlepage"><div><div><h1 class="title"><a id="ch02lvl1sec16"/>Hardware and software requirements</h1></div></div></div><p>The first <a id="id81" class="indexterm"/>thing you will need for this project <a id="id82" class="indexterm"/>is an Arduino Uno board.</p><p>Then, you will need a BLE module. We chose the Adafruit nRF8001 chip because it comes with a nice Arduino library, and it already has existing examples of Android apps to control the module.</p><p>The following is a close-up picture of the module we used for this project:</p><div class="mediaobject"><img src="graphics/0389OS_02_01.jpg" alt="Hardware and software requirements"/></div><p>You will also need one LED of the color of your choice, and a 330 Ohm resistor. Finally, to make the different electrical connections, you will also need a breadboard and some jumper wires.</p><p>The following is the list of all hardware parts you will need for this project, along with links to find these parts on the Web:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">The<a id="id83" class="indexterm"/> Arduino Uno board (<a class="ulink" href="http://www.adafruit.com/product/50">http://www.adafruit.com/product/50</a>)</li><li class="listitem" style="list-style-type: disc">LEDs <a id="id84" class="indexterm"/>(<a class="ulink" href="https://www.sparkfun.com/products/9590">https://www.sparkfun.com/products/9590</a>)</li><li class="listitem" style="list-style-type: disc">The<a id="id85" class="indexterm"/> 330 Ohm resistor (<a class="ulink" href="https://www.sparkfun.com/products/8377">https://www.sparkfun.com/products/8377</a>)</li><li class="listitem" style="list-style-type: disc">The <a id="id86" class="indexterm"/>Adafruit nRF8001 breakout board (<a class="ulink" href="https://www.adafruit.com/products/1697">https://www.adafruit.com/products/1697</a>)</li><li class="listitem" style="list-style-type: disc">The<a id="id87" class="indexterm"/> breadboard (<a class="ulink" href="https://www.adafruit.com/product/64">https://www.adafruit.com/product/64</a>)</li><li class="listitem" style="list-style-type: disc">Jumper <a id="id88" class="indexterm"/>wires (<a class="ulink" href="https://www.adafruit.com/product/758">https://www.adafruit.com/product/758</a>)</li></ul></div><p>On the software side, you will need the following:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">The <a id="id89" class="indexterm"/>Arduino IDE (<a class="ulink" href="http://arduino.cc/en/Main/Software">http://arduino.cc/en/Main/Software</a>)</li><li class="listitem" style="list-style-type: disc">The <a id="id90" class="indexterm"/>Arduino aREST library (<a class="ulink" href="https://github.com/marcoschwartz/aREST/">https://github.com/marcoschwartz/aREST/</a>)</li><li class="listitem" style="list-style-type: disc">The <a id="id91" class="indexterm"/>nRF8001 Arduino library for the BLE chip (<a class="ulink" href="https://github.com/adafruit/Adafruit_nRF8001">https://github.com/adafruit/Adafruit_nRF8001</a>)</li></ul></div><p>To install a <a id="id92" class="indexterm"/>given library, simply <a id="id93" class="indexterm"/>extract the folder in your <code class="literal">Arduino /libraries</code> folder (or create this folder if it doesn't exist yet). To find your <code class="literal">Arduino</code> folder or define a new one, you can go to the <span class="strong"><strong>Preferences</strong></span> option of the Arduino IDE.</p><div class="section" title="Configuring the hardware"><div class="titlepage"><div><div><h2 class="title"><a id="ch02lvl2sec15"/>Configuring the hardware</h2></div></div></div><p>We will<a id="id94" class="indexterm"/> now build the hardware part of the project. To help you out, the following is a schematic of the project:</p><div class="mediaobject"><img src="graphics/0389OS_02_02.jpg" alt="Configuring the hardware"/></div><p>Now, we will perform the following steps:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">The first step is to place the Bluetooth module and the LED on the breadboard.</li><li class="listitem">Then, connect the power supply from the Arduino board to the breadboard: 5V of the Arduino board goes to the red power rail, and <span class="strong"><strong>GND</strong></span> goes to the blue power rail.</li><li class="listitem">We will <a id="id95" class="indexterm"/>now connect the BLE module. First, connect the power supply of the module: <span class="strong"><strong>GND</strong></span> goes to the blue power rail, and <span class="strong"><strong>VIN</strong></span> goes to the red power rail.</li><li class="listitem">After this, you need to connect the different wires responsible for the<a id="id96" class="indexterm"/> <span class="strong"><strong>Serial Peripheral Interface</strong></span> (<span class="strong"><strong>SPI</strong></span>) communications: <span class="strong"><strong>SCK</strong></span> to Arduino pin <span class="strong"><strong>13</strong></span>, <span class="strong"><strong>MISO</strong></span> to Arduino pin <span class="strong"><strong>12</strong></span>, and <span class="strong"><strong>MOSI</strong></span> to Arduino pin <span class="strong"><strong>11</strong></span>.</li><li class="listitem">Then, connect the <span class="strong"><strong>REQ</strong></span> pin to Arduino pin <span class="strong"><strong>10</strong></span>. Finally, connect the <span class="strong"><strong>RDY</strong></span> pin to Arduino pin <span class="strong"><strong>2</strong></span>, and the <span class="strong"><strong>RST</strong></span> pin to Arduino pin <span class="strong"><strong>9</strong></span>.</li><li class="listitem">For the LED, simply place the resistor on the breadboard so it is in series with the LED, connected to the anode of the LED, which is the longest pin of the LED.</li><li class="listitem">Then, connect the other side of the resistor to Arduino pin <span class="strong"><strong>7</strong></span>.</li><li class="listitem">Finally, connect the other pin of the LED (the cathode) to the blue power rail, that is to the ground.</li></ol></div><p>This is an image of the completely assembled project:</p><div class="mediaobject"><img src="graphics/0389OS_02_03.jpg" alt="Configuring the hardware"/></div></div></div></div>
<div class="section" title="Writing the Arduino sketch"><div class="titlepage"><div><div><h1 class="title"><a id="ch02lvl1sec17"/>Writing the Arduino sketch</h1></div></div></div><p>We will now <a id="id97" class="indexterm"/>write the Arduino sketch <a id="id98" class="indexterm"/>so that the Arduino board can talk with the BLE module and receive commands from Android via Bluetooth. Here is the complete sketch for this part:</p><div class="informalexample"><pre class="programlisting">#define LIGHTWEIGHT 1

#include &lt;SPI.h&gt;
#include "Adafruit_BLE_UART.h"
#include &lt;aREST.h&gt;

// Pins
#define ADAFRUITBLE_REQ 10
#define ADAFRUITBLE_RDY 2     // This should be an interrupt pin, //  on Uno thats #2 or #3
#define ADAFRUITBLE_RST 9

// Create aREST instance
aREST rest = aREST();

// BLE instance
Adafruit_BLE_UART BTLEserial = Adafruit_BLE_UART(ADAFRUITBLE_REQ, ADAFRUITBLE_RDY, ADAFRUITBLE_RST);

void setup(void)
{  
  // Start Serial
  Serial.begin(9600);
  Serial.println(F("Adafruit Bluefruit Low Energy nRF8001 Print echo demo"));

  // Start BLE
  BTLEserial.begin();
 
  // Give name and ID to device
  rest.set_id("001");
  rest.set_name("my_arduino"); 
}

aci_evt_opcode_t laststatus = ACI_EVT_DISCONNECTED;

void loop() {  
  
  // Tell the nRF8001 to do whatever it should be working on.
  BTLEserial.pollACI();
  
  // Ask what is our current status
  aci_evt_opcode_t status = BTLEserial.getState();
  // If the status changed....
  if (status != laststatus) {
    // print it out!
    if (status == ACI_EVT_DEVICE_STARTED) {
        Serial.println(F("* Advertising started"));
    }
    if (status == ACI_EVT_CONNECTED) {
        Serial.println(F("* Connected!"));
    }
    if (status == ACI_EVT_DISCONNECTED) {
        Serial.println(F("* Disconnected or advertising timed out"));
    }
    // OK set the last status change to this one
    laststatus = status;
  }
  
  // Handle REST calls
  if (status == ACI_EVT_CONNECTED) {
    rest.handle(BTLEserial);
  }
}</pre></div><p>Now, let's see <a id="id99" class="indexterm"/>the details of this sketch. It <a id="id100" class="indexterm"/>starts by importing the required libraries for the nRF8001 BLE module and the aREST library:</p><div class="informalexample"><pre class="programlisting">#include &lt;SPI.h&gt;
#include "Adafruit_BLE_UART.h"
#include &lt;aREST.h&gt;</pre></div><p>We will also specify an option for the aREST library, called <code class="literal">LIGHTWEIGHT</code>. This means that the Arduino board will only return a limited amount of data back to the Android phone. It will return the value of a variable when we read from the board, and no data at all when we send a command to the board. This is required when using BLE communications. This is done with the following piece of code:</p><div class="informalexample"><pre class="programlisting">#define LIGHTWEIGHT 1</pre></div><p>Then, we will define which pin the BLE module is connected to:</p><div class="informalexample"><pre class="programlisting">#define ADAFRUITBLE_REQ 10
#define ADAFRUITBLE_RDY 2     // This should be an interrupt pin, on Uno thats #2 or #3
#define ADAFRUITBLE_RST 9</pre></div><p>Note that we don't <a id="id101" class="indexterm"/>define the pins for the SPI pins of the BLE module, as they are already defined in the module's library.</p><p>After this, we <a id="id102" class="indexterm"/>can create an instance of the aREST API that will be used to handle the requests coming via Bluetooth:</p><div class="informalexample"><pre class="programlisting">aREST rest = aREST();</pre></div><p>We also need to create an instance for the BLE module, with the pins we defined earlier:</p><div class="informalexample"><pre class="programlisting">Adafruit_BLE_UART BTLEserial = Adafruit_BLE_UART(ADAFRUITBLE_REQ, ADAFRUITBLE_RDY, ADAFRUITBLE_RST);</pre></div><p>Now, in the <code class="literal">setup()</code> function of the sketch, we will start the serial communications, and print a welcome message:</p><div class="informalexample"><pre class="programlisting">Serial.begin(9600);
Serial.println(F("Adafruit Bluefruit Low Energy nRF8001 Print echo demo"));</pre></div><p>Note that the welcome message is printed using the <code class="literal">F()</code> function around the message, which puts the string variable directly into the Arduino program memory. This is done to save some dynamic memory (RAM) for this sketch.</p><p>We will also initialize the BLE module:</p><div class="informalexample"><pre class="programlisting"> BTLEserial.begin();</pre></div><p>Finally, we will give an ID and a name to our board:</p><div class="informalexample"><pre class="programlisting">rest.set_id("001");
rest.set_name("my_arduino"); </pre></div><p>In the <code class="literal">loop()</code> function of the sketch, we will check the status of the BLE module:</p><div class="informalexample"><pre class="programlisting">BTLEserial.pollACI();</pre></div><p>After this, we will get this status and store it in a variable:</p><div class="informalexample"><pre class="programlisting">aci_evt_opcode_t status = BTLEserial.getState();</pre></div><p>If there is some device connected to our BLE module, we will then handle the incoming request using the aREST library:</p><div class="informalexample"><pre class="programlisting">if (status == ACI_EVT_CONNECTED) {
    rest.handle(BTLEserial);
  }</pre></div><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="note03"/>Note</h3><p>Note that all<a id="id103" class="indexterm"/> the code for this chapter can be found inside the GitHub repository of the book at <a class="ulink" href="https://github.com/marcoschwartz/arduino-android-blueprints">https://github.com/marcoschwartz/arduino-android-blueprints</a>.</p></div></div><p>It's now time to upload<a id="id104" class="indexterm"/> the sketch to your Arduino board. When this is done, you can move on to the development of the Android app to control the Arduino board via the BLE sketch.</p><div class="section" title="How to create a simple Android app to connect to the BLE module"><div class="titlepage"><div><div><h2 class="title"><a id="ch02lvl2sec16"/>How to create a simple Android app to connect to the BLE module</h2></div></div></div><p>Connecting<a id="id105" class="indexterm"/> the Adafruit BLE module will give us the opportunity to:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">Learn how to work with existing open source projects</li><li class="listitem" style="list-style-type: disc">Analyze Java and understand how the <code class="literal">Main</code> activity connects to the layout files</li><li class="listitem" style="list-style-type: disc">Modify the code to light up an LED via Bluetooth and get it to work</li></ul></div><p>For this project, we <a id="id106" class="indexterm"/>will be using an open source project that works perfectly with our Adafruit Bluetooth module and is optimized for the Android Studio IDE. Throughout this chapter, we will also have the opportunity to explain what the different parts of the code are for.</p><p>To make the project work successfully, you need to make sure that you have installed the necessary SDKs outlined in <a class="link" href="ch01.html" title="Chapter 1. Setting Up Your Workspace">Chapter 1</a>, <span class="emphasis"><em>Setting Up Your Workspace</em></span>. The SDK is available via SDK Manager, which is accessible by going to <span class="strong"><strong>Tools</strong></span> &gt; <span class="strong"><strong>Android</strong></span> &gt; <span class="strong"><strong>SDK Manager</strong></span>.</p><p>The first step is to go to Tony Dicola's GitHub public repository<a id="id107" class="indexterm"/>, at <a class="ulink" href="https://github.com/tdicola/BTLETest">https://github.com/tdicola/BTLETest</a>, as shown in the following screenshot:</p><div class="mediaobject"><img src="graphics/0389OS_02_04.jpg" alt="How to create a simple Android app to connect to the BLE module"/></div><p>At this point, you can either opt to <span class="strong"><strong>Clone in Desktop</strong></span> using the GitHub desktop application or download the ZIP file and extract the file to your desktop, as shown in the following screenshot:</p><div class="mediaobject"><img src="graphics/0389OS_02_05.jpg" alt="How to create a simple Android app to connect to the BLE module"/></div><p>Double-click on <a id="id108" class="indexterm"/>the extracted file (Windows and Mac).</p><p>Open Android Studio, then click on <span class="strong"><strong>Import Project</strong></span> and <span class="strong"><strong>Choose Extracted Folder</strong></span>, as shown here:</p><div class="mediaobject"><img src="graphics/0389OS_02_06.jpg" alt="How to create a simple Android app to connect to the BLE module"/></div><p>To aid you in <a id="id109" class="indexterm"/>the selection process, you will be able to see a small Android logo next to the folder you need to choose, as shown in the following screenshot:</p><div class="mediaobject"><img src="graphics/0389OS_02_07.jpg" alt="How to create a simple Android app to connect to the BLE module"/></div><p>After successfully importing the project, you might need to modify the Gradle settings file so that it <a id="id110" class="indexterm"/>compiles correctly and is successfully built. The Gradle settings file acts as a preferences manager for our Android project and allows us to manage what libraries we would like to include for our project.</p><p>You can modify the Gradle settings file by accessing the project tree and clicking on <span class="strong"><strong>app &gt; src</strong></span> followed by <span class="strong"><strong>build.gradle</strong></span>, as shown in the following screenshot :</p><div class="mediaobject"><img src="graphics/0389OS_02_08.jpg" alt="How to create a simple Android app to connect to the BLE module"/></div><p>Our recommendation<a id="id111" class="indexterm"/> is to alter <code class="literal">buildToolsVersion</code> to <code class="literal">19.1.0</code>. Do not be confused by <span class="strong"><strong>app</strong></span> showing up in the tabs. The correct settings can be seen as follows:</p><div class="mediaobject"><img src="graphics/0389OS_02_09.jpg" alt="How to create a simple Android app to connect to the BLE module"/></div><p>Once you modify the settings in the Gradle <span class="strong"><strong>Settings</strong></span> option, you will be asked to sync your project settings, and you will be able to do that by clicking on <span class="strong"><strong>Sync Now</strong></span>. Once the Gradle settings <a id="id112" class="indexterm"/>file is set up, you can go ahead and test the app on your physical Android device that supports BLE (the device should be running Android 4.3 or higher). Run the app by going to the toolbar, clicking on <span class="strong"><strong>Run</strong></span>, and selecting <span class="strong"><strong>Run app</strong></span>, followed by choosing the right physical device, as shown in the following screenshot:</p><div class="mediaobject"><img src="graphics/0389OS_02_10.jpg" alt="How to create a simple Android app to connect to the BLE module"/></div><p>You can send out the following messages to the Bluetooth module by tapping on the <span class="strong"><strong>Text Field</strong></span> and then tapping on <span class="strong"><strong>Send</strong></span>:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">/mode/7/o /</li><li class="listitem" style="list-style-type: disc">/digital/7/1 /</li><li class="listitem" style="list-style-type: disc">/digital/7/0 /</li></ul></div><p>When you <a id="id113" class="indexterm"/>see that the preceding messages respond with the right responses via the LED, which will switch on and switch off if you follow the previous order, we will then proceed to modifying the layout file.</p></div><div class="section" title="Modifying the Android layout file"><div class="titlepage"><div><div><h2 class="title"><a id="ch02lvl2sec17"/>Modifying the Android layout file</h2></div></div></div><p>Modification <a id="id114" class="indexterm"/>of the Android layout file will simplify the user experience and allow us to switch the LED on and off with the tap of a button. In the Android layout file, we will add buttons for the following:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">Activating the pin to accept inputs</li><li class="listitem" style="list-style-type: disc">Switch on LED</li><li class="listitem" style="list-style-type: disc">Switch off LED</li></ul></div><p>Go to the project tree, as shown in the following screenshot and follow this path: <code class="literal">app</code> &gt; <code class="literal">src</code> &gt; <code class="literal">res</code> &gt; <code class="literal">layout</code> &gt; <code class="literal">activity_main.xml</code>. Double-click on the <code class="literal">activity_main.xml</code> file.</p><div class="mediaobject"><img src="graphics/0389OS_02_11.jpg" alt="Modifying the Android layout file"/></div><p>The Android layout files are managed either via the design view or via the text view, where the dimensions and properties are set using the XML format. In this particular case, we will stick to modifying the layout using the design view, as shown in the following screenshot:</p><div class="mediaobject"><img src="graphics/0389OS_02_12.jpg" alt="Modifying the Android layout file"/></div><p>Within the <a id="id115" class="indexterm"/>design view, there is a palette with defined user-interface elements that the developer can use to drag-and-drop into the design view and create customized layouts. To follow proper design-develop-distribute methodology, we will start off by creating a paper prototype of how we would like the app to look and work out, as shown in the following screenshot. At this point of time, our paper prototypes will be neither sophisticated nor adherent to design principles, but we would like to help you get used to the process to enable you to design high-quality apps.</p><div class="mediaobject"><img src="graphics/0389OS_02_13.jpg" alt="Modifying the Android layout file"/></div><p>Having this paper <a id="id116" class="indexterm"/>prototype as our guide, we can then start modifying the design. We will start off by resizing the <span class="strong"><strong>Scroll View</strong></span> area, which shows the response that the Android physical device receives when connecting with the BLE module. This will allow us to visualize how we would like to design the layout.</p><p>Adding buttons to the interface is as easy as dragging and dropping buttons from the <span class="strong"><strong>Palette</strong></span> option to the user interface. The <span class="strong"><strong>Palette</strong></span> option is available on the left-hand side of the design view. In this case, we will add the following three buttons:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">Set output</li><li class="listitem" style="list-style-type: disc">Switch on</li><li class="listitem" style="list-style-type: disc">Switch off</li></ul></div><p>If you double-click on the button that you've included in the interface, you will be able to change the text and ID. Standard Java naming conventions recommend the use of the camel-case naming convention; thus, you should identify them as follows:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">The <span class="strong"><strong>Set Output</strong></span> button<div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>Text</strong></span>: <code class="literal">Set Output</code></li><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>ID</strong></span>: <code class="literal">setOutputBtn</code></li></ul></div></li><li class="listitem" style="list-style-type: disc">The <span class="strong"><strong>Switch On</strong></span> button<div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>Text</strong></span>: <code class="literal">Switch On LED</code></li><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>ID</strong></span>: <code class="literal">switchOnBtn</code></li></ul></div></li><li class="listitem" style="list-style-type: disc">The <span class="strong"><strong>Set Output</strong></span> button<div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>Text</strong></span>: <code class="literal">Switch Off LED</code></li><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>ID</strong></span>: <code class="literal">switchOffBtn</code></li></ul></div></li></ul></div><p>With the layout <a id="id117" class="indexterm"/>setup, we can proceed to connecting the layout to our main activity code.</p></div><div class="section" title="Connecting the modified layout to the corresponding activity"><div class="titlepage"><div><div><h2 class="title"><a id="ch02lvl2sec18"/>Connecting the modified layout to the corresponding activity</h2></div></div></div><p>From the<a id="id118" class="indexterm"/> project tree, follow the path: <code class="literal">app</code> &gt; <code class="literal">src</code> &gt; <code class="literal">main</code> &gt; <code class="literal">java</code> &gt; <code class="literal">com.tonydicola.bletest.app</code> &gt; <code class="literal">MainActivity</code>, as shown in the following screenshot:</p><div class="mediaobject"><img src="graphics/0389OS_02_14.jpg" alt="Connecting the modified layout to the corresponding activity"/></div><p>Double-click on <code class="literal">MainActivity.java</code>. The screen for <code class="literal">MainActivity.java</code> will look as follows. In the <a id="id119" class="indexterm"/>following paragraphs, we will have an opportunity to go through the code and understand what role it plays within the app. There are a number of comments within the code (statements starting with <code class="literal">//////</code>) that will further explain the role of those lines of code.</p><div class="mediaobject"><img src="graphics/0389OS_02_15.jpg" alt="Connecting the modified layout to the corresponding activity"/></div><p>If we quickly <a id="id120" class="indexterm"/>analyze the code, we can see the following structure:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">The package name.</li><li class="listitem" style="list-style-type: disc">An import statement.</li><li class="listitem" style="list-style-type: disc">Declaration of private and public variables (which can be used throughout the whole activity).</li><li class="listitem" style="list-style-type: disc"><code class="literal">BluetoothGattCallback</code>: This<a id="id121" class="indexterm"/> is the method that deals with the callback and where much of the logic takes place.</li><li class="listitem" style="list-style-type: disc"><code class="literal">onServicesDiscovered</code>: This <a id="id122" class="indexterm"/>is the method that deals with Bluetooth service discovery.</li><li class="listitem" style="list-style-type: disc"><code class="literal">onCharacteristicChanged</code>: This<a id="id123" class="indexterm"/> is the method that takes care of any change in characteristics.</li><li class="listitem" style="list-style-type: disc"><code class="literal">onCreate</code>: This is the method <a id="id124" class="indexterm"/>that deals with the main layout and how it functions. The <code class="literal">onCreate</code> method is called when the activity is first shown, and plays a very important role in the Android app life cycle. Most of the code in this section will relate to the Android layout.</li><li class="listitem" style="list-style-type: disc"><code class="literal">onResume</code> and <code class="literal">onStop</code>: These <a id="id125" class="indexterm"/>are the methods that form a<a id="id126" class="indexterm"/> part of the Android app life cycle and determine how the app will react at different points.</li><li class="listitem" style="list-style-type: disc"><code class="literal">sendClick</code>: This <a id="id127" class="indexterm"/>is the method that deals with what processes will be run when the <span class="strong"><strong>Send</strong></span> button is clicked.</li><li class="listitem" style="list-style-type: disc"><code class="literal">parseIDs</code>: This is<a id="id128" class="indexterm"/> the method that will return the Bluetooth module's ID in string format.</li><li class="listitem" style="list-style-type: disc"><code class="literal">Boilerplate</code>: This <a id="id129" class="indexterm"/>is the code that is available within the primary template when creating this project, but it is not necessarily relevant for it.</li></ul></div><p>Understanding<a id="id130" class="indexterm"/> the code will help us to make the right modifications; we will start by declaring the UI elements as private variables by adding the following code:</p><div class="informalexample"><pre class="programlisting">private Button setoutput;
private Button switchon;
private Button switchoff;</pre></div><p>We then proceed to the <a id="id131" class="indexterm"/>
<code class="literal">onCreate</code> method, where we will add the code that will recognize the actual buttons within the layout and where we will also add the <code class="literal">onClickListener</code> method to each button, which allows the Android app to listen to any of the users' interactions with the button and act accordingly.</p><p>First, we will start off by grabbing references to the UI elements by adding the following code:</p><div class="informalexample"><pre class="programlisting">setoutput = (Button) findViewById(R.id.setToOutputBtn);
switchon = (Button) findViewById(R.id.switchOnBtn);
switchoff = (Button) findViewById(R.id.switchOffBtn);</pre></div><p>Just after these references to the UI elements, we will add some more code, which will allow us to send the right messages to the BLE module and to switch on and switch off the light:</p><div class="informalexample"><pre class="programlisting">setoutput.setOnClickListener(new View.OnClickListener() {
            public void onClick(View v) {
                String setOutputMessage = "/mode/7/o /";
                tx.setValue(setOutputMessage.getBytes(Charset.forName("UTF-8")));
                if (gatt.writeCharacteristic(tx)) {
                    writeLine("Sent: " + setOutputMessage);
                }
                else {
                    writeLine("Couldn't write TX characteristic!");
                }

            }
        });

        switchon.setOnClickListener(new View.OnClickListener() {
            public void onClick(View v) {
                String switchOnMessage = "/digital/7/1 /";
                tx.setValue(switchOnMessage.getBytes(Charset.forName("UTF-8")));
                if (gatt.writeCharacteristic(tx)) {
                    writeLine("Sent: " + switchOnMessage);
                }
                else {
                    writeLine("Couldn't write TX characteristic!");
                }
            }
        });

        switchoff.setOnClickListener(new View.OnClickListener() {
            public void onClick(View v) {
                String switchOffMessage = "/digital/7/0 /";
                tx.setValue(switchOffMessage.getBytes(Charset.forName("UTF-8")));
                if (gatt.writeCharacteristic(tx)) {
                    writeLine("Sent: " + switchOffMessage);
                }
                else {
                    writeLine("Couldn't write TX characteristic!");
                }
            }
        });</pre></div><p>With the preceding methods<a id="id132" class="indexterm"/> implemented, we should now be able to build the app and test it on our physical device. The final result should look as follows:</p><div class="mediaobject"><img src="graphics/0389OS_02_16.jpg" alt="Connecting the modified layout to the corresponding activity"/></div><p>You should now<a id="id133" class="indexterm"/> successfully be able to switch on and switch off the light from the Android app.</p></div><div class="section" title="How to go further"><div class="titlepage"><div><div><h2 class="title"><a id="ch02lvl2sec19"/>How to go further</h2></div></div></div><p>There are <a id="id134" class="indexterm"/>several things you can do to go further with what you learned in this chapter. You can use what you learned to control more than just a simple LED. For example, you can connect the relay module we used in the first chapter and control it via Bluetooth. This already allows you to control much bigger devices, such as lamps, all via your Android phone. Of course, such projects require that you take safety precautions, which will be detailed in the chapter where we will build such an application.</p><p>You can also work on improving the Android application by improving the user interface and learning how to further modify the Android layout files with better-looking buttons, customized app icons, and general improvements to the user experience. As we go on in this book, we will have further opportunities to build on this code and enable more functions and capabilities.</p></div></div>
<div class="section" title="Summary"><div class="titlepage"><div><div><h1 class="title"><a id="ch02lvl1sec18"/>Summary</h1></div></div></div><p>Let's summarize what we learned in this chapter. We connected a BLE module to Arduino as well as a simple red LED that we controlled remotely. After this, we wrote a sketch that enabled the Arduino board to receive commands via the Bluetooth module.</p><p>On the Android side, we took the opportunity to take an existing project, analyze it, modify it, and run the final application on our physical Android device.</p><p>In the next chapter, we will build a wireless weather station using what we just learnt in this chapter. We will connect several sensors to an Arduino board, and read data coming from these sensors using an Android app communicating with the Arduino board via Bluetooth.</p></div></body></html>