<html><head></head><body><div class="chapter" title="Chapter&#xA0;1.&#xA0;Downloading LevelDB and Building with OS X"><div class="titlepage"><div><div><h1 class="title"><a id="ch01"/>Chapter 1. Downloading LevelDB and Building with OS X</h1></div></div></div><p>This chapter takes you through downloading LevelDB and building it using the command-line techniques specific to building on OS X. It then shows how to set up an Xcode project for a simple OS X application, with iOS details in <a class="link" href="ch02.html" title="Chapter 2. Installing LevelDB and Building for iOS">Chapter 2</a>, <span class="emphasis"><em>Installing LevelDB and Building for iOS</em></span>.</p><p>The build error messages and how we deal with them will be useful for any Mac-based developers using open source projects. These often assume familiarity with the Unix development tools and installing idioms. We will start with a high level of detail to ease people in, who have only used Xcode or a similar IDE on other platforms. Later chapters will summarize the steps, so you may want to come back here for a refresher.</p><p>The instructions in this chapter will assume that you are using the terminal in OS X. The <code class="literal">$</code>
<span class="strong"><strong> </strong></span>that<span class="strong"><strong> </strong></span>we will use, as the terminal prompt, will vary according to your local terminal settings, usually showing the current working directory.</p><p>The examples in this chapter use a minimal amount of C++ (using the easier style of C++11). Complete log files of the installation steps and source code are available at the Packt Publishing website, and later chapters have much larger samples as complete apps.</p><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="tip02"/>Tip</h3><p>The instructions in this chapter are similar to generic Unix commands but you will probably find that commands, directory structures, and permissions vary slightly. Most Linux distributions have similar directory layouts but OS X has varied from generic Unix practice and even from OS X earlier standards.</p></div></div><div class="section" title="Installing LevelDB"><div class="titlepage"><div><div><h1 class="title"><a id="ch01lvl1sec08"/>Installing LevelDB</h1></div></div></div><p>People who want to <a id="id0" class="indexterm"/>actively work <a id="id1" class="indexterm"/>using the latest source can use Git<span class="strong"><strong> </strong></span>to clone the repository, starting with the instructions, at: <a class="ulink" href="https://code.google.com/p/leveldb/source/checkout">https://code.google.com/p/leveldb/source/checkout</a>. The project maintainers typically update the release archives after a small number of changes, so there is little incentive to work with the repository unless you plan to actively contribute. A Git clone based on the source code used in this book and oriented towards building for Apple is: <a class="ulink" href="https://code.google.com/r/dentaroo-appleflavouredleveldb/">https://code.google.com/r/dentaroo-appleflavouredleveldb/</a>.</p><p>To decide if you want to update <a id="id2" class="indexterm"/>your copy of LevelDB, you can check the changed history at <a class="ulink" href="https://code.google.com/p/leveldb/source/list">https://code.google.com/p/leveldb/source/list</a>. Most of the following screenshots and samples are from Version 1.10.1, released on May 14, 2013. Any reliance on later releases will be discussed. At least one patch to LevelDB was contributed as a direct result of this book, issue 177, building for iOS on later compilers.</p><p>LevelDB, other libraries, and our <a id="id3" class="indexterm"/>samples were compiled primarily with Xcode Version 4.6.3 and checked with the developer previews of Xcode 5 as they were made available.</p><p>The stable LevelDB <a id="id4" class="indexterm"/>releases are always available from the download page: <a class="ulink" href="https://code.google.com/p/leveldb/downloads/list">https://code.google.com/p/leveldb/downloads/list</a>.</p><p>Open that page and click on 1.10.1 which takes you to a specific page that allows you to click on the <code class="literal">.tar.gz</code> file and download it.</p><p>Using the standard Unix utility, <code class="literal">tar</code> <a id="id5" class="indexterm"/>will uncompress the <code class="literal">.gz</code> step and then <a id="id6" class="indexterm"/>unpack the <code class="literal">.tar</code> archive in one command. See <code class="literal">tar --help</code> if you want more information:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>$ tar xvf leveldb-1.10.0.tar.gz</strong></span>
<span class="strong"><strong>x leveldb-1.10.0/</strong></span>
<span class="strong"><strong>…</strong></span>
<span class="strong"><strong>x leveldb-1.10.0/util/coding.cc</strong></span>
</pre></div><p>Now the file is unpacked, change the directory into it:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>$ cd leveldb-1.10.0</strong></span>
<span class="strong"><strong>$ pwd</strong></span>
<span class="strong"><strong>/Users/andydent/dev/openSourceDev/leveldb-1.10.0</strong></span>
</pre></div><p>You can clean up the <code class="literal">.tar</code> file here as it is no longer needed, but I recommend archiving a copy of your <code class="literal">zip</code> file, for later comparison and reversion.</p><div class="section" title="Building the LevelDB libraries"><div class="titlepage"><div><div><h2 class="title"><a id="ch01lvl2sec06"/>Building the LevelDB libraries</h2></div></div></div><p>Unlike many open source <a id="id7" class="indexterm"/>projects, LevelDB doesn't come <a id="id8" class="indexterm"/>with a configure script. To build our first version of it, just type <code class="literal">make</code> at the command line (see <code class="literal">log of make.txt</code>). It is important to understand the <code class="literal">makefile</code> which is a plain text file you can open in any editor. At the top it has a commented section to allow you to set OPT to specify a debug or a production build (the default).</p><p>The targets are labels that appear at the left of the lines, ending in colons, for example, <code class="literal">db_bench</code>. Most makefiles have, at <a id="id9" class="indexterm"/>least, targets <code class="literal">all</code> and <code class="literal">clean</code>. The <code class="literal">clean</code> target removes all the previous build products so you guarantee a build with the changed settings. The LevelDB source comes with <a id="id10" class="indexterm"/>a range of tests, invoked by <code class="literal">make check</code> (see <code class="literal">log of make check.txt</code>). In the output of <code class="literal">make check</code>, you will see:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>==== Test TableTest.ApproximateOffsetOfCompressed</strong></span>
<span class="strong"><strong>skipping compression tests</strong></span>
</pre></div><p>The compression test is skipped because a default install of LevelDB lacks the snappy compression library, which is used to quickly compress values in tables.</p><p>A further check you can make on your <a id="id11" class="indexterm"/>LevelDB library is to run the <code class="literal">db_bench</code> command which is a timing utility built by the makefile. It is built as part of the <code class="literal">make check</code> or can be built at any time with the command, <code class="literal">build db_bench</code>. If you run <code class="literal">db_bench</code> now and save the output, you can compare the benchmark figures before and after the inclusion of snappy. We will also look at the effect of using snappy with data, specific to your application in <a class="link" href="ch10.html" title="Chapter 10. Tuning and Key Policies">Chapter 10</a>, <span class="emphasis"><em>Tuning and Key Policies</em></span>, on tuning.</p></div><div class="section" title="Installing snappy"><div class="titlepage"><div><div><h2 class="title"><a id="ch01lvl2sec07"/>Installing snappy</h2></div></div></div><p>The snappy compression <a id="id12" class="indexterm"/>library is useful if your databases have very big values, such as, complete documents stored in a single record. You will often see it <a id="id13" class="indexterm"/>referred to in discussions of LevelDB.</p><p>For completeness, we will cover installing snappy and building it with default options. Unfortunately, at the time of writing, it doesn't build with the C++11 and libc++ options we will be using in the remaining chapters. So, after any experimentation you do with snappy here, please use the following instructions to remove it, to avoid compilation errors with libc++.</p><p>To install snappy we go through a similar process of downloading an archive from <a class="ulink" href="http://code.google.com/p/snappy/downloads/list">http://code.google.com/p/snappy/downloads/list</a>, then unpacking, using a second terminal window to make it easier to keep track of the different libraries. This time, there is a configure script. We build and install with the commands:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>$./configure</strong></span>
<span class="strong"><strong>$make</strong></span>
<span class="strong"><strong>$make install</strong></span>
</pre></div><p>After these three processes (see logs) you will have the include files and built libraries for snappy in a standard location in <code class="literal">/usr</code>, where the LevelDB makefile looks for them. Rebuild your LevelDB libraries with (in <a id="id14" class="indexterm"/>the terminal window in the LevelDB directory):</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>$make clean</strong></span>
<span class="strong"><strong>$make</strong></span>
</pre></div><p>You will see <span class="strong"><strong>–DSNAPPY</strong></span> shown in the log of the <code class="literal">make</code> command, indicating that it detected the snappy installation and <a id="id15" class="indexterm"/>changed the options to match. If you repeat the <code class="literal">make check</code> you will see the compression test working.</p></div><div class="section" title="Removing snappy"><div class="titlepage"><div><div><h2 class="title"><a id="ch01lvl2sec08"/>Removing snappy</h2></div></div></div><p>If you have installed snappy for these <a id="id16" class="indexterm"/>tests, as mentioned above, you will probably want to remove it. An uninstall target is built into the makefile, that will <a id="id17" class="indexterm"/>remove it from the standard location which is checked by the LevelDB makefile.</p><p>In a terminal with working directory set to your snappy directory:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>$ make uninstall</strong></span>
<span class="strong"><strong>( cd '/usr/local/share/doc/snappy' &amp;&amp;rm -f ChangeLog COPYINGINSTALL NEWS README format_description.txt framing_format.txt )</strong></span>
<span class="strong"><strong>( cd '/usr/local/include' &amp;&amp;rm -f snappy.h snappy-sinksource.h snappy-stubs-public.h snappy-c.h )</strong></span>
<span class="strong"><strong> /bin/sh ./libtool   --mode=uninstall rm -f '/usr/local/lib/libsnappy.la'</strong></span>
<span class="strong"><strong>libtool: uninstall: rm -f /usr/local/lib/libsnappy.la /usr/local/lib/libsnappy.1.dylib /usr/local/lib/libsnappy.dylib /usr/local/lib/libsnappy.a</strong></span>
</pre></div><p>Now change the directory back to your LevelDB source and <code class="literal">make clean</code>, then repeat the original <code class="literal">make</code> to rebuild your libraries.</p><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="tip03"/>Tip</h3><p>It is a good idea to establish a habit of cleaning before building. Almost all makefiles will rebuild if source files have been dirtied, but don't respond to the environmental changes so that there is a need to forcefull rebuilds by cleaning.</p></div></div></div></div></div>
<div class="section" title="Moving to Xcode"><div class="titlepage"><div><div><h1 class="title"><a id="ch01lvl1sec09"/>Moving to Xcode</h1></div></div></div><p>Now that the build process is successfully building the library, utility, and test programs, you could continue to program the command-line tools in the plain Unix manner by editing the <code class="literal">cpp</code> files and building them with the make command. For OS X GUI and all iOS apps, we have to build with Xcode.</p><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="tip04"/>Tip</h3><p>We will start by creating a workspace. It is a good idea to get into the habit of using workspaces to wrap your projects, because the new <span class="strong"><strong>CocoaPods </strong></span>standard for delivering open source modules relies on them. There is no technical reason at this stage why we have to use a workspace, just building good habits.</p></div></div><p>In Xcode, navigate to <span class="strong"><strong>File</strong></span> | <span class="strong"><strong>New</strong></span> | <span class="strong"><strong>Workspace</strong></span> and create a workspace somewhere you can use as a basis for your development.</p><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="tip05"/>Tip</h3><p>I recommend avoiding spaces in path names because sometimes it causes a script or utility to do something unexpected. This is also a good advice for the Windows developers, even those who are using the latest Visual Studio. It's not the core tools which catch you, but the associated scripts, command lines, or environment variables.</p></div></div><p>Now navigate to <span class="strong"><strong>File</strong></span> | <span class="strong"><strong>New</strong></span> | <span class="strong"><strong>Project</strong></span> which presents a template chooser. Choose an OS X <span class="strong"><strong>Application</strong></span> in the left panel and click on the <span class="strong"><strong>Command Line Tool</strong></span> in the icons provided, then click on <span class="strong"><strong>Next</strong></span>:</p><div class="mediaobject"><img src="graphics/1015OS_01_01.jpg" alt="Moving to Xcode"/><div class="caption"><p>Choosing the Command Line Tool template</p></div></div><p>Choose a C++ project and uncheck the <a id="id18" class="indexterm"/>
<span class="strong"><strong>Use Automatic Reference Counting</strong></span> checkbox. Make sure you specify the <span class="strong"><strong>Product Name</strong></span> and <span class="strong"><strong>Company Identifier</strong></span>. You will see as you type in those entries that the <span class="strong"><strong>Bundle Identifier</strong></span> is being generated from them: <code class="literal">Packt.LevelDB-OSX-Sample01</code>. As shown in the following screenshot:</p><div class="mediaobject"><img src="graphics/1015OS_01_02.jpg" alt="Moving to Xcode"/><div class="caption"><p>Entering options and seeing Bundle Identifier</p></div></div><p>The <span class="strong"><strong>Next</strong></span> button takes you to a save dialog where you specify the location in which the project will be created. Leave the <span class="strong"><strong>Source </strong></span>
<a id="id19" class="indexterm"/>
<span class="strong"><strong>Control</strong></span> option checked and choose <span class="strong"><strong>Add to:</strong></span> your workspace, which we called <code class="literal">levelDB_OSX</code>.</p><p>You will see a project window appear <a id="id20" class="indexterm"/>in Xcode showing the <span class="strong"><strong>Build Settings</strong></span>. In the top-left is the <span class="strong"><strong>Run</strong></span> button. Just click on it to prove your command-line tool compiles and runs. At the bottom you should see the <span class="strong"><strong>All Output</strong></span> of the embedded terminal window showing <code class="literal">Hello, World!</code>
</p><p>If this is your first time in Xcode, congratulations! You have just compiled and run a simple C++ program. Now we're going to copy a bit of code from the document <code class="literal">doc/index.html</code> and use that to prove our simple <span class="emphasis"><em>Hello World</em></span> is a <span class="emphasis"><em>Hello LevelDB</em></span>.</p><p>We will start with the lines:</p><div class="informalexample"><pre class="programlisting">#include &lt;assert&gt;
#include "leveldb/db.h"</pre></div><p>Notice a red warning icon springs up rapidly to the left of the <code class="literal">&lt;assert&gt;</code> line. Clicking on it tells us <span class="strong"><strong>assert file not found</strong></span> and a similar message is visible in the left panel of the <span class="strong"><strong>Navigator</strong></span>. Change the <code class="literal">&lt;assert&gt;</code> to a <code class="literal">&lt;cassert&gt;</code> and the message goes away (this looks for a standard C++ header instead of the traditional Unix assert header).</p><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="tip06"/>Tip</h3><p>
<span class="strong"><strong>Downloading the example code</strong></span>
</p><p>You can download the example code files for all Packt books you have purchased from your account at <a class="ulink" href="http://www.packtpub.com">http://www.packtpub.com</a>. If you purchased this book elsewhere, you can visit <a class="ulink" href="http://www.packtpub.com/support">http://www.packtpub.com/support</a> and register to have the files e-mailed directly to you.</p></div></div><div class="mediaobject"><img src="graphics/1015OS_01_03.jpg" alt="Moving to Xcode"/><div class="caption"><p>Error due to failure to find db.h header</p></div></div><p>Now the red icon is next to the <code class="literal">leveldb/db.h</code> include and is warning us that it doesn't know that file. We will fix that in a minute, Xcode doesn't know where to find the LevelDB headers. For now, just copy the <a id="id21" class="indexterm"/>other lines from <code class="literal">index.html</code> to create a database and then the final <code class="literal">delete db;</code> to close it again.</p><p>The final code looks like:</p><div class="informalexample"><pre class="programlisting">#include &lt;iostream&gt;
#include &lt;cassert&gt;
#include "leveldb/db.h"

int main(intargc, const char * argv[])
{
    leveldb::DB* db;
leveldb::Options options;
options.create_if_missing = true;
leveldb::Status status = leveldb::DB::Open(options,
"/tmp/testdb", &amp;db);
assert(status.ok());
std::cout&lt;&lt; "Hello, World with leveldb in it!\n";
delete db;
return 0;
}</pre></div><p>We need to point Xcode to the header file location, which means setting a path in the settings but also deciding where the files should live. This is very much a matter of taste. You could leave them where you unpacked and built them, or put a copy in a standard location. I'm going to copy them to the standard location for Unix headers:<code class="literal">/usr/local/include</code>. Just drag the LevelDB directory from the include directory in our LevelDB installation (remember where we unpacked it previously) to <code class="literal">/usr/local/include</code>. The directory we are copying contains <code class="literal">db.h</code> and <code class="literal">env.h</code> as well as a few other <code class="literal">.h</code> files:</p><div class="mediaobject"><img src="graphics/1015OS_01_04.jpg" alt="Moving to Xcode"/><div class="caption"><p>User header search paths</p></div></div><p>Copying these files still hasn't fixed our compilation warnings. We need to modify our project to tell it where to look for the include files. Click on the Xcode target <span class="strong"><strong>LevelDB_OSX_Sample01</strong></span> in the navigator (the top of the tree) and on its name in the <span class="strong"><strong>Targets</strong></span> panel that appears to the right, so you see the <span class="strong"><strong>Build Settings</strong></span> tab. Scroll down about half way to the <span class="strong"><strong>Search Path</strong></span> section and add an entry in <span class="strong"><strong>User Header Search Paths</strong></span> for <code class="literal">/usr/local/includ</code>e with recursive turned off. It will appear inline as <code class="literal">/usr/local/include/</code>.</p><p>Now the red icon next to the <code class="literal">leveldb/db.h</code> text should go away, but we still can't build, we need to add the library. Click on the <span class="strong"><strong>Build </strong></span>
<a id="id22" class="indexterm"/>
<span class="strong"><strong>Phases</strong></span> tab and open the section <span class="strong"><strong>Link Binary With Libraries</strong></span>. Drag the <code class="literal">libleveldb.a</code> file into this section (from the copy you put in <code class="literal">/usr/local/lib</code>), as shown in the following screenshot:</p><div class="mediaobject"><img src="graphics/1015OS_01_05.jpg" alt="Moving to Xcode"/><div class="caption"><p>Static library added to build phases</p></div></div><p>You would think this would be enough to be able to build, but trying will cause an error:</p><div class="informalexample"><pre class="programlisting">Undefined symbols for architecture x86_64:
  "leveldb::DB::Open(leveldb::Options const&amp;, std::__1::basic_string&lt;char, std::__1::char_traits&lt;char&gt;, std::__1::allocator&lt;char&gt;&gt; const&amp;, leveldb::DB**)", referenced from:
      _main in main.o
ld: symbol(s) not found for architecture x86_64
clang: error: linker command failed with exit code 1 (use -v to see invocation)</pre></div><p>The problem is that the default build is linked with libstdc++ and the default template uses libc++. The LevelDB library uses <code class="literal">std::string</code> objects across its interface, so you have to ensure the same standard libraries are used with both, library and application, to avoid crashes and unpredictable runtime errors:</p><div class="mediaobject"><img src="graphics/1015OS_01_06.jpg" alt="Moving to Xcode"/><div class="caption"><p>Choosing the libstdc++ library</p></div></div><p>Go back to the <span class="strong"><strong>Build Settings</strong></span> tab and scroll to the <span class="strong"><strong>Apple LLVM compiler 4.2 – Language</strong></span> panel. The <span class="strong"><strong>C++ Standard Library</strong></span> allows you to choose <span class="strong"><strong>libstdc++ (GNU C++ standard library)</strong></span>.</p><p>Choose that and you should be able to finally <a id="id23" class="indexterm"/>build and run your little test program by clicking the big run icon. Then go have a look in the <code class="literal">/tmp/testdb</code> folder to see the database files created.</p></div>
<div class="section" title="Summary"><div class="titlepage"><div><div><h1 class="title"><a id="ch01lvl1sec10"/>Summary</h1></div></div></div><p>In this chapter we went through a typical experience for using Unix-oriented open source, getting LevelDB downloaded and built with the command line. We survived some common build errors and learned about differences in C++ library models.</p><p>With the libraries built and installed, we learned how to include them into an Xcode project and build a simple OS X command-line program. Next, we will learn how to vary this process for an iOS app.</p></div></body></html>