<html><head></head><body><div><div><div><div><h1 class="title"><a id="ch08"/>Chapter 8. Using Cloud Functions</h1></div></div></div><p>In application development, all the processes cannot be executed on the client side. So it's recommended to execute such processes on the cloud end. Parse allows users to develop a mobile app, bypassing the server-side coding and management. While developing complex applications, users want some business logic to not be executed on the client end. So for such applications, Parse provides the Parse Cloud, where you can deploy your custom logic, which can be accessed by your application.</p><p>The cloud code<a id="id204" class="indexterm"/> is required to be written in JavaScript language. The difference would be the place of execution; cloud code will be executed on the Parse Cloud rather than executing on the mobile device. Once the cloud code is updated, it's available for use across all mobile environments instantly. Such features help you to change application behavior instantly with ease. In this chapter, we will learn about the implementation of the cloud code and its usage on the mobile end.</p><div><div><div><div><h1 class="title"><a id="ch08lvl1sec48"/>The cloud code</h1></div></div></div><p>Before getting started with the cloud code, you need to set up the Parse command line tool. This tool will help you to manage and deploy your code on the cloud.</p><div><div><div><div><h2 class="title"><a id="ch08lvl2sec66"/>Installing the command-line tool</h2></div></div></div><p>To install<a id="id205" class="indexterm"/> the Parse command-line tool<a id="id206" class="indexterm"/> on a Mac/Linux environment, you need to execute the following command in your terminal window:</p><div><pre class="programlisting">curl -s https://www.parse.com/downloads/cloud_code/installer.sh | sudo /bin/bash</pre></div><p>The previous line of code will install a tool named <code class="literal">parse</code> to the<code class="literal">/usr/local/bin/parse</code> directory. To uninstall, you just need to delete the file, as it does not have any junk files installed with it.</p></div><div><div><div><div><h2 class="title"><a id="ch08lvl2sec67"/>Setting up the cloud code</h2></div></div></div><p>To <a id="id207" class="indexterm"/>set up the cloud code, create a directory where you want to save your cloud code. It's recommended to keep the cloud code in your project workspace.</p><p>The command <code class="literal">parse new</code> creates a new directory for you, and prompts for the selection of the application for which you are creating the cloud code:</p><div><pre class="programlisting">$ parse new MyCloudCode
Email: demo@gmail.com
Password:
1:DemoApp
Select an App: 1
$ cd MyCloudCode</pre></div><p>You need to use the e-mail ID and password of the Parse account to log in. In case of the <code class="literal">OAuth</code> login, you need to set a new password from your Parse settings to set up the cloud code. After successful execution of the previous command, the following file structure will be created for you:</p><div><pre class="programlisting">-config/
  global.json
-cloud/
  main.js
-public/
  index.html</pre></div><p>The explanation of the files mentioned in the preceding section is as follows:</p><div><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">The JSON file in the <code class="literal">config</code> directory should not be edited, it's for Parse use</li><li class="listitem" style="list-style-type: disc">The <code class="literal">cloud</code> directory is the place where you will store your cloud code</li><li class="listitem" style="list-style-type: disc">Initially the <code class="literal">config</code> folder will contain <code class="literal">main.js</code>, which holds your cloud functions</li><li class="listitem" style="list-style-type: disc">The <code class="literal">public</code> directory will hold the static data content for hosting on Parse</li></ul></div></div><div><div><div><div><h2 class="title"><a id="ch08lvl2sec68"/>Creating the cloud function</h2></div></div></div><p>To create<a id="id208" class="indexterm"/> the function on the cloud, you need to add the function to your <code class="literal">cloud</code>/<code class="literal">main.js</code> file. Let's take an example of the <code class="literal">cloud</code> function:</p><div><pre class="programlisting">Parse.Cloud.define("demoCloudCode", function(request, response) {
  response.success("Cloud integration is easy!");
});</pre></div><p>To deploy the code on the Parse Cloud, run the following command in your terminal:</p><div><pre class="programlisting">$ parse deploy</pre></div><p>Once the<a id="id209" class="indexterm"/> function is deployed on the cloud, you can check the cloud code in your Parse application under the <strong>Cloud Code</strong> section. The deployed code should be published there. Now it's time to execute the cloud code on the mobile side. Parse provides you with the <code class="literal">callFunctionInBackground:withParameters:block:</code> method to execute the cloud code from the mobile end.</p><p>You will have to use the following code to execute the cloud code:</p><div><pre class="programlisting">[PFCloud callFunctionInBackground:@"demoCloudCode"
                   withParameters:@{}
                            block:^(NSString *result, NSError *error) {
   if (!error) {
     NSLog(@"%@", result);
     // result is @"Cloud integration is easy!"
   }
}];</pre></div><p>So, in this section, we explored how to write and execute the cloud code.</p></div><div><div><div><div><h2 class="title"><a id="ch08lvl2sec69"/>Hosting a website</h2></div></div></div><p>It's<a id="id210" class="indexterm"/> easy to host a website on Parse. All the files in your <code class="literal">public</code> directory will be hosted at <code class="literal">your-custom-subdomain.parseapp.com</code>. The following code will illustrate a way to host your site on the Parse Cloud. Open the terminal and execute the following code:</p><div><pre class="programlisting">$ echo "Hello World" &gt; public/index.html
$ parse deploy</pre></div><p>The previous line of code will add <code class="literal">Hello World</code> in your <code class="literal">index.html</code> file and with the <code class="literal">deploy</code> command your code will be deployed to the Parse Cloud.</p><p>To update your subdomain, navigate to the <strong>Web Hosting</strong> section of your app's setting. In the field of <strong>ParseApp name</strong>, provide a unique name, and all your website files will be available at <code class="literal">your-custom-subdomain.parseapp.com</code>.</p></div><div><div><div><div><h2 class="title"><a id="ch08lvl2sec70"/>Understanding complex functions</h2></div></div></div><p>The cloud code <a id="id211" class="indexterm"/>is important to reduce the computation on the client side. Let's say, your application requires the average marks of students associated with the MBA course. The <code class="literal">Marks</code> object will look as follows:</p><div><pre class="programlisting">{
  "student": "John Melon",
  "marks": 5,
  "course": "MBA"
}</pre></div><p>In this case, <a id="id212" class="indexterm"/>you should not fetch a long list of data and filter that on the client side. You can add a Parse code for filtering the result and providing you with the resultant data. The following Parse Cloud code will help you to filter the data:</p><div><pre class="programlisting">Parse.Cloud.define("averageMarks", function(request, response) {
  var query = new Parse.Query("Marks");
  query.equalTo("course", request.params.course);
  query.find({
    success: function(results) {
      var sum = 0;
      for (var i = 0; i &lt; results.length; ++i) {
        sum += results[i].get("marks");
      }
      response.success(sum / results.length);
    },
    error: function() {
      response.error("course lookup failed");
    }
  });
});</pre></div><p>These are the following key points to note about the previous <code class="literal">Cloud</code> function:</p><div><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">Define a <code class="literal">cloud</code> function, and a query on the <code class="literal">Marks</code> object</li><li class="listitem" style="list-style-type: disc">Filter the <code class="literal">Marks</code> objects based on the <code class="literal">course</code> name provided in <code class="literal">params query.equalTo("course", request.params.course);</code></li><li class="listitem" style="list-style-type: disc">Then fetch the filtered data and return the average after completing the computation</li></ul></div><p>Now to fetch the data using the cloud code on the client side, you need to use the following code:</p><div><pre class="programlisting">[PFCloud callFunctionInBackground:@"averageMarks"
                   withParameters:@{@"course": @"MBA"}
                            block:^(NSNumber *marks, NSError *error) {
  if (!error) {
     // marks is 45
  }
}];</pre></div><p>The previous code will invoke the <code class="literal">cloud</code> function with the name <code class="literal">averageMarks</code>, and with the <code class="literal">course</code> name <code class="literal">MBA</code> as a parameter. After successful execution of the cloud code, you will get <code class="literal">marks</code> as<a id="id213" class="indexterm"/> the response, which will hold the average marks of the students who are associated with the MBA course.</p></div><div><div><div><div><h2 class="title"><a id="ch08lvl2sec71"/>Using cloud on the saved code</h2></div></div></div><p>In case <a id="id214" class="indexterm"/>of multiplatform mobile application development, the cloud code saves a lot of code to write on the client end. Suppose you have an iOS, Android, or Windows environment for application development, then in that case you can avoid coding validation on all environments by deploying a validation code on the cloud. The Cloud provides you with the <code class="literal">beforeSave</code> method. The following code will illustrate the usage:</p><div><pre class="programlisting">Parse.Cloud.beforeSave("averageMarks", function(request, response) {
  if (request.object.get("marks") &lt; 1) {
    response.error("you cannot give less than one mark");
  } else if (request.object.get("marks") &gt; 50) {
    response.error("you cannot give more than five marks");
  } else {
    response.success();
  }
});</pre></div><p>By this method, Parse allows you to add your custom logic, which will be executed before saving the object on the Cloud. In this function you can add your validation code on the objects.</p><p>Likewise, Parse provides you with the <code class="literal">afterSave</code> method as well, which will help you to provide custom logic, which will be executed after saving the object:</p><div><pre class="programlisting">Parse.Cloud.afterSave("averageMarks", function(request) {
  query = new Parse.Query("Marks");
  query.get(request.object.get("course").course, {
    success: function(course) {
      post.increment("marks");
      post.save();
    },
    error: function(error) {
      console.error("Got an error " + error.code + " : " + error.message);
    }
  });
});</pre></div><p>The previous code will be executed after saving the object on the cloud. This method allows you to<a id="id215" class="indexterm"/> add custom logic, which will get executed after saving the object.</p></div><div><div><div><div><h2 class="title"><a id="ch08lvl2sec72"/>Using cloud on the deleted code</h2></div></div></div><p>Just like<a id="id216" class="indexterm"/> saving, you can add the custom code, which will be executed before and after deleting any object from Parse. Parse provides you with the <code class="literal">beforeDelete</code> and <code class="literal">afterDelete</code> methods, which will help you to add your custom logic on these events.</p><p>The following code will illustrate the usage of the <code class="literal">beforeDelete</code> method. Similarly, you can use the <code class="literal">afterDelete</code> method as well:</p><div><pre class="programlisting">Parse.Cloud.beforeDelete("Marks", function(request) {
  query = new Parse.Query("Marks");
  query.equalTo("course", request.object.course);
  query.count({
    success: function(count) {
      if (count &gt; 0) {
        response.error("Can't delete.");
      } else {
        response.success();
      }
    },
    error: function(error) {
      response.error("Error " + error.code + " : " + error.message + " when getting photo count.");
    }
  });
});</pre></div></div></div></div>
<div><div><div><div><h1 class="title"><a id="ch08lvl1sec49"/>Summary</h1></div></div></div><p>In this chapter, we explored the Parse Cloud code and its various implementations to simplify the application development on the mobile end.</p><p>We started by exploring the installation process of the command-line tool and then we saw the setup of the cloud code on Parse.</p><p>We also learned about writing the cloud functions and their usage on the client side.</p><p>Then, we learned about publishing our website on the cloud.</p><p>Finally, we explored complex-case scenarios and implementations using the cloud.</p><p>In the next chapter, we will learn about error handling and security on Parse.</p></div></body></html>