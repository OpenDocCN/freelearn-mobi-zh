<html><head></head><body><div id="book-content"><div id="sbo-rt-content"><div id="_idContainer115">
			<h1 id="_idParaDest-100" class="chapter-number"><a id="_idTextAnchor112"/>9</h1>
			<h1 id="_idParaDest-101"><a id="_idTextAnchor113"/>Runtime Permissions</h1>
			<p>As we build our Android apps, there are some functionalities that require permissions to be granted for them to function properly. Due to privacy and data security policies, we as developers can not automatically grant permissions to the apps that we develop. We need to inform the users of the permissions that the apps need and why they <span class="No-Break">need them.</span></p>
			<p>In this chapter, we will understand runtime permissions and how to request them in <span class="No-Break">our app.</span></p>
			<p>In this chapter, we’re going to cover the following <span class="No-Break">main topics:</span></p>
			<ul>
				<li>Understanding <span class="No-Break">runtime permissions</span></li>
				<li>Requesting permissions <span class="No-Break">at runtime</span></li>
			</ul>
			<h1 id="_idParaDest-102"><a id="_idTextAnchor114"/>Technical requirements</h1>
			<p>To follow the instructions in this chapter, you will need to have Android Studio Hedgehog or later (<a href="https://developer.android.com/studio"><span class="No-Break">https://developer.android.com/studio</span></a><span class="No-Break">) downloaded.</span></p>
			<p>You can use the previous chapter’s code to follow the instructions in this chapter. You can find the code for this chapter <span class="No-Break">at </span><a href="https://github.com/PacktPublishing/Mastering-Kotlin-for-Android/tree/main/chapternine"><span class="No-Break">https://github.com/PacktPublishing/Mastering-Kotlin-for-Android/tree/main/chapternine</span></a><span class="No-Break">.</span></p>
			<h1 id="_idParaDest-103"><a id="_idTextAnchor115"/>Understanding runtime permissions</h1>
			<p><strong class="bold">Runtime permissions</strong> are permissions<a id="_idIndexMarker461"/> that are requested at runtime by an app. They are also called <strong class="bold">dangerous permissions</strong>. The user can grant or deny each permission, and <a id="_idIndexMarker462"/>the app can continue to run with limited capabilities even if the user denies a permission request. Android provides several methods you can use to request permission, such as <strong class="source-inline">requestPermissions()</strong> and <strong class="source-inline">checkSelfPermission()</strong>. The user only needs to grant permission once during the lifetime of <span class="No-Break">the app.</span></p>
			<p>Some of the features that need permission to be granted to work are camera, location, microphone and storage. Before using them, ensure that a user has permission to use them. If the user has not granted permission, you must request it from them. If the user has denied the permission, you must show a dialog explaining why you need it and ask the user to grant it from the settings. If the user has granted permission, you can use the feature. Failing to do these checks often results in an app crashing or a feature not working. If your app targets <a id="_idIndexMarker463"/>Android 6.0 and above, you must request these permissions at runtime, and the user must grant the permission for the app <span class="No-Break">to work.</span></p>
			<p>The flow for requesting<a id="_idIndexMarker464"/> permissions is shown in the <span class="No-Break">following chart:</span></p>
			<div>
				<div id="_idContainer110" class="IMG---Figure">
					<img src="image/B19779_09_01.jpg" alt="Figure 9.1 – The runtime permissions flow" width="1121" height="791"/>
				</div>
			</div>
			<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 9.1 – The runtime permissions flow</p>
			<p>As shown in the preceding diagram, this is <span class="No-Break">the flow:</span></p>
			<ol>
				<li>The initial step is to <em class="italic">declare</em> the permission in the manifest file. This is done by adding the permission to the <span class="No-Break">manifest file.</span></li>
				<li>After adding the permission to the manifest file, we must <em class="italic">design the UX</em> for the feature that needs <a id="_idIndexMarker465"/>the permission to <span class="No-Break">be granted.</span></li>
				<li>The next step is <em class="italic">waiting for the user to use</em> the feature that needs permission to be granted. At this point, we check whether the user has granted permission. If the user has granted permission, we proceed to use <span class="No-Break">the feature.</span></li>
				<li>If the user <em class="italic">has not granted permission</em>, we first check whether we need to <em class="italic">show a rationale</em> that explains why we need permission. If we need to show the rationale, we show it with explanations and then request permission from the user. If we do not need to show the rationale, we just request permission from <span class="No-Break">the user.</span></li>
				<li>Once the permission is requested, we wait for the <em class="italic">user to grant or deny</em> permission. If the user grants permission, we proceed to use the feature. If the user denies permission, we allow the app to work, but the user cannot use the feature that needs permission <span class="No-Break">to work.</span></li>
			</ol>
			<p>With this flow in mind, let us look at how to implement it in code. We are going to request permission to access <span class="No-Break">a location.</span></p>
			<h1 id="_idParaDest-104"><a id="_idTextAnchor116"/>Requesting permissions at runtime</h1>
			<p>We will follow the<a id="_idIndexMarker466"/> steps covered in <span class="No-Break"><em class="italic">Figure 9</em></span><em class="italic">.1</em> to request runtime permissions for <span class="No-Break">our app:</span></p>
			<ol>
				<li>Let us start by adding the permission to the manifest file. We will request permission to access the user’s location. To do this, we add the following permission to the <span class="No-Break">manifest file:</span><pre class="source-code">
&lt;uses-permission android:name="android.permission.ACCESS_COARSE_LOCATION" /&gt;</pre><p class="list-inset">This specifies that our app will be using the <strong class="source-inline">ACCESS_COARSE_LOCATION</strong> permission. Declaring permissions in the manifests is crucial for enhancing security, user awareness, and overall app compatibility. By explicitly specifying the actions or resources apps require access to permissions informs users during installations, allowing them to make informed decisions about granting or denying access. This declaration ensures compatibility across different Android versions and devices, facilitates inter-app communication, and supports intent filtering to control <a id="_idIndexMarker467"/>component access. Permissions also play a role in runtime permission requests for dangerous permissions and help maintain platform compatibility. Additionally, Play Store reviews declare permissions as part of the submission process, contributing to adherence to policies and guidelines. In essence, manifest-based permission declarations are fundamental for creating secure, transparent, and user-controlled environments in <span class="No-Break">our apps.</span></p><p class="list-inset">The next thing is to create the UX for the feature that needs permission. We will create a dialog to request permissions from the user. It will also have the logic that shows the rationale to the user if permission was <span class="No-Break">previously denied.</span></p></li>				<li>Let’s create a new file in the <strong class="source-inline">view</strong> package named <strong class="source-inline">PermissionDialog.kt</strong> and add the utility functions to <span class="No-Break">the file:</span><pre class="source-code">
fun checkIfPermissionGranted(context: Context, permission: String): Boolean {
    return (ContextCompat.checkSelfPermission(context, permission)
            == PackageManager.PERMISSION_GRANTED)
}
fun shouldShowPermissionRationale(context: Context, permission: String): Boolean {
    val activity = context as Activity?
    if (activity == null)
        Log.d("Permissions", "Activity is null")
    return ActivityCompat.shouldShowRequestPermissionRationale(
        activity!!,
        permission
    )
}</pre><p class="list-inset">The first function checks whether the permission has been granted using the <strong class="source-inline">ContextCompat.checkSelfPermission()</strong> function. The second function checks whether <a id="_idIndexMarker468"/>we need to show the rationale to the user. This is done using the <strong class="source-inline">ActivityCompat.shouldShowRequestPermissionRationale()</strong> function. This function returns <strong class="source-inline">true</strong> if the app has requested this permission previously and the user denied the request. If the user turned down the permission request in the past and chose the <strong class="bold">Don’t ask again</strong> option in the permission request system dialog, this method <span class="No-Break">returns </span><span class="No-Break"><strong class="source-inline">false</strong></span><span class="No-Break">.</span></p><p class="list-inset">Next, let us create a sealed class that will be used to represent the state of the <span class="No-Break">permission request.</span></p></li>				<li>Create a new file named <strong class="source-inline">PermissionAction.kt</strong> in the <strong class="source-inline">data</strong> package, and add the following code to <span class="No-Break">the file:</span><pre class="source-code">
sealed class PermissionAction {
    data object PermissionGranted : PermissionAction()
    data object PermissionDenied : PermissionAction()
}</pre><p class="list-inset">The class has two states, <strong class="source-inline">PermissionGranted</strong> and <strong class="source-inline">PermissionDenied</strong>. A user can either grant or <span class="No-Break">deny permission.</span></p></li>				<li>Next, let us create <a id="_idIndexMarker469"/>the dialog that will be used to request permission from the user. Head back to the <strong class="source-inline">PermissionDialog.kt</strong> file and add the following code to <span class="No-Break">the file:</span><pre class="source-code">
@Composable
fun PermissionDialog(
    context: Context,
    permission: String,
    permissionAction: (PermissionAction) -&gt; Unit
) {
    val isPermissionGranted = checkIfPermissionGranted(context, permission)
    if (isPermissionGranted) {
        permissionAction(PermissionAction.PermissionGranted)
        return
    }
    val permissionsLauncher = rememberLauncherForActivityResult(
        ActivityResultContracts.RequestPermission()
    ) { isGranted: Boolean -&gt;
        if (isGranted) {
            permissionAction(PermissionAction.PermissionGranted)
        } else {
            permissionAction(PermissionAction.PermissionDenied)
        }
    }
    val showPermissionRationale = shouldShowPermissionRationale(context, permission)
    var isDialogDismissed by remember { mutableStateOf(false) }
    var isPristine by remember { mutableStateOf(true) }
    if ((showPermissionRationale &amp;&amp; !isDialogDismissed) || (!isDialogDismissed &amp;&amp; !isPristine)) {
        isPristine = false
        AlertDialog(
            onDismissRequest = {
                isDialogDismissed = true
                permissionAction(PermissionAction.PermissionDenied)
            },
            title = { Text(text = "Permission Required") },
            text = { Text(text = "This app requires the location permission to be granted.") },
            confirmButton = {
                Button(
                    onClick = {
                        isDialogDismissed = true
                        permissionsLauncher.launch(permission)
                    }
                ) {
                    Text(text = "Grant Access")
                }
            },
            dismissButton = {
                Button(
                    onClick = {
                        isDialogDismissed = true
                        permissionAction(PermissionAction.PermissionDenied)
                    }
                ) {
                    Text(text = "Cancel")
                }
            }
        )
    } else {
        if (!isDialogDismissed) {
            SideEffect {
                permissionsLauncher.launch(permission)
            }
        }
    }
}</pre><p class="list-inset">Let’s break down the <span class="No-Break">preceding code:</span></p><ul><li>We have created a composable, <strong class="source-inline">PermissionDialog</strong>, which takes three parameters, <strong class="source-inline">context</strong>, <strong class="source-inline">permission</strong> string, and a <strong class="source-inline">permissionAction</strong> callback, which passed the option the user selected to the <span class="No-Break">call site.</span></li><li>Inside the <a id="_idIndexMarker470"/>composable, the first thing we do is check whether permission has been granted. If permission has been granted, we call the <strong class="source-inline">permissionAction</strong> callback with the <strong class="source-inline">PermissionGranted</strong> state <span class="No-Break">and return.</span></li><li>Next, we also created <strong class="source-inline">permissionsLauncher</strong>, which is used to request permission from the user. We use the <strong class="source-inline">rememberLauncherForActivityResult()</strong> function to create a launcher for the contract. We then use the launcher to request permission from the user. If the user grants the permission, we call the <strong class="source-inline">permissionAction</strong> callback with the <strong class="source-inline">PermissionGranted</strong> state. If the user denies the permission, we call the <strong class="source-inline">permissionAction</strong> callback with the <span class="No-Break"><strong class="source-inline">PermissionDenied</strong></span><span class="No-Break"> state.</span></li><li>If the permission has not been granted, we check whether we need to show the rationale to the user. If we need to, we show the rationale with explanations and then request permission from the user. If we do not need to show the rationale, we must request permission from the user. In our case, the rationale is <strong class="source-inline">AlertDialog</strong>, with two action items and a message explaining why we need the permission. The first action item is used to request permission from the user. The second action item is used to cancel the permission request. If we tap the <strong class="bold">Grant Access</strong> option, we launch the permission request once again, and a dialog will pop up again, asking them to allow permission. If we tap <strong class="bold">Cancel</strong>, the <strong class="source-inline">permissionAction</strong> callback is called with the <strong class="source-inline">PermissionDenied</strong> state, and the dialog is dismissed. We also have two mutable states, <strong class="source-inline">isDialogDismissed</strong> and <strong class="source-inline">isPristine</strong>. The first is used to check whether the dialog has been dismissed. The second one let’s know whether the dialog was shown before. We use these states combined to know whether to show the dialog <span class="No-Break">or not.</span></li><li>Lastly, if we do not need to show the rationale, we just request permission from the user. We<a id="_idIndexMarker471"/> use <strong class="source-inline">SideEffect</strong> to request permission from the user because we want to request permission from the user as soon as the dialog <span class="No-Break">is shown.</span></li></ul><p class="list-inset">Since we do not have an actual feature in our app currently that uses location, we are going to simulate permission flow with our <span class="No-Break"><strong class="source-inline">PetsScreen</strong></span><span class="No-Break"> composable.</span></p></li>				<li>Let’s head to the <strong class="source-inline">PetsScreen.kt</strong> file and modify it to <span class="No-Break">the following:</span><pre class="source-code">
@Composable
fun PetsScreen(
    onPetClicked: (Cat) -&gt; Unit,
    contentType: ContentType,
) {
    val petsViewModel: PetsViewModel = koinViewModel()
    val petsUIState by petsViewModel.petsUIState.collectAsStateWithLifecycle()
    val context = LocalContext.current
    var showContent by rememberSaveable { mutableStateOf(false) }
    PermissionDialog(
        context = context,
        permission = Manifest.permission.ACCESS_COARSE_LOCATION
    ) { permissionAction -&gt;
        when (permissionAction) {
            is PermissionAction.PermissionDenied -&gt; {
                showContent = false
            }
            is PermissionAction.PermissionGranted -&gt; {
                showContent = true
                Toast.makeText(
                    context,
                    "Location permission granted!",
                    Toast.LENGTH_SHORT
                ).show()
            }
        }
    }
    if (showContent) {
        PetsScreenContent(
            modifier = Modifier
                .fillMaxSize(),
            onPetClicked = onPetClicked,
            contentType = contentType,
            petsUIState = petsUIState,
            onFavoriteClicked = {
                petsViewModel.updatePet(it)
            }
        )
    }
}</pre><p class="list-inset">We have only made a few changes to <span class="No-Break">this file:</span></p><ul><li>First, we have added a <strong class="source-inline">showContent</strong> mutable state that is used to check whether we should show the content of the screen. We have also set the initial value of the state to <strong class="source-inline">false</strong>. We will use this state to show the content of the screen if<a id="_idIndexMarker472"/> the user grants permission. We also have the <strong class="source-inline">context</strong> variable used to get the <span class="No-Break">screen’s context.</span></li><li>We have also added the <strong class="source-inline">PermissionDialog</strong> composable to the <strong class="source-inline">PetsScreen</strong> composable. We have passed the context and the permission – in this case, the <strong class="source-inline">ACCESS_COARSE_LOCATION</strong> permission – to the composable. We have also passed a callback to the composable that is used to get the state of the permission request. If the user grants the permission, we set the <strong class="source-inline">showContent</strong> state to <strong class="source-inline">true</strong> and show a toast with the <strong class="bold">Location permission granted</strong> message. If the user denies the permission, we set the <strong class="source-inline">showContent</strong> state <span class="No-Break">to </span><span class="No-Break"><strong class="source-inline">false</strong></span><span class="No-Break">.</span></li><li>Lastly, we have added a check to see whether the <strong class="source-inline">showContent</strong> state is <strong class="source-inline">true</strong>. If the state is <strong class="source-inline">true</strong>, we show the content of the screen. If the state is <strong class="source-inline">false</strong>, we do not show the content of <span class="No-Break">the screen.</span></li></ul></li>				<li>Build and run the app. At first, we<a id="_idIndexMarker473"/> will see the permission dialog, as shown in the <span class="No-Break">following screenshot:</span></li>
			</ol>
			<div>
				<div id="_idContainer111" class="IMG---Figure">
					<img src="image/B19779_09_02.jpg" alt="Figure 9.2 – The permission dialog" width="503" height="1100"/>
				</div>
			</div>
			<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 9.2 – The permission dial<a id="_idTextAnchor117"/>og</p>
			<ol>
				<li value="7">Tap the <strong class="bold">Don’t allow</strong> option, which will show an empty white screen, since we don’t show any content when the user has not granted the <span class="No-Break">app permission.</span></li>
			</ol>
			<div>
				<div id="_idContainer112" class="IMG---Figure">
					<img src="image/B19779_09_03.jpg" alt="Figure 9.3 – The no permission screen" width="503" height="1100"/>
				</div>
			</div>
			<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 9.3 – The no permission screen</p>
			<p class="list-inset">The next time we run the<a id="_idIndexMarker474"/> app, we will see the rationale dialog showing why the app <span class="No-Break">needs permission.</span></p>
			<div>
				<div id="_idContainer113" class="IMG---Figure">
					<img src="image/B19779_09_04.jpg" alt="Figure 9.4 – The permission rationale" width="499" height="1099"/>
				</div>
			</div>
			<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 9.4 – The permission rationale</p>
			<p class="list-inset">On this rationale dialog, we can either cancel the request or grant access. Tapping the <strong class="bold">Grant Access</strong> option should bring up the permission dialog shown in <span class="No-Break"><em class="italic">Figure 9</em></span><em class="italic">.2</em>, and by tapping the <strong class="bold">While using the app</strong> option, we grant the app the location <a id="_idIndexMarker475"/>permission, and now, we should be able to see the list of cute cats o<a id="_idTextAnchor118"/>nce again. Running the app again does not show the dialogs, since we have already granted the app the <span class="No-Break">location permission.</span></p>
			<div>
				<div id="_idContainer114" class="IMG---Figure">
					<img src="image/B19779_09_05.jpg" alt="Figure 9.5 – Cute cats" width="499" height="1099"/>
				</div>
			</div>
			<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 9.5 – Cute cats</p>
			<h1 id="_idParaDest-105"><a id="_idTextAnchor119"/>Summary</h1>
			<p>In this chapter, we explored what runtime permissions are and why we should declare and request permissions in our apps. Step by step, we learned how to request runtime permissions in our app and how to show permission rationale dialogs, explaining to users why we need access to runtime permissions in cases where they have denied apps access <span class="No-Break">to permissions.</span></p>
			<p>In the next chapter, we will learn debugging tips and tricks, how to detect leaks using LeakCanary, how to inspect HTTPS requests/responses fired by our app using Chucker, and how to inspect the <span class="No-Break">Room database.</span></p>
		</div>
	</div></div>
<div id="book-content"><div id="sbo-rt-content"><div id="_idContainer116" class="Content">
			<h1 id="_idParaDest-106" lang="en-US" xml:lang="en-US"><a id="_idTextAnchor120"/>Part 3: Code Analysis and Tests</h1>
			<p>In this part, you will gain proficiency in debugging through a series of valuable tips and tricks. Unveiling the intricacies, you will discover techniques for detecting memory leaks within your app and adeptly inspecting HTTP requests triggered by your application. Our exploration extends to inspecting your local database, offering insights into its inner workings. Diving into Kotlin best practices, you will delve into code analysis for your application, addressing code smells for enhanced code quality. This part also includes a comprehensive exploration of testing methodologies, empowering you to seamlessly integrate tests across various layers of your <span class="No-Break">MVVM architecture.</span></p>
			<p>This section contains the <span class="No-Break">following chapters:</span></p>
			<ul>
				<li><a href="B19779_10.xhtml#_idTextAnchor121"><em class="italic">Chapter 10</em></a>, <em class="italic">Debugging Your App</em></li>
				<li><a href="B19779_11.xhtml#_idTextAnchor135"><em class="italic">Chapter 11</em></a>, <em class="italic">Enhancing Code Quality</em></li>
				<li><a href="B19779_12.xhtml#_idTextAnchor157"><em class="italic">Chapter 12</em></a>, <em class="italic">Testing Your App</em></li>
			</ul>
		</div>
		<div>
			<div id="_idContainer117">
			</div>
		</div>
		<div>
			<div id="_idContainer118">
			</div>
		</div>
		<div>
			<div id="_idContainer119">
			</div>
		</div>
		<div>
			<div id="_idContainer120">
			</div>
		</div>
		<div>
			<div id="_idContainer121">
			</div>
		</div>
		<div>
			<div id="_idContainer122" class="Basic-Graphics-Frame">
			</div>
		</div>
		<div>
			<div id="_idContainer123" class="Basic-Graphics-Frame">
			</div>
		</div>
		<div>
			<div id="_idContainer124">
			</div>
		</div>
		<div>
			<div id="_idContainer125">
			</div>
		</div>
		<div>
			<div id="_idContainer126" class="Basic-Graphics-Frame">
			</div>
		</div>
	</div></div></body></html>