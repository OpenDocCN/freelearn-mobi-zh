<html><head></head><body><div class="chapter" title="Chapter&#xA0;3.&#xA0;Migrating to Swift 3 to Be More Swifty"><div class="titlepage"><div><div><h1 class="title"><a id="ch03"/>Chapter 3. Migrating to Swift 3 to Be More Swifty</h1></div></div></div><p>If you're a Swift developer like me, you probably have existing code in Swift 2.2 that you aren't ready to let go of just yet. Thankfully, Xcode 8 and the built in <span class="emphasis"><em>Swift Migrator</em></span> will help you convert your Swift 2.2 projects to Swift 3. We will use a sample project to walk through using the Migrator. We will also go over some useful strategies you can employ when the Migrator fails to convert all of your code properly.</p><div class="section" title="How can you migrate your project…"><div class="titlepage"><div><div><h1 class="title"><a id="ch03lvl1sec20"/>How can you migrate your project…</h1></div></div></div><p>When you open a Swift 2.2 project in Xcode 8 for the first time, you are given the option to migrate your project to either Swift 2.3 or Swift 3 in order to take advantage of the new SDKs. However, if for some you decide that now is not the right time to convert, you can always do so later. The Swift Migrator tool is accessible in Xcode 8 under the <span class="strong"><strong>Edit </strong></span>|<span class="strong"><strong> Convert </strong></span>|<span class="strong"><strong> To Current Swift Syntax…</strong></span> menu.</p><p>You will need to convert your code if you want to use the new SDK's available for iOS 10, macOS 10.12, watchOS 3, or tvOS 10. You have two options for migrating your project listed below:</p><div class="section" title="Option1 - Migrating to Swift 3"><div class="titlepage"><div><div><h2 class="title"><a id="ch03lvl2sec6"/>Option1 - Migrating to Swift 3</h2></div></div></div><p>If you want to build against the latest Swift and use all of the new features of Xcode 8, then choose the migrate to Swift 3 option. The Migrator will modify your source files to adhere to the new Swift 3 syntax.</p></div><div class="section" title="Option 2 - Migrating to Swift 2.3"><div class="titlepage"><div><div><h2 class="title"><a id="ch03lvl2sec7"/>Option 2 - Migrating to Swift 2.3</h2></div></div></div><p>If you just want to use the new SDKs and aren't ready or able to migrate to the latest version of Swift, then choose the Swift 2.3 option. Swift 2.3 is Swift 2.2 plus new SDKs. In this migration scenario, the Migrator will modify build settings to use Legacy Swift (Swift 2.2) while making selective source changes to allow your project to build against the new SDKs.</p></div></div></div>
<div class="section" title="Planning ahead"><div class="titlepage"><div><div><h1 class="title"><a id="ch03lvl1sec21"/>Planning ahead</h1></div></div></div><p>Let's face it, Xcode is asking you to bravely use its black box tool to make irreversible changes to your project. While I'm a huge Apple fan, I doubt I would ever just press the shiny new migrate button without thinking about what could go wrong in the process. I'm not in the business of scrapping projects and starting from scratch. Honestly, who really is? To avoid a potentially terrible time with the
Migrator, you really should consider doing everything listed below as pre-work before migrating your project:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Ensure that your existing codebase is making use of a version control system such as Git (<a class="ulink" href="https://git-scm.com">https://git-scm.com</a>) or Subversion (<a class="ulink" href="https://subversion.apache.org">https://subversion.apache.org</a>). If you run the Migrator and the output doesn't convert things as expected (or other unexpected things happen), you will have peace of mind that you can always get back to your original version.</li><li class="listitem">Make sure your project compiles on the latest version of Xcode (7.3 or 7.3.1). You want to make sure everything, including your tests, runs as expected under Xcode 7. If your project does not build and run as a Swift 2.2 project, you are just asking for trouble by using the Migrator at this point. Make sure things work now before migrating to Swift 2.3 or Swift 3. Your goal is to have your tests pass now and after the migration.</li><li class="listitem">Make sure that every target you want converted builds with the active scheme. The Swift Migrator uses the active scheme in Xcode to determine which source files it should examine for migration. You can verify the targets that the Migrator will consider by looking at the settings of your scheme using the <span class="strong"><strong>Edit Scheme</strong></span> menu. Once there, switch to the build tab of the scheme and make sure that all targets you want migrated are checked off.</li></ol></div><div class="note" style="" title="Note"><div class="inner"><h3 class="title"><a id="tip11"/>Tip</h3><p>You can add a new scheme to your project and include all of the targets. Using a separate scheme for migration will ensure that you don't modify settings on your main schemes. You can remove the scheme after the migration.</p></div></div><p>If your project uses Carthage or CocoaPods, or another projects that is not built along with your main project, then you have two options:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>Integrate the outside projects into your main project: </strong></span>Using this option means that you intend to copy the source files of the other projects into your existing project. I would be hesitant in doing this unless you really have a good handle on how the project is structured and intend to maintain it going forward. Once you copy the files in, you will be disconnected from updates and continued work happening in the project. Updating in the future would require you to perform the same copy, paste, and configure drill each time.</li><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>Do nothing, meaning you won't convert at this time: </strong></span>With this option, you migrate just your code and continue to link to any 3<sup>rd</sup> party project without migrating. This could be a pretty good option to consider as the owner of the outside project might have better insights on how to migrate the project but just has not done so yet. If it's not your project, you might be better off waiting for an update from the owner and maintainers of the project. Chances are good that you can continue to use the 3<sup>rd</sup> party project as is. A last trend that developers are implementing is to create Swift 2.3 and Swift 3 branches to ease later transitions while developing with Xcode 8 betas.</li></ul></div></div>
<div class="section" title="Migrating with Xcode's Swift migration tool"><div class="titlepage"><div><div><h1 class="title"><a id="ch03lvl1sec22"/>Migrating with Xcode's Swift migration tool</h1></div></div></div><p>Once you've done your pre-work, it's time to migrate your code. For our purposes, we are going to use a simple Tic Tac Toe project that you can download from the Packt website:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem"><span class="strong"><strong>Launch Xcode 8 and open the Tic Tac Toe project</strong></span>:<span class="strong"><strong> </strong></span>On first launch, Xcode will ask you if you want to migrate your Swift 2.2 project to use the latest SDKs. Choose Convert to start the migration.<p>
</p><div class="mediaobject"><img alt="Migrating with Xcode's Swift migration tool" src="graphics/image_03_001.jpg"/></div><p>
</p></li><li class="listitem"><span class="strong"><strong>Choose either Swift 2.3 or Swift 3</strong></span>:<span class="strong"><strong> </strong></span>After choosing to convert, you will be prompted with another screen that basically lets you know that Xcode is going to modify your files. You are also told that, once the migration is over, you will be given the option to accept the changes or dismiss them without permanently changing your project's files. The modal dialog also gives you a disclaimer that the Swift Migrator isn't perfect and you might have to make additional changes once the migration has completed. Press <span class="strong"><strong>Next</strong></span> and then choose Swift 3.<p>
</p><div class="mediaobject"><img alt="Migrating with Xcode's Swift migration tool" src="graphics/image_03_002.jpg"/></div><p>
</p></li><li class="listitem"><span class="strong"><strong>Choose the targets to convert</strong></span>:<span class="strong"><strong> </strong></span>If you have a project with multiple targets, you need to make sure that you have selected a scheme that will build all the targets you want migrated to the newest Swift (or Swift 2.3). In our case, there is only one target to convert and it should already be checked off. Should you want to skip a target, you just need to uncheck its corresponding checkbox.<p>
</p><div class="mediaobject"><img alt="Migrating with Xcode's Swift migration tool" src="graphics/image_03_004.jpg"/></div><p>
</p><div class="note" style="" title="Note"><div class="inner"><h3 class="title"><a id="tip12"/>Tip</h3><p>You can run the migration multiple times on a project. If you prefer not to modify your schemes, you could just run the migration for each scheme that you want converted. Just make the selected scheme the active one and start the migration.</p></div></div></li><li class="listitem"><span class="strong"><strong>Review changes on the preview screen: </strong></span>After selecting the targets and pressing <span class="strong"><strong>Next</strong></span>, the Migrator tool will begin its work. Once the process is finished, you are prompted with a preview screen containing before and after changes for you to review. Every source file that Xcode modified will be available in the preview window. It is highly recommended that you examine each of the files to make sure you understand the code changes and agree with the recommended changes before accepting them.</li><li class="listitem">When reviewing changes, you have options on what you want permanently modified. Each modified file has a numbered listing of changes that you can discard or further modify. You discard a particular change in a file by expanding the button on an individual highlighted change and selecting the dismiss action. At the file level, you can discard changes to a file by unchecking the file on the left sidebar view.<p>
</p><div class="mediaobject"><img alt="Migrating with Xcode's Swift migration tool" src="graphics/image_03_005.jpg"/></div><p>
</p></li><li class="listitem"><span class="strong"><strong>Save your changes: </strong></span>Once you are finished reviewing changes, press the <span class="strong"><strong>S<span class="strong"><strong>ave</strong></span>
</strong></span> button. You will be prompted with a confirmation dialog warning you that the changes will be final. You won't be able to revert using the migration tool once you give the Swift Migrator approval to apply all of the changes. Click the <span class="strong"><strong>
<span class="strong"><strong>Continue</strong></span>
</strong></span> button to confirm that you do want to accept the changes.</li></ol></div><p>
</p><div class="mediaobject"><img alt="Migrating with Xcode's Swift migration tool" src="graphics/image_03_006.jpg"/></div><p>
</p><p>Once you save the changes, the migration is complete. Xcode will try to compile your project and will let you know if there are any build issues. In our case, we have a warning and two build errors. The warning is telling us that we are not using all of the recommended project settings. Go ahead and double-click the warning to have Xcode change our project settings to the recommended ones. In this case, Xcode is recommending that we use Whole Module Optimization.</p><div class="note" style="" title="Note"><div class="inner"><h3 class="title"><a id="note13"/>Note</h3><p>Whole Module Optimization is a build setting that lets the compiler consider the entire module when making advanced optimizations of your code. When the compiler has module-wide visibility of your code, optimization decisions are made with more information about how an affected routine is used throughout the module and not just within a single file. Better optimizations result in faster code. You can learn more about Whole Module Optimization and options for optimizing Swift performance by viewing the Optimizing Swift Performance lecture given at WWDC 2015 <a class="ulink" href="https://developer.apple.com/videos/play/wwdc2015/409/">https://developer.apple.com/videos/play/wwdc2015/409/</a>.</p></div></div><p>
</p><div class="mediaobject"><img alt="Migrating with Xcode's Swift migration tool" src="graphics/image_03_007.jpg"/></div><p>
</p><p>The remaining build errors may or may not show up on your machine. In my case the errors are due to the fact that I had previously built the project using Xcode 7.3.1. Each time you build a project, Xcode caches the intermediate products from a compilation to improve future builds. If part of your code hasn't changed, Xcode uses the cached byproducts to streamline recompilation. This cached data is stored in a folder that Xcode uses for future builds. In my case the derived data folder contained code that was no longer relevant for the project given the project's migration to Swift 3 and Xcode 8.0. Clean your project with the Product &gt; Clean command. Your project should now compile successfully.</p><p>Troubleshooting when things go wrong with the migration</p><p>Unfortunately, not all projects will convert perfectly. The <a class="ulink" href="https://swift.org">https://swift.org</a> website maintains a list of known Migrator issues that you can reference (<a class="ulink" href="https://swift.org/migration-guide/">https://swift.org/migration-guide/</a>). For example, the Migrator might suggest how to fix an issue via a fixit in the editor margin without automatically doing it for you. The reason you might see a fixit in this example is because your project might have multiple targets that share some form of dependence, which can confuse the Migrator. It's a known issue, but an easy one to deal with after the migration. You just need to click the fixit selecting the recommended action, and Xcode will do the rest. We don't have enough time to cover all of the known issues with migrations, but we will cover some of more important ones.</p><p>We can categorize known Migrator issues into one of three general areas:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem"><span class="strong"><strong>Standard library issues</strong></span>:<span class="strong"><strong> </strong></span>Generally, these issues involve Collection routines and types</li><li class="listitem"><span class="strong"><strong>New SDK issues</strong></span>:<span class="strong"><strong> </strong></span>These issues deal with the Migrator failing to correlate old types and protocols to new ones created in the new SDK. You might also run into issues related to the Foundation framework overhaul. We cover the major changes to the Foundation framework in <a class="link" href="ch08.html" title="Chapter 8. Oh Goodness! Look Whats New in the Foundation Framework">Chapter 8</a>, <span class="emphasis"><em>Oh Goodness! Look What's New in the Foundation Framework</em></span>.</li><li class="listitem"><span class="strong"><strong>Swift 3 language changes</strong></span>:<span class="strong"><strong> </strong></span>These Migrator issues relate to changes to the language for Swift 3. In cases where a function or construct is no longer available in Swift 3, the Migrator will not take any action and you will need to manually change the code.</li></ol></div><p>You will need to use a combination of the warning/error messages generated along with the known issues page listed on the <a class="ulink" href="https://swift.org">https://swift.org</a> website to determine how to fix build errors that surface after a migration. If a fixit hint is not provided in the editor margin, you will have to manually correct the issue.</p><div class="section" title="Quick strategies for addressing issues"><div class="titlepage"><div><div><h2 class="title"><a id="ch03lvl2sec8"/>Quick strategies for addressing issues</h2></div></div></div><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem"><span class="strong"><strong>Fixit suggestions</strong></span>:<span class="strong"><strong> </strong></span>After the migration finishes, examine the warnings/errors section for fixit actions. Each of these will give you a recommendation on how to fix the code in question. Simply choose the actions and Xcode will apply the code change.</li><li class="listitem"><span class="strong"><strong>Migrator comments</strong></span>:<span class="strong"><strong> </strong></span>Even when your project compiles, there is still a possibility that the Migrator missed something during the conversion that could not be handled. In these cases, the Migrator leaves <code class="literal">/*Migrator FIXME: ...*/</code> comments in your code. You'll want to search for these and decide if you need to manually make a change once you have evaluated the code block.</li><li class="listitem"><span class="strong"><strong>Use the new Foundation framework value types</strong></span>:<span class="strong"><strong> </strong></span>When inspecting your project code, you might see that Swift is casting types to "NS" prefixed types. You probably don't want legacy Foundation types when using Swift 3. Again, the Migrator does a pretty good job of finding and correcting these; however, you are still  advised to do a manual search for the "NS" prefix. If you find any 'NS' prefix occurrences, you will have the opportunity to determine if each is correct or if you should use a new Foundation type without the "NS" prefix. In <a class="link" href="ch08.html" title="Chapter 8. Oh Goodness! Look Whats New in the Foundation Framework">Chapter 8</a>, <span class="emphasis"><em>Oh Goodness! Look What's New in the Foundation Framework</em></span>, we will cover Foundation changes, including the new value types.</li><li class="listitem"><span class="strong"><strong>User-defined collection types might generate migration issues: </strong></span>In Swift 3, collections need to handle moving forward and backward through their collection of items. You will need to adopt the new Collection protocol (<a class="ulink" href="https://developer.apple.com/reference/swift/collection">https://developer.apple.com/reference/swift/collection</a>) functions that define how you increment the index. If your collection supports decrementing, there is a new protocol function for that as well. Last, there is a protocol function that allows your collection to support randomly accessing an item. If you see errors associated with your custom collections not adhering to the Collection protocol, it's likely that you have not added one or more of the new protocol functions below:<div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><code class="literal">func index(after: Index) -&gt; Index</code></li><li class="listitem" style="list-style-type: disc"><code class="literal">func index(before: Index) -&gt; Index</code></li><li class="listitem" style="list-style-type: disc"><code class="literal">func index(_: Index, offsetBy: Int) -&gt; Index</code></li><li class="listitem" style="list-style-type: disc"><code class="literal">func distance(from: Index, to: Index) -&gt; IndexDistance</code></li></ul></div></li><li class="listitem"><span class="strong"><strong>Removed features in Swift 3</strong></span>: An example of this would be the C-style for-loop, which has been removed from Swift 3. You will have to manually re-write it as a <code class="literal">for…in</code> statement.</li></ol></div><p>Hopefully, at this point, you are getting the idea that the Migrator is going to handle most of your everyday use cases. For those issues, you will need to use the warning and error messages to decipher what's going on. The first place to check should be the known issues section on Swift.org.</p></div></div>
<div class="section" title="Summary"><div class="titlepage"><div><div><h1 class="title"><a id="ch03lvl1sec23"/>Summary</h1></div></div></div><p>The Swift Migrator is a great tool that saves you time when you need to migrate Swift 2.2 projects to Swift 3 (or Swift 2.3). We learned that we have to migrate our existing Swift 2.2 projects to Swift 3 to take advantage of everything Xcode 8 has to offer. We also learned that we can use the new SDKs without migrating to Swift 3 by choosing to migrate to Swift 2.3 (Swift 2.2 plus new SDKs). At any point in the future, we can use the <span class="strong"><strong>
<span class="strong"><strong>Edit</strong></span> |<span class="strong"><strong>Conver</strong></span>t</strong></span> <span class="emphasis"><em>| <span class="strong"><strong>To Current Swift Syntax...</strong></span>
</em></span> menu to launch the migration tool. Finally, we learned that the Migrator isn't perfect and that it might not convert everything. We might have to make some manual changes to get things to work after the migration has finished. In the next chapter, we will begin covering Swift 3's core language changes.</p></div></body></html>