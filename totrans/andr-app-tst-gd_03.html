<html><head></head><body><div class="chapter" title="Chapter&#xA0;3.&#xA0;Building Blocks on the Android SDK"><div class="titlepage"><div><div><h1 class="title"><a id="ch03"/>Chapter 3. Building Blocks on the Android SDK</h1></div></div></div><p>We now know how to create test projects and run the tests. It is now time to start digging a bit deeper to find the building blocks available to create the tests.</p><p>Thus, in this third chapter, we will be covering:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">Common assertions</li><li class="listitem" style="list-style-type: disc">View assertions</li><li class="listitem" style="list-style-type: disc">Other assertion types</li><li class="listitem" style="list-style-type: disc">TouchUtils, intended to test User Interfaces</li><li class="listitem" style="list-style-type: disc">Mock objects</li><li class="listitem" style="list-style-type: disc">Instrumentation</li><li class="listitem" style="list-style-type: disc">TestCase class hierarchies</li><li class="listitem" style="list-style-type: disc">Using external libraries</li></ul></div><p>We will be analyzing these components and showing examples of their use when applicable. The examples in this chapter are intentionally split from the original Android project containing them to let you concentrate and focus only on the subject being presented, although the complete examples can be downloaded as explained later. Right now, we are interested in the trees and not the forest.</p><p>Along with the examples presented, we will be identifying common, reusable patterns that will help you in the creation of tests for your own projects.</p><div class="section" title="The demonstration application"><div class="titlepage"><div><div><h1 class="title"><a id="ch03lvl1sec01"/>The demonstration application</h1></div></div></div><p>We have created a very simple application to demonstrate the use of some of the tests in this chapter. The source for this application can be downloaded from<a class="ulink" href="http://www.packtpub.com/support"> http://www.packtpub.com/support</a>.<a class="indexterm" id="id91"/>
</p><p>The next screenshot shows this application running:</p><div class="mediaobject"><img alt="The demonstration application" src="graphics/3500_03_01(2).jpg"/></div></div></div>
<div class="section" title="Assertions in depth"><div class="titlepage"><div><div><h1 class="title"><a id="ch03lvl1sec02"/>Assertions in depth</h1></div></div></div><p>Assertions are methods that should check for a condition that could be evaluated and throw an exception if the condition is not met, thus aborting the execution of the test.<a class="indexterm" id="id92"/>
</p><p>The JUnit API includes the class<code class="literal"> Assert</code>, which is the base class all of the test case classes. It holds several assertion methods useful for writing tests. These inherited methods test for a variety of conditions and are overloaded to support different parameter types. They can be grouped together in different sets, depending on the condition checked; for example:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><code class="literal">assertEquals</code></li><li class="listitem" style="list-style-type: disc"><code class="literal">assertFalse</code></li><li class="listitem" style="list-style-type: disc"><code class="literal">assertNotNull</code></li><li class="listitem" style="list-style-type: disc"><code class="literal">assertNotSame</code></li><li class="listitem" style="list-style-type: disc"><code class="literal">assertNull</code></li><li class="listitem" style="list-style-type: disc"><code class="literal">assertSame</code></li><li class="listitem" style="list-style-type: disc"><code class="literal">assertTrue</code></li><li class="listitem" style="list-style-type: disc"><code class="literal">fail</code></li></ul></div><p>The condition tested is pretty obvious and easily identifiable by the method name. Perhaps the ones that deserve some attention are<code class="literal"> assertEquals()</code> and<code class="literal"> assertSame()</code>. The former when used on objects asserts that both objects passed as parameters are equal, calling the objects'<code class="literal"> equals()</code> method. The latter asserts that both objects refer to the same object. If in some case<code class="literal"> equals()</code> is not implemented by the class, then<code class="literal"> assertEquals()</code> and<code class="literal"> assertSame()</code> will do the same thing.</p><p>When one of these assertions fails inside a test an<code class="literal"> AssertionFailedException</code> is thrown.</p><p>Occasionally, during the development process you may need to create a test that you are not implementing at that precise time. However, you want to flag that the creation of the test was postponed. We did this in<a class="link" href="ch01.html" title="Chapter 1. Getting Started with Testing"> Chapter 1</a>,<span class="emphasis"><em> Getting Started with Testing</em></span> when we added just the test method stubs. In those cases you may use the<code class="literal"> fail</code> method which always fails and use a custom message indicating the condition:</p><div class="informalexample"><pre class="programlisting">public void testNotImplementedYet() {<span class="strong"><strong>
fail("Not implemented yet");</strong></span>
}
</pre></div><p>There is another common use for<code class="literal"> fail()</code> that is worth mentioning. If we need to test if a method throws an exception we can surround the code with a try-catch block and force a fail if the exception was not thrown. For example:<a class="indexterm" id="id93"/>
</p><div class="informalexample"><pre class="programlisting">public void testShouldThrowException() {
try {
MyFirstProjectActivity.methodThatShouldThrowException();<span class="strong"><strong>
fail("Exception was not thrown");</strong></span>
} catch ( Exception ex ) {
// do nothing
}
}
</pre></div><div class="section" title="Custom messages"><div class="titlepage"><div><div><h2 class="title"><a id="ch03lvl2sec01"/>Custom messages</h2></div></div></div><p>Speaking about custom messages, it is worth knowing that all<code class="literal"> assert</code> methods provide an overloaded version including a custom<code class="literal"> String</code> message. Should the assertion fail this custom message will be printed by the test runner instead of a default message. This custom message is extremely useful for easily identifying the failure once you are looking at the test report, so it is highly recommended as a best practice to use this version.<a class="indexterm" id="id94"/>
</p><p>This is an example of a trivial test using this recommendation:</p><div class="informalexample"><pre class="programlisting">public void testMax() {
final int a = 1;
final int b = 2;
final int expected = b;
final int actual = Math.max(a, b);<span class="strong"><strong>
assertEquals("Expection " + expected + " but was " + actual,
expected, actual);</strong></span>
}
</pre></div><p>In the example we can see another practice that would help you organize and understand your tests easily. This is the use of explicit names for variables holding the expected and actual values.</p></div><div class="section" title="Static imports"><div class="titlepage"><div><div><h2 class="title"><a id="ch03lvl2sec02"/>Static imports</h2></div></div></div><p>Though basic assertion methods are inherited from the Assert base class, some other assertions need specific imports. To improve readability of your tests there is a pattern of importing the assert methods statically from the corresponding classes. Using this pattern instead of having:<a class="indexterm" id="id95"/>
</p><div class="informalexample"><pre class="programlisting">public void testAlignment() {
final int margin = 0;
...<span class="strong"><strong>
android.test.ViewAsserts.assertRightAligned( mMessage, mCapitalize, margin);</strong></span>
}
</pre></div><p>We can simplify it by adding the static import:</p><div class="informalexample"><pre class="programlisting"><span class="strong"><strong>import static android.test.ViewAsserts.assertRightAligned;
public void testAlignment() {
final int margin = 0;
assertRightAligned(mMessage, mCapitalize, margin);
}</strong></span>
</pre></div><p>Eclipse doesn't usually handle these static imports automatically, so if you want content assist (<span class="emphasis"><em>Ctrl+SPACE</em></span>) to add static imports for you when you type the beginning of one of these asserts, you should add the classes to the Favorites list in Eclipse. To do this, navigate to<span class="strong"><strong> Window | Preferences | Java | Editor | Content Assist | Favorites | New Type</strong></span>. Type in:<span class="strong"><strong> android.test.ViewAsserts</strong></span> and then add another type:<span class="strong"><strong> android.test.MoreAsserts</strong></span>.<a class="indexterm" id="id96"/>
</p><div class="mediaobject"><img alt="Static imports" src="graphics/3500_03_02.jpg"/></div></div></div>
<div class="section" title="View assertions"><div class="titlepage"><div><div><h1 class="title"><a id="ch03lvl1sec03"/>View assertions</h1></div></div></div><p>The assertions introduced earlier handle a variety of types as parameters but they are only intended to test simple conditions or simple objects.</p><p>For example, we have<code class="literal"> assertEquals(short expected, short actual)</code> to test<code class="literal"> short</code> values,<code class="literal"> assertEquals(int expected, int actual)</code> to test integer values,<code class="literal"> assertEquals(Object expected, Object actual)</code> to test any<code class="literal"> Object</code> instance, and so on.<a class="indexterm" id="id97"/>
</p><p>Usually while testing user interfaces in Android, you will face the necessity of more sophisticated methods, mainly related with<code class="literal"> Views</code>. In this respect, Android provides a class with plenty of assertions in<code class="literal"> android.test.ViewAsserts</code> (see<a class="ulink" href="http://developer.android.com/reference/android/test/ViewAsserts.html"> http://developer.android.com/reference/android/test/ViewAsserts.html</a> for details) that test the relationships between Views and their absolute and relative positions on the screen.</p><p>These methods are also overloaded to provide different conditions. Among the assertions, we can find:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><code class="literal">assertBaselineAligned:</code> Asserts that two views are aligned on their baseline, that is their baselines are on the same y location.<a class="indexterm" id="id98"/></li><li class="listitem" style="list-style-type: disc"><code class="literal">assertBottomAligned:</code> Asserts that two views are bottom aligned, that is their bottom edges are on the same y location.<a class="indexterm" id="id99"/></li><li class="listitem" style="list-style-type: disc"><code class="literal">assertGroupContains:</code> Asserts that the specified group contains a specific child once and only once.<a class="indexterm" id="id100"/></li><li class="listitem" style="list-style-type: disc"><code class="literal">assertGroupIntegrity:</code> Asserts the specified group's integrity. The children count should be &gt;= 0 and each child should be non-null.<a class="indexterm" id="id101"/></li><li class="listitem" style="list-style-type: disc"><code class="literal">assertGroupNotContains:</code> Asserts that the specified group does not contain a specific child.<a class="indexterm" id="id102"/></li><li class="listitem" style="list-style-type: disc"><code class="literal">assertHasScreenCoordinates:</code> Asserts that a view has a particular x and y position on the visible screen.<a class="indexterm" id="id103"/></li><li class="listitem" style="list-style-type: disc"><code class="literal">assertHorizontalCenterAligned:</code> Asserts that the test view is horizontally center aligned with respect to the reference view.<a class="indexterm" id="id104"/></li><li class="listitem" style="list-style-type: disc"><code class="literal">assertLeftAligned:</code> Asserts that two views are left aligned, that is their left edges are on the same x location. An optional margin can also be provided.<a class="indexterm" id="id105"/></li><li class="listitem" style="list-style-type: disc"><code class="literal">assertOffScreenAbove:</code> Asserts that the specified view is above the visible screen.<a class="indexterm" id="id106"/></li><li class="listitem" style="list-style-type: disc"><code class="literal">assertOffScreenBelow:</code> Asserts that the specified view is below the visible screen.<a class="indexterm" id="id107"/></li><li class="listitem" style="list-style-type: disc"><code class="literal">assertOnScreen:</code> Asserts that a view is on the screen.<a class="indexterm" id="id108"/></li><li class="listitem" style="list-style-type: disc"><code class="literal">assertRightAligned:</code> Asserts that two views are right-aligned, that is their right edges are on the same x location. An optional margin can also be specified.<a class="indexterm" id="id109"/></li><li class="listitem" style="list-style-type: disc"><code class="literal">assertTopAligned:</code> Asserts that two views are top-aligned, that is their top edges are on the same y location. An optional margin can also be specified.<a class="indexterm" id="id110"/></li><li class="listitem" style="list-style-type: disc"><code class="literal">assertVerticalCenterAligned:</code> Asserts that the test view is vertically center aligned with respect to the reference view.<a class="indexterm" id="id111"/></li></ul></div><p>The following example shows how you can use<code class="literal"> ViewAsserts</code> to test the user interface layout:</p><div class="informalexample"><pre class="programlisting">public void testUserInterfaceLayout() {
final int margin = 0;
final View origin = mActivity.getWindow().getDecorView();<span class="strong"><strong>
assertOnScreen(origin, mMessage);
assertOnScreen(origin, mCapitalize);
assertRightAligned(mMessage, mCapitalize, margin);</strong></span>
}
</pre></div><p>The<code class="literal"> assertOnScreen</code> method uses an origin to start looking for the requested<code class="literal"> Views</code>. In this case we are using the top-level window decor View. If for some reason you don't need to go that high in the hierarchy or if this approach is not suitable for your test, you may use another root<code class="literal"> View</code> in the hierarchy; for example<code class="literal"> View.getRootView()</code> which in our concrete example would be<code class="literal"> mMessage.getRootView().</code>
</p></div>
<div class="section" title="Even more assertions"><div class="titlepage"><div><div><h1 class="title"><a id="ch03lvl1sec04"/>Even more assertions</h1></div></div></div><p>If the assertions reviewed previously do not seem to be enough for your tests' needs, there is yet another class included in the Android framework that covers other cases. This class is<code class="literal"> MoreAsserts</code> (<a class="ulink" href="http://developer.android.com/reference/android/test/MoreAsserts.html">http://developer.android.com/reference/android/test/MoreAsserts.html</a>).</p><p>These methods are also overloaded, to support different conditions. Among these assertions we can find:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><code class="literal">assertAssignableFrom:</code> Asserts that an object is assignable to a class.<a class="indexterm" id="id112"/></li><li class="listitem" style="list-style-type: disc"><code class="literal">assertContainsRegex:</code> Asserts that an expected<code class="literal"> Regex</code> matches any substring of the specified<code class="literal"> String</code>. It fails with the specified message if it does not.<a class="indexterm" id="id113"/></li><li class="listitem" style="list-style-type: disc"><code class="literal">assertContainsInAnyOrder:</code> Asserts that the specified<code class="literal"> Iterable</code> contains precisely the elements expected, but in any order.<a class="indexterm" id="id114"/></li><li class="listitem" style="list-style-type: disc"><code class="literal">assertContainsInOrder:</code> Asserts that the specified<code class="literal"> Iterable</code> contains precisely the elements expected, in the same order.<a class="indexterm" id="id115"/></li><li class="listitem" style="list-style-type: disc"><code class="literal">assertEmpty:</code> Asserts that an<code class="literal"> Iterable</code> is empty.<a class="indexterm" id="id116"/></li><li class="listitem" style="list-style-type: disc"><code class="literal">assertEquals</code> for some<code class="literal"> Collections</code> not covered in JUnit asserts.<a class="indexterm" id="id117"/></li><li class="listitem" style="list-style-type: disc"><code class="literal">assertMatchesRegex:</code> Asserts that the specified<code class="literal"> Regex</code> exactly matches the<code class="literal"> String</code> and fails with the provided message if it does not.<a class="indexterm" id="id118"/></li><li class="listitem" style="list-style-type: disc"><code class="literal">assertNotContainsRegex:</code> Asserts that the specified<code class="literal"> Regex</code> does not match any substring of the specified String, and fails with the provided message if it does.<a class="indexterm" id="id119"/></li><li class="listitem" style="list-style-type: disc"><code class="literal">assertNotEmpty:</code> Asserts that some<code class="literal"> Collections</code> not covered in JUnit asserts are not empty.<a class="indexterm" id="id120"/></li><li class="listitem" style="list-style-type: disc"><code class="literal">assertNotMatchesRegex:</code> Asserts that the specified<code class="literal"> Regex</code> does not exactly match the specified String, and fails with the provided message if it does.<a class="indexterm" id="id121"/></li><li class="listitem" style="list-style-type: disc"><code class="literal">checkEqualsAndHashCodeMethods:</code> Utility for testing<code class="literal"> equals()</code> and<code class="literal"> hashCode()</code> results at once. Tests that<code class="literal"> equals()</code> applied to both objects matches the specified result.<a class="indexterm" id="id122"/></li></ul></div><p>This test below checks for an error during the invocation of the capitalization method called via a click on the UI button.</p><div class="informalexample"><pre class="programlisting"><span class="strong"><strong>@UiThreadTest</strong></span>
public void testNoErrorInCapitalization() {
final String msg = "this is a sample";
mMessage.setText(msg);
mCapitalize.performClick();
final String actual = mMessage.getText().toString();
final String notExpectedRegexp = "(?i:ERROR)";<span class="strong"><strong>
assertNotContainsRegex("Capitalization found error:",
notExpectedRegexp, actual);</strong></span>
}
</pre></div><p>Note that because this is a test that modifies the user interface, we must annotate it with<code class="literal"> @UiThreadTest</code>, otherwise it won't be able to alter the UI from a different thread and we will receive the following exception:</p><p>
<span class="strong"><strong>03-02 23:06:05.826: INFO/TestRunner(610): ----- begin exception -----</strong></span>
</p><p>
<span class="strong"><strong>03-02 23:06:05.862: INFO/TestRunner(610): android.view.ViewRoot$CalledFromWrongThreadException: Only the original thread that created a view hierarchy can touch its views</strong></span>.</p><p>
<span class="strong"><strong>03-02 23:06:05.862: INFO/TestRunner(610): at android.view.ViewRoot.checkThread(ViewRoot.java:2932)</strong></span>
</p><p>
<span class="strong"><strong>[...]</strong></span>
</p><p>
<span class="strong"><strong>03-02 23:06:05.862: INFO/TestRunner(610): at android.app.Instrumentation$InstrumentationThread.run(Instrumentation.java:1447)</strong></span>
</p><p>
<span class="strong"><strong>03-02 23:06:05.892: INFO/TestRunner(610): ----- end exception -----</strong></span>
</p><p>If you are not familiar with regular expressions, invest some time and visit<a class="ulink" href="http://developer.android.com/reference/java/util/regex/package-summary.html"> http://developer.android.com/reference/java/util/regex/package-summary.html</a>, it will be worth it!</p><p>In this particular case, we are looking for the word "ERROR" contained in the result with a case insensitive match (setting the flag 'i' for this purpose). That is, if for some reason capitalization didn't work in our application and it contains an error message we will detect this condition with the assertion.</p></div>
<div class="section" title="The TouchUtils class"><div class="titlepage"><div><div><h1 class="title"><a id="ch03lvl1sec05"/>The TouchUtils class</h1></div></div></div><p>Sometimes, when testing UIs, it is helpful to simulate different kinds of touch events. These touch events can be generated in many different ways but probably<code class="literal"> android.test.TouchUtils</code> is the simplest to use. This class provides reusable methods for generating touch events in test cases that are derived from<code class="literal"> InstrumentationTestCase</code>.<a class="indexterm" id="id123"/>
</p><p>Featured methods allow simulated interaction with the UI under test.<code class="literal"> TouchUtils</code> provides the infrastructure to inject the events using the correct UI or main thread, so no special handling is needed and you don't need to annotate the test using<code class="literal"> @UIThreadTest</code>.<a class="indexterm" id="id124"/>
</p><p>The mentioned methods support:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">Clicking on a View and releasing it</li><li class="listitem" style="list-style-type: disc">Tapping on a View, that is touching it and quickly releasing</li><li class="listitem" style="list-style-type: disc">Long clicking on a View</li><li class="listitem" style="list-style-type: disc">Dragging the screen</li><li class="listitem" style="list-style-type: disc">Dragging Views</li></ul></div><p>The following test represents a typical usage of<code class="literal"> TouchUtils:</code>
<a class="indexterm" id="id125"/>
</p><div class="informalexample"><pre class="programlisting">public void testListScrolling() {
mListView.scrollTo(0, 0);
TouchUtils.dragQuarterScreenUp(this, mActivity);
TouchUtils.dragQuarterScreenUp(this, mActivity);
TouchUtils.dragQuarterScreenUp(this, mActivity);
TouchUtils.dragQuarterScreenUp(this, mActivity);
TouchUtils.tapView(this, mListView);
final int expectedItemPosition = 6;
final int actualItemPosition = mListView.getFirstVisiblePosition();
assertEquals("Wrong position", expectedItemPosition, actualItemPosition);
final String expected = "Anguilla";
final String actual = mListView.getAdapter(). getItem(expectedItemPosition).toString();
assertEquals("Wrong content", actual, expected);
}
</pre></div><p>This test does the following:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem"> Repositions the list at the beginning to start from a known condition.</li><li class="listitem"> Scroll the list several times.</li><li class="listitem"> Check the first visible position to see that the list was correctly scrolled.</li><li class="listitem"> Check the content of the element to verify that it is correct.</li></ol></div><p>Even the most complex UIs can be tested in this way and it will help you detect a variety of conditions that could potentially affect the user experience.</p></div>
<div class="section" title="Mock Objects"><div class="titlepage"><div><div><h1 class="title"><a id="ch03lvl1sec06"/>Mock Objects</h1></div></div></div><p>We visited the Mock Objects provided by the Android testing framework in<a class="link" href="ch01.html" title="Chapter 1. Getting Started with Testing"> Chapter 1</a>,<span class="emphasis"><em> Getting Started with Testing</em></span> and evaluated the concerns regarding not using real objects in order to isolate our tests from the surrounding environment.<a class="indexterm" id="id126"/>
</p><p>The next chapter deals with Test Driven Development, and if we were Test Driven Development purists we may argue about the use of mock objects and be more inclined to use real ones. Martin Fowler calls these two styles the<span class="emphasis"><em> Classical</em></span> and<span class="emphasis"><em> Mockist</em></span> Test Driven Development dichotomy in his great article<span class="emphasis"><em> Mocks Aren't Stubs</em></span>. It can be read online at<a class="ulink" href="http://www.martinfowler.com/articles/mocksArentStubs.html"> http://www.martinfowler.com/articles/mocksArentStubs.html</a>.</p><p>Independent of that discussion, we are introducing here the available Mock Objects as one of the available building blocks because sometimes introducing mock objects in our tests is recommended, desirable, useful, or even unavoidable.</p><p>Android SDK provides some classes in the subpackage<code class="literal"> android.test.mock</code> to help us in this quest:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><code class="literal">MockApplication:</code> A mock implementation of the<code class="literal"> Application</code> class. All methods are non-functional and throw<code class="literal"> UnsupportedOperationException</code>.<a class="indexterm" id="id127"/></li><li class="listitem" style="list-style-type: disc"><code class="literal">MockContentProvider:</code> A mock implementation of<code class="literal"> ContentProvider</code>. All methods are non-functional and throw<code class="literal"> UnsupportedOperationException</code>.<a class="indexterm" id="id128"/></li><li class="listitem" style="list-style-type: disc"><code class="literal">MockContentResolver:</code> A mock implementation of the<code class="literal"> ContentResolver</code> class that isolates the test code from the real content system. All methods are non-functional and throw<code class="literal"> UnsupportedOperationException</code>.<a class="indexterm" id="id129"/></li><li class="listitem" style="list-style-type: disc"><code class="literal">MockContext:</code> A mock Context class. This can be used to inject other dependencies. All methods are non-functional and throw<code class="literal"> UnsupportedOperationException</code>.<a class="indexterm" id="id130"/></li><li class="listitem" style="list-style-type: disc"><code class="literal">MockCursor:</code> A mock Cursor class that isolates the test code from real Cursor implementation. All methods are non-functional and throw<code class="literal"> UnsupportedOperationException</code>.<a class="indexterm" id="id131"/></li><li class="listitem" style="list-style-type: disc"><code class="literal">MockDialogInterface:</code> A mock implementation of<code class="literal"> DialogInterface</code> class. All methods are non-functional and throw<code class="literal"> UnsupportedOperationException</code>.<a class="indexterm" id="id132"/></li><li class="listitem" style="list-style-type: disc"><code class="literal">MockPackageManager:</code> A mock implementation of<code class="literal"> PackageManager</code> class. All methods are non-functional and throw<code class="literal"> UnsupportedOperationException</code>.<a class="indexterm" id="id133"/></li><li class="listitem" style="list-style-type: disc"><code class="literal">MockResources:</code> A mock Resources class. All methods are non-functional and throw<code class="literal"> UnsupportedOperationException</code>.<a class="indexterm" id="id134"/></li></ul></div><p>As we mentioned, all of these classes have non-functional methods that throw<code class="literal"> UnsupportedOperationException</code> if used. So, if you need to use some of these methods or if you detect that your test is failing with this<code class="literal"> Exception</code>, you should extend one of these base classes and provide the required functionality.</p><div class="section" title="MockContext overview"><div class="titlepage"><div><div><h2 class="title"><a id="ch03lvl2sec03"/>MockContext overview</h2></div></div></div><p>The<code class="literal"> MockContext</code> class implements all methods in a non-functional way and throws<code class="literal"> UnsupportedOperationException</code>. So, if you forgot to implement one of the needed methods for the test case you are handling, this exception will be thrown and you can instantly detect the situation.<a class="indexterm" id="id135"/>
</p><p>This mock can be used to inject other dependencies, mocks, or monitors into the classes under test. A finer level of control can be obtained by extending this class.</p><p>Extend this class to provide your desired behavior, overriding the corresponding methods.</p><p>As we will cover next, the Android SDK provides some pre-built mock<code class="literal"> Contexts</code> that are useful in some cases.</p></div><div class="section" title="The IsolatedContext class"><div class="titlepage"><div><div><h2 class="title"><a id="ch03lvl2sec04"/>The IsolatedContext class</h2></div></div></div><p>In your tests you may find the need to isolate the<code class="literal"> Activity</code> under test to prevent interaction with other components. This can be a complete isolation, but sometimes this isolation avoids interacting with other components and for your<code class="literal"> Activity</code> to behave correctly some connection with the system is still required.<a class="indexterm" id="id136"/>
</p><p>For those cases, the Android SDK provides<code class="literal"> android.test.IsolatedContext</code>, a mock<code class="literal"> Context</code> that prevents interaction with most of the underlying system but also satisfies the needs of interacting with other packages or components like<code class="literal"> Services</code> or<code class="literal"> ContentProviders.</code>
<a class="indexterm" id="id137"/>
</p></div><div class="section" title="Alternate route to file and database operations"><div class="titlepage"><div><div><h2 class="title"><a id="ch03lvl2sec05"/>Alternate route to file and database operations</h2></div></div></div><p>In some cases, all we need is to be able to provide an alternate route to the file and database operations. For example, if we are testing the application on a real device, perhaps we don't want to affect existing files during our tests.<a class="indexterm" id="id138"/>
</p><p>Such cases can take advantage of another class that is not part of the<code class="literal"> android.test.mock</code> subpackage but of<code class="literal"> android.test</code> instead:<code class="literal"> RenamingDelegatingContext</code>.</p><p>This class lets us alter operations on files and databases by having a prefix that is specified in the constructor. All other operations are delegated to the delegating Context that you must specify in the constructor too.</p><p>Suppose our<code class="literal"> Activity</code> under test uses some files we want to control in some way, maybe introducing specialized content or a fixture to drive our tests and we don't want to or we can't use the real files. In this case we create a<code class="literal"> RenamingDelegatingContext</code> specifying a prefix; we add this prefix to the replacement file names and our unchanged<code class="literal"> Activity</code> will use them instead.</p><p>For example, if our Activity tries to access a file named<code class="literal"> birthdays.txt</code>, and we provide<code class="literal"> RenamingDelegatingContext</code> specifying the prefix "test", then this same Activity will access the file<code class="literal"> testbirthdays.txt</code> instead, when it is being tested.</p></div><div class="section" title="The MockContentResolver class"><div class="titlepage"><div><div><h2 class="title"><a id="ch03lvl2sec06"/>The MockContentResolver class</h2></div></div></div><p>The<code class="literal"> MockContentResolver</code> class implements all methods in a non-functional way and throws the exception<code class="literal"> UnsupportedOperationException</code> if you attempt to use them. The reason for this class is to isolate tests from the real content.<a class="indexterm" id="id139"/>
</p><p>Let's say your application uses a<code class="literal"> ContentProvider</code> maybe from more than one<code class="literal"> Activity</code>. You can create unit-tests for this<code class="literal"> ContentProvider</code> using<code class="literal"> ProviderTestCase2</code>, which we will be looking at shortly, and in some cases implementing a<code class="literal"> RenamingDelegatingContext</code> as previously described.</p><p>But when we try to produce functional or integration tests of our Activities against the<code class="literal"> ContentProvider</code>, it's not so evident what test case to use. The most obvious choice is<code class="literal"> ActivityInstrumentationTestCase2</code> if your functional tests mainly simulate user experience because you may need<code class="literal"> sendKeys()</code> or similar methods, which are readily available in these tests.</p><p>The first problem you may encounter then is that it's not clear where to inject a<code class="literal"> MockContentResolver</code> in your test to be able to use a test database instance or database fixture with your<code class="literal"> ContentProvider</code>. There's no way to inject a<code class="literal"> MockContext</code> either.</p><p>This problem will be solved in<a class="link" href="ch07.html" title="Chapter 7. Testing Recipes"> Chapter 7</a>,<span class="emphasis"><em> Testing Recipes</em></span> where further details are provided.</p></div></div>
<div class="section" title="The TestCase base class"><div class="titlepage"><div><div><h1 class="title"><a id="ch03lvl1sec07"/>The TestCase base class</h1></div></div></div><p>This is the base class of all other test cases in the JUnit framework. It implements the basic methods that we were analyzing in previous examples.<a class="indexterm" id="id140"/>
</p><p>
<code class="literal">TestCase</code> also implements the<code class="literal"> junit.framework.Test</code> interface.<a class="indexterm" id="id141"/>
</p><p>This is the UML class diagram of<code class="literal"> TestCase</code> and the<code class="literal"> Test</code> interface.</p><div class="mediaobject"><img alt="The TestCase base class" src="graphics/3500_03_03.jpg"/></div><p>Test cases should either extend<code class="literal"> TestCase</code> directly or one of its descendants.</p><p>There are other methods beside the ones explained before.</p><div class="section" title="The no-argument constructor"><div class="titlepage"><div><div><h2 class="title"><a id="ch03lvl2sec07"/>The no-argument constructor</h2></div></div></div><p>All test cases require a default constructor because sometimes, depending on the test runner used, this is the only constructor that is invoked. It is also used for serialization.<a class="indexterm" id="id142"/>
</p><p>According to the documentation, this method is not intended to be used by mere mortals without calling<code class="literal"> setName(String name)</code>.</p><p>A common pattern is to use a default constant test case name in this constructor and invoke the<span class="strong"><strong> Given name</strong></span> constructor afterwards.</p><div class="informalexample"><pre class="programlisting">public class MyTestCase extends TestCase {<span class="strong"><strong>
public MyTestCase() {
this("MyTestCase Default Name");
}</strong></span>
public MyTestCase(String name) {
super(name);
}
}
</pre></div></div><div class="section" title="The given name constructor"><div class="titlepage"><div><div><h2 class="title"><a id="ch03lvl2sec08"/>The given name constructor</h2></div></div></div><p>This constructor takes a name as an argument to give to the test case. It will appear in test reports and will be helpful when you try to identify failed tests.<a class="indexterm" id="id143"/>
</p></div><div class="section" title="The setName() method"><div class="titlepage"><div><div><h2 class="title"><a id="ch03lvl2sec09"/>The setName() method</h2></div></div></div><p>There are some classes extending<code class="literal"> TestCase</code> that don't provide a given name constructor. In such cases the only alternative is to call<code class="literal"> setName(String name)</code>.<a class="indexterm" id="id144"/>
</p></div></div>
<div class="section" title="The AndroidTestCase base class"><div class="titlepage"><div><div><h1 class="title"><a id="ch03lvl1sec08"/>The AndroidTestCase base class</h1></div></div></div><p>This class can be used as a base class for general purpose Android test cases.<a class="indexterm" id="id145"/>
</p><p>This is the UML class diagram of<code class="literal"> AndroidTestCase</code> and the closest related classes.</p><div class="mediaobject"><img alt="The AndroidTestCase base class" src="graphics/3500_03_04.jpg"/></div><p>Use this class when you need access to an Activity Context like Resources, databases, or files in the filesystem. Context is stored as a field in this class conveniently named<code class="literal"> mContext</code> and can be used inside the tests if needed. The<code class="literal"> getContext()</code> method can be used too.<a class="indexterm" id="id146"/>
</p><p>Tests based on this class can start more than one<code class="literal"> Activity</code> using<code class="literal"> Context.startActivity()</code>.</p><p>There are various test cases in Android SDK that extend this base class:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><code class="literal">ApplicationTestCase&lt;T extends Application&gt;</code></li><li class="listitem" style="list-style-type: disc"><code class="literal">ProviderTestCase2&lt;T extends ContentProvider&gt;</code></li><li class="listitem" style="list-style-type: disc"><code class="literal">ServiceTestCase&lt;T extends Service&gt;</code></li></ul></div><div class="section" title="The assertActivityRequiresPermission() method"><div class="titlepage"><div><div><h2 class="title"><a id="ch03lvl2sec10"/>The assertActivityRequiresPermission() method</h2></div></div></div><p>The signature for this method is as follows:<a class="indexterm" id="id147"/>
</p><div class="informalexample"><pre class="programlisting">public void assertActivityRequiresPermission (String packageName, String className, String permission)
</pre></div><div class="section" title="Description"><div class="titlepage"><div><div><h3 class="title"><a id="ch03lvl3sec01"/>Description</h3></div></div></div><p>This assertion method checks that the launching of a particular<code class="literal"> Activity</code> is protected by specific permission. It takes three parameters:<a class="indexterm" id="id148"/>
</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><code class="literal">packageName:</code> A String indicating the package name of the Activity to launch<a class="indexterm" id="id149"/></li><li class="listitem" style="list-style-type: disc"><code class="literal">className:</code> A String indicating the class of the Activity to launch<a class="indexterm" id="id150"/></li><li class="listitem" style="list-style-type: disc"><code class="literal">permission:</code> A String with the permission to query<a class="indexterm" id="id151"/></li></ul></div><p>The<code class="literal"> Activity</code> is launched and then a<code class="literal"> SecurityException</code> is expected mentioning that the required permission is missing in the error message. The Activity is not handled by this test and thus an<code class="literal"> Instrumentation</code> is not needed.</p></div><div class="section" title="Example"><div class="titlepage"><div><div><h3 class="title"><a id="ch03lvl3sec02"/>Example</h3></div></div></div><p>This test checks the requirement of the<code class="literal"> android.Manifest.permission.WRITE_EXTERNAL_STORAGE</code> permission, needed to write to external storage, in the Activity<code class="literal"> MyContactsActivity:</code>
<a class="indexterm" id="id152"/>
</p><div class="informalexample"><pre class="programlisting">public void testActivityPermission() {
final String PKG = "com.example.aatg.myfirstproject";
final String ACTIVITY = PKG + ".MyFirstProjectActivity";
final String PERMISSION = android.Manifest.permission.WRITE_EXTERNAL_STORAGE;
assertActivityRequiresPermission(PKG, ACTIVITY, PERMISSION);
}
</pre></div><div class="tip" style="margin-left: 0.5in; margin-right: 0.5in;" title="Tip"><h3 class="title"><a id="tip04"/>Tip</h3><p>Always use the constants describing the permissions from<code class="literal"> android.Manifest.permission</code>, not the<code class="literal"> Strings</code>, so if the implementation changes your code will still be valid.</p></div></div></div><div class="section" title="The assertReadingContentUriRequiresPermission method"><div class="titlepage"><div><div><h2 class="title"><a id="ch03lvl2sec11"/>The assertReadingContentUriRequiresPermission method</h2></div></div></div><p>The signature for this method is as follows:<a class="indexterm" id="id153"/>
</p><div class="informalexample"><pre class="programlisting">public void assertReadingContentUriRequiresPermission ( Uri uri, String permission)
</pre></div><div class="section" title="Description"><div class="titlepage"><div><div><h3 class="title"><a id="ch03lvl3sec03"/>Description</h3></div></div></div><p>This assertion method checks that reading from a specific URI requires the permission provided as a parameter.<a class="indexterm" id="id154"/>
</p><p>It takes two parameters:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><code class="literal">uri:</code> The URI that requires a permission to query<a class="indexterm" id="id155"/></li><li class="listitem" style="list-style-type: disc"><code class="literal">permission:</code> A String containing the permission to query<a class="indexterm" id="id156"/></li></ul></div><p>If a<code class="literal"> SecurityException</code> is generated containing the specified permission, this assertion is validated.</p></div><div class="section" title="Example"><div class="titlepage"><div><div><h3 class="title"><a id="ch03lvl3sec04"/>Example</h3></div></div></div><p>This test tries to read contacts and verifies that the correct<code class="literal"> SecurityException</code> is generated:<a class="indexterm" id="id157"/>
</p><div class="informalexample"><pre class="programlisting">public void testReadingContacts() {
final Uri URI = ContactsContract.AUTHORITY_URI;
final String PERMISSION = android.Manifest.permission.READ_CONTACTS;
assertReadingContentUriRequiresPermission(URI, PERMISSION);
}
</pre></div></div></div><div class="section" title="The assertWritingContentUriRequiresPermission() method"><div class="titlepage"><div><div><h2 class="title"><a id="ch03lvl2sec12"/>The assertWritingContentUriRequiresPermission() method</h2></div></div></div><p>The signature for this method is as follows:<a class="indexterm" id="id158"/>
</p><div class="informalexample"><pre class="programlisting">public void assertWritingContentUriRequiresPermission( Uri uri, String permission)
</pre></div><div class="section" title="Description"><div class="titlepage"><div><div><h3 class="title"><a id="ch03lvl3sec05"/>Description</h3></div></div></div><p>This assertion method checks that inserting into a specific URI requires the permission provided as a parameter.<a class="indexterm" id="id159"/>
</p><p>It takes 2 parameters:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><code class="literal">uri:</code> The URI that requires a permission to query<a class="indexterm" id="id160"/></li><li class="listitem" style="list-style-type: disc"><code class="literal">permission:</code> A String containing the permission to query<a class="indexterm" id="id161"/></li></ul></div><p>If a<code class="literal"> SecurityException</code> containing the specified permission is generated, this assertion is validated.</p></div><div class="section" title="Example"><div class="titlepage"><div><div><h3 class="title"><a id="ch03lvl3sec06"/>Example</h3></div></div></div><p>This test tries to write to Contacts and verifies that the correct<code class="literal"> SecurityException</code> is generated:<a class="indexterm" id="id162"/>
</p><div class="informalexample"><pre class="programlisting">public void testWritingContacts() {
final Uri URI = ContactsContract.AUTHORITY_URI;
final String PERMISSION = android.Manifest.permission.WRITE_CONTACTS;
assertWritingContentUriRequiresPermission(URI, PERMISSION);
}
</pre></div></div></div></div>
<div class="section" title="Instrumentation"><div class="titlepage"><div><div><h1 class="title"><a id="ch03lvl1sec09"/>Instrumentation</h1></div></div></div><p>Instrumentation is instantiated by the system before any of the application code is run, allowing it to monitor all of the interaction between the system and the application.<a class="indexterm" id="id163"/>
</p><p>As with many other Android application components, Instrumentation implementations are described in the<code class="literal"> AndroidManifest.xml</code> under the tag<code class="literal">&lt;instrumentation&gt;</code>. For example, if you open our tests'<code class="literal"> AndroidManifest.xml</code> and look inside you will find:</p><div class="informalexample"><pre class="programlisting">&lt;instrumentation
android:targetPackage="com.example.aatg.myfirstproject"
android:name="android.test.InstrumentationTestRunner"
android:label="MyFirstProject Tests"/&gt;
</pre></div><p>This is the Instrumentation declaration.</p><p>The<code class="literal"> targetPackage</code> attribute defines the name of the package under test,<code class="literal"> name</code> the name of the test runner, and<code class="literal"> label</code> the text that will be displayed when this instrumentation is listed.<a class="indexterm" id="id164"/>
</p><p>Please note as mentioned earlier, this declaration belongs to the test project and not to the main project.</p><div class="section" title="The ActivityMonitor inner class"><div class="titlepage"><div><div><h2 class="title"><a id="ch03lvl2sec13"/>The ActivityMonitor inner class</h2></div></div></div><p>As mentioned earlier, the Instrumentation class is used to monitor the interaction between the system and the application or Activities under test. The inner class<code class="literal"> Instrumentation.ActivityMonitor</code> allows monitoring of a single Activity within an application.<a class="indexterm" id="id165"/>
</p><div class="section" title="Example"><div class="titlepage"><div><div><h3 class="title"><a id="ch03lvl3sec07"/>Example</h3></div></div></div><p>Let's pretend that we have a<code class="literal"> TextField</code> in our<code class="literal"> Activity</code> that holds a URL and has its auto link property set:</p><div class="informalexample"><pre class="programlisting">&lt;TextView android:layout_width="fill_parent"
android:layout_height="wrap_content"
android:text="@string/home"
android:layout_gravity="center" android:gravity="center"
android:autoLink="web" android:id="@+id/link" /&gt;
</pre></div><p>If we want to verify that when clicked the hyperlink is correctly followed and a Brower is invoked, we can create a test like:</p><div class="informalexample"><pre class="programlisting">public void testFollowLink() {
final Instrumentation inst = getInstrumentation();
IntentFilter intentFilter = new IntentFilter( Intent.ACTION_VIEW);
intentFilter.addDataScheme("http");
intentFilter.addCategory(Intent.CATEGORY_BROWSABLE);
ActivityMonitor monitor = inst.addMonitor( intentFilter, null, false);
assertEquals(0, monitor.getHits());
TouchUtils.clickView(this, mLink);
monitor.waitForActivityWithTimeout(5000);<span class="strong"><strong>
assertEquals(1, monitor.getHits());</strong></span>
inst.removeMonitor(monitor);
}
</pre></div><p>Here, we:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem"> Get the instrumentation.</li><li class="listitem"> Add a monitor based on an<code class="literal"> IntentFilter</code>.</li><li class="listitem"> Wait for the activity.</li><li class="listitem"> Verify that the monitor hits were incremented.</li><li class="listitem"> Remove the monitor.</li></ol></div><p>Using monitors we can test even the most complex interactions with the system and other Activities. This is a very powerful tool for creating integration tests.</p></div></div></div>
<div class="section" title="The InstrumentationTestCase class"><div class="titlepage"><div><div><h1 class="title"><a id="ch03lvl1sec10"/>The InstrumentationTestCase class</h1></div></div></div><p>The<code class="literal"> InstrumentationTestCase</code> class is the direct or indirect base class for various test cases that have access to Instrumentation. This is the list of the most important direct and indirect subclasses:<a class="indexterm" id="id166"/>
</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><code class="literal">ActivityTestCase</code><a class="indexterm" id="id167"/></li><li class="listitem" style="list-style-type: disc"><code class="literal">ProviderTestCase2&lt;T extends ContentProvider&gt;</code></li><li class="listitem" style="list-style-type: disc"><code class="literal">SingleLaunchActivityTestCase&lt;T extends Activity&gt;</code></li><li class="listitem" style="list-style-type: disc"><code class="literal">SyncBaseInstrumentation</code></li><li class="listitem" style="list-style-type: disc"><code class="literal">ActivityInstrumentationTestCase2&lt;T extends Activity&gt;</code></li><li class="listitem" style="list-style-type: disc"><code class="literal">ActivityUnitTestCase&lt;T extends Activity&gt;</code></li></ul></div><p>This is the UML class diagram of<code class="literal"> InstrumentationTestCase</code> and the closest related classes:<a class="indexterm" id="id168"/>
</p><div class="mediaobject"><img alt="The InstrumentationTestCase class" src="graphics/3500_03_05.jpg"/></div><p>
<code class="literal">InstrumentationTestCase</code> is in the<code class="literal"> android.test</code> package, not shown in the image, and extends<code class="literal"> junit.framework.TestCase</code> which extends<code class="literal"> junit.framework.Assert</code>.<a class="indexterm" id="id169"/>
</p><div class="section" title="The launchActivity and launchActivityWithIntent method"><div class="titlepage"><div><div><h2 class="title"><a id="ch03lvl2sec14"/>The launchActivity and launchActivityWithIntent method</h2></div></div></div><p>These utility methods are used to launch Activities from the test. If the<code class="literal"> Intent</code> is not specified using the second option, a default<code class="literal"> Intent</code> is used:<a class="indexterm" id="id170"/>
</p><div class="informalexample"><pre class="programlisting">public final T launchActivity( String pkg, Class&lt;T&gt; activityCls, Bundle extras)
</pre></div><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;" title="Note"><h3 class="title"><a id="note07"/>Note</h3><p>Note that the template class parameter<code class="literal"> T</code> is used in<code class="literal"> activityCls</code> and as the return type, limiting its use to Activities of that type.</p></div><p>If you need to specify a custom<code class="literal"> Intent</code>, you can use the following code that also adds the<code class="literal"> intent</code> parameter:</p><div class="informalexample"><pre class="programlisting">public final T launchActivityWithIntent( String pkg, Class&lt;T&gt; activityCls, Intent intent)
</pre></div></div><div class="section" title="The sendKeys and sendRepeatedKeys methods"><div class="titlepage"><div><div><h2 class="title"><a id="ch03lvl2sec15"/>The sendKeys and sendRepeatedKeys methods</h2></div></div></div><p>When testing Activities' UI you will face the need to simulate the interaction with qwerty-based keyboards or DPAD buttons to send keys to complete fields, select shortcuts, or navigate throughout the different components.<a class="indexterm" id="id171"/>
</p><p>This is what the different<code class="literal"> sendKeys</code> and<code class="literal"> sendRepeatedKeys</code> are for.</p><p>There is one version of<code class="literal"> sendKeys</code> that accepts integer keys values. They can be obtained from constants defined in the<code class="literal"> KeyEvent</code> class.</p><p>For example, we can use the<code class="literal"> sendKeys</code> method in this way:</p><div class="informalexample"><pre class="programlisting">public void testSendKeyInts() {
try {
runTestOnUiThread(new Runnable() {
public void run() {
mMessage.requestFocus();
}
});
} catch (Throwable e) {
fail("Couldn't set focus");
}
sendKeys(KeyEvent.KEYCODE_H,
KeyEvent.KEYCODE_E,
KeyEvent.KEYCODE_E,
KeyEvent.KEYCODE_E,
KeyEvent.KEYCODE_Y,
KeyEvent.KEYCODE_ALT_LEFT,
KeyEvent.KEYCODE_1,
KeyEvent.KEYCODE_DPAD_DOWN,
KeyEvent.KEYCODE_ENTER);
final String expected = "HEEEY!";
final String actual = mMessage.getText().toString();
assertEquals(expected, actual);
}
</pre></div><p>Here, we are sending<span class="emphasis"><em> H, E</em></span>, and<span class="emphasis"><em> Y</em></span> letter keys, the exclamation mark, and then the<span class="emphasis"><em> Enter</em></span> key using their integer representations to the Activity under test.</p><p>Alternatively, we can create a String concatenating the keys we desire to send discarding the KEYCODE prefix and separating them with spaces that are ultimately ignored:<a class="indexterm" id="id172"/>
</p><div class="informalexample"><pre class="programlisting">public void testSendKeyString() {
try {
runTestOnUiThread(new Runnable() {
public void run() {
mMessage.requestFocus();
}
});
} catch (Throwable e) {
fail("Couldn't set focus");
}
sendKeys("H 3*E Y ALT_LEFT 1 DPAD_DOWN ENTER");
final String expected = "HEEEY!";
final String actual = mMessage.getText().toString();
assertEquals(expected, actual);
}
</pre></div><p>Here, we did exactly the same as the previous test but using a<code class="literal"> String</code>. Note that every key in the<code class="literal"> String</code> can be prefixed by a repeating factor followed by '*' and the key to be repeated. We used 3*E in our previous example which is the same as "E E E", three times the letter<span class="emphasis"><em> E</em></span>.</p><p>If sending repeated keys is what we need in our tests, there is also another alternative that is specifically intended for these cases:</p><div class="informalexample"><pre class="programlisting">public void testSendRepeatedKeys() {
try {
runTestOnUiThread(new Runnable() {
public void run() {
mMessage.requestFocus();
}
});
} catch (Throwable e) {
fail("Couldn't set focus");
}
sendRepeatedKeys(1, KeyEvent.KEYCODE_H,
3, KeyEvent.KEYCODE_E,
1, KeyEvent.KEYCODE_Y,
1, KeyEvent.KEYCODE_ALT_LEFT,
1, KeyEvent.KEYCODE_1,
1, KeyEvent.KEYCODE_DPAD_DOWN,
1, KeyEvent.KEYCODE_ENTER);
final String expected = "HEEEY!";
final String actual = mMessage.getText().toString();
assertEquals(expected, actual);
}
</pre></div><p>This is the same test implemented in a different manner. Each key is preceded by the repetition number.<a class="indexterm" id="id173"/>
</p></div><div class="section" title="The runTestOnUiThread helper method"><div class="titlepage"><div><div><h2 class="title"><a id="ch03lvl2sec16"/>The runTestOnUiThread helper method</h2></div></div></div><p>The<code class="literal"> runTestOnUiThread</code> method is a helper method for running portions of a test on the UI thread.<a class="indexterm" id="id174"/>
</p><p>Alternatively, as we have discussed before, to run a test on the UI thread we can annotate it with<code class="literal"> @UiThreadTest</code>.</p><p>But sometimes, we need to run only parts of the test on the UI thread because other parts of it are not suitable to run on that thread, or are using helper methods that provide the infrastructure to use that thread, like<code class="literal"> TouchUtils</code> methods.</p><p>The most common pattern is changing the focus before sending keys, so the keys are correctly sent to the objective<code class="literal"> View:</code>
</p><div class="informalexample"><pre class="programlisting">public void testCapitalizationSendingKeys() {
final String keysSequence = "T E S T SPACE M E";<span class="strong"><strong>
runTestOnUiThread(new Runnable() {
public void run() {
mMessage.requestFocus();
}
});</strong></span>
mInstrumentation.waitForIdleSync();
sendKeys(keysSequence);
TouchUtils.clickView(this, mCapitalize);
final String expected = "test me".toUpperCase();
final String actual = mMessage.getText().toString();
assertEquals(expected, actual);
}
</pre></div><p>We request the focus for the<code class="literal"> mMessage EditText</code> before waiting for the application to be idle, using<code class="literal"> Instrumentation.waitForIdleSync()</code>, and then sending the key sequence to it. Afterwards, using<code class="literal"> TouchUtils.clickView()</code>, we click the<code class="literal"> Button</code> to finally check the content of the field after the conversion.<a class="indexterm" id="id175"/>
</p></div></div>
<div class="section" title="The ActivityTestCase class"><div class="titlepage"><div><div><h1 class="title"><a id="ch03lvl1sec11"/>The ActivityTestCase class</h1></div></div></div><p>This is mainly a class holding common code for other test cases that access Instrumentation.<a class="indexterm" id="id176"/>
</p><p>You may use this class if you are implementing specific behavior for test cases and existing alternatives don't fit your requirements.</p><p>If this is not the case, you may find the following options more suitable for your requirements:<a class="indexterm" id="id177"/>
</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><code class="literal">ActivityInstrumentationTestCase2&lt;T extends Activity&gt;</code></li><li class="listitem" style="list-style-type: disc"><code class="literal">ActivityUnitTestCase&lt;T extends Activity&gt;</code></li></ul></div><p>This is the UML class diagram of<code class="literal"> ActivityTestCase</code> and the closest related classes:</p><div class="mediaobject"><img alt="The ActivityTestCase class" src="graphics/3500_03_06.jpg"/></div><p>The abstract class<code class="literal"> android.testActivityTestCase</code> extends<code class="literal"> android.test.InstrumentationTestCase</code> and serves as a base class for other different test cases, such as<code class="literal"> android.test.ActivityInstrumentationTestCase, android.test.ActivityInstrumentationTestCase2</code>, and<code class="literal"> android.test.ActivityUnitTestCase</code>.<a class="indexterm" id="id178"/>
</p><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;" title="Note"><h3 class="title"><a id="note08"/>Note</h3><p>
<code class="literal">android.test.ActivityInstrumentationTestCase</code> is a deprecated class since Android API Level 3 (Android 1.5) and should not be used in newer projects.</p></div><div class="section" title="The scrubClass method"><div class="titlepage"><div><div><h2 class="title"><a id="ch03lvl2sec17"/>The scrubClass method</h2></div></div></div><p>This is one of the protected methods in the class:<a class="indexterm" id="id179"/>
</p><div class="informalexample"><pre class="programlisting">protected void scrubClass (Class&lt;?&gt; testCaseClass)
</pre></div><p>It is invoked from the<code class="literal"> tearDown()</code> method in several test cases implementation in order to clean up class' variables that may have been instantiated as non-static inner classes avoiding the need to hold references to them.</p><p>This is in order to prevent memory leaks for large test suites.</p><p>
<code class="literal">IllegalAccessException</code> is thrown if a problem accessing these variables is found.</p></div></div>
<div class="section" title="The ActivityInstrumentationTestCase2 class"><div class="titlepage"><div><div><h1 class="title"><a id="ch03lvl1sec12"/>The ActivityInstrumentationTestCase2 class</h1></div></div></div><p>This class will probably be the one you use the most in writing Android test cases. It provides functional testing of a single<code class="literal"> Activity</code>.<a class="indexterm" id="id180"/>
</p><p>This class has access to Instrumentation and will create the<code class="literal"> Activity</code> under test using the system infrastructure by calling<code class="literal"> InstrumentationTestCase.launchActivity().</code>
</p><p>This is the UML class diagram showing<code class="literal"> ActivityInstrumentationTestCase2</code> and the closest related classes:<a class="indexterm" id="id181"/>
</p><div class="mediaobject"><img alt="The ActivityInstrumentationTestCase2 class" src="graphics/3500_03_07.jpg"/></div><p>The class<code class="literal"> android.test.ActivityInstrumentationTestCase2</code> extends<code class="literal"> android.test.ActivityTestCase</code>. This diagram also shows<code class="literal"> ActivityUnitTestCase</code>, which also extends<code class="literal"> ActivityTestCase</code>. Class template parameter T represents the Activity's class.</p><p>The<code class="literal"> Activity</code> can then be manipulated and monitored after creation.<a class="indexterm" id="id182"/>
</p><p>If you need to provide a custom Intent to start your<code class="literal"> Activity</code>, before invoking<code class="literal"> getActivity()</code> you may inject an Intent with<code class="literal"> setActivityIntent(Intent intent).</code>
</p><p>This functional test would be very useful for testing interaction through the user interface as events can be injected to simulate user behavior.</p><div class="section" title="The constructor"><div class="titlepage"><div><div><h2 class="title"><a id="ch03lvl2sec18"/>The constructor</h2></div></div></div><p>There is only one public, non deprecated constructor for this class. This is:<a class="indexterm" id="id183"/>
</p><div class="informalexample"><pre class="programlisting">ActivityInstrumentationTestCase2(Class&lt;T&gt; activityClass)
</pre></div><p>It should be invoked with an instance of the<code class="literal"> Activity</code> class for the same<code class="literal"> Activity</code> used as a class template parameter.</p></div><div class="section" title="The setUp method"><div class="titlepage"><div><div><h2 class="title"><a id="ch03lvl2sec19"/>The setUp method</h2></div></div></div><p>As we have seen before in<a class="link" href="ch01.html" title="Chapter 1. Getting Started with Testing"> Chapter 1</a>,<span class="emphasis"><em> Getting Started with Testing</em></span> the<code class="literal"> setUp</code> method is the best place to initialize the test case fields and other fixture components requiring initialization.<a class="indexterm" id="id184"/>
</p><p>This is an example showing some of the patterns that you may find repeatedly in your test cases:</p><div class="informalexample"><pre class="programlisting">protected void setUp() throws Exception {
super.setUp();
// this must be called before getActivity()
// disabling touch mode allows for sending key events
setActivityInitialTouchMode(false);
mActivity = getActivity();
mInstrumentation = getInstrumentation();
mLink = (TextView) mActivity.findViewById( com.example.aatg.myfirstproject.R.id.link);
mMessage = (EditText) mActivity.findViewById( com.example.aatg.myfirstproject.R.id.message);
mCapitalize = (Button) mActivity.findViewById(com.example. aatg.myfirstproject.R.id.capitalize);
}
</pre></div><p>We performed the following actions:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem"> Invoke the super method. This is a JUnit pattern that should be followed here to ensure correct operation.</li><li class="listitem"> Disable touch mode. This should be done before the<code class="literal"> Activity</code> is created by invoking<code class="literal"> getActivity()</code> to have some effect. It sets the initial touch mode of the<code class="literal"> Activity</code> under test to disabled. Touch mode is a fundamental Android UI concept and is discussed in<a class="ulink" href="http://developer.android.com/resources/articles/touch-mode.html"> http://developer.android.com/resources/articles/touch-mode.html</a>.</li><li class="listitem"> Start the Activity using<code class="literal"> getActivity()</code>.<a class="indexterm" id="id185"/></li><li class="listitem"> Get the instrumentation. We have access to the Instrumentation because<code class="literal"> ActivityInstrumentationTestCase2</code> extends<code class="literal"> InstrumentationTestCase</code>.</li><li class="listitem"> Find the Views and set fields. In these operations, note that the R class used is from the target package, not from the tests.</li></ol></div></div><div class="section" title="The tearDown method"><div class="titlepage"><div><div><h2 class="title"><a id="ch03lvl2sec20"/>The tearDown method</h2></div></div></div><p>Usually this method cleans up what was initialized in<code class="literal"> setUp</code>.<a class="indexterm" id="id186"/>
</p><p>In this example, we are only invoking the super method:</p><div class="informalexample"><pre class="programlisting">protected void tearDown() throws Exception {<span class="strong"><strong>
super.tearDown();</strong></span>
}
</pre></div></div><div class="section" title="The testPreconditions method"><div class="titlepage"><div><div><h2 class="title"><a id="ch03lvl2sec21"/>The testPreconditions method</h2></div></div></div><p>This method is used to check for some initial conditions to run our tests correctly.<a class="indexterm" id="id187"/>
</p><p>Despite its name, it is not guaranteed that this test is run before other tests. However, it is a good practice to collect all of the precondition tests under this custom name.</p><p>This is an example of a<code class="literal"> testPrecondition</code> test:</p><div class="informalexample"><pre class="programlisting">public void testPreconditions() {
assertNotNull(mActivity);
assertNotNull(mInstrumentation);
assertNotNull(mLink);
assertNotNull(mMessage);
assertNotNull(mCapitalize);
}
</pre></div><p>We check only for not null values, but in this case asserting this we can also be sure that the Views were found using the specific IDs and that their types were correct, otherwise they are assigned in<code class="literal"> setUp.</code>
<a class="indexterm" id="id188"/>
</p></div></div>
<div class="section" title="The ProviderTestCase2&lt;T&gt; class"><div class="titlepage"><div><div><h1 class="title"><a id="ch03lvl1sec13"/>The ProviderTestCase2&lt;T&gt; class</h1></div></div></div><p>This is a test case designed to test the<code class="literal"> ContentProvider</code> classes.<a class="indexterm" id="id189"/>
</p><p>This is the UML class diagram of<code class="literal"> ProviderTestCase2</code> and the closest related classes:<a class="indexterm" id="id190"/>
</p><div class="mediaobject"><img alt="The ProviderTestCase2&lt;T&gt; class" src="graphics/3500_03_08.jpg"/></div><p>The class<code class="literal"> android.test.ProviderTestCase2</code> also extends<code class="literal"> AndroidTestCase</code>. Class template parameter T represents the<code class="literal"> ContentProvider</code> under test. Implementation of this test uses an<code class="literal"> IsolatedContext</code> and a<code class="literal"> MockContentResolver</code>, mock objects that we described earlier in this chapter.</p><div class="section" title="The constructor"><div class="titlepage"><div><div><h2 class="title"><a id="ch03lvl2sec22"/>The constructor</h2></div></div></div><p>There is only one public, non deprecated constructor for this class. This is:<a class="indexterm" id="id191"/>
</p><div class="informalexample"><pre class="programlisting">ProviderTestCase2(Class&lt;T&gt; providerClass, String providerAuthority)
</pre></div><p>It should be invoked with an instance of the<code class="literal"> ContentProvider</code> class for the same<code class="literal"> ContentProvider</code> used as a class template parameter.</p><p>The second parameter is the authority for the provider, usually defined as<code class="literal"> AUTHORITY</code> constant in the<code class="literal"> ContentProvider</code> class.</p></div><div class="section" title="Example"><div class="titlepage"><div><div><h2 class="title"><a id="ch03lvl2sec23"/>Example</h2></div></div></div><p>This is a typical example of a<code class="literal"> ContentProvider</code> test:<a class="indexterm" id="id192"/>
</p><div class="informalexample"><pre class="programlisting">public void testQuery() {
Uri uri = Uri.withAppendedPath( MyProvider.CONTENT_URI, "dummy");
final Cursor c = mProvider.query(uri, null, null, null, null);
final int expected = 2;
final int actual = c.getCount();
assertEquals(expected, actual);
}
</pre></div><p>In this test we are expecting the query to return a<code class="literal"> Cursor</code> containing 2 rows. This is just an example—use the number of rows that applies for your particular case, and asserting this condition.</p><p>Usually in the<code class="literal"> setUp</code> method we obtain a reference to the provider,<code class="literal"> mProvider</code> in this example, using<code class="literal"> getProvider()</code>.</p><p>What is interesting to note is that because these tests are using<code class="literal"> MockContentResolver</code> and<code class="literal"> IsolatedContext</code>, the content of the real database is not affected and we can also run tests like this one:</p><div class="informalexample"><pre class="programlisting">public void testDelete() {
Uri uri = Uri.withAppendedPath( MyProvider.CONTENT_URI, "dummy");
final int actual = mProvider.delete( uri, "_id = ?", new String[] { "1" });
final int expected = 1;
assertEquals(expected, actual);
}
</pre></div><p>This test deletes some content of the database, but the database is restored to its initial content so as not to affect other tests.</p></div></div>
<div class="section" title="The ServiceTestCase&lt;T&gt;"><div class="titlepage"><div><div><h1 class="title"><a id="ch03lvl1sec14"/>The ServiceTestCase&lt;T&gt;</h1></div></div></div><p>This is a test case specially created to test Services.<a class="indexterm" id="id193"/>
</p><p>This class,<code class="literal"> ServiceTestCase&lt;T&gt;</code>, extends<code class="literal"> AndroidTestCase</code> as is shown in this UML class diagram:<a class="indexterm" id="id194"/>
</p><div class="mediaobject"><img alt="The ServiceTestCase&lt;T&gt;" src="graphics/3500_03_09.jpg"/></div><p>Methods to exercise the service lifecycle like<code class="literal"> setupService, startService, bindService</code>, and<code class="literal"> shutDownService</code> are also included in this class.<a class="indexterm" id="id195"/>
</p><div class="section" title="The constructor"><div class="titlepage"><div><div><h2 class="title"><a id="ch03lvl2sec24"/>The constructor</h2></div></div></div><p>There is only one public, non deprecated constructor for this class. This is:<a class="indexterm" id="id196"/>
</p><div class="informalexample"><pre class="programlisting">ServiceTestCase(Class&lt;T&gt; serviceClass)
</pre></div><p>It should be invoked with an instance of the<code class="literal"> Service</code> class for the same<code class="literal"> Service</code> used as a class template parameter.</p></div></div>
<div class="section" title="The TestSuiteBuilder.FailedToCreateTests class"><div class="titlepage"><div><div><h1 class="title"><a id="ch03lvl1sec15"/>The TestSuiteBuilder.FailedToCreateTests class</h1></div></div></div><p>The class<code class="literal"> TestSuiteBuilder.FailedToCreateTests</code> is a special<code class="literal"> TestCase</code> used to indicate a failure during the<code class="literal"> build()</code> step.<a class="indexterm" id="id197"/>
</p><p>That is, if during the test suite creation an error is detected, you will be receiving an exception like this one indicating the failure to construct the test suite:</p><div class="informalexample"><pre class="programlisting"><span class="strong"><strong>
01-02 06:31:26.656: INFO/TestRunner(4569): java.lang.RuntimeException: Exception during suite construction
01-02 06:31:26.656: INFO/TestRunner(4569): at android.test.suitebuilder.TestSuiteBuilder$FailedToCreateTests.testSuiteConstructionFailed(TestSuiteBuilder.java:239)
01-02 06:31:26.656: INFO/TestRunner(4569): at java.lang.reflect.Method.invokeNative(Native Method)
[...]
01-02 06:31:26.656: INFO/TestRunner(4569): at android.test.InstrumentationTestRunner.onStart(InstrumentationTestRunner.java:520)
01-02 06:31:26.656: INFO/TestRunner(4569): at android.app.Instrumentation$InstrumentationThread.run(Instrumentation.java:1447)</strong></span>
</pre></div></div>
<div class="section" title="Using external libraries in test projects"><div class="titlepage"><div><div><h1 class="title"><a id="ch03lvl1sec16"/>Using external libraries in test projects</h1></div></div></div><p>Your main Android project may require external libraries. Let's pretend that in one<code class="literal"> Activity</code> we are creating objects from a class that is part of an external library. For the sake of our example, let's say the library is called<code class="literal"> libdummy-0.0.1-SNAPSHOT.jar</code> and the mentioned class is<code class="literal"> Dummy</code>. A dummy class that doesn't do anything is used here only to not divert your attention from the main objective which is including any library you may need, not just a particular one.<a class="indexterm" id="id198"/>
</p><p>So our<code class="literal"> Activity</code> would look like this:</p><div class="informalexample"><pre class="programlisting">package com.example.aatg.myfirstproject;<span class="strong"><strong>
import com.example.libdummy.Dummy;</strong></span>
import android.app.Activity;
import android.os.Bundle;
import android.view.View;
import android.view.View.OnClickListener;
import android.widget.Button;
import android.widget.EditText;
public class MyFirstProjectActivity extends Activity {
private EditText mMessage;
private Button mCapitalize;
private Dummy mDummy;
/** Called when the activity is first created. */
@Override
public void onCreate(Bundle savedInstanceState) {
super.onCreate(savedInstanceState);
setContentView(R.layout.main);
mMessage = (EditText) findViewById(R.id.message);
mCapitalize = (Button) findViewById(R.id.capitalize);
mCapitalize.setOnClickListener(new OnClickListener() {
public void onClick(View v) {
mMessage.setText(mMessage.getText().toString(). toUpperCase());
}
});<span class="strong"><strong>
mDummy = new Dummy();</strong></span>
}
public static void methodThatShouldThrowException() throws Exception {
throw new Exception("This is an exception");
}<span class="strong"><strong>
public Dummy getDummy() {
return mDummy;
}</strong></span>
}
</pre></div><p>This library should be added to the project's Java Build Path as usual as a JAR or external JAR depending on where the file is located.</p><p>Now, let's create a simple test. From our previous experience, we know that if we need to test an<code class="literal"> Activity</code> we should use<code class="literal"> ActivityInstrumentationTestCase2</code>, and this is precisely what we will do. Our simple test will be:<a class="indexterm" id="id199"/>
</p><div class="informalexample"><pre class="programlisting">public void testDummy() {
assertNotNull(mActivity.getDummy());
}
</pre></div><p>Unfortunately, this test won't compile. The problem is that we are referencing a missing class. Our test project doesn't know anything about<code class="literal"> Dummy</code> class or the<code class="literal"> libdummy</code> library and hence we receive this error:</p><p>
<span class="strong"><strong>The method getDummy() from the type DummyActivity refers to the missing type Dummy</strong></span>.</p><p>Lets add the<code class="literal"> libdummy</code> library to the test project's properties using the<span class="strong"><strong> Add External JARs..</strong></span>. button:</p><div class="mediaobject"><img alt="Using external libraries in test projects" src="graphics/3500_03_10.jpg"/></div><p>However, doing this will lead us to another error. If you run the tests, these are the errors you'll receive:</p><p>
<span class="strong"><strong>08-10 00:26:11.820: ERROR/AndroidRuntime(510): FATAL EXCEPTION: main</strong></span>
</p><p>
<span class="strong"><strong>08-10 00:26:11.820: ERROR/AndroidRuntime(510): java.lang.IllegalAccessError: Class ref in pre-verified class resolved to unexpected implementation</strong></span>
</p><p>
<span class="strong"><strong>...[lines removed for brevity]</strong></span>
</p><p>
<span class="strong"><strong>08-10 00:26:11.820: ERROR/AndroidRuntime(510): at com.android.internal.os.ZygoteInit$MethodAndArgsCaller.run(ZygoteInit.java:868)</strong></span>
</p><p>
<span class="strong"><strong>08-10 00:26:11.820: ERROR/AndroidRuntime(510): at com.android.internal.os.ZygoteInit.main(ZygoteInit.java:626)</strong></span>
</p><p>
<span class="strong"><strong>08-10 00:26:11.820: ERROR/AndroidRuntime(510): at dalvik.system.NativeStart.main(Native Method)</strong></span>
</p><p>The reason for this problem is that adding the library to both projects results in the same classes being inserted into both APKs. The tester project, however, loads classes from the tested project. The classes in the library will be loaded from the tester project but the classes in the tested project will refer to the copies in the tested project's APK. Hence the reference error.<a class="indexterm" id="id200"/>
</p><p>The way to solve this problem is to export the<code class="literal"> libdummy</code> entry to dependent projects and remove the JAR from the test project Java Build Path.</p><p>The following screenshot shows how to do this in the main project's properties:</p><div class="mediaobject"><img alt="Using external libraries in test projects" src="graphics/3500_03_11.jpg"/></div><p>Note that<code class="literal"> libdummy-0.0.1-SNAPSHOT.jar</code> is now checked in<span class="strong"><strong> Order and Export</strong></span>.</p></div>
<div class="section" title="Summary"><div class="titlepage"><div><div><h1 class="title"><a id="ch03lvl1sec17"/>Summary</h1></div></div></div><p>We investigated the most relevant building blocks and reusable patterns for creating our tests. Along this journey we:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">Used several types of assertions from the most common ones found usually in JUnit tests to the most specialized assertions found in the Android SDK to exercise application UIs</li><li class="listitem" style="list-style-type: disc">Explained mock objects and their use in Android tests</li><li class="listitem" style="list-style-type: disc">Exemplified the use of the different tests available in the Android SDK from unit to functional tests</li><li class="listitem" style="list-style-type: disc">Illustrated the relationships between the most common classes using UML class diagrams to clearly understand them</li><li class="listitem" style="list-style-type: disc">Dug into Instrumentation and different monitors available for Activities</li></ul></div><p>Now that we have all the building blocks it is time to start creating more and more tests to acquire the experience needed to master the technique.</p><p>The next chapter introduces Test Driven Development using a sample project to expose all of its advantages.</p></div></body></html>