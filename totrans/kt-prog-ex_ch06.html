<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml" xmlns:epub="http://www.idpf.org/2007/ops" xmlns:m="http://www.w3.org/1998/Math/MathML" xmlns:pls="http://www.w3.org/2005/01/pronunciation-lexicon" xmlns:ssml="http://www.w3.org/2001/10/synthesis">
<head>
  <meta charset="UTF-8"/>
  <title>Building the Messenger Android App – Part II</title>
  <link type="text/css" rel="stylesheet" media="all" href="style.css"/>
  <link type="text/css" rel="stylesheet" media="all" href="core.css"/>
</head>
<body>
  <div id="sbo-rt-content"><section>

                            <header>
                    <h1 class="header-title">Building the Messenger Android App – Part II</h1>
                </header>
            
            <article>
                
<p class="mce-root">In the previous chapter, we went full steam ahead with the development of the Messenger Android application. By doing so, we examined&#160;<span>both Kotlin and Android application development in depth. We explored the <strong>Model-View-Presenter</strong> (<strong>MVP</strong>) pattern and how to use it to build powerful and fully functional Android applications. In addition to this, we covered the basics of Reactive programming and learned how to use RxJava and RxAndroid in our applications. We also learned about some of the available means by which we can communicate with a remote server. We learned about OkHttp and Retrofit, and then went one step further by implementing a fully functional Retrofit service to facilitate communication with the messenger API that we made in <a href="kt-prog-ex_ch04.html">Chapter 4</a>, <em>Designing and Implementing the Messenger Backend with Spring Boot 2.0</em>. Putting all this knowledge pertaining to Android and Kotlin together, we created both a login and signup user interface for the Messenger app.</span></p>
<p>In this chapter, we will finish the development of the Messenger app. In the process of doing so, we will cover the following topics:</p>
<ul>
<li>Working with application settings</li>
<li>Working with ChatKit</li>
<li>Android application testing</li>
<li>Performing background tasks</li>
</ul>
<p>Let's continue the development of our Messenger app by implementing the Main UI.</p>


            </article>

            
        </section>
    </div>


  <div id="sbo-rt-content"><section>

                            <header>
                    <h1 class="header-title">Creating the Main UI</h1>
                </header>
            
            <article>
                
<p class="p1"><span class="s1">Similar to what we have done in implementing the Login UI and SignUp UI, we will create a model, view, and presenter for the Main UI. We are not going to focus as much on explanations as we did in the process of implementing the previous two UI views. Instead, only new concepts will be explained.</span></p>
<p class="p1"><span class="s1">Without further ado, let's create a <kbd>MainView</kbd>.</span></p>


            </article>

            
        </section>
    </div>


  <div id="sbo-rt-content"><section>

                            <header>
                    <h1 class="header-title">Creating the MainView</h1>
                </header>
            
            <article>
                
<p class="p1"><span class="s1">Before we proceed with creating the main view, it is imperative that we have a clear understanding of the user interface that we want to implement. A good place to start is to clearly write out sentences that describe how we want the <kbd>MainView</kbd> to function. Let's go ahead and do that:</span></p>
<ul>
<li class="li1"><span class="s1">The main view should display the active conversations of the currently logged-in user upon launch</span></li>
<li class="li1"><span class="s1">The main view should allow a logged-in user to create a new conversation</span></li>
<li class="li1"><span class="s1">The main view should be able to show the contacts of a currently logged-in user (in the case of this application, this is a list of all the registered users on the Messenger platform)</span></li>
<li class="li1"><span class="s1">A user must be able to access the settings screen directly from the<span>&#160;</span><kbd>MainView</kbd></span></li>
<li class="li1"><span class="s1">A user should be able to log out of the application directly from the<span>&#160;</span><kbd>MainView</kbd></span></li>
</ul>
<p class="p1"><span class="s1">All right, great! We have our list of brief statements describing what the<span>&#160;</span><kbd>MainView</kbd><span>&#160;</span>can do. With this list, it is possible to get on with creating the<span>&#160;</span><kbd>MainView</kbd><span>&#160;</span>(in terms of programming, that is). We are not going to do this yet. Let's create a few visual sketches of <kbd>MainView</kbd> to give us a clearer&#160;idea of how it will look:</span></p>
<div class="CDPAlignCenter CDPAlign"><img src="images/48cec2cb-c814-47c5-b74c-ae97f62c8528.jpg" style="width:47.67em;height:25.83em;"/></div>
<p class="p1"><span class="s1">As can be seen from the preceding diagram,<span>&#160;</span><kbd>MainActivity</kbd><span>&#160;</span>can render two completely separate views to a user. The first view is the <span class="packt_screen">Conversations Screen</span> and the second the C<span class="packt_screen">ontacts Screen</span>. A perfect way to implement this is to employ two use fragments within the<span>&#160;</span><kbd>MainActivity</kbd>. In this case, we will require two distinct fragments. These are the conversations fragment and the contacts fragment.</span></p>
<p class="p1"><span class="s1">Now that we have a clear idea of what the<span>&#160;</span><kbd>MainView</kbd><span>&#160;</span>is going to contain, we need to implement a proper interface to declare the behaviors of the<span>&#160;</span><kbd>MainView</kbd>. The following is the<span>&#160;</span><kbd>MainView</kbd><span>&#160;</span>interface:</span></p>
<pre><span>package </span>com.example.messenger.ui.main<br/><span>import </span>com.example.messenger.ui.base.BaseView<br/><br/><span>interface </span>MainView : BaseView {<br/>  <span>fun </span><span>showConversationsLoadError</span>()<br/>  <span>fun </span><span>showContactsLoadError</span>()<br/>  <span>fun </span><span>showConversationsScreen</span>()<br/>  <span>fun </span><span>showContactsScreen</span>()<br/>  <span>fun </span><span>getContactsFragment</span>(): MainActivity.ContactsFragment<br/>  <span>fun </span><span>getConversationsFragment</span>(): MainActivity.ConversationsFragment<br/>  <span>fun </span><span>showNoConversations</span>()<br/>  <span>fun </span><span>navigateToLogin</span>()<br/>  <span>fun </span><span>navigateToSettings</span>()<br/>}</pre>
<p class="p1"><span class="s1">Great work! We will save the implementation of the<span>&#160;</span><kbd>MainView</kbd><span>&#160;</span>by<span>&#160;</span><kbd>MainActivity</kbd><span>&#160;</span>for later. For now, we will work on the<span>&#160;</span><kbd>MainInteractor</kbd>.</span></p>


            </article>

            
        </section>
    </div>


  <div id="sbo-rt-content"><section>

                            <header>
                    <h1 class="header-title">Creating the MainInteractor</h1>
                </header>
            
            <article>
                
<p class="p1"><span class="s1">We want the user to be able to view other users (contacts) on the Messenger platform and view their active conversations on the main screen. In addition to this, we want a user to be able to log out of the platform directly from the main screen. As a result of these requirements,<span>&#160;</span><kbd>MainInteractor</kbd><span>&#160;</span>must be capable of loading contacts, loading conversations, and logging the user out of the platform. The following is the<span>&#160;</span><kbd>MainInteractor</kbd><span>&#160;</span>interface. Ensure to put it and all other<span>&#160;</span><kbd>Main_</kbd><span>&#160;</span>files in the <kbd>com.example.messenger.ui.main</kbd> package:</span></p>
<pre><span>package </span>com.example.messenger.ui.main<br/><br/><span>import </span>com.example.messenger.data.vo.ConversationListVO<br/><span>import </span>com.example.messenger.data.vo.UserListVO<br/><span><br/></span><span>interface </span>MainInteractor {<br/><br/>  <span>interface </span>OnConversationsLoadFinishedListener {<br/>    <span>fun </span><span>onConversationsLoadSuccess</span>(<br/>    conversationsListVo: ConversationListVO)<br/><br/>      <span>fun </span><span>onConversationsLoadError</span>()<br/>  }<br/><br/>  <span>interface </span>OnContactsLoadFinishedListener {<br/>    <span>fun </span><span>onContactsLoadSuccess</span>(userListVO: UserListVO)<br/>    <span>fun </span><span>onContactsLoadError</span>()<br/>  }<br/><br/>  <span>interface </span>OnLogoutFinishedListener {<br/>    <span>fun </span><span>onLogoutSuccess</span>()<br/>  }<br/><br/>  <span>fun </span><span>loadContacts</span>(<br/>  listener: MainInteractor.OnContactsLoadFinishedListener)<br/><br/>  <span>fun </span><span>loadConversations</span>(<br/>  listener: MainInteractor.OnConversationsLoadFinishedListener)<br/><br/>  <span>fun </span><span>logout</span>(listener: MainInteractor.OnLogoutFinishedListener)<br/>}</pre>
<p class="p1"><span class="s1">We added&#160;the <kbd>OnConversationsLoadFinishedListener</kbd>, <kbd>OnContactsLoadFinishedListener</kbd>, and <kbd>OnLogoutFinishedListener</kbd>&#160;</span><span class="s1">interfaces to the<span>&#160;</span><kbd>MainInteractor</kbd><span>&#160;</span>interface. These are all interfaces that will be implemented by a<span>&#160;</span><kbd>MainPresenter</kbd>. These callbacks are necessary for the presenter to perform appropriate actions regardless of the success or failure of a conversation load, contact load, or user logout process.</span></p>
<p class="p1"><span class="s1">The<span>&#160;</span><kbd>MainInteractorImpl</kbd><span>&#160;class with an implemented <kbd>loadContacts()</kbd> method is given below</span>:</span></p>
<pre><span>package </span>com.example.messenger.ui.main<br/><br/><span>import </span>android.content.Context<br/><span>import </span>android.util.Log<br/><span>import </span>com.example.messenger.data.local.AppPreferences<br/><span>import </span>com.example.messenger.data.remote.repository.ConversationRepository<br/><span>import </span>com.example.messenger.data.remote.repository.ConversationRepositoryImpl<br/><span>import </span>com.example.messenger.data.remote.repository.UserRepository<br/><span>import </span>com.example.messenger.data.remote.repository.UserRepositoryImpl<br/><span>import </span>io.reactivex.android.schedulers.AndroidSchedulers<br/><span>import </span>io.reactivex.schedulers.Schedulers<br/><span><br/></span><span>class </span>MainInteractorImpl(<span>val </span><span>context</span>: Context) : MainInteractor {<br/><br/>  <span>private val </span><span>userRepository</span>: UserRepository = <br/>  UserRepositoryImpl(<span>context</span>)<br/>  <span>private val </span><span>conversationRepository</span>: ConversationRepository = <br/>  ConversationRepositoryImpl(<span>context</span>)<br/>  <br/>  <span>override fun </span><span>loadContacts</span>(listener: <br/>  MainInteractor.OnContactsLoadFinishedListener) {<br/>    </pre>
<p><span>Let's load all users registered on the Messenger API platform.&#160;</span><span>These users are contacts that can be communicated with by&#160;</span><span>the currently logged in user:</span></p>
<pre><span>    </span><span>userRepository</span>.all()<br/>    .subscribeOn(Schedulers.io())<br/>    .observeOn(AndroidSchedulers.mainThread())<br/>    .subscribe(<span>{ </span>res <span>-&gt;</span><span>      </span></pre>
<p><span>Now, the contacts were loaded successfully.</span> <span><kbd>onContactsLoadSuccess()</kbd> is called with the API response</span> <span>data passed as an argument:</span></p>
<pre><span>    </span>listener.onContactsLoadSuccess(res) <span>}</span><span>,<br/></span><span>    </span><span>{ </span>error <span>-&gt;</span><span>      </span></pre>
<p class="mce-root"><span>If the contact load failed, hence, <kbd>onContactsLoadError()</kbd></span> <span>is called:</span></p>
<pre><span>      </span>listener.onContactsLoadError()<br/>    error.printStackTrace()<span>}</span>)<br/>  }<br/>}</pre>
<p><kbd>loadContacts()</kbd> makes use of <kbd>UserRepository</kbd> to load a list of all available users on the messenger platform. If the users were successfully retrieved, the listener's <kbd>onContactsLoadSuccess()</kbd> is invoked with the list of the users loaded passed as an argument. Otherwise, <kbd>onContactsLoadError()</kbd>&#160;<span>is invoked&#160;</span>and the error is printed to the standard system output .</p>
<p>We are not done with <kbd>MainInteractorImpl</kbd> yet. We must still add functions for <kbd>loadConversations()</kbd> and <kbd>logout()</kbd>. These two&#160;<span>required&#160;</span>functions are given in the following code snippet. Add them to <kbd>MainInteractorImpl</kbd>.</p>
<pre>  <span>override fun </span><span>loadConversations</span>(<br/>  listener: MainInteractor.OnConversationsLoadFinishedListener) {</pre>
<p><span>It retrieves all conversations of the currently logged in user&#160;</span><span>using conversational repository instance:</span></p>
<pre><span>    </span><span>conversationRepository</span>.all()<br/>    .subscribeOn(Schedulers.io())<br/>    .observeOn(AndroidSchedulers.mainThread())<br/>    .subscribe(<span>{ </span>res <span>-&gt; </span>listener.onConversationsLoadSuccess(res) <span>}</span><span>,<br/></span><span>    </span><span>{ </span>error <span>-&gt;<br/></span><span>      </span>listener.onConversationsLoadError()<br/>    error.printStackTrace()<span>}</span>)<br/>  }<br/><br/>  <span>override fun </span><span>logout</span>(<br/>  listener: MainInteractor.OnLogoutFinishedListener) {    </pre>
<p><span>When login out clear user data from shared preferences file and invokes listener's</span> <kbd>onLogoutSuccess()</kbd> callback:<span><br/></span></p>
<pre><span>  </span><span>val </span>preferences: AppPreferences = AppPreferences.create(<span>context</span>)<br/>  preferences.clear()<br/>  listener.onLogoutSuccess()<br/>}</pre>
<p><kbd>loadConversations()</kbd> works similarly to <kbd>loadContacts()</kbd>. The difference being that <kbd>ConversationRepository</kbd> is being used to retrieve active conversations that the user currently has instead of a list of contacts. <kbd>logout()</kbd> simply clears the preferences file used by the application to remove the currently logged in user's data, after which the <kbd>onLogoutSuccess()</kbd> method of the provided <kbd>OnLogoutFinishedListener</kbd> invoked.&#160;</p>
<p class="p1"><span class="s1">That's all for the<span>&#160;</span><kbd>MainInteractorImpl</kbd><span>&#160;</span>class. Next on our agenda is the implementation of the<span>&#160;</span><kbd>MainPresenter</kbd>.</span></p>


            </article>

            
        </section>
    </div>


  <div id="sbo-rt-content"><section>

                            <header>
                    <h1 class="header-title">Creating the MainPresenter</h1>
                </header>
            
            <article>
                
<p class="p1"><span class="s1">As always, the first thing we must do is create a presenter interface that defines functions to be implemented by a presenter implementation class. The following is the <kbd>MainPresenter</kbd> interface:</span></p>
<pre><span>package </span>com.example.messenger.ui.main<br/><span><br/></span><span>interface </span>MainPresenter {<br/>  <span>fun </span><span>loadConversations</span>()<br/>  <span>fun </span><span>loadContacts</span>()<br/>  <span>fun </span><span>executeLogout</span>()<br/>}</pre>
<p class="p1"><span class="s1">The <kbd>loadConversations()</kbd>,<span>&#160;</span><kbd>loadContacts()</kbd><span>,&#160;</span>and<span>&#160;</span><kbd>executeLogout()</kbd><span>&#160;</span>functions will be invoked by the<span>&#160;</span><kbd>MainView</kbd><span>&#160;</span>and must be implemented by the<span>&#160;</span><kbd>MainPresenterImpl</kbd><span>&#160;</span>class. Our<span>&#160;</span><kbd>MainPresenterImpl</kbd><span>&#160;</span>class with its defined properties, and <kbd>onConversationsLoadSuccess()</kbd> and <kbd>onConversationsLoadError()</kbd> methods is given as follows:</span></p>
<pre><span>package </span>com.iyanuadelekan.messenger.ui.main<br/><br/><span>import </span>com.iyanuadelekan.messenger.data.vo.ConversationListVO<br/><span>import </span>com.iyanuadelekan.messenger.data.vo.UserListVO<br/><span><br/></span><span>class </span>MainPresenterImpl(<span>val </span><span>view</span>: MainView) : MainPresenter<span>, <br/></span>        MainInteractor.OnConversationsLoadFinishedListener<span>,<br/></span><span>        </span>MainInteractor.OnContactsLoadFinishedListener<span>,<br/>        </span>MainInteractor.OnLogoutFinishedListener {<br/><br/>  <span>private val </span><span>interactor</span>: MainInteractor = MainInteractorImpl<br/>                                           (<span>view</span>.getContext())<br/><br/>  <span>override fun </span><span>onConversationsLoadSucces</span><span>s</span>(conversationsListVo:<br/>                                          ConversationListVO) {</pre>
<p><span>Let's check if currently logged in user has active conversations:</span></p>
<pre><span>    </span><span>if </span>(!conversationsListVo.<span>conversations</span>.isEmpty()) {<br/>      <span>val </span>conversationsFragment = <span>view</span>.getConversationsFragment()<br/>      <span>val </span>conversations = conversationsFragment.<span>conversations<br/></span><span>      </span><span>val </span>adapter = conversationsFragment.<span>conversationsAdapter<br/></span><span><br/></span><span>      </span>conversations.clear()<br/>      adapter.notifyDataSetChanged()  </pre>
<p><span>After retrieving conversations from API, we add each conversation&#160;</span><span>to <kbd>ConversationFragment</kbd>'s conversations list and c</span><span>onversations adapter is notified after every item addition:</span></p>
<pre><span>      </span>conversationsListVo.<span>conversations</span>.<span>forEach </span><span>{ </span>contact <span>-&gt;<br/></span><span>        </span>conversations.add(contact)<br/>        adapter.notifyItemInserted(conversations.<span>size </span>- <span>1</span>)<br/>      <span>}<br/></span><span>    </span>} <span>else </span>{<br/>      <span>view</span>.showNoConversations()<br/>    }<br/>  }<br/><br/>  <span>override fun </span><span>onConversationsLoadError</span>() {<br/>    <span>view</span>.showConversationsLoadError()<br/>  }<br/>}</pre>
<p>In addition, add the&#160;<kbd>onContactsLoadSuccess()</kbd>, <kbd>onContactsLoadError()</kbd>&#160;, <kbd>onLogoutSuccess()</kbd>, <kbd>loadConversations()</kbd>, <kbd>loadContacts()</kbd> and <kbd>executeLogout()</kbd> functions given below to <kbd>MainPresenterImpl</kbd>:</p>
<pre>  <span>override fun </span><span>onContactsLoadSuccess</span>(userListVO: UserListVO) {<br/>    <span>val </span>contactsFragment = <span>view</span>.getContactsFragment()<br/>    <span>val </span>contacts = contactsFragment.<span>contacts<br/></span><span>    </span><span>val </span>adapter = contactsFragment.<span>contactsAdapter</span></pre>
<p><span>Let's clear previously loaded contacts in contacts list</span> <span>and notify adapter pf data set change:</span></p>
<pre>contacts.clear()<br/>adapter.notifyDataSetChanged()</pre>
<p><span>Now, let's add each contact retrieved from API to <kbd>ContactsFragment</kbd>'s&#160;</span><span>contacts list and c</span><span>ontacts adapter is notified after every item addition:</span></p>
<pre><span>    </span>userListVO.<span>users</span>.<span>forEach </span><span>{ </span>contact <span>-&gt;<br/></span><span>      </span>contacts.add(contact)<br/>      contactsFragment.<span>contactsAdapter</span>.notifyItemInserted(contacts.<span>size</span>-<span>1</span>)<br/>    <span>}<br/></span><span>  </span>}<br/><br/>  <span>override fun </span><span>onContactsLoadError</span>() {<br/>    <span>view</span>.showContactsLoadError()<br/>  }<br/><br/>  <span>override fun </span><span>onLogoutSuccess</span>() {<br/>    <span>view</span>.navigateToLogin()<br/>  }<br/><br/>  <span>override fun </span><span>loadConversations</span>() {<br/>    <span>interactor</span>.loadConversations(<span>this</span>)<br/>  }<br/><br/>  <span>override fun </span><span>loadContacts</span>() {<br/>    <span>interactor</span>.loadContacts(<span>this</span>)<br/>  }<br/><br/>  <span>override fun </span><span>executeLogout</span>() {<br/>    <span>interactor</span>.logout(<span>this</span>)<br/>  }</pre>
<p class="p1"><span class="s1">We have successfully created our<span>&#160;</span><kbd>MainInteractor</kbd>&#160;and<span>&#160;</span><kbd>MainPresenter</kbd>. At this point, it is time to finish up our work on the<span>&#160;</span><kbd>MainView</kbd><span>&#160;</span>and its layouts.</span></p>


            </article>

            
        </section>
    </div>


  <div id="sbo-rt-content"><section>

                            <header>
                    <h1 class="header-title">Wrapping up the MainView</h1>
                </header>
            
            <article>
                
<p class="p1"><span class="s1">First and foremost, we must work on the<span>&#160;</span><kbd>activity_main.xml</kbd><span>&#160;</span>layout file. Modify the file to contain the following code:</span></p>
<pre><span>&lt;?</span><span>xml version=</span><span>"1.0" </span><span>encoding=</span><span>"utf-8"</span><span>?&gt;<br/></span><span>&lt;android.support.design.widget.CoordinatorLayout<br/></span><span>  </span><span>xmlns:</span><span>android</span><span>=</span><span>"http://schemas.android.com/apk/res/android"<br/></span><span>  </span><span>xmlns:</span><span>tools</span><span>=</span><span>"http://schemas.android.com/tools"<br/></span><span>  </span><span>android</span><span>:layout_width=</span><span>"match_parent"<br/></span><span>  </span><span>android</span><span>:layout_height=</span><span>"match_parent"<br/></span><span>  </span><span>tools</span><span>:context=</span><span>".ui.main.MainActivity"</span><span>&gt;<br/></span><span>  &lt;LinearLayout<br/></span><span>    </span><span>android</span><span>:id=</span><span>"@+id/ll_container"<br/></span><span>    </span><span>android</span><span>:layout_width=</span><span>"match_parent"<br/></span><span>    </span><span>android</span><span>:layout_height=</span><span>"match_parent"<br/></span><span>    </span><span>android</span><span>:orientation=</span><span>"vertical"</span><span>/&gt;<br/></span><span>&lt;/android.support.design.widget.CoordinatorLayout&gt;<br/></span></pre>
<p class="p1"><span class="s1">Within the root view of the layout file, we have a single<span>&#160;</span><kbd>LinearLayout</kbd>. This <kbd>ViewGroup</kbd> will act as a container for the conversations and contacts fragments. Speaking of conversations and contacts fragments, we must create appropriate layouts for them as well. Create a<span>&#160;</span><kbd>fragment_conversations.xml</kbd><span>&#160;</span>layout file in the project's layout <kbd>resource</kbd> directory with the following content:</span></p>
<pre><span>&lt;?</span><span>xml version=</span><span>"1.0" </span><span>encoding=</span><span>"utf-8"</span><span>?&gt;<br/></span><span>&lt;android.support.design.widget.</span><span>CoordinatorLayout</span><span> <br/></span><span>xmlns:</span><span>android</span><span>=</span><span>"http://schemas.android.com/apk/res/android"<br/></span><span>  </span><span>android</span><span>:layout_width=</span><span>"match_parent"<br/></span><span>  </span><span>android</span><span>:layout_height=</span><span>"match_parent"<br/></span><span>xmlns:</span><span>app</span><span>=</span><span>"http://schemas.android.com/apk/res-auto"</span><span>&gt;<br/></span><span>&lt;android.support.v7.widget.RecyclerView<br/></span><span>  </span><span>android</span><span>:id=</span><span>"@+id/rv_conversations"<br/></span><span>  </span><span>android</span><span>:layout_width=</span><span>"match_parent"<br/></span><span>android</span><span>:layout_height=</span><span>"match_parent"</span><span>/&gt;<br/></span><span>&lt;android.support.design.widget.FloatingActionButton<br/></span><span>  </span><span>android</span><span>:id=</span><span>"@+id/fab_contacts"<br/></span><span>  </span><span>android</span><span>:layout_width=</span><span>"wrap_content"<br/></span><span>  </span><span>android</span><span>:layout_height=</span><span>"wrap_content"<br/></span><span>  </span><span>android</span><span>:layout_margin=</span><span>"@dimen/default_margin"<br/></span><span>  </span><span>android</span><span>:src=</span><span>"@android:drawable/ic_menu_edit"<br/></span><span>  </span><span>app</span><span>:layout_anchor=</span><span>"@id/rv_conversations"<br/></span><span>  </span><span>app</span><span>:layout_anchorGravity=</span><span>"bottom|right|end"</span><span>/&gt;<br/></span><span>&lt;/android.support.design.widget.</span><span>CoordinatorLayout</span><span>&gt;</span></pre>
<p class="p1"><span class="s1">We made use of two child views within the<span>&#160;</span><kbd>CoordinatorLayout</kbd><span>&#160;root&#160;</span>view. The first is a<span>&#160;</span><kbd>RecyclerView</kbd><span>&#160;</span>and the second is a<span>&#160;</span><kbd>FloatingActionButton</kbd>. A<span>&#160;</span><kbd>RecyclerView</kbd><span>&#160;</span>is an Android widget that is used as a container for displaying large sets of data that can be scrolled through efficiently by maintaining a limited number of views. We are able to make use of the<span>&#160;</span><kbd>RecyclerView</kbd><span>&#160;</span>widget because we added its dependency to our project's module-level<span>&#160;</span><kbd>build.gradle</kbd><span>&#160;</span>script, as follows:</span></p>
<pre class="p1"><span class="s1">implementation 'com.android.support:recyclerview-v7:26.1.0'</span></pre>
<p class="p1"><span class="s1">As we are making use of the<span>&#160;</span><kbd>RecyclerView</kbd>&#160;widgets, we need to create appropriate view holder layouts for each<span>&#160;</span><kbd>RecyclerView</kbd><span>&#160;</span>widget. Create a<span>&#160;</span><kbd>vh_contacts.xml</kbd><span>&#160;</span>file and a<span>&#160;</span><kbd>vh_conversations.xml</kbd><span>&#160;</span>file within the layouts resource directory.</span></p>
<p class="p1"><span class="s1">The following is the<span>&#160;</span><kbd>vh_contacts.xml</kbd><span>&#160;</span>layout:</span></p>
<pre><span>&lt;?</span><span>xml version=</span><span>"1.0" </span><span>encoding=</span><span>"utf-8"</span><span>?&gt;<br/></span><span>&lt;LinearLayout </span><span>xmlns:</span><span>android</span><span>=</span><span>"http://schemas.android.com/apk/res/android"<br/></span><span>  </span><span>android</span><span>:orientation=</span><span>"vertical" </span><span>android</span><span>:layout_width=</span><span>"match_parent"<br/></span><span>  </span><span>android</span><span>:id=</span><span>"@+id/ll_container"<br/></span><span>  </span><span>android</span><span>:layout_height=</span><span>"wrap_content"</span><span>&gt;<br/></span><span>  &lt;LinearLayout<br/></span><span>    </span><span>android</span><span>:layout_width=</span><span>"match_parent"<br/></span><span>    </span><span>android</span><span>:layout_height=</span><span>"wrap_content"<br/></span><span>    </span><span>android</span><span>:orientation=</span><span>"vertical"<br/></span><span>    </span><span>android</span><span>:padding=</span><span>"@dimen/default_padding"</span><span>&gt;<br/></span><span>    &lt;LinearLayout<br/></span><span>      </span><span>android</span><span>:layout_width=</span><span>"match_parent"<br/></span><span>      </span><span>android</span><span>:layout_height=</span><span>"wrap_content"<br/></span><span>      </span><span>android</span><span>:orientation=</span><span>"horizontal"</span><span>&gt;<br/></span><span>      &lt;</span><span>TextView</span><span><br/></span><span>        </span><span>android</span><span>:id=</span><span>"@+id/tv_username"<br/></span><span>        </span><span>android</span><span>:layout_width=</span><span>"wrap_content"<br/></span><span>        </span><span>android</span><span>:layout_height=</span><span>"wrap_content"<br/></span><span>        </span><span>android</span><span>:textSize=</span><span>"18sp"<br/></span><span>        </span><span>android</span><span>:textStyle=</span><span>"bold"</span><span>/&gt;<br/></span><span>      &lt;LinearLayout<br/></span><span>        </span><span>android</span><span>:layout_width=</span><span>"0dp"<br/></span><span>        </span><span>android</span><span>:layout_height=</span><span>"wrap_content"<br/></span><span>        </span><span>android</span><span>:layout_weight=</span><span>"1"<br/></span><span>        </span><span>android</span><span>:gravity=</span><span>"end"</span><span>&gt;<br/></span><span>        &lt;</span><span>TextView</span><span><br/></span><span>          </span><span>android</span><span>:id=</span><span>"@+id/tv_phone"<br/></span><span>          </span><span>android</span><span>:layout_width=</span><span>"wrap_content"<br/></span><span>          </span><span>android</span><span>:layout_height=</span><span>"wrap_content"<br/></span><span>          </span><span>android</span><span>:layout_marginLeft=</span><span>"@dimen/default_margin"<br/></span><span>                    <br/></span><span>          android</span><span>:layout_marginStart=</span><span>"@dimen/default_margin"</span><span>/&gt;<br/></span><span>      &lt;/LinearLayout&gt;<br/></span><span>    &lt;/LinearLayout&gt;<br/></span><span>    &lt;</span><span>TextView</span><span><br/></span><span>      </span><span>android</span><span>:id=</span><span>"@+id/tv_status"<br/></span><span>      </span><span>android</span><span>:layout_width=</span><span>"wrap_content"<br/></span><span>      </span><span>android</span><span>:layout_height=</span><span>"wrap_content"</span><span>/&gt;<br/></span><span>  &lt;/LinearLayout&gt;<br/></span><span>  &lt;View<br/></span><span>    </span><span>android</span><span>:layout_width=</span><span>"match_parent"<br/></span><span>    </span><span>android</span><span>:layout_height=</span><span>"1dp"<br/></span><span>    </span><span>android</span><span>:background=</span><span>"#e8e8e8"</span><span>/&gt;<br/></span><span>&lt;/LinearLayout&gt;</span></pre>
<p class="p1"><span class="s1">The<span>&#160;</span><kbd>vh_conversations.xml</kbd><span>&#160;</span>layout should contain the following code:</span></p>
<pre><span>&lt;?</span><span>xml version=</span><span>"1.0" </span><span>encoding=</span><span>"utf-8"</span><span>?&gt;<br/></span><span>&lt;LinearLayout </span><span>xmlns:</span><span>android</span><span>=</span><span>"http://schemas.android.com/apk/res/android"<br/></span><span>  </span><span>android</span><span>:orientation=</span><span>"vertical" </span><span>android</span><span>:layout_width=</span><span>"match_parent"<br/></span><span>  </span><span>android</span><span>:id=</span><span>"@+id/ll_container"<br/></span><span>  </span><span>android</span><span>:layout_height=</span><span>"wrap_content"</span><span>&gt;<br/></span><span>  &lt;LinearLayout<br/></span><span>    </span><span>android</span><span>:layout_width=</span><span>"match_parent"<br/></span><span>    </span><span>android</span><span>:layout_height=</span><span>"wrap_content"<br/></span><span>    </span><span>android</span><span>:orientation=</span><span>"vertical"<br/></span><span>    </span><span>android</span><span>:padding=</span><span>"@dimen/default_padding"</span><span>&gt;<br/></span><span>    &lt;TextView<br/></span><span>       </span><span>android</span><span>:id=</span><span>"@+id/tv_username"<br/></span><span>       </span><span>android</span><span>:layout_width=</span><span>"wrap_content"<br/></span><span>       </span><span>android</span><span>:layout_height=</span><span>"wrap_content"<br/></span><span>       </span><span>android</span><span>:textStyle=</span><span>"bold"<br/></span><span>       </span><span>android</span><span>:textSize=</span><span>"18sp"</span><span>/&gt;<br/></span><span>    &lt;TextView<br/></span><span>      </span><span>android</span><span>:id=</span><span>"@+id/tv_preview"<br/></span><span>      </span><span>android</span><span>:layout_width=</span><span>"wrap_content"<br/></span><span>      </span><span>android</span><span>:layout_height=</span><span>"wrap_content"</span><span>/&gt;<br/></span><span>  &lt;/LinearLayout&gt;<br/></span><span>  &lt;View<br/></span><span>    </span><span>android</span><span>:layout_width=</span><span>"match_parent"<br/></span><span>    </span><span>android</span><span>:layout_height=</span><span>"1dp"<br/></span><span>    </span><span>android</span><span>:background=</span><span>"#e8e8e8"</span><span>/&gt;<br/></span><span>&lt;/LinearLayout&gt;</span></pre>
<p class="p1"><span class="s1">As written in the Android developers reference, <em>Floating action buttons are used for a special type of promoted action. They are distinguished by a circled icon floating above the UI and have special motion behaviors related to morphing, launching, and the transferring anchor point</em>. We can make use of the<span>&#160;</span><kbd>FloatingActionButton</kbd><span>&#160;</span>widget because we added the Android support design library dependency to the project's<span>&#160;</span><kbd>build.gradle</kbd><span>&#160;</span>script:</span></p>
<pre class="p1"><span class="s1">implementation 'com.android.support:design:26.1.0'</span></pre>
<p class="p1"><span class="s1">Create a<span>&#160;</span><kbd>fragment_contacts.xml</kbd><span>&#160;</span>layout file within the layout resource directory containing the following XML:</span></p>
<pre><span>&lt;?</span><span>xml version=</span><span>"1.0" </span><span>encoding=</span><span>"utf-8"</span><span>?&gt;<br/></span><span>&lt;LinearLayout </span><span>xmlns:</span><span>android</span><span>=</span><span>"http://schemas.android.com/apk/res/android"<br/></span><span>  </span><span>android</span><span>:orientation=</span><span>"vertical" </span><span>android</span><span>:layout_width=</span><span>"match_parent"<br/></span><span>  </span><span>android</span><span>:layout_height=</span><span>"match_parent"</span><span>&gt;<br/></span><span>  &lt;android.support.v7.widget.RecyclerView<br/></span><span>    </span><span>android</span><span>:id=</span><span>"@+id/rv_contacts"<br/></span><span>    </span><span>android</span><span>:layout_width=</span><span>"match_parent"<br/></span><span>    </span><span>android</span><span>:layout_height=</span><span>"match_parent"</span><span>/&gt;<br/></span><span>&lt;/LinearLayout&gt;</span></pre>
<p class="p1"><span class="s1">Now it is time to finish up the<span>&#160;</span><kbd>MainActivity</kbd><span>&#160;</span>class. There is a lot we need to get done to complete <kbd>MainActivity</kbd>. First and foremost we must declare the necessary class properties. Next, we need to provide implementations for the following methods: <kbd>bindViews()</kbd>, <kbd>showConversationsLoadError()</kbd>, <kbd>showContactsLoadError()</kbd>, <kbd>showConversationsScreen()</kbd>, <kbd>showContactsScreen()</kbd>, <kbd>getContext()</kbd>, <kbd>getContactsFragment()</kbd>, <kbd>getConversationsFragment()</kbd>, <kbd>navigateToLogin()</kbd> and <kbd>navigateToSettings()</kbd>. Finally, we will create <kbd>ConversationsFragment</kbd> and <kbd>ContactsFragment</kbd> classes.<br/>
<br/>
That is a lot to get done. We will start first and foremost with the addition of <kbd>ConversationsFragment</kbd> and <kbd>ContactsFragment</kbd> to <kbd>MainActivity</kbd>.&#160; <kbd>ConversationsFragment</kbd> is given below. Add it within <kbd>MainActivity</kbd>.</span></p>
<pre><span>//</span><span>ConversationsFragment class extending the Fragment class</span><span><br/></span><span>  </span><span>class </span>ConversationsFragment : Fragment()<span>, </span>View.OnClickListener {<br/><br/>    <span>private lateinit var </span><span>activity</span>: MainActivity<br/>    <span>private lateinit var </span><span>rvConversations</span>: RecyclerView<br/>    <span>private lateinit var </span><span>fabContacts</span>: FloatingActionButton<br/>    <span>var </span><span>conversations</span>: ArrayList&lt;ConversationVO&gt; = ArrayList()<br/>    <span>lateinit var </span><span>conversationsAdapter</span>: ConversationsAdapter</pre>
<p><span>The following&#160;method is called, when user interface of <kbd>ConversationsFragment</kbd></span> <span>is being drawn for the first time:<br/></span></p>
<pre><span>    </span><span>override fun </span>onCreateView(inflater: LayoutInflater<span>, </span>container: <br/>    ViewGroup<span>, </span>savedInstanceState: Bundle?): View? {<br/>      <span>// fragment layout inflation<br/></span><span>      </span><span>val </span>baseLayout = <br/>      inflater.inflate(R.layout.<span>fragment_conversations</span><span>, <br/></span>      container<span>, false</span>)<br/><br/>      <span>// Layout view bindings<br/></span><span>      </span><span>rvConversations </span>= baseLayout.findViewById(R.id.<span>rv_conversations</span>)<br/>      <span>fabContacts </span>= baseLayout.findViewById(R.id.<span>fab_contacts</span>)<br/><br/>      <span>conversationsAdapter  </span>= ConversationsAdapter(<br/>      getActivity()<span>, </span><span>conversations</span>)<br/><br/>      <span>// Setting the adapter of conversations recycler view to <br/>      // created conversations adapter<br/></span><span>      </span><span>rvConversations</span>.<span>adapter </span>= <span>conversationsAdapter</span><span>      </span></pre>
<p><span>Setting the layout manager of conversations recycler and let's see how to view a linear layout manager:</span></p>
<pre><span>      </span><span>rvConversations</span>.<span>layoutManager </span>= <br/>      LinearLayoutManager(getActivity().<span>baseContext</span>)<br/>      <span>fabContacts</span>.setOnClickListener(<span>this</span>)<br/>      <span>return </span>baseLayout<br/>    }<br/><br/>    <span>override fun </span><span>onClick</span>(view: View) {<br/>      <span>if </span>(view.<span>id </span>== R.id.<span>fab_contacts</span>) {<br/>        <span>this</span>.<span>activity</span>.showContactsScreen()<br/>      }<br/>    }<br/><br/>    <span>fun </span><span>setActivity</span>(activity: MainActivity) {<br/>      <span>this</span>.<span>activity </span>= activity<br/>    }<br/>  }</pre>
<p><kbd>ConversationsFragment</kbd> possesses a <kbd>RecyclerView</kbd> layout element. Recycler views need adapters to provide a binding from a data set to views that are displayed within the <kbd>RecyclerView</kbd>. Simply put, a <kbd>RecyclerView</kbd> make use of an <kbd>Adapter</kbd> to provide data for the views it renders to the display.&#160; Add <kbd>ConversationsAdapter</kbd> below as a nested class&#160;<span>(an inner class)</span> of <kbd>ConversationsFragment</kbd>:</p>
<pre><span>   </span><span> </span><span>class </span>ConversationsAdapter(<span>private val </span><span>context</span>: <br/>    Context<span>, private val </span><span>dataSet</span>: List&lt;ConversationVO&gt;) :<br/>    RecyclerView.Adapter&lt;ConversationsAdapter.ViewHolder&gt;()<span>, <br/></span>    ChatView.ChatAdapter {<br/><br/>      <span>val </span><span>preferences</span>: AppPreferences = <br/>      AppPreferences.create(<span>context</span>)<br/><span><br/></span><span>      </span><span>override fun </span><span>onBindViewHolder</span>(holder: ViewHolder<span>, </span>position: <br/>      Int) {<br/>        <span>val </span>item = <span>dataSet</span>[position] <span>// get item at current position<br/></span><span>        </span><span>val </span>itemLayout = holder.<span>itemLayout </span><span>// bind view holder layout <br/>        // to local variable<br/></span><span><br/></span><span>        </span>itemLayout.findViewById&lt;TextView&gt;(R.id.<span>tv_username</span>).<span>text </span>= <br/>        item.<span>secondPartyUsername<br/></span><span>        </span>itemLayout.findViewById&lt;TextView&gt;(R.id.<span>tv_preview</span>).<span>text </span>= <br/>        item.<span>messages</span>[item.<span>messages</span>.<span>size </span>- <span>1</span>].<span>body</span><span> </span></pre>
<p><span>Now, let's set <kbd>View.OnClickListener</kbd> of <kbd>itemLayout</kbd>:</span></p>
<pre><span>        </span>itemLayout.setOnClickListener <span>{<br/></span><span>          </span><span>val </span>message = item.<span>messages</span>[<span>0</span>]<br/>          <span>val </span>recipientId: Long<br/><br/>          recipientId = <span>if </span>(message.<span>senderId </span>== <br/><span>          preferences</span>.<span>userDetails</span>.<span>id</span>) {<br/>            message.<span>recipientId<br/></span><span>          </span>} <span>else </span>{<br/>            message.<span>senderId<br/></span><span>          </span>}<br/><br/>          navigateToChat(item.<span>secondPartyUsername</span><span>, <br/></span>          recipientId<span>, </span>item.<span>conversationId</span>)<br/>        <span>}<br/></span><span>      </span>}<br/> <span><br/></span><span>      </span><span>override fun </span><span>onCreateViewHolder</span>(parent: ViewGroup<span>, <br/></span>      viewType: Int): ViewHolder {       </pre>
<p><span>Now, let's create the <kbd>ViewHolder</kbd> layout:</span></p>
<pre><span>        </span><span>val </span>itemLayout = LayoutInflater.from(parent.<span>context</span>)<br/>        .inflate(R.layout.<span>vh_conversations</span><span>, null, false</span>)<br/>        .findViewById&lt;LinearLayout&gt;(R.id.<span>ll_container</span>)<br/><br/>        <span>return </span>ViewHolder(itemLayout)<br/>      }<br/><span><br/></span><span>      </span><span>override fun </span><span>getItemCount</span>(): Int {<br/>        <span>return </span><span>dataSet</span>.<span>size<br/></span><span>      </span>}<br/><span><br/></span><span>      </span><span>override fun </span><span>navigateToChat</span>(recipientName: String<span>, <br/></span>      recipientId: Long<span>, </span>conversationId: Long?) {<br/>        <span>val </span>intent = Intent(<span>context</span><span>, </span>ChatActivity::<span>class</span>.<span>java</span>)<span><br/></span><span>        </span>intent.putExtra(<span>"CONVERSATION_ID"</span><span>, </span>conversationId)<br/>        intent.putExtra(<span>"RECIPIENT_ID"</span><span>, </span>recipientId)<br/>        intent.putExtra(<span>"RECIPIENT_NAME"</span><span>, </span>recipientName)<br/><br/>        <span>context</span>.startActivity(intent)<br/>      }<br/><span><br/></span><span>      </span><span>class </span>ViewHolder(<span>val </span><span>itemLayout</span>: LinearLayout) : <br/>      RecyclerView.ViewHolder(itemLayout)<br/>    }</pre>
<p>When creating a recycler view <kbd>Adapter</kbd>, there are some important methods that you must provide custom implementations for. These methods are: <kbd>onCreateViewHolder()</kbd>, <kbd>onBindViewHolder()</kbd>, and <kbd>getItemCount()</kbd>.&#160; <kbd>onCreateViewHolder()</kbd> is invoked when the recycler view needs a new view holder instance. <kbd>onBindViewHolder()</kbd> is called by the recycler view in order to display data in the data set at a specified position. <kbd>getItemCount()</kbd> is called to get the number of items in the data set. A <kbd>ViewHolder</kbd> describes an item view in use as well as metadata about its place in a <kbd>RecyclerView</kbd>.</p>
<div class="packt_infobox">An inner class is a class nested in another.</div>
<p>Having understood what is going on in <kbd>ConversationsFragment</kbd>, let us proceed by implementing <kbd>ContactsFragment</kbd>. First and&#160; add the following&#160;<kbd>ContactsFragment</kbd>&#160;class to <kbd>MainActivity</kbd>:</p>
<pre><span>  </span><span>class </span>ContactsFragment : Fragment() {<br/><br/>    <span>private lateinit var </span><span>activity</span>: MainActivity<br/>    <span>private lateinit var </span><span>rvContacts</span>: RecyclerView<br/>    <span>var </span><span>contacts</span>: ArrayList&lt;UserVO&gt; = ArrayList()<br/>    <span>lateinit var </span><span>contactsAdapter</span>: ContactsAdapter<br/><br/>    <span>override fun </span><span>onCreateView</span>(inflater: LayoutInflater<span>, <br/></span>    container: ViewGroup<span>, </span>savedInstanceState: Bundle?): View? {<br/>      <span>val </span>baseLayout = inflater.inflate(R.layout.<span>fragment_contacts</span><span>, <br/></span>      container<span>, false</span>)<br/>      <span>rvContacts </span>= baseLayout.findViewById(R.id.<span>rv_contacts</span>)<br/>      <span>contactsAdapter </span>= ContactsAdapter(getActivity()<span>, </span><span>contacts</span>)<br/><br/>      <span>rvContacts</span>.<span>adapter </span>= <span>contactsAdapter<br/></span><span>      rvContacts</span>.<span>layoutManager </span>= <br/>      LinearLayoutManager(getActivity().<span>baseContext</span>)<br/><br/>      <span>return </span>baseLayout<br/>    }<br/><br/>    <span>fun </span><span>setActivity</span>(activity: MainActivity) {<br/>      <span>this</span>.<span>activity </span>= activity<br/>    }<br/>  }</pre>
<p>As you most likely noticed, similar to <kbd>ConversationsFragment</kbd>, <kbd>ContactsFragment</kbd> makes use of a <kbd>RecyclerView</kbd> to render contact view elements to an application's user. The corresponding adapter class for this <kbd>RecyclerView</kbd> is <kbd>ContactsAdapter</kbd>. It is given in the following code snippet. Add it as an inner class of <kbd>ContactsFragment</kbd>:</p>
<pre><span>class </span>ContactsAdapter(<span>private val </span><span>context</span>: Context<span>, <br/>                      private val </span><span>dataSet</span>: List&lt;UserVO&gt;) :<br/>                      RecyclerView.Adapter&lt;ContactsAdapter.ViewHolder&gt;()<span>, <br/></span>                      ChatView.ChatAdapter {<br/><br/>  <span>override fun </span><span>onCreateViewHolder</span>(parent: ViewGroup<span>, <br/></span>                                  viewType: Int): ViewHolder {<br/>    <span>val </span>itemLayout = LayoutInflater.from(parent.<span>context</span>)<br/>                      .inflate(R.layout.<span>vh_contacts</span><span>, </span>parent<span>, false</span>)<br/>    <span>val </span>llContainer = itemLayout.findViewById&lt;LinearLayout&gt;<br/>                      (R.id.<span>ll_container</span>)<br/><br/>    <span>return </span>ViewHolder(llContainer)<br/>  }<br/><br/>  <span>override fun </span><span>onBindViewHolder</span>(holder: ViewHolder<span>, </span>position: Int) {<br/>    <span>val </span>item = <span>dataSet</span>[position]<br/>    <span>val </span>itemLayout = holder.<span>itemLayout<br/></span><span><br/></span><span>    </span>itemLayout.findViewById&lt;TextView&gt;(R.id.<span>tv_username</span>).<span>text </span>= item.<span>username<br/></span><span>    </span>itemLayout.findViewById&lt;TextView&gt;(R.id.<span>tv_phone</span>).<span>text </span>= item.<span>phoneNumber<br/></span><span>    </span>itemLayout.findViewById&lt;TextView&gt;(R.id.<span>tv_status</span>).<span>text </span>= item.<span>status<br/></span><span><br/></span><span>    </span>itemLayout.setOnClickListener <span>{<br/></span><span>      </span>navigateToChat(item.<span>username</span><span>, </span>item.<span>id</span>)<br/>    <span>}<br/></span><span>  </span>}<br/><br/>  <span>override fun </span><span>getItemCount</span>(): Int {<br/>    <span>return </span><span>dataSet</span>.<span>size<br/></span><span>  </span>}<br/><br/>  <span>override fun </span><span>navigateToChat</span>(recipientName: String<span>, <br/></span>                              recipientId: Long<span>, </span>conversationId: Long?) {<br/>    <span>val </span>intent = Intent(<span>context</span><span>, </span>ChatActivity::<span>class</span>.<span>java</span>)<br/>    intent.putExtra(<span>"RECIPIENT_ID"</span><span>, </span>recipientId)<br/>    intent.putExtra(<span>"RECIPIENT_NAME"</span><span>, </span>recipientName)<br/><br/>    <span>context</span>.startActivity(intent)<br/>  }<br/><br/>  <span>class </span>ViewHolder(<span>val </span><span>itemLayout</span>: LinearLayout) : <br/>    RecyclerView.ViewHolder(itemLayout)<br/>  }</pre>
<p>So far so good. Having created the necessary fragments, we can get to work on the properties and methods of <kbd>MainActivity</kbd>. Add the property definitions below to the top of the <kbd>MainActivity</kbd> class:</p>
<pre>  <span>private lateinit var </span><span>llContainer</span>: LinearLayout<br/>  <span>private lateinit var </span><span>presenter</span>: MainPresenter<br/><br/>  <span>// Creation of fragment instances<br/></span><span>  </span><span>private val </span><span>contactsFragment </span>= ContactsFragment()<br/>  <span>private val </span><span>conversationsFragment </span>= ConversationsFragment()</pre>
<p>Next, modify <kbd>onCreate()</kbd> to reflect the following changes:</p>
<pre><span>override fun </span><span>onCreate</span>(savedInstanceState: Bundle?) {<br/>  <span>super</span>.onCreate(savedInstanceState)<br/>  setContentView(R.layout.<span>activity_main</span>)<br/>  <span>presenter </span>= MainPresenterImpl(<span>this</span>)<br/><br/>  <span>conversationsFragment</span>.setActivity(<span>this</span>)<br/>  <span>contactsFragment</span>.setActivity(<span>this</span>)<br/><br/>  bindViews()<br/>  showConversationsScreen()<br/>}</pre>
<p>Now add the <kbd>bindViews()</kbd>, <kbd>showConversationsLoadError()</kbd>, <kbd>showContactsLoadError()</kbd>, and <kbd>showConversationsScreen()</kbd>&#160;and <kbd>showContactsScreen()</kbd> methods below to <kbd>MainActivity</kbd>:</p>
<pre>  <span>override fun </span><span>bindViews</span>() {<br/>    <span>llContainer </span>= findViewById(R.id.<span>ll_container</span>)<br/>  }<br/><br/>  <span>override fun </span><span>onCreateOptionsMenu</span>(menu: Menu?): Boolean {<br/>    <span>menuInflater</span>.inflate(R.menu.<span>main</span><span>, </span>menu)<br/>    <span>return super</span>.onCreateOptionsMenu(menu)<br/>  }<br/><br/>  <span>override fun </span><span>showConversationsLoadError</span>() {<br/>    Toast.makeText(<span>this, </span><span>"Unable to load conversations. <br/>    Try again later."</span><span>,<br/></span><span>    </span>Toast.<span>LENGTH_LONG</span>).show()<br/>  }<br/><br/>  <span>override fun </span><span>showContactsLoadError</span>() {<br/>    Toast.makeText(<span>this, </span><span>"Unable to load contacts. Try again later."</span><span>,<br/></span><span>    </span>Toast.<span>LENGTH_LONG</span>).show()<br/>  }</pre>
<p><span>Let's begin a new fragment transaction and replace any fragment&#160;</span><span>present in activity's fragment container with a <kbd>ConversationsFragment</kbd>:</span></p>
<pre><span>override fun </span><span>showConversationsScreen</span>() {   <span><br/></span><span>  </span><span>val </span>fragmentTransaction = <span>fragmentManager</span>.beginTransaction()<br/>  fragmentTransaction.replace(R.id.<span>ll_container</span><span>, </span><span> conversationsFragment</span>)<br/>  fragmentTransaction.commit()<br/><br/>  <span>// Begin conversation loading process<br/></span><span>  </span><span>presenter</span>.loadConversations()<br/><br/>  <span>supportActionBar</span>?.<span>title </span>= <span>"Messenger"<br/></span><span>  </span><span>supportActionBar</span>?.setDisplayHomeAsUpEnabled(<span>false</span>)<br/>}<br/><span><br/></span><span>override fun </span><span>showContactsScreen</span>() {<span><br/></span><span>  </span><span>val </span>fragmentTransaction = <span>fragmentManager</span>.beginTransaction()<br/>  fragmentTransaction.replace(R.id.<span>ll_container</span><span>, </span><span>contactsFragment</span>)<br/>  fragmentTransaction.commit()<br/>  <span>presenter</span>.loadContacts()<br/><br/>  <span>supportActionBar</span>?.<span>title </span>= <span>"Contacts"<br/></span><span>  </span><span>supportActionBar</span>?.setDisplayHomeAsUpEnabled(<span>true</span>)<br/>}</pre>
<p>Finally, add the <kbd>showNoConversations()</kbd>, <kbd>onOptionsItemSelected()</kbd>, <kbd>getContext()</kbd>, <kbd>getContactsFragment()</kbd>, <kbd>getConversationsFragment()</kbd>, <kbd>navigateToLogin()</kbd> and <kbd>navigateToSettings()</kbd>&#160; functions below to&#160;<kbd>MainActivity</kbd>:</p>
<pre>  <span>override fun </span><span>showNoConversations</span>() {<br/>    Toast.makeText(<span>this, </span><span>"You have no active conversations."</span><span>, <br/></span>    Toast.<span>LENGTH_LONG</span>).show()<br/>  }<br/><br/>  <span>override fun </span><span>onOptionsItemSelected</span>(item: MenuItem?): Boolean {<br/>    <span>when </span>(item?.<span>itemId</span>) {<br/>      android.R.id.<span>home </span>-&gt; showConversationsScreen()<br/>      R.id.<span>action_settings </span>-&gt; navigateToSettings()<br/>      R.id.<span>action_logout </span>-&gt; <span>presenter</span>.executeLogout()<br/>    }<br/><br/>    <span>return super</span>.onOptionsItemSelected(item)<br/>  }<br/><br/>  <span>override fun </span><span>getContext</span>(): Context {<br/>    <span>return this<br/></span><span>  </span>}<br/><span><br/></span><span>  </span><span>override fun </span><span>getContactsFragment</span>(): ContactsFragment {<br/>    <span>return </span><span>contactsFragment<br/></span><span>  </span>}<br/><span><br/></span><span>  </span><span>override fun </span><span>getConversationsFragment</span>(): ConversationsFragment {<br/>    <span>return </span><span>conversationsFragment<br/></span><span>  </span>}<br/><br/>  <span>override fun </span><span>navigateToLogin</span>() {<br/>    startActivity(Intent(<span>this, </span>LoginActivity::<span>class</span>.<span>java</span>))<br/>    finish()<br/>  }<br/><br/>  <span>override fun </span><span>navigateToSettings</span>() {<br/>    startActivity(Intent(<span>this, </span>SettingsActivity::<span>class</span>.<span>java</span>))<br/>  }</pre>
<p class="p1"><span class="s1">Comments were placed in some areas within the preceding code snippets have been heavily commented to give you more understanding of what was done. Ensure you go through the comments carefully to fully grasp what we have done.</span></p>


            </article>

            
        </section>
    </div>


  <div id="sbo-rt-content"><section>

                            <header>
                    <h1 class="header-title">Creating the MainActivity menu</h1>
                </header>
            
            <article>
                
<p class="p1"><span class="s1">In the<span>&#160;</span><kbd>onCreateOptionsMenu(Menu)</kbd><span>&#160;</span>function of<span>&#160;</span><kbd>MainActivity</kbd>, we inflated a menu that we have not yet implemented. Add a<span>&#160;</span><kbd>main.xml</kbd><span>&#160;</span>file in the<span>&#160;</span><kbd>menu</kbd><span>&#160;</span>package under the application resource directory.<span>&#160;</span><kbd>main.xml</kbd><span>&#160;</span>should contain the following content:</span></p>
<pre><span>&lt;?</span><span>xml version=</span><span>"1.0" </span><span>encoding=</span><span>"utf-8"</span><span>?&gt;<br/></span><span>&lt;menu </span><span>xmlns:</span><span>android</span><span>=</span><span>"http://schemas.android.com/apk/res/android"<br/></span><span>xmlns:</span><span>app</span><span>=</span><span>"http://schemas.android.com/apk/res-auto"</span><span>&gt;<br/></span><span>&lt;item<br/></span><span>  </span><span>android</span><span>:id=</span><span>"@+id/action_settings"<br/></span><span>  </span><span>android</span><span>:orderInCategory=</span><span>"100"<br/></span><span>  </span><span>android</span><span>:title=</span><span>"@string/action_settings"<br/></span><span>  </span><span>app</span><span>:showAsAction=</span><span>"never" </span><span>/&gt;<br/></span><span>&lt;item<br/></span><span>  </span><span>android</span><span>:id=</span><span>"@+id/action_logout"<br/></span><span>  </span><span>android</span><span>:orderInCategory=</span><span>"100"<br/></span><span>  </span><span>android</span><span>:title=</span><span>"@string/action_logout"<br/></span><span>  </span><span>app</span><span>:showAsAction=</span><span>"never" </span><span>/&gt;<br/></span><span>&lt;/menu&gt;</span></pre>
<p class="p1"><span class="s1">Fantastic work! We are one step closer to finishing this project. It is now time for us to work on the chat user The <kbd>showConversationLoadError()</kbd> and <kbd>showMessageSendError()</kbd> are functions that, interface (where the actual chatting happens).</span></p>


            </article>

            
        </section>
    </div>


  <div id="sbo-rt-content"><section>

                            <header>
                    <h1 class="header-title">Creating the Chat UI</h1>
                </header>
            
            <article>
                
<p class="p1"><span class="s1">The chat UI we are about to create must display the message thread of an active conversation as well as enable a user to send a new message to the individual they are chatting with. We will start this section by creating the view layout that will be rendered to the user.</span></p>


            </article>

            
        </section>
    </div>


  <div id="sbo-rt-content"><section>

                            <header>
                    <h1 class="header-title">Creating the chat layout</h1>
                </header>
            
            <article>
                
<p class="p1"><span class="s1">We will make use of an open source library called ChatKit to create the chat view's layout. ChatKit is an Android library that provides flexible components for chat user interface implementation in Android projects as well as utilities for chat-user-interface data management and customization.</span></p>
<p class="p1"><span class="s1">We added ChatKit to the Messenger project with the following line of code in the<span>&#160;</span><kbd>build.gradle</kbd><span>&#160;</span>script:</span></p>
<pre class="p1"><span class="s1">implementation 'com.github.stfalcon:chatkit:0.2.2'</span></pre>
<p class="p1"><span class="s1">As mentioned earlier, ChatKit provides a number of useful user interface widgets for creating a chat UI. Two of these widgets are <kbd>MessagesList</kbd> and <kbd>MessageInput</kbd>. <span>The&#160;</span><kbd>MessagesList</kbd><span>&#160;</span>is a widget for the display and management of messages in conversation threads.<span>&#160;</span><kbd>MessageInput</kbd><span>&#160;</span>is a widget for entering text messages. In addition to supporting several styling options,<span>&#160;</span><kbd>MessageInput</kbd><span>&#160;</span>supports simple input validation processes.</span></p>
<p class="p1"><span class="s1">Let's see how we can use <kbd>MessagesList</kbd> and <kbd>MessageInput</kbd> in a layout file. Create a new <kbd>chat</kbd>&#160;package within <kbd>com.example.messenger.ui</kbd> and add a new empty activity named<span>&#160;</span><kbd>ChatActivity</kbd><span>&#160;</span>to it. Open the<span>&#160;</span><kbd>ChatActivity</kbd>&#160;activities layout file (<kbd>activity_chat.xml</kbd>) and add the following XML to it:</span></p>
<pre><span>&lt;?</span><span>xml version=</span><span>"1.0" </span><span>encoding=</span><span>"utf-8"</span><span>?&gt;<br/></span><span>&lt;RelativeLayout </span><span>xmlns:</span><span>android</span><span>=</span><span>"http://schemas.android.com/apk/res/android"<br/></span><span>  </span><span>xmlns:</span><span>app</span><span>=</span><span>"http://schemas.android.com/apk/res-auto"<br/></span><span>  </span><span>xmlns:</span><span>tools</span><span>=</span><span>"http://schemas.android.com/tools"<br/></span><span>  </span><span>android</span><span>:layout_width=</span><span>"match_parent"<br/></span><span>  </span><span>android</span><span>:layout_height=</span><span>"match_parent"<br/></span><span>  </span><span>tools</span><span>:context=</span><span>"com.example.messenger.ui.chat.ChatActivity"</span><span>&gt;<br/></span><span>  &lt;com.stfalcon.chatkit.messages.MessagesList<br/></span><span>    </span><span>android</span><span>:id=</span><span>"@+id/messages_list"<br/></span><span>    </span><span>android</span><span>:layout_width=</span><span>"match_parent"<br/></span><span>    </span><span>android</span><span>:layout_height=</span><span>"match_parent"<br/></span><span>    </span><span>android</span><span>:layout_above=</span><span>"@+id/message_input"</span><span>/&gt;<br/></span><span>  &lt;com.stfalcon.chatkit.messages.MessageInput<br/></span><span>    </span><span>android</span><span>:id=</span><span>"@+id/message_input"<br/></span><span>    </span><span>android</span><span>:layout_width=</span><span>"match_parent"<br/></span><span>    </span><span>android</span><span>:layout_height=</span><span>"wrap_content"<br/></span><span>    </span><span>android</span><span>:layout_alignParentBottom=</span><span>"true"<br/></span><span>    </span><span>app</span><span>:inputHint=</span><span>"@string/hint_enter_a_message" </span><span>/&gt;<br/></span><span>&lt;/RelativeLayout&gt;<br/></span></pre>
<p class="p1"><span class="s1">As you can see in the preceding XML, we made use of ChatKit's <kbd>MessagesList</kbd> and <kbd>MessageInput</kbd> UI widgets&#160;just as we would any other Android widgets. Both <kbd>MessagesList</kbd> and <kbd>MessageInput</kbd> are located within the <kbd>com.stfalcon.chatkit.messages</kbd> package.&#160;Open the layout design window to see how the layout looks visually.</span></p>
<p class="p1"><span class="s1">Next on our agenda is the creation of a<span>&#160;</span><kbd>ChatView</kbd><span>&#160;</span>class:</span></p>
<pre><span>package </span>com.example.messenger.ui.chat<br/><br/><span>import </span>com.example.messenger.ui.base.BaseView<br/><span>import </span>com.example.messenger.utils.message.Message<br/><span>import </span>com.stfalcon.chatkit.messages.MessagesListAdapter<br/><br/><span><br/></span><span>interface </span>ChatView : BaseView {<br/><br/>  <span>interface </span>ChatAdapter {<br/>    <span>fun </span><span>navigateToChat</span>(recipientName: String<span>, </span>recipientId: Long<span>, <br/></span>    conversationId: Long? = <span>null</span>)<br/>  }<br/><br/>  <span>fun </span><span>showConversationLoadError</span>()<br/><br/>  <span>fun </span><span>showMessageSendError</span>()<br/><br/>  <span>fun </span><span>getMessageListAdapter</span>(): MessagesListAdapter&lt;Message&gt;<br/>}</pre>
<p class="p1"><span class="s1">Within<span>&#160;</span><kbd>ChatView</kbd>, we defined a<span>&#160;</span><kbd>ChatAdapter</kbd><span>&#160;</span>interface declaring a single<span>&#160;</span><kbd>navigateToChat(String, Long, Long)</kbd><span>&#160;</span>function. This interface should be implemented by adapters that are capable of directing a user to the<span>&#160;</span><kbd>ChatView</kbd>. Both the<span>&#160;</span><kbd>ConversationsAdapter</kbd><span>&#160;</span>and<span>&#160;</span><kbd>ContactsAdapter</kbd><span>&#160;that</span>&#160;we earlier created implement this interface.</span></p>
<p class="p1"><span class="s1">The <kbd>showConversationLoadError()</kbd><span>&#160;</span>and<span>&#160;</span><kbd>showMessageSendError()</kbd><span>&#160;</span>are functions that, when implemented, must display appropriate error messages when the loading of a conversation and the loading of a message fail, respectively.</span></p>
<p class="p1"><span class="s1">ChatKit's<span>&#160;</span><kbd>MessagesList</kbd><span>&#160;</span>UI widget must possess a<span>&#160;</span><kbd>MessagesListAdapter</kbd><span>&#160;</span>for the management of its messages dataset.<span>&#160;</span><kbd>getMessageListAdapter()</kbd><span>&#160;</span>is a function that, when implemented by a <kbd>ChatView</kbd>, will return the<span>&#160;</span><kbd>MessagesListAdapter</kbd><span>&#160;</span>of the UI's<span>&#160;</span><kbd>MessagesList</kbd>.</span></p>


            </article>

            
        </section>
    </div>


  <div id="sbo-rt-content"><section>

                            <header>
                    <h1 class="header-title">Preparing chat UI models</h1>
                </header>
            
            <article>
                
<p class="p1"><span class="s1">To be able to add messages to the<span>&#160;</span><kbd>MessagesListAdapter</kbd>&#160;of a <kbd>MessageList</kbd>, we must implement ChatKit's<span>&#160;</span><kbd>IMessage</kbd><span>&#160;</span>interface in an appropriate Model. We will implement this model here. Create a<span>&#160;</span><kbd>com.example.messenger.utils.message</kbd><span>&#160;</span>package and add the following&#160;<span>&#160;</span><kbd>Message</kbd><span>&#160;</span>class within it:</span></p>
<pre><span>package </span>com.example.messenger.utils.message<br/><br/><span>import </span>com.stfalcon.chatkit.commons.models.IMessage<br/><span>import </span>com.stfalcon.chatkit.commons.models.IUser<br/><span>import </span>java.util.*<br/><span><br/></span><span>data class </span>Message(<span>private val </span><span>authorId</span>: Long<span>, private val </span><span>body</span>: String<span>,<br/></span><span>private val </span><span>createdAt</span>: Date) : IMessage {<br/><br/>  <span>override fun </span><span>getId</span>(): String {<br/>    <span>return </span><span>authorId</span>.toString()<br/>  }<br/><br/>  <span>override fun </span><span>getCreatedAt</span>(): Date {<br/>    <span>return </span><span>createdAt<br/></span><span>  </span>}<br/><br/>  <span>override fun </span><span>getUser</span>(): IUser {<br/>    <span>return </span>Author(<span>authorId</span><span>, </span><span>""</span>)<br/>  }<br/><br/>  <span>override fun </span><span>getText</span>(): String {<br/>    <span>return </span><span>body<br/></span><span>  </span>}<br/><br/>}</pre>
<p class="p1"><span class="s1">In addition to this, we need to create an<span>&#160;</span><kbd>Author</kbd><span>&#160;</span>class that implements ChatKit's<span>&#160;</span><kbd>IUser</kbd><span>&#160;</span>interface. The implementation of this class is as follows:</span></p>
<pre><span>package </span>com.example.messenger.utils.message<br/><br/><span>import </span>com.stfalcon.chatkit.commons.models.IUser<br/><br/><span><br/></span><span>data class </span>Author(<span>val </span><span>id</span>: Long<span>, val </span><span>username</span>: String) : IUser {<br/><br/>  <span>override fun </span><span>getAvatar</span>(): String? {<br/>    <span>return null<br/></span><span>  </span>}<br/><br/>  <span>override fun </span><span>getName</span>(): String {<br/>    <span>return </span><span>username<br/></span><span>  </span>}<br/><br/>  <span>override fun </span><span>getId</span>(): String {<br/>    <span>return </span><span>id</span>.toString()<br/>  }<br/><br/>}</pre>
<p class="p1"><span class="s1">The<span>&#160;</span><kbd>Author</kbd><span>&#160;</span>class models the user details of a message author, such as the name of the author, their ID, and an avatar (if they have one).</span></p>
<p class="p1"><span class="s1">We have done enough with views and layouts for now. Let's go ahead and implement a<span>&#160;</span><kbd>ChatInteractor</kbd><span>&#160;</span>and<span>&#160;</span><kbd>ChatPresenter</kbd>.</span></p>


            </article>

            
        </section>
    </div>


  <div id="sbo-rt-content"><section>

                            <header>
                    <h1 class="header-title">Creating the ChatInteractor and ChatPresenter</h1>
                </header>
            
            <article>
                
<p class="p1"><span class="s1">By now, we already understand what presenters and interactors are meant to do, so let's go straight to creating code. The following is the<span>&#160;</span><kbd>ChatInteractor</kbd><span>&#160;</span>interface. This and all other<span>&#160;</span><kbd>Chat_</kbd><span>&#160;</span>files belong to the<span>&#160;</span><kbd>com.example.messenger.ui.chat</kbd><span>&#160;</span>package:<br/></span></p>
<pre><span>package </span>com.example.messenger.ui.chat<br/><br/><span>import </span>com.example.messenger.data.vo.ConversationVO<br/><span><br/></span><span>interface </span>ChatInteractor {<br/><br/>  <span>interface </span>OnMessageSendFinishedListener {<br/>    <span>fun </span><span>onSendSuccess</span>()<br/><br/>    <span>fun </span><span>onSendError</span>()<br/>  }<br/><br/>  <span>interface </span>onMessageLoadFinishedListener {<br/>    <span>fun </span><span>onLoadSuccess</span>(conversationVO: ConversationVO)<br/>    <span>fun </span><span>onLoadError</span>()<br/>  }<br/><br/>  <span>fun </span><span>sendMessage</span>(recipientId: Long<span>, </span>message: String<span>, </span>listener: <br/>  OnMessageSendFinishedListener)<br/><br/>  <span>fun </span><span>loadMessages</span>(conversationId: Long<span>, </span>listener: <br/>  onMessageLoadFinishedListener)<br/>}</pre>
<p class="p1"><span class="s1">The following is a corresponding<span>&#160;</span><kbd>ChatInteractorImpl</kbd><span>&#160;</span>class for the<span>&#160;</span><kbd>ChatInteractor</kbd><span>&#160;</span>interface:</span></p>
<pre><span>package </span>com.example.messenger.ui.chat<br/><br/><span>import </span>android.content.Context<br/><span>import </span>com.example.messenger.data.local.AppPreferences<br/><span>import </span>com.example.messenger.data.remote.repository.ConversationRepository<br/><span>import </span>com.example.messenger.data.remote.repository.ConversationRepositoryImpl<br/><span>import </span>com.example.messenger.data.remote.request.MessageRequestObject<br/><span>import </span>com.example.messenger.service.MessengerApiService<br/><span>import </span>io.reactivex.android.schedulers.AndroidSchedulers<br/><span>import </span>io.reactivex.schedulers.Schedulers<br/><br/><span><br/></span><span>class </span>ChatInteractorImpl(context: Context) : ChatInteractor {<br/><br/>  <span>private val </span><span>preferences</span>: AppPreferences = AppPreferences.create(context)<br/>  <span>private val </span><span>service</span>: MessengerApiService = MessengerApiService<br/>                                             .getInstance()<br/>  <span>private val </span><span>conversationsRepository</span>: ConversationRepository = <br/>                           ConversationRepositoryImpl(context)</pre>
<p><span>The method below will be called to load the messages of a conversation thread:</span></p>
<pre><span><br/></span><span>  </span><span>override fun </span><span>loadMessages</span>(conversationId: Long<span>, </span>listener: <br/>  ChatInteractor.onMessageLoadFinishedListener) {<br/>    <span>conversationsRepository</span>.findConversationById(conversationId)<br/>    .subscribeOn(Schedulers.io())<br/>    .observeOn(AndroidSchedulers.mainThread())<br/>    .subscribe(<span>{ </span><span>res</span> <span>-&gt; </span>listener.onLoadSuccess(<span>res</span>)<span>}</span><span>,<br/></span><span>    </span><span>{ </span>error <span>-&gt;<br/></span><span>      </span>listener.onLoadError()<br/>      error.printStackTrace()<span>}</span>)<br/>  }<br/><br/></pre>
<p><span>The method below will be called to send a message to a user:</span></p>
<pre><span><br/></span><span>  </span><span>override fun </span><span>sendMessage</span>(recipientId: Long<span>, </span>message: String<span>,<br/></span><span>  </span>listener: ChatInteractor.OnMessageSendFinishedListener) {<br/>  <span>service</span>.createMessage(MessageRequestObject(<br/>  recipientId<span>, </span>message)<span>, </span><span>preferences</span>.<span>accessToken </span><span>as </span>String)<br/>  .subscribeOn(Schedulers.io())<br/>  .observeOn(AndroidSchedulers.mainThread())<br/>  .subscribe(<span>{ </span>_ <span>-&gt; </span>listener.onSendSuccess()<span>}</span><span>,<br/></span><span>  </span><span>{ </span>error <span>-&gt;<br/></span><span>    </span>listener.onSendError()<br/>    error.printStackTrace()<span>}</span>)<br/>  }<br/>}</pre>
<p class="p1"><span class="s1">Now, let's handle the<span>&#160;</span><kbd>ChatPresenter</kbd><span>&#160;</span>and<span>&#160;</span><kbd>ChatPresenterImpl</kbd><span>&#160;</span>code. For the<span>&#160;</span><kbd>ChatPresenter</kbd>, we need to create an interface that enforces the declaration of two functions:<span>&#160;</span><kbd>sendMessage(Long, String)</kbd><span>&#160;</span>and<span>&#160;</span><kbd>loadMessages(Long)</kbd>. The following is the<span>&#160;</span><kbd>ChatPresenter</kbd><span>&#160;</span>interface:</span></p>
<pre><span>package </span>com.example.messenger.ui.chat<br/><br/><span>interface </span>ChatPresenter {<br/><br/>  <span>fun </span><span>sendMessage</span>(recipientId: Long<span>, </span>message: String)<br/><br/>  <span>fun </span><span>loadMessages</span>(conversationId: Long)<br/>}</pre>
<p class="p1"><span class="s1">The <kbd>ChatPresenter</kbd>&#160;interface's implementation class is shown as follows:</span></p>
<pre><span>package </span>com.iyanuadelekan.messenger.ui.chat<br/><br/><span>import </span>android.widget.Toast<br/><span>import </span>com.iyanuadelekan.messenger.data.vo.ConversationVO<br/><span>import </span>com.iyanuadelekan.messenger.utils.message.Message<br/><span>import </span>java.text.SimpleDateFormat<br/><span><br/></span><span>class </span>ChatPresenterImpl(<span>val </span><span>view</span>: ChatView) : ChatPresenter<span>,<br/>        </span>ChatInteractor.OnMessageSendFinishedListener<span>,<br/></span><span>        </span>ChatInteractor.onMessageLoadFinishedListener {<br/><br/>  <span>private val </span><span>interactor</span>: ChatInteractor = ChatInteractorImpl<br/>                                           (<span>view</span>.getContext())<br/><br/>  <span>override fun </span><span>onLoadSuccess</span>(conversationVO: ConversationVO) {<br/>    <span>val </span>adapter = <span>view</span>.getMessageListAdapter() <span><br/></span><span><br/></span><span>    // create date formatter to format createdAt dates <br/>    // received from Messenger API<br/></span><span>    </span><span>val </span>dateFormatter = SimpleDateFormat(<span>"yyyy-MM-dd HH:mm:ss"</span>)<br/><br/>   </pre>
<p><span>Let's iterate over conversation message loaded from API, and</span> <span>create a new <kbd>IMessage</kbd> object for message currently</span> <span>iterated upon and add <kbd>IMessage</kbd> to the start of</span> <span><kbd>MessagesListAdapter</kbd>:</span></p>
<pre><span><br/></span><span>    </span>conversationVO.<span>messages</span>.<span>forEach </span><span>{ </span>message <span>-&gt;<br/></span><span>      </span>adapter.addToStart(Message(message.<span>senderId</span><span>, </span>message.<span>body</span><span>,<br/></span><span>             </span>dateFormatter.parse(message.<span>createdAt</span>.<span>split</span>(<span>"."</span>)[<span>0</span>]))<span>, true</span>)<br/>    <span>}<br/></span><span>  </span>}<br/><br/>  <span>override fun </span><span>onLoadError</span>() {<br/>    <span>view</span>.showConversationLoadError()<br/>  }<br/><br/>  <span>override fun </span><span>onSendSuccess</span>() {<br/>    Toast.makeText(<span>view</span>.getContext()<span>, </span><span>"Message sent"</span><span>, </span>Toast.<span>LENGTH_LONG</span>).show()<br/>  }<br/><br/>  <span>override fun </span><span>onSendError</span>() {<br/>    <span>view</span>.showMessageSendError()<br/>  }<br/><span><br/></span><span>  </span><span>override fun </span><span>sendMessage</span>(recipientId: Long<span>, </span>message: String) {<br/>    <span>interactor</span>.sendMessage(recipientId<span>, </span>message<span>,this</span>)<br/>  }<br/><span><br/></span><span>  </span><span>override fun </span><span>loadMessages</span>(conversationId: Long) {<br/>    <span>interactor</span>.loadMessages(conversationId<span>, this</span>)<br/>  }<br/>}</pre>
<p class="p1"><span class="s1">Keeping with our practice thus far, explanatory comments have been left within the preceding code snippet to aid your understanding.</span></p>
<p class="p1"><span class="s1">Last, but not the least, we will work on the<span>&#160;</span><kbd>ChatActivity</kbd>.&#160; First and foremost, we shall begin by declaring the required properties for our activity and working on its <kbd>onCreate()</kbd> lifecycle method.</span></p>
<p class="p1"><span class="s1">Modify<span>&#160;</span><kbd>ChatActivity</kbd><span>&#160;</span>to contain the following code:</span></p>
<pre><span>package </span>com.example.messenger.ui.chat<br/><br/><span>import </span>android.content.Context<br/><span>import </span>android.content.Intent<br/><span>import </span>android.support.v7.app.AppCompatActivity<br/><span>import </span>android.os.Bundle<br/><span>import </span>android.view.MenuItem<br/><span>import </span>android.widget.Toast<br/><span>import </span>com.example.messenger.R<br/><span>import </span>com.example.messenger.data.local.AppPreferences<br/><span>import </span>com.example.messenger.ui.main.MainActivity<br/><span>import </span>com.example.messenger.utils.message.Message<br/><span>import </span>com.stfalcon.chatkit.messages.MessageInput<br/><span>import </span>com.stfalcon.chatkit.messages.MessagesList<br/><span>import </span>com.stfalcon.chatkit.messages.MessagesListAdapter<br/><span>import </span>java.util.*<br/><br/><span>class </span>ChatActivity : AppCompatActivity()<span>, </span>ChatView<span>, </span>MessageInput.InputListener {<br/><br/>  <span>private var </span><span>recipientId</span>: Long = -<span>1<br/></span><span>  </span><span>private lateinit var </span><span>messageList</span>: MessagesList<br/>  <span>private lateinit var </span><span>messageInput</span>: MessageInput<br/>  <span>private lateinit var </span><span>preferences</span>: AppPreferences<br/>  <span>private lateinit var </span><span>presenter</span>: ChatPresenter<br/>  <span>private lateinit var </span><span>messageListAdapter</span>: MessagesListAdapter&lt;Message&gt;<br/><br/>  <span>override fun </span><span>onCreate</span>(savedInstanceState: Bundle?) {<br/>    <span>super</span>.onCreate(savedInstanceState)<br/>    setContentView(R.layout.<span>activity_chat</span>)<br/>    <span>supportActionBar</span>?.setDisplayHomeAsUpEnabled(<span>true</span>)<br/>    <span>supportActionBar</span>?.<span>title </span>= <span>intent</span>.getStringExtra(<span>"RECIPIENT_NAME"</span>)<br/><br/>    <span>preferences </span>= AppPreferences.create(<span>this</span>)<span><br/></span><span>    </span><span>messageListAdapter </span>= MessagesListAdapter(<br/><span>    preferences</span>.<span>userDetails</span>.<span>id</span>.toString()<span>, null</span>)<br/>    <span>presenter </span>= ChatPresenterImpl(<span>this</span>)<br/>    bindViews()<br/><br/>    </pre>
<p><span>Let's parse extras bundle from intent which launched the <kbd>ChatActivity</kbd>.&#160;</span><span>If either of the extras identified by the keys <kbd>CONVERSATION_ID</kbd> and&#160;</span><kbd>RECIPIENT_ID</kbd> does not exist, -1 is returned as a default value:</p>
<pre><span>val </span>conversationId = <span>intent</span>.getLongExtra(<span>"CONVERSATION_ID"</span><span>, </span>-<span>1</span>)<br/><span>recipientId </span>= <span>intent</span>.getLongExtra(<span>"RECIPIENT_ID"</span><span>, </span>-<span>1</span>)<br/><br/></pre>
<p><span>If <kbd>conversationId</kbd> is not equal to -1, then the <kbd>conversationId</kbd> is valid,</span> <span>hence load messages in the conversation:</span></p>
<pre><span>if </span>(conversationId != -<span>1L</span>) {<br/>      <span>presenter</span>.loadMessages(conversationId)<br/>    }<br/>  }<br/>}</pre>
<p>In the code above, we created <kbd>recipientId</kbd>, <kbd>messageList</kbd>, <kbd>messageInput</kbd>, <kbd>preferences</kbd>, <kbd>presenter</kbd>, and <kbd>messageListAdapter</kbd> properties which are of the type <kbd>Long</kbd>, <kbd>MessageList</kbd>, <kbd>MessageInput</kbd>, <kbd>AppPreferences</kbd>, <kbd>ChatPresenter</kbd> and <kbd>MessageListAdapter</kbd> respectively. <kbd>messageList</kbd> is a view which renders distinct views for messages provided to it by <kbd>messageListAdapter</kbd>. All the logic contained within <kbd>onCreate()</kbd> has to do with the initialization of views within the activity. The code within <kbd>onCreate()</kbd> has been commented to give you full understanding of what is going on. Go through each line of the comments patiently before proceeding. <kbd>ChatActivity</kbd> implements <kbd>MessageInput.InputListener</kbd>. Classes which implement this interface must provide an appropriate <kbd>onSubmit()</kbd> method. Let's go ahead and do that. Add the following method to <kbd>ChatActivity</kbd>.</p>
<p><span>Function override from <kbd>MessageInput.InputListener</kbd> c</span><span>alled when a user submits a message with the <kbd>MessageInput</kbd> widget:</span></p>
<pre><span>  </span><span>override fun </span><span>onSubmit</span>(input: CharSequence?): Boolean {<br/>    <span>// create a new Message object and add it to the <br/>    // start of the MessagesListAdapter<br/></span><span>    </span><span>messageListAdapter</span>.addToStart(Message(<br/>    <span>preferences</span>.<span>userDetails</span>.<span>id</span><span>, </span>input.<span>toString</span>()<span>, </span>Date())<span>, true</span>)<br/><br/>    <span>// start message sending procedure with the ChatPresenter<br/></span><span>    </span><span>presenter</span>.sendMessage(<span>recipientId</span><span>, </span>input.<span>toString</span>())<br/><br/>    <span>return true<br/></span><span>  </span>}</pre>
<p><kbd>onSubmit()</kbd> takes a <kbd>CharSequence</kbd> of the message submitted by the <kbd>MessageInput</kbd> and creates an appropriate Message instance for it. This instance is then added to the start of the <kbd>MessageList</kbd> by invoking <kbd>messageListAdapter.addToStart()</kbd> with the Message instance passed as an argument. After adding the created <kbd>Message</kbd> to <kbd>MessageList</kbd>, the <kbd>ChatPresenter</kbd> instance is used to initialize the sending procedure to the server.</p>
<p>Now let us work on other method overrides we must do.&#160; Add the <kbd>showConversationLoadError()</kbd>, <kbd>showMessageSendError()</kbd>, <kbd>getContext()</kbd> and <kbd>getMessageListAdapter()</kbd> methods shown below to <kbd>ChatActivity</kbd>:</p>
<pre>  <span>override fun </span><span>showConversationLoadError</span>() {<br/>    Toast.makeText(<span>this, </span><span>"Unable to load thread. <br/>    Please try again later."</span><span>,<br/></span><span>      </span>Toast.<span>LENGTH_LONG</span>).show()<br/>  }<br/><br/>  <span>override fun </span><span>showMessageSendError</span>() {<br/>    Toast.makeText(<span>this, </span><span>"Unable to send message. <br/>    Please try again later."</span><span>,<br/></span><span>      </span>Toast.<span>LENGTH_LONG</span>).show()<br/>  }<br/><br/>  <span>override fun </span><span>getContext</span>(): Context {<br/>    <span>return this<br/></span><span>  </span>}<br/><br/>  <span>override fun </span><span>getMessageListAdapter</span>(): MessagesListAdapter&lt;Message&gt; {<br/>    <span>return </span><span>messageListAdapter<br/></span><span>  </span>}</pre>
<p>And finally override <kbd>bindViews()</kbd>, <kbd>onOptionsItemSelected()</kbd>,&#160; and <kbd>onBackPressed()</kbd> as follows:</p>
<pre>  <span>override fun </span><span>bindViews</span>() {<br/>    <span>messageList </span>= findViewById(R.id.<span>messages_list</span>)<br/>    <span>messageInput </span>= findViewById(R.id.<span>message_input</span>)<br/><br/>    <span>messageList</span>.setAdapter(<span>messageListAdapter</span>)<br/>    <span>messageInput</span>.setInputListener(<span>this</span>)<br/>  }<br/><br/>  <span>override fun </span><span>onOptionsItemSelected</span>(item: MenuItem?): Boolean {<br/>    <span>if </span>(item?.<span>itemId </span>== android.R.id.<span>home</span>) {<br/>      onBackPressed()<br/>    }<br/>    <span>return super</span>.onOptionsItemSelected(item)<br/>  }<br/><br/>  <span>override fun </span><span>onBackPressed</span>() {<br/>    <span>super</span>.onBackPressed()<br/>    finish()<br/>  }</pre>
<p class="p1"><span class="s1">So far, so good!&#160;You have successfully created the majority of the Messenger app. Go ahead and give yourself a round of applause. The only thing that remains for us to do before wrapping up this chapter is to create a settings activity from which users can update their profile statuses. Feel free to take a well-deserved coffee break before proceeding to the next section.</span></p>


            </article>

            
        </section>
    </div>


  <div id="sbo-rt-content"><section>

                            <header>
                    <h1 class="header-title">Creating the application's settings activity</h1>
                </header>
            
            <article>
                
<p class="p1"><span class="s1">It is now the time to develop a simple application settings activity from which a user can update their profile status. Create a new package within <kbd>com.example.messenger.ui</kbd> named <kbd>settings</kbd>. Within this package, create a new</span>&#160;settings activity<span class="s1">. Name the activity<span>&#160;</span><kbd>SettingsActivity</kbd>. To create a settings activity, right-click on the <kbd>settings</kbd> package, then select<span>&#160;</span></span><span class="s1"><span class="packt_screen">New</span></span> | <span class="s1"><span class="packt_screen">Activity</span></span> | <span class="s1"><span class="packt_screen">Settings Activity</span></span><span class="s1">. Input the necessary details of the new settings activity, such as an activity name and activity title, then click <span class="packt_screen">Finish</span>.</span></p>
<p class="p1"><span class="s1">In the process of creating a new<span>&#160;</span><kbd>SettingsActivity</kbd>, Android Studio will add a number of additional files to your project. In addition to this, a new <kbd>.xml</kbd>&#160;resource directory (<kbd>app</kbd> | <kbd>res</kbd> | <kbd>xml</kbd>) will be added to your project. This directory should contain the following files:</span></p>
<ul class="ol1">
<li class="li1"><kbd><span class="s1">pref_data_sync.xml</span></kbd></li>
<li class="li1"><kbd><span class="s1">pref_general.xml</span></kbd></li>
<li class="li1"><kbd><span class="s1">pref_headers.xml</span></kbd></li>
<li class="li1"><kbd><span class="s1">pref_notification.xml</span></kbd></li>
</ul>
<p class="p1"><span class="s1">You may choose to delete the<span>&#160;</span><kbd>pref_notification.xml</kbd><span>&#160;</span>and<span>&#160;</span><kbd>pref_data_sync.xml</kbd><span>&#160;</span>files. We will not make use of them in this project. Let's take a look at<span>&#160;</span><kbd>pref_general.xml</kbd></span>:</p>
<pre><span>&lt;PreferenceScreen </span><span>xmlns:</span><span>android</span><span>=</span><span>"http://schemas.android.com/apk/res/android"</span><span>&gt;</span><span><br/></span><span>  &lt;SwitchPreference<br/></span><span>  </span><span>android</span><span>:defaultValue=</span><span>"true"<br/></span><span>  </span><span>android</span><span>:key=</span><span>"example_switch"<br/></span><span>  </span><span>android</span><span>:summary=<br/></span><span>  "@string/pref_description_social_recommendations"<br/></span><span>  </span><span>android</span><span>:title=</span><span>"@string/pref_title_social_recommendations" </span><span>/&gt;<br/></span><span><br/></span><span>  </span><span>&lt;!-- NOTE: EditTextPreference accepts EditText attributes. --&gt;<br/></span><span>  &lt;!-- NOTE: EditTextPreference's summary should be set to <br/>  its value by the activity code. --&gt;<br/></span><span>  </span><span>&lt;EditTextPreference<br/></span><span>    </span><span>android</span><span>:capitalize=</span><span>"words"<br/></span><span>    </span><span>android</span><span>:defaultValue=</span><span>"@string/pref_default_display_name"<br/></span><span>    </span><span>android</span><span>:inputType=</span><span>"textCapWords"<br/></span><span>    </span><span>android</span><span>:key=</span><span>"example_text"<br/></span><span>    </span><span>android</span><span>:maxLines=</span><span>"1"<br/></span><span>    </span><span>android</span><span>:selectAllOnFocus=</span><span>"true"<br/></span><span>    </span><span>android</span><span>:singleLine=</span><span>"true"<br/></span><span>    </span><span>android</span><span>:title=</span><span>"@string/pref_title_display_name" </span><span>/&gt;<br/></span><span><br/></span><span>  </span><span>&lt;!-- NOTE: Hide buttons to simplify the UI. <br/>  Users can touch outside the dialog to<br/></span><span>  dismiss it. --&gt;<br/></span><span>  &lt;!-- NOTE: ListPreference's summary should be set to <br/>  its value by the activity code. --&gt;<br/></span><span>  </span><span>&lt;ListPreference<br/></span><span>    </span><span>android</span><span>:defaultValue=</span><span>"-1"<br/></span><span>    </span><span>android</span><span>:entries=</span><span>"@array/pref_example_list_titles"<br/></span><span>    </span><span>android</span><span>:entryValues=</span><span>"@array/pref_example_list_values"<br/></span><span>    </span><span>android</span><span>:key=</span><span>"example_list"<br/></span><span>    </span><span>android</span><span>:negativeButtonText=</span><span>"@null"<br/></span><span>    </span><span>android</span><span>:positiveButtonText=</span><span>"@null"<br/></span><span>    </span><span>android</span><span>:title=</span><span>"@string/pref_title_add_friends_to_messages" </span><span>/&gt;<br/></span><span><br/></span><span>&lt;/PreferenceScreen&gt;<br/></span></pre>
<p class="p1"><span class="s1">The root view of this<span>&#160;</span><kbd>xml</kbd><span>&#160;</span>layout file is a<span>&#160;</span><kbd>PreferenceScreen</kbd>. A<span>&#160;</span><kbd>PreferenceScreen</kbd><span>&#160;</span>is the root of a<span>&#160;</span><kbd>Preference</kbd><span>&#160;</span>hierarchy. A<span>&#160;</span><kbd>PreferenceScreen</kbd><span>&#160;</span>in itself is a top-level<span>&#160;</span><kbd>Preference</kbd>. The word<span>&#160;</span><kbd>Preference</kbd><span>&#160;</span>has been used a few times now. Let's define what a<span>&#160;</span><kbd>Preference</kbd><span>&#160;</span>is. It<span>&#160;</span>is a representation of the basic<span>&#160;</span><kbd>Preference</kbd><span>&#160;</span>user-interface building block that is displayed in the form of a list by a<span>&#160;</span><kbd>PreferenceActivity</kbd>.</span></p>
<p class="p1"><span class="s1">The <kbd>Preference</kbd> class provides an appropriate view for a preference to be displayed within a<span>&#160;</span><kbd>PreferenceActivity</kbd><span>&#160;</span>and its associated<span>&#160;</span><kbd>SharedPreferences</kbd><span>&#160;</span>for the storage and retrieval of preference data. <kbd>SwitchPreference</kbd>, <kbd>EditTextPreference</kbd>, and <kbd>ListPreference</kbd> in the preceding code snippet are all subclasses of <kbd>DialogPreference</kbd>, which in turn is a subclass&#160;of the<span>&#160;</span><kbd>Preference</kbd><span>&#160;</span>class. A<span>&#160;</span><kbd>PreferenceActivity</kbd><span>&#160;</span>is the base class needed by an activity in order to display a hierarchy of preferences to a user.</span></p>
<p class="p1"><span class="s1">The<span>&#160;</span><kbd>SwitchPreference</kbd>,<span>&#160;</span><kbd>EditTextPreference</kbd><span>,&#160;</span>and<span>&#160;</span><kbd>ListPreference</kbd><span>&#160;</span>views in<span>&#160;</span><kbd>pref_general.xml</kbd><span>&#160;</span>are not needed. Remove them from the XML file now. We need a preference that enables the user to update their status on our Messenger platform. This is a highly specific use case and thus it comes as no surprise that there's no<span>&#160;p</span>reference<span>&#160;</span>widget that provides us with this ability. No worries! We will implement a custom preference that does the job. Let's call it<span>&#160;</span><kbd>ProfileStatusPreference</kbd>. Create a new <kbd>ProfileStatusPreference</kbd> class containing the following code in the <kbd>settings</kbd> package:</span></p>
<pre><span>package </span>com.example.messenger.ui.settings<br/><br/><span>import </span>android.content.Context<br/><span>import </span>android.preference.EditTextPreference<br/><span>import </span>android.text.TextUtils<br/><span>import </span>android.util.AttributeSet<br/><span>import </span>android.widget.Toast<br/><span>import </span>com.example.messenger.data.local.AppPreferences<br/><span>import </span>com.example.messenger.data.remote.request.StatusUpdateRequestObject<br/><span>import </span>com.example.messenger.service.MessengerApiService<br/><span>import </span>io.reactivex.android.schedulers.AndroidSchedulers<br/><span>import </span>io.reactivex.schedulers.Schedulers<br/><span><br/></span><span>class </span>ProfileStatusPreference(context: Context<span>, </span>attributeSet: AttributeSet) : EditTextPreference(context<span>, </span>attributeSet) {<br/><br/>  <span>private val </span><span>service</span>: MessengerApiService = MessengerApiService<br/>                                             .getInstance()<br/>  <span>private val </span><span>preferences</span>: AppPreferences = AppPreferences<br/>                                            .create(context)<br/><br/>  <span>override fun </span><span>onDialogClosed</span>(<span>positiveResult</span>: Boolean) {<br/>    <span>if </span>(<span>positiveResult</span>) {<br/>      </pre>
<p><span>The following snippet binds <kbd>ProfileStatusPreference</kbd>'s <kbd>EditText</kbd> to <kbd>etStatus</kbd> variable:</span></p>
<pre><span>      </span><span>val </span>etStatus = <span>editText<br/></span><span><br/></span><span>      </span><span>if </span>(TextUtils.isEmpty(etStatus.<span>text</span>)) {<br/>        <span>// Display error message when user tries <br/>        // to submit an empty status.<br/></span><span>      </span>Toast.makeText(<span>context</span><span>, </span><span>"Status cannot be empty."</span><span>, <br/></span>      Toast.<span>LENGTH_LONG</span>).show()<br/><br/>    } <span>else </span>{<br/>      <span>val </span>requestObject = <br/>      StatusUpdateRequestObject(etStatus.<span>text</span>.toString())<br/><br/>      </pre>
<p><span>Let's use <kbd>MessengerApiService</kbd> to update the user's status:</span></p>
<pre><span><br/></span><span>      </span><span>service</span>.updateUserStatus(requestObject<span>,  <br/></span><span>      preferences</span>.<span>accessToken </span><span>as </span>String)<br/>      .subscribeOn(Schedulers.io())<br/>      .observeOn(AndroidSchedulers.mainThread())<br/>      .subscribe(<span>{ </span>res <span>-&gt;<br/></span><span>        </span></pre>
<p><span>Now, we will store the updated user details if status update is successful:</span></p>
<pre><span><br/></span><span>        </span><span>preferences</span>.storeUserDetails(res) <span>}</span><span>,<br/></span><span>        </span><span>{ </span>error <span>-&gt;<br/></span><span>          </span>Toast.makeText(<span>context</span><span>, </span><span>"Unable to update status at the " </span>+<br/>          <span>"moment. Try again later."</span><span>, </span>Toast.<span>LENGTH_LONG</span>).show()<br/>          error.printStackTrace()<span>}</span>)<br/>     }<br/>   }<br/><br/>    <span>super</span>.onDialogClosed(<span>positiveResult</span>)<br/>  }<br/>}</pre>
<p class="p1"><span class="s1">The<span>&#160;</span><kbd>ProfileStatusPreference</kbd><span>&#160;</span>class extends <kbd>EditTextPreference</kbd>. <kbd>EditTextPreference</kbd> is a <kbd>Preference</kbd> that permits string input in an<span>&#160;</span><kbd>EditText</kbd>.<span>&#160;</span><kbd>EditTextPreference</kbd><span>&#160;</span>is a<span>&#160;</span><kbd>DialogPreference</kbd><span>,&#160;</span>and, as such, presents a dialog to the user containing the<span>&#160;</span><kbd>Preference</kbd><span>&#160;</span>view when the<span>&#160;</span><kbd>Preference</kbd><span>&#160;</span>is clicked. When a dialog of the <kbd>DialogPreference</kbd> is closed, its <kbd>onDialogClosed(Boolean)</kbd> method is invoked.&#160;A positive <kbd>Boolean</kbd> value argument,<span>&#160;</span><kbd>true</kbd>, is passed to<span>&#160;</span><kbd>onDialogClosed()</kbd><span>&#160;</span>when the dialog is dismissed with a positive result. <kbd>false</kbd> is passed to<span>&#160;</span><kbd>onDialogClosed()</kbd><span>&#160;</span>when the dialog is dismissed with a negative result, for example, when the dialog's cancel button is clicked.</span></p>
<p class="p1"><span class="s1">The <kbd>ProfileStatusPreference</kbd><span>&#160;</span>overrides the<span>&#160;</span><kbd>onDialogClosed()</kbd><span>&#160;</span>function of <kbd>EditTextPreference</kbd>. If the dialog is closed with a positive result, the validity of the status contained within&#160;the<span>&#160;</span><kbd>EditText</kbd><span>&#160;function of <kbd>ProfileStatusPreference</kbd></span>&#160;is checked. If the status message is valid, the status is updated with the API, otherwise an error message is shown.</span></p>
<p class="p1"><span class="s1">Having created<span>&#160;</span><kbd>ProfileStatusPreference</kbd>, go back to<span>&#160;</span><kbd>pref_general.xml</kbd><span>&#160;</span>and update it to reflect the XML in the following snippet:</span></p>
<pre><span>&lt;PreferenceScreen </span><span>xmlns:</span><span>android</span><span>=</span><span>"http://schemas.android.com/apk/res/android"</span><span>&gt;</span><span><br/></span><span>  &lt;com.example.messenger.ui.settings.ProfileStatusPreference<br/></span><span>    </span><span>android</span><span>:key=</span><span>"profile_status"<br/></span><span>    </span><span>android</span><span>:singleLine=</span><span>"true"<br/></span><span>    </span><span>android</span><span>:inputType=</span><span>"text"<br/></span><span>    </span><span>android</span><span>:maxLines=</span><span>"1"<br/></span><span>    </span><span>android</span><span>:selectAllOnFocus=</span><span>"true"<br/></span><span>    </span><span>android</span><span>:title=</span><span>"Profile status"<br/></span><span>    </span><span>android</span><span>:defaultValue=</span><span>"Available"<br/></span><span>    </span><span>android</span><span>:summary=</span><span>"Set profile status (visible to contacts)."</span><span>/&gt;</span><span><br/></span><span>&lt;/PreferenceScreen&gt;<br/></span></pre>
<p class="p1"><span class="s1">As can be seen in the preceding code, we made use of<span>&#160;</span><kbd>ProfileStatusPreference</kbd><span>&#160;</span>in the code snippet as we would any other preference bundled within the Android application framework.</span></p>
<p class="p1"><span class="s1">Moving on to other aspects, let's check out<span>&#160;</span><kbd>pref_headers.xml</kbd>:</span></p>
<pre class="p1"><span class="s1">&lt;preference-headers xmlns:android="http://schemas.android.com/apk/res/android"&gt;<br/></span><span class="s1">  &lt;!-- These settings headers are only used on tablets. --&gt;<br/></span><span class="s1">  &lt;header<br/></span><span class="s1"><span class="Apple-converted-space">    </span>android:fragment=<br/>    "com.example.messenger.ui.settings.SettingsActivity<br/>    $GeneralPreferenceFragment"<br/></span><span class="s1"><span class="Apple-converted-space">    </span>android:icon="@drawable/ic_info_black_24dp"<br/></span><span class="s1"><span class="Apple-converted-space">    </span>android:title="@string/pref_header_general" /&gt;<br/></span><span class="s1"><span class="Apple-converted-space">  </span>&lt;header<br/></span><span class="s1"><span class="Apple-converted-space">    </span>android:fragment=<br/>    "com.example.messenger.ui.settings.SettingsActivity<br/>    $NotificationPreferenceFragment"<br/></span><span class="s1"><span class="Apple-converted-space">    </span>android:icon="@drawable/ic_notifications_black_24dp"<br/></span><span class="s1"><span class="Apple-converted-space">    </span>android:title="@string/pref_header_notifications" /&gt;<br/></span><span class="s1"><span class="Apple-converted-space">  </span>&lt;header<br/></span><span class="s1"><span class="Apple-converted-space">    </span>android:fragment=<br/>    "com.example.messenger.ui.settings.SettingsActivity<br/>    $DataSyncPreferenceFragment"<br/></span><span class="s1"><span class="Apple-converted-space">    </span>android:icon="@drawable/ic_sync_black_24dp"<br/></span><span class="s1"><span class="Apple-converted-space">    </span>android:title="@string/pref_header_data_sync" /&gt;<br/></span><span class="s1">&lt;/preference-headers&gt;</span></pre>
<p class="p1"><span class="s1">The preference header file defines headers for various preferences in the<span>&#160;</span><kbd>SettingsActivity</kbd>. Modify the file to contain the following code:</span></p>
<pre><span>&lt;preference-headers </span><span>xmlns:</span><span>android</span><span>=</span><span>"http://schemas.android.com/apk/res/android"</span><span>&gt;</span><span><br/></span><span>&lt;header<br/></span><span>  </span><span>android</span><span>:fragment=<br/></span><span>  "com.example.messenger.ui.settings.SettingsActivity<br/>  $GeneralPreferenceFragment"<br/></span><span>  </span><span>android</span><span>:icon=</span><span>"@drawable/ic_info_black_24dp"<br/></span><span>  </span><span>android</span><span>:title=</span><span>"@string/pref_header_account" </span><span>/&gt;</span><span><br/></span><span>&lt;/preference-headers&gt;</span></pre>
<p class="p1"><span class="s1">Perfectly done! Now we have to work on the<span>&#160;</span><kbd>SettingsActivity</kbd>. Modify the body of<span>&#160;</span><kbd>SettingsActivity</kbd><span>&#160;</span>to contain the content shown in the following code block:</span></p>
<pre><span>package </span>com.example.messenger.ui.settings<br/><br/><span>import </span>android.content.Intent<br/><span>import </span>android.os.Bundle<br/><span>import </span>android.preference.PreferenceActivity<br/><span>import </span>android.preference.PreferenceFragment<br/><span>import </span>android.view.MenuItem<br/><span>import </span>android.support.v4.app.NavUtils<br/><span>import </span>com.example.messenger.R<br/><br/></pre>
<p><kbd><span>PreferenceActivity</span></kbd> <span>presenting a set of application settings:</span></p>
<pre><span><br/></span><span>class </span>SettingsActivity : AppCompatPreferenceActivity() {<br/><br/>  <span>override fun </span><span>onCreate</span>(savedInstanceState: Bundle?) {<br/>    <span>super</span>.onCreate(savedInstanceState)<br/>    <span>supportActionBar</span>?.setDisplayHomeAsUpEnabled(<span>true</span>)<br/>  }<br/><br/>  <span>override fun </span><span>onMenuItemSelected</span>(featureId: Int<span>, </span>item: MenuItem): <br/>  Boolean {<br/>    <span>val </span>id = item.<span>itemId<br/></span><span><br/></span><span>    </span><span>if </span>(id == android.R.id.<span>home</span>) {<br/>      <span>if </span>(!<span>super</span>.onMenuItemSelected(featureId<span>, </span>item)) {<br/>        NavUtils.navigateUpFromSameTask(<span>this</span>)<br/>      }<br/>      <span>return true<br/></span><span>    </span>}<br/>    <span>return super</span>.onMenuItemSelected(featureId<span>, </span>item)<br/>  }<br/><br/>  </pre>
<p><span>The following function</span> <span><kbd>onBuildHeaders()</kbd></span> <span>is called when the activity needs a list of headers build:</span></p>
<pre><span><br/></span><span>  </span><span>override fun </span><span>onBuildHeaders</span>(target: List&lt;PreferenceActivity.Header&gt;) <br/>  {<br/>    loadHeadersFromResource(R.xml.<span>pref_headers</span><span>, </span>target)<br/>  }  </pre>
<p><span>The below method preventing fragment injection from malicious applications and a</span><span>ll unknown fragments should be denied here:</span></p>
<pre><span><br/></span><span>  </span><span>override fun </span><span>isValidFragment</span>(fragmentName: String): Boolean {<br/>    <span>return </span>PreferenceFragment::<span>class</span>.<span>java</span>.<span>name </span>== fragmentName<br/>    || GeneralPreferenceFragment::<span>class</span>.<span>java</span>.<span>name </span>== fragmentName<br/>  }<br/><br/></pre>
<p><span>The below fragment shows general preferences:</span></p>
<pre><span><br/></span><span>  </span><span>class </span>GeneralPreferenceFragment : PreferenceFragment() {<br/><br/>    <span>override fun </span><span>onCreate</span>(savedInstanceState: Bundle?) {<br/>      <span>super</span>.onCreate(savedInstanceState)<br/><br/>      addPreferencesFromResource(R.xml.<span>pref_general</span>)<br/>      setHasOptionsMenu(<span>true</span>)<br/>    }<br/><br/>    <span>override fun </span><span>onOptionsItemSelected</span>(item: MenuItem): Boolean {<br/>      <span>val </span>id = item.<span>itemId<br/></span><span><br/></span><span>      </span><span>if </span>(id == android.R.id.<span>home</span>) {<br/>        startActivity(Intent(<span>activity</span><span>, </span>SettingsActivity::<span>class</span>.<span>java</span>))<br/>        <span>return true<br/></span><span>      </span>}<br/>      <span>return super</span>.onOptionsItemSelected(item)<br/>    }<br/>  }<br/>}</pre>
<p class="p1"><span class="s1">The <kbd>SettingsActivity</kbd><span>&#160;</span>extends<span>&#160;</span><kbd>AppCompatPreferenceActivity</kbd>—an activity that implements the required calls to be used with<span>&#160;</span><kbd>AppCompat</kbd>.<span>&#160;</span><kbd>SettingsActivity</kbd><span>&#160;</span>is a<span>&#160;</span><kbd>PreferenceActivity</kbd><span>&#160;</span>that represents a set of application settings. The <kbd>onBuildHeaders()</kbd> function of <kbd>SettingsActivity</kbd> is called when the activity needs a list of headers built. <kbd>isValidFragment()</kbd> prevents malicious applications from injecting fragments into the <kbd>SettingsActivity</kbd>. The <kbd>isValidFragment()</kbd> returns true when a fragment is valid and false otherwise.</span></p>
<p class="p1"><span class="s1">Within<span>&#160;</span><kbd>SettingsActivity</kbd><span>, we defined a <kbd>GeneralPreferenceFragment</kbd> class. <kbd>GeneralPreferenceFragment</kbd> extends <kbd>PreferenceFragment</kbd>. The <kbd>PreferenceFragment</kbd> fragment is an abstract class defined in the Android application framework. A <kbd>PreferenceFragment</kbd> shows a hierarchy of <kbd>Preference</kbd> instances as lists.</span></span></p>
<p class="p1"><span class="s1"><span>Preferences from <kbd>pref_general.xml</kbd> are added to the <kbd>GeneralPreferenceFragment</kbd> in the <kbd>onCreate()</kbd> method by the invocation of <kbd>addPreferencesFromResource(R.xml.pref_general)</kbd>.</span></span></p>
<p class="p1"><span class="s1">With these changes made to the<span>&#160;</span><kbd>SettingsActivity</kbd>, I am pleased to inform you that you have successfully finished work on the settings of the Messenger application.</span></p>
<p class="p1"><span class="s1">Having completed the<span>&#160;</span><kbd>SettingsActivity</kbd>, we are now ready to run the Messenger app. Go ahead and build and run the Messenger application on a device (virtual or physical). Once the app launches, you will be directed straight to the<span>&#160;</span><kbd>LoginActivity</kbd>.</span></p>
<div>
<p class="p1"><span class="s1">The first thing we must do is register a new user on the Messenger platform. We can do this on the<span>&#160;</span><kbd>SignUpActivity</kbd>. Go ahead and click on the <span class="packt_screen">DON'T HAVE AN ACCOUNT? SIGN UP!</span> button. You will be directed to the<span>&#160;</span><kbd>SignUpActivity</kbd>:</span></p>
</div>
<div class="CDPAlignCenter CDPAlign"><img src="images/ece09890-08ea-4057-9946-197b1d09d492.jpg" style="width:16.17em;height:28.50em;"/></div>
<div>
<p class="p1"><span class="s1">Create a new user in this activity. Enter <kbd>popeye</kbd> as the username, as well as a phone number and a password, then click the <span class="packt_screen">SIGN UP</span> button. A new user will be registered on the Messenger platform with the username&#160;<kbd>popeye</kbd>. Once the registration is completed, you will be directed to the <kbd>MainActivity</kbd> and the conversations view will be rendered immediately:</span></p>
</div>
<div class="CDPAlignCenter CDPAlign"><img src="images/1d1c0a6f-1487-4722-9e76-47c6eedbb428.jpg" style="width:17.83em;height:32.17em;"/></div>
<div>
<p class="p1"><span class="s1">As the newly registered user does not have any active conversations, a toast message informing them of this will be displayed. We need to create another user on the messenger platform to demonstrate the chat functionality. Log out of popeye's account by clicking the three dots at the top-right corner of the screen and selecting <span class="packt_screen">logout</span>:</span></p>
</div>
<div class="CDPAlignCenter CDPAlign"><img src="images/400e3aa8-68c2-4aa1-8138-67e41513e2a1.jpg" style="width:18.08em;height:32.58em;"/></div>
<div>
<p class="p1"><span class="s1">Once logged out, create a new Messenger account with the username <kbd>dexter</kbd>. After logging in as <kbd>dexter</kbd>, click on the new message creation floating action button at the bottom-right of the conversations view. The contacts view will be rendered to you:</span></p>
</div>
<div class="CDPAlignCenter CDPAlign"><img src="images/f40a4b3a-4e08-4208-a44e-6d24e5921647.jpg" style="width:16.67em;height:30.00em;"/></div>
<p class="p1"><span class="s1">Clicking on the <span class="packt_screen">popeye</span>&#160;contact will open the<span>&#160;</span><kbd>ChatActivity</kbd>. Let's send a message to <kbd>popeye</kbd>. Type <kbd>Hey Popeye!</kbd>&#160;into the message input field at the bottom of the screen and click <span class="packt_screen">Send</span>. The message will immediately be sent to <kbd>popeye</kbd>:</span></p>
<div class="mce-root CDPAlignCenter CDPAlign"><img src="images/b0bc732a-8b7c-404f-8912-5c342208aa42.jpg" style="width:13.00em;height:23.42em;"/></div>
<div>
<p class="p1"><span class="s1">Upon going back to the conversation view of the<span>&#160;</span><kbd>MainActivity</kbd>, you will notice a conversation item now exists for the conversation initiated with <kbd>popeye</kbd>:</span></p>
</div>
<div class="mce-root CDPAlignCenter CDPAlign"><img src="images/551361ee-a183-428a-8afe-74a29caa9f1f.jpg" style="width:13.67em;height:24.75em;"/></div>
<p class="p1"><span class="s1">Let's check whether the message has actually been delivered to <kbd>popeye</kbd>. Log out of the Messenger platform and then log in as <kbd>popeye</kbd>. Upon login, you will be greeted by the new conversation initiated by <kbd>dexter</kbd>:</span></p>
<div class="CDPAlignCenter CDPAlign"><img src="images/f058435d-1e79-4761-a5a8-19924160672e.jpg" style="width:16.83em;height:30.25em;"/></div>
<div>
<p class="p1"><span class="s1">Fantastic! It's been delivered. Now let's reply to <kbd>dexter</kbd>. Open the conversation and send <kbd>dexter</kbd> a message:</span></p>
</div>
<div class="CDPAlignCenter CDPAlign"><img src="images/6923be76-81a7-4e8c-86c9-62c55a85377d.jpg" style="width:16.08em;height:28.92em;"/></div>
<div>
<p class="p1"><span class="s1">We sent a simple <kbd>How are you Dexter?</kbd>&#160;in the preceding screenshot. It is time to update popeye's profile status. Navigate back to the main activity and access the settings activity (click the three dots on the action bar and select <span class="packt_screen">Settings</span>). Tapping <span class="packt_screen">Account</span>&#160;in the launched settings activity will display the general preference fragment. Click on the <span class="packt_screen">Profile status</span>&#160;preference:</span></p>
</div>
<div class="CDPAlignCenter CDPAlign"><img src="images/bb6fbf2e-f5ed-4fbd-8007-d9166531da25.jpg" style="width:16.08em;height:29.17em;"/></div>
<div>
<p class="p1"><span class="s1">A dialog containing an<span>&#160;</span><kbd>EditText</kbd><span>&#160;</span>in which you can input a new profile status will pop up. Input a status message of your choosing and click <span class="packt_screen">OK</span>:</span></p>
</div>
<div class="CDPAlignCenter CDPAlign"><img src="images/863a5158-eed9-415e-9c92-847a539c5665.jpg" style="width:15.33em;height:27.08em;"/></div>
<div>
<p class="p1"><span class="s1">The status of the current profile will be updated immediately.</span></p>
<p class="p1"><span class="s1">At this juncture, I am pleased to inform you that you have successfully implemented the Messenger application in its entirety. Feel free to make modifications and additions to the code we created in this chapter—you will learn a lot more if you do. Before we conclude this chapter, there are two topics we need to cover briefly. The first is application testing, and the second is performing background tasks.</span></p>
</div>


            </article>

            
        </section>
    </div>


  <div id="sbo-rt-content"><section>

                            <header>
                    <h1 class="header-title">Android application testing</h1>
                </header>
            
            <article>
                
<p class="p1"><span class="s1">Application testing is the process by which a developed software application is tested to assert its software quality. Many factors contribute to software quality. Such factors include application usability, functionality, reliability, and consistency. A number of advantages arise from testing an Android application. These advantages include but are not limited to:</span></p>
<ul class="ol1">
<li class="li1"><span class="s1">Fault detection</span></li>
<li class="li1"><span class="s1">Increased software stability</span></li>
</ul>
<p class="p1"><span class="s1">The integrals of Android application testing span far and wide, and, as such, are beyond the scope of this book. Nevertheless, the following is a list of Android-testing resources you may choose to (and probably should) explore in your free time:</span></p>
<ul class="ol1">
<li class="li1"><span class="s1">Espresso (<a href="https://developer.android.com/training/testing/espresso/index.html"><span class="s3">https://developer.android.com/training/testing/espresso/index.html</span></a>)</span></li>
<li class="li1"><span class="s1">Roboelectric (<a href="http://robolectric.org"><span class="s3">http://robolectric.org</span></a>)</span></li>
<li class="li1"><span class="s1">Mockito (<a href="http://site.mockito.org"><span class="s3">http://site.mockito.org</span></a>)</span></li>
<li class="li1"><span class="s1">Calabash (<a href="https://github.com/calabash/calabash-android"><span class="s3">https://github.com/calabash/calabash-android</span></a>)</span></li>
</ul>


            </article>

            
        </section>
    </div>


  <div id="sbo-rt-content"><section>

                            <header>
                    <h1 class="header-title">Performing background operations</h1>
                </header>
            
            <article>
                
<p class="p1"><span class="s1">We made use of RxAndroid extensively in the process of developing the Messenger application to perform asynchronous operations. In many cases, when using RxAndroid, we observed the outcome of background operations on the main thread of the Android application. In some cases, you may not want to use a third-party library, such as RxAndroid, to do this. Instead, you may want to use a solution bundled in the Android application framework. Android provides a number of options to achieve this goal. One such option is AsyncTask.</span></p>


            </article>

            
        </section>
    </div>


  <div id="sbo-rt-content"><section>

                            <header>
                    <h1 class="header-title">AsyncTask</h1>
                </header>
            
            <article>
                
<p class="p1"><span class="s1">The<span>&#160;</span><kbd>AsyncTask</kbd><span>&#160;</span>class enables the performance of background operations and the publishing of operation results on the application UI thread without the burden of managing handlers and threads.<span>&#160;</span><kbd>AsyncTask</kbd><span>&#160;</span>is best used in situations where short operations need to be run. The computations of an <kbd>AsyncTask</kbd> run on a background thread and their results are published to the UI thread. <span>&#160;</span>You can find out more about<span>&#160;</span><kbd>AsyncTask</kbd><span>&#160;</span>here:<span>&#160;</span><a href="https://developer.android.com/reference/android/os/AsyncTask.html"><span class="s3">https://developer.android.com/reference/android/os/AsyncTask.html</span></a>.</span></p>


            </article>

            
        </section>
    </div>


  <div id="sbo-rt-content"><section>

                            <header>
                    <h1 class="header-title">IntentService</h1>
                </header>
            
            <article>
                
<p class="p1"><span class="s1">An<span>&#160;</span><kbd>IntentService</kbd><span>&#160;</span>is a good candidate for performing scheduled operations that run in the background, independent of an activity. As described in the Android developer reference, <kbd>IntentService</kbd> is a base class for services that handle asynchronous requests (expressed as Intents) on demand. Clients send requests through <kbd>startService</kbd>&#160;(Intent) calls; the service is started as needed and handles each Intent in turn using a worker thread, and stops itself when it runs out of work. You can learn more about <kbd>IntentService</kbd> here:<span>&#160;</span><a href="https://developer.android.com/reference/android/app/IntentService.html"><span class="s3">https://developer.android.com/reference/android/app/IntentService.html</span></a>.</span></p>


            </article>

            
        </section>
    </div>


  <div id="sbo-rt-content"><section>

                            <header>
                    <h1 class="header-title">Summary</h1>
                </header>
            
            <article>
                
<p class="p1"><span class="s1">In this chapter, we completed the development of the Messenger Android application.&#160;</span><span class="s1">In the process of doing so, we learned how to make use of ChatKit—a third-party library for creating beautiful chat use</span><span class="s1">r interfaces. In addition to this, we further explored the utilities offered to us by the Android application framework. We got a firsthand look at the development of a settings activity in Android, which helped us to learn about <kbd>PreferenceScreen</kbd>, <kbd>PreferenceActivity</kbd>, <kbd>DialogPreference</kbd>, <kbd>Preference</kbd>, and <kbd>PreferenceFragment</kbd>. Finally, we briefly discussed Android application testing and performing background operations.</span></p>
<p class="p1"><span class="s1">In the next chapter, we will explore the various storage options provided to us by the Android application framework.</span></p>
<p class="mce-root"></p>


            </article>

            
        </section>
    </div>
</body>
</html>