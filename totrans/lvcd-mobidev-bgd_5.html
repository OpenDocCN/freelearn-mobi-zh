<html><head></head><body><div class="chapter" title="Chapter&#xA0;5.&#xA0;Making a Jigsaw Puzzle Application" id="aid-21PMQ1"><div class="titlepage"><div><div><h1 class="title"><a id="ch05"/>Chapter 5. Making a Jigsaw Puzzle Application</h1></div></div></div><p>
<span class="emphasis"><em>Picture this…</em></span>
</p><p>
<span class="emphasis"><em>So far, we've been dealing with a lot of text or calling mobile OS features. These are neat things, but they're not that visual. If you were longing to mess around with pictures and image data, your time has come!</em></span>
</p><p>LiveCode isn't naturally a graphics powerhouse and its way of handling image data (often referred to as "bitmap data" by other tools) is somewhat unusual. It effectively stores the pixels of an image as a series of single byte characters to represent the red, green, and blue values of each pixel. Handling a final image is quite flexible, but in order to create something along the lines of a jigsaw puzzle, we need to understand the format of <code class="literal">imageData</code>, a LiveCode property.</p><p>In this chapter, we will:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem">Examine the way LiveCode stores bitmap data in an image object</li><li class="listitem">Find a way to use a single bitmap in place of 50 buttons</li><li class="listitem">Make a collision detection map</li><li class="listitem">Create a jigsaw puzzle app that takes advantage of several mobile device features</li></ul></div><div class="section" title="Image data format"><div class="titlepage"><div><div><h1 class="title"><a id="ch05lvl1sec63"/>Image data format</h1></div></div></div><p>In other authoring tools, such <a id="id349" class="indexterm"/>as Adobe Director and Adobe Flash, bitmap data is stored as a matrix of 24-bit or 32-bit values. If you want to know the color of the 20th pixel from the left edge in the 15th row from the top of the image, you would have to use a <code class="literal">getPixel</code> function with these numbers filled in. In Flash, which uses a zero starting point for all its variable types, you would have to write the following code:</p><div class="informalexample"><pre class="programlisting">pixelcolor = bitmapvariable.getPixel(19,14);</pre></div><p>You would in fact have to start this line with <code class="literal">var pixelcolor:uint</code>, but here we're looking at the main differences and not the oddities of having a strongly typed programming language! In Director, which like LiveCode uses 1 based variables, you would have to write the following code:</p><div class="informalexample"><pre class="programlisting">pixelcolor = imagevariable.getPixel(20,15)</pre></div><p>Again, there's no need for variable typing or even a semicolon at the end of the line. While we digress, Flash too, doesn't need the semicolon at the end or at least, you don't have to type it yourself. Flash knew what you meant! Getting back to the point…</p><p>In LiveCode, each pixel <a id="id350" class="indexterm"/>of an image is represented by four bytes, which you can access as if they are single-byte characters. The range of values in a byte is 0-255, and storing such values, especially the value <code class="literal">0</code>, in character variables does not work out well. Therefore, you would have to convert the character value into a numeric value before making use of it. The basic problem is that, although the numeric value is stored in a variable, when you come to do calculations on it, LiveCode wants to work in Base 10 arithmetic and not in the binary form inside the variable. You have to convert the variable into something that can be processed using the <code class="literal">charToNum</code> function.</p><div class="note" title="Note"><h3 class="title"><a id="note12"/>Note</h3><p>So, why would a <a id="id351" class="indexterm"/>character variable not like zeros you ask! Well, in the earliest days of personal computers, the predominant programming language was Pascal. In Pascal, a variable that contained a literal string needed a way to know how long the string was. The first byte of a Pascal string stores the length of the string, which was fine up to 255 characters, and in those days, it was most likely thought of as enough, and more than anyone would ever need! In real life though, strings can be longer than 255 characters. This paragraph alone is over 900 characters long. To solve this issue, the C programming language used a zero to indicate the end of a <span class="emphasis"><em>C String</em></span>. You could have a million characters in a row; however, only the last one would be a zero. RGB values don't care about the limitations of C strings and there are zeros all over the place, which is why we convert it to a numeric value as soon as we can.</p></div><p>In addition to the oddity of each pixel being stored as four bytes of information, there's also no way to tell specify rows and columns. All the pixels in an image have their four bytes end to end; you have to do a calculation to know where in the data the pixel you're looking for is located. If you have worked on a bitmap editor before, say Photoshop or Gimp, you must be aware that you select content based on an <span class="emphasis"><em>X</em></span> and <span class="emphasis"><em>Y</em></span> co-ordinate value that correspond to the column and row that the pixel is located in. LiveCode doesn't let you access bitmaps in this way. Hence, we need to do a calculation.</p><p>Here's how the pixel from the preceding example would be retrieved in LiveCode if you want it as a 24-bit value:</p><div class="informalexample"><pre class="programlisting">put getPixel(""test image"",20,15) into pixelcolor

function getPixel pImage,pX,pY
  put the imageData of image pImage into tImageData
  put the width of image pImage into tWidth
  put ((pY-1)*tWidth + (pX-1)) * 4 into tStartChar
  put charToNum(char tStartChar+2 of tImageData) into tRed
  put charToNum(char tStartChar+3 of tImageData) into tGreen
  put charToNum(char tStartChar+4 of tImageData) into tBlue
  return tRed*65536+tGreen*256+tBlue
end getPixel</pre></div><p>On the face of it, this is one of the few cases where the way it's done in LiveCode is considerably longer than in other languages. However, quite often, you really need the red, green, and blue values from the pixel, and in other languages, you have to take extra steps to extract these values.</p><p>The extra steps <a id="id352" class="indexterm"/>needed to make the returned number a 24-bit RGB value are no big deal, as LiveCode is easily extended by your own functions. If you need the 24-bit value, use the preceding function and you will have added a <code class="literal">getPixel</code> function to the LiveCode language. You still have to do the calculations to even get at just the red value. Maybe one day, LiveCode will have a built-in <code class="literal">getPixel</code> function that works quicker than your own function. The 24-bit number returned here is in fact represented as three decimal numbers and not as a 24-bit binary value, but it would still be generally referred to as <span class="emphasis"><em>24 bit</em></span>.</p><div class="section" title="Mystery byte…"><div class="titlepage"><div><div><h2 class="title"><a id="ch05lvl2sec98"/>Mystery byte…</h2></div></div></div><p>The first character of the four that represent one pixel is not used. LiveCode has tutorials on how to use <code class="literal">imageData</code>, where that byte is referred to as Alpha. That makes sense, as even the other tools <a id="id353" class="indexterm"/>that give you a 32-bit number have the value broken up into Alpha, Red, Green, and Blue. Why doesn't that byte, which RunRev calls Alpha, contain the alpha value? Who knows!</p><p>One possibility is that the value doesn't serve its purpose well enough. When talking about alpha transparency, you sometimes may mean that the image is transparent, as might be the case in a GIF image. Other times, you may mean that it's translucent, where it's only partially see-through.</p><p>To solve the ambiguous nature of the problem, LiveCode has two other properties of an image, <code class="literal">maskData</code> and <code class="literal">alphaData</code>:</p><div class="informalexample"><pre class="programlisting">put the maskData of image "test image" into tMaskData
put the alphaData of image "test image" into tAlphaData</pre></div><p>These properties of an image still have all the rows end to end, and you have to do the calculation to find where a given pixel's alpha value is stored.</p><p>With <code class="literal">maskData</code>, you get a set of values for each of the pixels. For every value other than 0, the pixel is visible.</p><p>With <code class="literal">alphaData</code>, you get a set of values of the opaqueness of the pixel. 0 would be fully transparent, 255 would be fully opaque, and the values in between will be translucent. 128 would be 50 percent opaque.</p><p>Later in this chapter, we <a id="id354" class="indexterm"/>are going to make use of both <code class="literal">maskData</code> and <code class="literal">alphaData</code>, and we will refer to the 0-255 <code class="literal">alphaData</code> value as its <span class="emphasis"><em>transparency</em></span>, and the zero or nonzero <code class="literal">maskData</code> value as its <span class="emphasis"><em>mask</em></span>.</p></div></div></div>
<div class="section" title="Misusing imageData" id="aid-22O7C1"><div class="titlepage"><div><div><h1 class="title"><a id="ch05lvl1sec64"/>Misusing imageData</h1></div></div></div><p>The topics in the <a id="id355" class="indexterm"/>LiveCode online tutorials include manipulation of <code class="literal">imageData</code>, turning a colored image into a grayscale one (this particular example of turning a <a id="id356" class="indexterm"/>colored image is located at <a class="ulink" href="http://lessons.runrev.com/s/lessons/m/4071/l/25371-vision-how-do-i-convert-a-color-image-to-grayscale">http://lessons.runrev.com/s/lessons/m/4071/l/25371-vision-how-do-i-convert-a-color-image-to-grayscale</a>). We're not going to do that here. Instead, we'll use the values in the <a id="id357" class="indexterm"/>image, mask, and alpha to achieve some neat things that don't change the image at all. In fact, in some cases, we won't even see the image!</p></div>
<div class="section" title="Time for action &#x2013; testing a getPixel function" id="aid-23MNU1"><div class="titlepage"><div><div><h1 class="title"><a id="ch05lvl1sec65"/>Time for action – testing a getPixel function</h1></div></div></div><p>Before getting to <a id="id358" class="indexterm"/>useful examples, let's make a <code class="literal">getPixel</code> function to obtain the color components of a point in the image and then complete a quick test case. The following steps will help you in this process:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Make a new Mainstack. Click on <span class="strong"><strong>Save</strong></span> to save it as <span class="strong"><strong>ImageDataTests</strong></span>.<div class="note" title="Note"><h3 class="title"><a id="note13"/>Note</h3><p>We'll use the same stack to illustrate several things and at the end, we may dare to try it on a mobile device!</p></div></li><li class="listitem">Set the stack's resolution to the size of your largest test device or just try 1024 x 768 if you'll be using the iPad Simulator.</li><li class="listitem">From the <span class="strong"><strong>File</strong></span> menu, navigate to <span class="strong"><strong>Import as Control</strong></span> | <span class="strong"><strong>Image</strong></span> and select any small image file you have, to place it in the upper-left corner of the card window. The next example, uses a LiveCode logo image that can easily be obtained from any LiveCode web page.</li><li class="listitem">Place a new <code class="literal">Graphic</code> object next to the image. It's going to show a single color, so just make it big enough so that you can easily see the color. Name it <code class="literal">swatch</code>.</li><li class="listitem">Set graphics to default to show an empty box, so type this in the message box to fill it:<div class="informalexample"><pre class="programlisting">set the filled of graphic 1 to true</pre></div></li><li class="listitem">Edit the script of the image and type these lines in:<div class="informalexample"><pre class="programlisting">on mouseMove pMx,pMy
  --put getPixel(the short name of me,pMx - the left of me,pMy - the top of me) into tPixelColor
  --set the backgroundColor of graphic "swatch" to tPixelColor
end mouseMove</pre></div></li><li class="listitem">Note that the two <a id="id359" class="indexterm"/>lines are commented out. LiveCode would only complain if we keep asking for <code class="literal">getPixel</code> before we create that function!</li><li class="listitem">Edit the stack script. Add the <code class="literal">getPixel</code> function, which is very much like the one shown in the Image data format we discussed in the preceding steps:<div class="informalexample"><pre class="programlisting">function getPixel pImage,pX,pY
  put the imageData of image pImage into tImageData
  put the width of image pImage into tWidth
  put ((pY-1)*tWidth + (pX-1)) * 4 into tStartChar
  put charToNum(char tStartChar+2 of tImageData) into tRed
  put charToNum(char tStartChar+3 of tImageData) into tGreen
  put charToNum(char tStartChar+4 of tImageData) into tBlue
  return tRed,tGreen,tBlue
end getPixel</pre></div></li><li class="listitem">Back in the image script, uncomment the two lines. Start pointing at the image and you should see the swatch graphic change color to match the pixel under the cursor.</li></ol><div style="height:10px; width: 1px"/></div><div class="section" title="What just happened?"><div class="titlepage"><div><div><h2 class="title"><a id="ch05lvl2sec99"/>
<span class="emphasis"><em>What just happened?</em></span>
</h2></div></div></div><p>We made a very simple example case of how to use the color of a pixel in an image; in this case, how to colorize a swatch. As setting <code class="literal">backgroundColor</code> of a graphic requires <code class="literal">redvalue</code>, <code class="literal">greenvalue</code>, and <code class="literal">bluevalue</code>, we didn't need to convert the values from the image to a 24-bit number and the <code class="literal">getPixel</code> function was able to return <code class="literal">tRed,tGreen,tBlue</code>.</p><p>Now, there isn't really any advantage to the way we did that compared to the built-in <code class="literal">mouseColor</code> function. However, at least we gave the <code class="literal">getPixel</code> function a tryout!</p></div><div class="section" title="Pop quiz – how many bits in a byte?"><div class="titlepage"><div><div><h2 class="title"><a id="ch05lvl2sec100"/>Pop quiz – how many bits in a byte?</h2></div></div></div><p>
<span class="emphasis"><em>Bytes</em></span> was mentioned a few times in this chapter and you may well know about <span class="emphasis"><em>bit depth</em></span> as we've talked about digital photographs. So tell me, how many bits are there in a byte?</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">32</li><li class="listitem">24</li><li class="listitem">8</li><li class="listitem">Depends on how hungry you are</li></ol><div style="height:10px; width: 1px"/></div><p>Answer: 8</p><p>We won't even talk about bits or bytes in the rest of this chapter; however, if only for the interest to mathematicians, it's good to know that a byte is 8 bits. A bit is a binary digit, and when you start to think of bits in those terms, you will see that a byte can store 2 to the power of 8 values in it (binary being Base 2). This comes into play when you look at the length of a Pascal string (2 to the power of 8 is 256, hence the range of characters in a Pascal String is 0-255) and it helps you realize that if a picture is made up of one byte, for each pixel's red, green, and blue values, it's a 24-bit picture. Once you add in another byte of data for the alpha channel, you have a 32-bit picture.</p></div><div class="section" title="Simulating lots of buttons"><div class="titlepage"><div><div><h2 class="title"><a id="ch05lvl2sec101"/>Simulating lots of buttons</h2></div></div></div><p>In some applications, you need to know exactly which area of an image the user is pointing at. For example, when there is a map and you want to show information related to the region the user has clicked on, this could be done using a lot of rectangular buttons or you could break the regions into graphics and use a <code class="literal">mouseEnter</code> handler to detect which region it is. Instead, you could use a single image to represent all the regions.</p></div></div>
<div class="section" title="Time for action &#x2013; making a map of the United States"><div class="titlepage" id="aid-24L8G2"><div><div><h1 class="title"><a id="ch05lvl1sec66"/>Time for action – making a map of the United States</h1></div></div></div><p>There are <a id="id360" class="indexterm"/>plenty of places online to get public domain images to <a id="id361" class="indexterm"/>use in your applications. Search for <code class="literal">public domain images</code> and you will see links to Wikipedia articles, government sites, and other sites that let you download images that are free to use. The map shown in the <a id="id362" class="indexterm"/>following steps came from the file at:</p><p>
<a class="ulink" href="http://upload.wikimedia.org/wikipedia/commons/3/32/Blank_US_Map.svg">http://upload.wikimedia.org/wikipedia/commons/3/32/Blank_US_Map.svg</a>.</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Make a new field named <code class="literal">states</code>. Find an alphabetical list of the 50 united states to paste it into the field or you can type them in!</li><li class="listitem">Make another field, set the text size to 24, and the size of the field wide enough for <span class="emphasis"><em>New Hampshire</em></span> to fit in (just the words, not the entire state!). Name the field <code class="literal">state</code>.<div class="note" title="Note"><h3 class="title"><a id="tip09"/>Tip</h3><p>
<span class="strong"><strong>Download the completed map</strong></span>
</p><p>Note that you can save a lot of work here by downloading the <code class="literal">us-map.png</code> file from the support file section for this book, which you can find at <a class="ulink" href="http://www.PacktPub.com">www.PacktPub.com</a>.</p></div></li><li class="listitem">If you have Adobe Illustrator, open the SVG file with it. If not, open it with GIMP. Pixelmator is a low-cost alternative on Macintosh OS X.</li><li class="listitem">In alphabetical order, fill in each state with a color where the red, green, and blue values match the line number of that state + 100 . We're adding 100 so that the shades of gray we'll see will not be so dark.</li><li class="listitem">Continue the <a id="id363" class="indexterm"/>same through all the states. Here's <a id="id364" class="indexterm"/>how it will start to look like in Illustrator, where Idaho is about to be colored as <code class="literal">112</code>, <code class="literal">112</code>, <code class="literal">112</code>:<div class="mediaobject"><img src="../Images/image00274.jpeg" alt="Time for action – making a map of the United States"/></div><p style="clear:both; height: 1em;"> </p></li><li class="listitem">Change the size of the map, so that it would fill about a third of the stack window, and choose <span class="strong"><strong>Export</strong></span>.<div class="note" title="Note"><h3 class="title"><a id="tip10"/>Tip</h3><p>
<span class="strong"><strong>Color profile settings</strong></span>
</p><p>LiveCode treats bitmaps in a way that ignores color profile information in the image, and that would ruin this thing we're trying to do. While exporting an image, check whether there is an option to set the color profile to <code class="literal">genericRGB</code>. If there isn't, then use a utility such as Color Sync to apply the <code class="literal">genericRGB</code> color profile. Once the image is saved, there is something you can do to make sure that it gets imported into LiveCode OK. Before importing, set the screen gamma to <code class="literal">2.23</code> by typing in the message box and press <span class="emphasis"><em>Enter</em></span>. This will set LiveCode to the right settings to make sure that the color values appear correctly.</p></div></li><li class="listitem">If you're using <a id="id365" class="indexterm"/>Illustrator, set the background to be <a id="id366" class="indexterm"/><span class="strong"><strong>White</strong></span> and anti-aliasing to be <span class="strong"><strong>None</strong></span>. With GIMP, make sure that the PNG is saved without an alpha channel.</li><li class="listitem">Type this line followed by the <span class="emphasis"><em>Enter</em></span> key into the message box:<div class="informalexample"><pre class="programlisting">set the screengamma to 2.23</pre></div></li><li class="listitem">Import the PNG into your <code class="literal">ImageDataTests</code> stack.</li><li class="listitem">Set the image's script to this:<div class="informalexample"><pre class="programlisting">on mouseMove pMx,pMy
  put getPixel(the short name of me,pMx - the left of me,pMy - the top of me) into tStateColor
  set the itemdelimiter to comma
  put item 1 of tStateColor - 100 into tLine
  put line tLine of field "states" into field "state"
end mouseMove</pre></div></li><li class="listitem">Try pointing at the different states, at least point at the ones that you have colored. The state name should appear in the <code class="literal">state</code> field.</li></ol><div style="height:10px; width: 1px"/></div><div class="section" title="What just happened?"><div class="titlepage"><div><div><h2 class="title"><a id="ch05lvl2sec102"/>
<span class="emphasis"><em>What just happened?</em></span>
</h2></div></div></div><p>For this case, we only needed to look at the value of the red channel for the pixel under the cursor (the green and blue values are the same because we used a gray color value for both). Rather than writing another function to get only the red part of the data, we reused the existing <code class="literal">getPixel</code> function, but then only took notice of the first item that the function returned. That number, after subtracting 100 that we had added to it to make the shades not be so dark, was then used as a lookup value to get the corresponding state name.</p></div><div class="section" title="Pop quiz – getting the big picture"><div class="titlepage"><div><div><h2 class="title"><a id="ch05lvl2sec103"/>Pop quiz – getting the big picture</h2></div></div></div><p>The example map image was an SVG file. Is an SVG file smaller than a PNG file for a given image? (do a little Wikipedia research and decide on the answer.)</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Yes</li><li class="listitem">No</li><li class="listitem">Depends on the nature of the image</li></ol><div style="height:10px; width: 1px"/></div><p>Answer: 3</p><p>SVG is a description of how to draw the image, whereas PNG is a description of the pixels in the image. In PNG, this information is also data compressed in a lossless way. For the example map, at its original size, a 24-bit PNG is half the size of the SVG file. There is a lot of data needed to describe the outlines of the U.S. states! If the image needs to be enlarged, the PNG would become a bigger-sized file and the SVG would remain at the same file size. On the other hand, if an image was a rectangle piece of a diagonal gradient, the SVG would be tiny and the PNG would be huge because there are no long runs of the same-colored pixels for the data compression to work well.</p></div><div class="section" title="Using maskData for collision detection"><div class="titlepage"><div><div><h2 class="title"><a id="ch05lvl2sec104"/>Using maskData for collision detection</h2></div></div></div><p>In old 2D <a id="id367" class="indexterm"/>maze adventure games, your character would move in distinct chunks, and while checking whether there was a wall or gap, the <a id="id368" class="indexterm"/>program only had to check relatively few locations. The occupied spots could be stored in an array, taking up little memory.</p><p>With other maze games, like those of marble maze tilt boards, you have to detect collisions at a much finer degree. A full-blown physics engine could take care of the problem, but it's possible to get some interesting results by storing the maze as an image and checking the pixels that are in front of your character or marble as the case may be.</p><p>In a full-featured game, it would be better to use <code class="literal">imageData</code> or perhaps <code class="literal">alphaData</code>, so that you can tell when you are going to hit something, and from the value you read, you can also tell what it is you have hit. In the marble maze game, you need to know when you have gone over a hole, for example.</p><p>For this next test though, we'll just use <code class="literal">maskData</code> and see what we can do about not hitting the thing that is in front of us.</p></div></div>
<div class="section" title="Time for action &#x2013; making a racecourse" id="aid-25JP21"><div class="titlepage"><div><div><h1 class="title"><a id="ch05lvl1sec67"/>Time for action – making a racecourse</h1></div></div></div><p>We're going to make a <a id="id369" class="indexterm"/>racecourse for little cars to move around. We'll make it out of the stack we've built! First, we need to convert what is on the card into an image that represents walls and spaces:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Using the LiveCode draw tools, add a bunch of objects to the <code class="literal">ImageDataTest</code> stack. These are going to be the obstacles in the racecourse.</li><li class="listitem">To create the image we'll need, type this in the message box:<div class="informalexample"><pre class="programlisting">import snapshot from rect the rect of this stack</pre></div></li><li class="listitem">The preceding command will take a screenshot of the card window and place it onto the card as a new <span class="emphasis"><em>image</em></span> control. The new image will overlay the whole card, so will not be noticeable. You can confirm that the image was created and select it with the Project Browser.</li><li class="listitem">Right-click on the image that was created and select <span class="strong"><strong>Launch Editor</strong></span>. This will open the image in the bitmap editor that you have set in <span class="strong"><strong>Preferences</strong></span>/<span class="strong"><strong>General</strong></span>. You will be prompted by LiveCode to select an editor if you haven't previously done so.</li><li class="listitem">In your image editor's <span class="strong"><strong>Layers</strong></span> window, duplicate the initial single layer.</li><li class="listitem">Make a new layer that is transparent beneath the duplicate image layer.</li><li class="listitem">Delete the original layer.</li><li class="listitem">Use the editor's <span class="emphasis"><em>Magic Wand</em></span> to select the white space of the card image in the layer with the image in it (not the transparent layer). Delete the selected area to reveal the transparent layer.</li><li class="listitem">Inverse the selection and fill it with a dark color (the color doesn't matter, as it's used just so we can see where the holes are).</li><li class="listitem">Take some time to <a id="id370" class="indexterm"/>fill in any small gaps. Also, place a thick border around the outside of the image. This shows how the card looks like and how the snapshot image should look like by now:<div class="mediaobject"><img src="../Images/image00275.jpeg" alt="Time for action – making a racecourse"/></div><p style="clear:both; height: 1em;"> </p></li><li class="listitem"><span class="strong"><strong>Merge</strong></span> the layers of the document and then select <span class="strong"><strong>Save</strong></span>.</li><li class="listitem">Return to LiveCode and click on the <span class="strong"><strong>Update</strong></span> button, and the snapshot image will be updated to reflect the changes you've made.</li><li class="listitem">Give the image the <a id="id371" class="indexterm"/>name <code class="literal">backdrop</code>. Later, we'll set the image behind other objects, but for now, we'll leave it on top of everything else.</li></ol><div style="height:10px; width: 1px"/></div><div class="section" title="What just happened?"><div class="titlepage"><div><div><h2 class="title"><a id="ch05lvl2sec105"/>
<span class="emphasis"><em>What just happened?</em></span>
</h2></div></div></div><p>We just made a pretty strange looking racecourse! In a real top-down racing game, you would have to carefully design a nice-looking racecourse and make a duplicate of the image for collision detection. In the duplicate, you would have to erase the parts of the image that represent where cars are allowed to drive and then, you would have to fill the rest of the image with a flat color. Players would see the nice-looking racecourse, and underneath that would be the duplicate flat color version used to detect collisions.</p><p>We now need a car that drives itself around the course we've made.</p></div></div>
<div class="section" title="Time for action &#x2013; making a racecar"><div class="titlepage" id="aid-26I9K2"><div><div><h1 class="title"><a id="ch05lvl1sec68"/>Time for action – making a racecar</h1></div></div></div><p>Take as much time as <a id="id372" class="indexterm"/>you would like to create an image of the car. Make it so that it faces right. Then, once it's in the stack, we'll start adding the required functions to its script. A size of about 40 pixels across should be about right. Our sample car is also available on <a class="ulink" href="http://www.PacktPub.com">www.PacktPub.com</a>. The following is a close-up image of what we're talking about, as seen in Photoshop:</p><div class="mediaobject"><img src="../Images/image00276.jpeg" alt="Time for action – making a racecar"/></div><p style="clear:both; height: 1em;"> </p><p>Yours can be even better than that, if you like! Save it as a 24-bit PNG that has transparency. Ok, start your engines…:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Import the image as a control and place it somewhere in the white area of the <code class="literal">ImageDataTests</code> stack. Name it <code class="literal">car1</code>.</li><li class="listitem">Duplicate the image <a id="id373" class="indexterm"/>as many times as you like (the following script can handle up to 100 cars) and name each one as a sequence, <code class="literal">car2</code>, <code class="literal">car3</code>, and so on.</li><li class="listitem">Arguably, the correct <span class="emphasis"><em>object-oriented</em></span> way to proceed would be to place some functions on the images and some in the card or stack script, but for performance reasons, we'll put everything in the stack script. Open the stack script.</li><li class="listitem">Add a line for the global variables we'll need:<div class="informalexample"><pre class="programlisting">global gBackdropMaskData,gMaskWidth,gSpeeds,gMovingCars,gMaskWidth</pre></div></li><li class="listitem">We'll add a Start/Stop button soon, which will call a function to toggle whether the cars are moving or not. Add the toggle function to the stack script:<div class="informalexample"><pre class="programlisting">on startStopCars
  if gMovingCars is true then
    put false into gMovingCars
  else
    put the maskData of image "backdrop" into gBackdropMaskData
    put the width of image "backdrop" into gMaskWidth
    setSpeeds
    put true into gMovingCars
    send moveCars to this card in 2 ticks
  end if
end startStopCars</pre></div></li><li class="listitem">The <code class="literal">setSpeeds</code> handler, which is called by <code class="literal">startStopCars</code>, will initialize the <code class="literal">gSpeeds</code> variable <a id="id374" class="indexterm"/>with a random speed for each of the car images. It will also set the initial direction to zero as well as position the car at a known location in the white area (<code class="literal">200, 200</code> in this case). Add the <code class="literal">setSpeeds</code> handler to the stack script below the <code class="literal">startStopCars</code> handler:<div class="informalexample"><pre class="programlisting">on setSpeeds
  put empty into gSpeeds
  repeat with a = 1 to 100
    put "car" &amp; a into carname
    if there is a image carname then
      put (random(10)+10)/10 into item 1 of line a of gSpeeds
      put 0 into item 2 of line a of gSpeeds
      set the loc of image carname to 200,200
    else
      exit repeat
    end if
  end repeat
end setSpeeds</pre></div></li><li class="listitem">In the <code class="literal">moveCars</code> handler, shown in step 8, we're going to look at the <code class="literal">gBackdropMaskData</code> variable to check whether the car is going to run into something solid. Add this <code class="literal">hitBarrier</code> function:<div class="informalexample"><pre class="programlisting">function hitBarrier pX,pY
  put (pY-1)*gMaskWidth + pX into tStartChar
  put charToNum(char tStartChar of gBackdropMaskData) into tMaskValue
  if tMaskValue = 255 then return true
  else return false
end hitBarrier</pre></div></li><li class="listitem">The <code class="literal">moveCars</code> handler is initially called by the <code class="literal">startStopCars</code> handler, and then, it calls itself after <a id="id375" class="indexterm"/>every two ticks until the <code class="literal">gMovingCars</code> variable is set to <code class="literal">false</code>. Type in the long <code class="literal">moveCars</code> handler into the stack script:<div class="informalexample"><pre class="programlisting">on moveCars
  put the long time
  lock screen
  repeat with a = 1 to 100
    put "car" &amp; a into carname
    put .1 into anglechange
    if there is a image carname then
      put 0 into counter
      repeat while counter &lt; 20
        add 1 to counter
        put item 1 of line a of gSpeeds into tCarSpeed
        put item 2 of line a of gSpeeds into tCarDirection
        put item 1 of the loc of image carname into tCarX
        put item 2 of the loc of image carname into tCarY
        put the round of ((cos(tCarDirection)*tCarSpeed)*20 + tCarX) into tLookAheadX
        put the round of ((sin(tCarDirection)*tCarSpeed)*20 + tCarY) into tLookAheadY
        if hitBarrier(tLookAheadX,tLookAheadY) then
          put tCarDirection + anglechange into item 2 of line a of gSpeeds
          put anglechange * -1 * ((20 - random(10))/10) into anglechange
          put max(1,tCarSpeed - .1) into item 1 of line a of gSpeeds
        else
          put min(3,tCarSpeed + .05) into item 1 of line a of gSpeeds
          exit repeat
        end if
        end repeat
      set the loc of image carname to item 1 of the loc of image carname + (tLookAheadX-item 1 of the loc of image carname)/10,item 2 of the loc of image carname + (tLookAheadY-item 2 of the loc of image carname)/10
      set the angle of image carname to 360 - item 2 of line a of gSpeeds / PI * 180
    else
      exit repeat
    end if
  end repeat
  unlock screen
  if gMovingCars is true then send moveCars to this card in 2 ticks
end moveCars</pre></div><div class="note" title="Note"><h3 class="title"><a id="tip11"/>Tip</h3><p>
<span class="strong"><strong>Collision avoidance</strong></span>
</p><p>Take a moment to look at the <code class="literal">moveCars</code> handler; what is it doing? You will no doubt have heard about collision detection; this is where you have code that recognizes when one object has collided with another object or a wall perhaps. You might as well trigger an explosion or a collision sound when that happens. For our example though, we actually don't want things to collide, as we want the cars to turn before they collide. For each car, up to 100 of them, we will look ahead of the car to check whether it collides with the edges of the course. If it's going to do so, we will change the direction that the car is heading toward, repeatedly, until a safe forward direction is found.</p></div></li><li class="listitem">Add a Start/Stop Cars <a id="id376" class="indexterm"/>button to the card window and set its script as:<div class="informalexample"><pre class="programlisting">on mouseUp
  startStopCars
end mouseUp</pre></div></li><li class="listitem">Select the backdrop image and choose <span class="strong"><strong>Send to Back</strong></span> from the <span class="strong"><strong>Object</strong></span> menu.</li><li class="listitem">It's a good idea to save it now!</li><li class="listitem">Click on the Run/Browse tool and then on the Start/Stop Cars button to see your cars drive around the interface. Here's how it looks like when 20 cars move about:<div class="mediaobject"><img src="../Images/image00277.jpeg" alt="Time for action – making a racecar"/></div><p style="clear:both; height: 1em;"> </p></li><li class="listitem">Note that you can continue to point at the parts of the image you first loaded (the LiveCode logo in the preceding example) to see the swatch to the right changing color. Also, if <a id="id377" class="indexterm"/>you point to different U.S. states, the text in the <code class="literal">state</code> field you created changes.</li></ol><div style="height:10px; width: 1px"/></div><div class="section" title="What just happened?"><div class="titlepage"><div><div><h2 class="title"><a id="ch05lvl2sec106"/>
<span class="emphasis"><em>What just happened?</em></span>
</h2></div></div></div><p>Having already used <span class="strong"><strong>imageData</strong></span> to implement a color picker and to act as multiple button areas, we went on to use the <span class="strong"><strong>maskData</strong></span> of the image as a collision map. There is quite a bit of arithmetic behind making the cars move in intelligent ways, and you could go on to change some of the numbers to get different behavior from the cars or you could take a break and get ready to make a jigsaw puzzle!</p></div><div class="section" title="Pop quiz – calculate this!"><div class="titlepage"><div><div><h2 class="title"><a id="ch05lvl2sec107"/>Pop quiz – calculate this!</h2></div></div></div><p>For the U.S. map, we only needed to simulate 50 buttons. If you make use of the red, green, and blue values, how many buttons could you simulate?</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">One, enormous button</li><li class="listitem">65,536 buttons</li><li class="listitem">16,777,216 buttons</li></ol><div style="height:10px; width: 1px"/></div><p>Answer: 3</p><p>As with the discussion about <span class="emphasis"><em>bits and bytes</em></span> (hey, I'm sure we weren't going to see these words for the rest of this chapter!), the red, green, and blue values combine to give us 2 to the power of 24 possible values. If you only used two of the colors, then the answer would have been 65,536.</p><p>The things we have tried so far in this chapter use techniques that would be useful in any LiveCode application and are not specific to mobile applications. You can try the stack you have constructed; it will work well on a mobile device with 20 cars driving around the screen! The color picker and states map work on a mobile when its screen is touched. However, these tests don't really make use of the mobile features.</p></div></div>
<div class="section" title="Making a jigsaw puzzle" id="aid-27GQ61"><div class="titlepage"><div><div><h1 class="title"><a id="ch05lvl1sec69"/>Making a jigsaw puzzle</h1></div></div></div><p>The remainder of the <a id="id378" class="indexterm"/>chapter will build on the preceding information about <code class="literal">imageData</code> and will also take advantage of a few mobile device features. We will make a jigsaw puzzle app.</p><div class="section" title="Going to pieces…"><div class="titlepage"><div><div><h2 class="title"><a id="ch05lvl2sec108"/>Going to pieces…</h2></div></div></div><p>The general technique we're going to use, is to take a set of PNGs that have a nice alpha channel in them (that creates the puzzle piece edges) and then we will replace the actual pixel data with an image of our own. The first thing we need then is some PNGs.</p><p>If you want to make a commercial mobile application, either create your own puzzle shapes or buy a royalty free image. For prototyping, you could grab any image from the Web to get the basics going and then you could replace the images with higher quality ones that you have bought. Here, we are using a preview image from <a class="ulink" href="http://depositphotos.com/">http://depositphotos.com/</a>, which also sells higher quality versions.</p><p>When you do have high-quality versions, you may wish to create each puzzle piece, so that they touch against each other perfectly. Here, we're using a preview image, and we will select the inner part of each piece and create the PNGs from those. There will be small gaps between the pieces, but at least this way we can prepare the images we need quickly.</p></div></div>
<div class="section" title="Time for action &#x2013; creating the pieces and choosing an image"><div class="titlepage" id="aid-28FAO2"><div><div><h1 class="title"><a id="ch05lvl1sec70"/>Time for action – creating the pieces and choosing an image</h1></div></div></div><p>If you <a id="id379" class="indexterm"/>wish <a id="id380" class="indexterm"/>to follow along with the exact same image <a id="id381" class="indexterm"/>shown here, know <a id="id382" class="indexterm"/>that it was taken from the top-left <a id="id383" class="indexterm"/>section of the file present at:</p><p>
<a class="ulink" href="http://static3.depositphotos.com/1004551/191/v/950/depositphotos_1914748-Jigsaw-puzzle-blank-templates.jpg">http://static3.depositphotos.com/1004551/191/v/950/depositphotos_1914748-Jigsaw-puzzle-blank-templates.jpg</a>.</p><p>The image is shown here:</p><div class="mediaobject"><img src="../Images/image00278.jpeg" alt="Time for action – creating the pieces and choosing an image"/></div><p style="clear:both; height: 1em;"> </p><p>The following <a id="id384" class="indexterm"/>steps will help in creating the pieces and choosing <a id="id385" class="indexterm"/>an image:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Make a new Mainstack of the size 1024 x 768 (or the size of your tablet device). Name the stack <code class="literal">jigsaw</code>, set the title to <code class="literal">Jigsaw Puzzle</code>, and save it.</li><li class="listitem">Open the whole puzzle image in your image editor.</li><li class="listitem">Use the <span class="strong"><strong>Magic Wand</strong></span> tool to pick up the inner part of the upper-left piece of the puzzle.</li><li class="listitem">Fill that with a color that makes it easy to spot any remaining gaps.</li><li class="listitem">Copy and paste into a new document (that has a transparent background) that is the size of the piece you copied.</li><li class="listitem">Repair any gaps using the brush tool that is set to the same fill color.</li><li class="listitem">Save it as a PNG file(with Photoshop, that would be save it for Web and devices, 24 bit, with transparency). Use a naming scheme that may help you identify the images <a id="id386" class="indexterm"/>easily. For example, <code class="literal">tlcorner.png</code>, <code class="literal">p1.png</code>, <code class="literal">trcorner.png</code>, and so on.</li><li class="listitem">Proceed through <a id="id387" class="indexterm"/>all the differently shaped areas. In the example image, there will be as few as 14 unique shapes. No need to save other pieces that are of the same shape and orientation as the ones you already have.</li><li class="listitem">The set of images will be similar to the ones shown in the following screenshot:<div class="mediaobject"><img src="../Images/image00279.jpeg" alt="Time for action – creating the pieces and choosing an image"/></div><p style="clear:both; height: 1em;"> </p></li><li class="listitem">Import all the 14 images as <span class="strong"><strong>Control/Image</strong></span>.</li><li class="listitem">Lay out a puzzle <a id="id388" class="indexterm"/>that covers most of the card window. In <a id="id389" class="indexterm"/>the following screenshot, the puzzle was of 900 x 622 pixels with 11 x 8 pieces. Make duplicates of the middle piece images to fill in the whole puzzle. You can accurately place a piece after selecting it using the arrow keys on your keyboard.<div class="mediaobject"><img src="../Images/image00280.jpeg" alt="Time for action – creating the pieces and choosing an image"/></div><p style="clear:both; height: 1em;"> </p></li><li class="listitem">Name the images in a grid-like fashion. The top-left piece would be named <code class="literal">p 1 1</code>, the top-right edge piece would be named <code class="literal">p 11 1</code> and the bottom-right piece would have the name <code class="literal">p 11 8</code>.</li><li class="listitem">Select all the <a id="id390" class="indexterm"/>pieces and group them. Name the group <a id="id391" class="indexterm"/><code class="literal">pieces</code>.</li><li class="listitem">Make a button with the name <code class="literal">fromcamera</code> and a label with the name <code class="literal">Take a Photo</code>. Set the button scripts to this:<div class="informalexample"><pre class="programlisting">on mouseUp
  loadimage "camera"
end mouseUp
Make another button, named "fromlibrary" and labeled "Load a Picture", with this script:
on mouseUp
  loadimage "library"
end mouseUp</pre></div></li><li class="listitem">Set the buttons to get a drop shadow; use the options in the <span class="strong"><strong>Graphic Effects</strong></span> pane of the <span class="strong"><strong>Inspector</strong></span> palette.</li><li class="listitem">Edit the card script and add these global variables and functions that will initialize the values that will be needed by the other functions we'll make:<div class="informalexample"><pre class="programlisting">global originalimage, puzzlewidth, puzzleheight, snapdistance, hcount, vcount

on opencard
   setvalues
end opencard

on setvalues
   put 900 into puzzlewidth
   put 662 into puzzleheight
   put 50 into snapdistance
   put 11 into hcount
   put 8 into vcount
end setvalues</pre></div></li><li class="listitem">Now, add the <code class="literal">loadImage</code> handler, which the two buttons will call in order to get an image <a id="id392" class="indexterm"/>from the user's camera or photo <a id="id393" class="indexterm"/>album:<div class="informalexample"><pre class="programlisting">on loadImage cameratype
  if puzzlewidth is empty then setvalues
  if there is an image "original" then delete image "original"
  mobilePickPhoto cameratype,puzzlewidth,puzzleheight
  if the result is empty then

    lock screen
    set the name of image the number of images to "original"
    set the width of image "original" to puzzlewidth
    set the height of image "original" to puzzleheight
    put the imageData of image "original" into originalImage
    delete image "original"
    --makepuzzle
    --scatter
    unlock screen
  else
    answer the result
  end if
end loadImage</pre></div></li><li class="listitem">The <code class="literal">makepuzzle</code> and <code class="literal">scatter</code> lines are commented out for now, so that you can test the functions so far.</li></ol><div style="height:10px; width: 1px"/></div><div class="section" title="What just happened?"><div class="titlepage"><div><div><h2 class="title"><a id="ch05lvl2sec109"/>
<span class="emphasis"><em>What just happened?</em></span>
</h2></div></div></div><p>The puzzle pieces are now in place and are named in a way that we can take advantage of them later when we manipulate them. If you go to <span class="strong"><strong>Standalone Application Settings</strong></span> and select <span class="strong"><strong>iOS</strong></span> or <span class="strong"><strong>Android</strong></span>, you can give the app a try.</p><div class="note" title="Note"><h3 class="title"><a id="tip12"/>Tip</h3><p>
<span class="strong"><strong>Setting up some test images</strong></span>
</p><p>If you use the iPad Simulator, you won't be able to test getting an image from the camera, and at first, you will just have the default images in the photo library. To add your own photo, drag images from <span class="strong"><strong>Finder</strong></span> to the Simulator window, and the image will be added to the Photos library. You can switch to the simulator Home screen to reselect the Jigsaw app using the <span class="emphasis"><em>cmd</em></span> + <span class="emphasis"><em>Shift</em></span> + <span class="emphasis"><em>H</em></span> key combination. This way, you can add a few images to the library in order to select one as the picture for the puzzle.</p></div><p>When LiveCode gets an <a id="id394" class="indexterm"/>image from the mobile device, both from the camera <a id="id395" class="indexterm"/>and the library or photo album, it places the picture as an image control that is the topmost object on the card. We don't need the image itself, just its <code class="literal">imageData</code>. In the <code class="literal">loadImage</code> handler, the image is made in the same size as the puzzle pieces group, <code class="literal">imageData</code> is stored in the global variable <code class="literal">originalimage</code>, and the image itself is deleted.</p><p>Next, we'll transfer the chosen picture to the puzzle pieces.</p></div></div>
<div class="section" title="Time for action &#x2013; transferring imageData"><div class="titlepage" id="aid-29DRA2"><div><div><h1 class="title"><a id="ch05lvl1sec71"/>Time for action – transferring imageData</h1></div></div></div><p>By setting <a id="id396" class="indexterm"/>the chosen image to be of the same width and height as the <a id="id397" class="indexterm"/>group that holds the puzzle pieces (that's where the 900 and 662 numbers came from), it becomes possible for us to transfer the matching rectangle of data from the full image to the puzzle piece in question. The following steps will guide you in transferring imageData:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Open the card script again. Add the <code class="literal">makepuzzle</code> handler:<div class="informalexample"><pre class="programlisting">on makepuzzle
  resetpuzzle
  put the number of images in group "pieces" into imagecount
  repeat with a = 1 to imagecount
    makepiece the short name of image a of group "pieces"
  end repeat
end makepuzzle</pre></div></li><li class="listitem">The <code class="literal">makepuzzle</code> handler will go through each of the puzzle pieces and call another handler to do the transfer of data for that one piece. Here is the <code class="literal">makepiece</code> handler:<div class="informalexample"><pre class="programlisting">on makepiece piecename
  put the width of image piecename into piecewidth
  put the height of image piecename into pieceheight
  put empty into tempimage
  put the left of image piecename - the left of group "pieces" into dx
  put the top of image piecename - the top of group "pieces" into dy
  repeat with y = 1 to pieceheight
    put ((y+dy-1) * puzzlewidth + dx)*4 into sourcestart
    put char sourcestart+1 to sourcestart+piecewidth*4 of originalimage after tempimage
  end repeat
  set the imageData of image piecename to tempimage
end makepiece</pre></div></li><li class="listitem">In the earlier <a id="id398" class="indexterm"/><code class="literal">imageData</code> tests, we were only interested in one pixel at a time, but here, we want lots of rows of data. The arithmetic, <span class="emphasis"><em>((y+dy-1) * puzzlewidth…</em></span>, and so on, quickly pull out a whole row of pixels at a time. These rows are built up into a new variable, <code class="literal">tempimage</code>, which is finally transferred into the actual puzzle piece.</li><li class="listitem">After the <a id="id399" class="indexterm"/>pieces have their rectangle of <code class="literal">imageData</code>, we then need to move the pieces into random places, making the game ready for the user to play. This is done with a <code class="literal">scatter</code> handler:<div class="informalexample"><pre class="programlisting">on scatter
  repeat with a = 1 to the number of images in group "pieces"
    set the myloc of image a of group "pieces" to the loc of image a of group "pieces"
    put the short name of image a of group "pieces" into n
    if edgepiece(n) then
      set the loc of image a of group "pieces" to 40 + random(400),300 + random(400)
    else
      set the loc of image a of group "pieces" to 500 + random(500),300 + random(400)
    end if
  end repeat
end scatter</pre></div></li><li class="listitem">The first thing that most jigsaw puzzle players do is they separate the <span class="emphasis"><em>straight-edged</em></span> pieces. We can code things in a way so that their time is saved. We can employ a function that places the edge pieces away from the non-edge pieces. The <code class="literal">edgepiece</code> function (which is called from the preceding <code class="literal">scatter</code> handler) is this:<div class="informalexample"><pre class="programlisting">function edgepiece pName
  return word 2 of pName = 1 or word 3 of pName = 1 or word 2 of pName = hcount or word 3 of pName = vcount
end edgepiece</pre></div></li><li class="listitem">The name that we carefully set for each piece is checked to verify that the piece is either at the left, right, top, or bottom edge of the puzzle. In other words, it's a piece located at the outer edges of the puzzle. Scatter places the straight-edged pieces in the left half of the screen and the others in the right half of the screen, as shown here:<div class="mediaobject"><img src="../Images/image00281.jpeg" alt="Time for action – transferring imageData"/></div><p style="clear:both; height: 1em;"> </p></li><li class="listitem">The start of <a id="id400" class="indexterm"/>the <code class="literal">makepuzzle</code> handler calls a <code class="literal">resetpuzzle</code> <a id="id401" class="indexterm"/>handler that is used to make sure that the pieces are back where they started, ready for a new picture to load. This is achieved when you use a property variable on each piece named <code class="literal">myloc</code>, which records the initial location of the piece. Here's the <code class="literal">resetpuzzle</code> handler:<div class="informalexample"><pre class="programlisting">on resetpuzzle
  repeat with a = 1 to the number of images in group "pieces"
    if the myloc of image a of group "pieces" is not empty then
      set the loc of image a of group "pieces" to the myloc of image a of group "pieces"
    else
     set the myloc of image a of group "pieces" to the loc of image a of group "pieces"
    end if
  end repeat
end resetpuzzle</pre></div></li><li class="listitem">You can see that if <code class="literal">myloc</code> is not already set, then the piece must be in its start position, and so, the <code class="literal">resetpuzzle</code> handler goes ahead and records that location in the <code class="literal">myloc</code> property.</li><li class="listitem">Uncomment <a id="id402" class="indexterm"/>the lines at step 17 of <span class="emphasis"><em>Time for Action - creating the pieces and choosing an image</em></span> (<code class="literal">makepuzzle</code> and scatter lines) and try <a id="id403" class="indexterm"/>another test of the app. You should now be able to choose a picture and see it in the spread out puzzle pieces. Hopefully, you will see something like this:<div class="mediaobject"><img src="../Images/image00282.jpeg" alt="Time for action – transferring imageData"/></div><p style="clear:both; height: 1em;"> </p></li></ol><div style="height:10px; width: 1px"/></div><div class="section" title="What just happened?"><div class="titlepage"><div><div><h2 class="title"><a id="ch05lvl2sec110"/>
<span class="emphasis"><em>What just happened?</em></span>
</h2></div></div></div><p>As mentioned in the preceding section, the right arithmetic made it relatively easy for us to extract a desired rectangle of <code class="literal">imageData</code> from a larger image, and store it in a smaller image that was the size of that rectangle. However, there's one bit of magic that wasn't pointed out, the puzzle kept its <a id="id404" class="indexterm"/>shape! Even though we had completely replaced <code class="literal">imageData</code> for the image, how did this happen? Setting <code class="literal">imageData</code> doesn't interfere with <a id="id405" class="indexterm"/>
<code class="literal">alphaData</code> of the image. The PNGs that we imported kept their original alpha channel and so still had the same shape, but just a different image.</p></div><div class="section" title="Adding interactivity"><div class="titlepage"><div><div><h2 class="title"><a id="ch05lvl2sec111"/>Adding interactivity</h2></div></div></div><p>Our jigsaw puzzle is ready to be shipped! Well, other than the fact it has no interactivity at all! Let's add some.</p></div></div>
<div class="section" title="Time for action &#x2013; setting up touch events" id="aid-2ACBS1"><div class="titlepage"><div><div><h1 class="title"><a id="ch05lvl1sec72"/>Time for action – setting up touch events</h1></div></div></div><p>The <a id="id406" class="indexterm"/>handlers so far have been in the card script, the plan being to have different cards with different types of puzzle. The interactivity <a id="id407" class="indexterm"/>handlers can be placed in the stack script available for all the cards.</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Open the stack script. There is only one of the global variables that we will also need in the stack script, but there are a couple of initializing items we need to cover. Start the stack script with these lines:<div class="informalexample"><pre class="programlisting">global snapdistance

on preopenstack
  if the platform contains "iphone" then iphoneUseDeviceResolution true
end preopenstack

on openstack
  set the compositorType of this stack to "Static OpenGL"
end openstack</pre></div></li><li class="listitem">The <code class="literal">preopenstack</code> handler checks whether the app is on iPhone and requests that the device's native resolution be used. This will make sure that Retina displays show the best quality. The <code class="literal">compositorType</code> being set to <code class="literal">"Static OpenGL"</code> will help performance.</li><li class="listitem">The interactivity we'll use will make use of touch events. Each touch comes with an associated ID value. Here is the handler that detects the start of a touch event:<div class="informalexample"><pre class="programlisting">on touchStart touchid
  put the short name of the target into n
  if word 1 of n is "p" then
    set the dropShadow of image n to the dropShadow of button "fromlibrary"
    set the relayerGroupedControls to true
    set the layer of the target to the number of images in group "pieces"
  end if
end touchstart</pre></div></li><li class="listitem">The <a id="id408" class="indexterm"/>check of the target name is a quick way to make sure that we don't drag anything around except for the puzzle <a id="id409" class="indexterm"/>pieces. When a piece is touched, we use the <code class="literal">relayerGroupedControls</code> and layer functions to make that piece appear above the other pieces.</li><li class="listitem">Do you remember how we added a dropshadow to the two buttons? Aside from making them look nicer, we make use of it here too. By adding the same <code class="literal">dropShadow</code> to the puzzle piece, we create the illusion that the piece is floating above the screen.</li><li class="listitem">Next thing to watch for is movement, which we can do with the <code class="literal">touchMove</code> event:<div class="informalexample"><pre class="programlisting">on touchMove touchid,touchx,touchy
  put the short name of the target into n
  if word 1 of n is "p" then
    set the loc of the target to touchx,touchy
  end if
end touchMove</pre></div></li><li class="listitem">Again, there's a quick double check that you can perform to make sure that it's a puzzle piece; otherwise, it's a simple case of setting the location of the piece to the location of the user's finger.</li><li class="listitem">When the user releases the piece, we check whether it's near its starting place, and if it is near, we move the piece into its place and remove the dropShadow effect:<div class="informalexample"><pre class="programlisting">on touchEnd touchid
  put the short name of the target into n
  if word 1 of n is "p" then
    checkdistance the short name of the target
    set the dropShadow of the target to empty
    checkfinished
  end if
end touchEnd</pre></div></li><li class="listitem">This is the <code class="literal">checkdistance</code> handler and a <code class="literal">distance</code> function that it calls:<div class="informalexample"><pre class="programlisting">on checkdistance dt
  if snapdistance is empty then put 100 into snapdistance
  put distance(item 1 of the loc of image dt - item 1 of the myloc of image dt,item 2 of the loc of image dt - item 2 of the myloc of image dt) into d
  if d&lt;snapdistance then
    put max(.1,min(.2,d/200)) into t
    move image dt to the myloc of image dt in t seconds
    set the relayerGroupedControls to true
    set the layer of image dt to 2
  end if
end checkdistance

function distance dx,dy
  return sqrt(dx*dx+dy*dy)
end distance</pre></div></li><li class="listitem">The <a id="id410" class="indexterm"/><code class="literal">distance</code> function is based on the <a id="id411" class="indexterm"/><span class="strong"><strong>Pythagorean theorem</strong></span>, returning the number of pixels between the puzzle piece and its original <code class="literal">myloc</code> value. <code class="literal">snapdistance</code> is the global variable that is used to determine whether the piece is close enough to its starting place to be considered on target.</li><li class="listitem">The <code class="literal">move</code> <a id="id412" class="indexterm"/>line uses LiveCode's move function, which animates the piece into its place.</li><li class="listitem">One last thing, let's check whether the puzzle is complete. Add this handler to the stack script:<div class="informalexample"><pre class="programlisting">on checkfinished
  repeat with a = 1 to the number of images in group "pieces"
    if the myloc of image a of group "pieces" &lt;&gt; the loc of image a of group "pieces" then exit checkfinished
  end repeat
  answer "You've done it!"
end checkfinished</pre></div></li></ol><div style="height:10px; width: 1px"/></div><div class="section" title="What just happened?"><div class="titlepage"><div><div><h2 class="title"><a id="ch05lvl2sec112"/>
<span class="emphasis"><em>What just happened?</em></span>
</h2></div></div></div><p>The jigsaw puzzle should fully work now. Something that you can't easily guess from the touch functions we added is the fact that it works with multitouch. You can drag on up to 10 pieces at once (or whatever the multitouch limit is for your device). Here, each piece will show a drop shadow and all the pieces will animate into their place when you let go of them.</p></div><div class="section" title="Have a go hero – one for the kids"><div class="titlepage"><div><div><h2 class="title"><a id="ch05lvl2sec113"/>Have a go hero – one for the kids</h2></div></div></div><p>Functions that relate to the puzzle itself are in the card script. Try making a new card that has bigger puzzle pieces and a higher value for <code class="literal">snapdistance</code> (the higher the value, the easier it is to <a id="id413" class="indexterm"/>get a piece into place). You could make an opening card for the stack that has a set of difficulty level buttons, one of which would jump <a id="id414" class="indexterm"/>to the easier puzzle. This would be ideal for younger players.</p><p>Adding some guide graphics will help players know where the edges of the finished puzzle are, and for simpler difficulty levels, you can even include outlines of the individual puzzle pieces.</p></div></div>
<div class="section" title="Summary" id="aid-2BASE1"><div class="titlepage"><div><div><h1 class="title"><a id="ch05lvl1sec73"/>Summary</h1></div></div></div><p>There are many other possibilities when it comes to making use of <code class="literal">imageData</code> in paint programs, image processing applications, and so on, and it is still the same as in the preceding examples. In this chapter, we went over and understood the format of <code class="literal">imageData</code>, <code class="literal">alphaData</code>, and <code class="literal">maskData</code> and how to copy areas of <code class="literal">imageData</code> from one image to another. Reading individual pixels of an image and finding novel uses for the pixel values was covered here as well. We also saw how to use multitouch interactivity to bring those chunks of <code class="literal">imageData</code> to life in the form of a jigsaw puzzle.</p><p>Working with graphics can be great fun, hopefully, this will just be the start of what you will create. However, in the next chapter, we'll get back to making a utility application. Sigh…</p></div></body></html>