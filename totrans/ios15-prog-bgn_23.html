<html><head></head><body>
		<div><h1 id="_idParaDest-275"><em class="italic"><a id="_idTextAnchor350"/>Chapter 20</em>: Getting Started with Cameras and Photo Libraries</h1>
			<p>In the previous chapter, you created the <code>RatingsView</code> class and added it to the <strong class="bold">Restaurant Detail</strong> and <strong class="bold">Review Form</strong> screens. You also enabled the user to submit a review using the <strong class="bold">Review Form</strong> screen, although the submitted review is only printed to the Debug area for now.</p>
			<p>In this chapter, you will complete the implementation of the <code>.plist</code> file containing the filters you want to use, then create a filter object class to store filter data, and create a data manager class to read the <code>.plist</code> file and populate an array of filter objects. Next, you'll create a protocol with a method to apply filters to images. After that, you'll create view controllers for the <code>UIImagePickerDelegate</code> protocol, which allows you to get photos from the camera or the photo library, and implement methods to apply a selected filter to a photo. Note that the photo will not be saved. You will learn how to save reviews and photos in the next chapter.</p>
			<p>By the end of this chapter, you'll have learned how to import photos into your own apps, and how to apply filters to them.</p>
			<p>The following topics will be covered in this chapter: </p>
			<ul>
				<li>Understanding filters</li>
				<li>Creating model objects for the <strong class="bold">Photo Filter</strong> screen</li>
				<li>Creating the <code>ImageFiltering</code> protocol</li>
				<li>Creating classes for the <strong class="bold">Photo Filter</strong> screen</li>
				<li>Implementing the image picker delegate protocol</li>
				<li>Getting permission to use the camera or photo library</li>
			</ul>
			<h1 id="_idParaDest-276"><a id="_idTextAnchor351"/>Technical requirements</h1>
			<p>You will continue working on the <code>LetsEat</code> project that you modified in the previous chapter.</p>
			<p>The resource files and completed Xcode project for this chapter are in the <code>Chapter20</code> folder of the code bundle for this book, which can be downloaded here:</p>
			<p><a href="https://github.com/PacktPublishing/iOS-15-Programming-for-Beginners-Sixth-Edition">https://github.com/PacktPublishing/iOS-15-Programming-for-Beginners-Sixth-Edition</a><a href="https://github.com/PacktPublishing/iOS-15-Programming-for-Beginners-Sixth-Edition&#13;"/></p>
			<p>Check out the following video to see the code in action:</p>
			<p><a href="https://bit.ly/3oZZ93P">https://bit.ly/3oZZ93P</a><a href="https://bit.ly/3oZZ93P&#13;"/></p>
			<p>Let's start by learning about photo filters, and how to apply them to images.</p>
			<h1 id="_idParaDest-277"><a id="_idTextAnchor352"/>Understanding filters</h1>
			<p>iOS has a <a id="_idIndexMarker1052"/>range of built-in filters that you can use to enhance photos. These filters are <a id="_idIndexMarker1053"/>available via the <strong class="bold">Core Image</strong> library. Core Image is an image processing and analysis technology that provides high-performance processing for still and video images. There are over 170 filters available in Core Image, giving you the ability to apply a wide range of cool effects to your photos.</p>
			<p class="callout-heading">Important Information</p>
			<p class="callout">You can learn more<a id="_idIndexMarker1054"/> about Core Image at <a href="https://developer.apple.com/documentation/coreimage">https://developer.apple.com/documentation/coreimage</a>.</p>
			<p>For this app, you'll just be using 10 filters. The details of these filters are provided in a <code>.plist</code> file. Import this file into your app by following these steps:</p>
			<ol>
				<li>If you have not yet done so, download and unzip the code bundle for this book at this link: <a href="https://github.com/PacktPublishing/iOS-15-Programming-for-Beginners-Sixth-Edition">https://github.com/PacktPublishing/iOS-15-Programming-for-Beginners-Sixth-Edition</a>. You will find the <code>FilterData.plist</code> inside the <code>resources</code> folder in the <code>Chapter20</code> folder.</li>
				<li>In the Project navigator, create a new group inside the <code>PhotoFilter</code> folder and name it <code>Model</code>.</li>
				<li>Drag <code>FilterData.plist</code> to the <code>Model</code> folder. Make sure <strong class="bold">Copy items if needed</strong> is ticked and click <strong class="bold">Finish</strong>.</li>
				<li>Click <code>FilterData.plist</code> in the Project navigator to see what it contains:</li>
			</ol>
			<div><div><img src="img/Figure_20.01_B17469.jpg" alt="Figure 20.1: Editor area showing contents for FilterData.plist&#13;&#10;"/>
				</div>
			</div>
			<p class="figure-caption">Figure 20.1: Editor area showing contents for FilterData.plist</p>
			<p>As you can see, <code>FilterData.plist</code> is an array of dictionaries. Each dictionary contains the name of the filter and a descriptive label. In the next section, you'll see how you can use the<a id="_idIndexMarker1055"/> information in <code>FilterData.plist</code> in your app.</p>
			<h1 id="_idParaDest-278"><a id="_idTextAnchor353"/>Creating model objects for the Photo Filter screen</h1>
			<p>To get the <a id="_idIndexMarker1056"/>information<a id="_idIndexMarker1057"/> from <code>FilterData.plist</code> into your app, you'll create a structure, <code>FilterItem</code>, that can store details about a filter, and a data manager class, <code>FilterManager</code>, that will load <code>FilterData.plist</code> and create an array of <code>FilterItem</code> instances. This is similar to the method used to load cuisine and location information into your app. Let's start by creating the <code>FilterItem</code> structure. Follow these steps:</p>
			<ol>
				<li value="1">Right-click the <code>Model</code> folder in the <code>PhotoFilter</code> folder and select <strong class="bold">New File</strong>.</li>
				<li><strong class="bold">iOS</strong> should already be selected. Choose <strong class="bold">Swift File</strong> and click <strong class="bold">Next</strong>.</li>
				<li>Name this file <code>FilterItem</code>. Click <code>FilterItem</code> file will appear in the Project navigator.</li>
				<li>Inside the <code>FilterItem</code> file, type the following code after the <code>import</code> statement to declare and define the <code>FilterItem</code> structure:<pre>struct FilterItem {
   let filter: String?
   let name: String?
   init(dict: [String: String]) {
      self.filter = dict["filter"] 
      self.name = dict["name"]
   }
}</pre><p>This structure has two properties and an initializer. The <code>filter</code> property will store filter names, and the <code>name</code> property will store the brief filter description. The initializer takes a dictionary as a parameter to set the <code>name</code> and <code>filter</code> properties when an instance of this class is created.</p></li>
			</ol>
			<p>Now that <a id="_idIndexMarker1058"/>you've <a id="_idIndexMarker1059"/>created the <code>FilterItem</code> class, you'll create the data manager class, <code>FilterDataManager</code>. Follow these steps:</p>
			<ol>
				<li value="1">Right-click the <code>Model</code> folder in the <code>PhotoFilter</code> folder and select <strong class="bold">New File</strong>.</li>
				<li><strong class="bold">iOS</strong> should already be selected. Choose <strong class="bold">Swift File</strong> and click <strong class="bold">Next</strong>.</li>
				<li>Name this file <code>FilterDataManager</code>. Click <code>FilterDataManager</code> file will appear in the Project navigator.</li>
				<li>Inside the <code>FilterDataManager</code> file, type in the following code after the <code>import</code> statement to declare and define the <code>FilterDataManager</code> class:<pre>class FilterDataManager: DataManager {
   func fetch() -&gt; [FilterItem] {
      var filterItems: [FilterItem] = []
      for data in loadPlist(file: "FilterData") {
         filterItems.append(FilterItem(dict: 
         data as! [String: String]))
      }
      return filterItems
   }
}</pre><p>The <code>FilterDataManager</code> class adopts the <code>DataManager</code> protocol you created earlier in <a href="B17469_16_Final_VK_ePub.xhtml#_idTextAnchor223"><em class="italic">Chapter 16</em></a><em class="italic">, Getting Started with MapKit</em>. Calling the <code>fetch()</code> method loads data from <code>FilterData.plist</code>, creates an array of <code>FilterItem</code> instances, and returns it.</p></li>
			</ol>
			<p>In the next <a id="_idIndexMarker1060"/>section, you'll<a id="_idIndexMarker1061"/> create a protocol with a method to apply a filter to an image.</p>
			<h1 id="_idParaDest-279"><a id="_idTextAnchor354"/>Creating the ImageFiltering protocol</h1>
			<p>You need a <a id="_idIndexMarker1062"/>way to apply a filter to an image. You will create a protocol, <code>ImageFiltering</code>, that implements a method, <code>apply(filter:to:)</code>, to do this. Any class that adopts this protocol will have access to this method, which applies a specified filter to an image. Follow these steps:</p>
			<ol>
				<li value="1">Right-click the <code>PhotoFilter</code> folder and select <strong class="bold">New File</strong>.</li>
				<li><strong class="bold">iOS</strong> should already be selected. Choose <strong class="bold">Swift File</strong> and click <strong class="bold">Next</strong>.</li>
				<li>Name this file <code>ImageFiltering</code>. Click <code>ImageFiltering</code> file will appear in the Project navigator.</li>
				<li>Modify the code in this file to declare and define the <code>ImageFiltering</code> protocol:<pre>import <code>UIKit</code> framework provides the required infrastructure for your iOS app. You import <code>UIKit</code> instead of <code>Foundation</code> because support for the <code>UIImage</code> class is not available in <code>Foundation</code>.</p><pre>import CoreImage</pre><p>Core Image is an image processing and analysis technology that provides high-performance processing for still and video images. You import <code>CoreImage</code> as it is required to access the built-in photo filters.</p><pre>protocol ImageFiltering {
   func apply(filter: String, originalImage: 
   UIImage) -&gt; UIImage
}</pre><p>Here, you <a id="_idIndexMarker1064"/>declare a protocol named <code>ImageFiltering</code>. This protocol specifies a method, <code>apply(filter:originalImage:)</code>, that takes a filter name and an image as parameters.</p><pre>extension ImageFiltering {
   func apply(filter: String, originalImage:
   UIImage) -&gt; UIImage {</pre><p>This extension of the <code>ImageFiltering</code> protocol contains the implementation of the <code>apply(filter:originalImage:)</code> method. This means that any class that adopts the <code>ImageFiltering</code> protocol will be able to execute this method.</p><pre>let initialCIImage = CIImage(image: 
originalImage, options: nil)</pre><p>This statement converts the original image to a <code>CIImage</code> instance so that you can apply filters to it, and assigns it to <code>initialCIImage</code>.</p><pre>let originalOrientation =
originalImage.imageOrientation </pre><p>This statement stores the original image orientation in <code>originalOrientation</code>.</p><pre>guard let ciFilter = CIFilter(name: filter) 
else {
   print("filter not found")
   return originalImage
}</pre><p>This <code>guard</code> statement gets the filter with the same name as <code>filter</code> and assigns it to <code>ciFilter</code>, and <a id="_idIndexMarker1065"/>returns the original image if the filter is not found.</p><pre>ciFilter.setValue(initialCIImage, forKey: 
kCIInputImageKey)
let context = CIContext()
let filteredCIImage = 
(ciFilter.outputImage)!</pre><p>These statements apply the selected filter to <code>initialCIImage</code> and store the result in <code>filteredCIImage</code>.</p><pre>let filteredCGImage = 
context.createCGImage(filteredCIImage, from: 
filteredCIImage.extent)
return UIImage(cgImage: filteredCGImage!, 
scale: 1.0, orientation: 
originalOrientation)</pre><p>These statements convert the <code>CIImage</code> instance stored in <code>filteredCIImage</code> back into a <code>UIImage</code> instance and returns it.</p></li>
			</ol>
			<p>This completes the implementation of the <code>ImageFiltering</code> protocol and the <code>apply(filter:originalImage:)</code> method. At this point, you have the following:</p>
			<ul>
				<li><code>FilterData.plist</code>, which contains photo filter data inside your app.</li>
				<li><code>FilterItem</code>, a class that can hold a filter and a filter description. </li>
				<li><code>FilterDataManager</code>, a data manager class that loads data from <code>FilterData.plist</code> and generates an array of <code>FilterItem</code> instances.</li>
				<li><code>ImageFiltering</code>, a protocol that contains a method, <code>apply(filter:originalImage:)</code>, which applies a filter to an image.</li>
			</ul>
			<p>In the next<a id="_idIndexMarker1066"/> section, you'll create classes for the UI elements in the <strong class="bold">Photo Filter</strong> screen, which allows you to manage this screen and the collection view inside it.</p>
			<h1 id="_idParaDest-280"><a id="_idTextAnchor355"/>Creating classes for the Photo Filter screen</h1>
			<p>So far, you <a id="_idIndexMarker1067"/>have<a id="_idIndexMarker1068"/> imported <code>FilterData.plist</code> into your app, created the <code>FilterItem</code> and <code>FilterDataManager</code> classes, and created the <code>ImageFiltering</code> protocol. In this section, you'll set up the classes for the <strong class="bold">Photo Filter</strong> screen, which allows you to manage this screen and the collection view inside it.</p>
			<p>Remember that you added the <code>PhotoFilter</code> storyboard file to your project in <a href="B17469_16_Final_VK_ePub.xhtml#_idTextAnchor223"><em class="italic">Chapter 16</em></a><em class="italic">, Getting Started with MapKit</em>. It contains a scene that consists of a large image view that will hold the user-selected photo and a collection view that will display filter previews. The following screenshot shows what this will look like when you have completed the implementation:</p>
			<div><div><img src="img/Figure_20.02_B17469.jpg" alt="Figure 20.2: iOS Simulator showing the completed Photo Filter screen&#13;&#10;"/>
				</div>
			</div>
			<p class="figure-caption">Figure 20.2: iOS Simulator showing the completed Photo Filter screen</p>
			<p>This <a id="_idIndexMarker1069"/>screen <a id="_idIndexMarker1070"/>works as follows. When you tap on the <strong class="bold">Add Photo</strong> button in the <strong class="bold">Restaurant Detail</strong> screen and select a photo, the <strong class="bold">Photo Filter</strong> screen will appear, showing the selected photo with a scrolling list of filters just below it. Each filter in the scrolling list is displayed in a collection view cell. Tapping a filter in the scrolling list will apply the selected filter to the photo.</p>
			<p>In the next section, you'll create and configure a class to manage the collection view cells. Each cell will display a thumbnail preview of what a photo looks like with the filter applied.</p>
			<h2 id="_idParaDest-281"><a id="_idTextAnchor356"/>Creating a class for the collection view cells</h2>
			<p>The <code>PhotoFilter</code> storyboard file in the Project navigator, you will see that the collection view is already present in the <strong class="bold">View Controller Scene</strong>, but there is no way to set the contents of the collection view cells. You will create a class to manage them now. Follow these steps:</p>
			<ol>
				<li value="1">Right-click the <code>PhotoFilter</code> folder and select <strong class="bold">New File</strong>.</li>
				<li><strong class="bold">iOS</strong> should already be selected. Choose <strong class="bold">Cocoa Touch Class</strong> and click <strong class="bold">Next</strong>.</li>
				<li>Configure the file as follows:<p><code>FilterCell</code></p><p><code>UICollectionViewCell </code></p><p><code>Swift</code></p><p>Click <strong class="bold">Next</strong>.</p></li>
				<li>Click <code>FilterCell</code> file will appear in the Project navigator.</li>
				<li>Add the following code to this file to declare and define the <code>FilterCell</code> class:<pre>import UIKit
class FilterCell: UICollectionViewCell {
<code>FilterCell</code> class <a id="_idIndexMarker1073"/>has two <a id="_idIndexMarker1074"/>properties: a label, <code>nameLabel</code>, and an image view, <code>thumbnailImageView</code>. The label will display the filter name, while the image view will display a thumbnail preview of the filter.</p><p>This class also contains two methods, <code>awakeFromNib()</code> and  <code>set(filterItem:imageForThumbnail:)</code>. </p><p>The <code>awakeFromNib()</code> method is called after the <code>FilterCell</code> instance has been loaded, and the two statements inside it round the corners of the image view. </p><p>The <code>set(filterItem:imageForThumbnail:)</code> method takes <code>UIImage</code> and <code>FilterItem</code> instances as parameters, assigns the <code>name</code> property of the <code>FilterItem</code> instance to <code>nameLabel</code>, applies the filter specified by the <code>filter</code> property to the <code>UIImage</code> instance, and assigns the image with the filter applied to <code>thumbnailImageView</code>. </p><p class="callout-heading">Important Information</p><p class="callout">For more details about <code>awakeFromNib()</code>, see this link: <a href="https://developer.apple.com/documentation/objectivec/nsobject/1402907-awakefromnib">https://developer.apple.com/documentation/objectivec/nsobject/1402907-awakefromnib</a>.</p></li>
				<li>Click the <code>PhotoFilter</code> storyboard file in the Project navigator.</li>
				<li>In the <a id="_idIndexMarker1075"/>document <a id="_idIndexMarker1076"/>outline, select <code>FilterCell</code>:<div><img src="img/Figure_20.03_B17469.jpg" alt="Figure 20.3: Identity inspector with Class set to FilterCell&#13;&#10;"/></div><p class="figure-caption">Figure 20.3: Identity inspector with Class set to FilterCell</p></li>
				<li>Click the Attributes inspector button. Set <code>filterCell</code>:<div><img src="img/Figure_20.04_B17469.jpg" alt="Figure 20.4: Attributes inspector with Identifier set to filterCell&#13;&#10;"/></div><p class="figure-caption">Figure 20.4: Attributes inspector with Identifier set to filterCell</p></li>
				<li>Click the <a id="_idIndexMarker1077"/>Connections <a id="_idIndexMarker1078"/>inspector button. Connect the <code>nameLabel</code> and <code>thumbnailImageView</code> outlets to their corresponding UI elements as shown:</li>
			</ol>
			<div><div><img src="img/Figure_20.05_B17469.jpg" alt="Figure 20.5: Connections inspector showing thumbnailImageView and nameLabel outlets&#13;&#10;"/>
				</div>
			</div>
			<p class="figure-caption">Figure 20.5: Connections inspector showing thumbnailImageView and nameLabel outlets</p>
			<p>You have now completed setting up the collection view cells. In the next section, you'll create the view controller for the <strong class="bold">Photo Filter</strong> screen. This will allow you to select a photo and choose a filter to be applied to it.</p>
			<h2 id="_idParaDest-282"><a id="_idTextAnchor357"/>Creating a view controller for the Photo Filter screen</h2>
			<p>So far, you have <a id="_idIndexMarker1079"/>created the <code>FilterCell</code> class<a id="_idIndexMarker1080"/> to manage the collection view cells in the <strong class="bold">Photo Filter</strong> screen. Now you'll create a view controller to manage this screen's contents. Follow these steps:</p>
			<ol>
				<li value="1">Right-click the <code>PhotoFilter</code> folder and select <strong class="bold">New File</strong>.</li>
				<li><strong class="bold">iOS</strong> should already be selected. Choose <strong class="bold">Cocoa Touch Class</strong> and click <strong class="bold">Next</strong>.</li>
				<li>Configure the file, as follows:<p><code>PhotoFilterViewController</code></p><p><code>UIViewController </code></p><p><code>Swift</code></p><p>Click Next.</p></li>
				<li>Click<code>PhotoFilterViewController</code> file will appear in the Project navigator. Delete all the boilerplate code after the <code>viewDidLoad()</code> method.</li>
				<li>Add the following code to the file to declare and define the  <code>PhotoFilterViewController</code> class and its properties:<pre>import UIKit
<code>AVFoundation</code> framework. This framework contains methods for capturing, processing, synthesizing, controlling, importing, and <a id="_idIndexMarker1081"/>exporting audiovisual media on<a id="_idIndexMarker1082"/> Apple platforms.</p><pre>class PhotoFilterViewController: UIViewController {</pre><p>This statement declares the <code>PhotoFilterViewController</code> class, a subclass of the <code>UIViewController</code> class.</p><pre>@IBOutlet var mainImageView: UIImageView!</pre><p>This is an outlet for the image view that will display the user-selected photo with the filter applied. </p><pre>@IBOutlet var collectionView: UICollectionView!</pre><p>This is an outlet for the collection view that will display thumbnail previews of each filter.</p><pre>private let manager = FilterDataManager()</pre><p>This statement assigns an instance of the <code>FilterDataManager</code> class to the  <code>manager</code> property.</p><pre>var selectedRestaurantID:Int?</pre><p>Each restaurant has a unique numeric identifier. This property is used to store that identifier. You'll see how it's used when storing photos using <code>FilterItem</code> instances provided by <code>manager</code>.</p><pre>override func viewDidLoad() { 
   super.viewDidLoad() 
   initialize()
}</pre><p>This method calls an <code>initialize()</code> method when the <code>PhotoFilterViewController</code> instance loads its view. Note that this will generate an error, since <code>initialize()</code> hasn't been implemented yet.</p></li>
				<li>As you did before, you will use extensions to organize your code. Add the following <code>private</code> extension containing the <code>initialize()</code> method after the closing curly brace:<pre>// MARK: - Private Extension
private extension PhotoFilterViewController {
   func initialize() { 
      setupCollectionView() 
      checkSource()
   }
}</pre><p>This extension contains the implementation of the <code>initialize()</code> method, which calls two other methods. <code>setupCollectionView()</code> sets up the collection view used to display the list of filters. <code>checkSource()</code> checks the user authorization status for the use of the camera. Note that these will generate errors since they haven't been implemented yet. You'll implement these methods in the next step.</p></li>
				<li>Implement<a id="_idIndexMarker1085"/> the <code>setupCollectionView()</code> and <code>checkSource()</code> methods<a id="_idIndexMarker1086"/> in the <code>private</code> extension after the <code>initialize()</code> method:<pre>func setupCollectionView() {
   let layout = UICollectionViewFlowLayout() 
   layout.scrollDirection = .horizontal 
   layout.sectionInset = UIEdgeInsets(top: 7, 
   left: 7, bottom: 7, right: 7) 
   layout.minimumInteritemSpacing = 0 
   layout.minimumLineSpacing = 7
   collectionView.collectionViewLayout = layout 
   collectionView.dataSource = self 
   collectionView.delegate = self
}
func checkSource() {
   let cameraMediaType = AVMediaType.video 
   let cameraAuthorizationStatus = 
   AVCaptureDevice.authorizationStatus(for: 
   cameraMediaType)
   switch cameraAuthorizationStatus { 
   case .notDetermined: 
      AVCaptureDevice.requestAccess(for: 
      cameraMediaType) { granted in 
         if granted {
            DispatchQueue.main.async {
               self.showCameraUserInterface()
            }
         }
      }
   case .authorized: 
      self.showCameraUserInterface() 
   default: 
      break
   }
}</pre><p>Let's<a id="_idIndexMarker1087"/> break<a id="_idIndexMarker1088"/> this down:</p><pre>setupCollectionView() </pre><p>Sets up the collection view used to display thumbnail previews of the filters. Here, you create an instance of <code>UICollectionViewFlowLayout</code>, set the scroll direction, section insets, inter-item spacing, and line spacing properties, and assign it to the collection view. After that, you set the <code>PhotoFilterViewController</code> class as the delegate and data source for this collection view. Note that you're setting <code>delegate</code> and <code>dataSource</code> programmatically rather than using the storyboard; either approach is acceptable. Don't worry about the errors, they appear because you haven't adopted the <code>UICollectionViewDataSource</code> and <code>UICollectionViewDelegate</code> protocols for this class yet. You'll fix this later.</p><pre>checkSource() </pre><p>Checks the user authorization status for the use of the camera. Possible cases are as follows:</p><p><code>.notDetermined</code> means the user hasn't been asked for access to the camera.</p><p><code>.authorized</code> means the user has previously granted access to the camera. </p><p><code>.restricted</code> means the user can't be granted access due to restrictions that have been set on the device. </p><p><code>.denied</code> means <a id="_idIndexMarker1089"/>the user has previously <a id="_idIndexMarker1090"/>denied camera access to the app. </p><p>If the status is <code>.notDetermined</code>, the app will ask the user for permission and, if permission is given, the <code>showCameraUserInterface()</code> method is called. If the status is <code>.authorized</code>, the <code>showCameraUserInterface()</code> method is called. Note that this will generate an error because <code>showCameraUserInterface()</code> has not been implemented yet. If the status is <code>.restricted</code> or <code>.denied</code>, it falls under the <code>default:</code> case and the method exits.</p></li>
				<li>There are a few more helper methods required. Add the following code to the <code>private</code> extension to implement them after the <code>checkSource()</code> method:<pre>func showApplyFilterInterface() {
   filters = manager.fetch()
   if let mainImage = self.mainImage { 
      mainImageView.image = mainImage 
      collectionView.reloadData()
   }
}
@IBAction func onPhotoTapped(_ sender: Any) {
   checkSource()
}</pre><p>Let's break this down:</p><pre>showApplyFilterInterface() </pre><p>This method will be called after the user selects a photo from the camera or photo library. It calls the <code>FilterManager</code> instance's <code>fetch()</code> method, which loads <code>FilterData.plist</code> and puts its contents into an array of <code>FilterItem</code> instances. This array is then assigned to the <code>PhotoFilterViewController</code> instance's <code>filters</code> property, which will later be <a id="_idIndexMarker1091"/>used to populate the collection <a id="_idIndexMarker1092"/>view with thumbnail previews of filters. The next statement assigns the <code>PhotoFilterViewController</code> instance's <code>mainImage</code> property to <code>mainImageView</code>, which is the outlet for the image view above the collection view, if <code>mainImage</code> has been set. The final statement tells the collection view to redraw itself.</p><pre>onPhotoTapped() </pre><p>This method calls the <code>checkSource()</code> method you implemented earlier, which calls the <code>showCameraUserInterface()</code> method if authorization has been granted. You'll assign this to the camera button in the <code>NSCameraUsageDescription</code> and <code>NSMicrophoneUsageDescription</code> keys in <code>Info.plist</code>. To learn more about requesting permission to use the camera, go to <a href="https://developer.apple.com/documentation/avfoundation/cameras_and_media_capture/requesting_authorization_for_media_capture_on_ios">https://developer.apple.com/documentation/avfoundation/cameras_and_media_capture/requesting_authorization_for_media_capture_on_ios</a>.</p></li>
				<li>You'll adopt the <code>UICollectionViewDataSource</code> protocol and implement the required methods to make the collection view display thumbnail previews of filters. Add <a id="_idIndexMarker1093"/>a new extension after the <code>private</code> extension<a id="_idIndexMarker1094"/> and implement them as follows:<pre>extension PhotoFilterViewController: 
UICollectionViewDataSource {
   func collectionView(_ collectionView: 
   UICollectionView, numberOfItemsInSection 
   section: Int) -&gt; Int {
      filters.count
   }
   func collectionView(_ collectionView: 
   UICollectionView, cellForItemAt indexPath: 
   IndexPath) -&gt; UICollectionViewCell {
      let cell = collectionView
      .dequeueReusableCell
      (withReuseIdentifier: "filterCell", 
      for: indexPath) as! FilterCell
      let filterItem = filters[indexPath.row]
      if let thumbnail = thumbnail {
         cell.set(filterItem: filterItem, 
         imageForThumbnail: thumbnail)
      }
      return cell
   }
}
collectionView(_:numberOfItemsInSection:) </pre><p>Determines the number of items the collection view is supposed to display, which is the same as the number of <code>FilterItems</code> inside the <code>PhotoFilterViewController</code> instance's <code>filters</code> array.</p><pre>collectionView(_:cellForItemAt:) </pre><p>Determines what to put in each cell. Here, you get the <code>FilterItem</code> instance corresponding to the cell's position in the collection view and pass it, along with the <code>PhotoFilterViewController</code> instance's <code>thumbnail</code> property, to the <code>set(filterItem:imageForThumbnail:)</code> method, which sets the image and<a id="_idIndexMarker1095"/> label for the collection <a id="_idIndexMarker1096"/>view cell.</p></li>
				<li>You've set up the collection view using a <code>UICollectionViewFlowLayout</code> instance earlier. Now you'll set the size for the collection view cells. Add the following extension after the extension containing the data source methods:<pre>extension PhotoFilterViewController: 
UICollectionViewDelegateFlowLayout {
   func collectionView(_ collectionView: 
   UICollectionView, layout 
   collectionViewLayout: 
   UICollectionViewLayout, sizeForItemAt 
   indexPath: IndexPath) -&gt; CGSize {
      let collectionViewHeight = 
      collectionView.frame.size.height 
      let topInset = 14.0
      let cellHeight = collectionViewHeight - 
      topInset
      return CGSize(width: 150, height: 
      cellHeight)
   }
}</pre><p><code>collectionView(_:layout:sizeForItemAt:)</code> returns the size each collection view cell should be. First, the height of the collection view is assigned to <code>collectionViewHeight</code>. Then, the value of <code>topInset</code> is set to <code>14.0</code> points. The height of the collection view cell is calculated by subtracting the <code>topInset</code> from the <code>collectionViewHeight</code>. This results in a 14-point gap between the top of the collection view cells and the top of the collection view. Finally, a <code>CGSize</code> instance<a id="_idIndexMarker1097"/> with the width set to <code>150</code> points and the height<a id="_idIndexMarker1098"/> set to <code>cellHeight</code> is returned as the size of the collection view cell. Previously, you did this using the Size inspector; now, you're doing it programmatically.</p></li>
			</ol>
			<p>Now you'll connect the outlets and actions in this class to the UI elements in the <code>PhotoFilter</code> storyboard file. <code>collectionView</code> is the outlet for the collection view that displays the list of filters. <code>mainImageView</code> is for the image view just above it, which shows the image the user selected. <code>onPhotoTapped()</code> is for the camera button in the navigation bar. You'll also configure the <strong class="bold">Cancel</strong> button to dismiss the <strong class="bold">Photo Filter</strong> screen. Follow these steps:</p>
			<ol>
				<li value="1">Click the <code>PhotoFilter</code> storyboard file in the Project navigator. Select the <code>PhotoFilterViewController</code>:<div><img src="img/Figure_20.06_B17469.jpg" alt="Figure 20.6: Identity inspector with Class set to PhotoFilterViewController&#13;&#10;"/></div><p class="figure-caption">Figure 20.6: Identity inspector with Class set to PhotoFilterViewController</p></li>
				<li>Select the Connections inspector. Click and drag from the <code>collectionView</code> outlet to the <strong class="bold">Collection View</strong> in the document outline:<div><img src="img/Figure_20.07_B17469.jpg" alt="Figure 20.7: Connections inspector showing the collectionView outlet&#13;&#10;"/></div><p class="figure-caption">Figure 20.7: Connections inspector showing the collectionView outlet</p></li>
				<li>Click and<a id="_idIndexMarker1099"/> drag from the <code>mainImageView</code> outlet <a id="_idIndexMarker1100"/>to the <strong class="bold">Image View</strong> in the document outline:<div><img src="img/Figure_20.08_B17469.jpg" alt="Figure 20.8: Connections inspector showing the mainImageView outlet&#13;&#10;"/></div><p class="figure-caption">Figure 20.8: Connections inspector showing the mainImageView outlet</p></li>
				<li>Click and drag from the <code>onPhotoTapped:</code> action to the camera button:<div><img src="img/Figure_20.09_B17469.jpg" alt="Figure 20.9: Connections inspector showing onPhotoTapped: action&#13;&#10;"/></div><p class="figure-caption">Figure 20.9: Connections inspector showing onPhotoTapped: action</p></li>
				<li>The <strong class="bold">Cancel</strong> button is used to exit this screen if the user does not wish to make a selection. You'll<a id="_idIndexMarker1101"/> connect the <strong class="bold">Cancel</strong> button to the unwind method you implemented in the previous chapter, which will dismiss this screen and return the user to the <strong class="bold">Restaurant Detail</strong> screen. <em class="italic">Ctrl + Drag</em> from the <strong class="bold">Cancel</strong> button to the Exit icon in the Scene Dock:<div><img src="img/Figure_20.10_B17469.jpg" alt="Figure 20.10: Photo Filter View Controller Scene showing Cancel button action being set&#13;&#10;"/></div><p class="figure-caption">Figure 20.10: Photo Filter View Controller Scene showing Cancel button action being set</p></li>
				<li>Select <code>unwindReviewCancelWithSegue:</code> in the pop-up menu:</li>
			</ol>
			<div><div><img src="img/Figure_20.11_B17469.jpg" alt="Figure 20.11: Pop-up menu with unwindReviewCancelWithSegue: selected&#13;&#10;"/>
				</div>
			</div>
			<p class="figure-caption">Figure 20.11: Pop-up menu with unwindReviewCancelWithSegue: selected</p>
			<p>All the <a id="_idIndexMarker1102"/>outlets and actions for the <code>PhotoFilterViewController</code> class have been connected.</p>
			<p>Next, you will implement the following methods:</p>
			<ul>
				<li><code>showCameraUserInterface()</code>, a method that will display either the view from the device camera or the photo library in an image picker interface.</li>
				<li>Two <code>UIImagePickerControllerDelegate</code> protocol methods that will be called when you choose a picture in the image picker interface or click the <code>UIImagePickerController</code>, go to <a href="https://developer.apple.com/documentation/uikit/uiimagepickercontroller">https://developer.apple.com/documentation/uikit/uiimagepickercontroller</a>.</p><p class="callout-heading">Important Information</p><p class="callout">To learn more about <code>UIImagePickerControllerDelegate</code>, go to <a href="https://developer.apple.com/documentation/uikit/uiimagepickercontrollerdelegate">https://developer.apple.com/documentation/uikit/uiimagepickercontrollerdelegate</a>.</p></li>
			</ul>
			<p>To implement the <code>showCameraUserInterface()</code> and <code>UIImagePickerControllerDelegate</code> methods, click the <code>PhotoFilterViewController</code> file in the Project <a id="_idIndexMarker1103"/>navigator and add the following extension<a id="_idIndexMarker1104"/> after the <code>UICollectionViewDelegateFlowLayout</code> extension:</p>
			<pre>extension PhotoFilterViewController: UIImagePickerControllerDelegate, 
UINavigationControllerDelegate {
   func showCameraUserInterface() {
      let imagePicker = UIImagePickerController()
      imagePicker.delegate = self
   #if targetEnvironment(simulator)
      imagePicker.sourceType = 
      UIImagePickerController.SourceType.photoLibrary
   #else
      imagePicker.sourceType = 
      UIImagePickerController.SourceType.camera
      imagePicker.showsCameraControls = true
   #endif
      imagePicker.mediaTypes = ["public.image"]
      imagePicker.allowsEditing = true 
      self.present(imagePicker, animated: true, 
      completion: nil)
   }
   func imagePickerControllerDidCancel(_ picker: 
   UIImagePickerController) {
      picker.dismiss(animated: true, completion: nil)
   }
   func imagePickerController(_ picker: 
   UIImagePickerController, 
   didFinishPickingMediaWithInfo info:
   [UIImagePickerController.InfoKey : Any]) {
      if let selectedImage = 
      info[UIImagePickerController.InfoKey
      .editedImage] as? UIImage {
         self.thumbnail = 
         selectedImage.preparingThumbnail(of: 
         CGSize(width: 100, height: 100))
         let mainImageViewSize = 
         mainImageView.frame.size
         self.mainImage = 
         selectedImage.preparingThumbnail(of: 
         mainImageViewSize)
      }
      picker.dismiss(animated: true){ 
         self.showApplyFilterInterface()
      }
   }
}</pre>
			<p>Let's talk<a id="_idIndexMarker1105"/> about <code>showCameraUserInterface()</code> first. This method is triggered when the camera button is<a id="_idIndexMarker1106"/> tapped, displaying an image picker on the screen. This image picker is the standard iOS image picker that appears when you want to use an image—for instance, to add an image to a Facebook post or to a tweet. </p>
			<p>Let's break this down:</p>
			<pre>let imagePicker = UIImagePickerController()</pre>
			<p>Creates an instance of the <code>UIImagePickerController</code> class and assigns it to <code>imagePicker</code>.</p>
			<pre>imagePicker.delegate = self</pre>
			<p>Sets the <code>imagePicker</code> instance's <code>delegate</code> property to the <code>PhotoFilterViewController</code> instance. </p>
			<pre>#if targetEnvironment(simulator)
   imagePicker.sourceType = 
   UIImagePickerController.SourceType.photoLibrary
#else
   imagePicker.sourceType = 
   UIImagePickerController.SourceType.camera
   imagePicker.showsCameraControls = true
#endif</pre>
			<p>This block of <a id="_idIndexMarker1107"/>code is known as a conditional<a id="_idIndexMarker1108"/> compilation block. It starts with an <code>#if</code> compilation directive and ends with an <code>#endif</code> compilation directive. If you're running on the simulator, only the statement setting the <code>imagePicker</code> instance's <code>sourceType</code> property to the photo library is compiled. If you're running on an actual device, the statements setting the <code>imagePicker</code> instance's <code>sourceType</code> property to camera and displaying the camera controls are compiled.</p>
			<p class="callout-heading">Important Information</p>
			<p class="callout">You can learn more about conditional compilation blocks at this link: <a href="https://docs.swift.org/swift-book/ReferenceManual/Statements.html#ID538">https://docs.swift.org/swift-book/ReferenceManual/Statements.html#ID538</a>.</p>
			<pre>imagePicker.mediaTypes = ["public.image"]</pre>
			<p>Sets the camera interface to capture still images. </p>
			<pre>imagePicker.allowsEditing = true </pre>
			<p>Indicates the user is allowed to edit the selected image.</p>
			<pre>self.present(imagePicker, animated: true, completion: nil)</pre>
			<p>Presents <code>imagePicker</code> on the screen.</p>
			<p>When the image picker appears onscreen, you have the option of selecting a photo or canceling. If you cancel, <code>imagePickerControllerDidCancel(_:)</code> is triggered and the image picker is dismissed.</p>
			<p>If you select a photo, <code>imagePickerController(_:didFinishPickingMediaWithInfo:)</code> is triggered and a photo will be returned and assigned to <code>selectedImage</code>. Next, the <code>selectedImage</code> instance's <code>preparingThumbnail(of:)</code> method will be used to create a small image with a width and height of <code>100</code> points. This will then be assigned to the <code>thumbnail</code> property. After that, an image with the same size as <code>mainImageView</code> will be created from <code>selectedImage</code> using the <code>preparingThumbnail(of:)</code> method. This will be assigned to the <code>mainImage</code> property and<a id="_idIndexMarker1109"/> the image picker will be dismissed.</p>
			<p class="callout-heading">Important Information</p>
			<p class="callout">You can learn more about the <code>preparingThumbnail(of:)</code> method at this link: <a href="https://developer.apple.com/documentation/uikit/uiimage/3750835-preparingthumbnail">https://developer.apple.com/documentation/uikit/uiimage/3750835-preparingthumbnail</a>.</p>
			<p>Next, you'll implement <code>filterMainImage(filterItem:)</code>, a method to apply a filter to the image in the <code>mainImageView</code>. Add an extension containing this method after the <code>UIImagePickerControllerDelegate</code> extension:</p>
			<pre>extension PhotoFilterViewController: ImageFiltering {
   func filterMainImage(filterItem: FilterItem) {
      if let mainImage = mainImage, let filter = 
      filterItem.filter {
         if filter != "None" {
            mainImageView.image = 
            self.apply(filter: filter, 
            originalImage: mainImage)
         } else {
            mainImageView.image = mainImage
         }
      }
   }
}</pre>
			<p>This makes the <code>PhotoFilterViewController</code> class adopt the <code>ImageFiltering</code> protocol. Remember that any class that adopts this protocol gets the <code>apply(filter:originalImage:)</code> method. The <code>filterMainImage(filterItem:)</code> method uses this method to apply the selected <a id="_idIndexMarker1110"/>filter<a id="_idIndexMarker1111"/> to the photo stored in the <code>PhotoFilterViewController</code> instance's <code>mainImage</code> property, and the result is assigned to the <code>mainImageView</code> outlet so that it is visible on the screen. If you selected the <code>None</code> filter, then <code>mainImage</code> is assigned to the <code>mainImageView</code> outlet.</p>
			<p>You still need to know which filter the user picked, so you'll make the <code>PhotoFilterViewController</code> class adopt the <code>UICollectionViewDelegate</code> protocol and implement the method that identifies which cell in the collection view was tapped. Add the following extension containing<a id="_idTextAnchor358"/><a id="_idTextAnchor359"/> this method after the <code>ImageFiltering</code> extension:</p>
			<pre>extension PhotoFilterViewController: 
UICollectionViewDelegate {
   func collectionView(_ collectionView: 
   UICollectionView, didSelectItemAt 
   indexPath: IndexPath) { 
      let filterItem = self.filters[indexPath.row] 
      filterMainImage(filterItem: filterItem)
   }
}</pre>
			<p>The <code>collectionView(_:didSelectItemAt:)</code> method is called whenever the user taps a cell in the collection view. The <code>FilterItem</code> corresponding to the cell that was tapped is then passed to <code>filterMainImage(filterItem:)</code>.</p>
			<p>The implementation of the <code>PhotoFilterViewController</code> class is now complete but remember that you have to ask for permission to use the camera or to access the photo<a id="_idIndexMarker1112"/> library. You'll modify the <code>Info.plist</code> file<a id="_idIndexMarker1113"/> in your project so that messages will be displayed to the user when your app attempts to access the camera or photo library.</p>
			<h1 id="_idParaDest-283"><a id="_idTextAnchor360"/>Getting permission to use the camera or photo library</h1>
			<p>As mentioned<a id="_idIndexMarker1114"/> earlier, Apple stipulates that your app must inform the user if it wishes to access the camera or photo library. If you don't do this, your app will be rejected and will not be allowed on the App Store.</p>
			<p>You'll modify the <code>Info.plist</code> file in your project to make your app display messages when it tries to access the camera or photo library. Follow these steps:</p>
			<ol>
				<li value="1">Click the <code>Info.plist</code> file in the Project navigator to display a list of keys. Move your mouse pointer over any existing key and click the <strong class="bold">+</strong> button:<div><img src="img/Figure_20.12_B17469.jpg" alt="Figure 20.12: Editor area showing contents of Info.plist&#13;&#10;"/></div><p class="figure-caption">Figure 20.12: Editor area showing contents of Info.plist</p></li>
				<li>A field should appear, allowing you to enter an additional key:<div><img src="img/Figure_20.13_B17469.jpg" alt="Figure 20.13: Editor area showing field used to enter keys&#13;&#10;"/></div><p class="figure-caption">Figure 20.13: Editor area showing field used to enter keys</p></li>
				<li>Enter the following keys:<pre>NSPhotoLibraryUsageDescription
NSCameraUsageDescription</pre></li>
				<li>For each key's <a id="_idIndexMarker1115"/>value, enter a string that explains to the user why you wish to use the camera or photo library:</li>
			</ol>
			<div><div><img src="img/Figure_20.14_B17469.jpg" alt="Figure 20.14: Info.plist with additional keys added&#13;&#10;"/>
				</div>
			</div>
			<p class="figure-caption">Figure 20.14: Info.plist with additional keys added</p>
			<p>Build and run the project. Go to the <strong class="bold">Restaurant Detail</strong> screen and tap the <strong class="bold">Add Photo</strong> button. You should see the following alert:</p>
			<div><div><img src="img/Figure_20.15_B17469.jpg" alt="Figure 20.15: iOS Simulator showing camera access alert&#13;&#10;"/>
				</div>
			</div>
			<p class="figure-caption">Figure 20.15: iOS Simulator showing camera access alert</p>
			<p>Tap <strong class="bold">OK</strong>. The<a id="_idIndexMarker1116"/> image picker will appear:</p>
			<div><div><img src="img/Figure_20.16_B17469.jpg" alt="Figure 20.16: iOS Simulator showing image picker&#13;&#10;"/>
				</div>
			</div>
			<p class="figure-caption">Figure 20.16: iOS Simulator showing image picker</p>
			<p>Select a photo, and the <strong class="bold">Photo Filter</strong> screen will display the photo and a list of thumbnails <a id="_idIndexMarker1117"/>with different filters applied to them. Tapping a filter will apply its effect to the photo:</p>
			<div><div><img src="img/Figure_20.17_B17469.jpg" alt="Figure 20.17: iOS Simulator showing Photo Filter screen&#13;&#10;"/>
				</div>
			</div>
			<p class="figure-caption">Figure 20.17: iOS Simulator showing Photo Filter screen</p>
			<p>You've modified the <code>info.plist</code> file in your project and your app now asks for permission before using the camera or the photo library. You can use the <strong class="bold">Cancel</strong> button to<a id="_idIndexMarker1118"/> dismiss the <strong class="bold">Photo Filter</strong> screen and return to the <strong class="bold">Restaurant Detail</strong> screen. You can't use the <strong class="bold">Save</strong> button yet though, you'll implement its functionality in the next chapter.</p>
			<h1 id="_idParaDest-284"><a id="_idTextAnchor361"/>Summary</h1>
			<p>In this chapter, you completed the implementation of the <code>FilterData.plist</code>, a <code>.plist</code> file containing the filters you want to use, created the <code>FilterItem</code> class to store filter data, and created the <code>FilterManager</code> data manager class to read the <code>.plist</code> file and populate an array of <code>FilterItem</code> instances. Next, you created a protocol, <code>ImageFiltering</code>, with a method to apply filters to images. Then, you created the <code>FilterCell</code> and <code>PhotoFilterViewController</code> classes in order to manage the collection view cells and the <code>PhotoFilterViewController</code> class adopt the <code>UIImagePickerDelegate</code> protocol, and added methods so that you can use photos from the camera or photo library in your app. Finally, you added code to <code>PhotoFilterViewController</code> to apply a selected filter to a picture.</p>
			<p>You are now able to write your own apps that import photos from your camera or photo library, and apply filters to them. </p>
			<p>Note that the selected picture cannot be saved. You will learn how to save reviews and pictures using Core Data in the next chapter so that they will reappear after you quit and relaunch the app.</p>
		</div>
	</body></html>