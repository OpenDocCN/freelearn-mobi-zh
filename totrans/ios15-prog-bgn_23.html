<html><head></head><body>
		<div id="_idContainer479">
			<h1 id="_idParaDest-275"><em class="italic"><a id="_idTextAnchor350"/>Chapter 20</em>: Getting Started with Cameras and Photo Libraries</h1>
			<p>In the previous chapter, you created the <strong class="source-inline">RatingsView</strong> class and added it to the <strong class="bold">Restaurant Detail</strong> and <strong class="bold">Review Form</strong> screens. You also enabled the user to submit a review using the <strong class="bold">Review Form</strong> screen, although the submitted review is only printed to the Debug area for now.</p>
			<p>In this chapter, you will complete the implementation of the <strong class="bold">Photo Filter</strong> screen so you can get a photo from the camera or photo library, and apply a filter to it. You'll start by importing a <strong class="source-inline">.plist</strong> file containing the filters you want to use, then create a filter object class to store filter data, and create a data manager class to read the <strong class="source-inline">.plist</strong> file and populate an array of filter objects. Next, you'll create a protocol with a method to apply filters to images. After that, you'll create view controllers for the <strong class="bold">Photo Filter</strong> screen and the collection view in it, implement the <strong class="source-inline">UIImagePickerDelegate</strong> protocol, which allows you to get photos from the camera or the photo library, and implement methods to apply a selected filter to a photo. Note that the photo will not be saved. You will learn how to save reviews and photos in the next chapter.</p>
			<p>By the end of this chapter, you'll have learned how to import photos into your own apps, and how to apply filters to them.</p>
			<p>The following topics will be covered in this chapter: </p>
			<ul>
				<li>Understanding filters</li>
				<li>Creating model objects for the <strong class="bold">Photo Filter</strong> screen</li>
				<li>Creating the <strong class="source-inline">ImageFiltering</strong> protocol</li>
				<li>Creating classes for the <strong class="bold">Photo Filter</strong> screen</li>
				<li>Implementing the image picker delegate protocol</li>
				<li>Getting permission to use the camera or photo library</li>
			</ul>
			<h1 id="_idParaDest-276"><a id="_idTextAnchor351"/>Technical requirements</h1>
			<p>You will continue working on the <strong class="source-inline">LetsEat</strong> project that you modified in the previous chapter.</p>
			<p>The resource files and completed Xcode project for this chapter are in the <strong class="source-inline">Chapter20</strong> folder of the code bundle for this book, which can be downloaded here:</p>
			<p><a href="https://github.com/PacktPublishing/iOS-15-Programming-for-Beginners-Sixth-Edition">https://github.com/PacktPublishing/iOS-15-Programming-for-Beginners-Sixth-Edition</a><a href="https://github.com/PacktPublishing/iOS-15-Programming-for-Beginners-Sixth-Edition&#13;"/></p>
			<p>Check out the following video to see the code in action:</p>
			<p><a href="https://bit.ly/3oZZ93P">https://bit.ly/3oZZ93P</a><a href="https://bit.ly/3oZZ93P&#13;"/></p>
			<p>Let's start by learning about photo filters, and how to apply them to images.</p>
			<h1 id="_idParaDest-277"><a id="_idTextAnchor352"/>Understanding filters</h1>
			<p>iOS has a <a id="_idIndexMarker1052"/>range of built-in filters that you can use to enhance photos. These filters are <a id="_idIndexMarker1053"/>available via the <strong class="bold">Core Image</strong> library. Core Image is an image processing and analysis technology that provides high-performance processing for still and video images. There are over 170 filters available in Core Image, giving you the ability to apply a wide range of cool effects to your photos.</p>
			<p class="callout-heading">Important Information</p>
			<p class="callout">You can learn more<a id="_idIndexMarker1054"/> about Core Image at <a href="https://developer.apple.com/documentation/coreimage">https://developer.apple.com/documentation/coreimage</a>.</p>
			<p>For this app, you'll just be using 10 filters. The details of these filters are provided in a <strong class="source-inline">.plist</strong> file. Import this file into your app by following these steps:</p>
			<ol>
				<li>If you have not yet done so, download and unzip the code bundle for this book at this link: <a href="https://github.com/PacktPublishing/iOS-15-Programming-for-Beginners-Sixth-Edition">https://github.com/PacktPublishing/iOS-15-Programming-for-Beginners-Sixth-Edition</a>. You will find the <strong class="source-inline">FilterData.plist</strong> inside the <strong class="source-inline">resources</strong> folder in the <strong class="source-inline">Chapter20</strong> folder.</li>
				<li>In the Project navigator, create a new group inside the <strong class="source-inline">PhotoFilter</strong> folder and name it <strong class="source-inline">Model</strong>.</li>
				<li>Drag <strong class="source-inline">FilterData.plist</strong> to the <strong class="source-inline">Model</strong> folder. Make sure <strong class="bold">Copy items if needed</strong> is ticked and click <strong class="bold">Finish</strong>.</li>
				<li>Click <strong class="source-inline">FilterData.plist</strong> in the Project navigator to see what it contains:</li>
			</ol>
			<div>
				<div id="_idContainer462" class="IMG---Figure">
					<img src="image/Figure_20.01_B17469.jpg" alt="Figure 20.1: Editor area showing contents for FilterData.plist&#13;&#10;"/>
				</div>
			</div>
			<p class="figure-caption">Figure 20.1: Editor area showing contents for FilterData.plist</p>
			<p>As you can see, <strong class="source-inline">FilterData.plist</strong> is an array of dictionaries. Each dictionary contains the name of the filter and a descriptive label. In the next section, you'll see how you can use the<a id="_idIndexMarker1055"/> information in <strong class="source-inline">FilterData.plist</strong> in your app.</p>
			<h1 id="_idParaDest-278"><a id="_idTextAnchor353"/>Creating model objects for the Photo Filter screen</h1>
			<p>To get the <a id="_idIndexMarker1056"/>information<a id="_idIndexMarker1057"/> from <strong class="source-inline">FilterData.plist</strong> into your app, you'll create a structure, <strong class="source-inline">FilterItem</strong>, that can store details about a filter, and a data manager class, <strong class="source-inline">FilterManager</strong>, that will load <strong class="source-inline">FilterData.plist</strong> and create an array of <strong class="source-inline">FilterItem</strong> instances. This is similar to the method used to load cuisine and location information into your app. Let's start by creating the <strong class="source-inline">FilterItem</strong> structure. Follow these steps:</p>
			<ol>
				<li value="1">Right-click the <strong class="source-inline">Model</strong> folder in the <strong class="source-inline">PhotoFilter</strong> folder and select <strong class="bold">New File</strong>.</li>
				<li><strong class="bold">iOS</strong> should already be selected. Choose <strong class="bold">Swift File</strong> and click <strong class="bold">Next</strong>.</li>
				<li>Name this file <strong class="source-inline">FilterItem</strong>. Click <strong class="bold">Create</strong>. The <strong class="source-inline">FilterItem</strong> file will appear in the Project navigator.</li>
				<li>Inside the <strong class="source-inline">FilterItem</strong> file, type the following code after the <strong class="source-inline">import</strong> statement to declare and define the <strong class="source-inline">FilterItem</strong> structure:<p class="source-code">struct FilterItem {</p><p class="source-code">   let filter: String?</p><p class="source-code">   let name: String?</p><p class="source-code">   init(dict: [String: String]) {</p><p class="source-code">      self.filter = dict["filter"] </p><p class="source-code">      self.name = dict["name"]</p><p class="source-code">   }</p><p class="source-code">}</p><p>This structure has two properties and an initializer. The <strong class="source-inline">filter</strong> property will store filter names, and the <strong class="source-inline">name</strong> property will store the brief filter description. The initializer takes a dictionary as a parameter to set the <strong class="source-inline">name</strong> and <strong class="source-inline">filter</strong> properties when an instance of this class is created.</p></li>
			</ol>
			<p>Now that <a id="_idIndexMarker1058"/>you've <a id="_idIndexMarker1059"/>created the <strong class="source-inline">FilterItem</strong> class, you'll create the data manager class, <strong class="source-inline">FilterDataManager</strong>. Follow these steps:</p>
			<ol>
				<li value="1">Right-click the <strong class="source-inline">Model</strong> folder in the <strong class="source-inline">PhotoFilter</strong> folder and select <strong class="bold">New File</strong>.</li>
				<li><strong class="bold">iOS</strong> should already be selected. Choose <strong class="bold">Swift File</strong> and click <strong class="bold">Next</strong>.</li>
				<li>Name this file <strong class="source-inline">FilterDataManager</strong>. Click <strong class="bold">Create</strong>. The <strong class="source-inline">FilterDataManager</strong> file will appear in the Project navigator.</li>
				<li>Inside the <strong class="source-inline">FilterDataManager</strong> file, type in the following code after the <strong class="source-inline">import</strong> statement to declare and define the <strong class="source-inline">FilterDataManager</strong> class:<p class="source-code">class FilterDataManager: DataManager {</p><p class="source-code">   func fetch() -&gt; [FilterItem] {</p><p class="source-code">      var filterItems: [FilterItem] = []</p><p class="source-code">      for data in loadPlist(file: "FilterData") {</p><p class="source-code">         filterItems.append(FilterItem(dict: </p><p class="source-code">         data as! [String: String]))</p><p class="source-code">      }</p><p class="source-code">      return filterItems</p><p class="source-code">   }</p><p class="source-code">}</p><p>The <strong class="source-inline">FilterDataManager</strong> class adopts the <strong class="source-inline">DataManager</strong> protocol you created earlier in <a href="B17469_16_Final_VK_ePub.xhtml#_idTextAnchor223"><em class="italic">Chapter 16</em></a><em class="italic">, Getting Started with MapKit</em>. Calling the <strong class="source-inline">fetch()</strong> method loads data from <strong class="source-inline">FilterData.plist</strong>, creates an array of <strong class="source-inline">FilterItem</strong> instances, and returns it.</p></li>
			</ol>
			<p>In the next <a id="_idIndexMarker1060"/>section, you'll<a id="_idIndexMarker1061"/> create a protocol with a method to apply a filter to an image.</p>
			<h1 id="_idParaDest-279"><a id="_idTextAnchor354"/>Creating the ImageFiltering protocol</h1>
			<p>You need a <a id="_idIndexMarker1062"/>way to apply a filter to an image. You will create a protocol, <strong class="source-inline">ImageFiltering</strong>, that implements a method, <strong class="source-inline">apply(filter:to:)</strong>, to do this. Any class that adopts this protocol will have access to this method, which applies a specified filter to an image. Follow these steps:</p>
			<ol>
				<li value="1">Right-click the <strong class="source-inline">PhotoFilter</strong> folder and select <strong class="bold">New File</strong>.</li>
				<li><strong class="bold">iOS</strong> should already be selected. Choose <strong class="bold">Swift File</strong> and click <strong class="bold">Next</strong>.</li>
				<li>Name this file <strong class="source-inline">ImageFiltering</strong>. Click <strong class="bold">Create</strong>. The <strong class="source-inline">ImageFiltering</strong> file will appear in the Project navigator.</li>
				<li>Modify the code in this file to declare and define the <strong class="source-inline">ImageFiltering</strong> protocol:<p class="source-code">import <strong class="bold">UIKit</strong> </p><p class="source-code"><strong class="bold">import CoreImage</strong></p><p class="source-code"><strong class="bold">protocol ImageFiltering {</strong></p><p class="source-code"><strong class="bold">   func apply(filter: String, originalImage: </strong></p><p class="source-code"><strong class="bold">   UIImage) -&gt; UIImage</strong></p><p class="source-code"><strong class="bold">}</strong></p><p class="source-code"><strong class="bold">extension ImageFiltering {</strong></p><p class="source-code"><strong class="bold">   func apply(filter: String, originalImage: </strong></p><p class="source-code"><strong class="bold">   UIImage) -&gt; UIImage {</strong></p><p class="source-code"><strong class="bold">      let initialCIImage = CIImage(image: </strong></p><p class="source-code"><strong class="bold">      originalImage, options: nil)</strong></p><p class="source-code"><strong class="bold">      let originalOrientation = </strong></p><p class="source-code"><strong class="bold">      originalImage.imageOrientation</strong></p><p class="source-code"><strong class="bold">      guard let ciFilter = CIFilter(name: </strong></p><p class="source-code"><strong class="bold">      filter) else {</strong></p><p class="source-code"><strong class="bold">         print("filter not found")</strong></p><p class="source-code"><strong class="bold">         return originalImage</strong></p><p class="source-code"><strong class="bold">      }</strong></p><p class="source-code"><strong class="bold">      ciFilter.setValue(initialCIImage, forKey:</strong></p><p class="source-code"><strong class="bold">      kCIInputImageKey)</strong></p><p class="source-code"><strong class="bold">      let context = CIContext()</strong></p><p class="source-code"><strong class="bold">      let filteredCIImage = </strong></p><p class="source-code"><strong class="bold">      (ciFilter.outputImage)!</strong></p><p class="source-code"><strong class="bold">      let filteredCGImage = </strong></p><p class="source-code"><strong class="bold">      context.createCGImage(filteredCIImage, </strong></p><p class="source-code"><strong class="bold">      from: filteredCIImage.extent)</strong></p><p class="source-code"><strong class="bold">      return UIImage(cgImage: filteredCGImage!, </strong></p><p class="source-code"><strong class="bold">      scale: 1.0, orientation: </strong></p><p class="source-code"><strong class="bold">      originalOrientation)</strong></p><p class="source-code"><strong class="bold">   }</strong></p><p class="source-code"><strong class="bold">}</strong></p><p>Let's break<a id="_idIndexMarker1063"/> this down:</p><p class="source-code">import UIKit</p><p>The <strong class="source-inline">UIKit</strong> framework provides the required infrastructure for your iOS app. You import <strong class="source-inline">UIKit</strong> instead of <strong class="source-inline">Foundation</strong> because support for the <strong class="source-inline">UIImage</strong> class is not available in <strong class="source-inline">Foundation</strong>.</p><p class="source-code">import CoreImage</p><p>Core Image is an image processing and analysis technology that provides high-performance processing for still and video images. You import <strong class="source-inline">CoreImage</strong> as it is required to access the built-in photo filters.</p><p class="source-code">protocol ImageFiltering {</p><p class="source-code">   func apply(filter: String, originalImage: </p><p class="source-code">   UIImage) -&gt; UIImage</p><p class="source-code">}</p><p>Here, you <a id="_idIndexMarker1064"/>declare a protocol named <strong class="source-inline">ImageFiltering</strong>. This protocol specifies a method, <strong class="source-inline">apply(filter:originalImage:)</strong>, that takes a filter name and an image as parameters.</p><p class="source-code">extension ImageFiltering {</p><p class="source-code">   func apply(filter: String, originalImage:</p><p class="source-code">   UIImage) -&gt; UIImage {</p><p>This extension of the <strong class="source-inline">ImageFiltering</strong> protocol contains the implementation of the <strong class="source-inline">apply(filter:originalImage:)</strong> method. This means that any class that adopts the <strong class="source-inline">ImageFiltering</strong> protocol will be able to execute this method.</p><p class="source-code">let initialCIImage = CIImage(image: </p><p class="source-code">originalImage, options: nil)</p><p>This statement converts the original image to a <strong class="source-inline">CIImage</strong> instance so that you can apply filters to it, and assigns it to <strong class="source-inline">initialCIImage</strong>.</p><p class="source-code">let originalOrientation =</p><p class="source-code">originalImage.imageOrientation </p><p>This statement stores the original image orientation in <strong class="source-inline">originalOrientation</strong>.</p><p class="source-code">guard let ciFilter = CIFilter(name: filter) </p><p class="source-code">else {</p><p class="source-code">   print("filter not found")</p><p class="source-code">   return originalImage</p><p class="source-code">}</p><p>This <strong class="source-inline">guard</strong> statement gets the filter with the same name as <strong class="source-inline">filter</strong> and assigns it to <strong class="source-inline">ciFilter</strong>, and <a id="_idIndexMarker1065"/>returns the original image if the filter is not found.</p><p class="source-code">ciFilter.setValue(initialCIImage, forKey: </p><p class="source-code">kCIInputImageKey)</p><p class="source-code">let context = CIContext()</p><p class="source-code">let filteredCIImage = </p><p class="source-code">(ciFilter.outputImage)!</p><p>These statements apply the selected filter to <strong class="source-inline">initialCIImage</strong> and store the result in <strong class="source-inline">filteredCIImage</strong>.</p><p class="source-code">let filteredCGImage = </p><p class="source-code">context.createCGImage(filteredCIImage, from: </p><p class="source-code">filteredCIImage.extent)</p><p class="source-code">return UIImage(cgImage: filteredCGImage!, </p><p class="source-code">scale: 1.0, orientation: </p><p class="source-code">originalOrientation)</p><p>These statements convert the <strong class="source-inline">CIImage</strong> instance stored in <strong class="source-inline">filteredCIImage</strong> back into a <strong class="source-inline">UIImage</strong> instance and returns it.</p></li>
			</ol>
			<p>This completes the implementation of the <strong class="source-inline">ImageFiltering</strong> protocol and the <strong class="source-inline">apply(filter:originalImage:)</strong> method. At this point, you have the following:</p>
			<ul>
				<li><strong class="source-inline">FilterData.plist</strong>, which contains photo filter data inside your app.</li>
				<li><strong class="source-inline">FilterItem</strong>, a class that can hold a filter and a filter description. </li>
				<li><strong class="source-inline">FilterDataManager</strong>, a data manager class that loads data from <strong class="source-inline">FilterData.plist</strong> and generates an array of <strong class="source-inline">FilterItem</strong> instances.</li>
				<li><strong class="source-inline">ImageFiltering</strong>, a protocol that contains a method, <strong class="source-inline">apply(filter:originalImage:)</strong>, which applies a filter to an image.</li>
			</ul>
			<p>In the next<a id="_idIndexMarker1066"/> section, you'll create classes for the UI elements in the <strong class="bold">Photo Filter</strong> screen, which allows you to manage this screen and the collection view inside it.</p>
			<h1 id="_idParaDest-280"><a id="_idTextAnchor355"/>Creating classes for the Photo Filter screen</h1>
			<p>So far, you <a id="_idIndexMarker1067"/>have<a id="_idIndexMarker1068"/> imported <strong class="source-inline">FilterData.plist</strong> into your app, created the <strong class="source-inline">FilterItem</strong> and <strong class="source-inline">FilterDataManager</strong> classes, and created the <strong class="source-inline">ImageFiltering</strong> protocol. In this section, you'll set up the classes for the <strong class="bold">Photo Filter</strong> screen, which allows you to manage this screen and the collection view inside it.</p>
			<p>Remember that you added the <strong class="source-inline">PhotoFilter</strong> storyboard file to your project in <a href="B17469_16_Final_VK_ePub.xhtml#_idTextAnchor223"><em class="italic">Chapter 16</em></a><em class="italic">, Getting Started with MapKit</em>. It contains a scene that consists of a large image view that will hold the user-selected photo and a collection view that will display filter previews. The following screenshot shows what this will look like when you have completed the implementation:</p>
			<div>
				<div id="_idContainer463" class="IMG---Figure">
					<img src="image/Figure_20.02_B17469.jpg" alt="Figure 20.2: iOS Simulator showing the completed Photo Filter screen&#13;&#10;"/>
				</div>
			</div>
			<p class="figure-caption">Figure 20.2: iOS Simulator showing the completed Photo Filter screen</p>
			<p>This <a id="_idIndexMarker1069"/>screen <a id="_idIndexMarker1070"/>works as follows. When you tap on the <strong class="bold">Add Photo</strong> button in the <strong class="bold">Restaurant Detail</strong> screen and select a photo, the <strong class="bold">Photo Filter</strong> screen will appear, showing the selected photo with a scrolling list of filters just below it. Each filter in the scrolling list is displayed in a collection view cell. Tapping a filter in the scrolling list will apply the selected filter to the photo.</p>
			<p>In the next section, you'll create and configure a class to manage the collection view cells. Each cell will display a thumbnail preview of what a photo looks like with the filter applied.</p>
			<h2 id="_idParaDest-281"><a id="_idTextAnchor356"/>Creating a class for the collection view cells</h2>
			<p>The <strong class="bold">Photo Filter</strong> screen <a id="_idIndexMarker1071"/>provides <a id="_idIndexMarker1072"/>the user interface that allows the user to select a filter to be applied to a photo. The collection view will display thumbnail previews of what a photo looks like with the filter applied. If you click the <strong class="source-inline">PhotoFilter</strong> storyboard file in the Project navigator, you will see that the collection view is already present in the <strong class="bold">View Controller Scene</strong>, but there is no way to set the contents of the collection view cells. You will create a class to manage them now. Follow these steps:</p>
			<ol>
				<li value="1">Right-click the <strong class="source-inline">PhotoFilter</strong> folder and select <strong class="bold">New File</strong>.</li>
				<li><strong class="bold">iOS</strong> should already be selected. Choose <strong class="bold">Cocoa Touch Class</strong> and click <strong class="bold">Next</strong>.</li>
				<li>Configure the file as follows:<p><strong class="bold">Class</strong>: <strong class="source-inline">FilterCell</strong></p><p><strong class="bold">Subclass</strong>: <strong class="source-inline">UICollectionViewCell </strong></p><p><strong class="bold">Also create XIB</strong>: Unchecked </p><p><strong class="bold">Language</strong>: <strong class="source-inline">Swift</strong></p><p>Click <strong class="bold">Next</strong>.</p></li>
				<li>Click <strong class="bold">Create</strong>. The <strong class="source-inline">FilterCell</strong> file will appear in the Project navigator.</li>
				<li>Add the following code to this file to declare and define the <strong class="source-inline">FilterCell</strong> class:<p class="source-code">import UIKit</p><p class="source-code">class FilterCell: UICollectionViewCell {</p><p class="source-code"><strong class="bold">   @IBOutlet var nameLabel: UILabel!</strong></p><p class="source-code"><strong class="bold">   @IBOutlet var thumbnailImageView: UIImageView!</strong></p><p class="source-code"><strong class="bold">   override func awakeFromNib() { </strong></p><p class="source-code"><strong class="bold">      super.awakeFromNib()</strong></p><p class="source-code"><strong class="bold">      thumbnailImageView.layer.cornerRadius = 9 </strong></p><p class="source-code"><strong class="bold">      thumbnailImageView.layer.masksToBounds = true</strong></p><p class="source-code"><strong class="bold">   }</strong></p><p class="source-code">}</p><p class="source-code"><strong class="bold">extension FilterCell: ImageFiltering {</strong></p><p class="source-code"><strong class="bold">   func set(filterItem: FilterItem, </strong></p><p class="source-code"><strong class="bold">   imageForThumbnail: UIImage) {</strong></p><p class="source-code"><strong class="bold">      nameLabel.text = filterItem.name</strong></p><p class="source-code"><strong class="bold">      if let filter = filterItem.filter {</strong></p><p class="source-code"><strong class="bold">         if filter != "None" {</strong></p><p class="source-code"><strong class="bold">            let filteredImage = apply(filter:</strong></p><p class="source-code"><strong class="bold">            filter, originalImage: </strong></p><p class="source-code"><strong class="bold">            imageForThumbnail)</strong></p><p class="source-code"><strong class="bold">            thumbnailImageView.image = </strong></p><p class="source-code"><strong class="bold">            filteredImage</strong></p><p class="source-code"><strong class="bold">      } else {</strong></p><p class="source-code"><strong class="bold">            thumbnailImageView.image =</strong></p><p class="source-code"><strong class="bold">            imageForThumbnail</strong></p><p class="source-code"><strong class="bold">        }</strong></p><p class="source-code"><strong class="bold">      }</strong></p><p class="source-code"><strong class="bold">    }</strong></p><p class="source-code"><strong class="bold">  }</strong></p><p>The <strong class="source-inline">FilterCell</strong> class <a id="_idIndexMarker1073"/>has two <a id="_idIndexMarker1074"/>properties: a label, <strong class="source-inline">nameLabel</strong>, and an image view, <strong class="source-inline">thumbnailImageView</strong>. The label will display the filter name, while the image view will display a thumbnail preview of the filter.</p><p>This class also contains two methods, <strong class="source-inline">awakeFromNib()</strong> and  <strong class="source-inline">set(filterItem:imageForThumbnail:)</strong>. </p><p>The <strong class="source-inline">awakeFromNib()</strong> method is called after the <strong class="source-inline">FilterCell</strong> instance has been loaded, and the two statements inside it round the corners of the image view. </p><p>The <strong class="source-inline">set(filterItem:imageForThumbnail:)</strong> method takes <strong class="source-inline">UIImage</strong> and <strong class="source-inline">FilterItem</strong> instances as parameters, assigns the <strong class="source-inline">name</strong> property of the <strong class="source-inline">FilterItem</strong> instance to <strong class="source-inline">nameLabel</strong>, applies the filter specified by the <strong class="source-inline">filter</strong> property to the <strong class="source-inline">UIImage</strong> instance, and assigns the image with the filter applied to <strong class="source-inline">thumbnailImageView</strong>. </p><p class="callout-heading">Important Information</p><p class="callout">For more details about <strong class="source-inline">awakeFromNib()</strong>, see this link: <a href="https://developer.apple.com/documentation/objectivec/nsobject/1402907-awakefromnib">https://developer.apple.com/documentation/objectivec/nsobject/1402907-awakefromnib</a>.</p></li>
				<li>Click the <strong class="source-inline">PhotoFilter</strong> storyboard file in the Project navigator.</li>
				<li>In the <a id="_idIndexMarker1075"/>document <a id="_idIndexMarker1076"/>outline, select <strong class="bold">Collection View Cell</strong> in the <strong class="bold">View Controller Scene</strong>. Click the Identity inspector button. Under <strong class="bold">Custom Class</strong>, set <strong class="bold">Class</strong> to <strong class="source-inline">FilterCell</strong>:<div id="_idContainer464" class="IMG---Figure"><img src="image/Figure_20.03_B17469.jpg" alt="Figure 20.3: Identity inspector with Class set to FilterCell&#13;&#10;"/></div><p class="figure-caption">Figure 20.3: Identity inspector with Class set to FilterCell</p></li>
				<li>Click the Attributes inspector button. Set <strong class="bold">Identifier</strong> to <strong class="source-inline">filterCell</strong>:<div id="_idContainer465" class="IMG---Figure"><img src="image/Figure_20.04_B17469.jpg" alt="Figure 20.4: Attributes inspector with Identifier set to filterCell&#13;&#10;"/></div><p class="figure-caption">Figure 20.4: Attributes inspector with Identifier set to filterCell</p></li>
				<li>Click the <a id="_idIndexMarker1077"/>Connections <a id="_idIndexMarker1078"/>inspector button. Connect the <strong class="source-inline">nameLabel</strong> and <strong class="source-inline">thumbnailImageView</strong> outlets to their corresponding UI elements as shown:</li>
			</ol>
			<div>
				<div id="_idContainer466" class="IMG---Figure">
					<img src="image/Figure_20.05_B17469.jpg" alt="Figure 20.5: Connections inspector showing thumbnailImageView and nameLabel outlets&#13;&#10;"/>
				</div>
			</div>
			<p class="figure-caption">Figure 20.5: Connections inspector showing thumbnailImageView and nameLabel outlets</p>
			<p>You have now completed setting up the collection view cells. In the next section, you'll create the view controller for the <strong class="bold">Photo Filter</strong> screen. This will allow you to select a photo and choose a filter to be applied to it.</p>
			<h2 id="_idParaDest-282"><a id="_idTextAnchor357"/>Creating a view controller for the Photo Filter screen</h2>
			<p>So far, you have <a id="_idIndexMarker1079"/>created the <strong class="source-inline">FilterCell</strong> class<a id="_idIndexMarker1080"/> to manage the collection view cells in the <strong class="bold">Photo Filter</strong> screen. Now you'll create a view controller to manage this screen's contents. Follow these steps:</p>
			<ol>
				<li value="1">Right-click the <strong class="source-inline">PhotoFilter</strong> folder and select <strong class="bold">New File</strong>.</li>
				<li><strong class="bold">iOS</strong> should already be selected. Choose <strong class="bold">Cocoa Touch Class</strong> and click <strong class="bold">Next</strong>.</li>
				<li>Configure the file, as follows:<p><strong class="bold">Class</strong>: <strong class="source-inline">PhotoFilterViewController</strong></p><p><strong class="bold">Subclass</strong>: <strong class="source-inline">UIViewController </strong></p><p><strong class="bold">Also create XIB</strong>: Unchecked </p><p><strong class="bold">Language</strong>: <strong class="source-inline">Swift</strong></p><p>Click Next.</p></li>
				<li>Click<strong class="bold"> Create</strong>. The <strong class="source-inline">PhotoFilterViewController</strong> file will appear in the Project navigator. Delete all the boilerplate code after the <strong class="source-inline">viewDidLoad()</strong> method.</li>
				<li>Add the following code to the file to declare and define the  <strong class="source-inline">PhotoFilterViewController</strong> class and its properties:<p class="source-code">import UIKit</p><p class="source-code"><strong class="bold">import AVFoundation</strong></p><p class="source-code">class PhotoFilterViewController: UIViewController {</p><p class="source-code"><strong class="bold">   @IBOutlet var mainImageView: UIImageView!</strong></p><p class="source-code"><strong class="bold">   @IBOutlet var collectionView: UICollectionView!</strong></p><p class="source-code"><strong class="bold">   private let manager = FilterDataManager() </strong></p><p class="source-code"><strong class="bold">   var selectedRestaurantID: Int?</strong></p><p class="source-code"><strong class="bold">   private var mainImage: UIImage?</strong></p><p class="source-code"><strong class="bold">   private var thumbnail: UIImage?</strong></p><p class="source-code"><strong class="bold">   private var filters: [FilterItem] = []</strong></p><p class="source-code">   override func viewDidLoad() { </p><p class="source-code">      super.viewDidLoad() </p><p class="source-code">      <strong class="bold">initialize()</strong></p><p class="source-code">   }</p><p class="source-code">}</p><p>Let's break this down:</p><p class="source-code">import AVFoundation</p><p>This statement imports the <strong class="source-inline">AVFoundation</strong> framework. This framework contains methods for capturing, processing, synthesizing, controlling, importing, and <a id="_idIndexMarker1081"/>exporting audiovisual media on<a id="_idIndexMarker1082"/> Apple platforms.</p><p class="callout-heading">Important Information</p><p class="callout">You can find out more about <strong class="source-inline">AVFoundation</strong> at this link:</p><p class="callout"><a href="https://developer.apple.com/av-foundation/">https://developer.apple.com/av-foundation/</a><a href="https://developer.apple.com/av-foundation/&#13;"/></p><p class="source-code">class PhotoFilterViewController: UIViewController {</p><p>This statement declares the <strong class="source-inline">PhotoFilterViewController</strong> class, a subclass of the <strong class="source-inline">UIViewController</strong> class.</p><p class="source-code">@IBOutlet var mainImageView: UIImageView!</p><p>This is an outlet for the image view that will display the user-selected photo with the filter applied. </p><p class="source-code">@IBOutlet var collectionView: UICollectionView!</p><p>This is an outlet for the collection view that will display thumbnail previews of each filter.</p><p class="source-code">private let manager = FilterDataManager()</p><p>This statement assigns an instance of the <strong class="source-inline">FilterDataManager</strong> class to the  <strong class="source-inline">manager</strong> property.</p><p class="source-code">var selectedRestaurantID:Int?</p><p>Each restaurant has a unique numeric identifier. This property is used to store that identifier. You'll see how it's used when storing photos using <strong class="bold">Core Data</strong> in the next chapter.</p><p class="source-code">private var mainImage: UIImage?</p><p>This property stores the photo selected by the user.</p><p class="source-code">private var thumbnail: UIImage?</p><p>This <a id="_idIndexMarker1083"/>property stores the thumbnail <a id="_idIndexMarker1084"/>for the user-selected photo.</p><p class="source-code">private var filters: [FilterItem] = []</p><p>This property stores an array of <strong class="source-inline">FilterItem</strong> instances provided by <strong class="source-inline">manager</strong>.</p><p class="source-code">override func viewDidLoad() { </p><p class="source-code">   super.viewDidLoad() </p><p class="source-code">   initialize()</p><p class="source-code">}</p><p>This method calls an <strong class="source-inline">initialize()</strong> method when the <strong class="source-inline">PhotoFilterViewController</strong> instance loads its view. Note that this will generate an error, since <strong class="source-inline">initialize()</strong> hasn't been implemented yet.</p></li>
				<li>As you did before, you will use extensions to organize your code. Add the following <strong class="source-inline">private</strong> extension containing the <strong class="source-inline">initialize()</strong> method after the closing curly brace:<p class="source-code">// MARK: - Private Extension</p><p class="source-code">private extension PhotoFilterViewController {</p><p class="source-code">   func initialize() { </p><p class="source-code">      setupCollectionView() </p><p class="source-code">      checkSource()</p><p class="source-code">   }</p><p class="source-code">}</p><p>This extension contains the implementation of the <strong class="source-inline">initialize()</strong> method, which calls two other methods. <strong class="source-inline">setupCollectionView()</strong> sets up the collection view used to display the list of filters. <strong class="source-inline">checkSource()</strong> checks the user authorization status for the use of the camera. Note that these will generate errors since they haven't been implemented yet. You'll implement these methods in the next step.</p></li>
				<li>Implement<a id="_idIndexMarker1085"/> the <strong class="source-inline">setupCollectionView()</strong> and <strong class="source-inline">checkSource()</strong> methods<a id="_idIndexMarker1086"/> in the <strong class="source-inline">private</strong> extension after the <strong class="source-inline">initialize()</strong> method:<p class="source-code">func setupCollectionView() {</p><p class="source-code">   let layout = UICollectionViewFlowLayout() </p><p class="source-code">   layout.scrollDirection = .horizontal </p><p class="source-code">   layout.sectionInset = UIEdgeInsets(top: 7, </p><p class="source-code">   left: 7, bottom: 7, right: 7) </p><p class="source-code">   layout.minimumInteritemSpacing = 0 </p><p class="source-code">   layout.minimumLineSpacing = 7</p><p class="source-code">   collectionView.collectionViewLayout = layout </p><p class="source-code">   collectionView.dataSource = self </p><p class="source-code">   collectionView.delegate = self</p><p class="source-code">}</p><p class="source-code">func checkSource() {</p><p class="source-code">   let cameraMediaType = AVMediaType.video </p><p class="source-code">   let cameraAuthorizationStatus = </p><p class="source-code">   AVCaptureDevice.authorizationStatus(for: </p><p class="source-code">   cameraMediaType)</p><p class="source-code">   switch cameraAuthorizationStatus { </p><p class="source-code">   case .notDetermined: </p><p class="source-code">      AVCaptureDevice.requestAccess(for: </p><p class="source-code">      cameraMediaType) { granted in </p><p class="source-code">         if granted {</p><p class="source-code">            DispatchQueue.main.async {</p><p class="source-code">               self.showCameraUserInterface()</p><p class="source-code">            }</p><p class="source-code">         }</p><p class="source-code">      }</p><p class="source-code">   case .authorized: </p><p class="source-code">      self.showCameraUserInterface() </p><p class="source-code">   default: </p><p class="source-code">      break</p><p class="source-code">   }</p><p class="source-code">}</p><p>Let's<a id="_idIndexMarker1087"/> break<a id="_idIndexMarker1088"/> this down:</p><p class="source-code">setupCollectionView() </p><p>Sets up the collection view used to display thumbnail previews of the filters. Here, you create an instance of <strong class="source-inline">UICollectionViewFlowLayout</strong>, set the scroll direction, section insets, inter-item spacing, and line spacing properties, and assign it to the collection view. After that, you set the <strong class="source-inline">PhotoFilterViewController</strong> class as the delegate and data source for this collection view. Note that you're setting <strong class="source-inline">delegate</strong> and <strong class="source-inline">dataSource</strong> programmatically rather than using the storyboard; either approach is acceptable. Don't worry about the errors, they appear because you haven't adopted the <strong class="source-inline">UICollectionViewDataSource</strong> and <strong class="source-inline">UICollectionViewDelegate</strong> protocols for this class yet. You'll fix this later.</p><p class="source-code">checkSource() </p><p>Checks the user authorization status for the use of the camera. Possible cases are as follows:</p><p><strong class="source-inline">.notDetermined</strong> means the user hasn't been asked for access to the camera.</p><p><strong class="source-inline">.authorized</strong> means the user has previously granted access to the camera. </p><p><strong class="source-inline">.restricted</strong> means the user can't be granted access due to restrictions that have been set on the device. </p><p><strong class="source-inline">.denied</strong> means <a id="_idIndexMarker1089"/>the user has previously <a id="_idIndexMarker1090"/>denied camera access to the app. </p><p>If the status is <strong class="source-inline">.notDetermined</strong>, the app will ask the user for permission and, if permission is given, the <strong class="source-inline">showCameraUserInterface()</strong> method is called. If the status is <strong class="source-inline">.authorized</strong>, the <strong class="source-inline">showCameraUserInterface()</strong> method is called. Note that this will generate an error because <strong class="source-inline">showCameraUserInterface()</strong> has not been implemented yet. If the status is <strong class="source-inline">.restricted</strong> or <strong class="source-inline">.denied</strong>, it falls under the <strong class="source-inline">default:</strong> case and the method exits.</p></li>
				<li>There are a few more helper methods required. Add the following code to the <strong class="source-inline">private</strong> extension to implement them after the <strong class="source-inline">checkSource()</strong> method:<p class="source-code">func showApplyFilterInterface() {</p><p class="source-code">   filters = manager.fetch()</p><p class="source-code">   if let mainImage = self.mainImage { </p><p class="source-code">      mainImageView.image = mainImage </p><p class="source-code">      collectionView.reloadData()</p><p class="source-code">   }</p><p class="source-code">}</p><p class="source-code">@IBAction func onPhotoTapped(_ sender: Any) {</p><p class="source-code">   checkSource()</p><p class="source-code">}</p><p>Let's break this down:</p><p class="source-code">showApplyFilterInterface() </p><p>This method will be called after the user selects a photo from the camera or photo library. It calls the <strong class="source-inline">FilterManager</strong> instance's <strong class="source-inline">fetch()</strong> method, which loads <strong class="source-inline">FilterData.plist</strong> and puts its contents into an array of <strong class="source-inline">FilterItem</strong> instances. This array is then assigned to the <strong class="source-inline">PhotoFilterViewController</strong> instance's <strong class="source-inline">filters</strong> property, which will later be <a id="_idIndexMarker1091"/>used to populate the collection <a id="_idIndexMarker1092"/>view with thumbnail previews of filters. The next statement assigns the <strong class="source-inline">PhotoFilterViewController</strong> instance's <strong class="source-inline">mainImage</strong> property to <strong class="source-inline">mainImageView</strong>, which is the outlet for the image view above the collection view, if <strong class="source-inline">mainImage</strong> has been set. The final statement tells the collection view to redraw itself.</p><p class="source-code">onPhotoTapped() </p><p>This method calls the <strong class="source-inline">checkSource()</strong> method you implemented earlier, which calls the <strong class="source-inline">showCameraUserInterface()</strong> method if authorization has been granted. You'll assign this to the camera button in the <strong class="bold">Photo Filter View Controller Scene</strong> later.</p><p class="callout-heading">Important Information</p><p class="callout">Apple stipulates that apps that use the camera or Photo Library must prompt the user accordingly. Later, you'll modify your app to display a dialog box asking for permission to use the camera or Photo Library by implementing the <strong class="source-inline">NSCameraUsageDescription</strong> and <strong class="source-inline">NSMicrophoneUsageDescription</strong> keys in <strong class="source-inline">Info.plist</strong>. To learn more about requesting permission to use the camera, go to <a href="https://developer.apple.com/documentation/avfoundation/cameras_and_media_capture/requesting_authorization_for_media_capture_on_ios">https://developer.apple.com/documentation/avfoundation/cameras_and_media_capture/requesting_authorization_for_media_capture_on_ios</a>.</p></li>
				<li>You'll adopt the <strong class="source-inline">UICollectionViewDataSource</strong> protocol and implement the required methods to make the collection view display thumbnail previews of filters. Add <a id="_idIndexMarker1093"/>a new extension after the <strong class="source-inline">private</strong> extension<a id="_idIndexMarker1094"/> and implement them as follows:<p class="source-code">extension PhotoFilterViewController: </p><p class="source-code">UICollectionViewDataSource {</p><p class="source-code">   func collectionView(_ collectionView: </p><p class="source-code">   UICollectionView, numberOfItemsInSection </p><p class="source-code">   section: Int) -&gt; Int {</p><p class="source-code">      filters.count</p><p class="source-code">   }</p><p class="source-code">   func collectionView(_ collectionView: </p><p class="source-code">   UICollectionView, cellForItemAt indexPath: </p><p class="source-code">   IndexPath) -&gt; UICollectionViewCell {</p><p class="source-code">      let cell = collectionView</p><p class="source-code">      .dequeueReusableCell</p><p class="source-code">      (withReuseIdentifier: "filterCell", </p><p class="source-code">      for: indexPath) as! FilterCell</p><p class="source-code">      let filterItem = filters[indexPath.row]</p><p class="source-code">      if let thumbnail = thumbnail {</p><p class="source-code">         cell.set(filterItem: filterItem, </p><p class="source-code">         imageForThumbnail: thumbnail)</p><p class="source-code">      }</p><p class="source-code">      return cell</p><p class="source-code">   }</p><p class="source-code">}</p><p class="callout-heading">Tip</p><p class="callout">Collection views are covered in <a href="B17469_13_Final_VK_ePub.xhtml#_idTextAnchor194"><em class="italic">Chapter 13</em></a><em class="italic">, Getting Started with MVC and Collection Views</em>.</p><p>The following should be familiar to you as you have done this before, but let's go over it again:</p><p class="source-code">collectionView(_:numberOfItemsInSection:) </p><p>Determines the number of items the collection view is supposed to display, which is the same as the number of <strong class="source-inline">FilterItems</strong> inside the <strong class="source-inline">PhotoFilterViewController</strong> instance's <strong class="source-inline">filters</strong> array.</p><p class="source-code">collectionView(_:cellForItemAt:) </p><p>Determines what to put in each cell. Here, you get the <strong class="source-inline">FilterItem</strong> instance corresponding to the cell's position in the collection view and pass it, along with the <strong class="source-inline">PhotoFilterViewController</strong> instance's <strong class="source-inline">thumbnail</strong> property, to the <strong class="source-inline">set(filterItem:imageForThumbnail:)</strong> method, which sets the image and<a id="_idIndexMarker1095"/> label for the collection <a id="_idIndexMarker1096"/>view cell.</p></li>
				<li>You've set up the collection view using a <strong class="source-inline">UICollectionViewFlowLayout</strong> instance earlier. Now you'll set the size for the collection view cells. Add the following extension after the extension containing the data source methods:<p class="source-code">extension PhotoFilterViewController: </p><p class="source-code">UICollectionViewDelegateFlowLayout {</p><p class="source-code">   func collectionView(_ collectionView: </p><p class="source-code">   UICollectionView, layout </p><p class="source-code">   collectionViewLayout: </p><p class="source-code">   UICollectionViewLayout, sizeForItemAt </p><p class="source-code">   indexPath: IndexPath) -&gt; CGSize {</p><p class="source-code">      let collectionViewHeight = </p><p class="source-code">      collectionView.frame.size.height </p><p class="source-code">      let topInset = 14.0</p><p class="source-code">      let cellHeight = collectionViewHeight - </p><p class="source-code">      topInset</p><p class="source-code">      return CGSize(width: 150, height: </p><p class="source-code">      cellHeight)</p><p class="source-code">   }</p><p class="source-code">}</p><p><strong class="source-inline">collectionView(_:layout:sizeForItemAt:)</strong> returns the size each collection view cell should be. First, the height of the collection view is assigned to <strong class="source-inline">collectionViewHeight</strong>. Then, the value of <strong class="source-inline">topInset</strong> is set to <strong class="source-inline">14.0</strong> points. The height of the collection view cell is calculated by subtracting the <strong class="source-inline">topInset</strong> from the <strong class="source-inline">collectionViewHeight</strong>. This results in a 14-point gap between the top of the collection view cells and the top of the collection view. Finally, a <strong class="source-inline">CGSize</strong> instance<a id="_idIndexMarker1097"/> with the width set to <strong class="source-inline">150</strong> points and the height<a id="_idIndexMarker1098"/> set to <strong class="source-inline">cellHeight</strong> is returned as the size of the collection view cell. Previously, you did this using the Size inspector; now, you're doing it programmatically.</p></li>
			</ol>
			<p>Now you'll connect the outlets and actions in this class to the UI elements in the <strong class="source-inline">PhotoFilter</strong> storyboard file. <strong class="source-inline">collectionView</strong> is the outlet for the collection view that displays the list of filters. <strong class="source-inline">mainImageView</strong> is for the image view just above it, which shows the image the user selected. <strong class="source-inline">onPhotoTapped()</strong> is for the camera button in the navigation bar. You'll also configure the <strong class="bold">Cancel</strong> button to dismiss the <strong class="bold">Photo Filter</strong> screen. Follow these steps:</p>
			<ol>
				<li value="1">Click the <strong class="source-inline">PhotoFilter</strong> storyboard file in the Project navigator. Select the <strong class="bold">View Controller</strong> icon of the <strong class="bold">View Controller Scene</strong> in the document outline. Click the Identity inspector button. Under <strong class="bold">Custom Class</strong>, set <strong class="bold">Class</strong> to <strong class="source-inline">PhotoFilterViewController</strong>:<div id="_idContainer467" class="IMG---Figure"><img src="image/Figure_20.06_B17469.jpg" alt="Figure 20.6: Identity inspector with Class set to PhotoFilterViewController&#13;&#10;"/></div><p class="figure-caption">Figure 20.6: Identity inspector with Class set to PhotoFilterViewController</p></li>
				<li>Select the Connections inspector. Click and drag from the <strong class="source-inline">collectionView</strong> outlet to the <strong class="bold">Collection View</strong> in the document outline:<div id="_idContainer468" class="IMG---Figure"><img src="image/Figure_20.07_B17469.jpg" alt="Figure 20.7: Connections inspector showing the collectionView outlet&#13;&#10;"/></div><p class="figure-caption">Figure 20.7: Connections inspector showing the collectionView outlet</p></li>
				<li>Click and<a id="_idIndexMarker1099"/> drag from the <strong class="source-inline">mainImageView</strong> outlet <a id="_idIndexMarker1100"/>to the <strong class="bold">Image View</strong> in the document outline:<div id="_idContainer469" class="IMG---Figure"><img src="image/Figure_20.08_B17469.jpg" alt="Figure 20.8: Connections inspector showing the mainImageView outlet&#13;&#10;"/></div><p class="figure-caption">Figure 20.8: Connections inspector showing the mainImageView outlet</p></li>
				<li>Click and drag from the <strong class="source-inline">onPhotoTapped:</strong> action to the camera button:<div id="_idContainer470" class="IMG---Figure"><img src="image/Figure_20.09_B17469.jpg" alt="Figure 20.9: Connections inspector showing onPhotoTapped: action&#13;&#10;"/></div><p class="figure-caption">Figure 20.9: Connections inspector showing onPhotoTapped: action</p></li>
				<li>The <strong class="bold">Cancel</strong> button is used to exit this screen if the user does not wish to make a selection. You'll<a id="_idIndexMarker1101"/> connect the <strong class="bold">Cancel</strong> button to the unwind method you implemented in the previous chapter, which will dismiss this screen and return the user to the <strong class="bold">Restaurant Detail</strong> screen. <em class="italic">Ctrl + Drag</em> from the <strong class="bold">Cancel</strong> button to the Exit icon in the Scene Dock:<div id="_idContainer471" class="IMG---Figure"><img src="image/Figure_20.10_B17469.jpg" alt="Figure 20.10: Photo Filter View Controller Scene showing Cancel button action being set&#13;&#10;"/></div><p class="figure-caption">Figure 20.10: Photo Filter View Controller Scene showing Cancel button action being set</p></li>
				<li>Select <strong class="source-inline">unwindReviewCancelWithSegue:</strong> in the pop-up menu:</li>
			</ol>
			<div>
				<div id="_idContainer472" class="IMG---Figure">
					<img src="image/Figure_20.11_B17469.jpg" alt="Figure 20.11: Pop-up menu with unwindReviewCancelWithSegue: selected&#13;&#10;"/>
				</div>
			</div>
			<p class="figure-caption">Figure 20.11: Pop-up menu with unwindReviewCancelWithSegue: selected</p>
			<p>All the <a id="_idIndexMarker1102"/>outlets and actions for the <strong class="source-inline">PhotoFilterViewController</strong> class have been connected.</p>
			<p>Next, you will implement the following methods:</p>
			<ul>
				<li><strong class="source-inline">showCameraUserInterface()</strong>, a method that will display either the view from the device camera or the photo library in an image picker interface.</li>
				<li>Two <strong class="source-inline">UIImagePickerControllerDelegate</strong> protocol methods that will be called when you choose a picture in the image picker interface or click the <strong class="bold">Cancel </strong>button.<p class="callout-heading">Important Information</p><p class="callout">To learn more about <strong class="source-inline">UIImagePickerController</strong>, go to <a href="https://developer.apple.com/documentation/uikit/uiimagepickercontroller">https://developer.apple.com/documentation/uikit/uiimagepickercontroller</a>.</p><p class="callout-heading">Important Information</p><p class="callout">To learn more about <strong class="source-inline">UIImagePickerControllerDelegate</strong>, go to <a href="https://developer.apple.com/documentation/uikit/uiimagepickercontrollerdelegate">https://developer.apple.com/documentation/uikit/uiimagepickercontrollerdelegate</a>.</p></li>
			</ul>
			<p>To implement the <strong class="source-inline">showCameraUserInterface()</strong> and <strong class="source-inline">UIImagePickerControllerDelegate</strong> methods, click the <strong class="source-inline">PhotoFilterViewController</strong> file in the Project <a id="_idIndexMarker1103"/>navigator and add the following extension<a id="_idIndexMarker1104"/> after the <strong class="source-inline">UICollectionViewDelegateFlowLayout</strong> extension:</p>
			<p class="source-code">extension PhotoFilterViewController: UIImagePickerControllerDelegate, </p>
			<p class="source-code">UINavigationControllerDelegate {</p>
			<p class="source-code">   func showCameraUserInterface() {</p>
			<p class="source-code">      let imagePicker = UIImagePickerController()</p>
			<p class="source-code">      imagePicker.delegate = self</p>
			<p class="source-code">   #if targetEnvironment(simulator)</p>
			<p class="source-code">      imagePicker.sourceType = </p>
			<p class="source-code">      UIImagePickerController.SourceType.photoLibrary</p>
			<p class="source-code">   #else</p>
			<p class="source-code">      imagePicker.sourceType = </p>
			<p class="source-code">      UIImagePickerController.SourceType.camera</p>
			<p class="source-code">      imagePicker.showsCameraControls = true</p>
			<p class="source-code">   #endif</p>
			<p class="source-code">      imagePicker.mediaTypes = ["public.image"]</p>
			<p class="source-code">      imagePicker.allowsEditing = true </p>
			<p class="source-code">      self.present(imagePicker, animated: true, </p>
			<p class="source-code">      completion: nil)</p>
			<p class="source-code">   }</p>
			<p class="source-code">   func imagePickerControllerDidCancel(_ picker: </p>
			<p class="source-code">   UIImagePickerController) {</p>
			<p class="source-code">      picker.dismiss(animated: true, completion: nil)</p>
			<p class="source-code">   }</p>
			<p class="source-code">   func imagePickerController(_ picker: </p>
			<p class="source-code">   UIImagePickerController, </p>
			<p class="source-code">   didFinishPickingMediaWithInfo info:</p>
			<p class="source-code">   [UIImagePickerController.InfoKey : Any]) {</p>
			<p class="source-code">      if let selectedImage = </p>
			<p class="source-code">      info[UIImagePickerController.InfoKey</p>
			<p class="source-code">      .editedImage] as? UIImage {</p>
			<p class="source-code">         self.thumbnail = </p>
			<p class="source-code">         selectedImage.preparingThumbnail(of: </p>
			<p class="source-code">         CGSize(width: 100, height: 100))</p>
			<p class="source-code">         let mainImageViewSize = </p>
			<p class="source-code">         mainImageView.frame.size</p>
			<p class="source-code">         self.mainImage = </p>
			<p class="source-code">         selectedImage.preparingThumbnail(of: </p>
			<p class="source-code">         mainImageViewSize)</p>
			<p class="source-code">      }</p>
			<p class="source-code">      picker.dismiss(animated: true){ </p>
			<p class="source-code">         self.showApplyFilterInterface()</p>
			<p class="source-code">      }</p>
			<p class="source-code">   }</p>
			<p class="source-code">}</p>
			<p>Let's talk<a id="_idIndexMarker1105"/> about <strong class="source-inline">showCameraUserInterface()</strong> first. This method is triggered when the camera button is<a id="_idIndexMarker1106"/> tapped, displaying an image picker on the screen. This image picker is the standard iOS image picker that appears when you want to use an image—for instance, to add an image to a Facebook post or to a tweet. </p>
			<p>Let's break this down:</p>
			<p class="source-code">let imagePicker = UIImagePickerController()</p>
			<p>Creates an instance of the <strong class="source-inline">UIImagePickerController</strong> class and assigns it to <strong class="source-inline">imagePicker</strong>.</p>
			<p class="source-code">imagePicker.delegate = self</p>
			<p>Sets the <strong class="source-inline">imagePicker</strong> instance's <strong class="source-inline">delegate</strong> property to the <strong class="source-inline">PhotoFilterViewController</strong> instance. </p>
			<p class="source-code">#if targetEnvironment(simulator)</p>
			<p class="source-code">   imagePicker.sourceType = </p>
			<p class="source-code">   UIImagePickerController.SourceType.photoLibrary</p>
			<p class="source-code">#else</p>
			<p class="source-code">   imagePicker.sourceType = </p>
			<p class="source-code">   UIImagePickerController.SourceType.camera</p>
			<p class="source-code">   imagePicker.showsCameraControls = true</p>
			<p class="source-code">#endif</p>
			<p>This block of <a id="_idIndexMarker1107"/>code is known as a conditional<a id="_idIndexMarker1108"/> compilation block. It starts with an <strong class="source-inline">#if</strong> compilation directive and ends with an <strong class="source-inline">#endif</strong> compilation directive. If you're running on the simulator, only the statement setting the <strong class="source-inline">imagePicker</strong> instance's <strong class="source-inline">sourceType</strong> property to the photo library is compiled. If you're running on an actual device, the statements setting the <strong class="source-inline">imagePicker</strong> instance's <strong class="source-inline">sourceType</strong> property to camera and displaying the camera controls are compiled.</p>
			<p class="callout-heading">Important Information</p>
			<p class="callout">You can learn more about conditional compilation blocks at this link: <a href="https://docs.swift.org/swift-book/ReferenceManual/Statements.html#ID538">https://docs.swift.org/swift-book/ReferenceManual/Statements.html#ID538</a>.</p>
			<p class="source-code">imagePicker.mediaTypes = ["public.image"]</p>
			<p>Sets the camera interface to capture still images. </p>
			<p class="source-code">imagePicker.allowsEditing = true </p>
			<p>Indicates the user is allowed to edit the selected image.</p>
			<p class="source-code">self.present(imagePicker, animated: true, completion: nil)</p>
			<p>Presents <strong class="source-inline">imagePicker</strong> on the screen.</p>
			<p>When the image picker appears onscreen, you have the option of selecting a photo or canceling. If you cancel, <strong class="source-inline">imagePickerControllerDidCancel(_:)</strong> is triggered and the image picker is dismissed.</p>
			<p>If you select a photo, <strong class="source-inline">imagePickerController(_:didFinishPickingMediaWithInfo:)</strong> is triggered and a photo will be returned and assigned to <strong class="source-inline">selectedImage</strong>. Next, the <strong class="source-inline">selectedImage</strong> instance's <strong class="source-inline">preparingThumbnail(of:)</strong> method will be used to create a small image with a width and height of <strong class="source-inline">100</strong> points. This will then be assigned to the <strong class="source-inline">thumbnail</strong> property. After that, an image with the same size as <strong class="source-inline">mainImageView</strong> will be created from <strong class="source-inline">selectedImage</strong> using the <strong class="source-inline">preparingThumbnail(of:)</strong> method. This will be assigned to the <strong class="source-inline">mainImage</strong> property and<a id="_idIndexMarker1109"/> the image picker will be dismissed.</p>
			<p class="callout-heading">Important Information</p>
			<p class="callout">You can learn more about the <strong class="source-inline">preparingThumbnail(of:)</strong> method at this link: <a href="https://developer.apple.com/documentation/uikit/uiimage/3750835-preparingthumbnail">https://developer.apple.com/documentation/uikit/uiimage/3750835-preparingthumbnail</a>.</p>
			<p>Next, you'll implement <strong class="source-inline">filterMainImage(filterItem:)</strong>, a method to apply a filter to the image in the <strong class="source-inline">mainImageView</strong>. Add an extension containing this method after the <strong class="source-inline">UIImagePickerControllerDelegate</strong> extension:</p>
			<p class="source-code">extension PhotoFilterViewController: ImageFiltering {</p>
			<p class="source-code">   func filterMainImage(filterItem: FilterItem) {</p>
			<p class="source-code">      if let mainImage = mainImage, let filter = </p>
			<p class="source-code">      filterItem.filter {</p>
			<p class="source-code">         if filter != "None" {</p>
			<p class="source-code">            mainImageView.image = </p>
			<p class="source-code">            self.apply(filter: filter, </p>
			<p class="source-code">            originalImage: mainImage)</p>
			<p class="source-code">         } else {</p>
			<p class="source-code">            mainImageView.image = mainImage</p>
			<p class="source-code">         }</p>
			<p class="source-code">      }</p>
			<p class="source-code">   }</p>
			<p class="source-code">}</p>
			<p>This makes the <strong class="source-inline">PhotoFilterViewController</strong> class adopt the <strong class="source-inline">ImageFiltering</strong> protocol. Remember that any class that adopts this protocol gets the <strong class="source-inline">apply(filter:originalImage:)</strong> method. The <strong class="source-inline">filterMainImage(filterItem:)</strong> method uses this method to apply the selected <a id="_idIndexMarker1110"/>filter<a id="_idIndexMarker1111"/> to the photo stored in the <strong class="source-inline">PhotoFilterViewController</strong> instance's <strong class="source-inline">mainImage</strong> property, and the result is assigned to the <strong class="source-inline">mainImageView</strong> outlet so that it is visible on the screen. If you selected the <strong class="source-inline">None</strong> filter, then <strong class="source-inline">mainImage</strong> is assigned to the <strong class="source-inline">mainImageView</strong> outlet.</p>
			<p>You still need to know which filter the user picked, so you'll make the <strong class="source-inline">PhotoFilterViewController</strong> class adopt the <strong class="source-inline">UICollectionViewDelegate</strong> protocol and implement the method that identifies which cell in the collection view was tapped. Add the following extension containing<a id="_idTextAnchor358"/><a id="_idTextAnchor359"/> this method after the <strong class="source-inline">ImageFiltering</strong> extension:</p>
			<p class="source-code">extension PhotoFilterViewController: </p>
			<p class="source-code">UICollectionViewDelegate {</p>
			<p class="source-code">   func collectionView(_ collectionView: </p>
			<p class="source-code">   UICollectionView, didSelectItemAt </p>
			<p class="source-code">   indexPath: IndexPath) { </p>
			<p class="source-code">      let filterItem = self.filters[indexPath.row] </p>
			<p class="source-code">      filterMainImage(filterItem: filterItem)</p>
			<p class="source-code">   }</p>
			<p class="source-code">}</p>
			<p>The <strong class="source-inline">collectionView(_:didSelectItemAt:)</strong> method is called whenever the user taps a cell in the collection view. The <strong class="source-inline">FilterItem</strong> corresponding to the cell that was tapped is then passed to <strong class="source-inline">filterMainImage(filterItem:)</strong>.</p>
			<p>The implementation of the <strong class="source-inline">PhotoFilterViewController</strong> class is now complete but remember that you have to ask for permission to use the camera or to access the photo<a id="_idIndexMarker1112"/> library. You'll modify the <strong class="source-inline">Info.plist</strong> file<a id="_idIndexMarker1113"/> in your project so that messages will be displayed to the user when your app attempts to access the camera or photo library.</p>
			<h1 id="_idParaDest-283"><a id="_idTextAnchor360"/>Getting permission to use the camera or photo library</h1>
			<p>As mentioned<a id="_idIndexMarker1114"/> earlier, Apple stipulates that your app must inform the user if it wishes to access the camera or photo library. If you don't do this, your app will be rejected and will not be allowed on the App Store.</p>
			<p>You'll modify the <strong class="source-inline">Info.plist</strong> file in your project to make your app display messages when it tries to access the camera or photo library. Follow these steps:</p>
			<ol>
				<li value="1">Click the <strong class="source-inline">Info.plist</strong> file in the Project navigator to display a list of keys. Move your mouse pointer over any existing key and click the <strong class="bold">+</strong> button:<div id="_idContainer473" class="IMG---Figure"><img src="image/Figure_20.12_B17469.jpg" alt="Figure 20.12: Editor area showing contents of Info.plist&#13;&#10;"/></div><p class="figure-caption">Figure 20.12: Editor area showing contents of Info.plist</p></li>
				<li>A field should appear, allowing you to enter an additional key:<div id="_idContainer474" class="IMG---Figure"><img src="image/Figure_20.13_B17469.jpg" alt="Figure 20.13: Editor area showing field used to enter keys&#13;&#10;"/></div><p class="figure-caption">Figure 20.13: Editor area showing field used to enter keys</p></li>
				<li>Enter the following keys:<p class="source-code">NSPhotoLibraryUsageDescription</p><p class="source-code">NSCameraUsageDescription</p></li>
				<li>For each key's <a id="_idIndexMarker1115"/>value, enter a string that explains to the user why you wish to use the camera or photo library:</li>
			</ol>
			<div>
				<div id="_idContainer475" class="IMG---Figure">
					<img src="image/Figure_20.14_B17469.jpg" alt="Figure 20.14: Info.plist with additional keys added&#13;&#10;"/>
				</div>
			</div>
			<p class="figure-caption">Figure 20.14: Info.plist with additional keys added</p>
			<p>Build and run the project. Go to the <strong class="bold">Restaurant Detail</strong> screen and tap the <strong class="bold">Add Photo</strong> button. You should see the following alert:</p>
			<div>
				<div id="_idContainer476" class="IMG---Figure">
					<img src="image/Figure_20.15_B17469.jpg" alt="Figure 20.15: iOS Simulator showing camera access alert&#13;&#10;"/>
				</div>
			</div>
			<p class="figure-caption">Figure 20.15: iOS Simulator showing camera access alert</p>
			<p>Tap <strong class="bold">OK</strong>. The<a id="_idIndexMarker1116"/> image picker will appear:</p>
			<div>
				<div id="_idContainer477" class="IMG---Figure">
					<img src="image/Figure_20.16_B17469.jpg" alt="Figure 20.16: iOS Simulator showing image picker&#13;&#10;"/>
				</div>
			</div>
			<p class="figure-caption">Figure 20.16: iOS Simulator showing image picker</p>
			<p>Select a photo, and the <strong class="bold">Photo Filter</strong> screen will display the photo and a list of thumbnails <a id="_idIndexMarker1117"/>with different filters applied to them. Tapping a filter will apply its effect to the photo:</p>
			<div>
				<div id="_idContainer478" class="IMG---Figure">
					<img src="image/Figure_20.17_B17469.jpg" alt="Figure 20.17: iOS Simulator showing Photo Filter screen&#13;&#10;"/>
				</div>
			</div>
			<p class="figure-caption">Figure 20.17: iOS Simulator showing Photo Filter screen</p>
			<p>You've modified the <strong class="source-inline">info.plist</strong> file in your project and your app now asks for permission before using the camera or the photo library. You can use the <strong class="bold">Cancel</strong> button to<a id="_idIndexMarker1118"/> dismiss the <strong class="bold">Photo Filter</strong> screen and return to the <strong class="bold">Restaurant Detail</strong> screen. You can't use the <strong class="bold">Save</strong> button yet though, you'll implement its functionality in the next chapter.</p>
			<h1 id="_idParaDest-284"><a id="_idTextAnchor361"/>Summary</h1>
			<p>In this chapter, you completed the implementation of the <strong class="bold">Photo Filter</strong> screen. You imported <strong class="source-inline">FilterData.plist</strong>, a <strong class="source-inline">.plist</strong> file containing the filters you want to use, created the <strong class="source-inline">FilterItem</strong> class to store filter data, and created the <strong class="source-inline">FilterManager</strong> data manager class to read the <strong class="source-inline">.plist</strong> file and populate an array of <strong class="source-inline">FilterItem</strong> instances. Next, you created a protocol, <strong class="source-inline">ImageFiltering</strong>, with a method to apply filters to images. Then, you created the <strong class="source-inline">FilterCell</strong> and <strong class="source-inline">PhotoFilterViewController</strong> classes in order to manage the collection view cells and the <strong class="bold">Photo Filter</strong> screen. After that you made the <strong class="source-inline">PhotoFilterViewController</strong> class adopt the <strong class="source-inline">UIImagePickerDelegate</strong> protocol, and added methods so that you can use photos from the camera or photo library in your app. Finally, you added code to <strong class="source-inline">PhotoFilterViewController</strong> to apply a selected filter to a picture.</p>
			<p>You are now able to write your own apps that import photos from your camera or photo library, and apply filters to them. </p>
			<p>Note that the selected picture cannot be saved. You will learn how to save reviews and pictures using Core Data in the next chapter so that they will reappear after you quit and relaunch the app.</p>
		</div>
	</body></html>