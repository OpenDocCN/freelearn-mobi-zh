<html><head></head><body><div><div><div><div><h1 class="title"><a id="ch06"/>Chapter 6. Getting to Grips with Events and Properties</h1></div></div></div><p>In this chapter, we will cover:</p><div><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">Reading and writing app properties</li><li class="listitem" style="list-style-type: disc">Firing and capturing events</li><li class="listitem" style="list-style-type: disc">Passing event data between your app and a WebView using custom events</li></ul></div><div><div><div><div><h1 class="title"><a id="ch06lvl1sec01"/>Introduction</h1></div></div></div><p>This chapter describes the processes of two fundamentally important, yet deceptively simple, parts of the Titanium framework. In this chapter, we'll explain how to go about creating and reading app properties so that you can store data that is accessible from any part of your application. This is similar to how session data or cookies would work if you were building a web-based app.</p><p>We'll also go into further detail on events, including a selection of those fired by the various components in Titanium, and custom events that you can define yourself.</p><p>Application properties are used for storing data in key/value pairs. These properties can persist between your app's windows, and even beyond single application sessions, much like a website cookie. You can use any combination of upper case or lower case letters and numbers in a property name, but you should mix them with care as JavaScript is case-sensitive. In this regard,<code class="literal"> Myname, myname</code>, and<code class="literal"> MYNAME</code> would be three very different properties!<a id="id235" class="indexterm"/>
</p><div><div><div><div><h2 class="title"><a id="ch06lvl2sec01"/>When should you use app properties?</h2></div></div></div><p>Application properties should be used when one or more of the following points are true:<a id="id236" class="indexterm"/>
</p><div><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">The data consists of simple key/value pairs</li><li class="listitem" style="list-style-type: disc">The data is related to the application rather than the user</li><li class="listitem" style="list-style-type: disc">The data does not require other data in order to be meaningful or useful</li><li class="listitem" style="list-style-type: disc">There only needs to be one version of the data stored at any one time</li></ul></div><p>For example, storing a string/string key pair of<code class="literal"> data_url</code> and "<a class="ulink" href="http://mywebsite.com/data.xml">http://mywebsite.com/data.xml</a>" would be a valid way to use app properties. This URL could be re-used throughout all of your application screens/windows and is related to your application, rather than your data.<a id="id237" class="indexterm"/>
</p><p>If your data is complex and needs to be joined, ordered, or queried when retrieving it, then you are better off using a local database built with SQLite. If your data is a file or large blob object, (for example, an image) then this is better stored on the filesystem, in the manner described in our previous recipe.</p></div><div><div><div><div><h2 class="title"><a id="ch06lvl2sec02"/>What object types can be stored as app properties?</h2></div></div></div><p>There are currently five distinct types of objects that can be stored in the app properties module. These include:<a id="id238" class="indexterm"/>
</p><div><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">Booleans</li><li class="listitem" style="list-style-type: disc">Doubles (float values)</li><li class="listitem" style="list-style-type: disc">Integers</li><li class="listitem" style="list-style-type: disc">Strings</li><li class="listitem" style="list-style-type: disc">Lists (arrays)</li></ul></div><p>In the following recipe, we will create a number of app properties and then read them back, printing them out to the console as we do so.</p><div><h3 class="title"><a id="note45"/>Note</h3><p>Complete source code for this entire chapter can be found in the<code class="literal"> /Chapter 6/EventsAndProperties</code>.</p></div></div></div></div>
<div><div><div><div><h1 class="title"><a id="ch06lvl1sec02"/>Reading and writing app properties</h1></div></div></div><p>Whether reading or writing values, all app properties are accessed from the<code class="literal"> Titanium.App.Properties</code> namespace. In this recipe, we are going to create a number of properties, all with different types, on the first tab window of our app. We will then read them and output their values to the console from a button in the second tab window. We'll also show you how to check the existence of a property using the<code class="literal"> hasProperty</code> method.<a id="id239" class="indexterm"/>
</p><div><h3 class="title"><a id="note46"/>Note</h3><p>Complete source code for this recipe can be found in the<code class="literal"> /Chapter 6/Recipe 1</code> folder.</p></div><div><div><div><div><h2 class="title"><a id="ch06lvl2sec03"/>Getting ready</h2></div></div></div><p>To prepare for this recipe, open up Titanium Studio and log in if you have not already done so. If you need to register a new account, you can do so for free directly from within the application. Once you are logged in, click on<strong> New Project</strong>, and the details window for creating a new project will appear. Enter in<code class="literal"> EventsAndProperties</code> as the name of the app, and fill in the rest of the details with your own information.<a id="id240" class="indexterm"/>
</p><p>Pay attention to the app identifier, which is written normally in reverse domain notation (that is,<em> com.packtpub.eventsandproperties)</em>. This identifier cannot be easily changed after the project is created and you will need to match it<em> exactly</em> when creating provisioning profiles for distributing your apps later on.</p></div><div><div><div><div><h2 class="title"><a id="ch06lvl2sec04"/>How to do it…</h2></div></div></div><p>Open up the<code class="literal"> app.js</code> file in your editor and leave the existing code, except for the declaration of the two labels and the lines where those labels are added to your tab Windows. After the declaration of the<code class="literal"> win1</code> object, type in the following code:</p><div><pre class="programlisting">//
//create a button that will define some app properties
//
var buttonSetProperties = Titanium.UI.createButton({
title: 'Set Properties!',
top: 50,
left: 20,
width: 280,
height: 40
});
//create event listener
buttonSetProperties.addEventListener('click',function(e){
Titanium.App.Properties.setString('myString', 'Hello world!');
Titanium.App.Properties.setBool('myBool', true);
Titanium.App.Properties.setDouble('myDouble', 345.12);
Titanium.App.Properties.setInt('myInteger', 11);
Titanium.App.Properties.setList('myList', ['The first value', 'The second value','The third value']);
alert('Your app properties have been set!');
}); //end event listener
win1.add(buttonSetProperties);
</pre></div><p>Now, while still in your<code class="literal"> app.js</code> file, add the following code. It should be placed after the declaration of the<code class="literal"> win2</code> object.<a id="id241" class="indexterm"/>
</p><div><pre class="programlisting">//
//create a button that will check for some properties
//
var buttonCheckForProperty = Titanium.UI.createButton({
title: 'Check Property?',
top: 50,
left: 20,
width: 280,
height: 40
});
//create event listener
buttonCheckForProperty.addEventListener('click',function(e){
if(Titanium.App.Properties.hasProperty('myString')){
Ti.API.info('The myString property exists!');
}
if(!Titanium.App.Properties.hasProperty('someOtherString')){
Ti.API.info('The someOtherString property does not exist.');
}
}); //end event listener
win2.add(buttonCheckForProperty);
//
//create a button that will read and output some app //properties to the console
//
var buttonGetProperties = Titanium.UI.createButton({
title: 'Get Properties!',
top: 50,
left: 20,
width: 280
height: 40
});
//create event listener
buttonGetProperties.addEventListener('click',function(e){
Ti.API.info('myString property = ' + Titanium.App.Properties.getString('myString'));
Ti.API.info('myBool property = ' + Titanium.App.Properties.getBool('myBool'));
Ti.API.info('myDouble property = ' + Titanium.App.Properties.getDouble('myDouble'));
Ti.API.info('myInteger property = ' + Titanium.App.Properties.getInt('myInteger'));
Ti.API.info('myList property = ' + Titanium.App.Properties.getList('myList'));
}); //end event listener
win2.add(buttonGetProperties);
</pre></div><p>Now, launch the emulator from Titanium Studio and you should see the standard 2-tab navigation view, with a button in each view. Clicking on the<strong> Set</strong> button on the first tab will set your app properties. After you have done so, you can use the buttons on the second tab view to read back individual properties and check the existence of a property. The results will appear in your Titanium Studio console, similar to the following screenshot:<a id="id242" class="indexterm"/>
</p><div><img src="img/3968EXP_06_01.jpg" alt="How to do it…"/></div></div><div><div><div><div><h2 class="title"><a id="ch06lvl2sec05"/>How it works…</h2></div></div></div><p>In this recipe, we are setting a number of app properties, using our<strong> Set Properties!</strong> button. Each property consists of a key/value pair, and therefore requires a property name (also called the 'key') and a property value. To set a property, we use the<code class="literal"> set</code> method, which looks similar to<code class="literal"> Titanium.App.Properties.set&lt;type&gt;(key,value)</code>. We are then retrieving our app properties by using the<code class="literal"> get</code> method, which looks similar to<code class="literal"> Titanium.App.Properties.get&lt;type&gt;(key,value)</code>.<a id="id243" class="indexterm"/>
</p><p>Application properties are loaded into memory as the app launches, and exist in the global scope of the app until either it is closed, or the property is removed from memory using the<code class="literal"> Titanium.App.Properties.remove()</code> method. While there is a memory overhead in using properties in this manner, it means you can efficiently and quickly access them from any part of your application as they are effectively global in scope.<a id="id244" class="indexterm"/>
</p><p>You can also access the entire list of properties stored at any given time using the<code class="literal"> Titanium.App.Properties.listProperties</code> method.<a id="id245" class="indexterm"/>
</p></div></div>
<div><div><div><div><h1 class="title"><a id="ch06lvl1sec03"/>Firing and capturing events</h1></div></div></div><p>Much of Titanium is built around the concept of event-driven programming. If you have ever written code in Visual Basic, C#, Java or any number of event-driven, object-orientated languages, this concept will already be familiar to you.<a id="id246" class="indexterm"/>
</p><p>Each time a user interacts with a part of your application's interface, or types something in a<code class="literal"> TextField</code>, an event occurs. The event is simply the action the user took (for example, a tap, a scroll, or a key press on the virtual keyboard) and where it took place (for example, on a button, or in this<code class="literal"> TextField)</code>. Additionally, some events can indirectly cause other events to fire. For example, when the user selects a menu item that opens a window, it causes another event—the opening of the window.</p><p>There are basically two fundamental types of events in Titanium; those you define yourself (a custom event), and those already defined by the Titanium API (a button click event is a good example).</p><p>In the following recipes, we will explore a number of Titanium-defined events before showing you how to create custom events that can pass data between your app and a Webview.</p><p>As mentioned in the previous recipe, the user can also indirectly cause events to occur. Buttons, for example, have an event called 'click', which occurs when the user clicks on the button on the screen. The code that handles the response to an event is called an event handler.</p><p>There are many events that can occur to each object in your Titanium application. The good news is that you don't need to learn about all of them, and those that are already defined are listed in the Titanium API. You simply need to know how they work and how the event data is accessed so you can find out if the object is able to respond to that event.</p><p>In this recipe, we will explore the events that occur from a number of common components, using the<code class="literal"> OptionDialog</code> as an example, and explain how to access the properties of those events. We'll also explain how to create a function that passes the resulting event back to our executing code.<a id="id247" class="indexterm"/>
</p><div><h3 class="title"><a id="note47"/>Note</h3><p>Complete source code for this recipe can be found in the<code class="literal"> /Chapter 6/Recipe 2</code> folder.</p></div><div><div><div><div><h2 class="title"><a id="ch06lvl2sec06"/>How to do it…</h2></div></div></div><p>Open up the<code class="literal"> app.js</code> file in your editor, and below your declaration of the<code class="literal"> win1</code> object, type in the following code:</p><div><pre class="programlisting">//create a button that will launch the optiondialog via
//its click event
var buttonLaunchDialog = Titanium.UI.createButton({
title: 'Launch OptionDialog',
top: 110,
left: 20,
width: 280,
height: 40
});
//create the event listener for the button
buttonLaunchDialog.addEventListener('click',function(e){
Ti.API.info(e.source + ' was tapped, it has a title of: ');
Ti.API.info(e.source.title);
});
//add the launch dialog button to our window
win1.add(buttonLaunchDialog);
</pre></div><p>Now, after you have created the previous code, we are going to create an<code class="literal"> OptionDialog</code> with an event listener that uses an external function as its event handler. We'll do this in the event handler function for the<code class="literal"> buttonLaunchDialog:</code>
<a id="id248" class="indexterm"/>
</p><div><pre class="programlisting">//create the event listener for the button
buttonLaunchDialog.addEventListener('click',function(e){
Ti.API.info(e.source + ' was tapped, it has a title of: ');
Ti.API.info(e.source.title);
var dialog = Titanium.UI.createOptionDialog({
options:['More than words can say!',
'Lots!',
'It is okay...',
'I hate ice cream', 'Cancel'],
cancel: 4,
title: 'How much do you like ice cream?'
});
//add the event listener for the option dialog
dialog.addEventListener('click', optionDialogEventHandler);
//show the option dialog
dialog.show();
});
</pre></div><p>All that is left to do now is create the final event handler function for our<code class="literal"> OptionDialog</code>. Add the following function to your code before the<code class="literal"> buttonLaunchDialog's</code> event listener:</p><div><pre class="programlisting">//this is the event handler function for our option dialog
function optionDialogEventHandler(e) {
alert(e.source + ' index pressed was ' + e.index);
}
</pre></div><p>Try launching your code now in either the iPhone or Android emulator. As seen in the following example screenshots, you should be able to click on the button and execute the launch of the<code class="literal"> OptionDialog</code> through the button's event handler, which in turn can then show an alert executed via the<code class="literal"> optionDialogEventHandler:</code>
<a id="id249" class="indexterm"/>
</p><div><img src="img/3968EXP_06_02.jpg" alt="How to do it…"/></div></div><div><div><div><div><h2 class="title"><a id="ch06lvl2sec07"/>How it works…</h2></div></div></div><p>First, it's important to reiterate the difference between the event handler and the event listener. The code that listens for a particular event, such as 'click', and then attaches a particular function in response is called the event listener. The code that handles the response to an event is called an event handler. In this recipe, we have shown that event listeners can be launched directly via user interaction, such as a button click, and that event handlers can be executed in one of the following two ways:<a id="id250" class="indexterm"/>
</p><div><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">Our first method is inline, that is, the event handler function is declared directly within the event listener, such as<code class="literal"> buttonLaunchDialog.addEventListener('click', function(e){} )</code>;. This is great for quick execution of code that is perhaps used once for a simple task, but does not have a great deal of code reuse.</li><li class="listitem" style="list-style-type: disc">The second method, and a much more preferable way of using an event handler, is to write it as a separate, self-contained function, such as:<a id="id251" class="indexterm"/><div><pre class="programlisting">function dialogClicked(e) {
//e.source will tell you what object was clicked
}
//create the event listener for the button
buttonLaunchDialog.addEventListener('click', dialogClicked);
</pre></div></li><li class="listitem" style="list-style-type: disc">This method allows you to get much greater code reuse, and is generally considered a much neater way of organizing your source code.</li></ul></div></div></div>
<div><div><div><div><h1 class="title"><a id="ch06lvl1sec04"/>Passing event data between your app and a Webview using custom events</h1></div></div></div><p>While we can use the events built into the Titanium API to suit 90 percent of our general purposes, what happens when we want to launch an event that's not covered by one of the standard Titanium components? Luckily for us, Titanium already has this covered with the<code class="literal"> fireEvent</code> method in our<code class="literal"> Titanium.App</code> namespace!<a id="id252" class="indexterm"/>
</p><p>FireEvent allows you to execute an arbitrary event with an event listener name that you determine, and then listen for that event in your code. In this recipe, we are going to get a little bit tricky and write some code that copies an input field's data and displays it on a label back in our app. We will do this by firing off a custom event from within a Webview, which we'll then listen for and respond to back in our Titanium window.<a id="id253" class="indexterm"/>
</p><div><div><div><div><h2 class="title"><a id="ch06lvl2sec08"/>See also</h2></div></div></div><div><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">Complete source code for this recipe can be found in the<code class="literal"> /Chapter 6/Recipe 3</code> folder.</li></ul></div></div><div><div><div><div><h2 class="title"><a id="ch06lvl2sec09"/>How to do it…</h2></div></div></div><p>Open up the<code class="literal"> app.js</code> file in your editor, and below your declaration of the<code class="literal"> win2</code> object, type in the following code to create the Webview:</p><div><pre class="programlisting">//create a webview and then add that to our
//second window (win2) at the bottom
var webview = Titanium.UI.createWebView({
url: 'webevent.html',
width: 320,
height: 100,
bottom: 0
});
</pre></div><p>Now, create a new HTML file and call it<code class="literal"> webevent.html</code>, with the following code. When you have finished, save the HTML file to your project<code class="literal"> Resources</code> folder.<a id="id254" class="indexterm"/>
</p><div><pre class="programlisting">&lt;!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd"&gt;
&lt;html lang="en"&gt;
&lt;head&gt;
&lt;title&gt;EventHandler Test&lt;/title&gt;
&lt;/head&gt;
&lt;body&gt;
&lt;input name="myInputField" id="myInputField" value="" size="40" /&gt;
&lt;/body&gt;
&lt;script&gt;
//capture the keypress event in javascript and fire
//an event passing through our textBox's value as a
//property called 'text'
var textBox = document.getElementById("myInputField");
textBox.onkeypress = function () {
// passing object back with event
Ti.App.fireEvent('webviewEvent',
{ text: this.value });
};
&lt;/script&gt;
&lt;/html&gt;
</pre></div><p>All that is left to do now is create the event handler back in our<code class="literal"> app.js</code> file which will copy the input field data from our HTML file as you type in it, and then add our<code class="literal"> webview</code> to the Window. Write the following code below your initial<code class="literal"> webview</code> object declaration in the<code class="literal"> app.js</code> file:</p><div><pre class="programlisting">//create a label and add to the window
var labelCopiedText = Titanium.UI.createLabel({
width: 'auto',
height: 'auto',
value: '',
bottom: 120
});
win2.add(labelCopiedText);
//create our custom event listener
Ti.App.addEventListener('webviewEvent', function(e)
{
labelCopiedText.text = e.text;
});
win2.add(webview);
</pre></div><p>Run your app in the emulator now and you should be able type in the input field that is within our Webview to see the results mirrored on the label that we positioned above it! You should be able to see a screen just like the one pictured here:<a id="id255" class="indexterm"/>
</p><div><img src="img/3968EXP_06_03.jpg" alt="How to do it…"/></div></div><div><div><div><div><h2 class="title"><a id="ch06lvl2sec10"/>How it works…</h2></div></div></div><p>Basically, our event fired from the<code class="literal"> Titanium.App.fireEvent</code> method creates a cross-context application event that any JavaScript file can listen to. However, there are two caveats to this. First, the event can only be handled if the same event name is used in both your<code class="literal"> fireEvent</code> call and your listener. As with app properties, this event name is case-sensitive so make sure it is spelled exactly the same way throughout all parts of your application code.<a id="id256" class="indexterm"/>
</p><p>Second, you must pass an object back even if it is empty, and that object must be in a JSON serialized format. This standardization ensures that your data payload is always transportable between contexts.</p></div><div><div><div><div><h2 class="title"><a id="ch06lvl2sec11"/>There's more…</h2></div></div></div><p>It's also possible to remove an event listener from your code should you no longer need it. You can do this by calling<code class="literal"> Titanium.App.removeEventListener</code> and passing it the name of your event. Note that it is still case-sensitive, so your event name must match exactly! An example for our application of removing the<code class="literal"> webviewEvent</code> would be:</p><div><pre class="programlisting">Titanium.App.removeEventListener('webviewEvent');
</pre></div></div></div></body></html>