<html><head></head><body><div class="chapter" title="Chapter&#xA0;10.&#xA0;Adding iAds into Your App"><div class="titlepage"><div><div><h1 class="title"><a id="ch10"/>Chapter 10. Adding iAds into Your App</h1></div></div></div><div class="blockquote"><blockquote class="blockquote"><p>Now that we've seen how awesome iAds can be for your brand, we'll take a look at adding them into your existing application to add an additional revenue stream.</p></blockquote></div><p>In this chapter, you'll learn how to:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">Set up an empty placeholder iPhone application, in case you don't currently have an app and its source code</li><li class="listitem" style="list-style-type: disc">Add the iAd banner view to an application</li><li class="listitem" style="list-style-type: disc">Update the banner to handle device rotations</li><li class="listitem" style="list-style-type: disc">Hide the banner when no adverts are available</li></ul></div><p>If you haven't created an iPhone application before or don't have experience with iOS development, don't worry; we'll give you the full code required to add this into an app. In fact, you're able to add the basic iAd banner into an app without any programming experience at all. With that said, the less adventurous may prefer to pass this information onto their app development team.</p><div class="section" title="Setting up the base project"><div class="titlepage"><div><div><h1 class="title"><a id="ch10lvl1sec01"/>Setting up the base project</h1></div></div></div><p>If you've not already got an application but would still like to try adding iAd into an app, we can make a quick single-screen placeholder iPhone project that'll be ready to have a banner added to it.<a class="indexterm" id="id386"/>
</p><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;" title="Note"><h3 class="title"><a id="note135"/>Note</h3><p>We'll be using Xcode; we installed this in<a class="link" href="ch04.html" title="Chapter 4. Making Sure It Works"> Chapter 4</a>,<span class="emphasis"><em> Making Sure it Works</em></span>, when we set up the iOS Simulator, so you should have it available (if not, then jump back and set it up now).</p><p>If you don't want to set up the demo app, you can find the completed placeholder project with the book assets in the<code class="literal"> iAd Demo App</code> folder.</p></div></div></div>
<div class="section" title="Time for action &#x2014; a placeholder app"><div class="titlepage"><div><div><h1 class="title"><a id="ch10lvl1sec02"/>Time for action — a placeholder app</h1></div></div></div><p>Using Xcode and its inbuilt interface builder and the drag-and-drop UI designer, we'll make a single screen iPhone application with some mock components to simulate an app:<a class="indexterm" id="id387"/>
</p><div class="orderedlist"><ol class="orderedlist"><li class="listitem">Open Xcode. If you haven't used it before, you can find it in the<code class="literal"> Applications</code> folder, which is in the<code class="literal"> Developer</code> folder on the root directory of your Mac.<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;" title="Note"><h3 class="title"><a id="note136"/>Note</h3><p>This differs from the<code class="literal"> Applications</code> folder that iAd Producer is in. If you can't find Xcode, then use the search function in finder to locate it.</p></div></li><li class="listitem">Xcode will open the<span class="strong"><strong> Welcome to Xcode</strong></span> window. From here, select<span class="strong"><strong> Create a New Xcode Project</strong></span>. When asked to choose a project type, click on<span class="strong"><strong> View Based Application</strong></span> |<span class="strong"><strong> Continue</strong></span>.</li><li class="listitem">You'll need to enter a<span class="strong"><strong> Product Name</strong></span> (this is what you want to call your application) and a<span class="strong"><strong> Company Identifier</strong></span> (this is usually your website URL reversed). For example, use<code class="literal"> Demo iAd App</code> as the name and<code class="literal"> com.examplecompany</code> as the identifier.</li><li class="listitem">Ensure that the<span class="strong"><strong> Device Family</strong></span> is<span class="strong"><strong> iPhone</strong></span> and deselect<span class="strong"><strong> Include Unit Tests</strong></span>. When your Xcode window looks similar to the following screenshot, click on the<span class="strong"><strong> Next</strong></span> button:<div class="mediaobject"><img alt="Time for action — a placeholder app" src="graphics/1321_10_01.jpg"/></div></li><li class="listitem">Choose a location to save your project and the associated files and then click on<span class="strong"><strong> Create</strong></span>.</li><li class="listitem">Wait while Xcode sets up your project. It will create several files and folders within the directory you chose to save the project. Once the Xcode window has loaded, locate the file<code class="literal"> iAd_Demo_AppViewController.xib</code> from the Xcode project navigator. The project navigator is a pane located to the left of Xcode. If you can't see it, select<span class="strong"><strong> View</strong></span> |<span class="strong"><strong> Navigation</strong></span> |<span class="strong"><strong> Show Project Navigator</strong></span> in the Xcode menu bar.<a class="indexterm" id="id388"/></li><li class="listitem">This opens the XIB file—think of this file as a page in your iAd. It'll open in the Xcode interface builder. The interface builder is like the canvas in iAd Producer; you're able to drop objects from a library to build up your page. To add an object to our canvas, known as a view, open the object library by selecting<span class="strong"><strong> View</strong></span> |<span class="strong"><strong> Activities</strong></span> |<span class="strong"><strong> Object Library</strong></span>. A pane will expand on the right of Xcode and you'll find the object library located at the bottom of it:<div class="mediaobject"><img alt="Time for action — a placeholder app" src="graphics/1321_10_02.jpg"/></div></li><li class="listitem">Here we can see a list of available user interface components, which we can add to our view. Find a label and drag it onto the view.<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;" title="Note"><h3 class="title"><a id="note137"/>Note</h3><p>You'll notice that many of these controls are just like iAd Producer. That's because Apple has tried to keep parity between many of the objects on iOS to reduce the barrier of entry and the learning curve.</p></div></li><li class="listitem">Double-click on the label to edit its text. Change the text to something like<code class="literal"> Apps With iAd Rock!</code> and then click outside the label to exit the editing mode. If you want to change the style of your label, you can use the attributes inspector, which behaves similarly to the properties and styles in iAd Producer. You can find the attribute inspector above the object library. Add a few more objects, such as a button, a switch, a slider, and a text field. Position these on the view, but leave space near the bottom. This is where our banner will appear later.<a class="indexterm" id="id389"/></li><li class="listitem">Your view could look something like this:<div class="mediaobject"><img alt="Time for action — a placeholder app" src="graphics/1321_10_03.jpg"/></div></li><li class="listitem">Really, it doesn't matter how you make this page look; it's just so we have some context when we add our banner in the next exercise.</li><li class="listitem">Finally, we can run our app in the simulator. Select the<span class="strong"><strong> Run</strong></span> button (with a play icon) from the top left of Xcode and the simulator should open. You should be able to toggle the switch and move the sliders around. Whenever you run a project, Xcode builds the app and automatically saves all the files.<a class="indexterm" id="id390"/></li></ol></div><div class="section" title="What just happened?"><div class="titlepage"><div><div><h2 class="title"><a id="ch10lvl2sec01"/>What just happened?</h2></div></div></div><p>We created a view-based application from the Xcode templates that gives us a single view app with a blank view to which we're able to add objects. We added some objects to the view so we have some content available when we run the app. With our view layout complete in the interface builder of Xcode, we simulated the app to see how it behaved.</p><p>Testing the iAd on the device requires you to register it with Apple to provision and enable it for development. This requires an active paid developer membership, which we signed up to in<a class="link" href="ch01.html" title="Chapter 1. Getting Started with iAd"> Chapter 1</a>,<span class="emphasis"><em> Getting Started with iAd</em></span>, to gain access to iAd Producer.</p></div></div>
<div class="section" title="Time for action &#x2014; running on the device"><div class="titlepage"><div><div><h1 class="title"><a id="ch10lvl1sec03"/>Time for action — running on the device</h1></div></div></div><p>If you haven't configured your device for development, we can use Xcode's organizer tool to log in to the Apple provisioning portal and set up the required certificates and register your device:<a class="indexterm" id="id391"/>
</p><div class="orderedlist"><ol class="orderedlist"><li class="listitem">Open Xcode, if it isn't already. Select<span class="strong"><strong> Window</strong></span> |<span class="strong"><strong> Organizer</strong></span> from the menu bar. This will open the organizer that allows us to manage our iOS devices, their provisioning, and app submissions.</li><li class="listitem">Now plug an iOS device in, such as an iPhone or iPad. If it's syncing with iTunes, wait for it to finish. Make sure that the<span class="strong"><strong> device</strong></span> tab of the organizer is selected and find your device in the list to the left.</li><li class="listitem">Select the device and click on the<span class="strong"><strong> Use for Development</strong></span> button to allow it to be set up for development.</li><li class="listitem">Once the device has been configured locally, select the<span class="strong"><strong> + Add to Portal</strong></span> button to contact the Apple developer portal that will set up your device. Enter the<span class="strong"><strong> Username</strong></span> and<span class="strong"><strong> Password</strong></span> for your Apple ID/developer account:<div class="mediaobject"><img alt="Time for action — running on the device" src="graphics/1321_10_04.jpg"/></div></li><li class="listitem">The organizer will now talk to Apple and enable Xcode on your device to interact. Once this has completed, your Mac will be able to send builds to the device.</li><li class="listitem">Close the organizer window and change the device<span class="strong"><strong> Scheme</strong></span> to<code class="literal"> Your Device Name</code> from the drop-down selector next to the<span class="strong"><strong> Run</strong></span> and<span class="strong"><strong> Stop</strong></span> buttons. Xcode will build your app and you should see it running on your device shortly after.<a class="indexterm" id="id392"/></li></ol></div><div class="section" title="What just happened?"><div class="titlepage"><div><div><h2 class="title"><a id="ch10lvl2sec02"/>What just happened?</h2></div></div></div><p>Xcode automatically added your device to the provisioning portal, which you can view and manage at<a class="ulink" href="http://developer.apple.com"> http://developer.apple.com</a>. When adding a device to the portal, Xcode carries out the following steps:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">Submits the<span class="strong"><strong> Unique Device Identifier  (UDID)</strong></span> to the Apple provisioning portal.</li><li class="listitem" style="list-style-type: disc">Adds the device to your registered devices list, which is linked to your developer account. Each account can add up to 100 devices.</li><li class="listitem" style="list-style-type: disc">Creates and installs certificates on your behalf, which are used to secure the builds so only you can make them.</li><li class="listitem" style="list-style-type: disc">Generates and sets up a development<span class="strong"><strong> provisioning profile</strong></span>—this tells the device if it's allowed to run an app or not. A provisioning profile contains a list of UDIDs for each device, which is entitled to run the associated app.<a class="indexterm" id="id393"/></li></ul></div><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;" title="Note"><h3 class="title"><a id="note138"/>Note</h3><p>You'll need to repeat this process for each device that you want to test on and it's specific to the Mac user account. If you switch machines, you'll need to reconfigure Xcode and follow these steps again.</p></div><p>With our demo app in place and running on the simulator and device, we can add our first iAd banner to it!</p></div></div>
<div class="section" title="Adding the banner to your view"><div class="titlepage"><div><div><h1 class="title"><a id="ch10lvl1sec04"/>Adding the banner to your view</h1></div></div></div><p>We're able to add the iAd banner to a view of your app using the interface builder. It's a simple drag-and-drop to get the basic banner functionality.<a class="indexterm" id="id394"/>
</p></div>
<div class="section" title="Time for action &#x2014; adding the banner"><div class="titlepage"><div><div><h1 class="title"><a id="ch10lvl1sec05"/>Time for action — adding the banner</h1></div></div></div><p>We'll add an iAd banner into the placeholder app that we built in the last exercise. If you want to use your own app make sure you're familiar with the interface builder in Xcode. Follow these steps in order to add the banner:<a class="indexterm" id="id395"/>
</p><div class="orderedlist"><ol class="orderedlist"><li class="listitem">Open your project, or our demo project in Xcode.</li><li class="listitem">From the file list, open the file<code class="literal"> iAd_Demo_AppViewController.xib</code>, if it isn't already. This will launch the interface builder. From the object library, drag the<span class="strong"><strong> Ad BannerView</strong></span> object to the main view. The object library contains a large amount of items that can make it hard to navigate. You can use the search text area underneath it to filter results. Searching for a banner reveals any banner-related objects. In the following screenshot, you can see a search for<span class="strong"><strong> banner:</strong></span><div class="mediaobject"><img alt="Time for action — adding the banner" src="graphics/1321_10_05.jpg"/></div></li><li class="listitem">Reposition your banner view so it snaps into place at the bottom center of the screen.</li><li class="listitem">Apple recommends putting your banner at the top or bottom of your app and making sure it is static; putting it in scrollable views or lists limits the on-screen time of the banner, which will severely impact the revenue generated by your campaign. Try to run your app using the<span class="strong"><strong> Run</strong></span> button or the keyboard shortcut<span class="emphasis"><em> cmd</em></span> +<span class="emphasis"><em> r</em></span>. You'll find that the app crashes before it's able to start up. This is due to there being a dependency of the banner view that we'll need to include. An iAd banner requires the iAd framework to be included with our application.</li><li class="listitem">To add the iAd framework, click on the name of your project in the project navigator pane on the left of Xcode. If you're using the demo project, this will be<code class="literal"> iAd Demo Project</code> and can be found at the very top of the project navigator. This will open the info of your project in the main Xcode window. Select your project name under<span class="strong"><strong> TARGETS</strong></span> and change the tab to<span class="strong"><strong> Build Phases</strong></span>.<a class="indexterm" id="id396"/></li><li class="listitem">Expand the<span class="strong"><strong> Link Binaries With Libraries</strong></span> section and click on the<span class="strong"><strong> +</strong></span> button at the bottom of the section to open the library/framework picker. Search for<code class="literal"> iAd</code> and select<span class="strong"><strong> iAd.framework</strong></span>. Then click on<span class="strong"><strong> add</strong></span>.<div class="mediaobject"><img alt="Time for action — adding the banner" src="graphics/1321_10_06.jpg"/></div></li><li class="listitem">From the project navigator file list, drag the<span class="strong"><strong> iAd.framework</strong></span> file to the<code class="literal"> Frameworks</code> folder. You don't have to do this step, but it helps keep your project tidy.</li><li class="listitem">Run your app. You should see the test banner appear after a few seconds. Try tapping it to open the demo advertisement.</li><li class="listitem">Great work! Your project now successfully has an iAd in it!<a class="indexterm" id="id397"/></li></ol></div><div class="section" title="What just happened?"><div class="titlepage"><div><div><h2 class="title"><a id="ch10lvl2sec03"/>What just happened?</h2></div></div></div><p>We just added the Ad BannerView object to our app's view and positioned it at the bottom center of the screen. Using the build phases, a list of steps called when building and running the app, we added the iAd framework to be sure it's available in our app. We had to add the<code class="literal"> iAd.framework</code> to our app's project or else the banner view wouldn't be able to access the correct components and cause the app to crash.</p><p>When an app is in debug or development mode, the iAd Network automatically serves a test advertisement. This is to prevent<span class="strong"><strong> click fraud</strong></span>, where artificial clicks (or taps) are generated to cheat the system and falsely increase revenue:</p><div class="mediaobject"><img alt="What just happened?" src="graphics/1321_10_07.jpg"/></div><p>Before you submit your application to the App Store, we need to enable our ads for production. We'll do this in the next chapter, but first let's look at improving our banner experience within the app.</p></div></div>
<div class="section" title="Handling orientation changes"><div class="titlepage"><div><div><h1 class="title"><a id="ch10lvl1sec06"/>Handling orientation changes</h1></div></div></div><p>You may remember that when we built banners in iAd Producer, we checked whether they worked in both portrait and landscape; however, currently, our demo app only works in portrait. Making sure your app displays banners in any orientation will ensure that you get maximum exposure and revenue from the iAd Network.<a class="indexterm" id="id398"/>
</p></div>
<div class="section" title="Time for action &#x2014; you spin me right round"><div class="titlepage"><div><div><h1 class="title"><a id="ch10lvl1sec07"/>Time for action — you spin me right round</h1></div></div></div><p>If you're using the demo app, then let's enable all the possible orientations. Make sure our banner adjusts itself accordingly:</p><div class="orderedlist"><ol class="orderedlist"><li class="listitem">Open the demo app in Xcode. If you're using your own app that already supports multiple orientations, skip ahead to step 4.</li><li class="listitem">To enable our app to know it should spin the view when the device is rotated, we need to modify a simple bit of Objective C. Open the file<code class="literal"> iAd_Demo_AppViewController.m</code> from the project navigator; you'll see the code appear on screen. Find the method<code class="literal"> (BOOL)shouldAutorotateToInterfaceOrientation</code>, which should be near the end of the function. This is called by the device when it's rotated and we're able to tell it when it should and shouldn't update the view. Find the following line:<div class="informalexample"><pre class="programlisting">return (interfaceOrientation == UIInterfaceOrientationPortrait);
</pre></div></li><li class="listitem">At the moment, it checks if the rotation orientation is portrait, and returns<code class="literal"> YES</code> if it is and<code class="literal"> NO</code> if it isn't. We're able to override this check and always say<code class="literal"> YES</code>; change the line to read:<div class="informalexample"><pre class="programlisting">return YES;
</pre></div></li><li class="listitem">This will mean the app will allow the view to rotate to any possible orientation.</li><li class="listitem">Run the app and try rotating it; you'll see that the view rotates but it gets cropped in landscape and the banner view isn't visible. For now, we'll ignore the rest of the cropped content but adjust our banner to be in view regardless.</li><li class="listitem">Open your view's XIB file in the interface builder. If you're continuing with the demo app, it'll be<code class="literal"> iAd_Demo_AppViewController.xib</code>. Click on the ad banner view at the bottom of the view to select it. From the menu bar, select<span class="strong"><strong> View</strong></span> |<span class="strong"><strong> Utilities</strong></span> |<span class="strong"><strong> Show Size Inspector</strong></span>.<a class="indexterm" id="id399"/></li><li class="listitem">This opens the size inspector that lets us modify the layout information of the banner view. The size inspector is a pane on the right of Xcode, above the object library.</li><li class="listitem">Find the<span class="strong"><strong> Autosizing</strong></span> box and click on the top red double-t beam shape to disable it. Then enable the bottom one with a click. Your auto-sizing settings should look like the following screenshot:<div class="mediaobject"><img alt="Time for action — you spin me right round" src="graphics/1321_10_08.jpg"/></div></li><li class="listitem">This means the banner's position will be set from the bottom of the screen instead of the top, so it'll always be attached to the bottom of the view no matter the height.</li><li class="listitem">Test the ad again. The banner now sits at the bottom of the screen no matter what the orientation, but it's not dynamically updating to fill the screen correctly. We need to make the banner view accessible to our code so we can inform it when a rotation occurs. This works similarly to the outlets in iAd Producer.</li><li class="listitem">Open the file<code class="literal"> iAd_Demo_AppViewController.h</code> from the project navigator. This will open the code editor in Xcode. After<code class="literal"> #import &lt;UIKit/UIKit.h&gt;</code>, add the following code:<a class="indexterm" id="id400"/><div class="informalexample"><pre class="programlisting">#import &lt;iAd/iAd.h&gt;
</pre></div></li><li class="listitem">This tells the file that we'll be using the iAd framework so it should import it. Now in-between<code class="literal"> @interface iAd_Demo_AppViewController : UIViewController</code> and<code class="literal"> @end</code>, add the following code:<div class="informalexample"><pre class="programlisting">{
ADBannerView *bannerView;
}
@property(nonatomic, strong) IBOutlet ADBannerView *bannerView;
</pre></div></li><li class="listitem">This creates a variable called<code class="literal"> bannerView</code>, which will be accessible from our code. The<code class="literal"> IBOutlet</code> tells the interface builder that the<code class="literal"> bannerView</code> is available as an outlet.</li><li class="listitem">Change the code editor to the file<code class="literal"> iAd_Demo_AppViewController.m</code> and after<code class="literal"> @implementation iAd_Demo_AppViewController</code>, add the following code on a new line:<div class="informalexample"><pre class="programlisting">@synthesize bannerView;
</pre></div></li><li class="listitem">This will allow us to access the<code class="literal"> bannerView's</code> properties.<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;" title="Note"><h3 class="title"><a id="note139"/>Note</h3><p>You might find that Xcode tries to help you write the code with auto completion and suggestions. In order to confirm that you want it to use a suggestion, press the<span class="emphasis"><em> tab</em></span> key.</p></div></li><li class="listitem">With our outlet in place, we can connect to it in the interface builder. Open<code class="literal"> iAd_Demo_AppViewController.xib</code> and right-click on the<span class="strong"><strong> File's Owner</strong></span> icon—a wireframe cube found to the left of the interface builder. Click-and-drag the circle, after the<span class="strong"><strong> bannerView</strong></span> outlet in the overlaid list, and drag to the<span class="strong"><strong> AdBannerView</strong></span> on the main view, as shown in the following screenshot:<div class="mediaobject"><img alt="Time for action — you spin me right round" src="graphics/1321_10_09.jpg"/></div></li><li class="listitem">This links the outlet we made in our code with the banner on the interface builder view. Now we can access our banner in the code and can inform the banner when a rotation occurs. Before the<code class="literal"> @end</code> line near the bottom of the file, add the following block of code:<div class="informalexample"><pre class="programlisting">(void)willRotateToInterfaceOrientation:(UIInterfaceOrientation)toInterfaceOrientation duration:(NSTimeInterval)duration
{
if(UIInterfaceOrientationIsLandscape(toInterfaceOrientation))
bannerView.currentContentSizeIdentifier =ADBannerContentSizeIdentifierLandscape;
else
bannerView.currentContentSizeIdentifier = ADBannerContentSizeIdentifierPortrait;
}
</pre></div></li><li class="listitem">You may find auto complete useful when adding this code. We're taking the<code class="literal"> willRotateToInterfaceOrientation</code> method that is called by the device just before the rotation occurs. We then check the orientation it's going to rotate to and update the<code class="literal"> contentSizeIdentifier</code> property of our banner to that new orientation.<a class="indexterm" id="id401"/></li><li class="listitem">Run the app and test by rotating the device; the banner will now update to fill the screen and display a landscape ad.<a class="indexterm" id="id402"/></li></ol></div><div class="section" title="What just happened?"><div class="titlepage"><div><div><h2 class="title"><a id="ch10lvl2sec04"/>What just happened?</h2></div></div></div><p>We improved the experience and potential revenue of our app by tweaking the banner view to work. Your banner should dynamically update the banner creative, no matter what orientation the device is in:</p><div class="mediaobject"><img alt="What just happened?" src="graphics/1321_10_10.jpg"/></div><p>By making the banner view accessible from the code, we're now able to add several more enhancements to our app, such as hiding the view when no ads are available or providing fallback content.</p></div><div class="section" title="Pop Quiz"><div class="titlepage"><div><div><h2 class="title"><a id="ch10lvl2sec05"/>Pop Quiz</h2></div></div></div><p>Xcode and Objective C can be a little overwhelming at first, but once you grasp the basics, you'll notice the similarities it has with iAd Producer. See what you've learnt by trying these questions:</p><div class="orderedlist"><ol class="orderedlist"><li class="listitem">To make an object in the interface builder accessible from the code, would you?<div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: none">a. Declare an IBOutlet in your code and then connect the outlet in the interface builder</li><li class="listitem" style="list-style-type: none">b. Rename the item in the interface builder and then use that in the code</li><li class="listitem" style="list-style-type: none">c. Just write the code and the interface builder will add the item</li><li class="listitem" style="list-style-type: none">d. Access the views items as<code class="literal"> [UIView objectAtIndex:0]</code>, depending on their location on the page</li></ul></div></li><li class="listitem">If an iAd banner is crashing our app, what is the most common cause?<div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: none">a. No adverts are available</li><li class="listitem" style="list-style-type: none">b. The ad downloaded is too large for the OS to cope</li><li class="listitem" style="list-style-type: none">c. There's no Internet connection</li><li class="listitem" style="list-style-type: none">d. The project is missing the iAd framework</li></ul></div></li></ol></div></div></div>
<div class="section" title="Handling no available ads"><div class="titlepage"><div><div><h1 class="title"><a id="ch10lvl1sec08"/>Handling no available ads</h1></div></div></div><p>Your app will encounter scenarios where the iAd Network is unable to serve an ad. This could be due to poor network coverage or iAd not yet being available in the country of a user. We should gracefully handle this by making sure that we don't display an empty banner and bringing the banner back into view if one becomes available.</p></div>
<div class="section" title="Time for action &#x2014; ban the banner"><div class="titlepage"><div><div><h1 class="title"><a id="ch10lvl1sec09"/>Time for action — ban the banner</h1></div></div></div><p>With a few small tweaks to our view and code, we can animate our banner on and off the screen, depending on the availability of ads:<a class="indexterm" id="id403"/>
</p><div class="orderedlist"><ol class="orderedlist"><li class="listitem">Open the demo project, or your own project containing an Ad Banner View, in Xcode. Open the main controller file for your view, for example,<code class="literal"> iAd_Demo_AppViewController.m</code>.</li><li class="listitem">Lets' assume that an ad is always going to fail and move the banner out of view as soon as the app comes into view. We'll then wait for the successful message from the iAd Network and bring it into view. Add this following code around line 30:<div class="informalexample"><pre class="programlisting">- (void)viewWillAppear:(BOOL)animated
{
CGRect frame = self.view.bounds;
CGPoint bannerOrigin =CGPointMake(CGRectGetMinX(frame), CGRectGetMaxY(frame));
bannerView.frame = CGRectMake(bannerView.bounds.origin.x, bannerOrigin.y, bannerView.frame.size.width, bannerView.frame.size.height);
}
</pre></div></li><li class="listitem">This takes the frame of the banner and sets the<code class="literal"> y</code> value to be the height of the current view, which repositions it off screen. Try running your app; you'll see that the banner never appears, even though it's likely the one loaded, because the banner never gets back in place when an ad loads successfully.</li><li class="listitem">We'll now use the<code class="literal"> delegate</code> methods of the iAd banner to handle the success and failure responses of the ad. A delegate is a way of interacting and receiving events or messages from an object; in our case, we can implement the banner's delegate in our code so it notifies us of changes. Let's update the code, so the banner knows what it should use for its delegate. In the<code class="literal"> viewWillAppear</code> method we modified a few steps back, add the following to the end of the method:<div class="informalexample"><pre class="programlisting">bannerView.delegate = self;
<a class="indexterm" id="id404"/>
</pre></div></li><li class="listitem">After adding this, you should see a yellow warning icon appear next to the line number. Click on this to reveal the warning:<div class="mediaobject"><img alt="Time for action — ban the banner" src="graphics/1321_10_11.jpg"/></div></li><li class="listitem">This warning tells us that although we've set the delegate of the banner view to be the current file (by saying<code class="literal"> self)</code>, it currently wouldn't be able to handle its role. Switch files to<code class="literal"> iAd_Demo_AppViewController.h</code>, which is known as the header file, and find<code class="literal"> UIViewController</code>. Update it to say the following:<div class="informalexample"><pre class="programlisting">UIViewController&lt;ADBannerViewDelegate&gt;
</pre></div></li><li class="listitem">This tells our view controller class that it can respond to requests from an Ad Banner View's delegate. With our delegate in place and our view controller able to respond to it, we can now add the successful and failure methods that will handle the ad. Before the<code class="literal"> @end</code> of your<code class="literal"> iAd_Demo_AppViewController.m</code> file, add the following:<div class="informalexample"><pre class="programlisting">#pragma mark ADBannerViewDelegate methods
</pre></div></li><li class="listitem">This isn't required, but it helps separate the sections of our code and highlights where the<code class="literal"> delegate</code> methods start from.</li><li class="listitem">After our<code class="literal"> pragma mark</code> line, we can add the delegate methods. Starting with the code to bring the banner back into view once an ad has successfully loaded. Add this method immediately after your<code class="literal"> pragma mark</code> line:<div class="informalexample"><pre class="programlisting">-(void)bannerViewDidLoadAd:(ADBannerView *)banner
{
CGRect frame = self.view.bounds;
CGPoint bannerOrigin =CGPointMake(CGRectGetMinX(frame), CGRectGetMaxY(frame));
<span class="strong"><strong>bannerOrigin.y -= bannerView.bounds.size.height;
</strong></span>
// Animate into view
[UIView animateWithDuration:2.0f
animations:^{
bannerView.frame = CGRectMake(bannerView.bounds.origin.x, bannerOrigin.y, bannerView.frame.size.width, bannerView.frame.size.height);
}];
}
</pre></div></li><li class="listitem">Here we've added the method<code class="literal"> bannerViewDidLoadAd</code>, which is a delegate method of the banner. When the iAd Network successfully delivers an ad, it calls this code. We then take the banner's frame and adjust it to bring it back into view, with the added tweak of animating the change so that the banner will move in from the bottom of the view. Run the ad and you'll see the banner appear.<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;" title="Note"><h3 class="title"><a id="note140"/>Note</h3><p>Sometimes the iAd Network doesn't deliver an advert to simulate a failure. If you find a banner hasn't appeared, try closing and re-opening your app to trigger another ad.</p></div></li><li class="listitem">With our banner animating in, let's make sure it can also animate out if there's a problem downloading an ad. Once the banner is visible, it'll circulate between various creatives, so we shouldn't just assume once we have one ad that we'll continue to receive a stream of them. Similar to the<code class="literal"> bannerViewDidLoadAd</code> delegate method, we can use the<code class="literal"> didFailToReceiveAdWithError</code> method when we're unable to get an ad. Use this method with the following code, placing it beneath the code we added in the last step:<div class="informalexample"><pre class="programlisting">(void)bannerView:(ADBannerView *)banner didFailToReceiveAdWithError:(NSError *)error
{
CGRect frame = self.view.bounds;
CGPoint bannerOrigin =CGPointMake(CGRectGetMinX(frame), CGRectGetMaxY(frame));
// Animate into view
[UIView animateWithDuration:2.0f
animations:^{
bannerView.frame = CGRectMake(bannerView.bounds.origin.x, bannerOrigin.y, bannerView.frame.size.width, bannerView.frame.size.height);
}];
}
</pre></div></li><li class="listitem">You may notice that this code is almost identical to when we receive an ad; except, now we're not subtracting the height of the banner from the frame, so it is offscreen. In the next exercise, we'll look at optimizing our code by not duplicating it.</li><li class="listitem">If you patiently watch your app, it'll eventually fail to download a banner and you should see the current banner slide out of view.<a class="indexterm" id="id405"/></li></ol></div><div class="section" title="What just happened?"><div class="titlepage"><div><div><h2 class="title"><a id="ch10lvl2sec06"/>What just happened?</h2></div></div></div><p>We added some code to the<code class="literal"> viewWillAppear</code> method, which is called whenever the view is about to become visible. This code hides the empty banner off screen to make more space available for additional components. Using delegates, we set up the view to respond to messages from the iAd Network and animate the banner on and off the screen, depending on the availability of ads.</p></div><div class="section" title="Have a go hero"><div class="titlepage"><div><div><h2 class="title"><a id="ch10lvl2sec07"/>Have a go hero</h2></div></div></div><p>Our app is looking great with our banner appearing in our app and correctly resizing on rotation, and displaying or hiding itself when ads become available. If you're finding these steps simple, then try these more advanced tasks:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">Update the<span class="strong"><strong> Autosizing</strong></span> properties of the items in the placeholder app, so they don't get cropped in landscape.</li><li class="listitem" style="list-style-type: disc">If you're comfortable with iPhone development, consider grouping all of your content into a view separate from the banner. This can then be a sibling of the banner view and it's layout can be resized, dependent on a banner's availability.</li><li class="listitem" style="list-style-type: disc">If you have your own app, try sharing one banner object between all the pages in your app for efficiency.</li><li class="listitem" style="list-style-type: disc">Create an iPad project and add a full screen banner into it. For reference, use:<a class="ulink" href="http://developer.apple.com/library/ios/#documentation/UserExperience/Conceptual/iAd_Guide/Full-ScreenAdvertisements/Full-ScreenAdvertisements.html">http://developer.apple.com/library/ios/#documentation/UserExperience/Conceptual/iAd_Guide/Full-ScreenAdvertisements/Full-ScreenAdvertisements.html</a>.</li><li class="listitem" style="list-style-type: disc">Try the next<span class="emphasis"><em> Time for action</em></span> section, where, for the more adventurous, we'll tidy up the code!</li><li class="listitem" style="list-style-type: disc">Read more about the fundamentals of Objective C at<a class="ulink" href="http://developer.apple.com/library/mac/#documentation/Cocoa/Conceptual/CocoaFundamentals/CommunicatingWithObjects/CommunicateWithObjects.html">http://developer.apple.com/library/mac/#documentation/Cocoa/Conceptual/CocoaFundamentals/CommunicatingWithObjects/CommunicateWithObjects.html</a>.</li></ul></div></div></div>
<div class="section" title="Time for action &#x2014; clean the code"><div class="titlepage"><div><div><h1 class="title"><a id="ch10lvl1sec10"/>Time for action — clean the code</h1></div></div></div><p>When you begin to duplicate code, you're increasing the efforts required to maintain your app, because you have to go through every instance and change it. In our last exercise, we have three similar blocks of code that we can combine into one method that intelligently handles the situations. This function will handle the hiding and displaying of our ad, depending on the banner's availability. Continuing with our demo app, complete the following steps to clean up the code:</p><div class="orderedlist"><ol class="orderedlist"><li class="listitem">Before the delegate methods of the banner, and before the<code class="literal"> pragma mark</code>, create an empty method by adding this code:<div class="informalexample"><pre class="programlisting">-(void) adjustBannerVisibility
{
}
</pre></div></li><li class="listitem">We'll need to add the following to the header file,<code class="literal"> iAd_Demo_AppViewController.h</code>, before the<code class="literal"> @end</code> statement in the file add to tell the project that this new method is available:<div class="informalexample"><pre class="programlisting">-(void) adjustBannerVisibility;
</pre></div></li><li class="listitem">This will suppress any warnings from Xcode about unknown methods. Now return back to the main file—<code class="literal">iAd_Demo_AppViewController.m.</code></li><li class="listitem">We can now build the function of this method up. It's going to replace and manage the showing and hiding of the banner. Add the following content inside the method:<div class="informalexample"><pre class="programlisting">CGRect frame = self.view.bounds;
CGPoint bannerOrigin =CGPointMake(CGRectGetMinX(frame), CGRectGetMaxY(frame));
// check if the banner is loaded
if(bannerView.bannerLoaded) {
// bring banner into view
bannerOrigin.y -= bannerView.bounds.size.height;
}
// Animate into view
[UIView animateWithDuration:2.0
animations:^{
bannerView.frame = CGRectMake(bannerView.bounds.origin.x, bannerOrigin.y, bannerView.frame.size.width, bannerView.frame.size.height);
}];
</pre></div></li><li class="listitem">This works the same the previous banner code, but in the one method. The<code class="literal"> bannerView.bannerLoaded</code> checks if we have a banner loaded and then adjusts the offset accordingly.</li><li class="listitem">Currently, we're adjusting the banner in the<code class="literal"> viewWillAppear, didFailToReceiveAdWithError</code>, and<code class="literal"> bannerViewDidLoadAd</code> methods. Go through each of these methods, and replace the banner frame code with our new method. You can call our method by using the following line of code:<div class="informalexample"><pre class="programlisting">[self adjustBannerVisibility];
</pre></div><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;" title="Note"><h3 class="title">Note</h3><p>Make sure you don't remove the<code class="literal"> banner.delegate = self</code>; from the<code class="literal"> viewWillAppear</code> method. This will stop your banner from ever appearing!</p></div></li></ol></div><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: none">For example your <code class="literal">bannerViewDidLoad</code> method should now look like the following:<div class="informalexample"><pre class="programlisting">-(void)bannerViewDidLoadAd:(ADBannerView *)banner
{
[self adjustBannerVisibility];
}
</pre></div></li><li class="listitem" style="list-style-type: none">As with any change, test your app and make sure the new code works as expected!</li></ul></div><div class="section" title="What just happened?"><div class="titlepage"><div><div><h2 class="title"><a id="ch10lvl2sec08"/>What just happened?</h2></div></div></div><p>By combining several methods into one method, we reduce the risk for failure in our code due to a mistake, and can update our code in one central place without having to duplicate any changes. The app is now much tidier. Deleting code is really satisfying because it means less work in the future!</p></div></div>
<div class="section" title="Summary"><div class="titlepage"><div><div><h1 class="title"><a id="ch10lvl1sec11"/>Summary</h1></div></div></div><p>In this chapter, we used iAd to provide a simple, well recognized, and immersive banner and ad experience to your app users. To make the banners work elegantly in our app and to maximize revenue opportunities we:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">Created a placeholder app to test the iAd functionality</li><li class="listitem" style="list-style-type: disc">Placed our banner in a static location, using the interface builder</li><li class="listitem" style="list-style-type: disc">Handled displaying the banner only when it had content</li><li class="listitem" style="list-style-type: disc">Optimized our code to increase its maintainability</li></ul></div><p>With great visibility of our ads and handling the occasions where no ads are available, we should be able to generate a healthy best-possible revenue stream from our app. Before we can start cashing the checks, we need to activate our application for live ads and look at how we can track the revenue; all coming up in the final chapter!</p></div></body></html>