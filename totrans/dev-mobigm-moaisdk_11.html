<html><head></head><body><div class="chapter" title="Chapter&#xA0;11.&#xA0;Let the Right Music In!"><div class="titlepage"><div><div><h1 class="title"><a id="ch11"/>Chapter 11. Let the Right Music In!</h1></div></div></div><p>Sound <a id="id251" class="indexterm"/>and music are always left for the final stages. It's so embarrassing that the same has happened with this book. If you're serious about the gaming experience you're creating, take music and sound into account from the beginning. Even if your game is not audio-centric, you should think of music and audio as feedback systems and treat them with the same importance as graphics.</p><p>In this chapter we'll learn how to play audio files inside your game using the built-in Untz sound system. We'll add background music and sound effects.</p><div class="section" title="Audio manager"><div class="titlepage"><div><div><h1 class="title"><a id="ch11lvl1sec58"/>Audio manager</h1></div></div></div><p>In order to add some music and effects to our game we'll create a module called <code class="literal">AudioManager</code> that will take care of loading sounds and playing them.</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">First of all, we need to<a id="id252" class="indexterm"/> create a file called<a id="id253" class="indexterm"/> <code class="literal">audio_manager.lua</code>. This file will be in charge of <a id="id254" class="indexterm"/>managing all our sound needs. In this case we will <a id="id255" class="indexterm"/>use Untz, but you could easily modify it to use FMOD as follows:<div class="informalexample"><pre class="programlisting">module ( "AudioManager", package.seeall )
local audio_definitions = {
  backgroundMusic = {
    type = RESOURCE_TYPE_SOUND, 
    fileName = 'sounds/music.mp3', 
    loop = true,
    volume = 1
  },
  jump = {
    type = RESOURCE_TYPE_SOUND, 
    fileName = 'sounds/jump.wav', 
    loop = false,
    volume = 1
  }
}</pre></div></li><li class="listitem">In the same way we defined the assets for our game, we will define all the sounds using the resource definition for the audio files. We saw this earlier in the <a class="link" href="ch06.html" title="Chapter 6. Resource Manager">Chapter 6</a>, <span class="emphasis"><em>Resource Manager</em></span>. If you don't understand what we're doing here, I suggest you go back and read about sound definitions in <a class="link" href="ch06.html" title="Chapter 6. Resource Manager">Chapter 6</a>. The <code class="literal">sounds</code> table will act as a cache for our sounds. It will be as follows:<div class="informalexample"><pre class="programlisting">sounds = {}</pre></div></li><li class="listitem">On the <a id="id256" class="indexterm"/>initialization method, the first thing <a id="id257" class="indexterm"/>we do is load all the definitions we added. We do this by calling the <code class="literal">setDefinitions</code> method<a id="id258" class="indexterm"/> from <code class="literal">ResourceDefinitions</code> as follows:<div class="informalexample"><pre class="programlisting">function AudioManager:initialize ()
    ResourceDefinitions:setDefinitions ( audio_definitions )</pre></div></li><li class="listitem">Then, since we're using Untz, we need to initialize it as follows:<div class="informalexample"><pre class="programlisting">    MOAIUntzSystem.initialize ()
end</pre></div><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="tip18"/>Tip</h3><p>You can call <code class="literal">MOAIUntzSystem.initialize</code> with two optional parameters: the sampling rate (which can be changed to match your audio files) and the number of frames per buffer.</p></div></div></li><li class="listitem">In order to play our sounds, we'll define a method that loads them in the local <code class="literal">sounds</code> table as follows:<div class="informalexample"><pre class="programlisting">function AudioManager:get ( name )
    local audio = self.sounds[name]
    
    if not audio then 
        audio = ResourceManager:get ( name )
        self.sounds[name] = audio
    end
    
    return audio
end</pre></div><p>This method checks if the audio has been previously loaded; if it was not loaded, it loads and returns it. We split this from the <code class="literal">play</code> method that we'll write now because we may want to preload the sounds before playing them.</p></li><li class="listitem">The next step is to create the <code class="literal">play</code> method:<div class="informalexample"><pre class="programlisting">function AudioManager:play ( name, loop )
    local audio = AudioManager:get ( name )</pre></div><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Here we get the actual audio. If it was preloaded, it can be played without any loading delays.<div class="informalexample"><pre class="programlisting">    if loop ~= nil then
        audio:setLooping ( loop )
    end</pre></div></li><li class="listitem">Here we can use the <code class="literal">loop</code> parameter to override the default <code class="literal">loop</code> attribute.<div class="informalexample"><pre class="programlisting">    audio:play ()
end</pre></div></li><li class="listitem">And finally, we play it.<div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="tip19"/>Tip</h3><p>It's worth mentioning that playing a sound multiple times will cause the previous play to cut off. </p></div></div></li></ol></div></li><li class="listitem">We'll <a id="id259" class="indexterm"/>now<a id="id260" class="indexterm"/> write a function to stop the audio:<div class="informalexample"><pre class="programlisting">function AudioManager:stop ( name )
    local audio = AudioManager:get ( name )
    audio:stop ()
end</pre></div></li><li class="listitem">We need to append this file in <code class="literal">main.lua</code> just above the required <code class="literal">game.lua</code>.</li></ol></div></div></div>
<div class="section" title="Background music"><div class="titlepage"><div><div><h1 class="title"><a id="ch11lvl1sec59"/>Background music</h1></div></div></div><p>Now let's play some <a id="id261" class="indexterm"/>background music by following the given steps:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">At the bottom of <code class="literal">Game:initialize</code> you should add the following method calls:<div class="informalexample"><pre class="programlisting">    AudioManager:initialize ()</pre></div></li><li class="listitem">We initialize the audio using <code class="literal">AudioManager:initialize</code> (the method we created earlier in this chapter):<div class="informalexample"><pre class="programlisting">    AudioManager:play ( 'backgroundMusic' )</pre></div></li><li class="listitem">And then we play the background music. Remember that we defined it in the <code class="literal">audio_definitions</code> table inside <code class="literal">audio_manager.lua</code>.</li></ol></div><p>That should be it. Run the <a id="id262" class="indexterm"/>game and you should be listening to an amazing song by Milhouse Palacios.</p></div>
<div class="section" title="Sound effects"><div class="titlepage"><div><div><h1 class="title"><a id="ch11lvl1sec60"/>Sound effects</h1></div></div></div><p>We will add a sound<a id="id263" class="indexterm"/> that will be played when the character jumps.</p><p>Open up <code class="literal">character.lua</code> and add a call to <code class="literal">AudioManager:play</code> inside <code class="literal">Character:jump</code>:</p><div class="informalexample"><pre class="programlisting">function Character:jump ( keyDown )
    if keyDown and not self.jumping then
        AudioManager:play ( 'jump' )
        self.physics.body:applyForce ( 0, 8000 )
        self.jumping = true
        self:startAnimation ( 'jump' )
    end
end</pre></div><p>That's it. Run it and listen to your jump.</p></div>
<div class="section" title="Summary"><div class="titlepage"><div><div><h1 class="title"><a id="ch11lvl1sec61"/>Summary</h1></div></div></div><p>In this chapter we created a new module that takes care of the sound. We added some background music and a jump sound effect.</p><p>We've covered a lot already, and you're ready to create a complete game with what we saw. The next chapter will guide you through deploying our <span class="emphasis"><em>Concentration</em></span> game to iOS.</p></div></body></html>