<html><head></head><body><div id="book-content"><div id="sbo-rt-content"><div id="_idContainer443" class="Basic-Text-Frame">
    <h1 class="chapterNumber">17</h1>
    <h1 id="_idParaDest-233" class="chapterTitle">Getting Started with Core Location and MapKit</h1>
    <p class="normal">In the previous chapter, you learned how to pass data from the Add New Journal Entry screen to the Journal List screen, and from the Journal List screen to the Journal Entry Detail screen. You also learned about the <code class="inlineCode">UITextFieldDelegate</code> and <code class="inlineCode">UITextViewDelegate</code> methods.</p>
    <p class="normal">In this chapter, you’ll learn how to <a id="_idIndexMarker738"/>get your device location using Apple’s <strong class="keyWord">Core Location</strong> framework, and how to set map regions, display map annotations, and create <a id="_idIndexMarker739"/>map snapshots using Apple’s <strong class="keyWord">MapKit</strong> framework. This will come in handy if you’re planning to build apps that use maps, such as <em class="italic">Apple Maps</em> or <em class="italic">Waze</em>.</p>
    <p class="normal">First, you’ll modify the Add New Journal Entry screen so that the user can add their current location to a new journal entry. Next, you’ll create a <code class="inlineCode">MapViewController</code> class (a view controller for the Map screen) and configure it to display a map region centered on your location. Then, you’ll update the <code class="inlineCode">JournalEntry</code> class to conform to the <strong class="keyWord">MKAnnotation</strong> protocol, which <a id="_idIndexMarker740"/>lets you add journal entries as map annotations to a map. After that, you’ll modify the <code class="inlineCode">MapViewController</code> class to display a pin for each journal entry within the map region that you set earlier. You’ll configure the pins to display callouts and configure buttons in the callouts to display the Journal Entry Detail screen when tapped. Finally, you’ll modify the <code class="inlineCode">JournalEntryViewController</code> class to display a map snapshot showing the location where the journal entry was made in the Journal Entry Detail screen.</p>
    <p class="normal">By the end of this chapter, you’ll have learned how to use Core Location to get your device location and how to use MapKit to specify a map region, add map annotation views to a map, and create map snapshots.</p>
    <p class="normal">The following topics will be covered in this chapter:</p>
    <ul>
      <li class="bulletList">Getting your device location using the Core Location framework</li>
      <li class="bulletList">Updating the <code class="inlineCode">JournalEntry</code> class to conform to the <code class="inlineCode">MKAnnotation</code> protocol</li>
      <li class="bulletList">Displaying annotation views on the Map screen</li>
      <li class="bulletList">Displaying a map snapshot on the Journal Entry Detail screen</li>
    </ul>
    <h1 id="_idParaDest-234" class="heading-1">Technical requirements</h1>
    <p class="normal">You will continue working on the <code class="inlineCode">JRNL</code> project that you modified in the previous chapter.</p>
    <p class="normal">The resource files and completed Xcode project for this chapter are in the <code class="inlineCode">Chapter17</code> folder of the code bundle for this book, which can be downloaded here:</p>
    <p class="normal"><a href="https://github.com/PacktPublishing/iOS-18-Programming-for-Beginners-Ninth-Edition%0D"><span class="url">https://github.com/PacktPublishing/iOS-18-Programming-for-Beginners-Ninth-Edition</span></a></p>
    <p class="normal">Check out the following video to see the code in action:</p>
    <p class="normal"><a href="https://youtu.be/6WE5Ed6jIWk%0D"><span class="url">https://youtu.be/6WE5Ed6jIWk</span></a></p>
    <p class="normal">In the next section, you’ll learn how the Core Location framework is used to get your device location.</p>
    <h1 id="_idParaDest-235" class="heading-1">Getting your device location using the Core Location framework</h1>
    <p class="normal">Every iPhone <a id="_idIndexMarker741"/>has multiple <a id="_idIndexMarker742"/>means of determining its location, including Wi-Fi, GPS, Bluetooth, magnetometer, barometer, and cellular hardware. Apple created the Core Location framework to gather location data using all available components on an iOS device.</p>
    <div class="note">
      <p class="normal">To learn <a id="_idIndexMarker743"/>more about Core Location, see <a href="https://developer.apple.com/documentation/corelocation"><span class="url">https://developer.apple.com/documentation/corelocation</span></a>.</p>
    </div>
    <p class="normal">To configure your app to use Core Location, you will need to create an instance of <code class="inlineCode">CLLocationManager</code>, which is used to configure, start, and stop location services. Next, you will create an instance of <code class="inlineCode">CLLocationUpdate</code>, a structure that contains location information delivered by the Core Location framework. Calling the <code class="inlineCode">CLLocationUpdate</code> type’s <code class="inlineCode">liveUpdates</code> method tells Core Location to start delivering location updates containing the user’s location, authorization status, and location availability.</p>
    <div class="note">
      <p class="normal">To learn <a id="_idIndexMarker744"/>more about the <code class="inlineCode">CLLocationManager</code> class, see <a href="https://developer.apple.com/documentation/corelocation/configuring_your_app_to_use_location_services"><span class="url">https://developer.apple.com/documentation/corelocation/configuring_your_app_to_use_location_services</span></a>.</p>
      <p class="normal">You can watch Apple’s WWDC 2023 video on streamlined location updates here: <a href="https://developer.apple.com/videos/play/wwdc2023/10180/"><span class="url">https://developer.apple.com/videos/play/wwdc2023/10180/</span></a>.</p>
    </div>
    <p class="normal">Since <a id="_idIndexMarker745"/>location information <a id="_idIndexMarker746"/>is considered sensitive user data, you’ll also need to obtain authorization to use location services. You can also check the authorization status of location updates delivered by the <code class="inlineCode">CLLocationUpdate</code> type’s <code class="inlineCode">liveUpdates</code> method. </p>
    <div class="note">
      <p class="normal">To learn <a id="_idIndexMarker747"/>more about requesting authorization to use location services, see <a href="https://developer.apple.com/documentation/corelocation/requesting_authorization_to_use_location_services"><span class="url">https://developer.apple.com/documentation/corelocation/requesting_authorization_to_use_location_services</span></a>.</p>
      <p class="normal">You can watch Apple’s WWDC 2024 video on <em class="italic">What’s new in location authorization</em> here: <a href="https://developer.apple.com/videos/play/wwdc2024/10212/"><span class="url">https://developer.apple.com/videos/play/wwdc2024/10212/</span></a>.</p>
    </div>
    <p class="normal">In the next section, you’ll modify the <code class="inlineCode">AddJournalEntryViewController</code> class so that the user can assign a location when they create a new journal entry.</p>
    <h2 id="_idParaDest-236" class="heading-2">Modifying the AddJournalEntryViewController class</h2>
    <p class="normal">At <a id="_idIndexMarker748"/>present, the Add New Journal Entry screen has a <strong class="screenText">Get Location</strong> switch, but it doesn’t do anything yet. You’ll add an outlet to the <code class="inlineCode">AddJournalEntryViewController</code> class for this switch and modify it to add your location to the <code class="inlineCode">JournalEntry</code> instance when the switch is on. Follow these steps:</p>
    <ol>
      <li class="numberedList" value="1">In the Project navigator, click the <code class="inlineCode">AddJournalEntryViewController</code> file. In this file, add an <code class="inlineCode">import</code> statement after the <code class="inlineCode">import UIKit</code> statement to import the Core Location framework:
        <pre class="programlisting code-one"><code class="hljs-code"><span class="hljs-keyword">import</span> UIKit
<span class="code-highlight"><strong class="hljs-keyword-slc">import</strong><strong class="hljs-slc"> CoreLocation</strong></span>
</code></pre>
      </li>
      <li class="numberedList">Add an extension for the <code class="inlineCode">AddJournalEntryViewController</code> class after all other code in the file:
        <pre class="programlisting code-one"><code class="hljs-code"><span class="hljs-keyword">extension </span><span class="hljs-title">AddJournalEntryViewController </span>{
<span class="hljs-comment">  // MARK: - CoreLocation</span>
}
</code></pre>
      </li>
    </ol>
    <p class="normal-one">You’ll implement code to ask for permission to use the user’s private data and to determine the user’s location in this extension later. </p>
    <ol>
      <li class="numberedList" value="3">Add <a id="_idIndexMarker749"/>outlets for the Get Location switch and the label next to it after all the other outlets in the <code class="inlineCode">AddJournalEntryViewController</code> class:
        <pre class="programlisting code-one"><code class="hljs-code"><span class="hljs-keyword">@IBOutlet</span> <span class="hljs-keyword">var</span> <span class="hljs-template-variable">photoImageView</span>: <span class="hljs-type">UIImageView</span>!
<span class="hljs-keyword">@IBOutlet</span> <span class="hljs-keyword">var</span> <span class="hljs-template-variable">saveButton</span>: <span class="hljs-type">UIBarButtonItem</span>!
<span class="code-highlight"><strong class="hljs-keyword-slc">@IBOutlet</strong><strong class="hljs-slc"> </strong><strong class="hljs-keyword-slc">var</strong><strong class="hljs-slc"> </strong><strong class="hljs-template-variable-slc">getLocationSwitch</strong><strong class="hljs-slc">: </strong><strong class="hljs-type-slc">UISwitch</strong><strong class="hljs-slc">!</strong></span>
<span class="code-highlight"><strong class="hljs-keyword-slc">@IBOutlet</strong><strong class="hljs-slc"> </strong><strong class="hljs-keyword-slc">var</strong><strong class="hljs-slc"> </strong><strong class="hljs-template-variable-slc">getLocationSwitchLabel</strong><strong class="hljs-slc">: </strong><strong class="hljs-type-slc">UILabel</strong><strong class="hljs-slc">!</strong></span>
<span class="hljs-keyword">var</span> <span class="hljs-template-variable">newJournalEntry</span>: <span class="hljs-con-class">JournalEntry</span>?
</code></pre>
      </li>
      <li class="numberedList">Add properties to store an instance of the <code class="inlineCode">CLLocationManager</code> class, an asynchronous task that will manage location updates, and the current device location after all other property declarations:
        <pre class="programlisting code-one"><code class="hljs-code"><span class="hljs-keyword">var</span> <span class="hljs-template-variable">newJournalEntry</span>: <span class="hljs-con-class">JournalEntry</span>?
<span class="code-highlight"><strong class="hljs-keyword-slc">private let</strong><strong class="hljs-slc"> </strong><strong class="hljs-template-variable-slc">locationManager</strong><strong class="hljs-slc"> </strong><strong class="hljs-operator-slc">=</strong><strong class="hljs-slc"> </strong><strong class="hljs-type-slc">CLLocationManager</strong><strong class="hljs-slc">()</strong></span>
<span class="code-highlight"><strong class="hljs-keyword-slc">private var </strong><strong class="hljs-template-variable-slc">locationTask</strong><strong class="hljs-slc"> </strong><strong class="hljs-operator-slc">=</strong><strong class="hljs-slc"> </strong><strong class="hljs-type-slc">Task</strong><strong class="hljs-slc">&lt;</strong><strong class="hljs-type-slc">Void</strong><strong class="hljs-slc">, </strong><strong class="hljs-type-slc">Error</strong><strong class="hljs-slc">&gt;?</strong></span>
<span class="code-highlight"><strong class="hljs-keyword-slc">private var</strong><strong class="hljs-slc"> </strong><strong class="hljs-template-variable-slc">currentLocation</strong><strong class="hljs-slc">: </strong><strong class="hljs-type-slc">CLLocation</strong><strong class="hljs-slc">?</strong></span>
</code></pre>
      </li>
    </ol>
    <p class="normal-one">All these properties are <code class="inlineCode">private</code> as they will only be used within this class.</p>
    <ol>
      <li class="numberedList" value="5">Implement a method to determine the user’s location in the <code class="inlineCode">AddJournalEntryViewController</code> extension before the closing curly brace:
        <pre class="programlisting code-one"><code class="hljs-code"><span class="hljs-keyword">private func</span> <span class="hljs-template-variable">fetchUserLocation</span>() {
  <span class="hljs-variable">locationManager</span>.<span class="hljs-con-attribute">requestWhenInUseAuthorization</span>()
  <span class="hljs-keyword">self</span>.<span class="hljs-variable">locationTask</span> = <span class="hljs-type">Task</span> {
    <span class="hljs-keyword">for try await</span> update <span class="hljs-keyword">in</span> 
    <span class="hljs-type">CLLocationUpdate</span>.<span class="hljs-con-attribute">liveUpdates</span>() {
      <span class="hljs-keyword">if let</span> location = update.<span class="hljs-con-attribute">location</span>  {
        <span class="hljs-variable">updateCurrentLocation</span>(location)
      } <span class="hljs-keyword">else if</span> update.<span class="hljs-con-attribute">authorizationDenied</span> {
        <span class="hljs-variable">failedToGetLocation</span>(<span class="hljs-variable">message</span>: <span class="hljs-string">"Check Location </span>
<span class="hljs-string">        Services settings for JRNL in Settings &gt; Privacy </span>
<span class="hljs-string">        &amp; Security."</span>)
      } <span class="hljs-keyword">else if</span> update.<span class="hljs-con-attribute">locationUnavailable</span> {
        <span class="hljs-variable">failedToGetLocation</span>(<span class="hljs-variable">message</span>: <span class="hljs-string">"Location    </span>
<span class="hljs-string">        Unavailable"</span>)
      }
    }
  }
}
</code></pre>
      </li>
    </ol>
    <p class="normal-one">Let’s break this down:</p>
    <pre class="programlisting code-one"><code class="hljs-code"><span class="hljs-variable">locationManager</span>.<span class="hljs-con-attribute">requestWhenInUseAuthorization</span>()
</code></pre>
    <p class="normal-one">This statement asks the user for permission to use their location information.</p>
    <pre class="programlisting code-one"><code class="hljs-code"><span class="hljs-keyword">self</span>.<span class="hljs-variable">locationTask</span> = <span class="hljs-type">Task</span> {
</code></pre>
    <p class="normal-one">This <a id="_idIndexMarker750"/>statement assigns an asynchronous task that will continuously obtain location updates to the <code class="inlineCode">locationTask</code> property.</p>
    <pre class="programlisting code-one"><code class="hljs-code"><span class="hljs-keyword">for try await</span> update <span class="hljs-keyword">in</span> 
<span class="hljs-type">CLLocationUpdate</span>.<span class="hljs-con-attribute">liveUpdates</span>() {
</code></pre>
    <p class="normal-one">This statement gets the updates provided by <code class="inlineCode">CLLocation.liveUpdates()</code> and assigns each to an <code class="inlineCode">update</code> instance.</p>
    <pre class="programlisting code-one"><code class="hljs-code"><span class="hljs-keyword">if let</span> location = update.<span class="hljs-con-attribute">location</span>  {
  <span class="hljs-variable">updateCurrentLocation</span>(location)
}
</code></pre>
    <p class="normal-one">This statement gets the user location from the <code class="inlineCode">update</code> instance and calls the <code class="inlineCode">updateCurrentLocation</code> method.</p>
    <pre class="programlisting code-one"><code class="hljs-code"><span class="hljs-keyword">else if</span> update.<span class="hljs-con-attribute">authorizationDenied</span> {
<span class="hljs-variable">failedToGetLocation</span>(<span class="hljs-variable">message</span>: <span class="hljs-string">"Check Location </span>
<span class="hljs-string">Services settings for JRNL in Settings &gt; Privacy &amp; Security."</span>))}
</code></pre>
    <p class="normal-one">This statement will call the <code class="inlineCode">failedToGetLocation(message:)</code> method if the user did not give authorization to use their private data.</p>
    <pre class="programlisting code-one"><code class="hljs-code"><span class="hljs-keyword">else if</span> update.<span class="hljs-con-attribute">locationUnavailable</span> {
<span class="hljs-variable">failedToGetLocation</span>(<span class="hljs-variable">message</span>: <span class="hljs-string">"Location    </span>
<span class="hljs-string">Unavailable"</span>)
}
</code></pre>
    <p class="normal-one">This <a id="_idIndexMarker751"/>statement will call the <code class="inlineCode">failedToGetLocation(message:)</code> method if the user’s location is not available.</p>
    <p class="normal-one">You will see error messages because the methods called by <code class="inlineCode">fetchUserLocation()</code> have not been implemented yet.</p>
    <ol>
      <li class="numberedList" value="6">Before the closing curly brace of the <code class="inlineCode">AddJournalEntryViewController</code> extension, implement the <code class="inlineCode">updateCurrentLocation(_:)</code> method called by the <code class="inlineCode">fetchUserLocation(</code>) class:
        <pre class="programlisting code-one"><code class="hljs-code"><span class="hljs-keyword">private func</span><span class="hljs-template-variable"> updateCurrentLocation</span>(<span class="hljs-template-variable">_ </span>location:<span class="hljs-type"> CLLocation</span>) {
  <span class="hljs-keyword">let</span> interval = location.<span class="hljs-con-attribute">timestamp</span>.<span class="hljs-con-attribute">timeIntervalSinceNow</span>
  <span class="hljs-keyword">if</span> <span class="hljs-con-attribute">abs</span>(interval) &lt; <span class="hljs-number">30</span> {
    <span class="hljs-keyword">self</span>.<span class="hljs-variable">locationTask</span>?.<span class="hljs-con-attribute">cancel</span>()
    <span class="hljs-variable">getLocationSwitchLabel</span>.<span class="hljs-con-attribute">text</span> = <span class="hljs-string">"Done"</span>
    <span class="hljs-keyword">let</span> lat = location.<span class="hljs-con-attribute">coordinate</span>.<span class="hljs-con-attribute">latitude</span>
    <span class="hljs-keyword">let</span> long = location.<span class="hljs-con-attribute">coordinate</span>.<span class="hljs-con-attribute">longitude</span>
    <span class="hljs-variable">currentLocation</span> = CLLocation(<span class="hljs-con-attribute">latitude</span>: lat, 
    <span class="hljs-con-attribute">longitude</span>: long)
  }
}
</code></pre>
      </li>
    </ol>
    <p class="normal-one">This method first gets the timestamp of <code class="inlineCode">location</code>. This location may be an old, cached location, and not actually the current location, so the timestamp is compared with the current date and time. If the duration is less than 30 seconds, this indicates that the user’s location is current. In this case, the asynchronous task assigned to <code class="inlineCode">locationTask</code> is canceled, the Get Location switch label’s text is set to <code class="inlineCode">Done</code>, and the <code class="inlineCode">currentLocation</code> property is set to this location.</p>
    <ol>
      <li class="numberedList" value="7">Before the closing curly brace of the <code class="inlineCode">AddJournalEntryViewController</code> extension, implement the <code class="inlineCode">failedToGetLocation(message:)</code> method called by the <code class="inlineCode">fetchUserLocation(</code>) class:
        <pre class="programlisting code-one"><code class="hljs-code"><span class="hljs-keyword">private func</span> <span class="hljs-template-variable">failedToGetLocation</span>(<span class="hljs-template-variable">message</span>: <span class="hljs-type">String</span>) {
  s<span class="hljs-keyword">elf</span>.<span class="hljs-variable">locationTask</span>?.<span class="hljs-con-attribute">cancel</span>()
  <span class="hljs-variable">getLocationSwitch</span>.<span class="hljs-con-attribute">setOn</span>(<span class="hljs-keyword">false</span>, <span class="hljs-con-attribute">animated</span>: <span class="hljs-keyword">true</span>)
  <span class="hljs-variable">getLocationSwitchLabel</span>.<span class="hljs-con-attribute">text</span> = <span class="hljs-string">"Get location"</span>
  <span class="hljs-keyword">let</span> alertController = <span class="hljs-type">UIAlertController</span>(<span class="hljs-con-attribute">title</span>: 
  <span class="hljs-string">"Failed to get location"</span>, <span class="hljs-con-attribute">message</span>: message, 
  <span class="hljs-con-attribute">preferredStyle</span>: .<span class="hljs-con-attribute">alert</span>)
  <span class="hljs-keyword">let</span> okAction = <span class="hljs-type">UIAlertAction</span>(<span class="hljs-con-attribute">title</span>: <span class="hljs-string">"OK"</span>, <span class="hljs-con-attribute">style</span>: 
  .<span class="hljs-con-attribute">default</span>)
  alertController.<span class="hljs-con-attribute">addAction</span>(okAction)
  <span class="hljs-con-attribute">present</span>(alertController, <span class="hljs-con-attribute">animated</span>: <span class="hljs-keyword">true</span>)
} 
</code></pre>
      </li>
    </ol>
    <p class="normal-one">This <a id="_idIndexMarker752"/>method will cancel the asynchronous task assigned to <code class="inlineCode">locationTask</code>, reset the values of the Get Location switch and label to their initial values, and display an alert configured with an appropriate error message.</p>
    <ol>
      <li class="numberedList" value="8">In the <code class="inlineCode">AddJournalEntryViewController</code> class, implement an action to be performed when the Get Location switch’s value is changed before the closing curly brace:
        <pre class="programlisting code-one"><code class="hljs-code"><span class="hljs-comment">// MARK: - Actions</span>
<span class="hljs-keyword">@IBAction</span> <span class="hljs-keyword">func</span> <span class="hljs-template-variable">locationSwitchValueChanged</span>(<span class="hljs-template-variable">_</span> <span class="hljs-params">sender</span>: <span class="hljs-type">UISwitch</span>) {
  <span class="hljs-keyword">if</span> <span class="hljs-variable">getLocationSwitch</span>.<span class="hljs-con-attribute">isOn</span> {
    <span class="hljs-variable">getLocationSwitchLabel</span>.<span class="hljs-con-attribute">text</span> <span class="hljs-operator">=</span> <span class="hljs-string">"Getting location..."</span>
    <span class="hljs-variable">fetchUserLocation</span>()
  } <span class="hljs-keyword">else</span> {
    <span class="hljs-variable">currentLocation</span> <span class="hljs-operator">=</span> <span class="hljs-literal">nil</span>
    <span class="hljs-variable">getLocationSwitchLabel</span>.<span class="hljs-con-attribute">text</span> <span class="hljs-operator">=</span> <span class="hljs-string">"Get location"</span>
<span class="hljs-string">    </span><span class="hljs-keyword">self</span>.<span class="hljs-variable">locationTask</span>?.<span class="hljs-con-attribute">cancel</span>()
  }
}
</code></pre>
      </li>
    </ol>
    <p class="normal-one">If the Get Location switch is turned on, the switch label text is set to <code class="inlineCode">Getting location...</code> and the <code class="inlineCode">fetchUserLocation()</code> method is called. If the switch is turned off, <code class="inlineCode">currentLocation</code> will be set to <code class="inlineCode">nil</code>, the switch label text is reset to <code class="inlineCode">Get location</code>, and the asynchronous task assigned to <code class="inlineCode">locationTask</code> is canceled.</p>
    <ol>
      <li class="numberedList" value="9">Modify the <code class="inlineCode">prepare(for:sender:)</code> method to add location information to the <code class="inlineCode">JournalEntry</code> instance:
        <pre class="programlisting code-one"><code class="hljs-code"><span class="hljs-keyword">override</span> <span class="hljs-keyword">func</span> <span class="hljs-template-variable">prepare</span>(<span class="hljs-template-variable">for</span> <span class="hljs-params">segue</span>: <span class="hljs-type">UIStoryboardSegue</span>, <span class="hljs-params">sender</span>: <span class="hljs-keyword">Any</span><span class="hljs-operator">?</span>) {
  <span class="hljs-keyword">let</span> title <span class="hljs-operator">=</span> <span class="hljs-variable">titleTextField</span>.<span class="hljs-con-attribute">text</span> <span class="hljs-operator">??</span> <span class="hljs-string">""</span>
  <span class="hljs-keyword">let</span> body <span class="hljs-operator">=</span> <span class="hljs-variable">bodyTextView</span>.<span class="hljs-con-attribute">text</span> <span class="hljs-operator">??</span> <span class="hljs-string">""</span>
  <span class="hljs-keyword">let</span> photo <span class="hljs-operator">=</span> <span class="hljs-variable">photoImageView</span>.<span class="hljs-con-attribute">image</span>
  <span class="hljs-keyword">let</span> rating <span class="hljs-operator">=</span> <span class="hljs-number">3</span>
<span class="code-highlight"><strong class="hljs-slc">  </strong><strong class="hljs-keyword-slc">let</strong><strong class="hljs-slc"> lat </strong><strong class="hljs-operator-slc">=</strong><strong class="hljs-slc"> </strong><strong class="hljs-variable-slc">currentLocation</strong><strong class="hljs-operator-slc">?</strong><strong class="hljs-slc">.</strong><strong class="hljs-con-attribute-slc">coordinate</strong><strong class="hljs-slc">.</strong><strong class="hljs-con-attribute-slc">latitude</strong><strong class="hljs-slc"> </strong></span>
<span class="code-highlight"><strong class="hljs-slc">  </strong><strong class="hljs-keyword-slc">let</strong><strong class="hljs-slc"> long </strong><strong class="hljs-operator-slc">=</strong><strong class="hljs-slc"> </strong><strong class="hljs-variable-slc">currentLocation</strong><strong class="hljs-operator-slc">?</strong><strong class="hljs-slc">.</strong><strong class="hljs-con-attribute-slc">coordinate</strong><strong class="hljs-slc">.</strong><strong class="hljs-con-attribute-slc">longitude</strong></span>
  <span class="hljs-variable">newJournalEntry</span> <span class="hljs-operator">=</span> <span class="hljs-con-class">JournalEntry</span>(<span class="hljs-variable">rating</span>: rating, <span class="hljs-variable">title</span>: 
  title, <span class="hljs-variable">body</span>: body, <span class="hljs-variable">photo</span>: photo<span class="code-highlight"><strong class="hljs-slc">, </strong><strong class="hljs-variable-slc">latitude</strong><strong class="hljs-slc">: lat, </strong></span>
<span class="code-highlight"><strong class="hljs-slc">  </strong><strong class="hljs-variable-slc">longitude</strong><strong class="hljs-slc">: long</strong></span>)
}
</code></pre>
      </li>
      <li class="numberedList">Modify the <code class="inlineCode">updateSaveButtonState()</code> method to enable the <strong class="screenText">Save</strong> button only <a id="_idIndexMarker753"/>after the location has been found if the Get Location switch is on:
        <pre class="programlisting code-one"><code class="hljs-code"><span class="hljs-keyword">private</span> <span class="hljs-keyword">func</span> <span class="hljs-template-variable">updateSaveButtonState</span>() {
  <span class="hljs-keyword">let</span> textFieldText <span class="hljs-operator">=</span> <span class="hljs-variable">titleTextField</span>.<span class="hljs-con-attribute">text</span> <span class="hljs-operator">??</span> <span class="hljs-string">""</span>
  <span class="hljs-keyword">let</span> textViewText <span class="hljs-operator">=</span> <span class="hljs-variable">bodyTextView</span>.<span class="hljs-con-attribute">text</span> <span class="hljs-operator">??</span> <span class="hljs-string">""</span>
<span class="code-highlight"><strong class="hljs-slc">  </strong><strong class="hljs-keyword-slc">let</strong><strong class="hljs-slc"> textIsValid </strong><strong class="hljs-operator-slc">=</strong><strong class="hljs-slc"> </strong><strong class="hljs-operator-slc">!</strong><strong class="hljs-slc">textFieldText.</strong><strong class="hljs-con-attribute-slc">isEmpty</strong><strong class="hljs-slc"> </strong><strong class="hljs-operator-slc">&amp;&amp;</strong></span>
<span class="code-highlight"><strong class="hljs-slc">  </strong><strong class="hljs-operator-slc">!</strong><strong class="hljs-slc">textViewText.</strong><strong class="hljs-con-attribute-slc">isEmpty</strong></span>
<span class="code-highlight"><strong class="hljs-slc">  </strong><strong class="hljs-keyword-slc">if</strong><strong class="hljs-slc"> </strong><strong class="hljs-variable-slc">getLocationSwitch</strong><strong class="hljs-slc">.</strong><strong class="hljs-con-attribute-slc">isOn</strong><strong class="hljs-slc"> {</strong></span>
<span class="code-highlight"><strong class="hljs-slc">    </strong><strong class="hljs-variable-slc">saveButton</strong><strong class="hljs-slc">.</strong><strong class="hljs-con-attribute-slc">isEnabled</strong><strong class="hljs-slc"> </strong><strong class="hljs-operator-slc">=</strong><strong class="hljs-slc"> textIsValid </strong></span>
<span class="code-highlight"><strong class="hljs-slc">    </strong><strong class="hljs-operator-slc">&amp;&amp;</strong><strong class="hljs-slc"> </strong><strong class="hljs-variable-slc">currentLocation</strong><strong class="hljs-slc"> </strong><strong class="hljs-operator-slc">!=</strong><strong class="hljs-slc"> </strong><strong class="hljs-literal-slc">nil</strong></span>
<span class="code-highlight"><strong class="hljs-slc">  } </strong><strong class="hljs-keyword-slc">else</strong><strong class="hljs-slc"> {</strong></span>
<span class="code-highlight"><strong class="hljs-slc">    </strong><strong class="hljs-variable-slc">saveButton</strong><strong class="hljs-slc">.</strong><strong class="hljs-con-attribute-slc">isEnabled</strong><strong class="hljs-slc"> </strong><strong class="hljs-operator-slc">=</strong><strong class="hljs-slc"> textIsValid</strong></span>
<span class="code-highlight"><strong class="hljs-slc">  }</strong></span>
}
</code></pre>
      </li>
      <li class="numberedList">Call <code class="inlineCode">updateSaveButtonState()</code> in <code class="inlineCode">updateCurrentLocation(_:)</code> so that the <strong class="screenText">Save</strong> button state will be updated once the location has been found:
        <pre class="programlisting code-one"><code class="hljs-code">      <span class="hljs-variable">currentLocation</span> <span class="hljs-operator">=</span> <span class="hljs-type">CLLocation</span>(<span class="hljs-con-attribute">latitude</span>: lat,    
      <span class="hljs-con-attribute">Longitude</span>: long
      <span class="code-highlight"><strong class="hljs-variable-slc">updateSaveButtonState</strong><strong class="hljs-slc">()</strong></span>
  }
}
</code></pre>
      </li>
      <li class="numberedList">In the Project navigator, click the <code class="inlineCode">Main</code> storyboard file. Click <strong class="screenText">New Entry Scene</strong> in the document outline.</li>
      <li class="numberedList">Most journal entries will probably not require a location, so you will set the default value for the Get Location switch to <strong class="screenText">off</strong>. Click the Get Location switch <a id="_idIndexMarker754"/>and click the Attributes inspector button. Under <strong class="screenText">Switch</strong>, set <strong class="screenText">State</strong> to <strong class="screenText">Off</strong>:</li>
    </ol>
    <figure class="mediaobject"><img src="image/B31371_17_01.png" alt="" width="755" height="317"/></figure>
    <p class="packt_figref">Figure 17.1: Attributes inspector showing the Get Location switch state set to Off</p>
    <ol>
      <li class="numberedList" value="14">Click <strong class="screenText">New Entry Scene</strong> in the document outline and click the Connections inspector button. Connect the <strong class="screenText">getLocationSwitch</strong> outlet to the Get Location switch in <strong class="screenText">New Entry Scene</strong>:</li>
    </ol>
    <figure class="mediaobject"><img src="image/B31371_17_02.png" alt="" width="779" height="274"/></figure>
    <p class="packt_figref">Figure 17.2: Connections inspector showing the getLocationSwitch outlet</p>
    <ol>
      <li class="numberedList" value="15">Connect the <strong class="screenText">getLocationSwitchLabel </strong>outlet to the label next to the Get Location <a id="_idIndexMarker755"/>switch in <strong class="screenText">New Entry Scene</strong>:</li>
    </ol>
    <figure class="mediaobject"><img src="image/B31371_17_03.png" alt="" width="812" height="193"/></figure>
    <p class="packt_figref">Figure 17.3: Connections inspector showing the getLocationSwitchLabel outlet</p>
    <ol>
      <li class="numberedList" value="16">Connect the <strong class="screenText">locationSwitchValueChanged</strong> action to the Get Location switch, and choose <strong class="screenText">Value Changed</strong> from the pop-up menu:</li>
    </ol>
    <figure class="mediaobject"><img src="image/B31371_17_04.png" alt="" width="812" height="532"/></figure>
    <p class="packt_figref">Figure 17.4: Attributes inspector showing the getLocationSwitchValueChanged outlet</p>
    <p class="normal">You <a id="_idIndexMarker756"/>have completed modifying the <code class="inlineCode">AddJournalEntryViewController</code> class. In the next section, you’ll learn how to configure your app to access user data.</p>
    <h2 id="_idParaDest-237" class="heading-2">Modifying the Info.plist file</h2>
    <p class="normal">Since your <a id="_idIndexMarker757"/>app uses user data, you will need to ask the user for permission to use it. To do so, you will add a new setting to your app’s <code class="inlineCode">Info.plist</code> file. Follow these steps:</p>
    <ol>
      <li class="numberedList" value="1">In the Project navigator, click the <code class="inlineCode">Info.plist</code> file. If you move your pointer over the <strong class="screenText">Information Property List</strong> row, you’ll see a small <strong class="screenText">+</strong> button. Click it to create a new row:</li>
    </ol>
    <figure class="mediaobject"><img src="image/B31371_17_05.png" alt="" width="792" height="107"/></figure>
    <p class="packt_figref">Figure 17.5: Editor area showing contents of Info.plist</p>
    <ol>
      <li class="numberedList" value="2">In the <a id="_idIndexMarker758"/>new row, set the <strong class="screenText">Key</strong> to <strong class="screenText">Privacy - Location When In Use Usage Description</strong> and set the <strong class="screenText">Value</strong> to <code class="inlineCode">This app uses your location for journal entries</code>. Your <code class="inlineCode">Info.plist</code> file should look like the following when you’re done:</li>
    </ol>
    <figure class="mediaobject"><img src="image/B31371_17_06.png" alt="" width="812" height="102"/></figure>
    <p class="packt_figref">Figure 17.6: Info.plist with a new row added</p>
    <ol>
      <li class="numberedList" value="3">Launch Simulator and choose <strong class="screenText">Location</strong> | <strong class="screenText">Apple</strong> from Simulator’s <strong class="screenText">Features</strong> menu to simulate a location:</li>
    </ol>
    <figure class="mediaobject"><img src="image/B31371_17_07.png" alt="" width="635" height="622"/></figure>
    <p class="packt_figref">Figure 17.7: Location | Apple selected from Simulator’s Features menu</p>
    <ol>
      <li class="numberedList" value="4">Build and <a id="_idIndexMarker759"/>run your app and click the <strong class="screenText">+</strong> button to display the Add New Journal Entry screen. When prompted, tap the <strong class="screenText">Allow While Using App</strong> button:</li>
    </ol>
    <figure class="mediaobject"><img src="image/B31371_17_08.png" alt="" width="318" height="296"/></figure>
    <p class="packt_figref">Figure 17.8: Alert showing Allow While Using App highlighted</p>
    <p class="normal-one">Note that <a id="_idIndexMarker760"/>this alert will appear the first time you launch your app during this chapter, and the setting you picked will be used by default during subsequent launches.</p>
    <ol>
      <li class="numberedList" value="5">Enter the journal entry title and body, and set the Get Location switch to on:</li>
    </ol>
    <figure class="mediaobject"><img src="image/B31371_17_09.png" alt="" width="494" height="389"/></figure>
    <p class="packt_figref">Figure 17.9: Add New Journal Entry screen showing the Get Location switch</p>
    <p class="normal-one">Once the location has been determined, the label next to the Get Location switch will display <strong class="screenText">Done</strong>, and the <strong class="screenText">Save</strong> button will be active.</p>
    <ol>
      <li class="numberedList" value="6">Click <strong class="screenText">Save</strong>. You will be returned to the Journal List screen.</li>
    </ol>
    <p class="normal">At this point, the Get Location switch and the label next to it have been connected to outlets <a id="_idIndexMarker761"/>in the <code class="inlineCode">AddJournalEntryViewController</code> class, the method for getting the device location has been assigned to the Get Location switch, and all the code required to add your location to the new <code class="inlineCode">JournalEntry</code> instance has been added. Great!</p>
    <p class="normal">In the next section, you’ll create a view controller for the Map screen and configure it to display your current device location.</p>
    <h2 id="_idParaDest-238" class="heading-2">Creating the MapViewController class</h2>
    <p class="normal">In <em class="chapterRef">Chapter 12</em>, <em class="italic">Finishing Up Your User Interface</em>, you added a map view to the Map screen. A map <a id="_idIndexMarker762"/>view is an instance of the <code class="inlineCode">MKMapView</code> class. You can see what it looks like in the Apple Maps app.</p>
    <div class="note">
      <p class="normal">To learn <a id="_idIndexMarker763"/>more about <code class="inlineCode">MKMapView</code>, see <a href="https://developer.apple.com/documentation/mapkit/mkmapview"><span class="url">https://developer.apple.com/documentation/mapkit/mkmapview</span></a>.</p>
    </div>
    <p class="normal">When you build and run your app, you will see a map on the screen. The part of the map that is visible onscreen can be specified by setting the map view’s <code class="inlineCode">region</code> property.</p>
    <div class="note">
      <p class="normal">To learn more about regions and how to make them, see <a href="https://developer.apple.com/documentation/mapkit/mkmapview/1452709-region"><span class="url">https://developer.apple.com/documentation/mapkit/mkmapview/1452709-region</span></a>.</p>
    </div>
    <p class="normal">You’ll <a id="_idIndexMarker764"/>create a new class, <code class="inlineCode">MapViewController</code>, to be the view controller for the Map screen, and you’ll use Core Location to determine the center point of the map region that will be displayed. Follow these steps:</p>
    <ol>
      <li class="numberedList" value="1">Create a new group inside your project by right-clicking the <strong class="screenText">JRNL</strong> group and choosing <strong class="screenText">New Group</strong>. Name this group <code class="inlineCode">Map Screen</code> and move it so it is below the <strong class="screenText">Journal Entry Detail Screen</strong> group.</li>
      <li class="numberedList">Right-click on the <strong class="screenText">Map Screen</strong> group and select <strong class="screenText">New File From Template...</strong>.</li>
      <li class="numberedList"><strong class="screenText">iOS</strong> should already be selected. Choose <strong class="screenText">Cocoa Touch Class</strong> and click <strong class="screenText">Next</strong>.</li>
      <li class="numberedList">Configure the class with the following details:<ul>
          <li class="bulletList level-2"><strong class="screenText">Class</strong>: <code class="inlineCode">MapViewController</code></li>
          <li class="bulletList level-2"><strong class="screenText">Subclass</strong>: <code class="inlineCode">UIViewController</code></li>
          <li class="bulletList level-2"><strong class="screenText">Also create XIB</strong>: Unchecked</li>
          <li class="bulletList level-2"><strong class="screenText">Language</strong>: <strong class="screenText">Swift</strong></li>
        </ul>
      </li>
    </ol>
    <p class="normal-one">Click <strong class="screenText">Next</strong> when you’re done.</p>
    <ol>
      <li class="numberedList" value="5">Click <strong class="screenText">Create</strong>. The <code class="inlineCode">MapViewController</code> file appears in the Project navigator, and its contents appear in the Editor area.</li>
      <li class="numberedList">Add code to import the <code class="inlineCode">Core Location</code> and <code class="inlineCode">MapKit</code> frameworks after the existing <code class="inlineCode">import</code> statement:
        <pre class="programlisting code-one"><code class="hljs-code"><span class="hljs-keyword">import</span> UIKit
<span class="code-highlight"><strong class="hljs-keyword-slc">import</strong><strong class="hljs-slc"> CoreLocation</strong></span>
<span class="code-highlight"><strong class="hljs-keyword-slc">import</strong><strong class="hljs-slc"> MapKit</strong></span>
</code></pre>
      </li>
      <li class="numberedList">Add a new extension for the <code class="inlineCode">MapViewController</code> class after all other code in the file:
        <pre class="programlisting code-one"><code class="hljs-code"><span class="hljs-keyword">extension</span> <span class="hljs-title">MapViewController {</span>
<span class="hljs-comment">// MARK: - CoreLocation</span>
}
</code></pre>
      </li>
    </ol>
    <p class="normal-one">You’ll implement code to ask for permission to use the user’s private data and to determine the user’s location in this extension later.</p>
    <ol>
      <li class="numberedList" value="8">In the <code class="inlineCode">MapViewController</code> class, add an outlet for the map view after the opening curly brace:
        <pre class="programlisting code-one"><code class="hljs-code"><span class="hljs-comment">// MARK: - Properties</span>
<span class="hljs-keyword">@IBOutlet</span> <span class="hljs-keyword">var</span> <span class="hljs-template-variable">mapView</span>: <span class="hljs-type">MKMapView</span>!
</code></pre>
      </li>
      <li class="numberedList">Add <a id="_idIndexMarker765"/>properties to hold a <code class="inlineCode">CLLocationManager</code> instance and an asynchronous task after the <code class="inlineCode">mapView </code>property:
        <pre class="programlisting code-one"><code class="hljs-code"><span class="hljs-keyword">@IBOutlet</span> <span class="hljs-keyword">var</span> <span class="hljs-template-variable">mapView</span>: <span class="hljs-type">MKMapView</span>!
<span class="code-highlight"><strong class="hljs-keyword-slc">private let</strong><strong class="hljs-slc"> </strong><strong class="hljs-template-variable-slc">locationManager</strong><strong class="hljs-slc"> </strong><strong class="hljs-operator-slc">=</strong><strong class="hljs-slc"> </strong><strong class="hljs-type-slc">CLLocationManager</strong><strong class="hljs-slc">()</strong></span>
<span class="code-highlight"><strong class="hljs-keyword-slc">private var </strong><strong class="hljs-template-variable-slc">locationTask</strong><strong class="hljs-slc"> </strong><strong class="hljs-operator-slc">=</strong><strong class="hljs-slc"> </strong><strong class="hljs-type-slc">Task</strong><strong class="hljs-slc">&lt;</strong><strong class="hljs-type-slc">Void</strong><strong class="hljs-slc">, </strong><strong class="hljs-type-slc">Error</strong><strong class="hljs-slc">&gt;?</strong></span>
</code></pre>
      </li>
      <li class="numberedList">Implement a method to determine the user’s location in the <code class="inlineCode">MapViewController</code> extension before the closing curly brace:
        <pre class="programlisting code-one"><code class="hljs-code"><span class="hljs-keyword">private func</span> <span class="hljs-template-variable">fetchUserLocation</span>() {
  <span class="hljs-variable">locationManager</span>.<span class="hljs-con-attribute">requestWhenInUseAuthorization</span>()
  <span class="hljs-keyword">self</span>.<span class="hljs-con-attribute">navigationItem</span>.<span class="hljs-con-attribute">title</span> = <span class="hljs-string">"Getting location..."</span>
  <span class="hljs-keyword">self</span>.<span class="hljs-variable">locationTask</span> = <span class="hljs-type">Task</span> {
    <span class="hljs-keyword">for</span> <span class="hljs-keyword">try await</span> update <span class="hljs-keyword">in</span> <span class="hljs-type">CLLocationUpdate</span>.<span class="hljs-con-attribute">liveUpdates</span>() {
      <span class="hljs-keyword">if</span> <span class="hljs-keyword">let</span> location = update.<span class="hljs-con-attribute">location</span>  {
        <span class="hljs-variable">updateMapWithLocation</span>(location)
      } e<span class="hljs-keyword">lse if</span> update.<span class="hljs-con-attribute">authorizationDenied</span> {
        <span class="hljs-variable">failedToGetLocation</span>(<span class="hljs-variable">message</span>: <span class="hljs-string">"Check Location Services</span>
<span class="hljs-string">        settings for JRNL in Settings &gt; Privacy &amp; Security."</span>)
      } <span class="hljs-keyword">else if</span> update.<span class="hljs-con-attribute">locationUnavailable</span> {
        <span class="hljs-variable">failedToGetLocation</span>(<span class="hljs-variable">message</span>: <span class="hljs-string">"Location Unavailable"</span>)
      }
    }
  }
}
</code></pre>
      </li>
    </ol>
    <p class="normal-one">This method is similar to the <code class="inlineCode">fetchUserLocation()</code> method you implemented in the <code class="inlineCode">AddJournalEntryViewController</code> extension. First, it will ask for permission to use private user data and set the title of the Map screen to <code class="inlineCode">Getting location...</code>. Next, an asynchronous task to continuously determine the user’s location will be assigned to <code class="inlineCode">locationTask</code>, and if the user’s location is found, the map will be updated to show the user’s location. Otherwise, an alert with an appropriate error message will be displayed. </p>
    <p class="normal-one">Note that since the methods called by <code class="inlineCode">fetchUserLocation()</code> have not been implemented yet, you will see error messages.</p>
    <ol>
      <li class="numberedList" value="11">Implement <a id="_idIndexMarker766"/>the missing methods in the <code class="inlineCode">MapViewController</code> extension before the closing curly brace:
        <pre class="programlisting code-one"><code class="hljs-code"><span class="hljs-keyword">private func</span> <span class="hljs-template-variable">updateMapWithLocation</span>(<span class="hljs-template-variable">_</span> location: <span class="hljs-type">CLLocation</span>) {
  <span class="hljs-keyword">let</span> interval = location.<span class="hljs-con-attribute">timestamp</span>.<span class="hljs-con-attribute">timeIntervalSinceNow</span>
  <span class="hljs-keyword">if</span> <span class="hljs-con-attribute">abs</span>(interval) &lt; <span class="hljs-number">30</span> {
    <span class="hljs-keyword">self</span>.<span class="hljs-variable">locationTask</span>?.<span class="hljs-con-attribute">cancel</span>()
    <span class="hljs-keyword">le</span><span class="hljs-keyword">t</span> lat = location.<span class="hljs-con-attribute">coordinate</span>.<span class="hljs-con-attribute">latitude</span>
    <span class="hljs-keyword">let</span> long = location.<span class="hljs-con-attribute">coordinate</span>.<span class="hljs-con-attribute">longitude</span>
    <span class="hljs-con-attribute">navigationItem</span>.<span class="hljs-con-attribute">title</span> = <span class="hljs-string">"Map"</span>
    <span class="hljs-variable">mapView</span>.<span class="hljs-con-attribute">region</span> = <span class="hljs-type">MKCoordinateRegion</span>(<span class="hljs-con-attribute">center</span>: 
    <span class="hljs-type">CLLocationCoordinate2D</span>(<span class="hljs-con-attribute">latitude</span>: lat, 
    <span class="hljs-con-attribute">longitude</span>: long), <span class="hljs-con-attribute">span</span>: <span class="hljs-type">MKCoordinateSpan</span>(
    <span class="hljs-con-attribute">latitudeDelta</span>: <span class="hljs-number">0.01</span>, <span class="hljs-con-attribute">longitudeDelta</span>: <span class="hljs-number">0.01</span>))
  }
}
<span class="hljs-keyword">private func</span> <span class="hljs-template-variable">failedToGetLocatio</span><span class="hljs-template-variable">n</span>(<span class="hljs-template-variable">message</span>: <span class="hljs-type">String</span>) {
 <span class="hljs-keyword"> self</span>.<span class="hljs-variable">locationTask</span>?.<span class="hljs-con-attribute">cancel</span>()
  <span class="hljs-con-attribute">navigationItem</span>.<span class="hljs-con-attribute">title</span> = <span class="hljs-string">"Location not found"</span>
  <span class="hljs-keyword">let</span> alertController = <span class="hljs-type">UIAlertController</span><span class="hljs-con-attribute">(title</span>: 
  <span class="hljs-string">"Failed to get location"</span>, <span class="hljs-con-attribute">message</span>: message, 
  <span class="hljs-con-attribute">preferredStyle</span>: .<span class="hljs-con-attribute">alert</span>)
  <span class="hljs-keyword">let</span> okAction = <span class="hljs-type">UIAlertAction</span>(<span class="hljs-con-attribute">title</span>: <span class="hljs-string">"OK"</span>, 
  <span class="hljs-con-attribute">style</span>: .default)
  alertController.<span class="hljs-con-attribute">addAction</span>(okAction)
  <span class="hljs-con-attribute">present</span>(alertController, <span class="hljs-con-attribute">animated</span>: <span class="hljs-keyword">true</span>)
}
</code></pre>
      </li>
    </ol>
    <p class="normal-one">These methods are similar to the <code class="inlineCode">updateCurrentLocation(location:)</code> and <code class="inlineCode">failedToGetLocation(message:)</code> methods you implemented earlier in the <code class="inlineCode">AddJournalEntryViewControlle</code>r extension. </p>
    <p class="normal-one">The <code class="inlineCode">updateMapWithLocation(location:)</code> method will set the title of the Map screen to <code class="inlineCode">Map</code>, create a map region centered on the user’s location, and assign it as the region for the <code class="inlineCode">mapView</code> property.</p>
    <p class="normal-one">The <code class="inlineCode">failedToGetLocation(message:)</code> method will set the title of the Map screen to <code class="inlineCode">Location not found</code> and display an appropriate error message if permission to use user data was denied or if the location is unavailable.</p>
    <ol>
      <li class="numberedList" value="12">Modify <a id="_idIndexMarker767"/>the <code class="inlineCode">viewDidLoad()</code> method for the <code class="inlineCode">MapViewController</code> class to call <code class="inlineCode">fetchUserLocation()</code> as shown:
        <pre class="programlisting code-one"><code class="hljs-code"><span class="hljs-keyword">override</span> <span class="hljs-keyword">func</span> <span class="hljs-template-variable">viewDidLoad</span>() {
  <span class="hljs-keyword">super</span>.<span class="hljs-con-attribute">viewDidLoad</span>()
<span class="code-highlight"><strong class="hljs-slc">  </strong><strong class="hljs-variable-slc">fetchUserLocation</strong><strong class="hljs-slc">()</strong></span>
}
</code></pre>
      </li>
      <li class="numberedList">Click the <code class="inlineCode">Main</code> storyboard file in the Project navigator and click the first <strong class="screenText">Map Scene</strong> in the document outline. Click the Identity inspector button, and under <strong class="screenText">Custom Class</strong>, set <strong class="screenText">Class</strong> to <code class="inlineCode">MapViewController</code>:</li>
    </ol>
    <figure class="mediaobject"><img src="image/B31371_17_10.png" alt="" width="812" height="251"/></figure>
    <p class="packt_figref">Figure 17.10: Identity inspector settings for Map scene</p>
    <ol>
      <li class="numberedList" value="14">Click the Connections inspector to display all the outlets for <strong class="screenText">Map Scene</strong>. Drag from the <strong class="screenText">mapView</strong> outlet to the map view in <strong class="screenText">Map Scene</strong>:</li>
    </ol>
    <figure class="mediaobject"><img src="image/B31371_17_11.png" alt="" width="812" height="347"/></figure>
    <p class="packt_figref">Figure 17.11: Connections inspector showing the mapView outlet</p>
    <div class="packt_tip-one">
      <p class="normal">Remember that if you make a mistake, you can click the <strong class="screenText">x</strong> to break the connection and drag from the outlet to the UI element once more.</p>
    </div>
    <ol>
      <li class="numberedList" value="15">Build <a id="_idIndexMarker768"/>and run your app, and verify that <strong class="screenText">Apple</strong> is selected from Simulator’s <strong class="screenText">Features</strong> | <strong class="screenText">Location</strong> menu. Tap the <strong class="screenText">Map</strong> tab button to display a map region centered on the location you selected, which, in this case, is the Apple campus:</li>
    </ol>
    <figure class="mediaobject"><img src="image/B31371_17_12.png" alt="" width="436" height="776"/></figure>
    <p class="packt_figref">Figure 17.12: Simulator showing a map centered on your location</p>
    <div class="packt_tip">
      <p class="normal">You <a id="_idIndexMarker769"/>can simulate any location in Simulator by choosing <strong class="screenText">Features</strong> | <strong class="screenText">Location</strong> | <strong class="screenText">Custom Location</strong> and entering the longitude and latitude of the desired location.</p>
    </div>
    <div class="note">
      <p class="normal">Since <code class="inlineCode">viewDidLoad()</code> is only <a id="_idIndexMarker770"/>called once when the <code class="inlineCode">MapViewController</code> instance loads its view, the map will not be updated if the user’s location changes after it was initially set. Also, you’ll notice that it takes a long time for the location to be determined if you’re running the app on an actual iOS device. You’ll address both of these issues in the next chapter.</p>
    </div>
    <p class="normal">You have successfully created a new view controller for the Map screen and configured it to <a id="_idIndexMarker771"/>display a map region centered on your device location. Excellent! In the next section, you’ll learn about the <code class="inlineCode">MKAnnotation</code> protocol, and how to make a class conform to it.</p>
    <h1 id="_idParaDest-239" class="heading-1">Updating the JournalEntry class to conform to the MKAnnotation protocol</h1>
    <p class="normal">When <a id="_idIndexMarker772"/>you use the <em class="italic">Maps</em> app on iPhone, you can tap and hold on the map to drop a pin:</p>
    <figure class="mediaobject"><img src="image/B31371_17_13.png" alt="" width="389" height="701"/></figure>
    <p class="packt_figref">Figure 17.13: Maps app showing a dropped pin</p>
    <p class="normal">To <a id="_idIndexMarker773"/>add a pin to a map view for your own apps, you need a class that conforms to the <code class="inlineCode">MKAnnotation</code> protocol. This protocol allows you to associate an instance of that class with a specific location.</p>
    <div class="note">
      <p class="normal">To learn <a id="_idIndexMarker774"/>more about the <code class="inlineCode">MKAnnotation</code> protocol, see <a href="https://developer.apple.com/documentation/mapkit/mkannotation"><span class="url">https://developer.apple.com/documentation/mapkit/mkannotation</span></a>.</p>
    </div>
    <p class="normal">Any class can adopt the <code class="inlineCode">MKAnnotation</code> protocol by implementing a <code class="inlineCode">coordinate</code> property, which contains a location. Optional <code class="inlineCode">MKAnnotation</code> protocol properties are <code class="inlineCode">title</code>, a string containing the annotation’s title, and <code class="inlineCode">subtitle</code>, a string containing the annotation’s subtitle.</p>
    <p class="normal">When an instance of a class conforming to the <code class="inlineCode">MKAnnotation</code> protocol is in the region of the map that is visible onscreen, the map view asks its delegate (usually a view controller) to provide a corresponding instance of the <code class="inlineCode">MKAnnotationView</code> class. This instance appears as a pin on the map.</p>
    <div class="note">
      <p class="normal">To learn <a id="_idIndexMarker775"/>more about <code class="inlineCode">MKAnnotationView</code>, see <a href="https://developer.apple.com/documentation/mapkit/mkannotationview"><span class="url">https://developer.apple.com/documentation/mapkit/mkannotationview</span></a>.</p>
    </div>
    <p class="normal">If the <a id="_idIndexMarker776"/>user scrolls the map and the <code class="inlineCode">MKAnnotationView</code> instance goes off screen, it will be put into a reuse queue and recycled later, like the way table view cells and collection view cells are recycled.</p>
    <p class="normal">To represent journal entry locations on the Map screen, you will modify the <code class="inlineCode">JournalEntry</code> class to make it conform to the <code class="inlineCode">MKAnnotation</code> protocol. This class will have a <code class="inlineCode">coordinate</code> property to store the journal entry’s location, a <code class="inlineCode">title</code> property to store the journal entry date, and a <code class="inlineCode">subtitle</code> property to store the journal entry title. You will use the <code class="inlineCode">JournalEntry</code> instance’s <code class="inlineCode">latitude</code> and <code class="inlineCode">longitude</code> properties to compute the value that will be assigned to the <code class="inlineCode">coordinate</code> property. Follow these steps:</p>
    <ol>
      <li class="numberedList" value="1">In the Project navigator, click the <code class="inlineCode">JournalEntry</code> file (inside the <strong class="screenText">Journal List Screen</strong> | <strong class="screenText">Model</strong> group). Type the following after the <code class="inlineCode">import UIKit</code> statement to import the <code class="inlineCode">MapKit</code> framework:
        <pre class="programlisting code-one"><code class="hljs-code"><span class="hljs-keyword">import</span> UIKit
<span class="code-highlight"><strong class="hljs-keyword-slc">import</strong><strong class="hljs-slc"> MapKit</strong></span>
</code></pre>
      </li>
    </ol>
    <p class="normal-one">This lets you use the <code class="inlineCode">MKAnnotation</code> protocol in your code.</p>
    <ol>
      <li class="numberedList" value="2">The <code class="inlineCode">MKAnnotation</code> protocol has an optional <code class="inlineCode">title</code> property, which you will use later. You will change the name of the <code class="inlineCode">title</code> property in the <code class="inlineCode">JournalEntry</code> class to <code class="inlineCode">entryTitle</code> so you don’t have two properties with the same name. Right-click on the <code class="inlineCode">title</code> property and choose <strong class="screenText">Refactor | Rename</strong> from the pop-up menu.</li>
      <li class="numberedList">Set the new name to <code class="inlineCode">entryTitle</code>, as shown, and click <strong class="screenText">Rename</strong>:</li>
    </ol>
    <figure class="mediaobject"><img src="image/B31371_17_14.png" alt="" width="812" height="360"/></figure>
    <p class="packt_figref">Figure 17.14: Refactoring the title property to entryTitle</p>
    <ol>
      <li class="numberedList" value="4">Modify <a id="_idIndexMarker777"/>the <code class="inlineCode">JournalEntry</code> class declaration as follows to make it a subclass of the <code class="inlineCode">NSObject</code> class and to adopt the <code class="inlineCode">MKAnnotation</code> protocol:
        <pre class="programlisting code-one"><code class="hljs-code"><span class="hljs-keyword">class</span> <span class="hljs-title">JournalEntry</span><span class="code-highlight"><strong class="hljs-slc">: </strong><strong class="hljs-type-slc">NSObject</strong><strong class="hljs-slc">, </strong><strong class="hljs-type-slc">MKAnnotation</strong><strong class="hljs-slc"> </strong></span>{
</code></pre>
      </li>
      <li class="numberedList">You’ll see an error because you have not yet implemented the <code class="inlineCode">coordinate</code> property, which is required to conform to the <code class="inlineCode">MKAnnotation</code> protocol. Type the following after the initializer:
        <pre class="programlisting code-one"><code class="hljs-code"><span class="hljs-comment">// MARK: - MKAnnotation</span>
<span class="hljs-keyword">var</span> <span class="hljs-template-variable">coordinate</span>: <span class="hljs-type">CLLocationCoordinate2D</span> {
  <span class="hljs-keyword">guard</span> <span class="hljs-keyword">let</span> lat <span class="hljs-operator">=</span> <span class="hljs-variable">latitude</span>, <span class="hljs-keyword">let</span> long <span class="hljs-operator">=</span> <span class="hljs-variable">longitude</span> <span class="hljs-keyword">else</span> {
    <span class="hljs-keyword">return</span> <span class="hljs-type">CLLocationCoordinate2D</span>()
  }
  <span class="hljs-keyword">return</span> <span class="hljs-type">CLLocationCoordinate2D</span>(<span class="hljs-con-attribute">latitude</span>: lat,   <span class="hljs-con-attribute">longitude</span>: long)
}
</code></pre>
      </li>
    </ol>
    <p class="normal-one">The <code class="inlineCode">coordinate</code> property is of the <code class="inlineCode">CLLocationCoordinate2D</code> type, and it holds a geographical location. The value of the <code class="inlineCode">coordinate</code> property is not assigned directly; the <code class="inlineCode">guard</code> statement gets the latitude and longitude values from the <code class="inlineCode">latitude</code> and <code class="inlineCode">longitude</code> properties, which are then used to create the value for the <code class="inlineCode">coordinate</code> property. Such properties are called <strong class="keyWord">computed properties</strong>.</p>
    <ol>
      <li class="numberedList" value="6">To implement <a id="_idIndexMarker778"/>the optional <code class="inlineCode">title</code> property, type the following after the <code class="inlineCode">coordinate</code> property:
        <pre class="programlisting code-one"><code class="hljs-code"><span class="hljs-keyword">var</span> <span class="hljs-template-variable">title</span>: <span class="hljs-type">String</span>? {
  <span class="hljs-variable">date</span>.<span class="hljs-con-attribute">formatted</span>(
    .<span class="hljs-con-attribute">dateTime</span>.<span class="hljs-con-attribute">day</span>().<span class="hljs-con-attribute">month</span>().<span class="hljs-con-attribute">year</span>()
  )
}
</code></pre>
      </li>
    </ol>
    <p class="normal-one">This is a computed property that returns the journal entry date formatted as a string.</p>
    <ol>
      <li class="numberedList" value="7">To <a id="_idIndexMarker779"/>implement the optional <code class="inlineCode">subtitle</code> property, type the following after the <code class="inlineCode">title</code> property:
        <pre class="programlisting code-one"><code class="hljs-code"><span class="hljs-keyword">var</span> <span class="hljs-template-variable">subtitle</span>: <span class="hljs-type">String</span>? {
  <span class="hljs-variable">entryTitle</span>
}
</code></pre>
      </li>
    </ol>
    <p class="normal-one">This is a computed property that returns the journal entry title.</p>
    <p class="normal">At this point, you’ve modified the <code class="inlineCode">JournalEntry</code> class to conform to the <code class="inlineCode">MKAnnotation</code> protocol. In the next section, you’ll modify the <code class="inlineCode">MapViewController</code> class to add an array of <code class="inlineCode">JournalEntry</code> instances to a map view, and any instance within the region displayed by the map view will appear as a pin on the Map screen.</p>
    <h1 id="_idParaDest-240" class="heading-1">Displaying annotation views on the Map screen</h1>
    <p class="normal">The Map <a id="_idIndexMarker780"/>screen at present displays a map <a id="_idIndexMarker781"/>region centered on your device location. Now that the map region has been set, you can determine which <code class="inlineCode">JournalEntry</code> instances are in this region based on their <code class="inlineCode">coordinate</code> property. Remember that the <code class="inlineCode">JournalEntry</code> class conforms to <code class="inlineCode">MKAnnotation</code>. As the view controller for the map view, the <code class="inlineCode">MapViewController</code> class is responsible for providing an <code class="inlineCode">MKAnnotationView</code> instance for any <code class="inlineCode">MKAnnotation</code> instance within this region. You will now modify the <code class="inlineCode">MapViewController</code> class to get an array of <code class="inlineCode">JournalEntry</code> instances from the <code class="inlineCode">SampleJournalEntryData</code> structure and add it to the map view. Follow these steps:</p>
    <ol>
      <li class="numberedList" value="1">In the Project navigator, click the <strong class="screenText">JournalEntry</strong> file. In the <code class="inlineCode">createSampleJournalEntryData()</code> method, modify the statement that creates the <code class="inlineCode">journalEntry2</code> instance as shown:
        <pre class="programlisting code-one"><code class="hljs-code"><span class="hljs-keyword">guard</span> <span class="hljs-keyword">let</span> journalEntry2 <span class="hljs-operator">=</span> <span class="hljs-con-class">JournalEntry</span>(<span class="hljs-variable">rating</span>: <span class="hljs-number">0</span>, <span class="hljs-variable">title</span>: <span class="hljs-string">"Bad"</span>, <span class="hljs-variable">body</span>: <span class="hljs-string">"Today is a bad day"</span>, <span class="hljs-variable">photo</span>: photo2<span class="code-highlight"><strong class="hljs-slc">, </strong><strong class="hljs-variable-slc">latitude</strong><strong class="hljs-slc">: </strong><strong class="hljs-number-slc">37.3318</strong><strong class="hljs-slc">, </strong><strong class="hljs-variable-slc">longitude</strong><strong class="hljs-slc">: </strong><strong class="hljs-operator-slc">-</strong><strong class="hljs-number-slc">122.0312</strong></span>) <span class="hljs-keyword">else</span> {
  <span class="hljs-con-attribute">fatalError</span>(<span class="hljs-string">"Unable to instantiate journalEntry2"</span>)
}
</code></pre>
      </li>
    </ol>
    <p class="normal-one">This <a id="_idIndexMarker782"/>instance now has values <a id="_idIndexMarker783"/>for its <code class="inlineCode">latitude</code> and <code class="inlineCode">longitude</code> properties, which will be used to set its <code class="inlineCode">coordinate</code> property. The values used are for a location close to the Apple campus, which you will set in Simulator when you run the app.</p>
    <div class="note-one">
      <p class="normal">You can use whatever location you wish, but you will need to make sure that the location is close to the center point of the map, otherwise, the pin will not be displayed.</p>
    </div>
    <ol>
      <li class="numberedList" value="2">In the Project navigator, click the <strong class="screenText">MapViewController</strong> file. Add an extension after all other code in the file to make the <code class="inlineCode">MapViewController</code> class conform to the <code class="inlineCode">MKMapViewDelegate</code> protocol:
        <pre class="programlisting code-one"><code class="hljs-code"><span class="hljs-keyword">extension</span> <span class="hljs-title">MapViewController</span>: <span class="hljs-type">MKMapViewDelegate</span><span class="hljs-title"> </span>{
}
</code></pre>
      </li>
      <li class="numberedList">Just after the <code class="inlineCode">locationTask</code> property declaration, add the following code to create a private property, <code class="inlineCode">annotations</code>, that will hold an array of <code class="inlineCode">JournalItem</code> instances:
        <pre class="programlisting code-one"><code class="hljs-code"><span class="hljs-keyword">private var </span><span class="hljs-template-variable">locationTask</span>: <span class="hljs-type">Task</span>&lt;<span class="hljs-type">Void</span>, <span class="hljs-type">Error</span>&gt;?
<span class="code-highlight"><strong class="hljs-keyword-slc">private var</strong><strong class="hljs-slc"> </strong><strong class="hljs-template-variable-slc">annotations</strong><strong class="hljs-slc">:</strong><strong class="hljs-operator-slc"> </strong><strong class="hljs-type-slc">[</strong><strong class="hljs-con-class-slc">JournalEntry</strong><strong class="hljs-type-slc">] = []</strong></span>
</code></pre>
        <div class="note-one">
          <p class="normal">There is currently no connection between the Journal List and Map screens. This means that any journal entries that you add using the Add New Journal Entry screen will not appear on the Map screen. You will create a shared instance that will be used by both view controllers in the next chapter.</p>
        </div>
      </li>
    </ol>
    <ol>
      <li class="numberedList" value="4">In the <code class="inlineCode">viewDidLoad()</code> method, set the map view’s <code class="inlineCode">delegate</code> property to an instance of <code class="inlineCode">MapViewController</code> before the closing curly brace:
        <pre class="programlisting code-one"><code class="hljs-code">  <span class="hljs-variable">fetchUserLocation</span>()
  <span class="code-highlight"><strong class="hljs-variable-slc">mapView</strong><strong class="hljs-slc">.</strong><strong class="hljs-con-attribute-slc">delegate</strong><strong class="hljs-slc"> </strong><strong class="hljs-operator-slc">=</strong><strong class="hljs-slc"> </strong><strong class="hljs-keyword-slc">self</strong></span>
}
</code></pre>
      </li>
      <li class="numberedList">On the <a id="_idIndexMarker784"/>next line, populate <a id="_idIndexMarker785"/>the <code class="inlineCode">journalEntries</code> array by calling the <code class="inlineCode">sampleJournalEntryData</code> structure’s <code class="inlineCode">createSampleJournalEntryData()</code> method:
        <pre class="programlisting code-one"><code class="hljs-code"> <span class="hljs-variable"> mapView</span>.<span class="hljs-con-attribute">delegate</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">self</span>
  <span class="code-highlight"><strong class="hljs-con-attribute-slc">annotations</strong><strong class="hljs-slc"> = </strong><strong class="hljs-con-class-slc">JournalEntry</strong><strong class="hljs-slc">.</strong><strong class="hljs-variable-slc">createSampleJournalEntryData</strong><strong class="hljs-slc">()</strong></span>
}
</code></pre>
      </li>
      <li class="numberedList">On the next line, add the following statement to add all the sample journal entries (which conform to the <code class="inlineCode">MKAnnotation</code> protocol) to the map view:
        <pre class="programlisting code-one"><code class="hljs-code">  <span class="hljs-con-attribute">annotations</span> = <span class="hljs-con-class">JournalEntry</span>.<span class="code-highlight"><strong class="hljs-variable-slc">createSampleJournalEntryData</strong></span>()
  <span class="code-highlight"><strong class="hljs-title-slc">mapView</strong><strong class="hljs-slc">.</strong><strong class="hljs-con-attribute-slc">addAnnotations</strong><strong class="hljs-slc">(</strong><strong class="hljs-con-attribute-slc">annotations</strong><strong class="hljs-slc">)</strong></span>
}
</code></pre>
      </li>
    </ol>
    <p class="normal-one">The map view’s delegate (the <code class="inlineCode">MapViewController</code> class in this case) will now automatically provide an <code class="inlineCode">MKAnnotationView</code> instance for every <code class="inlineCode">JournalItem</code> instance within the map region displayed on the Map screen.</p>
    <ol>
      <li class="numberedList" value="7">Build and run your app, and verify the location has been set to <strong class="screenText">Apple</strong> using Simulator’s <strong class="screenText">Features</strong> | <strong class="screenText">Location</strong> menu. You should see a single pin (<code class="inlineCode">MKAnnotationView</code> instance) on the Map screen:</li>
    </ol>
    <figure class="mediaobject"><img src="image/B31371_17_15.png" alt="" width="463" height="825"/></figure>
    <p class="packt_figref">Figure 17.15: iOS Simulator showing a standard MKAnnotationView instance</p>
    <p class="normal">The Map screen can now display pins, but tapping <a id="_idIndexMarker786"/>a pin just makes it bigger. You will add code to make pins display a callout with a button in the next section.</p>
    <div class="note">
      <p class="normal">Since <code class="inlineCode">viewDidLoad()</code> is only called once when the <code class="inlineCode">MapViewController</code> instance loads its view, any journal entries with locations added to the <code class="inlineCode">journalEntries</code> array after that will not be added as annotations to the map. You’ll address this issue in the next chapter.</p>
    </div>
    <h2 id="_idParaDest-241" class="heading-2">Configuring a pin to display a callout</h2>
    <p class="normal">Currently, the Map screen displays standard <code class="inlineCode">MKAnnotationView</code> instances, which look like pins. Tapping <a id="_idIndexMarker787"/>a pin just makes it bigger. An <code class="inlineCode">MKAnnotationView</code> instance can be configured to display callout bubbles when tapped. To make it do so, you will implement the <code class="inlineCode">mapView(_:viewFor:)</code> method, an optional <code class="inlineCode">MKMapViewDelegate</code> protocol method. Follow these steps:</p>
    <ol>
      <li class="numberedList" value="1">Click the <strong class="screenText">MapViewController</strong> file in the Project navigator. In the <code class="inlineCode">MKMapViewDelegate</code> extension, add the following method after the opening curly brace:
        <pre class="programlisting code-one"><code class="hljs-code"><span class="hljs-comment">// MARK: - MKMapViewDelegate</span>
<span class="hljs-keyword">func</span> <span class="hljs-template-variable">mapView</span>(<span class="hljs-template-variable">_</span> <span class="hljs-params">mapView</span>: <span class="hljs-type">MKMapView</span>, <span class="hljs-template-variable">viewFor</span> <span class="hljs-params">annotation</span>: <span class="hljs-keyword">any</span> <span class="hljs-type">MKAnnotation</span>) -&gt; <span class="hljs-type">MKAnnotationView</span>? {
  <span class="hljs-keyword">let</span> identifier <span class="hljs-operator">=</span> <span class="hljs-string">"mapAnnotation"</span>
  <span class="hljs-keyword">guard</span> annotation <span class="hljs-keyword">is</span> <span class="hljs-con-class">JournalEntry</span><span class="hljs-type"> </span><span class="hljs-keyword">else</span><span class="hljs-type"> </span>{
   <span class="hljs-keyword"> return nil</span>
  }
  <span class="hljs-keyword">if</span> <span class="hljs-keyword">let</span> annotationView <span class="hljs-operator">=</span>
  mapView.<span class="hljs-con-attribute">dequeueReusableAnnotationView</span>(<span class="hljs-con-attribute">withIdentifier</span>:
  identifier) {
    annotationView.<span class="hljs-con-attribute">annotation</span> <span class="hljs-operator">=</span> annotation
    <span class="hljs-keyword">return</span> annotationView
  } <span class="hljs-keyword">else</span> {
    <span class="hljs-keyword">let</span> annotationView <span class="hljs-operator">=</span>
    <span class="hljs-type">MKMarkerAnnotationView</span>(<span class="hljs-type">annotation</span>:annotation,
    <span class="hljs-type">reuseIdentifier</span>:identifier)
    annotationView.<span class="hljs-con-attribute">canShowCallou</span>t <span class="hljs-operator">=</span> <span class="hljs-literal">true</span>
    <span class="hljs-keyword">let</span> calloutButton <span class="hljs-operator">=</span> <span class="hljs-type">UIButton</span>(<span class="hljs-con-attribute">type</span>: .<span class="hljs-con-attribute">detailDisclosure</span>)
    annotationView.<span class="hljs-con-attribute">rightCalloutAccessoryView</span> <span class="hljs-operator">=</span>     calloutButton
    <span class="hljs-keyword">return</span> annotationView
  }
}
</code></pre>
      </li>
    </ol>
    <p class="normal-one">Let’s break this down:</p>
    <pre class="programlisting code-one"><code class="hljs-code"><span class="hljs-keyword">func</span> <span class="hljs-template-variable">mapView</span>(<span class="hljs-template-variable">_</span> <span class="hljs-params">mapView</span>: <span class="hljs-type">MKMapView</span>, <span class="hljs-template-variable">viewFor</span> <span class="hljs-params">annotation</span>: <span class="hljs-keyword">any</span> <span class="hljs-type">MKAnnotation</span>) -&gt; <span class="hljs-type">MKAnnotationView</span>?
</code></pre>
    <p class="normal-one">This is one of the methods specified in the <code class="inlineCode">MKMapViewDelegate</code> protocol. It’s triggered when an <code class="inlineCode">MKAnnotation</code> instance is within the map region, and it returns an <code class="inlineCode">MKAnnotationView</code> instance, which the user will see on the screen.</p>
    <pre class="programlisting code-one"><code class="hljs-code"><span class="hljs-keyword">let</span> identifier <span class="hljs-operator">=</span> <span class="hljs-string">"mapAnnotation"</span>
</code></pre>
    <p class="normal-one">A constant, <code class="inlineCode">identifier</code>, is assigned the <code class="inlineCode">"MapAnnotation"</code> string. This will be the <a id="_idIndexMarker788"/>reuse identifier for the <code class="inlineCode">MKAnnotationView</code> instance.</p>
    <pre class="programlisting code-one"><code class="hljs-code"><span class="hljs-keyword">guard</span> annotation <span class="hljs-keyword">is</span> <span class="hljs-con-class">JournalEntry</span><span class="hljs-type"> </span><span class="hljs-keyword">else</span><span class="hljs-type"> </span>{
 <span class="hljs-keyword"> return nil</span>
}
</code></pre>
    <p class="normal-one">This <code class="inlineCode">guard</code> statement checks to see if the annotation is a <code class="inlineCode">JournalEntry</code> instance, and returns <code class="inlineCode">nil</code> if it is not.</p>
    <pre class="programlisting code-one"><code class="hljs-code"><span class="hljs-keyword">if</span> <span class="hljs-keyword">let</span> annotationView <span class="hljs-operator">=</span>
mapView.<span class="hljs-con-attribute">dequeueReusableAnnotationView</span>(<span class="hljs-con-attribute">withIdentifier</span>:
identifier) {
  annotationView.<span class="hljs-con-attribute">annotation</span> <span class="hljs-operator">=</span> annotation
  <span class="hljs-keyword">return</span> annotationView
</code></pre>
    <p class="normal-one">This <code class="inlineCode">if</code> statement checks to see whether there is an existing <code class="inlineCode">MKAnnotationView</code> instance that was initially visible but is no longer on the screen. If there is, it can be reused and is assigned to the <code class="inlineCode">annotationView</code> constant. The <code class="inlineCode">JournalItem</code> instance is then assigned to the <code class="inlineCode">annotation</code> property of <code class="inlineCode">annotationView</code> and the <code class="inlineCode">annotationView</code> is returned.</p>
    <pre class="programlisting code-one"><code class="hljs-code">} <span class="hljs-keyword">else</span> {
    <span class="hljs-keyword">let</span> annotationView <span class="hljs-operator">=</span>
    <span class="hljs-type">MKMarkerAnnotationView</span>(<span class="hljs-type">annotation</span>:annotation,
    <span class="hljs-type">reuseIdentifier</span>:identifier)
</code></pre>
    <p class="normal-one">The <code class="inlineCode">else</code> clause is executed if there are no existing <code class="inlineCode">MKAnnotationView</code> instances that can be reused. A new <code class="inlineCode">MKAnnotationView</code> instance is created with the reuse identifier specified earlier (<code class="inlineCode">MapAnnotation</code>).</p>
    <pre class="programlisting code-one"><code class="hljs-code">annotationView.<span class="hljs-con-attribute">canShowCallou</span>t <span class="hljs-operator">=</span> <span class="hljs-literal">true</span>
<span class="hljs-keyword">let</span> calloutButton <span class="hljs-operator">=</span> <span class="hljs-type">UIButton</span>(<span class="hljs-con-attribute">type</span>: .<span class="hljs-con-attribute">detailDisclosure</span>)
annotationView.<span class="hljs-con-attribute">rightCalloutAccessoryView</span> <span class="hljs-operator">=</span> calloutButton
</code></pre>
    <p class="normal-one">The <code class="inlineCode">MKAnnotationView</code> instance is configured with a callout. When you tap a pin <a id="_idIndexMarker789"/>on the map, a callout bubble will appear showing the title (journal entry date), subtitle (journal entry title), and a button. You’ll program the button later to present the Journal Entry Detail screen.</p>
    <pre class="programlisting code-one"><code class="hljs-code"><span class="hljs-keyword">return</span> annotationView
</code></pre>
    <p class="normal-one">The custom <code class="inlineCode">MKAnnotationView</code> instance is returned.</p>
    <div class="note-one">
      <p class="normal">To <a id="_idIndexMarker790"/>learn more about the <code class="inlineCode">mapView(_:viewFor:)</code> method, see <a href="https://developer.apple.com/documentation/mapkit/mkmapviewdelegate/1452045-mapview"><span class="url">https://developer.apple.com/documentation/mapkit/mkmapviewdelegate/1452045-mapview</span></a>.</p>
    </div>
    <ol>
      <li class="numberedList" value="2">Build and run your app, and set the location to <strong class="screenText">Apple</strong> using Simulator’s <strong class="screenText">Features</strong> | <strong class="screenText">Location</strong> menu. You should see a single pin on the Map screen. Tap the pin to display a callout:</li>
    </ol>
    <figure class="mediaobject"><img src="image/B31371_17_16.png" alt="" width="459" height="825"/></figure>
    <p class="packt_figref">Figure 17.16: iOS Simulator showing a callout when a pin is tapped</p>
    <p class="normal">You have <a id="_idIndexMarker791"/>successfully created a custom <code class="inlineCode">MKAnnotationView</code> that displays a callout when tapped, but tapping the button in the callout bubble doesn’t do anything yet. You’ll configure the button to present the Journal Entry Detail screen in the next section.</p>
    <h2 id="_idParaDest-242" class="heading-2">Going from the Map screen to the Journal Entry Detail screen</h2>
    <p class="normal">At this point, the Map screen now displays an <code class="inlineCode">MKAnnotationView</code> instance, and tapping it displays a callout bubble showing journal entry details. The button in the callout bubble <a id="_idIndexMarker792"/>doesn’t work yet, though. </p>
    <p class="normal">To present the Journal Entry Detail screen from the callout button, you’ll add a segue between the Map screen and the Journal Entry Detail screen and you will implement the <code class="inlineCode">mapView(_:annotationView:calloutAccessoryControlTapped:)</code> method, an optional <code class="inlineCode">MKMapViewDelegate</code> protocol method, to perform that segue when the callout button is tapped. Follow these steps:</p>
    <ol>
      <li class="numberedList" value="1">In the Project navigator, click the <strong class="screenText">Main</strong> storyboard file. Find the <strong class="screenText">Map</strong> icon under <strong class="screenText">Map Scene</strong> in the document outline. <em class="keystroke">Ctrl</em> + <em class="keystroke">Drag</em> from the <strong class="screenText">Map</strong> icon to the <strong class="screenText">Entry Detail</strong> <strong class="screenText">Scene</strong> and choose <strong class="screenText">Show</strong> from the pop-up menu to add a segue between the <strong class="screenText">Map</strong> <strong class="screenText">Scene</strong> and the <strong class="screenText">Entry Detail</strong> <strong class="screenText">Scene</strong>:</li>
    </ol>
    <figure class="mediaobject"><img src="image/B31371_17_17.png" alt="" width="812" height="421"/></figure>
    <p class="packt_figref">Figure 17.17: Segue pop-up menu</p>
    <ol>
      <li class="numberedList" value="2">You will set an identifier for this segue so that the <code class="inlineCode">mapView(_:annotationView:calloutAccessoryControlTapped:)</code> method knows which segue to perform. Select the segue connecting the <strong class="screenText">Map</strong> <strong class="screenText">Scene</strong> to the <strong class="screenText">Entry Detail</strong> <strong class="screenText">Scene</strong>:</li>
    </ol>
    <figure class="mediaobject"><img src="image/B31371_17_18.png" alt="" width="784" height="526"/></figure>
    <p class="packt_figref">Figure 17.18: Segue between Map scene and Entry Detail scene</p>
    <ol>
      <li class="numberedList" value="3">In the <a id="_idIndexMarker793"/>Attributes inspector, under <strong class="screenText">Storyboard Segue</strong>, set <strong class="screenText">Identifier</strong> to <code class="inlineCode">showMapDetail</code>:</li>
    </ol>
    <figure class="mediaobject"><img src="image/B31371_17_19.png" alt="" width="453" height="281"/></figure>
    <p class="packt_figref">Figure 17.19: Attributes inspector settings for the showDetail segue</p>
    <ol>
      <li class="numberedList" value="4">Click the <strong class="screenText">MapViewController</strong> file in the Project navigator. In the <code class="inlineCode">MapViewController</code> class, add a property to store a journal entry after all other property declarations:
        <pre class="programlisting code-one"><code class="hljs-code"><span class="hljs-keyword">private var</span> <span class="hljs-template-variable">annotations</span>: [<span class="hljs-con-class">JournalEntry</span>] <span class="hljs-operator">= []</span>
<span class="code-highlight"><strong class="hljs-keyword-slc">private var</strong><strong class="hljs-slc"> </strong><strong class="hljs-template-variable-slc">selectedAnnotation</strong><strong class="hljs-slc">: </strong><strong class="hljs-con-class-slc">JournalEntry</strong><strong class="hljs-slc">?</strong></span>
</code></pre>
      </li>
    </ol>
    <p class="normal-one">This <a id="_idIndexMarker794"/>property will store the <code class="inlineCode">JournalEntry</code> instance for the <code class="inlineCode">MKAnnotationView</code> instance that was tapped.</p>
    <ol>
      <li class="numberedList" value="5">Add <code class="inlineCode">mapView(_:annotationView:calloutAccessoryControlTapped:)</code> after the <code class="inlineCode">mapView(_:viewFor:)</code> method:
        <pre class="programlisting code-one"><code class="hljs-code"><span class="hljs-keyword">func</span> <span class="hljs-template-variable">mapView</span>(<span class="hljs-template-variable">_ </span><span class="hljs-params">mapView</span>: <span class="hljs-type">MKMapView</span>, <span class="hljs-template-variable">annotationView</span> <span class="hljs-params">view</span>: <span class="hljs-type">MKAnnotationView</span>, <span class="hljs-template-variable">calloutAccessoryControlTapped</span> <span class="hljs-params">control</span>: <span class="hljs-type">UIControl</span>) {
  <span class="hljs-keyword">guard</span> <span class="hljs-keyword">let</span> annotation <span class="hljs-operator">=</span> mapView.<span class="hljs-con-attribute">selectedAnnotations</span>.<span class="hljs-con-attribute">first</span> 
<span class="hljs-keyword">  else</span> {
    <span class="hljs-keyword">return</span>
  }
  <span class="hljs-variable">selectedAnnotation</span> <span class="hljs-operator">=</span> annotation <span class="hljs-keyword">as?</span> <span class="hljs-con-class">JournalEntry</span>
  <span class="hljs-keyword">self</span>.<span class="hljs-con-attribute">performSegue</span>(<span class="hljs-con-attribute">withIdentifier</span>: <span class="hljs-string">"showMapDetail"</span>, 
  <span class="hljs-con-attribute">sender</span>: <span class="hljs-keyword">self</span>)
}
</code></pre>
      </li>
    </ol>
    <p class="normal-one">This method is triggered when the user taps the callout bubble button. The annotation for the annotation view will be assigned to the <code class="inlineCode">selectedAnnotation</code> property, and the segue with the <code class="inlineCode">showMapDetail </code>identifier will be performed, which presents the Journal Entry Detail screen.</p>
    <div class="note-one">
      <p class="normal">To <a id="_idIndexMarker795"/>learn more about the <code class="inlineCode">mapView(_:annotationView:calloutAccessoryControlTapped:)</code> method, see <a href="https://developer.apple.com/documentation/mapkit/mkmapviewdelegate/1616211-mapview"><span class="url">https://developer.apple.com/documentation/mapkit/mkmapviewdelegate/1616211-mapview</span></a>.</p>
    </div>
    <ol>
      <li class="numberedList" value="6">Build and <a id="_idIndexMarker796"/>run your app and set the location to <strong class="screenText">Apple</strong> using Simulator’s <strong class="screenText">Features</strong> | <strong class="screenText">Location</strong> menu. You should see a single pin on the Map screen. Tap the pin to display a callout and tap the button inside the callout.</li>
      <li class="numberedList">The Journal Entry Detail screen appears, but it does not contain any details about the journal entry:</li>
    </ol>
    <figure class="mediaobject"><img src="image/B31371_17_20.png" alt="" width="417" height="380"/></figure>
    <p class="packt_figref">Figure 17.20: iOS Simulator showing a blank Journal Entry Detail screen</p>
    <ol>
      <li class="numberedList" value="8">To make the Journal Entry Detail screen display the details of a journal entry, you will use the <code class="inlineCode">prepare(for:sender:)</code> method to pass the selected journal <a id="_idIndexMarker797"/>entry to the Journal Entry Detail screen’s view controller. In the <code class="inlineCode">MapViewController</code> class, uncomment and modify the <code class="inlineCode">prepare(for:sender:)</code> method as shown:
        <pre class="programlisting code-one"><code class="hljs-code"><span class="hljs-comment">// MARK: - Navigation</span>
<span class="hljs-keyword">override</span> <span class="hljs-keyword">func</span> <span class="hljs-template-variable">prepare</span>(<span class="hljs-template-variable">for</span> <span class="hljs-params">segue</span>: <span class="hljs-type">UIStoryboardSegue</span>, <span class="hljs-template-variable">sender</span>: <span class="hljs-keyword">Any</span><span class="hljs-operator">?</span>) {
  <span class="hljs-keyword">super</span>.<span class="hljs-con-attribute">prepare</span>(<span class="hljs-con-attribute">for</span>: segue, <span class="hljs-con-attribute">sender</span>: sender)
  <span class="hljs-keyword">guard</span> segue.<span class="hljs-con-attribute">identifier</span> <span class="hljs-operator">==</span> <span class="hljs-string">"showMapDetail"</span> <span class="hljs-keyword">else</span> {
    <span class="hljs-con-attribute">fatalError</span>(<span class="hljs-string">"Unexpected segue identifier"</span>)
  }
  <span class="hljs-keyword">guard</span> <span class="hljs-keyword">let</span> entryDetailViewController <span class="hljs-operator">=</span> segue.<span class="hljs-con-attribute">destination</span> <span class="hljs-keyword">  as? </span><span class="hljs-con-class">JournalEntryDetailViewController</span> <span class="hljs-keyword">else</span> {
    <span class="hljs-con-attribute">fatalError</span>(<span class="hljs-string">"Unexpected view controller"</span>)
  }
  entryDetailViewController.<span class="hljs-variable">selectedJournalEntry</span> <span class="hljs-operator">=</span>   <span class="hljs-variable">selectedAnnotation</span>
}
</code></pre>
      </li>
    </ol>
    <p class="normal-one">As you have learned before, the prepare<code class="inlineCode">(for:sender:) </code>method is executed by a view <a id="_idIndexMarker798"/>controller before transitioning to another view controller. In this case, this method is called before the Map screen transitions to the Journal Entry Detail screen. If the segue’s identifier is <code class="inlineCode">showMapDetail</code> and the segue destination is a <code class="inlineCode">JournalEntryDetailViewController</code> instance, <code class="inlineCode">selectedAnnotation</code> will be assigned to the <code class="inlineCode">selectedJournalEntry</code> property for the <code class="inlineCode">JournalEntryDetailViewController</code> instance.</p>
    <ol>
      <li class="numberedList" value="9">Build and run your app and verify the location has been set to <strong class="screenText">Apple</strong> using Simulator’s <strong class="screenText">Features</strong> | <strong class="screenText">Location</strong> menu. You should see a single pin on the Map screen. Tap the pin to display a callout and tap the button inside the callout. The Journal Entry Detail screen appears, and it displays the details of the journal entry that you tapped on the Map screen.</li>
    </ol>
    <figure class="mediaobject"><img src="image/B31371_17_21.png" alt="" width="494" height="464"/></figure>
    <p class="packt_figref">Figure 17.21: Simulator showing the Journal Entry Detail screen</p>
    <p class="normal">You have <a id="_idIndexMarker799"/>connected the Journal Entry Detail screen to the Map screen, and have successfully passed data from a selected journal entry on the Map screen to the Journal Entry Detail screen. Fantastic! In the next section, you’ll configure the Journal Entry Detail screen to display a map snapshot of the journal entry’s location.</p>
    <h1 id="_idParaDest-243" class="heading-1">Displaying a map snapshot on the Journal Entry Detail screen</h1>
    <p class="normal">The Map <a id="_idIndexMarker800"/>screen currently <a id="_idIndexMarker801"/>displays a single pin representing a journal entry. When you tap the pin on the Map screen and tap the callout button, the details of the journal entry are displayed on the Journal Entry Detail screen, but the second image view on the Journal Entry Detail screen currently displays a placeholder map image. You can capture a map region and convert it into an image using the <code class="inlineCode">MKMapSnapshotter</code> class.</p>
    <div class="note">
      <p class="normal">For <a id="_idIndexMarker802"/>more information on the <code class="inlineCode">MKMapSnapshotter</code> class, see <a href="https://developer.apple.com/documentation/mapkit/mkmapsnapshotter"><span class="url">https://developer.apple.com/documentation/mapkit/mkmapsnapshotter</span></a>.</p>
    </div>
    <p class="normal">To configure the region and appearance of the map that is captured in the snapshot, an <code class="inlineCode">MKMapSnapshotter.Options</code> object is used.</p>
    <div class="note">
      <p class="normal">For more <a id="_idIndexMarker803"/>information on the <code class="inlineCode">MKMapSnapshotter.Options</code> object, see <a href="https://developer.apple.com/documentation/mapkit/mkmapsnapshotter/options"><span class="url">https://developer.apple.com/documentation/mapkit/mkmapsnapshotter/options</span></a>.</p>
    </div>
    <p class="normal">You will <a id="_idIndexMarker804"/>connect the second <a id="_idIndexMarker805"/>image view in the <strong class="keyWord">Entry Detail Scene</strong> to an outlet in the <code class="inlineCode">JournalEntryDetailViewController</code> class and replace the placeholder image with a map snapshot showing the location of the journal entry. Follow these steps:</p>
    <ol>
      <li class="numberedList" value="1">In the Project navigator, click the <code class="inlineCode">JournalEntryDetailViewController</code> file. Type the following after the <code class="inlineCode">import UIKit</code> statement to import the <code class="inlineCode">MapKit</code> framework:
        <pre class="programlisting code-one"><code class="hljs-code"><span class="hljs-keyword">import</span> UIKit
<span class="code-highlight"><strong class="hljs-keyword-slc">import</strong><strong class="hljs-slc"> MapKit</strong></span>
</code></pre>
      </li>
      <li class="numberedList">Add the following outlet after all other outlets in the <code class="inlineCode">JournalEntryDetailViewController</code> class:
        <pre class="programlisting code-one"><code class="hljs-code"><span class="hljs-keyword">@IBOutlet</span> <span class="hljs-keyword">var</span> <span class="hljs-template-variable">bodyTextView</span>: <span class="hljs-type">UITextView</span>!
<span class="hljs-keyword">@IBOutlet</span> <span class="hljs-keyword">var</span> <span class="hljs-template-variable">photoImageView</span>: <span class="hljs-type">UIImageView</span>!
<span class="code-highlight"><strong class="hljs-keyword-slc">@IBOutlet</strong><strong class="hljs-slc"> </strong><strong class="hljs-keyword-slc">var</strong><strong class="hljs-slc"> </strong><strong class="hljs-template-variable-slc">mapImageView</strong><strong class="hljs-slc">: </strong><strong class="hljs-type-slc">UIImageView</strong><strong class="hljs-slc">!</strong></span>
<span class="hljs-keyword">var</span> <span class="hljs-template-variable">selectedJournalEntry</span>: <span class="hljs-con-class">JournalEntry</span>?
</code></pre>
      </li>
      <li class="numberedList">Add a method to generate the map snapshot before the closing curly brace:
        <pre class="programlisting code-one"><code class="hljs-code"><span class="hljs-comment">// MARK: - Private methods</span>
<span class="hljs-keyword">private</span> <span class="hljs-keyword">func</span> <span class="hljs-template-variable">getMapSnapshot</span>() {
  <span class="hljs-keyword">guard</span> <span class="hljs-keyword">let</span> lat <span class="hljs-operator">=</span> <span class="hljs-variable">selectedJournalEntry</span><span class="hljs-operator">?</span>.<span class="hljs-variable">latitude</span>, <span class="hljs-keyword">let</span> 
  long <span class="hljs-operator">= </span><span class="hljs-variable">selectedJournalEntry</span><span class="hljs-operator">?</span>.<span class="hljs-variable">longitude</span> <span class="hljs-keyword">else</span> {
    <span class="hljs-keyword">self</span>.<span class="hljs-variable">mapImageView</span>.<span class="hljs-con-attribute">image</span> = <span class="hljs-keyword">nil</span>
    <span class="hljs-keyword">return</span>
  }
  <span class="hljs-keyword">let</span> options <span class="hljs-operator">=</span> <span class="hljs-type">MKMapSnapshotter</span>.<span class="hljs-type">Options</span>()
  options.<span class="hljs-con-attribute">region</span> <span class="hljs-operator">=</span> <span class="hljs-type">MKCoordinateRegion</span>(<span class="hljs-con-attribute">center</span>:
  <span class="hljs-type">CLLocationCoordinate2D</span>(<span class="hljs-con-attribute">latitude</span>: lat, <span class="hljs-con-attribute">longitude</span>: long),
  <span class="hljs-con-attribute">span</span>: <span class="hljs-type">MKCoordinateSpan</span>(<span class="hljs-con-attribute">latitudeDelta</span>: <span class="hljs-number">0.01</span>,
  <span class="hljs-con-attribute">longitudeDelta</span>: <span class="hljs-number">0.01</span>))
  options.<span class="hljs-con-attribute">size</span> <span class="hljs-operator">=</span> <span class="hljs-type">CGSize</span>(<span class="hljs-con-attribute">width</span>: <span class="hljs-number">300</span>,<span class="hljs-con-attribute"> height</span>: <span class="hljs-number">300</span>)
  options.<span class="hljs-con-attribute">preferredConfiguration</span> <span class="hljs-operator">=</span> <span class="hljs-type">  MKStandardMapConfiguration</span>()
  <span class="hljs-keyword">let</span> snapshotter <span class="hljs-operator">=</span> <span class="hljs-type">MKMapSnapshotter</span>(<span class="hljs-con-attribute">options</span>: options)
  snapshotter.<span class="hljs-con-attribute">start</span> { snapshot, error <span class="hljs-keyword">in</span>
    <span class="hljs-keyword">if</span> <span class="hljs-keyword">let</span> snapshot {
      <span class="hljs-keyword">self</span>.<span class="hljs-variable">mapImageView</span>.<span class="hljs-con-attribute">image</span> <span class="hljs-operator">=</span> snapshot.<span class="hljs-con-attribute">image</span>
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> <span class="hljs-keyword">let</span> error {
      <span class="hljs-con-attribute">print</span>(<span class="hljs-string">"snapshot error:  </span>
<span class="hljs-subst">      </span>\(error.<span class="hljs-con-attribute">localizedDescription</span>)<span class="hljs-string">"</span>)
    }
  }
}
</code></pre>
      </li>
    </ol>
    <p class="normal-one">This <a id="_idIndexMarker806"/>method checks <a id="_idIndexMarker807"/>to see if <code class="inlineCode">journalEntry</code> has values in its <code class="inlineCode">latitude</code> and <code class="inlineCode">longitude</code> properties. If it does, then an <code class="inlineCode">MKMapSnapShotter.Options</code> object is created, configured, and assigned to an <code class="inlineCode">MKMapSnapshotter</code> object. The <code class="inlineCode">MKMapSnapshotter</code> object is then used to generate the map snapshot, which will be assigned to the <code class="inlineCode">image</code> property of the <code class="inlineCode">mapImageView</code> property.</p>
    <ol>
      <li class="numberedList" value="4">Call the <code class="inlineCode">getMapSnapshot()</code> method in the <code class="inlineCode">viewDidLoad()</code> method before the closing curly brace:
        <pre class="programlisting code-one"><code class="hljs-code">  <span class="hljs-variable">photoImageView</span>.<span class="hljs-con-attribute">image</span> <span class="hljs-operator">=</span> <span class="hljs-variable">journalEntry</span><span class="hljs-operator">?</span>.<span class="hljs-variable">photo</span>
  <span class="code-highlight"><strong class="hljs-variable-slc">getMapSnapshot</strong><strong class="hljs-slc">()</strong></span>
}
</code></pre>
      </li>
      <li class="numberedList">In the Project navigator, click the <strong class="screenText">Main</strong> storyboard file and click <strong class="screenText">Entry Detail </strong><strong class="keyWord">Scene</strong> in the document outline. Click the Connections inspector button and connect the <strong class="screenText">mapImageView</strong> outlet to the second image view in the <strong class="screenText">Entry Detail </strong><strong class="keyWord">Scene</strong>:</li>
    </ol>
    <figure class="mediaobject"><img src="image/B31371_17_22.png" alt="" width="812" height="570"/></figure>
    <p class="packt_figref">Figure 17.22: Connections inspector showing the mapImageView outlet</p>
    <div class="packt_tip-one">
      <p class="normal">It may be easier to drag to the image view in the document outline.</p>
    </div>
    <ol>
      <li class="numberedList" value="6">Build <a id="_idIndexMarker808"/>and run <a id="_idIndexMarker809"/>your app and verify the location has been set to <strong class="screenText">Apple</strong> using Simulator’s <strong class="screenText">Features</strong> | <strong class="screenText">Location</strong> menu. You should see a single pin on the Map screen. Tap the pin to display a callout and tap the button inside the callout. The Journal Entry Detail screen appears, and it displays the details of the journal entry that you tapped on the Map screen. Scroll down and you will see the map snapshot in the second image view:</li>
    </ol>
    <figure class="mediaobject"><img src="image/B31371_17_23.png" alt="" width="463" height="825"/></figure>
    <p class="packt_figref">Figure 17.23: Simulator showing the Journal Entry Detail screen with a map snapshot</p>
    <p class="normal">The <a id="_idIndexMarker810"/>Journal Entry Detail screen <a id="_idIndexMarker811"/>can now display the map snapshot showing the location of a journal entry. Cool!</p>
    <h1 id="_idParaDest-244" class="heading-1">Summary</h1>
    <p class="normal">In this chapter, you modified the Add New Journal Entry screen so that the user can add their current location to a new journal entry. Next, you created a <code class="inlineCode">MapViewController</code> class and configured it to display a custom map region centered on your location. Then, you updated the <code class="inlineCode">JournalEntry</code> class to conform to the <code class="inlineCode">MKAnnotation</code> protocol. After that, you modified the <code class="inlineCode">MapViewController</code> class to display a pin for each journal entry within the map region. You configured the pins to display callouts and configured buttons in the callouts to display the Journal Entry Detail screen when tapped. Finally, you modified the <code class="inlineCode">JournalEntryViewController</code> class to display a map snapshot for the journal entry on the Journal Entry Detail screen.</p>
    <p class="normal">You now know how to get your device location using Apple’s Core Location framework, how to create custom map regions and display map annotations using Apple’s MapKit framework, and how to create map snapshots, which will come in handy if you’re planning to build apps that use maps, such as <em class="italic">Apple Maps</em> or <em class="italic">Waze</em>.</p>
    <p class="normal">In the next chapter, you’ll learn how to create a shared data instance, and how to load and save data from JSON files.</p>
    <h1 id="_idParaDest-245" class="heading-1">Join us on Discord!</h1>
    <p class="normal">Read this book alongside other users, experts, and the author himself. Ask questions, provide solutions to other readers, chat with the author via Ask Me Anything sessions, and much more. Scan the QR code or visit the link to join the community.</p>
    <p class="normal"><a href="https://packt.link/ios-Swift%0D"><span class="url">https://packt.link/ios-Swift</span></a></p>
    <p class="normal"><a href="https://packt.link/ios-Swift%0D"><img src="image/QR_Code2370024260177612484.png" alt="" width="177" height="177"/></a></p>
  </div>
</div></div></body></html>