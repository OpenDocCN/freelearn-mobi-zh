<html><head></head><body>
  <div><div><div><div><h1 class="title"><a class="calibre1" id="ch11"/>Chapter 11. Handling Data</h1>
        </div>
      </div>
    </div>

    <p class="calibre9">From time to time it is important for an application to store or manipulate data. With the advent of LINQ, manipulation is extremely simple now. The problem, though, is that you need to store the data somehow. Thankfully this too is simple using SQLite.</p>

    <p class="calibre9">We will be covering the following topics in this chapter:</p>

    <div><ul class="itemizedlist">
        <li class="listitem">Using SQLite</li>

        <li class="listitem">Setting up an SQLite helper class</li>

        <li class="listitem">Using LINQ</li>

        <li class="listitem">Dangers of using LINQ on iOS</li>
      </ul>
    </div>

    <div><div><div><div><h1 class="title"><a class="calibre1" id="ch11lvl1sec44"/>Using SQLite</h1>
          </div>
        </div>
      </div>

      <p class="calibre9">SQLite is a very simple <a class="calibre1" id="id867"/>database system that is also extremely powerful. It is outside the scope of this book to give you a master class on using SQLite, but understanding how to set up and use the system will help.</p>

      <div><div><div><div><h2 class="title1"><a class="calibre1" id="ch11lvl2sec54"/>Installing and setting up SQLite</h2>
            </div>
          </div>
        </div>

        <p class="calibre9">Installing can be performed <a class="calibre1" id="id868"/>in one of two ways; either you can install from the Xamarin component market (it is useful as it supplies you with examples and also the Android version) or you can download and install the software manually. As there are no additional libraries (SQLite comes as a single C# file) either way is good.</p>

        <p class="calibre9">Once you have either copied the C# file or installed the component, the <code class="email">SQLite.net</code> implementation is ready for use. It is as simple as inserting the following <code class="email">using</code> directive at the top of the source file, and it's done:</p>

        <div><pre class="programlisting">using SQLite;</pre>
        </div>
      </div>

      <div><div><div><div><h2 class="title1"><a class="calibre1" id="ch11lvl2sec55"/>Database basics</h2>
            </div>
          </div>
        </div>

        <p class="calibre9">An easy way to consider a <a class="calibre1" id="id869"/>database is like an old card index system (commonly known as a <strong class="calibre2">cardex</strong> <a class="calibre1" id="id870"/>system). Information (data) can be added, updated, read, or deleted—and SQLite gives you that facility within the mobile environment. The data is stored in a file with tables (the table can be considered as the box that holds the cards) holding the information you want.</p>

        <p class="calibre9">Before the cardex system can be used though, the method of storage has to be defined. The simplest method of doing it is to create a class containing the primitive types. SQLite can only store certain types of data: <code class="email">integer</code>, <code class="email">real</code>, <code class="email">text</code>, <code class="email">none</code>, and <code class="email">numeric</code>. No other types are permitted—this includes arrays and collections (such as <code class="email">List&lt;T&gt;</code>) The types normally used in programming (such as <code class="email">string</code> and <code class="email">double</code>) are <strong class="calibre2">mapped</strong> to these internal types.</p>

        <p class="calibre9">A table also requires a primary key. This is the main index key which is typically auto-incremented. In a data class, this would be defined using <code class="email">[PrimaryKey, AutoIncrement]</code>.</p>

        <div><div><div><div><h3 class="title2"><a class="calibre1" id="ch11lvl3sec104"/>A simple database class</h3>
              </div>
            </div>
          </div>

          <p class="calibre9">As a demonstration, a simple <a class="calibre1" id="id871"/>database class can be used:</p>

          <div><pre class="programlisting">using SQLite;
public class demoRow
{
    public demoRow ()
    {}
    [PrimaryKey, AutoIncrement]
    public int ID
    {get; set;}
    public string Name
    {get;set;}
    public double Value
    {get;set;}
    public override string ToString()
    {
        return string.Format("[demoRow : ID={0}, Name={1},Value={2}]", ID, Name, Value);
    }
}</pre>
          </div>

          <p class="calibre9">The <code class="email">demoTable</code> <a class="calibre1" id="id872"/>variable can then be brought into the database.</p>
        </div>

        <div><div><div><div><h3 class="title2"><a class="calibre1" id="ch11lvl3sec105"/>Create a connection to the database</h3>
              </div>
            </div>
          </div>

          <p class="calibre9">Before the database can be <a class="calibre1" id="id873"/>used, a connection to the server needs to be set up. As with any class, the database class needs to be set up. I've called mine <code class="email">DataManager</code>. <a class="calibre1" id="id874"/>SQLite needs a path to the database file.</p>

          <div><pre class="programlisting">DataManager dm = new DataManager("path_to_database");
dm.Setup(); // calls the creation of the database code</pre>
          </div>

          <p class="calibre9">The preceding code sets up an instance of the <a class="calibre1" id="id875"/> <code class="email">DataManager</code>. To enable the database to be used <a class="calibre1" id="id876"/>across the app, the following should be added to the <code class="email">AppDelegate</code> class:</p>

          <div><pre class="programlisting">private static DataManager dm{ get; set; }</pre>
          </div>

          <p class="calibre9">Within the <code class="email">DataManager</code> class, a lock is required (in order to prevent more than one operation occurring on the database at any time), as is a local copy of the database path.</p>

          <div><pre class="programlisting">public DataManager(string path)
{
    dataLock = new object();
    dataBasePath = path;
}

private string dataBasePath;
private object dataLock;

public string DataPath{
    get
    {
        return dataBasePath;
    }
}</pre>
          </div>

          <p class="calibre9">Finally, the table needs to be set up in the database.</p>

          <div><pre class="programlisting">public bool Setup()
{
    lock(dbLock)
    {
        try
        {
            using (SQLiteConnection sqlCon = newSQLiteConnection(DBPath))
            {
                 sqlCon.CreateTable&lt;demoRow&gt;();
            }
            return true;
        }
        catch (SQLiteException ex)
        {
            throw ex;
        }
        catch (Exception ex)
        {
            throw ex;
        }
    }
}</pre>
          </div>

          <p class="calibre9">You'll notice that you will need to define a class with the following constants in it:</p>

          <div><pre class="programlisting">public const string DBClauseSyncOff = "PRAGMA SYNCHRONOUS=OFF;";
public const string DBClauseVacuum = "VACUUM;";</pre>
          </div>

          <p class="calibre9">The <a class="calibre1" id="id877"/> <code class="email">DBClauseVacuum</code> constant <a class="calibre1" id="id878"/>is used on the final Execute query. The <code class="email">DBClauseSyncOff</code> <a class="calibre1" id="id879"/>constant is used on the first.</p>

          <p class="calibre9">At this point, you may have noticed something about using SQLite. It is being used as if it is a normal method within a class. This is fine as it is.</p>
        </div>
      </div>
    </div>
  </div>


  <div><div><div><div><h1 class="title"><a class="calibre1" id="ch11lvl1sec45"/>Setting up an SQLite helper class</h1>
        </div>
      </div>
    </div>

    <p class="calibre9">Typically using SQLite would <a class="calibre1" id="id880"/>require you to make and store the connection globally (to save device resources and reduce the possibility of a security problem) and then for every call to the database set up a set of queries and issues. Even for a trivial database, this can lead to many lines of repeated code and more the lines of code you have, the greater is the potential for bugs to crop up.</p>

    <p class="calibre9">A helper class encapsulates all of the functionalities you will need and is very easy to write.</p>

    <div><div><div><div><h2 class="title1"><a class="calibre1" id="ch11lvl2sec56"/>Writing helper class methods</h2>
          </div>
        </div>
      </div>

      <p class="calibre9">As I mentioned at the outset, <a class="calibre1" id="id881"/>databases allow you to read/write from/to a table. To start with, it makes sense to be able to read data. The following are two classes: the first returns <code class="email">List&lt;demoRow&gt;</code> and the other returns a name for the given ID.</p>

      <div><pre class="programlisting">Public List&lt;demoRow&gt; getAllListOfRows()
{
    lock (dbLock)
    {
        using (SQLiteConnection sqlCon = newSQLiteConnection(this.DBPath))
        {
            sqlCon.Execute(Constants.DBClauseSyncOff);
            sqlCon.BeginTransaction();
            List&lt;demoRow&gt; toReturn = new List&lt;demoRow&gt;();
            toReturn = sqlCon.Query&lt;demoRow&gt;("SELECT * FROMdemoRow");
                return toReturn.Count != 0 ? toReturn : newList&lt;demoRow&gt;();
        }
    }
}

public string getNameForID(int id)
{
    lock (dbLock)
    {
        using (SQLiteConnection sqlCon = newSQLiteConnection(DBPath))
        {
            sqlCon.Execute(Constants.DBClauseSyncOff);sqlCon.BeginTransaction();string toReturn = string.Empty;toReturn = sqlCon.ExecuteScalar&lt;string&gt;("SELECT NameFROM demoRow WHERE ID=?", id);
                return !string.IsNullOrEmpty(toReturn) ?toReturn : "No name found";
        }
    }
}</pre>
      </div>

      <p class="calibre9">There is very little difference between the two methods except for the database call. The List version requires a query—this is <a class="calibre1" id="id882"/>used when a non-primitive type is used and the data is expected back out. The <code class="email">ExecuteScalar</code> method expects <a class="calibre1" id="id883"/>rows that are of primitive type to be returned.</p>

      <p class="calibre9">Accessing these helper methods would be the same as accessing any other method.</p>

      <div><pre class="programlisting">string name = dm.getNameForID(3);</pre>
      </div>

      <p class="calibre9">or</p>

      <div><pre class="programlisting">List&lt;demoRow&gt; dT = dm.getListOfTables();</pre>
      </div>
    </div>

    <div><div><div><div><h2 class="title1"><a class="calibre1" id="ch11lvl2sec57"/>Adding data to the database</h2>
          </div>
        </div>
      </div>

      <p class="calibre9">Data addition comes in the <a class="calibre1" id="id884"/>form of inserting or updating, and <a class="calibre1" id="id885"/>unlike a read, data addition needs to be trapped in case the insert or update fails and the database needs to be rolled back to before the attempt to add data.</p>

      <p class="calibre9">Thankfully, an insert or update <a class="calibre1" id="id886"/>can be handled in one method.</p>

      <div><pre class="programlisting">public void AddOrUpdateTable(demoRow dTRow){
    lock (dataLock)
    {
        using (SQLiteConnection sqlCon = new SQLiteConnection( DBPath))
        {
            sqlCon.Execute(Constants.DBClauseSyncOff);
            sqlCon.BeginTransaction();
            try
            {
                if (sqlCon.Execute("UPDATE dataRow SET " +"ID=?, " + "Name=?, " +"Value=? WHERE " +"ID=?",dRow.ID,dRow.Name,dRow.Value,dRow.ID) == 0)
                {
                    sqlCon.Insert(dRow, typeof(demoRow));}
                sqlCon.Commit();
            }
            catch (Exception ex)
            {
                Console.WriteLine("Error in AddOrUpdateTable :{0}-{1}", ex.Message, ex.StackTrace);sqlCon.Rollback();
             }
        }
    }
}</pre>
      </div>

      <p class="calibre9">Again, for the preceding code to work, a single instance of <code class="email">demoRow</code> class needs to be passed into the method. Using a <code class="email">List</code> of <code class="email">demoRow</code> is simple to handle.</p>

      <div><pre class="programlisting">public void AddOrUpdateTables(List&lt;demoRow&gt;rows)
{
    foreach(demoReow row in rows)
        AddOrUpdateTable(row);
}</pre>
      </div>
    </div>
  </div>


  <div><div><div><div><h1 class="title"><a class="calibre1" id="ch11lvl1sec46"/>Data manipulation using LINQ</h1>
        </div>
      </div>
    </div>

    <p class="calibre9">Accessing a database <a class="calibre1" id="id887"/>continually puts a strain onto the system it is sitting on and if you consider the number of databases being used at any one time, it quickly becomes clear that the overhead of continually hitting the SQL service will be high.</p>

    <p class="calibre9">LINQ allows database style <a class="calibre1" id="id888"/>queries to be applied to data and the results come out. While there are many excellent books out there (quite a few of them are free), I will cover a couple of convenient methods of using LINQ within an iOS application.</p>

    <p class="calibre9">While LINQ is extremely powerful, not everything with LINQ will work without a problem when coding on iOS. The main reason is how the iPhone works. Quite simply, iOS wants to know what is going <a class="calibre1" id="id889"/>to happen <strong class="calibre2">Ahead Of Time</strong> (<strong class="calibre2">AOT</strong>). It doesn't like surprises and really doesn't like data structures it wasn't aware of. For example:</p>

    <div><pre class="programlisting">List&lt;string&gt; data = new List&lt;string&gt;();</pre>
    </div>

    <p class="calibre9">The preceding code should not cause an issue. But think of it another way—how big is <code class="email">List</code> is going to be? When you're working ahead of time, space allocations are typically finite. (For example, an array of <code class="email">int</code> values may have 20 values worth of memory reserved and nothing more, the AOT system likes this—it knows ahead of time that there will need to be 20 lots of <code class="email">int</code> reserved.)</p>

    <p class="calibre9">With this in mind, when using LINQ within an application, you may encounter random crashes—it is unlikely, but it may happen and it's worth mentioning it.</p>

    <div><div><div><div><h2 class="title1"><a class="calibre1" id="ch11lvl2sec58"/>LINQ – a whistle-stop tour</h2>
          </div>
        </div>
      </div>

      <p class="calibre9">For my examples, I'll use <a class="calibre1" id="id890"/>the <code class="email">demoRow</code> table already used in this chapter.</p>

      <div><pre class="programlisting">List&lt;demoRow&gt; myRow = dm.getListOfRows();</pre>
      </div>

      <p class="calibre9">Somewhere in the returned <code class="email">List</code> there is the name <code class="email">Fred Moriarty</code> and I want to get from <code class="email">List</code> the instance of the class with that name in it. I know there is only one instance of this name in the list.</p>

      <div><pre class="programlisting">var demo = myRow.SingleOrDefault(t=&gt;t.Name == "Fred Moriarty");</pre>
      </div>

      <p class="calibre9">The preceding code takes the table and returns the single instance. If the name is not found, <code class="email">null</code> (or the default value) is returned.</p>

      <p class="calibre9">Say my list contains a number of <code class="email">Fred Bloggs</code> instances in the <code class="email">Name</code> field.</p>

      <div><pre class="programlisting">var bloggs = myTRow.Where(t=&gt;t.Name == "Fred Bloggs").ToList();</pre>
      </div>

      <p class="calibre9">Before LINQ came along, this would have been quite a slow affair and would have required a code such as follows:</p>

      <div><pre class="programlisting">List&lt;demoRow&gt; bloggs = new List&lt;demoRow&gt;();
foreach(demoRow blog in bloggs)
{
    if (blog.Name == "Fred Bloggs")
        bloggs.Add(blog);
}</pre>
      </div>

      <p class="calibre9">The previous examples are very <a class="calibre1" id="id891"/>simple. LINQ can perform very complex operations as well, such as:</p>

      <div><pre class="programlisting">var res = from inviter in ContactListfrom tester in inviteswhere inviter.UserID == tester.UserIdselect tester;</pre>
      </div>

      <p class="calibre9">Here we have two lists (<code class="email">ContactList</code> and <code class="email">invites</code>). The LINQ query creates two loops and selects the instance tester when <code class="email">UserID</code> from the outer loop matches <code class="email">UserId</code> from the inner loop. The result is pretty much instant.</p>

      <div><div><div><div><h3 class="title2"><a class="calibre1" id="ch11lvl3sec106"/>SELECT and WHERE in LINQ – a common cause of confusion</h3>
            </div>
          </div>
        </div>

        <p class="calibre9">A very common error that at <a class="calibre1" id="id892"/>some point everyone meets with LINQ is mixing the <code class="email">WHERE</code> <a class="calibre1" id="id893"/>syntax up with the <code class="email">SELECT</code> syntax.</p>

        <p class="calibre9">The <code class="email">WHERE</code> syntax is a <a class="calibre1" id="id894"/>condition (for example, <code class="email">WHERE ID==311</code> or <code class="email">WHERE A==B</code>). It only returns the condition set. In the following example, <code class="email">testClass</code> is a list, it contains a class of which there is a string called <code class="email">Value</code>.</p>

        <div><pre class="programlisting">var retString = testClass.Where(t=&gt;t.Value == "fred").ToList();</pre>
        </div>

        <p class="calibre9">The <code class="email">retString</code> variable will <a class="calibre1" id="id895"/>contain a <code class="email">List&lt;string&gt;</code> of all results from <code class="email">testString</code> where <code class="email">Value == "fred"</code>.</p>

        <p class="calibre9">The <code class="email">SELECT</code> syntax returns something for all items in the object passed in it. The result might be the items themselves but can be something else.</p>

        <div><pre class="programlisting">var retString = inString.Select(t=&gt;t.ToUpper()).ToList();</pre>
        </div>

        <p class="calibre9">The preceding code transforms the contents of <code class="email">inString</code> to be in upper case and is output to a list.</p>

        <div><pre class="programlisting">var retString = inString.Select(t=&gt;t.Value, Func&lt;inString,outString&gt;).ToList();</pre>
        </div>

        <p class="calibre9">Here <code class="email">Func&lt;inString, outString&gt;</code> transforms the elements of <code class="email">inString</code> to <code class="email">outString</code> and outputs the element as an <code class="email">outString</code> list.</p>
      </div>

      <div><div><div><div><h3 class="title2"><a class="calibre1" id="ch11lvl3sec107"/>Using Select in LINQ</h3>
            </div>
          </div>
        </div>

        <p class="calibre9">Take the following <a class="calibre1" id="id896"/>example <a class="calibre1" id="id897"/>and remember <code class="email">Select</code> performs a transform:</p>

        <div><pre class="programlisting">string[] teams = {"Liverpool", "Everton", "Oldham", "Leeds"};
var result = teams.Select(t=&gt;t.ToUpper());
foreach (string team in result)
{
    Console.WriteLine(team);
}</pre>
        </div>

        <p class="calibre9">This will be the output:</p>

        <div><pre class="programlisting">LIVERPOOL
EVERTON
OLDHAM
LEEDS.</pre>
        </div>

        <p class="calibre9"><em class="calibre15">But what is happening?</em> The <code class="email">Select</code> statement is performed on the string array <code class="email">teams</code>. It then specifies a lambda expression (<code class="email">t=&gt;</code>) which in turn transforms the expression to be upper case (<code class="email">ToUpper()</code>).</p>

        <p class="calibre9">The <code class="email">Select</code> statement (as has been seen in the previous code) has an overloaded method as well. Again, it is a transforming method.</p>

        <div><pre class="programlisting">string[] teams = {"Liverpool", "Everton", "Oldham", "Leeds"};
var trans = teams.Select(teams, index) =&gt;new {index, str = teams.Substring(0, index)});</pre>
        </div>

        <p class="calibre9">If the code was run and a suitable <a class="calibre1" id="id898"/>output was used, you would see <code class="email">E</code>, <code class="email">Ol</code>, <code class="email">Lee</code>—the index at the start is 0, so no characters are seen.</p>
      </div>

      <div><div><div><div><h3 class="title2"><a class="calibre1" id="ch11lvl3sec108"/>Replacing SQL with LINQ</h3>
            </div>
          </div>
        </div>

        <p class="calibre9">Depending on your needs, it <a class="calibre1" id="id899"/>may be a better option to replace an SQLite database <a class="calibre1" id="id900"/>with a series of <code class="email">List&lt;T&gt;</code> classes and use LINQ to replace the SQL queries. For example, if you have a very simple database (such as our <code class="email">demoTable</code> database) which has a very limited scope for manipulation to be used, it may be a better idea to use a list of classes, add to them as you would normally do, and perform the queries using LINQ. Without the hit on the database server, this may yield a faster response time from the application.</p>

        <p class="calibre9">For a more complex table structure where the SQL itself performs a <code class="email">JOIN</code> to another table or there are complex manipulations involved, using LINQ may not result in a usable system.</p>

        <p class="calibre9">LINQ can perform <code class="email">JOIN</code> conditions as well as most other functions that SQLite can perform—just not as easily.</p>

        <p class="calibre9">Remember though, LINQ on the <a class="calibre1" id="id901"/>iPhone may decide to just die whereas SQLite won't.</p>
      </div>
    </div>
  </div>


  <div><div><div><div><h1 class="title"><a class="calibre1" id="ch11lvl1sec47"/>Summary</h1>
        </div>
      </div>
    </div>

    <p class="calibre9">Data storage on the iPhone can be simple and can also be fraught with problems. For safety and reliability, the SQLite option is preferred on the iPhone. For speed, you can't beat LINQ but you must ensure that you test the LINQ project on a physical device when using LINQ.</p>
  </div>
</body></html>