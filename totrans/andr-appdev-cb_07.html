<html><head></head><body><div><div><div><div><h1 class="title"><a id="ch07"/>Chapter 7. Alerts and Notifications</h1></div></div></div><p>In this chapter, we will cover the following topics:</p><div><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">Lights, Action, and Sound – getting the user's attention!</li><li class="listitem" style="list-style-type: disc">Creating a Toast using a custom layout</li><li class="listitem" style="list-style-type: disc">Displaying a message box with AlertDialog</li><li class="listitem" style="list-style-type: disc">Displaying a progress dialog</li><li class="listitem" style="list-style-type: disc">Lights, Action, and Sound Redux using Notifications</li><li class="listitem" style="list-style-type: disc">Creating a Media Player Notification</li><li class="listitem" style="list-style-type: disc">Making a Flashlight with a Heads-Up Notification</li></ul></div><div><div><div><div><h1 class="title"><a id="ch07lvl1sec55"/>Introduction</h1></div></div></div><p>Android provides many ways to notify your user—from non-visual methods, including sounds, lights, and vibration, to visual methods including Toasts, Dialogs, and Status Bar notifications.</p><p>Keep in mind, notifications distract your user, so it's a good idea to be very judicious when using any notification. Users like to be in control of their device (it is theirs, after all) so give them the option to enable and disable notifications as they desire. Otherwise, your user might get annoyed and uninstall your app altogether.</p><p>We'll start by reviewing the following non-UI based notification options:</p><div><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">Flash LED</li><li class="listitem" style="list-style-type: disc">Vibrate phone</li><li class="listitem" style="list-style-type: disc">Play ringtone</li></ul></div><p>Then we'll move on to visual notifications, including:</p><div><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">Toasts</li><li class="listitem" style="list-style-type: disc"><code class="literal">AlertDialog</code></li><li class="listitem" style="list-style-type: disc"><code class="literal">ProgressDialog</code></li><li class="listitem" style="list-style-type: disc">Status Bar Notifications</li></ul></div><p>The recipes that follow will show you how to implement these features in your own applications. It's worth reading the following link to understand "best practices" when using notifications:</p><div><div><h3 class="title"><a id="tip21"/>Tip</h3><p>Refer to <strong>Android Notification Design Guidelines</strong> <a id="id419" class="indexterm"/>at <a class="ulink" href="http://developer.android.com/design/patterns/notifications.html">http://developer.android.com/design/patterns/notifications.html</a>
</p></div></div></div></div>
<div><div><div><div><h1 class="title"><a id="ch07lvl1sec56"/>Lights, Action, and Sound – getting the user's attention!</h1></div></div></div><p>Most of the recipes in this chapter use the Notification object to alert your users, so this recipe will show an alternative approach for when you don't actually need a notification.</p><p>As the recipe title implies, we're going to use lights, action, and sound:</p><div><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><strong>Lights</strong>: Normally, you'd <a id="id420" class="indexterm"/>use the LED device, but that is only available through the Notification object, which we'll demonstrate later in the chapter. Instead we'll take this opportunity to use <code class="literal">setTorchMode()</code> (added in API 23—Android 6.0), to use the camera flash as a flashlight. (Note: as you'll see in the code, this feature will only work on an Android 6.0 device with a camera flash.)</li><li class="listitem" style="list-style-type: disc"><strong>Action</strong>: We'll <a id="id421" class="indexterm"/>vibrate the phone.</li><li class="listitem" style="list-style-type: disc"><strong>Sound</strong>: We'll<a id="id422" class="indexterm"/> use the <code class="literal">RingtoneManager</code> to play the default notification sound.</li></ul></div><p>As you'll see, the code for each of these is quite simple.</p><p>As demonstrated in the following <em>Lights, Action, and Sound Redux using Notifications</em> recipe, all three options: LED, vibrate, and sounds, are available through the Notification object. The Notification object would certainly be the most appropriate method to provide alerts and reminders when the user is not actively engaged in your app. But for those times when you want to provide feedback while they are using your app, these options are available. The vibrate option is a good example; if you want to provide haptic feedback to a button press (common with keyboard apps), call the vibrate method directly.</p><div><div><div><div><h2 class="title"><a id="ch07lvl2sec191"/>Getting ready</h2></div></div></div><p>Create a new project in Android Studio and call it: <code class="literal">LightsActionSound</code>. When prompted for the API level, we need API 21 or above to compile the project. Select <strong>Empty Activity</strong> when prompted for the <strong>Activity Type</strong>.</p></div><div><div><div><div><h2 class="title"><a id="ch07lvl2sec192"/>How to do it...</h2></div></div></div><p>We'll use three buttons to<a id="id423" class="indexterm"/> initiate each action, so start by opening <code class="literal">activity_main.xml</code> and follow these steps:</p><div><ol class="orderedlist arabic"><li class="listitem">Replace the existing <code class="literal">&lt;TextView&gt;</code> element with the following three buttons:<div><pre class="programlisting">&lt;ToggleButton
    android:id="@+id/buttonLights"
    android:layout_width="wrap_content"
    android:layout_height="wrap_content"
    android:text="Lights"
    android:layout_centerHorizontal="true"
    android:layout_above="@+id/buttonAction"
    android:onClick="clickLights" /&gt;
&lt;Button
    android:id="@+id/buttonAction"
    android:layout_width="wrap_content"
    android:layout_height="wrap_content"
    android:text="Action"
    android:layout_centerVertical="true"
    android:layout_centerHorizontal="true"
    android:onClick="clickVibrate"/&gt;
&lt;Button
    android:id="@+id/buttonSound"
    android:layout_width="wrap_content"
    android:layout_height="wrap_content"
    android:text="Sound"
    android:layout_below="@+id/buttonAction"
    android:layout_centerHorizontal="true"
    android:onClick="clickSound"/&gt;</pre></div></li><li class="listitem">Add the following permission to the Android Manifest:<div><pre class="programlisting">&lt;uses-permission android:name="android.permission.VIBRATE"&gt;&lt;/uses-permission&gt;</pre></div></li><li class="listitem">Open <code class="literal">ActivityMain.java</code> and add the following global variables:<div><pre class="programlisting">private CameraManager mCameraManager;
private String mCameraId=null;
private ToggleButton mButtonLights;</pre></div></li><li class="listitem">Add the following method to get the Camera ID:<div><pre class="programlisting">private String getCameraId() {
    try {
        String[] ids = mCameraManager.getCameraIdList();
        for (String id : ids) {
            CameraCharacteristics c = mCameraManager.getCameraCharacteristics(id);
            Boolean flashAvailable = c.get(CameraCharacteristics.FLASH_INFO_AVAILABLE);
            Integer facingDirection = c.get(CameraCharacteristics.LENS_FACING);
            if (flashAvailable != null &amp;&amp; flashAvailable &amp;&amp; facingDirection != null &amp;&amp; facingDirection == CameraCharacteristics.LENS_FACING_BACK) {
                return id;
            }
        }
    } catch (CameraAccessException e) {
        e.printStackTrace();
    }
    return null;
}</pre></div></li><li class="listitem">Add the following<a id="id424" class="indexterm"/> code to the <code class="literal">onCreate()</code> method:<div><pre class="programlisting">mButtonLights = (ToggleButton)findViewById(R.id.buttonLights);
if (Build.VERSION.SDK_INT &gt;= Build.VERSION_CODES.M) {
    mCameraManager = (CameraManager) this.getSystemService(Context.CAMERA_SERVICE);
    mCameraId = getCameraId();
    if (mCameraId==null) {
        mButtonLights.setEnabled(false);
    } else {
        mButtonLights.setEnabled(true);
    }
} else {
    mButtonLights.setEnabled(false);
}</pre></div></li><li class="listitem">Now add the code to handle each of the button clicks:<div><pre class="programlisting">public void clickLights(View view) {
    if (Build.VERSION.SDK_INT &gt;= Build.VERSION_CODES.M) {
        try {
            mCameraManager.setTorchMode(mCameraId, mButtonLights.isChecked());
        } catch (CameraAccessException e) {
            e.printStackTrace();
        }
    }
}

public void clickVibrate(View view) {
    ((Vibrator)getSystemService(VIBRATOR_SERVICE)).vibrate(1000);
}

public void clickSound(View view) {
    Uri notificationSoundUri = RingtoneManager.getDefaultUri(RingtoneManager.TYPE_NOTIFICATION);
    Ringtone ringtone = RingtoneManager.getRingtone(getApplicationContext(), notificationSoundUri);
    ringtone.play();
}</pre></div></li><li class="listitem">You're ready to run <a id="id425" class="indexterm"/>the application on a physical device. The code presented here will need Android 6.0 (or higher) to use the flashlight option.</li></ol></div></div><div><div><div><div><h2 class="title"><a id="ch07lvl2sec193"/>How it works...</h2></div></div></div><p>As you can see from the previous paragraphs, most of the code is related to finding and opening the camera to use the flash feature. <code class="literal">setTorchMode() </code>was introduced in API 23, which is why we have the API version check:</p><div><pre class="programlisting">if (Build.VERSION.SDK_INT &gt;= Build.VERSION_CODES.M){}</pre></div><p>This app demonstrates using the new <code class="literal">camera2</code> libraries, which were introduced in Lollipop (API 21). The <code class="literal">vibrate</code> and <code class="literal">ringtone</code> methods have both been available since API 1.</p><p>The <code class="literal">getCameraId()</code> method is where we check for the camera. We want an outward-facing camera with a flash. If one is found, the ID is returned, otherwise it is null. If the camera id is null, we disable the button.</p><p>For playing the sound, we use the <code class="literal">Ringtone</code> object from the <code class="literal">RingtoneManager</code>. Besides it being relatively easy to implement, another benefit to this method is that we can use the default notification sound, which we get with this code:</p><div><pre class="programlisting">Uri notificationSoundUri = RingtoneManager.getDefaultUri(RingtoneManager.TYPE_NOTIFICATION);</pre></div><p>This way, if the user changes their preferred notification sound, we use it automatically.</p><p>Last is the call to vibrate <a id="id426" class="indexterm"/>the phone. This was the simplest code to use, but it does require permission, which we added to the Manifest:</p><div><pre class="programlisting">&lt;uses-permission android:name="android.permission.VIBRATE"&gt;&lt;/uses-permission&gt;</pre></div></div><div><div><div><div><h2 class="title"><a id="ch07lvl2sec194"/>There's more...</h2></div></div></div><p>In a production-level application, you wouldn't want to simply disable the button if you didn't have to. In this case, there are other means to use the camera flash as a flashlight. Take a look at the multi-media chapter for additional examples on using the camera, where we'll see <code class="literal">getCameraId()</code> used again.</p></div><div><div><div><div><h2 class="title"><a id="ch07lvl2sec195"/>See also</h2></div></div></div><div><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">Refer to the <em>Lights, Action, and Sound Redux with Notifications</em> recipe later in this chapter to see the equivalent features using the Notification object</li><li class="listitem" style="list-style-type: disc">Refer to <a class="link" href="ch11.html" title="Chapter 11. Multimedia">Chapter 11</a>, <em>Multimedia</em>, for examples using the new camera API and other sound options</li></ul></div></div></div>
<div><div><div><div><h1 class="title"><a id="ch07lvl1sec57"/>Creating a Toast using a custom layout</h1></div></div></div><p>We've used Toasts<a id="id427" class="indexterm"/> quite a bit already in previous chapters as <a id="id428" class="indexterm"/>they provide a quick and easy way to display information—both for the user and for ourselves when debugging.</p><p>The previous examples have all used the simple one-line syntax, but the Toast isn't limited to this. Toasts, like most components in Android, can be customized, as we'll demonstrate in this recipe.</p><p>Android Studio offers a shortcut for making the simple Toast statement. As you start to type the Toast command, press <em>Ctrl</em> + <em>Spacebar</em> and you'll see the following:</p><div><img src="img/B05057_07_01.jpg" alt="Creating a Toast using a custom layout"/></div><p>Press <em>Enter</em> to<a id="id429" class="indexterm"/> auto-complete. Then, press <em>Ctrl</em> + <em>Spacebar</em> <a id="id430" class="indexterm"/>again and you'll see the following:</p><div><img src="img/B05057_07_02.jpg" alt="Creating a Toast using a custom layout"/></div><p>When you press <em>Enter</em> again, it will auto-complete with the following:</p><div><pre class="programlisting">Toast.makeText(MainActivity.this, "", Toast.LENGTH_SHORT).show();</pre></div><p>In this recipe, we'll use the Toast Builder to change the default layout, and gravity to create a custom Toast as shown in this screenshot:</p><div><img src="img/B05057_07_03.jpg" alt="Creating a Toast using a custom layout"/></div><div><div><div><div><h2 class="title"><a id="ch07lvl2sec196"/>Getting ready</h2></div></div></div><p>Create a new <a id="id431" class="indexterm"/>project in Android Studio and call it: <code class="literal">CustomToast</code>. Use<a id="id432" class="indexterm"/> the default <strong>Phone &amp; Tablet </strong>options and select <strong>Empty Activity</strong> when prompted for the <strong>Activity Type</strong>.</p></div><div><div><div><div><h2 class="title"><a id="ch07lvl2sec197"/>How to do it...</h2></div></div></div><p>We're going to change the shape of the Toast to a square and create a custom layout to display an image and text message. Start by opening <code class="literal">activity_main.xml</code> and follow these steps:</p><div><ol class="orderedlist arabic"><li class="listitem">Replace the existing <code class="literal">&lt;TextView&gt;</code> element with a <code class="literal">&lt;Button&gt;</code> as follows:<div><pre class="programlisting">&lt;Button
    android:layout_width="wrap_content"
    android:layout_height="wrap_content"
    android:text="Show Toast"
    android:id="@+id/button"
    android:layout_alignParentTop="true"
    android:layout_centerHorizontal="true"
    android:onClick="showToast"/&gt;</pre></div></li><li class="listitem">Create a new resource file in the <code class="literal">res/drawable</code> folder named: <code class="literal">border_square.xml</code> and type the following code:<div><pre class="programlisting">&lt;?xml version="1.0" encoding="utf-8"?&gt;
&lt;layer-list &gt;
    &lt;item
        android:left="4px"
        android:top="4px"
        android:right="4px"
        android:bottom="4px"&gt;
        &lt;shape android:shape="rectangle" &gt;
            &lt;solid android:color="@android:color/black" /&gt;
            &lt;stroke android:width="5px" android:color="@android:color/white"/&gt;
        &lt;/shape&gt;
    &lt;/item&gt;
&lt;/layer-list&gt;</pre></div></li><li class="listitem">Create a <a id="id433" class="indexterm"/>new resource file in the <code class="literal">res/layout</code> folder <a id="id434" class="indexterm"/>named: <code class="literal">toast_custom.xml</code> and type the following code:<div><pre class="programlisting">&lt;?xml version="1.0" encoding="utf-8"?&gt;
&lt;LinearLayout 
    android:id="@+id/toast_layout_root"
    android:layout_width="match_parent"
    android:layout_height="match_parent"
    android:orientation="horizontal"
    android:background="@drawable/border_square"&gt;
    &lt;ImageView
        android:layout_width="wrap_content"
        android:layout_height="wrap_content"
        android:id="@+id/imageView"
        android:layout_weight="1"
        android:src="img/ic_launcher" /&gt;
    &lt;TextView
        android:id="@android:id/message"
        android:layout_width="0dp"
        android:layout_height="match_parent"
        android:layout_weight="1"
        android:textColor="@android:color/white"
        android:padding="10dp" /&gt;
&lt;/LinearLayout&gt;</pre></div></li><li class="listitem">Now<a id="id435" class="indexterm"/> open <code class="literal">ActivityMain.java</code> and type the <a id="id436" class="indexterm"/>following method:<div><pre class="programlisting">public void showToast(View view) {
    LayoutInflater inflater = (LayoutInflater)this.getSystemService(Context.LAYOUT_INFLATER_SERVICE);
    View layout = inflater.inflate(R.layout.toast_custom, null);
    ((TextView) layout.findViewById(android.R.id.message)).setText("Custom Toast");
    Toast toast = new Toast(this);
    toast.setGravity(Gravity.CENTER, 0, 0);
    toast.setDuration(Toast.LENGTH_LONG);
    toast.setView(layout);
    toast.show();
}</pre></div></li><li class="listitem">Run the program on a device or emulator.</li></ol></div></div><div><div><div><div><h2 class="title"><a id="ch07lvl2sec198"/>How it works...</h2></div></div></div><p>This custom Toast changes the default gravity, shape, and adds an image just to show that "it can be done".</p><p>The first step is to create a new Toast layout, which we do by inflating our <code class="literal">custom_toast</code> layout. Once we have the new layout, we need to get the <code class="literal">TextView</code> so we can set our message, which we do with the standard <code class="literal">setText()</code> method. With this done, we create a Toast object and set the individual properties. We set the Toast gravity with the <code class="literal">setGravity()</code> method. The gravity determines where on the screen our Toast will display. We specify our custom layout with the <code class="literal">setView()</code> method call. And just like in the single line variation, we display the Toast with the <code class="literal">show()</code> method.</p></div></div>
<div><div><div><div><h1 class="title"><a id="ch07lvl1sec58"/>Displaying a message box with AlertDialog</h1></div></div></div><p>In <a class="link" href="ch04.html" title="Chapter 4. Menus">Chapter 4</a>, <em>Menus</em>, we created a <a id="id437" class="indexterm"/>theme to make an Activity look like a dialog. In this recipe, we'll demonstrate how to create a dialog using the <code class="literal">AlertDialog</code> class. The <code class="literal">AlertDialog</code> offers a Title, up to three buttons, and a list or custom layout area, as shown in this example:</p><div><img src="img/B05057_07_04.jpg" alt="Displaying a message box with AlertDialog"/></div><div><div><h3 class="title"><a id="note16"/>Note</h3><p>The button placement can vary depending on the OS version.</p></div></div><div><div><div><div><h2 class="title"><a id="ch07lvl2sec199"/>Getting ready</h2></div></div></div><p>Create a new project in <a id="id438" class="indexterm"/>Android Studio and call it: <code class="literal">AlertDialog</code>. Use the default <strong>Phone &amp; Tablet </strong>options and select the <strong>Empty Activity</strong> option when prompted for the <strong>Activity Type</strong>.</p></div><div><div><div><div><h2 class="title"><a id="ch07lvl2sec200"/>How to do it...</h2></div></div></div><p>To demonstrate, we'll create a <strong>Confirm Delete</strong> dialog to prompt the user for confirmation after pressing the <em>Delete</em> button. Start by opening the <code class="literal">main_activity.xml</code> layout file and follow these steps:</p><div><ol class="orderedlist arabic"><li class="listitem">Add the following <code class="literal">&lt;Button&gt;</code>:<div><pre class="programlisting">&lt;Button
    android:id="@+id/buttonClose"
    android:layout_width="wrap_content"
    android:layout_height="wrap_content"
    android:text="Delete"
    android:layout_centerVertical="true"
    android:layout_centerHorizontal="true"
    android:onClick="confirmDelete"/&gt;</pre></div></li><li class="listitem">Add the <code class="literal">confirmDelete()</code> method called by the button:<div><pre class="programlisting">public void confirmDelete(View view) {
    AlertDialog.Builder builder = new AlertDialog.Builder(this);
    builder.setTitle("Delete")
        .setMessage("Are you sure you?")
        .setPositiveButton(android.R.string.ok, new DialogInterface.OnClickListener() {
            public void onClick(DialogInterface dialog, int id) {
                Toast.makeText(MainActivity.this, "OK Pressed", Toast.LENGTH_SHORT).show();
        }})
        .setNegativeButton(android.R.string.cancel, new DialogInterface.OnClickListener() {
            public void onClick(DialogInterface dialog, int id) {
                Toast.makeText(MainActivity.this, "Cancel Pressed", Toast.LENGTH_SHORT).show();
        }});
    builder.create().show();
}</pre></div></li><li class="listitem">Run the application on a device or emulator.</li></ol></div></div><div><div><div><div><h2 class="title"><a id="ch07lvl2sec201"/>How it works...</h2></div></div></div><p>This dialog is meant to <a id="id439" class="indexterm"/>serve as a simple confirmation dialog—such as confirming a delete action. Basically, just create an <code class="literal">AlertDialog.Builder</code> object and set the properties as needed. We use a Toast message to indicate the user selection and we don't even have to close the dialog; it's taken care of by the base class.</p></div><div><div><div><div><h2 class="title"><a id="ch07lvl2sec202"/>There's more...</h2></div></div></div><p>As shown in the recipe introduction screenshot, the <code class="literal">AlertDialog</code> also has a third button, called the Neutral button, and can be set using the following method:</p><div><pre class="programlisting">builder.setNeutralButton()</pre></div><div><div><div><div><h3 class="title"><a id="ch07lvl3sec18"/>Add an icon</h3></div></div></div><p>To add an icon<a id="id440" class="indexterm"/> to the dialog, use the <code class="literal">setIcon()</code> method. Here is an example:</p><div><pre class="programlisting">.setIcon(R.mipmap.ic_launcher)</pre></div></div><div><div><div><div><h3 class="title"><a id="ch07lvl3sec19"/>Using a list</h3></div></div></div><p>We can also create a list<a id="id441" class="indexterm"/> of items to select with various list-setting methods, including:</p><div><pre class="programlisting">.setItems()
.setAdapter()
.setSingleChoiceItems()
.setMultiChoiceItems()</pre></div><p>As you can see, there are also <a id="id442" class="indexterm"/>methods for single-choice (using a radio button) and multi-choice lists (using a checkbox).</p><div><div><h3 class="title"><a id="tip22"/>Tip</h3><p>You can't use both the Message and the Lists, as <code class="literal">setMessage()</code> will take priority.</p></div></div></div><div><div><div><div><h3 class="title"><a id="ch07lvl3sec20"/>Custom Layout</h3></div></div></div><p>Finally, we can also create a <a id="id443" class="indexterm"/>custom layout, and set it using:</p><div><pre class="programlisting">.setView()</pre></div><p>If you use a custom layout and replace the standard buttons, you are also responsible for closing the dialog. Use <code class="literal">hide()</code> if you plan to reuse the dialog and <code class="literal">dismiss()</code> when finished to release the resources.</p></div></div></div>
<div><div><div><div><h1 class="title"><a id="ch07lvl1sec59"/>Displaying a progress dialog</h1></div></div></div><p>The <code class="literal">ProgressDialog</code> has<a id="id444" class="indexterm"/> been <a id="id445" class="indexterm"/>available since API 1, and is widely used. As we'll demonstrate in this recipe, it's simple to use, but keep this statement in mind (from the Android Dialog Guidelines site):</p><div><blockquote class="blockquote"><p>Avoid ProgressDialog</p><p>Android includes another dialog class called ProgressDialog that shows a dialog with a progress bar. However, if you need to indicate loading or indeterminate progress, you should instead follow the design guidelines for Progress &amp; Activity and use a ProgressBar in your layout.</p></blockquote></div><p>
<a class="ulink" href="http://developer.android.com/guide/topics/ui/dialogs.html">http://developer.android.com/guide/topics/ui/dialogs.html</a>
</p><p>This message doesn't mean the <code class="literal">ProgressDialog</code> is deprecated or is bad code. It's suggesting that the use of the <code class="literal">ProgressDialog</code> should be avoided, since the user cannot interact with your app while the dialog is displayed. If possible, use a layout that includes a progress bar, instead of using a <code class="literal">ProgressDialog</code>.</p><p>The Google Play app provides a good example. When adding items to download, Google Play shows a progress bar, but it's not a dialog, so the user can continue interacting with the app, even adding more items to download. If possible, use that approach instead.</p><p>There are times when you may not have that luxury, such as after placing an order, the user is going to expect an order confirmation. (Even with Google Play, you still see a confirmation dialog when actually purchasing apps.) So, remember, avoid the progress dialog if possible. But, for those times when something must complete before continuing, this recipe provides an example <a id="id446" class="indexterm"/>of how to use the <code class="literal">ProgressDialog</code>. The following screenshot shows the <code class="literal">ProgressDialog</code> from the recipe:</p><div><img src="img/B05057_07_05.jpg" alt="Displaying a progress dialog"/></div><div><div><div><div><h2 class="title"><a id="ch07lvl2sec203"/>Getting ready</h2></div></div></div><p>Create a new project in <a id="id447" class="indexterm"/>Android Studio and call it: <code class="literal">ProgressDialog</code>. Use the default <strong>Phone &amp; Tablet </strong>options and select <strong>Empty Activity</strong> when prompted for the <strong>Activity Type</strong>.</p></div><div><div><div><div><h2 class="title"><a id="ch07lvl2sec204"/>How to do it...</h2></div></div></div><div><ol class="orderedlist arabic"><li class="listitem">Since this is just a demonstration on using the ProgressDialog, we will create a button to show the dialog. To simulate waiting for a server response, we will use a delayed message to dismiss the dialog. To start, open <code class="literal">activity_main.xml</code> and follow these steps:</li><li class="listitem">Replace the <code class="literal">&lt;TextView&gt;</code> with the following <code class="literal">&lt;Button&gt;</code>:<div><pre class="programlisting">&lt;Button
    android:layout_width="wrap_content"
    android:layout_height="wrap_content"
    android:text="Show Dialog"
    android:id="@+id/button"
    android:layout_centerVertical="true"
    android:layout_centerHorizontal="true"
    android:onClick="startProgress"/&gt;</pre></div></li><li class="listitem">Open <code class="literal">MainActivity.java</code> and add the following two global variables:<div><pre class="programlisting">private ProgressDialog mDialog;
final int THIRTY_SECONDS=30*1000;</pre></div></li><li class="listitem">Add the <code class="literal">showDialog()</code> method referenced by the button click:<div><pre class="programlisting">public void startProgress(View view) {
    mDialog= new ProgressDialog(this);
    mDialog.setMessage("Doing something...");
    mDialog.setCancelable(false);
    mDialog.show();
    new Handler().postDelayed(new Runnable() {
        public void run() {
            mDialog.dismiss();
        }}, THIRTY_SECONDS);</pre></div></li><li class="listitem">Run the program on a device or emulator. When you press the <strong>Show Dialog</strong> button, you'll see the dialog as shown in the screen from the Intro.</li></ol></div></div><div><div><div><div><h2 class="title"><a id="ch07lvl2sec205"/>How it works...</h2></div></div></div><p>We use the <code class="literal">ProgressDialog</code> class to display our dialog. The options should be self-explanatory, but this setting is worth noting:</p><div><pre class="programlisting">mDialog.setCancelable(false);</pre></div><p>Normally, a dialog can be cancelled using the <em>back</em> key, but when this is set to false, the user is stuck on the dialog until it is hidden/dismissed from the code. To simulate a delayed response from a server, we use a <code class="literal">Handler</code> and the <code class="literal">postDelayed()</code> method. After the specified milliseconds (30,000 in this case, to represent 30 seconds), the <code class="literal">run()</code> method will be called, which <a id="id448" class="indexterm"/>dismisses our dialog.</p></div><div><div><div><div><h2 class="title"><a id="ch07lvl2sec206"/>There's more...</h2></div></div></div><p>We used the <a id="id449" class="indexterm"/>default <code class="literal">ProgressDialog</code> settings for this recipe, which creates an indeterminate dialog indicator, for example, the continuously spinning circle. If you can measure the task at hand, such as loading files, you can use a determinate style instead. Add and run this line of code:</p><div><pre class="programlisting">mDialog.setProgressStyle(ProgressDialog.STYLE_HORIZONTAL);</pre></div><p>You will get the following dialog style as an output to the preceding line of code:</p><div><img src="img/B05057_07_06.jpg" alt="There's more..."/></div></div></div>
<div><div><div><div><h1 class="title"><a id="ch07lvl1sec60"/>Lights, Action, and Sound Redux using Notifications</h1></div></div></div><p>You're probably already<a id="id450" class="indexterm"/> familiar with Notifications as they've become a prominent feature (even making their way to the desktop environment) and for good reason. They provide an excellent means to send information to your user. They provide the least intrusive option of all the alerts and notification options available.</p><p>As we saw in the first recipe, <em>Lights, Action, and Sound – getting the user's attention!</em>, lights, vibration, and sound are all very useful for getting the user's attention. That's why the Notification object includes support for all three methods, as we'll demonstrate in this recipe. Given this ability to get your user's attention, care should still be taken not to abuse your user. Otherwise, they'll likely uninstall your app. It's generally a good idea to give your users the option to enable/disable notifications and even how to present the notification—with sound or without, and so on.</p><div><div><div><div><h2 class="title"><a id="ch07lvl2sec207"/>Getting ready</h2></div></div></div><p>Create a new project in Android Studio and call it: <code class="literal">LightsActionSoundRedux</code>. Use the default <strong>Phone &amp; Tablet </strong>options and select <strong>Empty Activity</strong> when prompted for the <strong>Activity Type</strong>.</p></div><div><div><div><div><h2 class="title"><a id="ch07lvl2sec208"/>How to do it...</h2></div></div></div><p>We'll need permission to use the <a id="id451" class="indexterm"/>vibrate option, so start by opening the Android Manifest file, and follow these steps:</p><div><ol class="orderedlist arabic"><li class="listitem">Add the following permission:<div><pre class="programlisting">&lt;uses-permission android:name="android.permission.VIBRATE"/&gt;</pre></div></li><li class="listitem">Open <code class="literal">activity_main.xml</code> and replace the existing <code class="literal">&lt;TextView&gt;</code> with the following buttons:<div><pre class="programlisting">&lt;Button
    android:id="@+id/buttonSound"
    android:layout_width="wrap_content"
    android:layout_height="wrap_content"
    android:text="Lights, Action, and Sound"
    android:layout_centerVertical="true"
    android:layout_centerHorizontal="true"
    android:onClick="clickLightsActionSound"/&gt;</pre></div></li><li class="listitem">Now open <code class="literal">MainActivity.java</code> and add the following methods to handle the button click:<div><pre class="programlisting">public void clickLightsActionSound(View view) {
    Uri notificationSoundUri = RingtoneManager.getDefaultUri(RingtoneManager.TYPE_NOTIFICATION);
    NotificationCompat.Builder notificationBuilder = new NotificationCompat.Builder(this)
        .setSmallIcon(R.mipmap.ic_launcher)
        .setContentTitle("LightsActionSoundRedux")
        .setContentText("Lights, Action &amp; Sound")
        .setSound(notificationSoundUri)
        .setLights(Color.BLUE, 500, 500)
        .setVibrate(new long[]{250,500,250,500,250,500});
    NotificationManager notificationManager = (NotificationManager) this.getSystemService(Context.NOTIFICATION_SERVICE);
    notificationManager.notify(0, notificationBuilder.build());
}</pre></div></li><li class="listitem">Run the program on a device or emulator.</li></ol></div></div><div><div><div><div><h2 class="title"><a id="ch07lvl2sec209"/>How it works...</h2></div></div></div><p>First, we combined all three<a id="id452" class="indexterm"/> actions into a single notification, simply because we could. You don't have to use all three extra notification options, or even any. Only the following are required:</p><div><pre class="programlisting">.setSmallIcon()
.setContentText()</pre></div><p>If you don't set both the icon and text, the notification will not show.</p><p>Second, we used the <code class="literal">NotificationCompat</code> to build our notification. This comes from the support library and makes it easier to be backward compatible with older OS versions. If we request a notification feature that is not available on the user's version of OS, it will simply be ignored.</p><p>The three lines of code that produce our extra notification options include the following:</p><div><pre class="programlisting">.setSound(notificationSoundUri)
.setLights(Color.BLUE, 500, 500)
.setVibrate(new long[]{250,500,250,500,250,500});</pre></div><p>It's worth noting that we use the same sound URI with the notification as we did with the <code class="literal">RingtoneManager</code> from the earlier <em>Lights, Action, and Sound </em>recipe. The vibrate feature also required the same vibrate permission as the previous recipe, but notice the value we send is different. Instead of sending just a duration for the vibration, we are sending a vibrate pattern. The first value represents the <code class="literal">off</code> duration (in milliseconds), the next value represents the vibration <code class="literal">on</code> duration, and repeats.</p><div><div><h3 class="title"><a id="tip23"/>Tip</h3><p>On devices with LED notification, you won't see the LED notification while the screen is active.</p></div></div></div><div><div><div><div><h2 class="title"><a id="ch07lvl2sec210"/>There's more...</h2></div></div></div><p>This recipe shows the basics of a notification, but like many features on Android, options have expanded with later OS releases.</p><div><div><div><div><h3 class="title"><a id="ch07lvl3sec21"/>Adding a button to the notification using addAction()</h3></div></div></div><p>There are several design <a id="id453" class="indexterm"/>considerations you should keep in mind when adding action buttons, as listed in the Notification Guidelines linked in the chapter introduction. You can add a button (up to three) using the <code class="literal">addAction()</code> method on the notification builder. Here's an example of a notification with one action button:</p><div><img src="img/B05057_07_07.jpg" alt="Adding a button to the notification using addAction()"/></div><p>Here's the code to create<a id="id454" class="indexterm"/> this notification:</p><div><pre class="programlisting">NotificationCompat.Builder notificationBuilder = new NotificationCompat.Builder(this).setSmallIcon(R.mipmap.ic_launcher)
        .setContentTitle("LightsActionSoundRedux")
        .setContentText("Lights, Action &amp; Sound");
Intent activityIntent = new Intent(this,MainActivity.class);
PendingIntent pendingIntent = PendingIntent.getActivity(this,0,activityIntent,0);
notificationBuilder.addAction(android.R.drawable.ic_dialog_email, "Email", pendingIntent);
notificationManager.notify(0, notificationBuilder.build());</pre></div><p>An <code class="literal">Action</code> requires three parameters—the image, the text, and a <code class="literal">PendingIntent</code>. The first two items are for the visual display, while the third item, the <code class="literal">PendingIntent</code>, is called when the user presses the button.</p><p>The previous code creates a very simple <code class="literal">PendingIntent;</code> it just launches the app. This is probably the most common intent for notifications, and is often used for when the user presses the notification. To set the notification intent, use the following code:</p><div><pre class="programlisting">.setContentIntent(pendingIntent)</pre></div><p>A button action would probably require more information as it should take the user to the specific item in your app. You should also create an application back-stack for the best user experience. Take a look at the topic "<strong>Preserving Navigation when Starting an Activity</strong>" at the following link:</p><p>
<a class="ulink" href="http://developer.android.com/guide/topics/ui/notifiers/notifications.html#NotificationResponse">http://developer.android.com/guide/topics/ui/notifiers/notifications.html#NotificationResponse</a>
</p></div><div><div><div><div><h3 class="title"><a id="ch07lvl3sec22"/>Expanded notifications</h3></div></div></div><p>Expanded notifications <a id="id455" class="indexterm"/>were introduced in Android 4.1 (API 16) and are available by using the <code class="literal">setStyle()</code> method on the Notification Builder. If the user's OS does not support expanded notifications, the notification will appear as a normal notification.</p><p>The three expanded styles currently available in the <code class="literal">NotificationCompat</code> library include:</p><div><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><code class="literal">InboxStyle</code></li><li class="listitem" style="list-style-type: disc"><code class="literal">BigPictureStyle</code></li><li class="listitem" style="list-style-type: disc"><code class="literal">BigTextStyle</code></li></ul></div><p>Here's an example of each notification style, and the code used to create the example:</p><div><img src="img/B05057_07_08.jpg" alt="Expanded notifications"/></div><div><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><code class="literal">InboxStyle</code>:<div><pre class="programlisting">NotificationCompat.Builder notificationBuilderInboxStyle = new NotificationCompat.Builder(this).setSmallIcon(R.mipmap.ic_launcher);
NotificationCompat.InboxStyle inboxStyle = new NotificationCompat.InboxStyle();
inboxStyle.setBigContentTitle("InboxStyle - Big Content Title")
    .addLine("Line 1")
    .addLine("Line 2");
notificationBuilderInboxStyle.setStyle(inboxStyle);
notificationManager.notify(0, notificationBuilderInboxStyle.build());</pre></div><div><img src="img/B05057_07_09.jpg" alt="Expanded notifications"/></div></li><li class="listitem" style="list-style-type: disc"><code class="literal">BigPictureStyle</code>:<div><pre class="programlisting">NotificationCompat.Builder notificationBuilderBigPictureStyle = new NotificationCompat.Builder(this).setSmallIcon(R.mipmap.ic_launcher).setContentTitle("LightsActionSoundRedux").setContentText("BigPictureStyle");
NotificationCompat.BigPictureStyle bigPictureStyle = new NotificationCompat.BigPictureStyle();
bigPictureStyle.bigPicture(BitmapFactory.decodeResource(getResources(), R.mipmap.ic_launcher));
notificationBuilderBigPictureStyle.setStyle(bigPictureStyle);
notificationManager.notify(0, notificationBuilderBigPictureStyle.build());</pre></div><div><img src="img/B05057_07_10.jpg" alt="Expanded notifications"/></div></li><li class="listitem" style="list-style-type: disc"><code class="literal">BigTextStyle</code><div><pre class="programlisting">NotificationCompat.Builder notificationBuilderBigTextStyle = new NotificationCompat.Builder(this).setSmallIcon(R.mipmap.ic_launcher).setContentTitle("LightsActionSoundRedux");
NotificationCompat.BigTextStyle BigTextStyle = new NotificationCompat.BigTextStyle();
BigTextStyle.bigText("This is an example of the BigTextStyle expanded notification.");
notificationBuilderBigTextStyle.setStyle(BigTextStyle);
notificationManager.notify(0, notificationBuilderBigTextStyle.build());</pre></div></li></ul></div></div><div><div><div><div><h3 class="title"><a id="ch07lvl3sec23"/>Lock screen notifications</h3></div></div></div><p>Android 5.0 (API 21) and above can <a id="id456" class="indexterm"/>show notifications on the lock screen, based on the user's lock screen visibility. Use <code class="literal">setVisibility()</code> to specify the notification visibility using the following values:</p><div><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><code class="literal">VISIBILITY_PUBLIC</code>: All content can be displayed</li><li class="listitem" style="list-style-type: disc"><code class="literal">VISIBILITY_SECRET</code>: No content should be displayed</li><li class="listitem" style="list-style-type: disc"><code class="literal">VISIBILITY_PRIVATE</code>: Display the basic content (title and icon) but the rest is hidden</li></ul></div></div></div><div><div><div><div><h2 class="title"><a id="ch07lvl2sec211"/>See also</h2></div></div></div><div><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">See the <em>Creating a Media Player Notification</em> and <em>Making a Flashlight with a Heads-Up Notification</em> recipes for additional notification options with Android 5.0 (API 21) and greater</li></ul></div></div></div>
<div><div><div><div><h1 class="title"><a id="ch07lvl1sec61"/>Creating a Media Player Notification</h1></div></div></div><p>This recipe is going to take a<a id="id457" class="indexterm"/> look at the new Media Player style introduced in Android 5.0 (API 21). Unlike the previous recipe, <em>Lights, Action, and Sound Redux using Notifications,</em> which used <code class="literal">NotificationCompat</code>, this recipe does not, as this style is not available in the support library.</p><p>Here's a screenshot showing how the notification will appear:</p><div><img src="img/B05057_07_11.jpg" alt="Creating a Media Player Notification"/></div><p>This screenshot shows an example of the Media Player Notification on a lock screen:</p><div><img src="img/B05057_07_12.jpg" alt="Creating a Media Player Notification"/></div><div><div><div><div><h2 class="title"><a id="ch07lvl2sec212"/>Getting ready</h2></div></div></div><p>Create a new project in Android Studio and call it: <code class="literal">MediaPlayerNotification</code>. When prompted for the API level, we need API 21 (or higher) for this project. Select <strong>Empty Activity</strong> when prompted for the <strong>Activity Type</strong>.</p></div><div><div><div><div><h2 class="title"><a id="ch07lvl2sec213"/>How to do it...</h2></div></div></div><p>We just need a single button<a id="id458" class="indexterm"/> to call our code to send the notification. Open <code class="literal">activity_main.xml</code> and follow these steps:</p><div><ol class="orderedlist arabic"><li class="listitem">Replace the existing <code class="literal">&lt;TextView&gt;</code> with the following button code:<div><pre class="programlisting">&lt;Button
    android:layout_width="wrap_content"
    android:layout_height="wrap_content"
    android:text="Show Notification"
    android:id="@+id/button"
    android:layout_centerVertical="true"
    android:layout_centerHorizontal="true"
    android:onClick="showNotification"/&gt;</pre></div></li><li class="listitem">Open <code class="literal">MainActivity.java</code> and add the <code class="literal">showNotification()</code> method:<div><pre class="programlisting">@Deprecated
public void showNotification(View view) {
    Intent activityIntent = new Intent(this,MainActivity.class);
    PendingIntent pendingIntent = PendingIntent.getActivity(this, 0, activityIntent, 0);

    Notification notification;
    if (Build.VERSION.SDK_INT &gt;= Build.VERSION_CODES.M) {
        notification = new Notification.Builder(this).setVisibility(Notification.VISIBILITY_PUBLIC)
            .setSmallIcon(Icon.createWithResource(this, R.mipmap.ic_launcher))
            .addAction(new Notification.Action.Builder(Icon.createWithResource(this, android.R.drawable.ic_media_previous), "Previous", pendingIntent).build())
            .addAction(new Notification.Action.Builder(Icon.createWithResource(this, android.R.drawable.ic_media_pause), "Pause", pendingIntent).build())
            .addAction(new Notification.Action.Builder(Icon.createWithResource(this, android.R.drawable.ic_media_next), "Next", pendingIntent).build())
            .setContentTitle("Music")
            .setContentText("Now playing...")
            .setLargeIcon(Icon.createWithResource(this, R.mipmap.ic_launcher))
            .setStyle(new Notification.MediaStyle().setShowActionsInCompactView(1)).build();
    } else {
        notification = new Notification.Builder(this)
            .setVisibility(Notification.VISIBILITY_PUBLIC)
            .setSmallIcon(R.mipmap.ic_launcher)
            .addAction(new Notification.Action.Builder(android.R.drawable.ic_media_previous, "Previous", pendingIntent).build())
            .addAction(new Notification.Action.Builder(android.R.drawable.ic_media_pause, "Pause", pendingIntent).build())
            .addAction(new Notification.Action.Builder(android.R.drawable.ic_media_next, "Next", pendingIntent).build())
            .setContentTitle("Music")
            .setContentText("Now playing...")
            .setLargeIcon(BitmapFactory.decodeResource(getResources(), R.mipmap.ic_launcher))
            .setStyle(new Notification.MediaStyle()
            .setShowActionsInCompactView(1)).build();
    }
    NotificationManager notificationManager = (NotificationManager) this.getSystemService(Context.NOTIFICATION_SERVICE);
    notificationManager.notify(0, notification);
}</pre></div></li><li class="listitem">Run the program<a id="id459" class="indexterm"/> on a device or emulator.</li></ol></div></div><div><div><div><div><h2 class="title"><a id="ch07lvl2sec214"/>How it works...</h2></div></div></div><p>The first detail to note is that we decorate our <code class="literal">showNotification()</code> method with:</p><div><pre class="programlisting">@Deprecated</pre></div><p>This tells the compiler we know we are using deprecated calls. (Without this, the compiler will flag the code.) We follow this with an API check, using this call:</p><div><pre class="programlisting">if (Build.VERSION.SDK_INT &gt;= Build.VERSION_CODES.M)</pre></div><p>The icon resource was changed in API 23, but we want this application to run on API 21 (Android 5.0) and later, so we still need to call the old methods when running on API 21 and API 22.</p><p>If the user is running on Android 6.0 (or higher), we use the new <code class="literal">Icon</code> class to create our icons, otherwise we use the old constructor. (You'll notice the IDE will show the deprecated calls with a strikethrough.) Checking the current OS version during runtime is a common strategy for remaining backward compatible.</p><p>We create three actions using <code class="literal">addAction()</code> to handle the media player functionality. Since we don't really have a media player going, we use the same intent for all the actions, but you'll want to create separate intents in your application.</p><p>To make the notification visible on the lock screen, we need to set the visibility level to <code class="literal">VISIBILITY_PUBLIC</code>, which we do with the following call:</p><div><pre class="programlisting">.setVisibility(Notification.VISIBILITY_PUBLIC)</pre></div><p>This call is worth noting:</p><div><pre class="programlisting">.setShowActionsInCompactView(1)</pre></div><p>Just as the method name implies, this sets the actions to show when the notification is shown with a reduced layout. (See the lock screen image in the recipe introduction.)</p></div><div><div><div><div><h2 class="title"><a id="ch07lvl2sec215"/>There's more...</h2></div></div></div><p>We only created the visual notification in this recipe. If we were creating an actual media player, we could instantiate a <code class="literal">MediaSession</code> class and pass in the session token with this call:</p><div><pre class="programlisting">.setMediaSession(mMediaSession.getSessionToken())</pre></div><p>This will allow the system to recognize the media content and react accordingly, such as updating the lock screen with the current album artwork.</p></div><div><div><div><div><h2 class="title"><a id="ch07lvl2sec216"/>See also</h2></div></div></div><div><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">Refer to <strong>Developer doc – MediaSession</strong><a id="id460" class="indexterm"/> at <a class="ulink" href="https://developer.android.com/reference/android/media/session/MediaSession.html">https://developer.android.com/reference/android/media/session/MediaSession.html</a></li><li class="listitem" style="list-style-type: disc">The<em> Lock Screen Visibility</em> section in the <em>Lights, Action, and Sound Redux using Notifications</em> recipe discusses the visibility options.</li></ul></div></div></div>
<div><div><div><div><h1 class="title"><a id="ch07lvl1sec62"/>Making a Flashlight with a Heads-Up Notification</h1></div></div></div><p>Android 5.0—Lollipop (API 21) introduced<a id="id461" class="indexterm"/> a new type of notification <a id="id462" class="indexterm"/>called the Heads-Up Notification. Many people do not care for this new notification as it can be extremely intrusive, as it forces its way on top of other apps. (See the following screenshot.) Keep this in mind when using this type of notification. We're going to demonstrate the Heads-Up Notification with a Flashlight as this demonstrates a good use-case scenario.</p><p>Here's a screenshot showing the Heads-Up Notification we'll create further on:</p><div><img src="img/B05057_07_13.jpg" alt="Making a Flashlight with a Heads-Up Notification"/></div><p>If you have a device running Android 6.0, you may have noticed the new Flashlight settings option. As a demonstration, we're going to create something similar in this recipe.</p><div><div><div><div><h2 class="title"><a id="ch07lvl2sec217"/>Getting ready</h2></div></div></div><p>Create a new project in Android Studio and call it: <code class="literal">FlashlightWithHeadsUp</code>. When prompted for the API level, we need API 23 (or higher) for this project. Select <strong>Empty Activity</strong> when prompted for the <strong>Activity Type</strong>.</p></div><div><div><div><div><h2 class="title"><a id="ch07lvl2sec218"/>How to do it...</h2></div></div></div><p>Our activity layout will consist of just a <code class="literal">ToggleButton</code> to control the flashlight mode. We'll be using the same <code class="literal">setTorchMode()</code> code as the <em>Lights, Action, and Sound – getting the user's attention!</em> recipe presented earlier, and add a Heads-Up Notification. We'll need permission to use the vibrate option, so start by opening the Android Manifest and following these steps:</p><div><ol class="orderedlist arabic"><li class="listitem">Add the following permission:<div><pre class="programlisting">&lt;uses-permission android:name="android.permission.VIBRATE"/&gt;</pre></div></li><li class="listitem">Specify that we only want a single instance of <code class="literal">MainActivity</code> by adding <code class="literal">android:launchMode="singleInstance"</code> to the <code class="literal">&lt;MainActivity&gt;</code> element. It will look as follows:<div><pre class="programlisting">&lt;activity android:name=".MainActivity"
    android:launchMode="singleInstance"&gt;</pre></div></li><li class="listitem">With the <a id="id463" class="indexterm"/>changes to <code class="literal">AndroidManifest</code> done, open<a id="id464" class="indexterm"/> the <code class="literal">activity_main.xml</code> layout and replace the existing <code class="literal">&lt;TextView&gt;</code> element with this <code class="literal">&lt;ToggleButton&gt;</code> code:<div><pre class="programlisting">&lt;ToggleButton
    android:id="@+id/buttonLight"
    android:layout_width="wrap_content"
    android:layout_height="wrap_content"
    android:text="Flashlight"
    android:layout_centerVertical="true"
    android:layout_centerHorizontal="true"
    android:onClick="clickLight"/&gt;</pre></div></li><li class="listitem">Now open <code class="literal">ActivityMain.java</code> and add the following global variables:<div><pre class="programlisting">private static final String ACTION_STOP="STOP";
private CameraManager mCameraManager;
private String mCameraId=null;
private ToggleButton mButtonLight;</pre></div></li><li class="listitem">Add the following code to the <code class="literal">onCreate()</code> to set up the camera:<div><pre class="programlisting">mButtonLight = (ToggleButton)findViewById(R.id.buttonLight);

mCameraManager = (CameraManager) this.getSystemService(Context.CAMERA_SERVICE);
mCameraId = getCameraId();
if (mCameraId==null) {
    mButtonLight.setEnabled(false);
} else {
    mButtonLight.setEnabled(true);
}</pre></div></li><li class="listitem">Add the following method to handle the response when the user presses the notification:<div><pre class="programlisting">@Override
protected void onNewIntent(Intent intent) {
    super.onNewIntent(intent);
    if (ACTION_STOP.equals(intent.getAction())) {
        setFlashlight(false);
    }
}</pre></div></li><li class="listitem">Add the method to get the camera id:<div><pre class="programlisting">private String getCameraId() {
    try {
        String[] ids = mCameraManager.getCameraIdList();
        for (String id : ids) {
            CameraCharacteristics c = mCameraManager.getCameraCharacteristics(id);
            Boolean flashAvailable = c.get(CameraCharacteristics.FLASH_INFO_AVAILABLE);
            Integer facingDirection = c.get(CameraCharacteristics.LENS_FACING);
            if (flashAvailable != null &amp;&amp; flashAvailable &amp;&amp; facingDirection != null &amp;&amp; facingDirection == CameraCharacteristics.LENS_FACING_BACK) {
                return id;
            }
        }
    } catch (CameraAccessException e) {
        e.printStackTrace();
    }
    return null;
}</pre></div></li><li class="listitem">Add these<a id="id465" class="indexterm"/> two methods to <a id="id466" class="indexterm"/>handle the flashlight mode:<div><pre class="programlisting">public void clickLight(View view) {
    setFlashlight(mButtonLight.isChecked());
    if (mButtonLight.isChecked()) {
        showNotification();
    }
}

private void setFlashlight(boolean enabled) {
    mButtonLight.setChecked(enabled);
    try {
        mCameraManager.setTorchMode(mCameraId, enabled);
    } catch (CameraAccessException e) {
        e.printStackTrace();
    }
}</pre></div></li><li class="listitem">Finally, add this method to create the notification:<div><pre class="programlisting">private void showNotification() {
    Intent activityIntent = new Intent(this,MainActivity.class);
    activityIntent.setAction(ACTION_STOP);
    PendingIntent pendingIntent = PendingIntent.getActivity(this,0,activityIntent,0);
    final Builder notificationBuilder = new Builder(this).setContentTitle("Flashlight")
        .setContentText("Press to turn off the flashlight")
        .setSmallIcon(R.mipmap.ic_launcher)
        .setLargeIcon(BitmapFactory.decodeResource(getResources(), R.mipmap.ic_launcher))
        .setContentIntent(pendingIntent)
        .setVibrate(new long[]{DEFAULT_VIBRATE})
        .setPriority(PRIORITY_MAX);
    NotificationManager notificationManager = (NotificationManager) this.getSystemService(Context.NOTIFICATION_SERVICE);
    notificationManager.notify(0, notificationBuilder.build());
}</pre></div></li><li class="listitem">You're ready<a id="id467" class="indexterm"/> to run the application <a id="id468" class="indexterm"/>on a physical device. As noted previously, you'll need an Android 6.0 (or higher) device, with an outward-facing camera flash.</li></ol></div></div><div><div><div><div><h2 class="title"><a id="ch07lvl2sec219"/>How it works...</h2></div></div></div><p>Since this recipe uses the same flashlight code as <em>Lights, Action, and Sound – getting the user's attention!</em>, we'll jump to the <code class="literal">showNotification()</code> method. Most of the notification builder calls are the same as previous examples, but there are two significant differences:</p><div><pre class="programlisting">.setVibrate()
.setPriority(PRIORITY_MAX)</pre></div><div><div><h3 class="title"><a id="tip24"/>Tip</h3><p>Notifications will not be escalated to Heads-Up Notifications unless the priority is set to <code class="literal">HIGH</code> (or above) and uses either vibrate or sound.</p><p>Note this from the Developer documentation given at: <a class="ulink" href="http://developer.android.com/reference/android/app/Notification.html#headsUpContentView">http://developer.android.com/reference/android/app/Notification.html#headsUpContentView</a>:</p><p>"At its discretion, the system UI may choose to show this as a heads-up notification."</p></div></div><p>We create a <code class="literal">PendingIntent</code> as we've done previously, but here we set the action with:</p><div><pre class="programlisting">activityIntent.setAction(ACTION_STOP);</pre></div><p>We set the app to only allow a single instance in the <code class="literal">AndroidManifest</code> file, as we don't want to start a new <a id="id469" class="indexterm"/>instance of the app when the user <a id="id470" class="indexterm"/>presses the notification. The <code class="literal">PendingIntent</code> we created sets the action, which we check in the <code class="literal">onNewIntent()</code> callback. If the user opens the app without pressing the notification, they can still disable the flashlight with the <code class="literal">ToggleButton</code>.</p></div><div><div><div><div><h2 class="title"><a id="ch07lvl2sec220"/>There's more...</h2></div></div></div><p>Just like in the <em>Creating a Toast using a custom layout</em> recipe earlier, we can use a custom layout with notifications. Use the following method on the builder to specify the layout:</p><div><pre class="programlisting">headsupContentView()</pre></div></div><div><div><div><div><h2 class="title"><a id="ch07lvl2sec221"/>See also</h2></div></div></div><div><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">Refer to the <em>Lights, Action, and Sou</em><em>nd – getting the user's attention!</em> recipe</li></ul></div></div></div></body></html>