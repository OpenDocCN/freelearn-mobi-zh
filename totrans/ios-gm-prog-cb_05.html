<html><head></head><body>
<div><div><div><div><div><h1 class="title" id="calibre_pb_0"><a id="ch05" class="calibre1"/>Chapter 5. Adding Music to iOS Games and an Introduction to iCloud</h1></div></div></div><p class="calibre8">In this chapter, we will be focusing on the following recipes:</p><div><ul class="itemizedlist"><li class="listitem">Adding music to games</li><li class="listitem">Adding background and sound effects</li><li class="listitem">Introduction to iCloud</li><li class="listitem">Integration of iCloud with iOS games</li></ul></div></div>

<div><div><div><div><div><h1 class="title" id="calibre_pb_1"><a id="ch05lvl1sec30" class="calibre1"/>Introduction</h1></div></div></div><p class="calibre8">In <a class="calibre1" title="Chapter 4. Particle System and Game Performance" href="part0031_split_000.html#page">Chapter 4</a>, <em class="calibre9">Particle System and Game Performance</em>, we created a full game of collecting coins by FlyingSpaceship containing sprites, scenes, parallax infinite scrolling background, particle effects, and many more except music. Now we are moving forward to add the most interesting part to the game, which is music. Music and sound effects brings a sense of engagement and fun to the game; no game exists without music. So we will be integrating some cool and awesome background music and sound effects into the FlyingSpaceship game built in the previous chapters. Moreover, we will be enlightening a new technology called iCloud and its framework recently released by Apple. Using iCloud, we can easily and securely store and retrieve the app data like a database from the iCloud, which is provided by Apple.</p></div></div>

<div><div><div><div><div><h1 class="title" id="calibre_pb_0"><a id="ch05lvl1sec31" class="calibre1"/>Adding music to games</h1></div></div></div><p class="calibre8">No<a id="id181" class="calibre1"/> video or movie is complete without music and neither is a game. Our end <a id="id182" class="calibre1"/>goal in this topic is to integrate some smoothing and awesome sound effects to make it look like a complete game that can be enjoyed by the user. So, in iOS development, there are many ways to integrate and play audio in an app or in a game. Some are system sound services, AVAudioPlayer, audio queue services, and OpenAL. All are used for some or the other purpose and utility in an app.</p><p class="calibre8">In this recipe, we <a id="id183" class="calibre1"/>will be discussing different ways of integrating music and sound effects provided by iOS. And in the upcoming section, we will integrate background music and some sound effects at specific events happening in our FlyingSpaceship game, which will be the starter kit for this chapter.</p></div>

<div><div><div><div><div><h2 class="title1" id="calibre_pb_1"><a id="ch05lvl2sec75" class="calibre1"/>Getting ready</h2></div></div></div><p class="calibre8">Before <a id="id184" class="calibre1"/>starting with the technical ways of integrating music and sound effects in the game, we should have an understanding of how audio is added in videos, movies, or wherever audio is required. In a game, there has to be background music and some sound effects at the events that need the attention of the user. All these music and sound effects are to be decided on the basis of the theme of the game. So the prerequisite for this section is to have a common sense of music and sound effects.</p></div></div>

<div><div><div><div><div><h2 class="title1" id="calibre_pb_2"><a id="ch05lvl2sec76" class="calibre1"/>How to do it...</h2></div></div></div><p class="calibre8">Now we will look at <a id="id185" class="calibre1"/>some of the ways to implement sound services in our app.</p><div><div><div><div><h3 class="title2"><a id="ch05lvl3sec03" class="calibre1"/>System Sound Services</h3></div></div></div><p class="calibre8">This is an easy way <a id="id186" class="calibre1"/>of playing audio files. For playing an audio sound using System Sound Services and to see how it works, the following are the<a id="id187" class="calibre1"/> steps involved:</p><div><ol class="orderedlist"><li class="listitem" value="1">Add an audio file to the project, and using <code class="email">mainBundle</code> get the path of the audio file:<div><pre class="programlisting">NSString *samplePath = [[NSBundle mainBundle] pathForResource:@"sample-sound" ofType:@"caf"];</pre></div></li><li class="listitem" value="2">Here we have used the <code class="email">.caf</code> format for the audio files. This is the recommended Apple format.</li><li class="listitem" value="3">Using the path, form a <code class="email">NSURL</code>, which will be used to create a <code class="email">SystemSoundID</code>:<div><pre class="programlisting">NSURL *sampleURL = [NSURL fileURLWithPath:samplePath];</pre></div></li><li class="listitem" value="4">Then create a <code class="email">systemSoundID</code> using the <code class="email">NSURL</code> formed earlier and a property declared as <code class="email">SystemSoundID</code> named <code class="email">sampleSound</code> in the code:<div><pre class="programlisting">AudioServicesCreateSystemSoundID((__bridge CFURLRef)sampleURL, &amp;self.sampleSound);</pre></div></li><li class="listitem" value="5">Finally, using the <code class="email">systemSoundID</code> that is, <code class="email">self.sampleSound</code>, play the audio file.<div><pre class="programlisting">AudioServicesPlaySystemSound(self.sampleSound);</pre></div></li><li class="listitem" value="6">For <a id="id188" class="calibre1"/>playing an audio sound using AVAudioPlayer AVFoundation framework is needed so it has to be imported and then add an audio file to the project and using <code class="email">mainBundle</code> get the path of the audio file. To import the framework add the following line of code:<div><pre class="programlisting">#import &lt;AVFoundation/AVFoundation.h&gt;</pre></div></li><li class="listitem" value="7">Now create an instance of AVAudioPlayer with content as the <code class="email">NSURL</code> of the file to be played with error.<div><pre class="programlisting">NSError *error;
AVAudioPlayer *backgroundAudioPlayer = [AVAudioPlayer alloc] initWithContentsOfURL:file error:&amp;error];</pre></div></li><li class="listitem" value="8">After that call a <code class="email">prepareToPlay</code> method on the <code class="email">AVAudioPlayer</code> object so that it prepares the audio file to be played.<div><pre class="programlisting">[backgroundAudioPlayer prepareToPlay];</pre></div></li><li class="listitem" value="9">Before playing the audio file, we can set the <code class="email">volume</code> and <code class="email">numberOfLoops</code> and lastly we can play the audio file.<div><pre class="programlisting">backgroundAudioPlayer.volume = 1.0;
backgroundAudioPlayer.numberOfLoops = -1;
[backgroundAudioPlayer play];</pre></div></li></ol><div></div></div><div><div><div><div><h3 class="title2"><a id="ch05lvl3sec04" class="calibre1"/>AVAudioPlayer</h3></div></div></div><pre></div></li></ol><div></div></div><div><div><div><div><h3 class="title2"><a id="ch05lvl3sec05" class="calibre1"/>Audio Queue Services</h3></div></div></div><p class="calibre8">Audio <a id="id191" class="calibre1"/>Queue Services<a id="id192" class="calibre1"/> is high-level audio stuff as it is a way to record and play audios. It lets your app use hardware recording and playback using microphones and loudspeakers without the knowledge of the hardware interface. It provides fine-grained timing control for scheduling playback and synchronization. For further information on Audio Queue Services see the <em class="calibre9">There's more</em> section.</pre><p class="calibre8">Above all are not suitable where there is a need for fine-grained control of audio with low latency; in such cases, only OpenAL is appropriate to be used, which is a cross-platform audio library supported by iOS. Learning OpenAL is a steep learning curve. So, to understand and implement it see, the <em class="calibre9">There's more</em> section.</p></div></div></div>

<div><div><div><div><div><h2 class="title1" id="calibre_pb_3"><a id="ch05lvl2sec77" class="calibre1"/>How it works…</h2></div></div></div><p class="calibre8">System Sound Services<a id="id193" class="calibre1"/> is particularly used for playing audio alerts and simple game sound effects such as click sound for moving a character in the game. Every sound that is played using this is assigned a <code class="email">systemSoundID</code>. All of the tracking is based on this ID, such as stopping, pausing, and different actions that can be applied on an audio. All we have to do is add this set of lines to play a sound:</p><div><pre class="programlisting">NSString *samplePath = [[NSBundle mainBundle] pathForResource:@"sample-sound" ofType:@"caf"];
NSURL *sampleURL = [NSURL fileURLWithPath:samplePath];
AudioServicesCreateSystemSoundID((__bridge CFURLRef)sampleURL, &amp;self.sampleSound);
AudioServicesPlaySystemSound(self.sampleSound);</pre></div><p class="calibre8">The <code class="email">sampleSound</code> is declared as a <code class="email">SystemSoundID</code> property so that the sound can be disposed later in the <code class="email">dealloc</code> method. If the sound is disposed immediately after the <code class="email">AudioServicesPlaySystemSound</code> method, then the sound will never play.</p><p class="calibre8">There are some disadvantages of System Sound Services, such as only <code class="email">.caf</code>, <code class="email">.aif</code>, and <code class="email">.wav</code> audio file formats are supported, sounds cannot be more than 30 seconds, and only one sound can be played at a time.</p></div></div>

<div><div><div><div><div><h2 class="title1" id="calibre_pb_4"><a id="ch05lvl2sec78" class="calibre1"/>There's more…</h2></div></div></div><p class="calibre8">Other than <a id="id194" class="calibre1"/>System Sound Services and AVAudioPlayer, there are two more advanced ways of playing audio which are Audio Queue Services used for playback and recording and OpenAL for fine-grained control of timing. You can explore Apple's docs for Core Audio overview and Audio Session Programming Guide.</p></div></div>

<div><div><div><div><div><h2 class="title1" id="calibre_pb_5"><a id="ch05lvl2sec79" class="calibre1"/>See also</h2></div></div></div><p class="calibre8">For better understanding and learning of Audio Queue Services and OpenAL, you can visit the following links:</p><div><ul class="itemizedlist"><li class="listitem"><a class="calibre1" href="https://developer.apple.com/library/mac/documentation/MusicAudio/Conceptual/AudioQueueProgrammingGuide/Introduction/Introduction.html">https://developer.apple.com/library/mac/documentation/MusicAudio/Conceptual/AudioQueueProgrammingGuide/Introduction/Introduction.html</a></li><li class="listitem"><a class="calibre1" href="https://developer.apple.com/library/ios/documentation/audiovideo/conceptual/multimediapg/usingaudio/usingaudio.html">https://developer.apple.com/library/ios/documentation/audiovideo/conceptual/multimediapg/usingaudio/usingaudio.html</a></li></ul></div></div></div>

<div><div><div><div><div><h1 class="title" id="calibre_pb_0"><a id="ch05lvl1sec32" class="calibre1"/>Adding background and sound effects</h1></div></div></div><p class="calibre8">After <a id="id195" class="calibre1"/>understanding<a id="id196" class="calibre1"/> some ways of integrating audio in the app, the most commonly used and easiest way is AVAudioPlayer. Basically, in this  recipe, we will be adding background music, which will be running forever, and some sound effects on specific events where the user's attention is required or where the user has to be notified of some change. This adding of background music and sound effects will be done in our game FlyingSpaceship built in the previous chapters.</p></div>

<div><div><div><div><div><h2 class="title1" id="calibre_pb_1"><a id="ch05lvl2sec80" class="calibre1"/>Getting ready</h2></div></div></div><p class="calibre8">Before starting with the addition of background music and sound effects on some events, we should have a good understanding of the <code class="email">AVAudioPlayer</code> class and the <code class="email">AVFoundation</code> framework. So the prerequisite for this section is to have knowledge of how to play audio using the AVAudioPlayer class as discussed in the preceding recipe.</p></div></div>

<div><div><div><div><div><h2 class="title1" id="calibre_pb_2"><a id="ch05lvl2sec81" class="calibre1"/>How to do it…</h2></div></div></div><p class="calibre8">We have the full game FlyingSpaceship built in which the addition of background music and sound effects will be done as discussed in the upcoming steps. To accomplish both, add two audio files <code class="email">background-music.caf</code> and <code class="email">coin-collected-sound.caf</code> to the resources folder of the project. Now perform the following steps:</p><div><ol class="orderedlist"><li class="listitem" value="1">Now we will add background music to make it a complete game. First of all import the module <code class="email">AVFoundation</code> in the <code class="email">FSMyScene</code> file of FlyingSpaceship.<div><pre class="programlisting">@import AVFoundation;</pre></div></li><li class="listitem" value="2">Declare <a id="id197" class="calibre1"/>a property named <code class="email">backgroundAudioPlayer</code> as an object of <code class="email">AVAudioPlayer</code>.<div><pre class="programlisting">@property (nonatomic, strong) AVAudioPlayer     *backgroundAudioPlayer;</pre></div></li><li class="listitem" value="3">As explained <a id="id198" class="calibre1"/>in the code snippet of the <em class="calibre9">AVAudioPlayer</em> section, create a path and <code class="email">NSURL</code> file using the <code class="email">background-music.caf</code> file.<div><pre class="programlisting">NSString *samplePath = [[NSBundle mainBundle] pathForResource:@"background-music.caf" ofType:nil];
NSURL *file = [NSURL fileURLWithPath:samplePath];</pre></div></li><li class="listitem" value="4">Just initialize the property <code class="email">self.backgroundAudioPlayer</code> with the new <code class="email">AVAudioPlayerobject</code>. This will also need an error object and the audio file, which we created earlier. All the errors will be logged in the object that we have passed in the parameter..<div><pre class="programlisting">NSError *error;
self.backgroundAudioPlayer = [[AVAudioPlayer alloc] initWithContentsOfURL:file error:&amp;error];
if (error)
{
   NSLog(@"Error in audio play %@",[error userInfo]);
   return;
}</pre></div></li><li class="listitem" value="5">After this, call <code class="email">prepareToPlay</code> on that object, set some volume such as 1.0, and in order to play it infinitely set <code class="email">numberOfLoops</code> to <code class="email">-1</code>.<div><pre class="programlisting">[self.backgroundAudioPlayer prepareToPlay];
self.backgroundAudioPlayer.numberOfLoops = -1;
self.backgroundAudioPlayer.volume = 1.0;</pre></div></li><li class="listitem" value="6">Finally, after all of this, play the background music that never ends.<div><pre class="programlisting">[self.backgroundAudioPlayer play];</pre></div></li><li class="listitem" value="7">After this, gather the code in a function called <code class="email">startBackgroundMusic</code> and it will look like this:<div><img src="img/00079.jpeg" alt="How to do it…" class="calibre10"/></div><p class="calibre13"> </p></li><li class="listitem" value="8">To make<a id="id199" class="calibre1"/> it play the background music, call the <code class="email">startBackgroundMusic</code> function in the <code class="email">initWithSize</code> method of <code class="email">FSMyScene</code>.</li><li class="listitem" value="9">Now, compile <a id="id200" class="calibre1"/>and run the project; you should be able to listen to the background music in the game.</li><li class="listitem" value="10">Now we will add a sound effect in the game when a coin is collected. For this, declare a property named <code class="email">coinCollectedAudioPlayer</code> as an object of AVAudioPlayer.<div><pre class="programlisting">@property (nonatomic, strong) AVAudioPlayer     *coinCollectedAudioPlayer;</pre></div></li><li class="listitem" value="11">As explained in the code snippet in the <em class="calibre9">AVAudioPlayer</em> section, create a path and a <code class="email">NSURL</code> file using <code class="email">coin-collected-sound.caf</code> file.<div><pre class="programlisting">NSString *samplePath = [[NSBundle mainBundle] pathForResource:@"coin-collected-sound.caf" ofType:nil];
NSURL *file = [NSURL fileURLWithPath:samplePath];</pre></div></li><li class="listitem" value="12">Assign an <code class="email">AVAudioPlayer</code> object with the preceding sound effect file with the error as the parameter to the <code class="email">self.coinCollectedAudioPlayer</code> property. And after creating this, check for errors, if any, print an error message, and return from there.<div><pre class="programlisting">NSError *error;
self.coinCollectedAudioPlayer = [[AVAudioPlayer alloc] initWithContentsOfURL:file error:&amp;error];
if (error)
{
   NSLog(@"Error in audio play %@",[error userInfo]);
   return;
}</pre></div></li><li class="listitem" value="13">After<a id="id201" class="calibre1"/> that, call <code class="email">prepareToPlay</code> on that object, set some volume such as 1.0 and <a id="id202" class="calibre1"/>play it once you set <code class="email">numberOfLoops</code> to <code class="email">1</code>.<div><pre class="programlisting">[self.coinCollectedAudioPlayer prepareToPlay];
self.coinCollectedAudioPlayer.numberOfLoops = 1;
self.coinCollectedAudioPlayer.volume = 1.0;</pre></div></li><li class="listitem" value="14">Finally, after all of this, play the sound effect that has to be played when the coin is collected by the spaceship.<div><pre class="programlisting">[self.coinCollectedAudioPlayer play];</pre></div></li><li class="listitem" value="15">After all of this, gather the code in a function called <code class="email">playCoinCollectedSoundEffect</code> and it will look like this:<div><img src="img/00080.jpeg" alt="How to do it…" class="calibre10"/></div><p class="calibre13"> </p></li><li class="listitem" value="16">To make it play when the coin collides with the spaceship, call the <code class="email">playCoinCollectedSoundEffect</code> function when <code class="email">spaceShipCollidedWithCoin</code> is called by the detection of a collision.</li><li class="listitem" value="17">After <a id="id203" class="calibre1"/>all the <a id="id204" class="calibre1"/>integration of background music and sound effects, our starter kit for this chapter is ready.</li></ol><div></div></div></div>

<div><div><div><div><div><h2 class="title1" id="calibre_pb_3"><a id="ch05lvl2sec82" class="calibre1"/>How it works…</h2></div></div></div><p class="calibre8">How the <a id="id205" class="calibre1"/>AVAudioPlayer works and how the background music and sound effects are played has been explained in the preceding topic. Here the difference between background music and sound effect was the <code class="email">numberOfLoops</code> property of AVAudioPlayer object. It was <code class="email">-1</code> for the background music and <code class="email">1</code> for sound effect of collecting the coin by the spaceship.</p></div></div>

<div><div><div><div><div><h2 class="title1" id="calibre_pb_4"><a id="ch05lvl2sec83" class="calibre1"/>There's more…</h2></div></div></div><p class="calibre8">Using the same AVAudioPlayer, we can play multiple sound effects together such as playing a sound of movement when the spaceship moves and the coin is collected. So for further enhancement in music and sound effects, there is no limit.</p></div></div>

<div><div><div><div><div><h2 class="title1" id="calibre_pb_5"><a id="ch05lvl2sec84" class="calibre1"/>See also</h2></div></div></div><p class="calibre8">For better understanding and learning of Core Audio in iOS, visit the link <a class="calibre1" href="https://developer.apple.com/library/mac/documentation/MusicAudio/Conceptual/CoreAudioOverview/CoreAudioEssentials/CoreAudioEssentials.html">https://developer.apple.com/library/mac/documentation/MusicAudio/Conceptual/CoreAudioOverview/CoreAudioEssentials/CoreAudioEssentials.html</a>.</p></div></div>

<div><div><div><div><div><h1 class="title" id="calibre_pb_0"><a id="ch05lvl1sec33" class="calibre1"/>Introduction to iCloud</h1></div></div></div><p class="calibre8">Apple has <a id="id206" class="calibre1"/>introduced a technology called iCloud that leverages the power of building apps using the new CloudKit framework. Using iCloud, we can easily and securely store and retrieve our app data in the form of a database in the cloud built by Apple. The CloudKit<a id="id207" class="calibre1"/> framework provides a way for users to anonymously sign into the apps with their iCloud Apple IDs without sharing their personal information. The most important part is that CloudKit makes the developer focus on the client-side app development and does the server-side application logic by iCloud itself. It also provides an authenticated, private, and public database storage services, which are for free with very high limits of storage.</p><p class="calibre8">In this recipe, we will be doing an introduction of iCloud and its framework CloudKit. We will understand how the iCloud services are enabled in Xcode, iTunes Connect, playing with provisioning profiles for development devices to integrate iCloud for apps. Later in this next section, we will integrate the iCloud service with our game FlyingSpaceship.</p></div>

<div><div><div><div><div><h2 class="title1" id="calibre_pb_1"><a id="ch05lvl2sec85" class="calibre1"/>Getting ready…</h2></div></div></div><p class="calibre8">Before starting to make a setup with iCloud and the CloudKit framework, we should know about some features of Xcode capabilities, iTunes Connect, and provisioning profiles. Also, we must have an understanding of core data, storing, and retrieving data in iOS for a smooth use and integration of the CloudKit framework. These are the prerequisites for starting to use the new technology iCloud and its framework.</p><p class="calibre8">To integrate<a id="id208" class="calibre1"/> iCloud in any app, the following steps are a must before starting with the setup to be done in Xcode:</p><div><ul class="itemizedlist"><li class="listitem">A Mac computer with Xcode 6 or later installed</li><li class="listitem">Membership in either iOS or Mac Developer Program</li><li class="listitem">Permission to create the code signing identities and provisioning profiles in Member Center</li><li class="listitem">Lastly, after all this, our Xcode project should be built without errors</li></ul></div></div></div>

<div><div><div><div><div><h2 class="title1" id="calibre_pb_2"><a id="ch05lvl2sec86" class="calibre1"/>How to do it…</h2></div></div></div><p class="calibre8">In this recipe, we will learn about the steps to enable CloudKit in our app. CloudKit is an app service provided by Apple. It is only available for the apps distributed by the App Store or the Mac App Store. CloudKit requires some additional configuration to be done from our Xcode Project. Our app must <a id="id209" class="calibre1"/>be provisioned and code signed to access the CloudKit service. So we will enable CloudKit for our FlyingSpaceship game. Perform the following steps to enable CloudKit in the Xcode project for our game:</p><div><ol class="orderedlist"><li class="listitem" value="1">Open the Xcode Project (FlyingSpaceship) in which we want to enable and use CloudKit services.</li><li class="listitem" value="2">Click on the <strong class="calibre2">Project</strong> in the Project Navigator and we can see the <strong class="calibre2">General</strong> section selected.</li><li class="listitem" value="3">Select the <strong class="calibre2">FlyingSpaceship</strong> target and then select the next section <strong class="calibre2">Capabilities</strong>.<div><img src="img/00081.jpeg" alt="How to do it…" class="calibre10"/></div><p class="calibre13"> </p></li><li class="listitem" value="4">Now, click <a id="id210" class="calibre1"/>on the first row, that is, <strong class="calibre2">iCloud</strong> and a section similar to this will open:<div><img src="img/00082.jpeg" alt="How to do it…" class="calibre10"/></div><p class="calibre13"> </p></li><li class="listitem" value="5">Now, on the right-hand side, switch to iCloud and some loading will occur.<div><img src="img/00083.jpeg" alt="How to do it…" class="calibre10"/></div><p class="calibre13"> </p></li><li class="listitem" value="6">Once the loading has finished, the iCloud will be enabled and giving options as shown in the following screenshot:<div><img src="img/00084.jpeg" alt="How to do it…" class="calibre10"/></div><p class="calibre13"> </p></li><li class="listitem" value="7">As<a id="id211" class="calibre1"/> we can see, there are are three services by iCloud; enable them as needed by the app. For now, we will enable CloudKit.<div><img src="img/00085.jpeg" alt="How to do it…" class="calibre10"/></div><p class="calibre13"> </p></li><li class="listitem" value="8">Also, a button called <strong class="calibre2">CloudKit Dashboard</strong> is visible. On clicking this button, we will be redirected to the CloudKit dashboard of the app FlyingSpaceship in Apple's iTunes Connect. The sidebar, record types to be added, and the container section of CloudKit dashboard look like this.<div><img src="img/00086.jpeg" alt="How to do it…" class="calibre10"/></div><p class="calibre13"> </p></li><li class="listitem" value="9">The dashboard<a id="id212" class="calibre1"/> is used to perform many database management tasks such as modifying schemas and records as shown in the preceding screenshot. A container's databases for an app exist both in the development and the production environment. Using the dashboard, we can play with the records creating, deleting, modifying, and so on.</li><li class="listitem" value="10">To explore sign in to the dashboard and click on the options in the left column, which has many operations to do as depicted in the following screenshot:<div><img src="img/00087.jpeg" alt="How to do it…" class="calibre10"/></div><p class="calibre13"> </p></li></ol><div></div></div></div>

<div><div><div><div><div><h2 class="title1" id="calibre_pb_3"><a id="ch05lvl2sec87" class="calibre1"/>How it works…</h2></div></div></div><p class="calibre8">The iCloud technology<a id="id213" class="calibre1"/> provides an easy and secure way of creating an app that stores a structured app and user data in a server called iCloud. Using the CloudKit framework, instances of an iCloud-enabled app, which is launched by different users on different devices, can access the assets stored in the app's database. After enabling iCloud for any app, we can make model objects for our app, which persist and are shared between multiple apps running on a large range of devices. These data or model objects are stored as records in the database and can be accessed by the authorized users.</p><p class="calibre8">iCloud is a free service provided by Apple that lets users access their personal data on all their devices by their Apple ID. It does all this by combining network-based storage dedicated APIs with full support of OS. Apple encourages building iCloud-enabled apps by providing server infrastructure, backups, and user accounts.</p><p class="calibre8">The following is a pictorial representation of iCloud's core idea, which addresses the problem of synchronization between multiple devices. A user using an iCloud app need not think about syncing his/her devices. When the user adopts iCloud storage, as depicted in the following diagram, all the changes appear automatically on all the devices that<a id="id214" class="calibre1"/> are attached to that iCloud account.</p><div><img src="img/00088.jpeg" alt="How it works…" class="calibre10"/></div><p class="calibre11"> </p></div></div>

<div><div><div><div><div><h2 class="title1" id="calibre_pb_4"><a id="ch05lvl2sec88" class="calibre1"/>There's more…</h2></div></div></div><p class="calibre8">iCloud supports many kinds of storage. The<a id="id215" class="calibre1"/> storage types are:</p><div><ul class="itemizedlist"><li class="listitem">Key-value storage <a id="id216" class="calibre1"/>such as user preferences, settings, and simple app state data</li><li class="listitem">iCloud document storage<a id="id217" class="calibre1"/> such as word-processing documents and drawings</li><li class="listitem">Core data storage <a id="id218" class="calibre1"/>for multidevice database solutions for structured content</li><li class="listitem">CloudKit storage<a id="id219" class="calibre1"/> for managing structured data ourselves and sharing among ourselves</li></ul></div><p class="calibre8">To store data on iCloud, we can use any of these depending upon our requirement and capabilities. Moving forward, we can pick these storage types and make an iCloud app for sharing the storage on multiple devices.</p></div></div>

<div><div><div><div><div><h2 class="title1" id="calibre_pb_5"><a id="ch05lvl2sec89" class="calibre1"/>See also…</h2></div></div></div><p class="calibre8">For more information on storage types, visit the link <a class="calibre1" href="https://developer.apple.com/library/ios/documentation/DataManagement/Conceptual/CloudKitQuickStart/Introduction/Introduction.html#//apple_ref/doc/uid/TP40014987-CH1-SW1">https://developer.apple.com/library/ios/documentation/DataManagement/Conceptual/CloudKitQuickStart/Introduction/Introduction.html#//apple_ref/doc/uid/TP40014987-CH1-SW1</a>.</p></div></div>

<div><div><div><div><div><h1 class="title" id="calibre_pb_0"><a id="ch05lvl1sec34" class="calibre1"/>Integration of iCloud with iOS games</h1></div></div></div><p class="calibre8">In this recipe, you will learn the steps to integrate the iCloud with iOS games. iCloud integration plays an important role in the development of the application as it helps us to support various features and enhance interdevice synchronization. In this recipe, we will explore and integrate a few features of the iCloud in our game.</p></div>

<div><div><div><div><div><h2 class="title1" id="calibre_pb_1"><a id="ch05lvl2sec90" class="calibre1"/>Getting ready</h2></div></div></div><p class="calibre8">As of now, we <a id="id220" class="calibre1"/>have finished the initial setup for playing with iCloud. As a prerequisite to integrate iCloud in any app, we must be enrolled in membership for<a id="id221" class="calibre1"/> iOS or the Mac Developer Program, and have the device provisioning profile and AppID. To accomplish this and start with the integration part, we must take a look at these two links:</p><div><ul class="itemizedlist"><li class="listitem"><a class="calibre1" href="https://developer.apple.com/library/ios/documentation/IDEs/Conceptual/AppDistributionGuide/AddingCapabilities/AddingCapabilities.html#//apple_ref/doc/uid/TP40012582-CH26">https://developer.apple.com/library/ios/documentation/IDEs/Conceptual/AppDistributionGuide/AddingCapabilities/AddingCapabilities.html#//apple_ref/doc/uid/TP40012582-CH26</a></li><li class="listitem"><a class="calibre1" href="https://developer.apple.com/library/ios/documentation/IDEs/Conceptual/AppDistributionGuide/Introduction/Introduction.html#//apple_ref/doc/uid/TP40012582">https://developer.apple.com/library/ios/documentation/IDEs/Conceptual/AppDistributionGuide/Introduction/Introduction.html#//apple_ref/doc/uid/TP40012582</a></li></ul></div><p class="calibre8">After all the configuration part is done, we can start with the integration of iCloud by CloudKit in our game FlyingSpaceship.</p></div></div>

<div><div><div><div><div><h2 class="title1" id="calibre_pb_2"><a id="ch05lvl2sec91" class="calibre1"/>How to do it…</h2></div></div></div><p class="calibre8">iCloud allows you to store and retrieve data easily from its secured server. This also provides an additional facility of sharing saved data among multiple applications. To save this data, our iCloud app places the data in a special local filesystem called the iCloud containers. It is also called <a id="id222" class="calibre1"/>
<strong class="calibre2">ubiquity container</strong>, and serves as the local representation of the corresponding iCloud storage. This data is totally separate from the rest of our app data; it is kept by the operating system.</p><p class="calibre8">For some iCloud services, our app does not communicate directly to the iCloud servers, instead, the operating system manages all this uploading and downloading of data for the devices attached to the iCloud account. However, CloudKit provides the facility to manage these activities. The following are the steps required for using these services:</p><div><ol class="orderedlist"><li class="listitem" value="1">Configure the access to our app's iCloud containers. It involves requesting entitlements and programmatically initializing these containers.</li><li class="listitem" value="2">Design the app to handle the responses of iCloud services accordingly, such as when the user signs out of iCloud and instances of our app on other devices can edit the data.</li><li class="listitem" value="3">Read/write using the proper iCloud API.</li><li class="listitem" value="4">The operating system coordinates the transition of data to and from iCloud when needed as per the design of the app.</li></ol><div></div><p class="calibre8">We have <a id="id223" class="calibre1"/>briefly discussed the iCloud containers already, so<a id="id224" class="calibre1"/> this is the time to implement the iCloud containers in our app. To implement them, we will open the <strong class="calibre2">Capabilities</strong> tab of our Xcode project, which manages the entitlements and containers of our app. When we enable iCloud in the same tab, then Xcode configures our app to the default iCloud container whose name is based on the app's bundle ID. This default container is used by most apps as shown in the following screenshot:</p><div><img src="img/00089.jpeg" alt="How to do it…" class="calibre10"/></div><p class="calibre11"> </p><p class="calibre8">If we want to build some app with data to be shared among each other, then we can enable the <strong class="calibre2">Specify custom containers</strong> option and it can be done using the following steps:</p><div><ol class="orderedlist"><li class="listitem" value="1">First of all, open <a class="calibre1" href="https://developer.apple.com/">https://developer.apple.com/</a> in the browser, and click on <strong class="calibre2">Member Center</strong>.</li><li class="listitem" value="2">Out of the six sections in the member center, go to the <strong class="calibre2">Certificates</strong>, <strong class="calibre2">Identifiers</strong>, and <strong class="calibre2">Profiles</strong> sections and then in the <strong class="calibre2">iOS</strong> section, go to <strong class="calibre2">Identifiers</strong> where a list of identifier types is present.<div><img src="img/00090.jpeg" alt="How to do it…" class="calibre10"/></div><p class="calibre13"> </p></li><li class="listitem" value="3">Click <a id="id225" class="calibre1"/>on the <strong class="calibre2">iCloud containers</strong> tab and we can <a id="id226" class="calibre1"/>see a default container there.<div><img src="img/00091.jpeg" alt="How to do it…" class="calibre10"/></div><p class="calibre13"> </p></li><li class="listitem" value="4">Now, to add another specific iCloud Container, click on the plus button at the top right<a id="id227" class="calibre1"/> of the page and then enter the ID <code class="email">iCloud.com.mb.FlyingSpaceshipShared</code>. Add some description<a id="id228" class="calibre1"/> for the container.<div><img src="img/00092.jpeg" alt="How to do it…" class="calibre10"/></div><p class="calibre13"> </p></li><li class="listitem" value="5">After executing all the preceding steps, we can find our custom AppIDs in the member center.<div><img src="img/00093.jpeg" alt="How to do it…" class="calibre10"/></div><p class="calibre13"> </p></li><li class="listitem" value="6">As the specific container is created, now go to the <strong class="calibre2">Capabilities</strong> tab of our app Xcode<a id="id229" class="calibre1"/> project. We can see an extra<a id="id230" class="calibre1"/> container visible in the <strong class="calibre2">iCloud</strong> section.<div><img src="img/00094.jpeg" alt="How to do it…" class="calibre10"/></div><p class="calibre13"> </p></li><li class="listitem" value="7">Now to use the specific container, select the <strong class="calibre2">Specify custom containers</strong> radio button then select the <code class="email">iCloud.com.mb.FlyingSpaceshipShared</code> container.</li></ol><div></div><p class="calibre8">Now we will prepare our code for iCloud. We will be incorporating some initial setup in the code for iCloud services to be used by the app. Firstly, when the user launches an iCloud-enabled FlyingSpaceship game for the first time, we should invite them to use iCloud. The choice should be all or none. Hence, to invite the user to use iCloud, the following are the steps of the initial setup:</p><div><ol class="orderedlist"><li class="listitem" value="1">In our app launch in the <code class="email">application:didFinishLauchingWithOptions</code> method, get <code class="email">ubiquityIdentityToken</code> from <code class="email">NSFileManager</code>.<div><pre class="programlisting">    NSFileManager* fileManager = [NSFileManager defaultManager];
    id currentiCloudToken = fileManager.ubiquityIdentityToken;</pre></div></li><li class="listitem" value="2">Then archive the iCloud availability in the user defaults database by the <code class="email">ubiquityIdentityToken</code> property fetched using <code class="email">NSFileManager</code>.<div><pre class="programlisting"> if (currentiCloudToken)
    {
    NSData *newTokenData = [NSKeyedArchiver archivedDataWithRootObject:currentiCloudToken];
      [[NSUserDefaults standardUserDefaults]setObject:newTokenData forKey:@"com.mb.FlyingSpaceship.UbiquityIdentityToken"];
    }
    else
    {
      [[NSUserDefaults standardUserDefaults] removeObjectForKey: @"com.mb.FlyingSpaceship.UbiquityIdentityToken"];
    }</pre></div></li><li class="listitem" value="3">Now<a id="id231" class="calibre1"/> the <code class="email">currentiCloudToken</code> function <a id="id232" class="calibre1"/>saved is the unique token representing the currently active iCloud account. Using this we can compare to detect whether the current account is different from the previous one.</li><li class="listitem" value="4">When the user will enables airplane mode, iCloud will itself become inaccessible, but the current iCloud account will remain signed in and <code class="email">ubiquityIdentityToken</code> contains the token of the current iCloud account.</li><li class="listitem" value="5">For the user who signs out of iCloud, the value of <code class="email">ubiquityIdentityToken</code> sets to <code class="email">nil</code>. So to receive notification, we should register as an observer of the <code class="email">NSUbiquityIdentityDidChangeNotification</code> notification where the token is received. This is a notification for iCloud availability change and we can handle it accordingly in the notification selector <code class="email">iCloudAccountAvailabilityChanged</code>.<div><pre class="programlisting">[[NSNotificationCenter defaultCenter] addObserver:selfselector:@selector(iCloudAccountAvailabilityChanged:)name:NSUbiquityIdentityDidChangeNotification object:nil];</pre></div></li><li class="listitem" value="6">After archiving the iCloud token and registering the iCloud notification, our app is ready to show an alert view in order to show invites to the user iCloud with two options: local only and use iCloud. For this, first of all save a Boolean variable for <code class="email">FirstLaunchWithiCloudAvailable</code> when the token is retrieved:<div><pre class="programlisting">  BOOL firstLaunchWithiCloudAvailable = [[NSUserDefaults standardUserDefaults] objectForKey:@"FirstLaunchWithiCloudAvailable"];
  if (firstLaunchWithiCloudAvailable == NO)
    {
      [[NSUserDefaults standardUserDefaults] setObject:[NSNumber numberWithBool:YES]
      forKey:@"FirstLaunchWithiCloudAvailable"];
    }
  [[NSUserDefaults standardUserDefaults] synchronize];</pre></div></li><li class="listitem" value="7">Also, call a method <code class="email">showiCloudInviteAlertView</code> always in <code class="email">didFinishLauchingWithOptions</code> . In this method, show the alert view to invite <a id="id233" class="calibre1"/>the user to use iCloud if a current token exists (it will exist only if the user is<a id="id234" class="calibre1"/> logged in to the iCloud Account, otherwise <code class="email">NIL</code> will be returned) and also if the <code class="email">FirstLaunchWithiCloudAvailable</code> bool is YES.<div><pre class="programlisting">- (void)showiCloudInviteAlertView
{
    BOOL firstLaunchWithiCloudAvailable = [[NSUserDefaults standardUserDefaults] objectForKey:@"FirstLaunchWithiCloudAvailable"];

    if (currentiCloudToken &amp;&amp; firstLaunchWithiCloudAvailable)
    {
     UIAlertView *alertView = [[UIAlertView alloc]  initWithTitle: @"Choose Storage Option" message: @"Should documents be stored in iCloud and available on all your devices?"
            delegate: self
               cancelButtonTitle: @"Local Only"
           otherButtonTitles: @"Use iCloud", nil];
        [alertView show];
    }
}</pre></div></li></ol><div></div><p class="calibre8">After all these changes, the <code class="email">didFinishLauchingWithOptions:</code> method will look like this:</p><div><img src="img/00095.jpeg" alt="How to do it…" class="calibre10"/></div><p class="calibre11"> </p></div></div>

<div><div><div><div><div><h2 class="title1" id="calibre_pb_3"><a id="ch05lvl2sec92" class="calibre1"/>How it works…</h2></div></div></div><p class="calibre8">If we start <a id="id235" class="calibre1"/>exploring iCloud Containers, then we will notice that depending on the design of the app in respect to iCloud integration, either the default container is selected or a custom container is created; the iCloud services are to be configured accordingly. If we do not make any custom container, then the default container will be configured, whose name will be based on the app's bundle ID.</p><p class="calibre8">And in order <a id="id236" class="calibre1"/> to share the data, the <strong class="calibre2">Specify custom container identifiers</strong> checkbox in the <strong class="calibre2">Capabilities</strong> tab of iCloud is used to add one or more container IDs. We need to specify the ID for the custom container created. For multiple container IDs, the first ID is the app's primary iCloud container.</p><p class="calibre8">With respect to custom iCloud containers, the sharing will be available on devices that are signed in to the iCloud account of the same app.</p><p class="calibre8">Now we will discuss the ways to prepare the code for iCloud. If the user is logged in to the iCloud account for the app, then only <code class="email">ubiquityIdentityToken</code> will be returned; otherwise <code class="email">nil</code> will be returned. And this token is retrieved using the <code class="email">NSFileManager</code> object. It is also saved if it exists for further use in the app according to the design of the app with respect to iCloud integration.</p><p class="calibre8">We are subscribing to notifications using <code class="email">NSUbiquityIdentityDidChangeNotification</code> to get a callback of all the changes in <code class="email">ubiquityIdentityToken</code>. For example, it will give a callback whenever the user is logged out.</p><p class="calibre8">Sometimes iCloud <a id="id237" class="calibre1"/>may not be available to our app; at that time, the account becomes unavailable while the app is running in the background. So the app must remove all the references to user-specific iCloud storage and refresh the user interface that is dependent on the iCloud Storage.</p><p class="calibre8">After the token is <a id="id238" class="calibre1"/>saved and the notification for <code class="email">UbiquityIdentityChange</code> is registered, the app becomes ready to show an alert to use iCloud. According to the selection of the user, the relevant iCloud APIs such as key-value storage, iCloud document storage, and CloudKit storage are used in the code for further handling of iCloud data.</p></div></div>

<div><div><div><div><div><h2 class="title1" id="calibre_pb_4"><a id="ch05lvl2sec93" class="calibre1"/>There's more…</h2></div></div></div><p class="calibre8">As described in preceding sections, there are many iCloud Storage APIs available in iCloud technology such as key-value storage, iCloud document storage, and CloudKit storage. From all of these, the proper selection of APIs depends upon the purpose that has to be accomplished. Hence, as a trial, the user data of the FlyingSpaceship game can be used to store in the iCloud servers and share it by using any suitable APIs mentioned previously.</p><p class="calibre8">To study more and for proper decision making, we can take a look at the link:</p><p class="calibre8">
<a class="calibre1" href="https://developer.apple.com/library/ios/documentation/General/Conceptual/iCloudDesignGuide/Chapters/iCloudFundametals.html#//apple_ref/doc/uid/TP40012094-CH6-SW28">https://developer.apple.com/library/ios/documentation/General/Conceptual/iCloudDesignGuide/Chapters/iCloudFundametals.html#//apple_ref/doc/uid/TP40012094-CH6-SW28</a>.</p></div></div>

<div><div><div><div><div><h2 class="title1" id="calibre_pb_5"><a id="ch05lvl2sec94" class="calibre1"/>See also</h2></div></div></div><p class="calibre8">For more information and integration of iCloud in any app, we can visit the link:</p><p class="calibre8">
<a class="calibre1" href="https://developer.apple.com/library/ios/documentation/General/Conceptual/iCloudDesignGuide/Chapters/Introduction.html#//apple_ref/doc/uid/TP40012094-CH1-SW1">https://developer.apple.com/library/ios/documentation/General/Conceptual/iCloudDesignGuide/Chapters/Introduction.html#//apple_ref/doc/uid/TP40012094-CH1-SW1</a>.</p></div></div></body></html>