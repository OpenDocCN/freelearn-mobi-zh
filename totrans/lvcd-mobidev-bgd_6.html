<html><head></head><body><div><div><div><div><h1 class="title"><a id="ch06"/>Chapter 6. Making a Reminder Application</h1></div></div></div><p>
<em>Note to self…</em>
</p><p>
<em>To-do lists, alarms, birthday reminders, notes, shopping lists, and the list goes on. There should be an app to keep a list of the different apps that keep lists! At the time of writing this book, there were already over 8,000 iOS apps that were lists, planners, or alarms. Perhaps, there's room for one more…</em>
</p><p>It could take a lot of research, and money, to explore all the reminder apps that are out there. The majority of apps will have a lot of features that you'll never use and at least one vital feature that is missing. If you're lucky, some combination of apps may do all the things you want in a reminder. However, don't forget that you use LiveCode and can make your own reminder app!</p><p>In this chapter, we will:</p><div><ul class="itemizedlist"><li class="listitem">Discuss what is meant by a <em>reminder</em></li><li class="listitem">Create some time measuring utility functions</li><li class="listitem">Define a data structure to store information about an event</li><li class="listitem">Make use of mobile device "notifications"</li><li class="listitem">Create a flexible reminder app</li></ul></div><div><div><div><div><h1 class="title"><a id="ch06lvl1sec74"/>Different types of reminders</h1></div></div></div><p>Here is the <a id="id415" class="indexterm"/>list of a few of the things that you might call a "reminder":</p><div><ul class="itemizedlist"><li class="listitem">A shopping list</li><li class="listitem">A Christmas present list</li><li class="listitem">A to-do list</li><li class="listitem">An alarm clock</li><li class="listitem">An egg timer</li><li class="listitem">A birthday reminder</li></ul></div><p>Now, is there a single way to describe all of these things? Well, it may get wordy, but a reminder could be described as a notification message or sound that either appears automatically or shows when you look for it. It is used to let you know that a certain time has passed, a moment has arrived, or that an outstanding task has not been completed.</p><p>See, pretty wordy. Breaking <a id="id416" class="indexterm"/>it down like this helps us to see what features a reminder app will need to have. Before getting to that, let's test the definition against the preceding examples:</p><p>
<strong>A shopping list</strong>: In this <a id="id417" class="indexterm"/>case, you go looking for the reminder. Although, we could set it up to automatically show when your location happens to be near the store! Other than that, this is effectively a task that has not been completed.</p><p>
<strong>A Christmas present list</strong>: This <a id="id418" class="indexterm"/>is much the same as a shopping list, but it could use a timed message that let's you know how few shopping days are left for you to buy a Christmas present for your loved ones.</p><p>
<strong>A to-do list</strong>: Again, this <a id="id419" class="indexterm"/>is simply a list of tasks that are not yet complete.</p><p>
<strong>An alarm clock</strong>: This gives <a id="id420" class="indexterm"/>you a notification that a moment in time has been reached.</p><p>
<strong>An egg timer</strong>: This is a notification <a id="id421" class="indexterm"/>of a certain amount of time that has passed, which could be used as a sequence of such events that might be used in a cooking-buddy app.</p><p>
<strong>A birthday reminder</strong>: This shows <a id="id422" class="indexterm"/>whether a certain moment has been reached. Really though, you want to set the reminder so that it can notify you ahead of the actual event.</p><p>At least as a starting point, we can use the definition to guide us as we outline the abilities the app will need to have.</p></div></div>
<div><div><div><div><h1 class="title"><a id="ch06lvl1sec75"/>Timing of notifications</h1></div></div></div><p>The mobile notifications that <a id="id423" class="indexterm"/>can be created with LiveCode will be sent the moment you ask for it to be sent. Strangely though, the value is based on the number of seconds since midnight on January 1st, 1970, specifically, in part of London! Well, it's named after an area of London called Greenwich.</p><p>
<strong>Greenwich Mean Time</strong>, often referred to as <strong>GMT</strong>, has been used as the standard for measuring time. It is somewhat superseded by <strong>UTC</strong> (<strong>Coordinated Universal Time</strong>), but in either case, it represents the exact current time at least for <a id="id424" class="indexterm"/>countries that are within the same time zone as Greenwich. The rest of us add or subtract some amount of time from that value.</p><p>In order to adapt to the fact that the Earth doesn't go around the Sun in an exact number of days or even an exact number of quarter days, calendars are adjusted by one day every four years, though not on 100 year boundaries, except for every 400 years (for example, the year 2000 was a leap year). These adjustments are still not enough to keep the clocks on time! The <a id="id425" class="indexterm"/>clocks are out of time by about 0.6 seconds a year, and so there are "Leap Seconds" added to compensate for that. In theory, Leap Seconds could be used to subtract one second, but as of yet, this hasn't been needed, as they have only been used to add one second.</p><p>None of this affects the number of seconds since midnight of January 1, 1970, but it does mean that converting LiveCode's <strong>seconds</strong> into time and date using your own arithmetic won't give you the right time. Yet, it's still used as the basis for notifications. This value is usually referred to as <a id="id426" class="indexterm"/>Unix Time.</p><p>It doesn't matter much though if you end up sending someone a Happy Birthday message 25 seconds early! Don't worry, the way we'll calculate the notification time will take care of the oddity.</p><div><div><div><div><h2 class="title"><a id="ch06lvl2sec114"/>Date and time pickers</h2></div></div></div><p>As mentioned in the preceding section, mobile notifications use the number of seconds since midnight of January 1, 1970 and don't add on the 25 seconds, or Leap Seconds, that have occurred since then. When we present the date and time pickers to the user, the selections the user makes will come back as the actual current or future time. We will adjust for that later.</p></div></div>
<div><div><div><div><h1 class="title"><a id="ch06lvl1sec76"/>Time for action – creating date and time pickers</h1></div></div></div><p>Let's make <a id="id427" class="indexterm"/>another test-rig stack, which we'll use to try out some date <a id="id428" class="indexterm"/>and time pickers:</p><div><ol class="orderedlist arabic"><li class="listitem">Create a new Mainstack, name it <code class="literal">ReminderFunctions</code>, and save the stack.</li><li class="listitem">Add two fields and two new buttons.</li><li class="listitem">Name one field <code class="literal">dateinseconds</code> and the other <code class="literal">timeinseconds</code>.</li><li class="listitem">Name the buttons as <code class="literal">Pick Date</code> and <code class="literal">Pick Time</code>.</li><li class="listitem">Set the script of the <strong>Pick Date</strong> button to this:<div><pre class="programlisting">on mouseUp
  mobilePickDate date
  put the result into tDate
  convert tDate to seconds
  put tDate into field "dateinseconds"
end mouseUp</pre></div></li><li class="listitem">Set the <strong>Pick Time</strong> button script to this:<div><pre class="programlisting">on mouseUp
  mobilePickDate "time"
  put the result into tTime
  convert tTime to seconds
  put tTime into field timeinseconds
end mouseUp</pre></div></li><li class="listitem">Set the <a id="id429" class="indexterm"/>Standalone Application Settings so that you can test on iOS or Android.</li><li class="listitem">Choose your <a id="id430" class="indexterm"/><strong>Test Target</strong> (in the following steps, you can see that the iPhone simulator was chosen in this case) and do a <strong>Test</strong>.</li><li class="listitem">Click on the <strong>Pick Date</strong> button.</li><li class="listitem">Select <code class="literal">December 25th, 2012</code> and click on <strong>Done</strong>.</li><li class="listitem">The number of seconds from midnight of January 1, 1970 to midnight of Christmas day 2012 will be shown in the first field that you created.</li><li class="listitem">Click on the <strong>Pick Time</strong> button and set the time to <code class="literal">1 am</code>. The following image shows how the picker looks different on iOS and the Android simulator:<div><img src="img/image00283.jpeg" alt="Time for action – creating date and time pickers"/></div><p style="clear:both; height: 1em;"> </p></li><li class="listitem"> Click on <a id="id431" class="indexterm"/><strong>Done</strong> and you will see the number of seconds from <a id="id432" class="indexterm"/>midnight of January 1 1970 to 1 AM of the day you do this test in the right-hand side field.</li></ol><div></div><div><div><div><div><h2 class="title"><a id="ch06lvl2sec115"/>
<em>What just happened?</em>
</h2></div></div></div><p>We just made two simple scripts that call the native date or time picker and convert the result into seconds to then show them in a field. What is interesting to note is that for the Pick Time case, it doesn't return the number of seconds of the current day, that is, all the seconds since midnight of January 1, 1970. In order to set a notification time for a particular time of a particular date, we have to do a little arithmetic. We'll go into that a little later when we make the actual reminder app in the <em>Making the reminders app</em> section of this chapter.</p></div><div><div><div><div><h2 class="title"><a id="ch06lvl2sec116"/>Pop quiz – OA (odd acronyms!)</h2></div></div></div><p>You may have <a id="id433" class="indexterm"/>noticed that the acronym for "Coordinated Universal Time" is UTC and not CUT. Why is that?</p><div><ol class="orderedlist arabic"><li class="listitem">CUT is too common a word.</li><li class="listitem">So as not to upset the French.</li><li class="listitem">The acronym committee members were dyslexics.</li></ol><div></div><p>Answer: 2</p><p>The French may not have proactively objected, but indeed, the acronym of UTC was chosen so as to not specifically match the English version of the phrase. It also fell in nicely with the other acronyms such as UT0, UT1, and so on.</p></div></div>
<div><div><div><div><h1 class="title"><a id="ch06lvl1sec77"/>Where?</h1></div></div></div><p>There is something we can do in a mobile reminder app that would never work in a pen and paper version of a reminder; we can present the list of reminders based on where you are at the time that you check it! To make use of location, you need to know where you are now and how far your location is from the place associated with the reminder.</p><p>At the time of writing this book, there was no ability in LiveCode to directly pull in a map so that you could choose locations other than the one you are at right now. So, we'll work within that limitation.</p><div><h3 class="title"><a id="note14"/>Note</h3><p>That being <a id="id434" class="indexterm"/>said, there is <code class="literal">mergMK</code> external (for more information, refer to <a class="ulink" href="http://mergext.com">http://mergext.com</a>), which works with iOS versions before 7.0 and was being updated at the time of writing this book. You could also use a combination of HTML and JavaScript as described in the article at <a class="ulink" href="http://stackoverflow.com/questions/25629786/fetch-data-from-html-file-in-livecode">http://stackoverflow.com/questions/25629786/fetch-data-from-html-file-in-livecode</a>. However, these are both beyond the scope of this beginner's book</p></div><p>The general technique while reading a mobile device's sensors, is to start tracking a given sensor, detect when changes happen, and to stop tracking the sensor. You can take a reading from the sensor at <a id="id435" class="indexterm"/>any time between the start and stop tracking commands. You can also specify how detailed a report you want and whether you want a precise reading. The precise reading of the location would dictate whether GPS was used or not. The advantage of using GPS is that you get greater accuracy (assuming there's a clear signal at the time) and the disadvantages are that it uses more battery power, and devices that don't <a id="id436" class="indexterm"/>have GPS cannot use this feature. When using location as part of a reminder, we're mainly interested in whether you're at home, the office, or perhaps at the supermarket. So, we'll use the less precise reading, the GPS one would be an overkill.</p></div>
<div><div><div><div><h1 class="title"><a id="ch06lvl1sec78"/>Time for action – trying out native location tracking</h1></div></div></div><p>Later in this chapter, we <a id="id437" class="indexterm"/>will add in a feature to allow the app user to add a set of favorite locations. For the moment, we'll just try out the basic functions. Location doesn't work in the simulators; you'll have to try this on a real device:</p><div><ol class="orderedlist arabic"><li class="listitem">Use the test-rig stack from the preceding steps and add a <code class="literal">Get Location</code> button and a <code class="literal">location</code> field. Make sure that the <code class="literal">location</code> field is as wide as the card window; it will show three long numbers.</li><li class="listitem">Set the script of the button to the following:<div><pre class="programlisting">on mouseUp
  mobileStartTrackingSensor "location", true
  put mobileSensorReading("location", false) into field "location"
  mobileStopTrackingSensor "location"
end mouseUp</pre></div></li><li class="listitem">The <code class="literal">true</code> value in the second line is the one that defines a <em>loosely</em> value saying that we don't need the precision of GPS. The <code class="literal">false</code> value in the third line says that we don't need detailed information to be returned.</li><li class="listitem">Go to <strong>Standalone Application Settings</strong> and choose your target device as <strong>iOS</strong> or <strong>Android</strong>.</li><li class="listitem">For iOS, set the <strong>Display Name</strong>, <strong>Internal App ID</strong>, and <strong>Profile</strong>. Choose your device and SDK version):<div><img src="img/image00284.jpeg" alt="Time for action – trying out native location tracking"/></div><p style="clear:both; height: 1em;"> </p></li><li class="listitem">Also, in the iOS <strong>Requirements and Restrictions</strong> section, select <strong>Location Services</strong> and <strong>GPS</strong> as required. In the app, you will also have to accept Location Services when iOS prompts for it.</li><li class="listitem">For Android, set <a id="id438" class="indexterm"/>the <strong>Label</strong>, <strong>Identifier</strong>, and <strong>Minimum Android Version</strong> fields:<div><img src="img/image00285.jpeg" alt="Time for action – trying out native location tracking"/></div><p style="clear:both; height: 1em;"> </p></li><li class="listitem">Additionally, in the <strong>Application Permissions</strong> part of the Android settings, make sure that you have asked permission to get the <strong>Coarse Location</strong> permission:<div><img src="img/image00286.jpeg" alt="Time for action – trying out native location tracking"/></div><p style="clear:both; height: 1em;"> </p></li><li class="listitem">Select <a id="id439" class="indexterm"/><strong>Save Standalone Application</strong> and install the app onto your device. Follow the description given in <a class="link" title="Chapter 2. Getting Started with LiveCode Mobile" href="part0026.xhtml#aid-OPEK1">Chapter 2</a>, <em>Getting Started with LiveCode Mobile</em> if you need a reminder on how to do that!</li><li class="listitem">In the app, try the <strong>Pick Date</strong> and <strong>Pick Time</strong> buttons to see how they bring up the native controls and then click on the <strong>Get Location</strong> button. Three long numbers should appear in the <code class="literal">location</code> field:<div><img src="img/image00287.jpeg" alt="Time for action – trying out native location tracking"/></div><p style="clear:both; height: 1em;"> </p></li></ol><div></div><div><div><div><div><h2 class="title"><a id="ch06lvl2sec117"/>
<em>What just happened?</em>
</h2></div></div></div><p>As you can see, there is very little code needed to read a location! If this was a tracking app, you would <a id="id440" class="indexterm"/>need to keep the tracking open and have functions to respond to the change of location messages, but for our app, we just need to know where you are at the time you take a look at your list of reminders.</p><p>The numbers that are shown in the location field are the latitude, longitude, and elevation of the position of the device. However, how will we use these numbers…?</p></div><div><div><div><div><h2 class="title"><a id="ch06lvl2sec118"/>Calculating the distance between two points on the Earth</h2></div></div></div><p>The plan is to <a id="id441" class="indexterm"/>make your app able to sort your reminders list in order of distance from where you are right now. Let's say you really use this app a lot and have dozens of reminders. The reminder you created about buying some bread may be at the bottom of the list, but if you have assigned the location of the supermarket to that reminder, sorting the list while you're outside the supermarket should bring the shopping list items to the top.</p><p>When faced <a id="id442" class="indexterm"/>with a problem such as this one, how will you come to know the distance between two points on Earth; Google is a good starting place for you to find that out! It takes very little research and time to find:</p><p>
<a class="ulink" href="http://www.movable-type.co.uk/scripts/latlong.html">http://www.movable-type.co.uk/scripts/latlong.html</a>
</p><p>The article in this URL discusses the original formula for calculating this and then shows a JavaScript function. If you find it hard to convert the equation into LiveCode handlers, you ought to be able to convert the JavaScript, line by line, into the LiveCode equivalent.</p><p>No need to type <a id="id443" class="indexterm"/>this in just yet, we'll integrate it later; however, if you want to have a play, put these lines into the stack script:</p><div><pre class="programlisting">function distance lat1,lon1,lat2,lon2
  put 6371 into r
  put toRad((lat2-lat1)) into dLat
  put toRad((lon2-lon1)) into dLon
  put toRad(lat1) into lat1
  put toRad(lat2) into lat2
  put sin(dLat/2) * sin(dLat/2) + sin(dLon/2)*sin(dLon/2) * cos(lat1)*cos(lat2) into a
  put 2*atan2(sqrt(a),sqrt(1-a)) into c
  put r*c into d
  return d
end distance

function toRad pAngle
  return pAngle/180*PI
end toRad</pre></div><p>Try this in the message box:</p><div><pre class="programlisting">put distance(40,-74,51,0)</pre></div><p>This appears as shown in the following screenshot:</p><div><img src="img/image00288.jpeg" alt="Calculating the distance between two points on the Earth"/></div><p style="clear:both; height: 1em;"> </p><p>As shown in the <a id="id444" class="indexterm"/>preceding screenshot, you should see a value of <strong>5645.48065</strong>. The two locations are somewhere near New York and London, and that value would be the distance in kilometers between the two along the surface of the Earth.</p></div><div><div><div><div><h2 class="title"><a id="ch06lvl2sec119"/>Pop quiz – what floor is my apartment on?</h2></div></div></div><p>Examine the screenshot (the one timed "6:53 PM", which precedes the previous screenshot), and given the clue that the building I live in is not much above sea level, which floor do I live on?</p><div><ol class="orderedlist arabic"><li class="listitem">40th floor</li><li class="listitem">73 floors below ground</li><li class="listitem">11th floor</li><li class="listitem">I'm homeless</li></ol><div></div><p>Answer: 3</p><p>The numbers coming back from the location sensor return as latitude, longitude, and elevation. This would make the elevation on where the device was at that time be about 37.5 meters, which is much too low to be the 40th floor. There is enough information in the screenshot for you to know exactly when it was taken and where on Earth!</p></div></div>
<div><div><div><div><h1 class="title"><a id="ch06lvl1sec79"/>Information needed in a reminder</h1></div></div></div><p>We're well on the <a id="id445" class="indexterm"/>way to know how to set a time and date for the reminder notification to occur, and we will be able to sort the reminders based on the distance from where we are. However, what exact information do we need in the reminder itself?</p><p>If this were a birthday reminder app, you would just need to ask for the person's name and the date of their birthday. If it were a shopping list app, you would need the name of the item and maybe the quantity. For a timer, you would need to ask what the event is called and would need to set a time for the event.</p><p>Here though, we're trying to make a completely flexible reminder app; it would be up to the user to describe the item in whatever manner they wish. So, we'll just ask for a title and a brief description. We will also need to offer the option of setting a date, time, an associated location, and whether an alert sound should be played.</p><p>Another thing to think about is; where will we store the information for the list of reminders? While making the WebScraper app in <a class="link" title="Chapter 4. Using Remote Data and Media" href="part0056.xhtml#aid-1LCVG2">Chapter 4,</a> <em>Using Remote Data and Media</em>, we chose to duplicate the main application stack into the documents folder and to then jump into that copy of the stack. This enabled the ability to save changes to the stack. The reminder app is a simpler case; we're only trying to store a few text strings to define each reminder and it would be simpler to just write a text file using this app.</p><p>We want to allow the <a id="id446" class="indexterm"/>user to make a list of locations, so that a reminder can be associated with that location. Rather than writing a different text file, we will make the first piece of information in each entry be the function of that entry. Right now, the only two functions are <code class="literal">location</code> and <code class="literal">reminder</code>. The following is an example of how the text file might look:</p><div><pre class="programlisting">Location  Home  40.692636  -73.978376
Location  Office  40.745194  -73.985199
Reminder  Packt  Ask for more time!  1334548800  Home  false
Reminder  Boss  Buy lunch	1334592000  Office  true</pre></div><p>Between each item in the line is a tab character, which will be used to separate the parts of the entry. The structure for a location is:</p><div><ul class="itemizedlist"><li class="listitem">Function: <code class="literal">Location</code></li><li class="listitem">Location's title</li><li class="listitem">Latitude</li><li class="listitem">Longitude</li></ul></div><p>For a reminder, it's:</p><div><ol class="orderedlist arabic"><li class="listitem">Function: <code class="literal">Reminder</code></li><li class="listitem">Title</li><li class="listitem">Brief description</li><li class="listitem">Notification time in seconds since midnight of January 1, 1970</li><li class="listitem">A location associated with this reminder</li><li class="listitem">Whether to play an alert sound (<code class="literal">true</code> or <code class="literal">false</code>)</li></ol><div></div></div>
<div><div><div><div><h1 class="title"><a id="ch06lvl1sec80"/>Making the reminder app</h1></div></div></div><p>Ok, enough <a id="id447" class="indexterm"/>groundwork! Let's start making the reminder app. Rather <a id="id448" class="indexterm"/>than adding a feature at the time, along with any scripts, we'll <a id="id449" class="indexterm"/>make the various cards that will be needed to create the app's <strong>GUI</strong> (<strong>graphical user interface</strong>) first and then go back and add the scripts.</p><div><div><div><div><h2 class="title"><a id="ch06lvl2sec120"/>Laying out the cards</h2></div></div></div><p>We're going to make the <a id="id450" class="indexterm"/>first card of the stack be a place where you can see the current reminders, sort them by time or location, and add new reminders and locations. Then, we will make a second card to enter the location details and a third card to enter the details for a new reminder.</p></div></div>
<div><div><div><div><h1 class="title"><a id="ch06lvl1sec81"/>Time for action – creating the reminder app screens</h1></div></div></div><p>The steps shown <a id="id451" class="indexterm"/>here are going to use the standard LiveCode fields and buttons, but feel free to make your version more attractive!</p><div><ol class="orderedlist arabic"><li class="listitem">Create a new Mainstack, give it the name <code class="literal">EasyReminder</code>, and save it. Other names, such as <code class="literal">Simple Reminders</code>, might be more descriptive, but it would be too long a name if you're using an older iPhone.</li><li class="listitem">Set the card size to the size of your device. The screenshots shown in this section are based on an older iPhone-sized stack.</li><li class="listitem">Go to <strong>Standalone Application Settings</strong> and set the values in the same way that we did while testing the <strong>Location</strong> feature.</li><li class="listitem">Set the name of the first card to be <code class="literal">home</code>.</li><li class="listitem">Create a <strong>Sort by Time</strong> button, a <strong>Sort by Location</strong> button, one field named <code class="literal">reminders</code>, another field named <code class="literal">data</code>, and two buttons named <code class="literal">Create Reminder…</code> and <code class="literal">Create Location…</code>.</li><li class="listitem">Add one more button named <code class="literal">Delete Location or Reminder</code>.</li><li class="listitem">Make sure that both the fields have their <strong>Lock text</strong> and <strong>Don't wrap</strong> box checked.</li><li class="listitem">You should now have a screen that looks something like the following screenshot:<div><img src="img/image00289.jpeg" alt="Time for action – creating the reminder app screens"/></div><p style="clear:both; height: 1em;"> </p></li><li class="listitem">Make a new card and name it <code class="literal">location</code>.</li><li class="listitem">Add a field and set its contents to: <code class="literal">Enter the latitude and longitude for this location</code>.</li><li class="listitem">Add two input <a id="id452" class="indexterm"/>fields named <code class="literal">latitude</code>, and <code class="literal">longitude</code>.</li><li class="listitem">Create a button named <code class="literal">Set to Current Location</code>.<div><h3 class="title"><a id="tip13"/>Tip</h3><p>
<strong>Avoid typos</strong>
</p><p>Although we have <a id="id453" class="indexterm"/>placed a field for you to type in the location by hand, use the <strong>Set to Current Location</strong> button if possible or at least use that at your current location to see the format that is required.</p></div></li><li class="listitem">Add another instructions field that says: <code class="literal">Enter a name for this location:</code>.</li><li class="listitem">Add a third input field named <code class="literal">location name</code>. Note that on older phones with smaller screens, this field location needs to be toward the top of the screen, so that it isn't covered by the keyboard popup.</li><li class="listitem">Finally, add a button named <code class="literal">Add Location</code> and <code class="literal">Cancel</code>.</li><li class="listitem">For this card, all the three fields need their <strong>Lock text</strong> box to be unchecked.</li><li class="listitem">The card should look like the following screenshot:<div><img src="img/image00290.jpeg" alt="Time for action – creating the reminder app screens"/></div><p style="clear:both; height: 1em;"> </p></li><li class="listitem">Make a third card and name it <code class="literal">reminder</code>.</li><li class="listitem">Add two instructions fields that say: <code class="literal">Enter a title for this reminder:</code> and <code class="literal">Enter a brief description:</code>.</li><li class="listitem">Create two more input fields named <code class="literal">title</code>, and <code class="literal">description</code>.</li><li class="listitem">Create three buttons <a id="id454" class="indexterm"/>named <code class="literal">Set Related Location</code>, <code class="literal">Set Date</code>, and <code class="literal">Set Time</code>.</li><li class="listitem">Add three fields next to those buttons, which will be used to show the user that the selection they made has taken place. Name the fields <code class="literal">location field</code>, <code class="literal">date field</code>, and <code class="literal">time field</code>.</li><li class="listitem">Create a checkbox <a id="id455" class="indexterm"/>button named <code class="literal">Play Alert Sound</code>.</li><li class="listitem">Lastly, create two more buttons named <code class="literal">Add Reminder</code> and <code class="literal">Cancel</code>.</li><li class="listitem">Arrange all of these elements to appear as shown in the following screenshot:<div><img src="img/image00291.jpeg" alt="Time for action – creating the reminder app screens"/></div><p style="clear:both; height: 1em;"> </p></li></ol><div></div><div><div><div><div><h2 class="title"><a id="ch06lvl2sec121"/>
<em>What just happened?</em>
</h2></div></div></div><p>We've made all of the <a id="id456" class="indexterm"/>screens needed for the app to function. That was <a id="id457" class="indexterm"/>the easy bit. Just wait until you see how much typing you are going to do!</p></div><div><div><div><div><h2 class="title"><a id="ch06lvl2sec122"/>Stack-level scripts</h2></div></div></div><p>There is quite a bit of <a id="id458" class="indexterm"/>code ahead. Describing it feature by feature would require us to jump all over the place, which would add to the existing scripts in some cases and we would easily get lost in this situation. So, instead of doing it that way, we'll look at the code for each card at a time and also at the handlers that go into the stack script. It's shown here in the <em>Time for action</em> section, mainly to give you a break now and then! Without further ado, the stack script…</p></div></div>
<div><div><div><div><h1 class="title"><a id="ch06lvl1sec82"/>Time for action – adding stack-level functions</h1></div></div></div><p>For this app, we're <a id="id459" class="indexterm"/>going to put some of the logic in the <a id="id460" class="indexterm"/>buttons on the cards themselves, but <a id="id461" class="indexterm"/>it still leaves a good amount that will have to go into the Stack script. To make it less overwhelming, we'll show one or two functions at a time followed by some explanation about any interesting points in the following steps:</p><div><ol class="orderedlist arabic"><li class="listitem">Open the Stack script.</li><li class="listitem">Type in the the following handlers:<div><pre class="programlisting">on openstack
  if the platform is "iphone" then iPhoneSetKeyboardReturnKey "done"
  readdata
  showdata
end openstack

on returnInField
  focus on nothing
end returnInField</pre></div><div><h3 class="title"><a id="note15"/>Note</h3><p>Android OS keyboards generally have a button dedicated to the function putting the keyboard away. On iOS, this isn't the case, as the button that sits where the <em>Return</em> key should be, may have a special word instead, such as <em>Send</em>, or <em>Done</em>. Unfortunately, we are entering text into fields that are able to take a return character. To solve the issue, we set the Return button to say <em>Done</em>, which will lead the user to expect the keyboard to go away when that button is pressed. We will also trap the <code class="literal">returnInField</code> message and use it as a way to actually put the keyboard away.</p></div></li><li class="listitem">Next, type <a id="id462" class="indexterm"/>in the functions that <a id="id463" class="indexterm"/>will read, and write the list of reminders as a text file to the documents folder on your device:<div><pre class="programlisting">on writedata
  global gReminderData
  put specialFolderPath("documents") &amp; "/reminders.txt" into tRemindersPath
  if gReminderData is empty then put "no entries yet" into gReminderData
  open file tRemindersPath
  write gReminderData to file tRemindersPath
  close file tRemindersPath
  clearnotifiers
  setupnotifiers
end writedata

on readdata
  global gReminderData
  put specialFolderPath("documents") &amp; "/reminders.txt" into tRemindersPath
  if there is a file tRemindersPath then
     open file tRemindersPath
     read from file tRemindersPath until eof
     close file tRemindersPath
     put it into gReminderData
  else
     open file tRemindersPath
     write "no entries yet" to file tRemindersPath
     close file tRemindersPath
     put "no entries yet" into gReminderData
  end if
end readdata</pre></div><div><h3 class="title"><a id="note16"/>Note</h3><p>These <a id="id464" class="indexterm"/>two functions are using the straightforward ability that LiveCode has to read and write text files. Note that <code class="literal">specialFolderPath</code> is being used to help work out where the file will be saved. This works even when you test on desktop machines. The LiveCode Dictionary shows a full list of special folder paths, including many that don't apply to mobile apps.</p></div></li><li class="listitem">You can put the following <code class="literal">showdata</code> function into the Home card's Card script as well, but having it in the Stack level keeps it near other functions that are related to it. Type it in now:<div><pre class="programlisting">on showdata
  global gReminderData
  go card "home"
  put empty into field "reminders"
  put gReminderData into field "data"
  if gReminderData = "no entries yet" then
    exit showdata
  end if
  set the itemdelimiter to tab
  put 1 into tLineNumber
  repeat with a = 1 to the number of lines in gReminderData
    put line a of gReminderData into tEntry
    if item 1 of tEntry = "Reminder" then
      put item 2 of tEntry into tTitle
      put item 3 of tEntry into tDescription
      put item 4 of tEntry into tNotificationTime
      convert tNotificationTime from seconds to abbreviated time and long date
      put item 5 of tEntry into tLocationName
      put tTitle &amp; ":" &amp;&amp; tDescription &amp;&amp; tNotificationTime &amp;&amp; tLocationName into line tLineNumber of field "reminders"
      add 1 to tLineNumber
    end if
  end repeat
end showdata</pre></div><div><h3 class="title"><a id="note17"/>Note</h3><p>If you recall <a id="id465" class="indexterm"/>the sample text file from <a id="id466" class="indexterm"/>earlier, the <code class="literal">showdata</code> function takes each line and splits the tab delimited items into chunks of information to <a id="id467" class="indexterm"/>present to the user. One cute trick is that the notification time, which is a long number of seconds, is converted into a human-readable form, showing both the date and time of the notification. The <code class="literal">data</code> field is used to show the raw data that has been saved. In the final application, you would not show this, but it's handy to check whether the reminder information looks correct or not.</p></div></li><li class="listitem">The last functions in the Stack script are used to set up the notifications themselves:<div><pre class="programlisting">on clearnotifiers
  mobileCancelAllLocalNotifications
end clearnotifiers

on setupnotifiers
  global gReminderData
  if gReminderData = "no entries yet" then exit setupnotifiers
  set the itemdelimiter to tab
  repeat with a = 1 to the number of lines in gReminderData
    put line a of gReminderData into tEntryDetails
    if item 1 of tEntryDetails = "Reminder" then
      put item 2 of tEntryDetails &amp;&amp; "-" &amp;&amp; item 3 of tEntryDetails into alertBody
      put "OK" into alertButtonMessage
      put tEntryDetails into alertPayload
      put item 4 of tEntryDetails into alertTime
      put item 6 of tEntryDetails into playSound
      mobileCreateLocalNotification alertBody, alertButtonMessage, alertPayload, alertTime, playSound
    end if
  end repeat
end setupnotifiers

on localNotificationReceived pMsg
  answer "Local Notification:" &amp;&amp; pMsg
end localNotificationReceived</pre></div><div><h3 class="title"><a id="note18"/>Note</h3><p>Many <a id="id468" class="indexterm"/>mobile apps that use <a id="id469" class="indexterm"/>notifications don't ever clear them. In <a id="id470" class="indexterm"/>general, maybe they don't need to be cleared. Once they go by, they're gone for good! Well, not always. Sometimes, you'll go into an app just ahead of when a notification comes and you'd do the task, only to then be pestered with notifications about something you already did! In our app, we clear all the notifications that were due and recreate the whole list again. This way, any that you have deleted won't come back to haunt you later. To help in debugging, <code class="literal">alertPayload</code> is filled in with the entire reminder entry and will be shown to you when the notification comes in.</p></div></li></ol><div></div><div><div><div><div><h2 class="title"><a id="ch06lvl2sec123"/>
<em>What just happened?</em>
</h2></div></div></div><p>In addition to getting your fingers nicely warmed up, you entered all the functions to read and write the reminders data and to create and receive the notification messages.</p></div><div><div><div><div><h2 class="title"><a id="ch06lvl2sec124"/>Home card scripts</h2></div></div></div><p>We're not going to <a id="id471" class="indexterm"/>put any scripts into the card level; they can just be inside various buttons. Starting with the ones on the first card.</p></div></div>
<div><div><div><div><h1 class="title"><a id="ch06lvl1sec83"/>Time for action – making the home card buttons work</h1></div></div></div><p>The <strong>Sort </strong>
<a id="id472" class="indexterm"/>
<strong>by Location</strong> button's script is quite something. You <a id="id473" class="indexterm"/>should look forward to that! First, we'll start with the <strong>Sort by Time</strong> button:</p><div><ol class="orderedlist arabic"><li class="listitem">Edit the script of the <strong>Sort by Time</strong> button on the first card.</li><li class="listitem">Type in the following short handler:<div><pre class="programlisting">on mouseUp
  global gReminderData
  set the itemdelimiter to tab
  sort gReminderData numeric by item 4 of each
  showdata
  writedata
end mouseUp</pre></div><div><h3 class="title"><a id="note19"/>Note</h3><p>LiveCode's sort command is powerful and in the preceding case, it sorts the list of reminders based on the notification seconds value. Once the lines are sorted, the list is recreated for the user to see and the text file is rewritten.</p></div></li><li class="listitem">Get mentally prepared and then edit the script of the <strong>Sort by Location</strong> button.</li><li class="listitem">Type in all of the following lines of code:<div><pre class="programlisting">on mouseUp
  global gReminderData
  mobileStartTrackingSensor "location", true
  put mobileSensorReading("location", false) into tLocation
  mobileStopTrackingSensor "location"
  set the itemdelimiter to comma
  put item 1 of tLocation into tLat
  put item 2 of tLocation into tLong
  set the itemdelimiter to tab
  sort gReminderData numeric by getdistance(tLat,tLong,item 5 of each)
  showdata
  writedata
end mouseUp

function getdistance pLat,pLong,pLocName
  if pLocName is empty then return 1000000
  global gReminderData
  put empty into tLat
  put empty into tLong
  repeat with a = 1 to the number of lines in gReminderData
    if item 1 of tEntryDetails = "Location" then
      if item 2 of tEntryDetails = pLocName then
        put item 3 of tEntryDetails into tLat
        put item 4 of tEntryDetails into tLong
      end if
    end if
  end repeat
  if tLat is empty then return 1000000000
  return distance(tLat,tLong,pLat,pLong)
end getdistance

function distance lat1,lon1,lat2,lon2
  put 6371 into r
  put toRad((lat2-lat1)) into dLat
  put toRad((lon2-lon1)) into dLon
  put toRad(lat1) into lat1
  put toRad(lat2) into lat2
  put sin(dLat/2) * sin(dLat/2) + sin(dLon/2)*sin(dLon/2) * cos(lat1)*cos(lat2) into a
  put 2*atan2(sqrt(a),sqrt(1-a)) into c
  put r*c into d
  return d
end distance

function toRad pAngle
  return pAngle/180*PI
end toRad</pre></div><div><h3 class="title"><a id="note20"/>Note</h3><p>The first part of the <code class="literal">mouseUp</code> handler just gets your current location. The <code class="literal">distance</code> and <code class="literal">toRad</code> functions are the same ones we looked at earlier. The magic happens in the way that the sort line uses a function to determine the sort order. By passing the Location that you associated with each reminder into the <code class="literal">getdistance</code> function, it's possible to run through the list of locations to find a match and to then use that location's latitude and longitude to measure the distance from your current location. This distance is then used by the sort command to decide the order of the lines.</p></div></li><li class="listitem">For a <a id="id474" class="indexterm"/>moment's relaxation, edit the <a id="id475" class="indexterm"/><strong>Create Reminder…</strong> button script and set it to this:<div><pre class="programlisting">on mouseUp
  go to card "reminder"
end mouseUp</pre></div></li><li class="listitem">Likewise, set the <strong>Create Location…</strong> button script to the following:<div><pre class="programlisting">on mouseUp
  go to card "location"
end mouseUp</pre></div></li><li class="listitem">For the last script for this card, edit the <strong>Delete Location or Reminder</strong> button script and type the following in:<div><pre class="programlisting">on mouseUp
  global gReminderData
  mobilePick gReminderData,1,"checkmark","cancelDone","picker"
  put the result into tItemsToDelete
  if tItemsToDelete = "0" then exit mouseUp
  set the itemdelimiter to comma
  repeat with a = the number of items in tItemsToDelete down to 1
    delete line (item a of tItemsToDelete) of gReminderData
  end repeat
  if gReminderData is empty then put "no entries yet" into gReminderData
  showdata
  writedata
end mouseUp</pre></div></li></ol><div></div><div><h3 class="title"><a id="note21"/>Note</h3><p>The delete <a id="id476" class="indexterm"/>handler uses <code class="literal">mobilePick</code> with <a id="id477" class="indexterm"/>a particular set of parameters. One interesting parameter is <code class="literal">checkmark</code>. Asking for that type of picker will then show a list with checkboxes in it when you're on iPad or Android. That would enable you to choose several entries to delete in one go. Hence, the repeat loop that goes through as many items as you choose.</p></div><div><div><div><div><h2 class="title"><a id="ch06lvl2sec125"/>
<em>What just happened?</em>
</h2></div></div></div><p>All being well, you have recovered by now after trying to understand the sort-by-location function! You can at least see how tough the Stack script would have been if all of this code would have been placed in that one location. Let's go on to the next card…</p></div><div><div><div><div><h2 class="title"><a id="ch06lvl2sec126"/>Creating a location card</h2></div></div></div><p>Next up, we <a id="id478" class="indexterm"/>will create the card that we will show when the user touches the <strong>Create a Location…</strong> button on the first card.</p></div></div>
<div><div><div><div><h1 class="title"><a id="ch06lvl1sec84"/>Time for action – making the location card work</h1></div></div></div><p>The Location card <a id="id479" class="indexterm"/>has three fields in it for latitude, longitude, and a <a id="id480" class="indexterm"/>title for the location. The user could type in the details manually, but if they happen to be at the location in question, there's a button there that will grab the location and fill in the numbers automatically. The following steps will guide you in making the location card work:</p><div><ol class="orderedlist arabic"><li class="listitem">Edit the script of the <strong>Set to Current Location</strong> button and type in the following lines of code:<div><pre class="programlisting">on mouseUp
  mobileStartTrackingSensor "location", true
  put mobileSensorReading("location", false) into tLocation
  mobileStopTrackingSensor "location"
  set the itemdelimiter to comma
  if the number of items in tLocation = 3 then
    put item 1 of tLocation into field "latitude"
    put item 2 of tLocation into field "longitude"
  end if
end mouseUp</pre></div></li><li class="listitem">Nothing too <a id="id481" class="indexterm"/>tricky here; we just captured the location and <a id="id482" class="indexterm"/>stored the latitude and longitude entries in the two fields.</li><li class="listitem">Edit the script of the <strong>Cancel</strong> button and change it to the following easy script:<div><pre class="programlisting">on mouseUp
  go to card "home"
end mouseUp</pre></div></li><li class="listitem">For the last item for this card, edit the <strong>Add Location</strong> button script and type in the following code:<div><pre class="programlisting">on mouseUp
  global gReminderData
  if field "location name" is empty then
    answer "Please enter a name for this location."
    exit mouseUp
  end if
  if field "latitude" is empty or field "longitude" is empty then
    answer "Please enter location values, or press the 'Set to Current Location' button."
    exit mouseUp
  end if
  put "Location" &amp; tab &amp; field "location name" &amp; tab &amp; field "latitude" &amp; tab &amp; field "longitude" into tLocationDetails
  if gReminderData = "no entries yet" then
    put tLocationDetails into gReminderData
  else
    put return &amp; tLocationDetails after gReminderData
  end if
  go to card "home"
  showdata
  writedata
end mouseUp</pre></div><p>Most of the handler just checks whether the user entered the required information.</p></li></ol><div></div><div><div><div><div><h2 class="title"><a id="ch06lvl2sec127"/>
<em>What just happened?</em>
</h2></div></div></div><p>A lot less has happened <a id="id483" class="indexterm"/>than what happened on the first card! However, it was <a id="id484" class="indexterm"/>important all the same. Now, we have a way where the user can set up a location to be used by the reminders that they have created. That's where we're headed now…</p></div><div><div><div><div><h2 class="title"><a id="ch06lvl2sec128"/>The reminder entry form</h2></div></div></div><p>This last <a id="id485" class="indexterm"/>card is essentially an entry form; we just want to ask the user what the reminder is for. There are some tricky aspects to it though and one or two lengthy functions to cope with that.</p></div></div>
<div><div><div><div><h1 class="title"><a id="ch06lvl1sec85"/>Time for action – taking in information about the reminder</h1></div></div></div><p>The Reminder card makes good use of pickers. There is little typing for the user to do, and because they pick an entry from a list we present, there's a good chance the information won't have any typos in it! Use the following steps for taking in information about the reminder:</p><div><ol class="orderedlist arabic"><li class="listitem">Edit the script of the <strong>Set Related Location</strong> button and type in the following lines of code:<div><pre class="programlisting">on mouseUp
  global gReminderData
  put empty into tLocations
  set the itemdelimiter to tab
  put 1 into tLineNumber
  repeat with a = 1 to the number of lines in gReminderData
    if item 1 of line a of gReminderData = "Location" then
      put item 2 to 4 of line a of gReminderData into line tLineNumber of tLocations
      add 1 to tLineNumber
    end if
  end repeat
  if tLocations is empty then
    answer "You need to add a location."
  else
    mobilePick tLocations,1
    put the result into tChosenLocation
    if tChosenLocation &gt;0 then
      put item 1 of line tChosenLocation of tLocations into field "location field"
    end if
  end if
end mouseUp</pre></div><div><h3 class="title"><a id="note22"/>Note</h3><p>We made the first word of each line in the reminders data either Location or Reminder. Here's one place where we can make use of that. Once we pull out the lines that are "Location", presenting them inside a picker is easy.</p></div></li><li class="listitem">Edit the <a id="id486" class="indexterm"/>script of the <strong>Set Date</strong> button and change it to the following easy-to-understand script:<div><pre class="programlisting">on mouseUp
  mobilePickDate "date"
  put the result into tDate
  convert tDate to seconds
  put tDate into field "date field"
end mouseUp</pre></div></li><li class="listitem">Set the script of the <strong>Set Time</strong> button to the following, which is almost an identical script:<div><pre class="programlisting">on mouseUp
  mobilePickDate "time"
  put the result into tTime
  convert tTime to seconds
  put tTime into field "time field"
end mouseUp</pre></div></li><li class="listitem">The <strong>Cancel</strong> button script is the same as it is on the Location card given here:<div><pre class="programlisting">on mouseUp
  go to card "home"
end mouseUp</pre></div></li><li class="listitem">Last, and far from least, the <strong>Add Reminder</strong> button script does all the hard work:<div><pre class="programlisting">on mouseUp
  global gReminderData
  if field "title" is empty or field "description" is empty then
    answer "Please enter both a title and a description."
    exit mouseUp
  end if
  put "false" into tDoAlert
  if the hilite of button "Play Alert Sound" then put "true" into tDoAlert
  put field "date field" into tDateValue
  put field "time field" into tTimeValue
  convert tTimeValue from seconds to short date
  convert tTimeValue to seconds
  put field "time field" - tTimeValue into tTimeValue
  add tTimeValue to tDateValue
  put "Reminder" &amp; tab &amp; field "title" &amp; tab &amp; field "description" into tReminderDetails
  put tReminderDetails &amp; tab &amp; tDateValue &amp; tab &amp; field "location field" &amp; tab into tReminderDetails
  put tReminderDetails &amp; tab &amp; tDoAlert into tReminderDetails
  if gReminderData = "no entries yet" then
    put tReminderDetails into gReminderData
  else
    put return &amp; tReminderDetails after gReminderData
  end if
  go to card "home"
  showdata
  writedata
end mouseUp</pre></div><div><h3 class="title"><a id="note23"/>Note</h3><p>Most of the preceding script just combines the different bits of information together into one reminder entry with the parts delimited with a tab character. However, there is one bit of cute arithmetic going on in there too. At the start of this chapter, we looked at how Unix Time differs from the actual time at a rate of 0.6 seconds per year. If you want to set a notification at 8 AM five years from now, you can't take the value that the Set Time button gave you because that refers to today's 8 AM. You can't take the value that Set <a id="id487" class="indexterm"/>Date gave you because that would be midnight. So, by converting the time value to the short date format and then back to the seconds format, you can find out what the Unix Time was at midnight of the current day. Subtracting that from the value that Set Time gave you let's you know the number of seconds since midnight, regardless of how many seconds behind Unix Time is. Adding that value to the one from Set Date will give us an exact Unix Time in seconds for the notification to occur. Under iOS, there is a picker type that allows you to set the date and time together, but as that isn't on Android, we've used a way that works for both.</p></div></li></ol><div></div><div><div><div><div><h2 class="title"><a id="ch06lvl2sec129"/>
<em>What just happened?</em>
</h2></div></div></div><p>Phew! We got to the end! Try to run the app on your device. If your fingers aren't too numb, that is! Honestly, you could bet a fortune that it won't work the first time, but if it works well enough to show the raw text in the data field on the first card, hopefully, you'll be able to track down any errors in the code. You can also type in some test data into the stack on your computer and at least test the functions that don't require device-specific features.</p></div><div><div><div><div><h2 class="title"><a id="ch06lvl2sec130"/>Have a go hero – nice transitions</h2></div></div></div><p>Really, if you've <a id="id488" class="indexterm"/>managed to get through and entered all that code to the point that the app is working, you're already a hero! However, read the section in the iOS and Android release notes for LiveCode about <em>Visual effects support</em>. Check whether you can get some typical mobile OS transitions happening as you go to and from the different cards.</p></div></div>
<div><div><div><div><h1 class="title"><a id="ch06lvl1sec86"/>Summary</h1></div></div></div><p>This chapter was way more exciting than expected! A reminder app is absolutely not quite as impressive as Angry Birds, but making use of the location features of a mobile device makes it a little more novel. Along the way, we covered the process of reading and writing data to the special documents folder as well as the use of pickers for straightforward lists, dates, and time. We also showed how to read the current location of the device and how to set up local notification events.</p><p>In the best of cases, you can manage to make a mobile app in a few hours or a few days, but there is quite a lot that goes on before you can submit the app to the various app stores. Sounds like a good topic for the next chapter!</p></div></body></html>