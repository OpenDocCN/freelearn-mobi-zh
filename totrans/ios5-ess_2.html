<html><head></head><body><div><div><div><div><h1 class="title"><a id="ch02"/>Chapter 2. Using iCloud and the Storage APIs</h1></div></div></div><p>In this chapter, we will be introducing the features of iCloud and their storage APIs. These allow you to develop your application to write and store user documents in a common and central location, with the ability to access those items from all of your computers and iOS devices.</p><p>Making a user's document available using iCloud, means that a user can view or edit those documents directly from any device, without the need of having to sync or transfer those files. Storing documents in a user's iCloud account provides an added layer of security for that user. Even if the user loses their device, the documents can easily be retrieved from the device, provided that they are contained within iCloud storage.</p><p>Through the use of the iCloud storage APIs, you can make your applications capable enough to store user documents and key-value data, allowing this information, and any changes to it, to be pushed to all of your iOS devices all at the same time. By using iCloud, you can create some excellent applications, by adding some great compelling functionality.</p><p>In this chapter, we will:</p><div><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">Take advantage of iCloud storage</li><li class="listitem" style="list-style-type: disc">Back up our data using iCloud backup</li><li class="listitem" style="list-style-type: disc">Store documents within iCloud storage</li><li class="listitem" style="list-style-type: disc">Search for documents within the Cloud</li><li class="listitem" style="list-style-type: disc">Handle file-version conflicts</li><li class="listitem" style="list-style-type: disc">Move and store documents to iCloud storage</li><li class="listitem" style="list-style-type: disc">Configure and set up provisioning profiles ready for iCloud storage.</li></ul></div><p>Let's get started.</p><div><div><div><div><h1 class="title"><a id="ch02lvl1sec01"/>Comparing Apple iCloud and Google Docs</h1></div></div></div><p>When Apple announced their new cloud-based file management system called iCloud, it allowed you to backup your files to the Cloud, and synchronize your data between multiple devices.<a id="id68" class="indexterm"/>
</p><p>Devices, such as the iPad and iPhone, can automatically backup files, such as photos, music, and documents to iCloud, and have these synchronize with your other Apple devices.</p><p>One of the significant differences you will notice between iCloud and Google Docs, is that, iCloud is meant only for Apple devices, such as the iPhone, iPod Touch and iPad.</p><p>iCloud works by storing all of your music, photos, documents, books, and so on, and automatically pushing them out to all of your other devices, wirelessly.</p><p>Any documents that are stored within iCloud can be accessed and viewed from any device that is connected to the Internet. At this stage, iCloud does not offer a way to share the documents with other users.</p><p>On the other hand, Google Docs is a free document management service from Google that allows you to create, edit, and manage various types of documents in the Cloud. This is all handled within an easy-to-use interface to manage your documents, each organized under labels that are equivalent to folders. Unlike iCloud, you are able to access these documents within the Cloud from any computer, tablet, or even using your iPhone and iPad.</p><p>Google Docs currently supports and stores the following file types within the Cloud. These can be later accessed from anywhere on the web.<a id="id69" class="indexterm"/>
</p><div><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">Documents</li><li class="listitem" style="list-style-type: disc">Spreadsheets</li><li class="listitem" style="list-style-type: disc">Presentations</li><li class="listitem" style="list-style-type: disc"><strong>Drawings:</strong> This is a new addition to the Google Docs family.</li></ul></div><p>iCloud and Google Docs both offer free storage, but come with some limitations. iCloud comes with a total limit of 5GB per account; additional space can be purchased should you require it.</p><p>Google Docs is also free, but comes with restrictions and limitations, based on the total number of documents that you can store and the length/content of each document.<a id="id70" class="indexterm"/>
</p><p>Unlike iCloud, Google Docs provides you with a way of sharing your documents with other users.</p><p>You have the flexibility of sharing and setting user rights to your documents. You have the ability to make a document publicly available on the Internet with view only access, or allow selected people to edit.<a id="id71" class="indexterm"/>
</p></div></div>
<div><div><div><div><h1 class="title"><a id="ch02lvl1sec02"/>Storing and using documents in iCloud</h1></div></div></div><p>Storing documents within the Cloud provides you with a common central location for easy access to those documents. Any updates that are made to the document can then be delivered to every iOS device or computer, as long as they are using the same Apple ID used to upload those documents.<a id="id72" class="indexterm"/>
</p><p>When a document is uploaded to iCloud, it is not moved there immediately. The document must first be moved out of the application sandbox into a local system-managed directory, where it can be monitored by the iCloud service.</p><p>Once this process has completed, the file is transferred to iCloud and then distributed out to the user's other iOS devices as soon as possible. While the files are stored within iCloud storage, any changes that are made on one device are initially stored locally and then immediately pushed out to iCloud, using a local daemon service.</p><p>This is to prevent file conflicts from happening at the same time; this is handled by the<strong> File</strong> coordinator, which mediates changes made between the application and the local daemon service that is responsible for facilitating the transfer of the document to-and-from the iCloud service.</p><p>The file coordinator acts much like a locking mechanism for the document, thus preventing your application and the daemon service from applying modifications to the document simultaneously.</p><div><h3 class="title"><a id="note07"/>Note</h3><p>Whenever your application stores documents to iCloud, it must specify one or more containers in which those documents, contents will be stored, by including the key value entry<code class="literal"> com.apple.developer.ubiquity-container-identifiers</code> within your applications, entitlements file. This is covered in the section<em> Requesting entitlements for iCloud storage</em>.</p></div><p>The following screenshot shows the process when changes are made on one device, and having those changes stored locally before being pushed back out to the iCloud service using a local daemon process.</p><div><img src="img/2267EXP_02_01.jpg" alt="Storing and using documents in iCloud"/></div><p>From an implementation perspective, the easiest way to provide your applications with the ability to manage documents stored within iCloud, would be to use the<code class="literal"> UIDocument</code> class. This class handles everything that is required to read and write files that are stored within iCloud. It can:<a id="id73" class="indexterm"/>
</p><div><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">Handle the creation and use of the file coordinators to modify the document</li><li class="listitem" style="list-style-type: disc">Seamlessly detect changes that are received from other devices</li><li class="listitem" style="list-style-type: disc">Handle any potential conflicts that arise when two devices manage to update the same file in conflicting ways</li><li class="listitem" style="list-style-type: disc">Prevent large number of conflicting changes from occurring at the same time</li></ul></div><p>We will take a look at storing documents within iCloud, when we start to create our example application in our section on<em> Creating an iCloudExample Application</em>.</p><div><div><div><div><h2 class="title"><a id="ch02lvl2sec01"/>Storing key-value data in iCloud</h2></div></div></div><p>Storing data within iCloud provides you with a means of making your applications share data between other copies of the same data running on other computers and other iOS devices.<a id="id74" class="indexterm"/>
</p><p>The class that allows you to do this is called the<code class="literal"> NSUbiquitousKeyValueStore</code>. This class provides you with the ability to share small amounts of data between your devices.</p><p>The<code class="literal"> NSUserDefaults</code> class, provides you with a programmatic interface for interacting with the system defaults that allows an application to customize its behavior to match a user's preferences. For example, you can set up your application to specify how often documents are automatically saved. This class allows you to save your details to a variety of data types, that is, numbers, strings, dates, arrays and so on, before retrieving the data for use at a later time.</p><p>The main difference between the<code class="literal"> NSUserDefaults</code> and the<code class="literal"> NSUbiquitousKeyValueStore</code>, is that the<code class="literal"> NSUserDefaults</code> class writes the data to the user's iCloud storage, so that it can be retrieved by the application running on a different iOS device or computer.</p><p>The following code snippet shows how to set up the cloud, so that you are able to write the data to the user's iCloud storage:</p><div><pre class="programlisting">// TeamID + Bundle Identifier
NSFileManager *fileManager = [NSFileManagerdefaultManager];
NSURL *CloudURL = [fileManager URLForUbiquityContainerIdentifier: @"TEAMID.com.yourcompany.iCloudExample"];
// Log our iCloud URL to the console window
NSLog(@"iCloudURL: %@", [CloudURLabsoluteString]);
// Get a reference to the user's cloud store.
NSUbiquitousKeyValueStore *cloudStore = [NSUbiquitousKeyValueStoredefaultStore];
// Store our Cloud URL to the iCloudURL key.
[cloudStoresetString:[CloudURLabsoluteString] forKey:@"CloudURL"];
// This is important to include as it stores the
// values you set earlier on iCloud.
[cloudStore synchronize];
</pre></div><div><h3 class="title"><a id="note08"/>Note</h3><p>When using the<code class="literal"> NSUbiquitousKeyValueStore</code> class, you must ensure that an entry to the<code class="literal"> com.apple.developer.ubiquity-kvstore-identifier</code> entitlement is added to your project entitlements file. This is covered in the section<em> Requesting entitlements for iCloud storage</em>.</p></div><p>The amount of space available for a single key-value store is limited to 64KB; any data that is written to a single key-value within your container must not exceed 4KB in size. This is so that you can store small amounts of data about your application, but it is not advisable to use it to store user documents or large amounts of data.</p><p>For example, you may have an application that might store the current version number, and the name of the screen or document that the user was viewing. That way, if the user opens the application on another device, the version of your application on that device can open the same screen or document as the previous device.<a id="id75" class="indexterm"/>
</p></div><div><div><div><div><h2 class="title"><a id="ch02lvl2sec02"/>Requesting entitlements for iCloud storage</h2></div></div></div><p>In order to protect the data your application creates, a number of specific entitlements need to be created at build-time in order to use iCloud storage. You will need to ensure that you have selected the option to enable iCloud for your application's App ID.<a id="id76" class="indexterm"/>
</p><p>You will need to either create a new App ID from within the iOS provisioning portal located at<a class="ulink" href="http://https://developer.apple.com/devcenter/ios/index.action#"> https://developer.apple.com/devcenter/ios/index.action#</a>. Or, if you are using an existing ID, this must not be a wildcard one, that is,<code class="literal"> com.yourcompany.*</code>.</p><p>To enable iCloud services for your App ID, follow these simple steps:</p><div><ol class="orderedlist"><li class="listitem"> First, set up your provisioning profile for use with iCloud, by simply checking the<strong> Enable for iCloud</strong> checkbox from the<strong> Configure App ID</strong> screen.<div><img src="img/2267EXP_02_02.jpg" alt="Requesting entitlements for iCloud storage"/></div></li><li class="listitem"> Next, you will be presented with a pop-up dialog box, explaining that any new provisioning profiles that you create using the chosen App ID will be enabled for iCloud services.<a id="id77" class="indexterm"/><div><img src="img/2267EXP_02_03.jpg" alt="Requesting entitlements for iCloud storage"/></div></li><li class="listitem"> Once you have clicked on the<strong> OK</strong> button, the pop-up dialog box will disappear, and you will be returned back to the<strong> Configure App ID</strong> screen, and the<strong> Enable for iCloud Enabled</strong> button will be set to green, as shown in the following screenshot:<div><img src="img/2267EXP_02_04.jpg" alt="Requesting entitlements for iCloud storage"/></div></li><li class="listitem"> Click on the<strong> Done</strong> button to close this screen.</li><li class="listitem"> Next, from the<strong> Provisioning</strong> tab, download your<strong> Development and Distribution Provisioning Profiles</strong>.</li><li class="listitem"> Next, from the<strong> ProjectNavigator</strong> window, click on your project, then click on the<strong> Targets</strong> section, and then on the<strong> Summary</strong> page.</li><li class="listitem"> Scroll down till you get to the<strong> Entitlements</strong> section, and check the<strong> Enable Entitlements</strong> checkbox. This will add a file called<strong> iCloudExample.entitlements</strong> to your project.<a id="id78" class="indexterm"/></li></ol></div><div><img src="img/2267EXP_02_05.jpg" alt="Requesting entitlements for iCloud storage"/></div><p>When you add entitlements to your project, they are bound directly to your applications provisioning profile that are used to separate your application's documents and data repositories from that of other applications that you create. There are two entitlements that an application can request, depending on which iCloud features it is required to use. These are explained in the following table.</p><div><table border="1"><colgroup><col style="text-align: left"/><col style="text-align: left"/></colgroup><thead><tr><th style="text-align: left" valign="bottom">
<p><strong>Entitlement</strong></p>
</th><th style="text-align: left" valign="bottom">
<p><strong>Description</strong></p>
</th></tr></thead><tbody><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">com.apple.developer.ubiquity-container-identifiers</code>
</p>
</td><td style="text-align: left" valign="top">
<p>Use this to request the iCloud document storage entitlement.</p>
<p>The value of this key is an array of container-identifier strings (the first string in the array must not contain any wildcard characters).</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">com.apple.developer.ubiquity-kvstore-identifier</code>
</p>
</td><td style="text-align: left" valign="top">
<p>Use this to request the iCloud key-value data store entitlement. The value of this key is a single container identifier string.</p>
</td></tr></tbody></table></div><p>When you specify the container identifier string, this must be in the form<code class="literal">&lt;TEAMID&gt;.&lt;CUSTOM_STRING&gt;</code>, where<code class="literal">&lt;TEAMID&gt;</code> is the unique ten-character identifier associated with your development team. The<code class="literal">&lt;CUSTOM_STRING&gt;</code> identifier is a reverse-DNS string that identifies the container for storing your application's documents.</p><p>This string does not necessarily need to be your application's bundle identifier, but can be anything that makes sense to you, or your development team.<a id="id79" class="indexterm"/>
</p><div><h3 class="title"><a id="note09"/>Note</h3><p>To locate your unique identifier associated with your development team, log in to the Apple developer connection website, and then go to the<strong> Member Center</strong> page (<a class="ulink" href="http://developer.apple.com/membercenter">http://developer.apple.com/membercenter</a>). From the<strong> Member Center</strong> home page, select the<strong> Your Account</strong> tab, and then select<strong> Organization Profile</strong> from the column on the left of that tab. Your team's identifier is in the<strong> Company/Organization ID</strong> field.</p></div><p>Applications using iCloud document storage can specify multiple containers for storing documents and data. The value of the<code class="literal"> com.apple.developer.ubiquity-container-identifiers</code> key is an array of strings. The first string in this array must be the main container identifier to associate with your application.</p><p>The following code snippet shows the XML from the<code class="literal"> iCloudExample</code> entitlements file that requests the keys for an iPhone application. It can read and write its own documents, which are stored in the container directory, identified as shown in the highlighted code sections.</p><div><pre class="programlisting">&lt;?xml version="1.0" encoding="UTF-8"?&gt;
&lt;!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd"&gt;
&lt;plist version="1.0"&gt;
&lt;dict&gt;
&lt;key&gt;application-identifier&lt;/key&gt;
&lt;string&gt;AXEUZ3F6VR.com.geniesoftstudios&lt;/string&gt;<strong>
&lt;key&gt;com.apple.developer.ubiquity-container-identifiers&lt;/key&gt;
&lt;array&gt;
&lt;string&gt;TEAMID.com.yourcompany.iCloudExample&lt;/string&gt;
&lt;/array&gt;
&lt;key&gt;com.apple.developer.ubiquity-kvstore-identifier&lt;/key&gt;
&lt;string&gt;TEAMID.com.yourcompany.iCloudExample&lt;/string&gt;
&lt;key&gt;get-task-allow&lt;/key&gt;</strong>
&lt;true/&gt;
&lt;/dict&gt;
&lt;/plist&gt;
</pre></div><p>The following screenshot displays the property list view within the project navigator of the<code class="literal"> iCloudExample.Entitlements</code> entitlements file.<a id="id80" class="indexterm"/>
</p><div><img src="img/2267EXP_02_06.jpg" alt="Requesting entitlements for iCloud storage"/></div><p>The<strong> TEAMID</strong> value (as shown in the previous screenshot), can be obtained from the<strong> Account Summary</strong> page of your<strong> Developer Account</strong> and using the<strong> Individual ID</strong>, as shown in the following screenshot:</p><div><img src="img/2267EXP_02_07.jpg" alt="Requesting entitlements for iCloud storage"/></div><div><h3 class="title"><a id="note10"/>Note</h3><p>The strings you specify in your entitlements property-list file are also the strings you pass to the<code class="literal"> URLForUbiquityContainerIdentifier:</code> method, when requesting the location of a directory in the user's iCloud storage.</p></div></div><div><div><div><div><h2 class="title"><a id="ch02lvl2sec03"/>iCloud backup</h2></div></div></div><p>When using backups with iCloud, users have the ability to choose to have their applications and data backed up directly to their iCloud account. This makes it easier to restore applications to their most recent state at a later time. Choosing to have data backed up to iCloud, will make it easier for a user to reinstall their data to any new or existing iOS device.<a id="id81" class="indexterm"/>
</p><p>iCloud determines what files get backed up, and is based on the location where these files are kept, normally within the applications, home directory. Other areas that are backed up would be everything contained within the user's documents directory, as well as the contents of your applications library. When developing iCloud applications, and minimizing the amount of data stored in the user's iCloud account, you are encouraged to put more files in the<code class="literal"> Library/Caches</code> directory, especially if those files can be easily re-created or obtained in another way.</p><p>In order to have your data backed-up to iCloud, you will need to activate this on all of your iOS devices. This can be achieved by following these simple steps:</p><div><ol class="orderedlist"><li class="listitem"> From the<strong> Settings</strong> pane within your device, select<strong> iCloud</strong>. This is shown in the following screenshot:<div><img src="img/2267EXP_02_08.jpg" alt="iCloud backup"/></div></li><li class="listitem"> Next, sign-in with your<strong> AppleID</strong> and<strong> Password</strong>, and then click on the<strong> Sign In</strong> button as shown in this screenshot.<a id="id82" class="indexterm"/></li><li class="listitem"> You will need to agree to the iCloud terms and conditions, and then click on the<strong> Agree</strong> button to close the pop up dialog box.</li><li class="listitem"> In the next screenshot, you have the option to decide which items you would like to backup to iCloud.</li><li class="listitem"> Next, click on the<strong> Storage &amp; Backup</strong> option to proceed to the next screen:<div><img src="img/2267EXP_02_09.jpg" alt="iCloud backup"/></div></li><li class="listitem"> Next, set the<strong> Back Up to iCloud</strong> option to<strong> ON</strong>, from under the<strong> Backup</strong> sections pane. This will automatically backup all of your camera photos, documents, and settings to iCloud.<a id="id83" class="indexterm"/></li></ol></div><div><h3 class="title"><a id="note11"/>Note</h3><p>Setting this option to<strong> ON</strong> will prevent iTunes from backing up your details, as your iOS device will handle this.</p></div><div><img src="img/2267EXP_02_10.jpg" alt="iCloud backup"/></div><p>When using the iCloud storage APIs from within your applications, any documents that your application stores explicitly in iCloud are not backed up with your application; this is because these will already be stored within your iCloud account, and therefore do not need to be backed up separately.<a id="id84" class="indexterm"/>
</p><div><h3 class="title"><a id="note12"/>Note</h3><p>For information on how to store documents within iCloud, refer to the section<em> Storing and using documents in iCloud</em>. To determine which directories are backed up, check out the<strong> iOS Application Programming Guide</strong> at:<a class="ulink" href="http://developer.apple.com/library/ios/#documentation/iphone/conceptual/iphoneosprogrammingguide/Introduction/Introduction.html"> http://developer.apple.com/library/ios/#documentation/iphone/conceptual/iphoneosprogrammingguide/Introduction/Introduction.html</a>.</p></div><div><div><div><div><h3 class="title"><a id="ch02lvl3sec01"/>Creating the iCloudExample application</h3></div></div></div><p>Before we can proceed to create our<code class="literal"> iCloudExample</code> application, we must first launch the Xcode development environment.<a id="id85" class="indexterm"/>
</p><div><ol class="orderedlist"><li class="listitem"> Launch Xcode from the <code class="literal">/Developer/Applications</code> folder.</li><li class="listitem"> Select the<strong> Single View Application</strong> template to use from the<strong> Project</strong> template dialog box.<div><img src="img/2267EXP_02_11.jpg" alt="Creating the iCloudExample application"/></div></li><li class="listitem"> Then, click on the<strong> Next</strong> button to proceed to the next step in the Wizard. This will allow you to enter in the<strong> Product Name</strong> and your<strong> Company Identifier</strong>.<a id="id86" class="indexterm"/><div><img src="img/2267EXP_02_12.jpg" alt="Creating the iCloudExample application"/></div></li><li class="listitem"> Enter in<code class="literal"> iCloudExample</code> for the<strong> Product Name</strong>, and ensure that you have selected<strong> iPhone</strong> from the<strong> Device Family</strong> drop-down box.<a id="id87" class="indexterm"/></li><li class="listitem"> Click on the<strong> Next</strong> button to proceed to the final step in the wizard.</li><li class="listitem"> Choose the folder location where you would like to save your project.</li><li class="listitem"> Click on the<strong> Create</strong> button to save your project at the location specified in<em> step 6</em>.</li></ol></div><p>Once your project has been created, you will be presented with the Xcode development interface, along with the project files that the template created for you, within the<strong> Project Navigator</strong> window.</p><p>Our next step is to start building our user interface to obtain the Cloud URL, store keys, and documents within the Cloud, and look how to retrieve information from the Cloud:</p><div><ol class="orderedlist"><li class="listitem"> Select the<code class="literal"> iCloudExampleViewController.xib</code> file from within theiCloudExample folder within the<strong> Project Navigator</strong> window.</li><li class="listitem"> From the<strong> Object Library</strong>, select-and-drag a (<code class="literal">UIButton</code>) button control, onto the view.</li><li class="listitem"> Modify the<strong> Object Attributes</strong> of the button control, and set the title to read<strong> Geti Cloud URL</strong>.</li><li class="listitem"> Select-and-drag a (<code class="literal">UILabel</code>) label control, onto the view, and place it directly under the<strong> Get iCloud URL</strong> button.</li><li class="listitem"> Modify the<strong> Object Attributes</strong> of the label control, and set the<strong> Text</strong> property to read<strong> iCloud URL:</strong>.</li></ol></div><p>Repeat the previous steps to add the buttons and labels for the<strong> Store to iCloud, DocPath, Read from iCloud</strong>, and<strong> Item Value</strong>.</p><p>If you have followed everything correctly, your view should look like the next screenshot. Feel free to adjust yours accordingly.<a id="id88" class="indexterm"/>
</p><div><img src="img/2267EXP_02_13.jpg" alt="Creating the iCloudExample application"/></div><p>Now that we have created a user interface, you will need to bind up the controls to create the necessary events, and then follow these steps:</p><div><ol class="orderedlist"><li class="listitem"> Open the<code class="literal"> iCloudExampleViewController.h</code> interface file, located within the<code class="literal"> iCloudExample</code> folder of your project, and add the following code:<div><pre class="programlisting">#import&lt;UIKit/UIKit.h&gt;
@interfaceiCloudExampleViewController : UIViewController {
UILabel *iCloudURL;
UILabel *documentPath;
UILabel *authorName;
}
- (IBAction)getCloudURL:(id)sender;
- (IBAction)storeDocument:(id)sender;
- (IBAction)readDocument:(id)sender;
@property (strong, nonatomic) IBOutletUILabel *iCloudURL;
@property (strong, nonatomic) IBOutletUILabel *documentPath;
@property (strong, nonatomic) IBOutletUILabel *authorName;
@end
</pre></div></li><li class="listitem"> Open our<code class="literal"> iCloudExampleViewController.m</code> implementation file, located within the<code class="literal"> iCloudExample</code> folder of your project, and add the following highlighted code:<a id="id89" class="indexterm"/><div><pre class="programlisting">
#import "iCloudExampleViewController.h"<strong>
#import&lt;Foundation/Foundation.h&gt;
#import&lt;Foundation/NSObject.h&gt;</strong>
@implementationiCloudExampleViewController;<strong>
@synthesizeiCloudURL;
@synthesizedocumentPath;
@synthesizeauthorName;</strong>
</pre></div><div><h3 class="title"><a id="note100"/>Note</h3><p>If we don't declare these, we will receive compiler-warning messages, which can result in unexpected results occurring in your application, or even make your application terminate unexpectedly.</p></div></li><li class="listitem"> Next, we need to declare the method that will connect to the iCloud service, using our<code class="literal"> TEAMID</code> and the bundle identifier, and retrieve the iCloud URL. Enter in the following code snippet.<div><pre class="programlisting">// Function to obtain the iCloud URL based on the TEAMID
// and the Bundle Identifier
- (IBAction)getCloudURL:(id)sender {
// TeamID + Bundle Identifier
NSFileManager *fileManager = [NSFileManagerdefaultManager];
NSURL *CloudURL = [fileManager URLForUbiquityContainerIdentifier :@"TEAMID.com.yourcompany.iCloudExample"];
iCloudURL.text = [@"iCloudURL = " stringByAppendingFormat:@"%@", [CloudURLabsoluteString ]];
iCloudURL.numberOfLines = 4;
iCloudURL.textColor = [UIColorblueColor];
}
</pre></div></li><li class="listitem">When this button is executed, it will display the URL from your iCloud service, based on your TEAMID and bundle identifier.<p><code class="literal">file://localhost/private/var/mobile/Library/Mobile%20Documents/TEAMID~com~yourcompany~iCloudExample/</code>
</p></li><li class="listitem"> Next, we need to implement our method that will be used to store a document into our iCloud sandbox. Enter in the following code snippet :<a id="id90" class="indexterm"/><div><pre class="programlisting">- (IBAction)storeDocument:(id)sender {
// Store document in the Cloud
NSArray *searchPath = NSSearchPathForDirectoriesInDomains( NSDocumentDirectory, NSUserDomainMask, YES);
NSString *docPath = [searchPath objectAtIndex:0];
NSString *fileName = [NSStringstringWithFormat: @"%@/iCloudExample.doc",docPath];
NSString *fileContent = @"Welcome to storing documents using icloud. iCloud Rocks!!!";
// Now Save the content to the documents directory
[fileContentwriteToFile:fileNameatomically: NOencoding:NSStringEncodingConversionAllowLossyerror:nil];
NSURL *fileURL = [NSURL URLWithString:fileName];
documentPath.text = [@"DocPath = " stringByAppendingFormat: @"%@", [fileURLabsoluteString ]];
documentPath.textColor = [UIColorblueColor];
documentPath.lineBreakMode = UILineBreakModeWordWrap;
}
</pre></div></li><li class="listitem">When this button is executed, this will display the path to the documents folder, located within the iCloud application sandbox:<code class="literal">/var/mobile/Applications/6BF2CE1F-C184-43FA-8D00-E4D476F8A538/Documents/iCloudExample.doc</code>.</li><li class="listitem"> Next, if you open the<strong> Organizer</strong> window, by selecting<strong> Window|Organizer</strong>, you will notice that our<code class="literal"> iCloudExample.doc</code> has been added to our application sandbox.<a id="id91" class="indexterm"/><div><img src="img/2267EXP_02_14.jpg" alt="Creating the iCloudExample application"/></div></li><li class="listitem"> Next, we need to implement our method that will be used to add and retrieve key-value with our iCloud repository.<div><pre class="programlisting">- (IBAction)readAuthor:(id)sender {
NSUbiquitousKeyValueStore *cloudStore = [NSUbiquitousKeyValueStoredefaultStore];
[cloudStoresetString:@"John Grisham" forKey:@"FavoriteAuthor"];
// Important, as it first stores your in memory key values
// to disk based storage, prior to eventually storing this
//within iCloud
[cloudStore synchronize];
// Get the latest values from iCloud
authorName.text = [@"Favorite Author = " stringByAppendingFormat :@"%@", [cloudStorestringForKey:@"FavoriteAuthor"]];
authorName.textColor = [UIColorredColor];
authorName.lineBreakMode = UILineBreakModeWordWrap;
}
</pre></div></li><li class="listitem">When this button is executed, this will display the key entry value for our <strong>Favorite Author</strong> key-value data, located within the iCloud application sandbox: <strong>Favorite Author = John Grisham</strong>.</li><li class="listitem"> We are now ready to build and compile our<code class="literal"> iCloudExample</code> application. The following screenshot shows the output when each of the buttons is pressed:<a id="id92" class="indexterm"/></li></ol></div><div><img src="img/2267EXP_02_15.jpg" alt="Creating the iCloudExample application"/></div><p>So there you have it, we have successfully created a simple, yet powerful application that can communicate with iCloud to store documents and key-value data, and retrieve the data from the Cloud.<a id="id93" class="indexterm"/>
</p></div></div><div><div><div><div><h2 class="title"><a id="ch02lvl2sec04"/>Moving a document to iCloud storage</h2></div></div></div><p>When moving documents to iCloud, you have the ability to create additional subdirectories from within the container directory to manage your files.<a id="id94" class="indexterm"/>
</p><p>From a development point of view, it is recommended that when adding your documents to iCloud, you should create a<code class="literal"> Documents</code> subdirectory and use that directory for storing user documents. Within iCloud, the contents of the<code class="literal"> Documents</code> directory are made visible to the user so that individual documents can be deleted, whereas, everything outside of the<code class="literal"> Documents</code> directory is grouped together, and treated as a single entity that a user can keep or delete.</p><p>The following code snippet creates and saves the file locally within your application sandbox first, before moving the file to the specified destination within iCloud.</p><div><pre class="programlisting">// TeamID + Bundle Identifier
NSFileManager *fileManager = [NSFileManagerdefaultManager];
NSURL *CloudURL = [fileManager URLForUbiquityContainerIdentifier: @"TEAMID.com.yourcompany.iCloudExample"];
NSString *docString = @"Documents";
NSURL *tempURL = [NSURL URLWithString:docString];
BOOL myVal = [fileManagersetUbiquitous:YESitemAtURL: fileURLdestinationURL:CloudURLerror:NULL];
</pre></div><p>In this code snippet, we create an<code class="literal"> NSURL</code> object that specifies the destination of the file within the user's iCloud storage. We then make a call to the<code class="literal"> URLForUbiquityContainerIdentifier:</code> method of the<code class="literal"> NSFileManager</code> classto get the root URL for the directory, and then append any additional directory and filenames to that URL. Finally, we call the<code class="literal"> setUbiquitous:itemAtURL:destinationURL:error:</code> method of<code class="literal"> NSFileManager</code>, to move the file to the specified destination in iCloud.<a id="id95" class="indexterm"/>
</p></div><div><div><div><div><h2 class="title"><a id="ch02lvl2sec05"/>iCloud storage APIs</h2></div></div></div><p>The iCloud storage APIs let your application write user documents and data to a central location, and access those items from all of a user's computers and iOS devices.<a id="id96" class="indexterm"/>
</p><div><h3 class="title"><a id="tip01"/>Tip</h3><p>Making a user's documents ubiquitous using iCloud, means that a user can view or edit those documents from any device without having to sync or transfer files explicitly.</p></div><p>Storing documents in a user's iCloud account provides a layer of security for that user. If the user happens to lose their device, any documents that were saved on it can easily be recovered if they are contained within iCloud storage. There are two ways to utilize iCloud storage, each with its own significant purpose. These are explained in the following table:<a id="id97" class="indexterm"/>
</p><div><table border="1"><colgroup><col style="text-align: left"/><col style="text-align: left"/></colgroup><thead><tr><th style="text-align: left" valign="bottom">
<p><strong>Storage type</strong></p>
</th><th style="text-align: left" valign="bottom">
<p><strong>Description</strong></p>
</th></tr></thead><tbody><tr><td style="text-align: left" valign="top">
<p>iCloud document storage</p>
</td><td style="text-align: left" valign="top">
<p>Use this feature to store user documents and data in the user's iCloud account. Refer to the section<em> Storing and using documents in iCloud</em>, located within this chapter.</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>iCloud key-value data storage</p>
</td><td style="text-align: left" valign="top">
<p>Use this feature to share small amounts of data among instances of your application. Refer to the section<em> Storing Key-Value data in iCloud</em>, located within this chapter.</p>
</td></tr></tbody></table></div><p>Most applications that you create will use the iCloud document storage to share documents from a user's iCloud account. This will provide the ability to share documents across multiple devices, and manage documents from a given device.<a id="id98" class="indexterm"/>
</p><p>When using the iCloud key-value data store, this is not something that a user will see, as this is handled your application and shares only small amounts of information; this information is used only by the application. An example of this would be that you can store the time the user logged in to your application, or what screen they are currently viewing.</p><p>The following screenshot shows the process involved when creating information within local iCloud storage, within your application's sandbox.</p><div><img src="img/2267EXP_02_16.jpg" alt="iCloud storage APIs"/></div><div><h3 class="title"><a id="note13"/>Note</h3><p>For more information on how to go about storing and using documents within iCloud, refer to the section<em> Storing and using documents in iCloud</em>, located within this chapter.</p></div></div><div><div><div><div><h2 class="title"><a id="ch02lvl2sec06"/>Searching for documents in iCloud</h2></div></div></div><p>There may be times when you need to check to see if a document exists at a location within the Cloud, prior to modifying the document. An example would be, say you wanted to check if a document existed prior to opening it within your application. If you don't perform a check and try to open this, you will receive an error.</p><p>Another case could be that you need to remove a file from your iCloud repository; you would still need to perform a check to ensure that the document indeed exists prior to attempting to remove this file, otherwise you will receive an improperly handled error, resulting in your application crashing.</p><p>To achieve any of these case scenarios, you will need to search the iCloud repository using the<code class="literal"> NSMetadataQuery</code> object. Searching through the iCloud repository is a guaranteed way to locate documents, both in a user's iCloud storage and from within your application sandbox.</p><p>You should always use query objects instead of saving URLs persistently, because the user can delete files from iCloud storage when your application is not running. Using a query to search is the only way to ensure an accurate list of documents.</p><div><pre class="programlisting">NSMetadataQuery *mdQuery = [[NSMetadataQueryalloc] init];
[mdQuerysetPredicate:[NSPredicatepredicateWithFormat:@"(kMDItemFSName LIKE 'iCloudDoc *')"]];
[[NSNotificationCenterdefaultCenter] addObserver:selfselector: @selector(processQuery:) name:nilobject:mdQuery];
[mdQuerystartQuery];
</pre></div><p>The following code snippet displays the associated<code class="literal"> processQuery</code> method of the<code class="literal"> NSNotification</code> class, and shows how we can perform and handle comparisons for each of the various<code class="literal"> NSMetadataQuery</code> notification methods.</p><div><pre class="programlisting">-(void)processQuery:(NSNotification *)notification {
NSMetadataQuery *mdQuery = [notification object];
if ([[notification name] isEqualToString: NSMetadataQueryDidStartGatheringNotification]) {
NSLog(@"%@ %@ Query started", [self class], NSStringFromSelector(_cmd));
}
else if ([[notification name] isEqualToString: NSMetadataQueryGatheringProgressNotification]) {
NSLog(@"%@ %@ %ld", [self class], NSStringFromSelector(_cmd), (long)[mdQueryresultCount]);
}
else if ([[notification name] isEqualToString: NSMetadataQueryDidFinishGatheringNotification]) {
NSUIntegertheResultCount = [mdQueryresultCount];
theResultCount = 20;
for (NSUIntegeri; i&lt;theResultCount; i++) {
NSLog(@"%@ %@ %ld %@", [self class], NSStringFromSelector(_cmd), (long)i, [mdQueryresultAtIndex:i]);
}
}
else {
NSLog(@"%@ %@ NSMetadataQueryDidUpdateNotification: %@", [self class], NSStringFromSelector(_cmd), notification);
}
}
</pre></div><p>In iOS 5.0, the<code class="literal"> NSMetadataQuery</code> class supports several search scopes for your documents. This is shown in the following table.<a id="id99" class="indexterm"/>
</p><div><table border="1"><colgroup><col style="text-align: left"/><col style="text-align: left"/></colgroup><thead><tr><th style="text-align: left" valign="bottom">
<p><strong>NSMetadataQueryclass methods</strong></p>
</th><th style="text-align: left" valign="bottom">
<p><strong>Description</strong></p>
</th></tr></thead><tbody><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">NSMetadataQueryUbiquitousDocumentsScope</code>
</p>
</td><td style="text-align: left" valign="top">
<p>Use this feature to search for documents in iCloud that reside inside a documents directory (for any given container directory, put documents that the user is allowed to access inside a documents subdirectory).</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">NSMetadataQueryUbiquitousDataScope</code>
</p>
</td><td style="text-align: left" valign="top">
<p>Use this feature to search for documents in iCloud that reside anywhere other than in a documents directory (for any given container directory, use this scope to store user-related data files that your application needs to share, but are not files you want the user to manipulate directly).</p>
</td></tr></tbody></table></div></div><div><div><div><div><h2 class="title"><a id="ch02lvl2sec07"/>Working with documents in iCloud</h2></div></div></div><p>When your application needs to read or write a document in iCloud, it must do so in a coordinated manner. Your application might not be the only application trying to manipulate the local file at any given moment. The daemon that transfers the document to and from iCloud also needs to monitor the file periodically. To prevent your application from interfering with the daemon (and vice versa), iOS provides a coordinated locking mechanism that works with the files and directories you target for iCloud storage.<a id="id100" class="indexterm"/>
</p><p>At the heart of the iCloud locking mechanism are file coordinators and file presenters.</p><div><div><div><div><h3 class="title"><a id="ch02lvl3sec02"/>The file coordinator</h3></div></div></div><p>Whenever you need to read and write a file, you do so using a file coordinator, which is an instance of the<code class="literal"> NSFileCoordinator</code> class. The job of a file coordinator is to coordinate the reads and writes performed by your application and the sync daemon on the same document. For example, your application and the daemon may both read the document at the same time, but only one may write to the file at any single time.<a id="id101" class="indexterm"/>
</p><p>Also, if one process is reading the document, the other process is prevented from writing to the document, until the earlier process is finished reading the document.<a id="id102" class="indexterm"/>
</p></div><div><div><div><div><h3 class="title"><a id="ch02lvl3sec03"/>The file presenter</h3></div></div></div><p>In addition to coordinating operations, file coordinators also work with file presenters to notify applications when changes are about to occur. A file presenter is any object that conforms to the<code class="literal"> NSFilePresenter</code> protocol, and takes responsibility for managing a specific file (or directory of files) in an application.<a id="id103" class="indexterm"/>
</p><p>The job of a file presenter is to protect the integrity of its own data structures. It does this by listening for messages from other file coordinators and using those messages to update its internal data structures. In most cases, a file presenter may not have to do anything. However, if a file coordinator declares that it is about to move a file to a new URL, the file presenter would need to replace its old URL with the new one provided to it by the file coordinator.<a id="id104" class="indexterm"/>
</p></div></div><div><div><div><div><h2 class="title"><a id="ch02lvl2sec08"/>Handling file-version conflicts</h2></div></div></div><p>Handling version conflicts of files is a common issue in software development. With iCloud, we need to be able to handle this when multiple instances of your application are running on multiple devices, and both try to modify the same document. This will result in a conflict when both devices try to upload the changes made to the file at the same time.<a id="id105" class="indexterm"/>
</p><p>At this point, iCloud will end up with two different versions of the same file, and has to decide what to do with them. Its solution is to make the most recently modified file the current file, and to mark any other versions of the file as conflict versions.</p><p>To avoid loss of changes made to those documents, your application will need to prompt the user to choose the appropriate course of action to take. For example, you might let the user choose which version of the file to keep, or you might offer to save the older version under a new name.</p><p>You would need to determine the current files, version, using the<code class="literal"> currentVersionOfItemAtURL:</code> class method, and then obtain an array of the conflicted versions, by using the class method call to<code class="literal"> unresolvedConflictVersionsOfItemAtURL:</code>.</p><p>For each conflicted file version, you will need to perform the appropriate cause of action to resolve the conflict, by using any of these actions, listed as follows:<a id="id106" class="indexterm"/>
</p><div><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">Merge the conflicted versions with the current file automatically, if this is practical to do so.</li><li class="listitem" style="list-style-type: disc">Choose to ignore the conflicted versions, which will result in data being lost in those files.</li><li class="listitem" style="list-style-type: disc">Prompt the user to select the appropriate course of action, and decide which of the versions that they should indeed keep. This should always be your last course of action.</li></ul></div></div><div><div><div><div><h2 class="title"><a id="ch02lvl2sec09"/>Using iCloud storage responsibly</h2></div></div></div><p>Applications that take advantage of iCloud storage features should act responsibly when storing data. The space available in each user's account is limited and is shared by all applications. In addition, users can see how much space is consumed by a given application, and choose to delete documents and data associated with that particular application. For these reasons, it is in your application's interest to be responsible about what files you store. Here are some tips to help you manage documents appropriately:<a id="id107" class="indexterm"/>
</p><div><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">Rather than storing all documents, let a user choose which documents to store in an iCloud account. If a user creates a large number of documents, storing all of those documents in iCloud could overwhelm that user's available space. Providing a way for a user to designate which documents to store in iCloud, gives that user more flexibility in deciding how best to use the available space.</li><li class="listitem" style="list-style-type: disc">Remember that deleting a document removes it from a user's iCloud account and from all of that user's computers and devices. Make sure that users are aware of this fact and confirm any delete operations. For your application to remove the local copy of a document, and then download a fresh copy from iCloud, use the<code class="literal"> evictUbiquitousItemAtURL:error:</code> method of<code class="literal"> NSFileManager</code>.<a id="id108" class="indexterm"/></li><li class="listitem" style="list-style-type: disc">When storing documents in iCloud, place them in a documents directory whenever possible. Documents inside a documents directory can be deleted individually by the user to free up space. However, everything outside that directory is treated as data, and must be deleted all at once.</li><li class="listitem" style="list-style-type: disc">Never store caches or other files that are private to your application in a user's iCloud storage. A user's iCloud account should only be used for storing user data and content.</li><li class="listitem" style="list-style-type: disc">Treat files in iCloud the same way you treat all other files in your application sandbox. The time at which to save a file should be driven by the need of your application, and the need to preserve the user's data. You should not change your application to save files more or less frequently for iCloud. iCloud automatically optimizes its transfers to the server to ensure the best possible performance.<a id="id109" class="indexterm"/></li></ul></div><p>iCloud secures your content by encrypting it using SSL, when it is being sent over the internet. This results in your content being stored in encrypted format, and uses secure tokens for authentication.</p><div><h3 class="title">Note</h3><p>For more information on how to go about storing and using documents within iCloud, refer to the section<em> Storing and using documents in iCloud</em>, located within this chapter.</p></div></div></div>
<div><div><div><div><h1 class="title"><a id="ch02lvl1sec03"/>Summary</h1></div></div></div><p>In this chapter, we learned about the benefits of using iCloud, and how to access them through their storage APIs. We looked at how we can incorporate iCloud features within our code, how to store and retrieve key-value data, and how to store documents within a folder inside our application sandbox.</p><p>We also learned about the process involved in how to search and locate a document within an iCloud repository, as well as learned to handle and avoid file-version conflicts when multiple copies of the same file are being updated on more than one device, and then being submitted to the iCloud repository.</p><p>In the next chapter, we will learn about the new debugging features of OpenGL ES, and how this new debugger in Xcode allows you to track-down issues specific to OpenGL ES directly within your code, right from within the IDE.</p></div></body></html>