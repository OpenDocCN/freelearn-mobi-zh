<html><head></head><body><h1 id="e-k8q8">Chapter 5. Posting on Walls</h1>
<p id="e-dfwQ">In this chapter we will implement the UI and the logic to enable the application to post on the current users' and their friends' walls.</p>
<p id="e-GCZW">We will start implementing the user interface that will allow the user to review the information to be posted before actually sending the data to the Facebook Platform. We will define the step to post on the current user's wall and customize the post dialog.</p>
<p id="e-sTEk">We will learn how to tag friends on posts, add context to posts (for example, location), and upload pictures on the Platform.</p>
<h1 id="e-h9C3">Creating the Post Dialog interface</h1>
<p id="e-sGt0">Creating a post on the Facebook Platform means publishing an action on the Facebook News Feed. This can be done using the Open Graph API, which is available in Facebook SDK 2.x, versus the new Native or Web Dialogs with Version 3.x of the framework. Note that you can still use Open Graph APIs to publish on your Feed.</p>
<p id="e-xyqj">In order to post on the Facebook News Feed, we first need to ask the user for permission to write on their feed; more specifically, <code>publish_actions</code>. Once the application is granted permission, we can use the following components:</p>
<ul id="e-syPW">
<li id="e-CLEh">
<code>FBNativeDialogs</code>: This is used to provide a native user interface. It is available on iOS 6 and above with a Facebook account set up on the device.</li>
<li id="e-jJgk">
<code>FBWebDialogs</code>: This is used to present Web Dialogs to publish on Open Graph.</li>
</ul>
<p id="e-DHJR">Native Dialogs are the ideal choice to share information on the Platform because they require less code to write and offer more out-of-the-box features; for example, location tags and privacy settings (see the following screenshot).</p>
<img data-width="500" data-height="321" src="kfNmAJlN.jpg"/><p id="e-pksg">The Feed Share dialog</p>
<p id="e-Pvfe">The previous screenshot shows a Native Dialog with feed content and also offers the ability to tag the current location through the <strong>Add Location</strong> button and change the privacy settings using the <strong>Friends</strong> button.</p>
<h2 id="e-gRn2">Creating the book model</h2>
<p id="e-aXxy">Before starting to implement the actual share functionality, we need a way to pass the information from <code>LBViewController</code>, the book info controller, to the Facebook View Controller. In order to pass that information, we are going to create a new model class. Model is the type of class that is used to store information with no logic associated with it.</p>
<p id="e-BeFM">To create a new model class, right-click on the main folder (aka <code>Group</code>) in Project Navigator, create a new group, and name it <code>models</code>. Right-click on <code>models</code> and create a new file. Choose the <strong>Objective-C</strong> class and set the <strong>Class</strong> field as <code>LBBook</code>, subclass of <code>NSObject</code>. Save these settings and we will have our new <code>LBBook</code> class in the <code>models</code> group. The following screenshot shows the project structure after creating the new <code>model</code> book class:</p>
<img data-width="427" data-height="500" src="F6f7U6Th.jpg"/><p id="e-i3ee">Project structure after adding the LBBook class</p>
<p id="e-PK7r">We need to populate the <code>model</code> class with the necessary properties to contain the book's information. We need the following properties:</p>
<ul id="e-gAOs">
<li id="e-c5GO"><code>Title</code></li>
<li id="e-fN3f"><code>Author</code></li>
<li id="e-nxg2"><code>Review</code></li>
<li id="e-df44"><code>Score</code></li>
</ul>
<p id="e-ARQe">Open the <code>LBBook.h</code> file and add the preceding properties as shown in the following code snippet:</p>
<pre id="e-b8jc">#import &amp;lt;Foundation/Foundation.h&amp;gt;
 @interface LBBook : NSObject
 @property (strong, nonatomic) NSString *title;
 @property (strong, nonatomic) NSString *author;
 @property (strong, nonatomic) NSString *review;
 @property (strong, nonatomic) NSNumber *vote;
 @end</pre>
<p id="e-br4y">We do not need to  customize the <code>LBBook.m</code> file. As mentioned before, we are going to use this class only as a container. No more coding is required for this model.</p>
<h2 id="e-ivr1">Passing information between controllers</h2>
<p id="e-RAcH">We need to collect the user inputs though the <code>LBViewController</code> interface. We can proceed following two different approaches. The first will require creating a reference for each of the UI input components in <code>LBViewController</code> and collecting the data when the user clicks on the <strong>Go Social</strong> button. The other technique will require updating the book information every time the user edits the book information through the interface. Both techniques need to have an instance of the <code>LBBook</code> class as a private property of the <code>LBViewController</code>. We are going to pursue the first approach and collect all information as the user clicks on the <strong>Go Social</strong> button.</p>
<p id="e-UuRV">Open <code>LBViewController.m</code> and import the <code>LBBook.h</code> file. The new book property will be private; therefore, edit the interface statement by adding the code as shown in the following code snippet:</p>
<pre id="e-gRwx">#import "LBBook.h"
 @interface LBViewController ()
 @property (strong, nonatomic) LBBook *book;
 @end</pre>
<p id="e-RmDG">In order to collect the book information provided by the user, we need to have references for each of the UI components in the <code>LBViewController.m</code> interface statement. To create these references, open Storyboard and select <strong>Book Scene</strong>. Open <code>LBViewController.m</code> as a file in the Assistant Editor window. Drag-and-drop each of the UI input controls within the <code>interface</code> statement to create a reference to it:</p>
<pre id="e-G6PF">#import "LBViewController.h"
#import "LBBook.h"
#import "LBFacebookViewController.h"
 
@interface LBViewController ()
 @property (strong, nonatomic) LBBook *book;
 // UI input fields
@property (weak, nonatomic) IBOutlet UITextField *titleField;
@property (weak, nonatomic) IBOutlet UITextField *authorField;
@property (weak, nonatomic) IBOutlet UITextView *reviewField;
@property (weak, nonatomic) IBOutlet UITextField *voteField;
 @end</pre>
<p id="e-vxfF">As we already anticipated, we are going to collect the book information from the view after the user clicks on the <strong>Go Social</strong> button. We need to create a method to bind the button event. For the book scene, press and hold the <em>Ctrl</em> button and drag-and-drop the button within the <code>implementation.m</code> statement in the <code>LBViewController</code> file to create a handler method. Set the name of the new method as <code>onGoSocialClick</code>.</p>
<p id="e-segP">Within the new method, we need to collect the book information and populate the <code>LBBook</code> instance with such information. We first need to check if the book property is already initialized; if it is not, we need to take care of it. For each of the UI inputs, we are going to set the corresponding property in the <code>book</code> property.</p>
<pre id="e-i0aX">- (IBAction)onGoSocialClick:(id)sender {
    // check if self.book is already initialized
    if (self.book == nil) {
        // init self.book
        self.book = [[LBBook alloc] init];
    }
    // set book title using the correspondent field text or empty string
    self.book.title = self.titleField.text ? self.titleField.text : @"";
    
    // set book author using the correspondent field text or empty string
    self.book.author = self.authorField.text ? self.authorField.text : @"";
    
    // set book review using the correspondent field text or empty string
    self.book.review = self.reviewField.text ? self.reviewField.text : @"";
    
    // set book review using the correspondent field text or empty string
    self.book.vote = self.voteField.text ? [NSNumber numberWithInt:self.voteField.text.intValue] : [NSNumber numberWithInt:-1];
}</pre>
<p id="e-OdOr">The preceding code snippet shows the final version of the <code>onGoSocialClick</code> method. Before setting any of the book properties, we need to check whether the corresponding UI input field is different from NIL; if so, we use an empty string. We should perform some sort of validation on the data provided; for example, the book title should not be empty. We are going to implement validation before posting the book information on the user's wall.</p>
<p id="e-Na4e">Now that we have the book variable populated with the current information provided by the user, we need to create a similar property in <code>LBFacebookViewController.h</code> but accessible from other classes. Using this approach, <code>LBViewController</code> can update book properties on <code>LBFacebookViewController</code> and the post methods will have access to such data.</p>
<p id="e-KtTZ">Open <code>LBFacebookViewController.h</code> and create a new <code>LBBook</code> property. This time the property will not be defined as <code>strong</code>, since we already have a <code>strong</code> reference to the same memory, but as <code>weak</code>. Memory management is out of the scope of this book. If you have any trouble understanding the <code>weak</code>/<code>strong</code> concept, you can take a look at the ARC documentation provided by Apple, which can be found at:</p>
<p id="e-FtCO"><a href="http://developer.apple.com/library/ios/#releasenotes/ObjectiveC/RN-TransitioningToARC/Introduction/Introduction.html">http://developer.apple.com/library/ios/#releasenotes/ObjectiveC/RN-TransitioningToARC/Introduction/Introduction.html</a></p>
<pre id="e-qMIu">#import "LBBook.h"
 @interface LBFacebookViewController : UIViewController
 // Current book data. Initialized by LBViewController using segue
@property (weak, nonatomic) LBBook *book;
 @end</pre>
<p id="e-I2Ch">Now we need to focus on passing the book object from <code>LBViewController</code> to <code>LBFacebookViewController</code>. We are going to use the segue that links the book scene with Facebook and overrides the segue handler method in <code>LBViewController</code>. First we need to define an identifier for the segue. Open Storyboard and select the segue between the book and the Facebook Scene. Open the Utilities Panel and within Attribute Inspector set the identifier for the segue as <code>GoSocialSegue</code>.</p>
<p id="e-jlUN">Using the segue, we can pass data from the source to the destination controller, which is exactly what we are going to do. Each time a segue is performed, the application calls a method in the source controller that can be overridden at our own convenience.</p>
<p id="e-GWnG">Open <code>LBFacebookViewController.m</code> and override the following method:</p>
<pre id="e-QFsT">- (void)prepareForSegue:(UIStoryboardSegue *)segue sender:(id)sender</pre>
<p id="e-EPx0">If the current segue has the <code>GoSocialSegue</code> identifier, we can set the destination controller book property with the current <code>book</code> property defined in <code>LBViewController</code>. The following code snippet shows the code for the preceding method.</p>
<pre id="e-QQxx">- (void)prepareForSegue:(UIStoryboardSegue *)segue sender:(id)sender
{
    if ([segue.identifier isEqualToString:@"GoSocialSegue"]) {
        if ([segue.destinationViewController isKindOfClass:[LBFacebookViewController class]]) {
            LBFacebookViewController *facebookController = segue.destinationViewController;
            [facebookController setBook:self.book];
        }
    }
}</pre>
<p id="e-p3qI">In the preceding code, we double-check the segue destination <code>viewController</code> class type and set the <code>book</code> property with the current one.</p>
<p id="e-fg5W">We are now able to pass book information from one controller to another.</p>
<h2 id="e-uXYo">Feed Share Dialogs</h2>
<p id="e-zYPe">Now that we have the book information stored in <code>LBFacebookViewController</code>, we can create the Native and Web Feed dialogs in order to share information on the user's wall.</p>
<p id="e-BHK8">Before starting the implementation of the Feed Dialogs, we need to ask the user for <code>publish_action</code> permissions. When the application is granted publishing permissions, we can focus on the dialogs' implementation.</p>
<p id="e-RYNX">We will use both Native and Web Dialogs to publish on a user's timeline.</p>
<h2 id="e-g2s8">Upload action permission</h2>
<p id="e-LQ37">We are going to check if our application has been granted publish action permissions every time the user is trying to create a new Feed on the Platform.</p>
<p id="e-NSY6">We need to create a new button that will allow the user to create a new Feed and send the current book information to Open Graph. The current Facebook Scene layout doesn't easily allow adding new components but we can always rearrange UI components in a different way. Open Storyboard and rearrange the Facebook Scene. The next picture shows the new Facebook scene layout.</p>
<img data-width="297" data-height="500" src="coVtgD7e.jpg"/><p id="e-pVZ1">The new Facebook Scene layout</p>
<p id="e-p1gc">From the preceding screenshot, we can see that the profile picture, name, and e-mail labels are smaller and in different positions. Now drag-and-drop a new button above the <strong>Friends</strong> button and name it <code>Book on Feed</code>. The following screenshot shows the Facebook Scene with the new button.</p>
<img data-width="287" data-height="500" src="g381pgNM.jpg"/><p id="e-t4JK">The Book on Feed button</p>
<p id="e-bhMB">This button should behave exactly like the <strong>Friends</strong> button; it will only be activated after the user logs in successfully; therefore, we need a reference of the button within the <code>LBFacebookViewController.m</code> file's <code>interface</code> statement.</p>
<img data-width="800" data-height="307" src="rVfaTdd3.jpg"/><p id="e-Ngge">The Book on Feed button reference</p>
<p id="e-RKPo">We need to map the <strong>Book on Feed</strong> button's click event with a new method. Open Assistant Editor and with the <code>LBFacebookViewController.m</code> file open, hold the <em>Ctrl</em> button and create a connection within the <code>implementation</code> statement inside the file. This will allow the user to publish the current book information on News Feed.</p>
<img data-width="750" data-height="364" src="qoGgPgQz.jpg"/><p id="e-voVQ">The Book on Feed button's click handler reference</p>
<p id="e-wPw4">As we already anticipated, we need to ask the user for permission to publish on their News Feed. Asking for publishing permissions is pretty easy; we only need to call a method from the <code>FBSession</code> object. The <code>FBSession</code> object is a singleton component that keeps track of the current user's Facebook session status. The <code>FBLoginView</code> component interacts with <code>FBSession</code> every time the user logs in and out in order to keep the session up to date; therefore, we can use this session object to perform any request after the user has successfully logged in.</p>
<p id="e-ou9h">Within the <code>onBookOnFeedClick</code> method, a publish action permission request will be sent to the user and the user's response will be saved on the Facebook Platform. Based on the user's response, the application will continue posting the current book information or display a message that alerts the user to the missing permission.</p>
<pre id="e-o7QM">- (IBAction)onBookOnFeedClick:(id)sender {
    
    if (![FBNativeDialogs canPresentShareDialogWithSession:nil]) {
        UIAlertView *pickWallMessage  = [[UIAlertView alloc] initWithTitle:@"Where to post"
                                                                   message:@"Pick a Wall"
                                                                  delegate:self
                                                         cancelButtonTitle:@"cancel"
                                                         otherButtonTitles:@"mine", @"friend's", nil];
        [pickWallMessage show];
    } else {
        [self checkForPublishPermissionAndPublish];
    }
}</pre>
<p id="e-riHz">The preceding screenshot shows how to check whether the application is already granted <code>publish_action</code> permission. If not, we will perform a request for publishing permission using the currently active Facebook sessions. When we ask for publish action permissions, we also need to define the audience for the new post; for example, <code>FBSessionDefaultAudienceEveryone</code>. The types of audience values we can set are the following:</p>
<ul id="e-a4j0">
<li id="e-LNN5">
<code>FBSessionDefaultAudienceNone</code>: This defines only Facebook Platform as the audience. No other users have access.</li>
<li id="e-ju3U">
<code>FBSessionDefaultAudienceOnlyMe</code>: This defines the current user only as the audience for the new story.</li>
<li id="e-LoRl">
<code>FBSessionDefaultAudienceFriends</code>: This defines the user's friends as the audience.</li>
<li id="e-NzwK">
<code>FBSessionDefaultAudienceEveryone</code>: This defines the current post as public. Everyone can read it.</li>
</ul>
<p id="e-fgdI">The <code>completionHandler</code> method checks whether the user has given permission for the current action. If permission was given, the application will prompt a window interface with the new post information using the <code>publishCurrentBook</code> method, which will be discussed later in the Facebook and Native sections of this chapter. If the user doesn't grant permissions, we will have to show an alert message through <code>showDeniedPermissionAlertMessage</code>. The following code snippet demonstrates the usage of the <code>showDeniedPermissionAlertMessage</code> method:</p>
<pre id="e-Cx8G">- (void)showDeniedPermissionAlertMessage:(NSString *)message
{
    UIAlertView *deniedPermissionMessage = [[UIAlertView alloc] initWithTitle:@"Permission Error"
                                                                      message:message
                                                                     delegate:nil
                                                            cancelButtonTitle:nil
                                                            otherButtonTitles:@"OK", nil];
    [deniedPermissionMessage show];
}</pre>

<h1 id="e-AuIF">Facebook Web Dialogs</h1>
<p id="e-FFYD">The Web Dialog class was introduced with Version 3 of the Facebook iOS SDK. For more details, visit <a href="https://developers.facebook.com/docs/reference/ios/3.6/class/FBWebDialogs/">https://developers.facebook.com/docs/reference/ios/3.6/class/FBWebDialogs/</a>.</p>
<p id="e-sWiF">This type of dialog is supported across all iOS versions and without setting a Facebook account on the current device.</p>
<p id="e-TdVy">Web Dialog is a useful component to show the Feed Dialog that will allow users to publish a story to a profile's timeline. For more details on this, visit <a href="https://developers.facebook.com/docs/reference/dialogs/feed/">https://developers.facebook.com/docs/reference/dialogs/feed/</a>.</p>
<p id="e-X11k"><code>FBWebDialogs</code> provides static methods to publish information on the timeline and sends requests to friends.</p>
<p id="e-Wzw7">In this part of the book, we are going to explore the implantation of the following method:</p>
<pre id="e-GqZN">presentDialogModallyWithSession:parameters:handler</pre>
<p id="e-z6ai">We are going to use the current Facebook open session and the book information to populate the input parameters for the preceding method.</p>
<p id="e-CR9s">Create a new method in the <code>LBFacebookViewController.m</code> file named <code>displayWebPostDialog</code> with <code>dictionary</code> as the input parameter. The following code snippet demonstrates the implementation of this method.</p>
<pre id="e-MLZo">- (void)displayWebPostDialog:(NSDictionary *)params
{
    [FBWebDialogs presentFeedDialogModallyWithSession:FBSession.activeSession
                                           parameters:params
                                              handler:
     ^(FBWebDialogResult result, NSURL *resultURL, NSError *error) {
         if (error) {
             NSLog(@"Error publishing story.");
         } else {
             if (result == FBWebDialogResultDialogNotCompleted) {
                 NSLog(@"User canceled story publishing.");
             } else {
                 NSLog(@"Story posted");
             }
         }
     }];
}</pre>
<p id="e-u6ju">When we call the static method <code>presentFeedDialogModallyWithSession</code>, the application will show the user a window with post information, similar to the following screenshot:</p>
<img data-width="500" data-height="366" src="W39kwaeg.jpg"/><p id="e-CTFw">Post on the Timeline Dialog</p>
<p id="e-JCgn">The missing piece now is to understand which part of the code is calling <code>displayWebPostDialog</code> and passing the right information to populate the Facebook Web Dialog.</p>
<p id="e-tqDG">Create the  <code>publishCurrentBook</code> method within the <code>LBFacebookViewController.m</code> file. For now, the method will create the dictionary for the Web Dialog information populated with the book data and invoke the <code>displayWebPostDialog</code> method.</p>
<pre id="e-ZnuB">- (void)publishCurrentBook
{
    BOOL displayNativePostDialog = [self displayNativePostDialog];
    
    // NO FACEBOOK INTEGRATION
    if (!displayNativePostDialog) {
        // Create dictionary for Facebook web dialog
        NSString *name = [NSString stringWithFormat:@"Checkout %@", self.book.title];
        NSString *caption = [NSString stringWithFormat:@"Score %@", self.book.vote];
        NSString *description = self.book.review;
        NSString *pictureUrl = @"http://www.iconpot.com/icon/thumbnail/open-book-vector.jpg";
        
        
        NSMutableDictionary *params = [NSMutableDictionary dictionaryWithObjectsAndKeys:
                                       name, @"name",
                                       caption, @"caption",
                                       description, @"description",
                                       pictureUrl, @"picture",
                                       nil];
        
        if (!self.myWall) {
            [params setObject:self.selectedFriend.id forKey:@"to"];
            self.myWall = YES;
        }
        
        [self displayWebPostDialog:params];
    }
}</pre>
<p id="e-ThOG">The  <code>publishCurrentBook</code> method reads the book information from the internal property book that was initialized by <code>onGoSocialSegue</code>.</p>
<p id="e-RsY4">The book fields will be used to populate the Web Dialog information. The following screenshot shows the map between the dictionary keys and the Web Dialog interface components:</p>
<img data-width="322" data-height="236" src="Yn7X7YMS.jpg"/><p id="e-I8D0">The Web dialog with book information</p>
<p id="e-FjHt">The user will be able to add more information through the textbox and be able to confirm or cancel the story. The following screenshot shows the story on Facebook's Timeline:</p>
<img data-width="514" data-height="210" src="PZwuQHRt.jpg"/><p id="e-i61i">A user post on the Timeline</p>
<h2 id="e-R1LB">Publishing on a friend's wall</h2>
<p id="e-mUnm">We need to give the user the ability to choose which Facebook wall to post the story on, updating the UI and the logic. The <strong>Book on Feed</strong> button will trigger a UI alert message that will let us choose which Wall to use instead of trying to post the story. The feature to publish on a friend's Wall will only be available using <code>FBWebDialogs</code>.</p>
<p id="e-Elv7">Create a new method, <code>checkForPublishPermissionAndPublish</code>, within <code>LBFacebookViewController.m</code>. Move the content from the <code>onBookOnFeedClick</code> method to the new method just created. The following code shows the new method body:</p>
<pre id="e-DlI2">- (void)checkForPublishPermissionAndPublish
{
    // Ask for publish_actions permissions in context
    if ([FBSession.activeSession.permissions indexOfObject:@"publish_actions"] == NSNotFound) {
        [FBSession.activeSession requestNewPublishPermissions:[NSArray arrayWithObject:@"publish_actions"]
                                              defaultAudience:FBSessionDefaultAudienceFriends
                                            completionHandler:^(FBSession *session, NSError *error) {
                                                if (!error) {
                                                    [self publishCurrentBook];
                                                } else {
                                                    if (error.fberrorCategory == FBErrorCategoryUserCancelled) {
                                                        [self showDeniedPermissionAlertMessage:@"Publish Action Permission was not granted"];
                                                    }
                                                }
                                            }];
    } else { // If permissions present, publish the story
        [self publishCurrentBook];
    }
}</pre>
<p id="e-VuiI">We need to create the <code>UIAlertMessage</code> interface to allow the user to choose between Walls. In order to catch the user's response on the <code>UIAlertMessage</code> interface, we need to set <code>LBFacebookViewController</code> as <code>UIAlertViewDelegate</code>. The following code snippet shows the new delegate extension.</p>
<pre id="e-AgVV">@interface LBFacebookViewController () &amp;lt;FBLoginViewDelegate, FBFriendPickerDelegate, UIAlertViewDelegate&amp;gt;</pre>
<p id="e-V3B7">Modify <code>onBookOnFeedClick</code> to display the alert message to the user as displayed in the following code.</p>
<pre id="e-adS2">- (IBAction)onBookOnFeedClick:(id)sender {
    
    if (![FBNativeDialogs canPresentShareDialogWithSession:nil]) {
        UIAlertView *pickWallMessage  = [[UIAlertView alloc] initWithTitle:@"Where to post"
                                                                   message:@"Pick a Wall"
                                                                  delegate:self
                                                         cancelButtonTitle:@"cancel"
                                                         otherButtonTitles:@"mine", @"friend's", nil];
        [pickWallMessage show];
    } else {
        [self checkForPublishPermissionAndPublish];
    }
}</pre>
<p id="e-uKFm">In the following screenshot, we are giving the user the option to choose between their wall or their friend's wall:</p>
<img data-width="278" data-height="248" src="kmU18Oju.jpg"/><p id="e-w549">UIAlertMessage – Wall options</p>
<p id="e-jCFW">In order to track a user's choice, we will use two private properties:</p>
<ul id="e-oiq8">
<li id="e-cpMV">
<code>@property BOOL myWall</code>: This keeps track of which wall to post to.</li>
<li id="e-kBYp">
<code>@property (strong, nonatomic) id&amp;lt;FBGraphUser&amp;gt; selectedFriend</code>: This keeps track of which friend is currently selected. We will use this object to extract the Facebook user.</li>
</ul>
<p id="e-VJ0L">Define the above variables within the <code>LBFacebookViewController.m</code> file.</p>
<p id="e-Nljd">Set the <code>myWall</code> variable as <code>false</code> within <code>viewDidLoad</code>. The <code>selectedFriend</code> variable will be set after clicking on the <strong>Done</strong> button in the <strong>Friend Picker</strong> component after the user chooses to post on a friend's wall.</p>
<p id="e-uVYY">We now need to create the <code>UIAlertViewMessage</code> delegate method to catch the user's response and choose the right Wall to post to, as displayed in the following screenshot:</p>
<pre id="e-iQpc">- (void)alertView:(UIAlertView *)alertView didDismissWithButtonIndex:(NSInteger)buttonIndex
{
    switch (buttonIndex) {
        case 1: //mine button was clicked
            self.myWall = YES;
            [self checkForPublishPermissionAndPublish];
            break;
        case 2: //friend's button was clicked
            self.myWall = NO;
            [self showFriendPickerViewControllerWithMultiSelection:YES];
            break;
        default:
            self.myWall = YES;
            break;
    }
}</pre>
<p id="e-wpdm">The <code>clickButtonAtIndex</code> <code>UIAlertViewDelegate</code> method was purposefully not overwritten. If the application were to try to run a modal view controller while the alert message is still visible, nothing would be displayed.</p>
<p id="e-VGLU">If the user clicks on the <strong>mine</strong> button, the application sets the <code>myWall</code> variable to <code>true</code>. This will show the post view controller and will let the user publish the new story on his or her own Wall.</p>
<p id="e-niNQ">If the user clicks on <strong>cancel</strong> to cancel the operation, we will set the <code>myWall</code> property to a <code>true</code> value and dismiss the alert message.</p>
<p id="e-Aw2a">When a user clicks on the  <strong>friend's</strong> button, the application will set the <code>myWall</code> property to <code>false</code> and <code>LBFriendPickerViewController</code> will be shown to the user in order to select a friend.</p>
<p id="e-vm6Q">The following code snippet shows the implementation of a new function, <code>showFriendPickerViewControllerWithMultiSelection</code>, that will show the friend picker view controller.</p>
<pre id="e-UFlY">- (void)showFriendPickerViewControllerWithMultiSelection:(BOOL)multiSelection
{
    if (self.friendPickerViewController == nil) {
        self.friendPickerViewController = [[LBFriendPickerViewController alloc] init];
        self.friendPickerViewController.title = @"Pick a Friend";
        [self.friendPickerViewController setDelegate:self];
    }
    
    [self.friendPickerViewController setAllowsMultipleSelection:multiSelection];
    
    [self.friendPickerViewController loadData];
    [self.friendPickerViewController clearSelection];
    
    [self presentViewController:self.friendPickerViewController animated:YES completion:^{
        NSLog(@"Friends list ready");
    }];
}</pre>
<p id="e-FDCd">The preceding method takes a Boolean value as input to enable or disable multiple selections. We will disable <code>multiSelection</code> when the user is trying to post a new story to a friend's wall.</p>
<p id="e-zCLu">Update <code>onFriendsClick</code> using the new method created in the preceding code; see the output in the following code snippet:</p>
<pre id="e-CkPk">- (IBAction)onFriendsClick:(id)sender {
    [self showFriendPickerViewControllerWithMultiSelection:YES];
}</pre>
<p id="e-kxdf">We now need to update the <code>facebookViewControllerDoneWasPressed</code> delegate method in order to retrieve which user was selected and store the reference to <code>self.selectedFriend</code>. The application will only let the user post on a single friend's wall. Once the delegate method is called, we can easily check if a friend selection was made and post to a friend's wall. The following code snippet demonstrates the usage of the new delegate method.</p>
<pre id="e-LL9v">#pragma mark - FBFriendPickerViewController delegate
- (void)facebookViewControllerDoneWasPressed:(id)sender {
    
    LBFriendPickerViewController *friendPicker = (LBFriendPickerViewController *)sender;
    
    // Checking for user friend selections
    if ([[friendPicker selection] count] &amp;gt; 0) {
        self.selectedFriend = [[friendPicker selection] objectAtIndex:0];
    } else {
        // resetting previous selction
        self.myWall = YES;
    }
    
    [self dismissViewControllerAnimated:YES completion:^{
        if (!self.myWall) {
            // Posting new story on the friends wall
            [self checkForPublishPermissionAndPublish];
        }
    }];
}</pre>
<p id="e-BKsq">If the <code>friendPickerViewController</code> selection array has at least one selection, we set the property <code>self.selectedFriend</code> with the first object in the friend's list selection. If more than one selection is returned, we reset the <code>self.myWall</code> property to <code>true</code>.</p>
<p id="e-fah4">When <code>LBFriendPickerViewController</code> is dismissed, we will show the publish interface with the friend's name as receiver of the new story if the <code>self.myWall</code> property is set to <code>false</code>; otherwise it shows nothing.</p>
<p id="e-zTyT">The last step to perform is to add the wall recipient to the publish story interface. Update the <code>publishCurrentBook</code> method to check the <code>self.myWall</code> property. If that property is set to <code>false</code>, it means that the user is trying to post on a friend's wall. Therefore, we need to collect the friend's Facebook ID using the <code>self.selectedFriend</code> property. That information needs to be added to the information previously defined for the <code>displayWebDialod</code> method.</p>
<pre id="e-nA1l">if (!self.myWall) {
        [params setObject:self.selectedFriend.id forKey:@"to"];
        self.myWall = YES;
}</pre>
<p id="e-mmrI">The preceding code snippet shows how the application set the parameter <code>to</code> using the friend's Facebook ID. This will change the receiver of the new story.</p>
<p id="e-YQH1">The following screenshot shows the final result:</p>
<img data-width="324" data-height="278" src="yA11XMbg.jpg"/><p id="e-hEXM">FBWebDialog – posting on a friend's Wall</p>

<h1 id="e-wQqA">Facebook Native Dialogs</h1>
<p id="e-saqp">We mentioned several times that Apple introduced Facebook integration for iOS6 and later versions. With this version of iOS SDK, Facebook engineers introduced native components to interact with the Platform; for example, <code>FBNativeDialogs</code>. The Framework native components are based on <code>SLComposeViewController</code>.</p>
<p id="e-JCsJ">The <code>FBNativeDialog</code> provides a better user interface and interaction but has some limitations. For example, currently <code>FBNativeDialog</code> is not able to post on a friend's wall.</p>
<p id="e-ScWe">First, as we already anticipated previously, the current iOS device needs to have a Facebook account set in order to use the native components.</p>
<p id="e-vhuR">Create a new method, <code>displayNativePostDialog</code>, as demonstrated in the following code snippet:</p>
<pre id="e-wG0Z">- (BOOL)displayNativePostDialog
{
    // You can get an img from any source: camera or image library
    UIImage *img = [UIImage imageNamed:@"book.jpg"];
    NSString *bookTitle = [NSString stringWithFormat:@"Checkout %@", self.book.title];
    
    bool displayNativeDialog = [FBNativeDialogs presentShareDialogModallyFrom:self
                                                                  initialText:bookTitle
                                                                        image:img
                                                                          url:nil
                                                                      handler:^(FBNativeDialogResult result, NSError *error) {}];
    return displayNativeDialog;
}</pre>
<p id="e-PEK0">The preceding method returns <code>true</code> when the current iOS device has a Facebook account associated with it. This method uses an image for the new story. You can drag-and-drop an image to your current project and reference it using the <code>imageNamed</code> method. You can also use the iOS APIs to acquire pictures from the camera or the media library. It is also possible to upload several pictures using their URLs. For more details on Facebook Native Dialogs, see <a href="https://developers.facebook.com/docs/reference/ios/3.6/class/FBNativeDialogs/">https://developers.facebook.com/docs/reference/ios/3.6/class/FBNativeDialogs/</a>.</p>
<p id="e-HDZE">We are going to invoke the <code>displayNativeDialog</code> method within <code>publishCurrentBook</code> as a first instruction. If that method returns <code>false</code>, meaning no Facebook integration on the current device, we will call <code>displayWebDialog</code>. The new <code>publishCurrentBook</code> method looks like the following code snippet:</p>
<pre id="e-gNL5">- (void)publishCurrentBook
{
    BOOL displayNativePostDialog = [self displayNativePostDialog];
    
    // NO FACEBOOK INTEGRATION
    if (!displayNativePostDialog) {
        // Create dictionary for Facebook web dialog
        NSString *name = [NSString stringWithFormat:@"Checkout %@", self.book.title];
        NSString *caption = [NSString stringWithFormat:@"Score %@", self.book.vote];
        NSString *description = self.book.review;
        NSString *pictureUrl = @"http://www.iconpot.com/icon/thumbnail/open-book-vector.jpg";
        
        
        NSMutableDictionary *params = [NSMutableDictionary dictionaryWithObjectsAndKeys:
                                       name, @"name",
                                       caption, @"caption",
                                       description, @"description",
                                       pictureUrl, @"picture",
                                       nil];
        
        if (!self.myWall) {
            [params setObject:self.selectedFriend.id forKey:@"to"];
            self.myWall = YES;
        }
        
        [self displayWebPostDialog:params];
    }
}</pre>
<p id="e-qIZE">The following screenshot shows how the Native Share Dialog looks:</p>
<img data-width="310" data-height="201" src="ZutbOLYU.jpg"/><p id="e-GVnz">The Native Share dialog</p>
<p id="e-sbyR">The preceding screenshot shows the Native Dialog with an image set through the <code>displayWebDialog</code> code to the left. The Native Dialog offers the ability to change the audience by clicking on the <strong>Friends</strong> button and pass information about the current location of the user clicking on <strong>Add Location</strong>. We can also associate a Facebook album to the picture that we are going to upload.</p>
<img data-width="500" data-height="212" src="ht6Lv6oX.jpg"/><p id="e-IQdY">Story updated using Facebook's Native Share dialog</p>
<p id="e-EI2W">The preceding screenshot shows the story updated using the Facebook Native dialog. Unfortunately, the post doesn't report the name of our social application and part of the book's information.</p>
<p id="e-zgbu">In order to increase the visibility of our application on Facebook Platform, we should definitely opt for the Web dialog.</p>

<h1 id="e-iP0g">Summary</h1>
<p id="e-QTMG">In this chapter we learned how to use the two important components of the new Facebook SDK, Native and Web dialogs. We used both components to post on a user's or their friend's wall. We learned to ask and check for public permission before performing the publish action. We also implemented a way to publish information on users' News Feeds.</p>
<p id="e-iXAA">An important part of this chapter focused on how to use Storyboard to create a social posting interface and pass information between view controllers.</p>
<p id="e-Vc93">The Web dialog is definitely recommended if we want to customize user experience and, of course, promote our application on users' feeds.</p>
</body></html>