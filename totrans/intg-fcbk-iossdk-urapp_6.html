<html><head></head><body><h1 id="e-IE9v">Chapter 6. Facebook Graph API</h1>
<p id="e-yWKX">In this chapter we are going to dig into the Facebook Graph API.</p>
<h3 id="e-QkKg">Note</h3>
<p id="e-cE0O">In order to access the Facebook iOS SDK API reference, visit <a href="https://developers.facebook.com/docs/reference/api/">https://developers.facebook.com/docs/reference/api/</a>.</p>
<p id="e-mDRh">The new <strong>API</strong>s (<strong>Application Programming Interface</strong>) were developed by Facebook engineers to replace the old <strong>REST</strong> (<strong>Representational State Transfer</strong>) web services. Graph API is the main tool to fetch and store data within the Social Graph. It is based on low-level HTTP verbs (GET, POST, PUT, and so on). Facebook SDKs are also based on Graph API.</p>
<h1 id="e-sYJF">Available features through Graph API</h1>
<p id="e-Mzpg">Using Graph API, we have access to all the information on the Social Graph having the necessary permissions. It is important to understand that some of Facebook's APIs have usage limits to prevent abuse, for example, downloading a picture.</p>
<p id="e-hr8D">When we read data from the core graph structure, we have the following features available:</p>
<ul id="e-lqef">
<li id="e-Edob">
<strong>Pictures</strong>: These are profile pictures.</li>
<li id="e-PFLJ">
<strong>Selecting Results</strong>: Using filters, it is possible to control which fields are included in the response.</li>
<li id="e-E5zn">
<strong>Pagination</strong>: It is the ability to define a limit for the response data. This is really useful, for instance, when we try to download user timeline information.</li>
<li id="e-Y66p">
<strong>Search</strong>: It gives the ability to search; however, the request needs to define a search query and an object type.</li>
<li id="e-nD32">
<strong>Permissions and Login protocols</strong>: These are necessary to use the Graph API in order to access sensitive data.</li>
</ul>
<p id="e-t8zR">Graph APIs provide the ability to publish and delete information from a user's timeline. We can also interact with events by providing  <strong>RSVP</strong>s, creating albums, writing notes, and referencing links.</p>
<p id="e-Pbot">An important feature of the Graph API is the ability to receive real-time updates.</p>
<p id="e-HvCW"><a href="https://developers.facebook.com/docs/reference/api/realtime/">https://developers.facebook.com/docs/reference/api/realtime/</a></p>
<p id="e-FJVU">When the application subscribes for updates for a specific object, we will need to define a callback URL. The Facebook Platform will call that URL whenever there is a change in the subscripted object.</p>

<h1 id="e-RDAC">Graph API Explorer</h1>
<p id="e-TqYP">The best way to learn how to use the Graph API is through the Graph Explorer Graph API Explorer is a debug tool that helps developers understand how to use the Graph API by simulating Graph API calls.</p>
<p id="e-yUdq">In order to access the Explorer tool, visit <a href="https://developers.facebook.com/tools/explorer">https://developers.facebook.com/tools/explorer</a>.</p>
<p id="e-BaGn">The first time we access Graph Explorer, the debugging tool will show our Facebook account <strong>id</strong> and <strong>name</strong>. The following screenshot shows the Graph API Explorer interface:</p>
<img data-width="800" data-height="256" src="WUktk3F6.jpg"/><p id="e-cGkh">Facebook dynamically provides the access token, and it will let us access private data. We can input our own query and see the results in the panel underneath the query input field. The bar to the left provides data filtering of responses; we can decide which fields need to be displayed in our query response.</p>
<img data-width="324" data-height="500" src="Zn2sTSjv.jpg"/><p id="e-hZtq">There is a long list of functionalities provided by the Explorer tool, and I strongly recommend taking a look at them since they will not be covered in this book.</p>

<h1 id="e-iXOf">Using the Graph API with Facebook iOS SDK</h1>
<p id="e-atXV">In order to use Graph APIs in our social application, we are going to use a component called <code>FBRequestConnection</code>.</p>
<p id="e-KQYZ">The previous class has convenient methods to perform Graph API calls and handles responses flawlessly, as it will create a single HTTP connection with the social platform. <code>FBRequestConnection</code> works only if the current <code>FBSession</code> is open and has a valid token.</p>
<p id="e-pmA4">The duties of <code>FBRequestConnection</code> are as follows:</p>
<ul id="e-RCBr">
<li id="e-Tw2R">Creating the correct URI for your Graph API request and appending the correct URN to the base Graph Facebook URL (<a href="http://graph.facebook.com/">http://graph.facebook.com/</a>)</li>
<li id="e-v0zF">Fetching the current active <code>FBSession</code>, extracting the security token associated, and attaching the security token to the Graph API request</li>
<li id="e-JYih">Handling connection start/end/canceling and batch requests</li>
</ul>
<p id="e-S6DF">Using <code>FBRequestConnection</code>, we have several methods to perform the Graph API Request. All methods to perform such requests need <code>FBRequestHandler</code> as the input parameter.</p>
<pre id="e-uEpj">typedef void (^FBRequestHandler)(
FBRequestConnection *connection,
id result,
NSError *error);</pre>
<p id="e-uaQ8">The following Graph API methods are available for our convenience:</p>
<ul id="e-GAT8">
<li id="e-xvCO">
<code>+ (FBRequestConnection *)startForMeWithComplentionHandler</code> (<code>FBRequestHandler</code>)handler: It performs a request for user information (<code>/me</code>). It uses an active session fetched through <code>FBSession activeSession</code>.</li>
<li id="e-fAzw">
<code>+ (FBRequestConnection *)startForMyFriendWithComplentionHandler</code> (<code>FBRequestHandler</code>)handler: It performs a request for a user's friends (<code>/me/friends</code>). An active session is needed for this.</li>
<li id="e-tdYW">
<code>+ (FBRequestConnection *) startForPlacesSearchAtCoordinate:(CLLocationCoordinate2D)coordinate radiusInMeters:(NSInteger)radius resultsLimit:(NSInteger)limit searchText:(NSString*)searchText completionHandler</code> (<code>FBRequestHandler</code>)handler: It returns places that match the <code>searchText</code> string in a certain area defined by coordinates and a radius. We need to define a limit for the number of results we are getting back from this request.</li>
<li id="e-T249">
<code>+ (FBRequestConnection*)startForPostStatusUpdate:(NSString *)message completionHandler</code> (<code>FBRequestHandler</code>)handler: It performs a request to post a status update on the user's timeline.</li>
<li id="e-d0ES">
<code>+ (FBRequestConnection*)startForUploadPhoto:(UIImage *)photo completionHandler</code> (<code>FBRequestHandler</code>)handler: It performs a post request to upload a photo.</li>
</ul>
<p id="e-TY4v">Every time we try to perform a Graph API request, we use the Graph API Explorer tool to check the response.</p>
<p id="e-S3Mh">In the next sections, we are going to use some of the <code>FBRequestConnection</code> methods to build and execute Graph API requests.</p>
<p id="e-A5Lr">The next samples are not directly connected with the application we built so far; therefore, they can easily be re-used on a different project.</p>
<h2 id="e-tO9v">Fetching user information</h2>
<p id="e-PeZa">In Chapter 4, <em>Displaying User Profile</em>, we used the <code>FBLoginView</code> delegate method to fetch and display user information. <code>FBLoginView</code> took care of fetching that information for us using the Graph API.</p>
<p id="e-J603"><code>FBRequestConnection</code> allows us to fetch user profile information independently from <code>FBLoginView</code>, for example, a custom user interface and login flow.</p>
<pre id="e-K54V">- (void)fetchUserInfoWithGraphApi
{
    [FBRequestConnection startForMeWithCompletionHandler:^(FBRequestConnection *connection, id result, NSError *error) {
        if (error) {
            NSString *title = @"Graph API Error";
            NSString *message = @"Error retrieving user information through Graph API";
            UIAlertView *errorGraphAPIMessage = [[UIAlertView alloc] initWithTitle:title
                                                                              message:message
                                                                             delegate:nil
                                                                    cancelButtonTitle:nil
                                                                    otherButtonTitles:@"OK", nil];
            [errorGraphAPIMessage show];
        } else {
            NSLog(@"User information: %@", result);
        }
    }];
}</pre>
<p id="e-iD8N">The previous code shows the implementation of <code>startForMeWithComplentionHandler</code>. The request handler will check whether there were any errors. If no errors exist, the handler will display the user profile information using the result variable on the log interface. The object in the result variable is an <code>id&amp;lt;FBGraphUser&amp;gt;</code> object.</p>
<h3 id="e-xYEP">Note</h3>
<p id="e-b14g">For more information on <code>FBGraphUser</code>, visit</p>
<p id="e-kdek"><a href="https://developers.facebook.com/docs/reference/ios/3.6/protocol/FBGraphUser/">https://developers.facebook.com/docs/reference/ios/3.6/protocol/FBGraphUser/</a>.</p>
<h2 id="e-CSzQ">Fetching a user's friends</h2>
<p id="e-NAUK">In Chapter 4, <em>Displaying User Profile</em>, we created a view controller to display a user's friends list. Now, let's consider the case where a table view is not the type of interaction we are looking for. We may need to customize our interface, and fetch the user's friend list information straight from the Facebook Platform.</p>
<pre id="e-RRMg">- (void)fetchUserFriendsListWithGraphAPI
{
    [FBRequestConnection startForMyFriendsWithCompletionHandler:^(FBRequestConnection *connection, id result, NSError *error) {
        if (error) {
            NSString *title = @"Graph API Error";
            NSString *message = @"Error retrieving user friends list through Graph API";
            UIAlertView *errorGraphAPIMessage = [[UIAlertView alloc] initWithTitle:title
                                                                           message:message
                                                                          delegate:nil
                                                                 cancelButtonTitle:nil
                                                                 otherButtonTitles:@"OK", nil];
            [errorGraphAPIMessage show];
        } else {
            NSLog(@"Friends information: %@", result);
        }
    }];
}</pre>
<p id="e-i6JZ">The previous code shows one example of <code>startForMyFriendWithComplentionHandler</code> in action. The preceding code makes a request to the platform. In this case, the result we expect is <code>id&amp;lt;FBGraphUser&amp;gt;</code> containing the user's friends list.</p>
<h2 id="e-wqpe">Fetching a user's photos</h2>
<p id="e-k0yW">Fetching a user's photos requires permission to access this data. We first need to implement a user request for permission; if this goes through, we can fetch the user's photos:</p>
<pre id="e-b72G">- (void)fetchUserPhotosWithGraphApi
{
    // Ask for user_photos permissions
    NSString *permission = @"user_photos";
    if ([FBSession.activeSession.permissions indexOfObject:permission] == NSNotFound) {
        [FBSession.activeSession requestNewReadPermissions:[NSArray arrayWithObject:permission]
                                         completionHandler:^(FBSession *session, NSError *error) {
            if (!error) {
                [self fetchUserPhotos];
            } else {
                if (error.fberrorCategory == FBErrorCategoryUserCancelled) {
                    NSString *title = @"Permission Error";
                    NSString *message = @"User Photos Permission was not granted";
                    UIAlertView *errorGraphAPIMessage = [[UIAlertView alloc] initWithTitle:title
                                                                                   message:message
                                                                                  delegate:nil
                                                                         cancelButtonTitle:nil
                                                                         otherButtonTitles:@"OK", nil];
                    [errorGraphAPIMessage show];
                }
            }
        }];
    } else { // If permissions present, fetch photos
        [self fetchUserPhotos];
    }
}</pre>
<p id="e-gTWL">The previous snippet shows how to perform a request for the user to access photo information. If the permission is already present in <code>FBSession</code>, we can perform the Graph API request; otherwise, we have to wait until the user gives us the permission.</p>
<pre id="e-aJpu">- (void)fetchUserPhotos
{
    [FBRequestConnection startWithGraphPath:@"/me/photos"
                          completionHandler:^(FBRequestConnection *connection, id result, NSError *error) {
        if (error) {
            NSString *title = @"Graph API Error";
            NSString *message = @"Error retrieving user photos through Graph API";
            UIAlertView *errorGraphAPIMessage = [[UIAlertView alloc] initWithTitle:title
                                                                           message:message
                                                                          delegate:nil
                                                                 cancelButtonTitle:nil
                                                                 otherButtonTitles:@"OK", nil];
            [errorGraphAPIMessage show];
        } else {
            NSLog(@"User photos information: %@", result);
        }
    }];
}</pre>
<p id="e-osYK">To fetch a user's photos, we can use the <code>startWithGraphPath</code> method. This method allows us to customize our Graph API request passing the URN as an input parameter, for example, <code>/me/photos</code>. The resulted URI will be <a href="http://graph.facebook.com/me/photos">graph.facebook.com/me/photos</a>.</p>
<p id="e-Bmcz">The result variable is a <code>FBGraphObject</code> type containing the list of pictures for the current user.</p>
<h2 id="e-JH0p">Posting status updates</h2>
<p id="e-HkGf">To perform any post operations, we explicitly need the user's permission. Posting a status update through Graph API firstly requires us to ask for the correct permission and, once this is granted, to execute the request on the Facebook Platform.</p>
<pre id="e-kAKY">- (void)postStatusUpdateUsingGraphAPI
{
    // Ask for post update permissions
    NSString *permission = @"user_photos";
    if ([FBSession.activeSession.permissions indexOfObject:permission] == NSNotFound) {
        [FBSession.activeSession requestNewPublishPermissions:[NSArray arrayWithObject:permission]
                                              defaultAudience:FBSessionDefaultAudienceFriends
                                            completionHandler:^(FBSession *session, NSError *error) {
                                                if (!error) {
                                                    [self postStatusUpdate];
                                                } else {
                                                    if (error.fberrorCategory == FBErrorCategoryUserCancelled) {
                                                        NSString *title = @"Permission Error";
                                                        NSString *message = @"Publish Action Permission was not granted";
                                                        UIAlertView *errorGraphAPIMessage = [[UIAlertView alloc] initWithTitle:title
                                                                                                                       message:message
                                                                                                                      delegate:nil
                                                                                                             cancelButtonTitle:nil
                                                                                                             otherButtonTitles:@"OK", nil];
                                                        [errorGraphAPIMessage show];
                                                    }
                                                }
                                            }];
    } else { // If permissions present, publish the story
        [self postStatusUpdate];
    }
}</pre>
<p id="e-G2Mj">Once the post update permission is granted, we can run the <code>postStatusUpdate</code> code. The following snippet shows the code to post a new status update on the user's timeline:</p>
<pre id="e-wjtN">- (void)postStatusUpdate
{
    [FBRequestConnection startForPostStatusUpdate:@"Posting my update through my new app!"
                                completionHandler:^(FBRequestConnection *connection, id result, NSError *error) {
        
        NSString *title = @"Graph API Success";
        NSString *message = @"Status Update posted";
        
        if (error) {
            title = @"Graph API Error";
            message = @"Error posting update through Graph API";
        } else {
            NSLog(@"Post information: %@", result);
        }
        
        UIAlertView *graphAPIMessage = [[UIAlertView alloc] initWithTitle:title
                                                                  message:message
                                                                 delegate:nil
                                                        cancelButtonTitle:nil
                                                        otherButtonTitles:@"OK", nil];
        [graphAPIMessage show];
    }];
}</pre>
<p id="e-teeE">The result of posting a new timeline update is the new post ID.</p>
<img data-width="500" data-height="212" src="KHFfOs8h.jpg"/><h2 id="e-reSh">Posting a new photo</h2>
<p id="e-wwYa">Posting a new photo requires the <code>photo_upload</code> permission. The following code shows how to ask for the upload photo permission and perform the request on the Platform.</p>
<pre id="e-qY9p">- (void)postPictureUsingGraphAPI
{
    // Ask for post picture permission
    NSString *permission = @"photo_upload";
    if ([FBSession.activeSession.permissions indexOfObject:permission] == NSNotFound) {
        [FBSession.activeSession requestNewPublishPermissions:[NSArray arrayWithObject:permission]
                                              defaultAudience:FBSessionDefaultAudienceFriends
                                            completionHandler:^(FBSession *session, NSError *error) {
                                                if (!error) {
                                                    [self postPhoto];
                                                } else {
                                                    if (error.fberrorCategory == FBErrorCategoryUserCancelled) {
                                                        NSString *title = @"Permission Error";
                                                        NSString *message = @"Upload Photo Permission was not granted";
                                                        UIAlertView *errorGraphAPIMessage = [[UIAlertView alloc] initWithTitle:title
                                                                                                                       message:message
                                                                                                                      delegate:nil
                                                                                                             cancelButtonTitle:nil
                                                                                                             otherButtonTitles:@"OK", nil];
                                                        [errorGraphAPIMessage show];
                                                     }
                                                }
                                            }];
    } else { // If permissions present, upload the photo
        [self postPhoto];
    }
}</pre>
<p id="e-foEb">When the photo upload permission is granted, we can perform the Graph API request using the <code>postPhoto</code> method. The following code is to upload a photo using the Graph API:</p>
<pre id="e-Zw3L">- (void)postPhoto
{
    // You can get an img from any source: camera or image library
    UIImage *img = [UIImage imageNamed:@"book.jpg"];
    [FBRequestConnection startForUploadPhoto:img
                           completionHandler:^(FBRequestConnection *connection, id result, NSError *error) {
                               NSString *title = @"Graph API Success";
                               NSString *message = @"Picture uploaded";
                               
                               if (error) {
                                   title = @"Graph API Error";
                                   message = @"Error uplaoding picture through Graph API";
                               } else {
                                   NSLog(@"Picture posted information: %@", result);
                               }
                               
                               UIAlertView *graphAPIMessage = [[UIAlertView alloc] initWithTitle:title
                                                                                         message:message
                                                                                        delegate:nil
                                                                               cancelButtonTitle:nil
                                                                               otherButtonTitles:@"OK", nil];
                               [graphAPIMessage show];
    }];
}</pre>
<p id="e-eavy">The preceding code uses an image from an iOS project; however, we can fetch an image from any source, for example, a camera or a library. The result of the request is the picture ID on the Facebook Platform.</p>
<img data-width="800" data-height="476" src="ciawwZd5.jpg"/>
<h1 id="e-vtAh">Summary</h1>
<p id="e-ltPS">In this chapter, we focus on the most important part of the Facebook iOS SDK, the Graph APIs. We learned how to use those APIs to communicate with the platform. The Graph API methods give us the flexibility to build our own GUI if we don't like the one provided by native or web components.</p>
<p id="e-Q12L">The Graph API Explorer is the tool that we should always use before implementing any communication with the platform. It will help us understand the request and response format of our communication with the social network.</p>
<p id="e-vIWW">Using the native components, we are limited to a subset of features provided by the Graph API. Graph API is the most powerful and flexible tool we can use to interact with the Platform and for fetching users and their friends' information.</p>
</body></html>