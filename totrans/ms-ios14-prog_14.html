<html><head></head><body>
		<div id="_idContainer155">
			<h1 id="_idParaDest-217"><em class="italic"><a id="_idTextAnchor457"/>Chapter 14</em>: Creating an App Clip for Your App</h1>
			<p>One of the main features that iOS 14 brings to the table is App Clips. App Clips provide users with a fast new way to discover and make use of what your app has to offer. By triggering an App Clip from a QR code, a link, an NFC tag, or other mechanism, it can pop into the user's device (even without your app installed) and bring some of your app's functionality to life in a matter of seconds.</p>
			<p>In this chapter, we are going to learn what an App Clip is, what they are used for, and what the user's journey will be like while using them. We will review the different options that users have to trigger them. We will then develop an App Clip and learn how to configure it with App Store Connect's new features. Finally, we will learn how to test them using Local Experiences. By the end of this chapter, you will be able to develop your own App Clips and bring your apps to the next level.</p>
			<p> Let's summarize the topics of this chapter:</p>
			<ul>
				<li>Introducing App Clips</li>
				<li>Developing your first App Clip</li>
				<li>Testing your App Clip experiences</li>
			</ul>
			<p>Let's get started!</p>
			<h1 id="_idParaDest-218"><a id="_idTextAnchor458"/>Technical requirements</h1>
			<p>The code bundle for this chapter includes three starter projects called <strong class="source-inline">AppClipExample_start</strong>, <strong class="source-inline">AppClipExample_configure_start</strong>, and <strong class="source-inline">AppClipExample_test</strong>. You can find them in the code bundle repository for this book:</p>
			<p><span class="hidden"><a id="_idTextAnchor459"/><a id="_idTextAnchor460"/></span><a href="https://github.com/PacktPublishing/Mastering-iOS-14-Programming-4th-Edition">https://github.com/PacktPublishing/Mastering-iOS-14-Programming-4th-Edition</a></p>
			<h1 id="_idParaDest-219"><a id="_idTextAnchor461"/><a id="_idTextAnchor462"/><a id="_idTextAnchor463"/>Introducing App Clips</h1>
			<p><strong class="bold">App Clips</strong> allow users<a id="_idIndexMarker723"/> to discover an app in a fast and lightweight manner. With App Clips, a user can quickly use a feature of your app without having the app installed on their phone. An App Clip is a small set of features from your app that can be discovered and used without the user having your app installed. Users can open your App Clip by using different triggers, such as QR codes, NFC tags, links in Messages, places in Maps, and Smart Banners in websites. The App Clip will pop up on the user's home screen as an overlay called an App Clip Card. The App Clip Card describes what your App Clip does so that the user can choose to either open and use the App Clip or dismiss it. Let's look at an example of what an App Clip Card looks like:</p>
			<div>
				<div id="_idContainer130" class="IMG---Figure">
					<img src="image/Figure_14.01_B14717.jpg" alt="Figure 14.1 – App Clip Card&#13;&#10;"/>
				</div>
			</div>
			<p class="figure-caption">Figure 14.1 – App Clip Card</p>
			<p>As shown in the preceding screenshot, an App Clip Card is an overlay on the user's home screen that displays the following:</p>
			<ul>
				<li><strong class="bold">A header image, describing your app or the App Clip's main feature</strong>: In this example, the header image is of someone preparing a coffee.</li>
				<li><strong class="bold">A title, describing what the App Clip does</strong>: "Mamine Café".</li>
				<li><strong class="bold">A subtitle, describing what feature the App Clip offers</strong>: "Order coffee in 3 taps".</li>
				<li><strong class="bold">A button, describing the action to be performed (such as open/view the App Clip)</strong>: "View".</li>
				<li><strong class="bold">Extra info footer</strong>: The App Clip's main app. A link is provided to the App Store so that the user can download it.</li>
			</ul>
			<p>App Clips should be lightweight, brief, and complete a user's task in seconds. Let's take a look at some use cases of App Clips:</p>
			<ul>
				<li>An App Clip for ordering coffee when you pass by a coffee shop's door and tap on an NFC tag, such as the one shown in the preceding screenshot.</li>
				<li>An App Clip for renting an electric bike parked in the street, just by scanning its QR code. You can also use <strong class="bold">Sign in with Apple and Apple Pay</strong> to avoid forms and interface complexities, allowing you to rent the bike in seconds.</li>
				<li>An App Clip for pre-ordering from the menu of a restaurant, saving you time while you're waiting<a id="_idIndexMarker724"/> to be seated.</li>
				<li>An App Clip that triggers when you tap around NFC spots in an art gallery or a museum so that Augmented Reality scenes are displayed on your iPhone.</li>
			</ul>
			<p>As you can see, the possibilities for App Clips are endless. Now that we have covered what an App Clip is, we are going to explain the user's journey of using an App Clip (from its invocation to when it's finally used). We will cover various invocation methods (how to make an App Clip appear) before describing the recommended guidelines for building an App Clip.</p>
			<h2 id="_idParaDest-220"><a id="_idTextAnchor464"/>App Clip User Journey</h2>
			<p>Now, let's explore the<a id="_idIndexMarker725"/> whole App Clip process and steps in more detail, starting from when the user discovers your App Clip to when the user finishes their App Clip journey. </p>
			<p>Let's imagine that we have an app for renting electric bikes. There are several stages involved in the App Clip process:</p>
			<div>
				<div id="_idContainer131" class="IMG---Figure">
					<img src="image/Figure_14.02_B14717.jpg" alt="Figure 14.2 – App Clip process and steps&#13;&#10;"/>
				</div>
			</div>
			<p class="figure-caption">Figure 14.2 – App Clip process and steps</p>
			<p>The preceding image explains the different stages of an App Clip:</p>
			<ol>
				<li><strong class="bold">Invocation method</strong>: The App Clip invocation method is how the user can trigger and open an <a id="_idIndexMarker726"/>App Clip. For our example, a user scans a QR code that's been placed on the bike with their device's camera, and the App Clip opens on their home screen. In this case, the invocation method is the QR code. We will explore these in more detail later in this chapter.</li>
				<li><strong class="bold">User journey</strong>: After invocation, the App Clip presents some options for the user to choose from (for example, 1-hour rental for $2 and 24-hour rental for $5). The user makes their desired selection inside the App Clip.</li>
				<li><strong class="bold">Accounts and payment</strong>: In our bike rental example, our App Clip needs to identify which user is renting the bike, and the user needs to pay for the service. Some App Clips will not require a registered user account nor payment to work; this step is optional.</li>
				<li><strong class="bold">Full app recommendation</strong>: When the rental decision for the bike has been made and the user is ready to proceed, your App Clip can recommend that the user downloads your complete app so that they can use it instead of the App Clip the next time they wish to use your service. Suggesting the entire app is an optional step, but it is recommended.</li>
			</ol>
			<p>Now that we have provided an overview of the high-level steps an App Clip follows, we will take a closer <a id="_idIndexMarker727"/>look at what invocation methods are available.</p>
			<h2 id="_idParaDest-221"><a id="_idTextAnchor465"/>App Clips Invocation Methods</h2>
			<p>We have seen that in<a id="_idIndexMarker728"/> order to display an App Clip, the user needs to invoke or discover it. Previously, we discussed that this can be done via a QR code, an NFC tag, a link in Messages, and so on. Here is a summary of the options available:</p>
			<ul>
				<li><strong class="bold">App Clip codes</strong>: Each App Clip code includes a QR code and an NFC tag so that a user can scan it with their camera or tap on it. </li>
				<li><strong class="bold">NFC tags</strong>.</li>
				<li><strong class="bold">QR codes</strong>.</li>
				<li><strong class="bold">Safari App Banner</strong>.</li>
				<li><strong class="bold">Links in Messages</strong>.</li>
				<li><strong class="bold">Place cards in Maps</strong>.</li>
				<li><strong class="bold">The Recently Used App Clips category on the new App Library on iOS 14</strong>.</li>
			</ul>
			<p>In this section, we learned what an App Clip is, what the user's journey is when they're using it, and the different invocation methods that can be used to trigger it. In the next section, we are going to build and configure an App Clip for a coffee shop.</p>
			<h1 id="_idParaDest-222"><a id="_idTextAnchor466"/>Developing your first App Clip</h1>
			<p>In this section, we <a id="_idIndexMarker729"/>are going to start with an existing app, and we will add an App Clip to it step by step. Open the <strong class="source-inline">AppClipExample_start</strong> project in this book's code bundle. If you launch the app, you will see that we have a coffee shop app in which we can order three different types of drinks, review the order, and pay by Apple Pay or by entering our credit card details:</p>
			<div>
				<div id="_idContainer132" class="IMG---Figure">
					<img src="image/Figure_14.03_B14717.jpg" alt="Figure 14.3 – Our app's main screens – Menu, Payment, and Credit Card controllers&#13;&#10;"/>
				</div>
			</div>
			<p class="figure-caption">Figure 14.3 – Our app's main screens – Menu, Payment, and Credit Card controllers</p>
			<p>Note that the<a id="_idIndexMarker730"/> purpose of this example app is to help us build the interesting part: the App Clip. Some functionalities, such as the credit card and Apple Pay payments, are not fully implemented; they just simulate this feature.</p>
			<p>Before we jump into the App Clip process, let's take a moment to review the project's structure and its contents:</p>
			<div>
				<div id="_idContainer133" class="IMG---Figure">
					<img src="image/Figure_14.04_B14717.jpg" alt="Figure 14.4 – Initial project structure&#13;&#10;"/>
				</div>
			</div>
			<p class="figure-caption">Figure 14.4 – Initial project structure</p>
			<p>The app contains a <a id="_idIndexMarker731"/>single target named <strong class="source-inline">AppClipExample</strong>. Inside that target, we have three <strong class="source-inline">ViewControllers</strong> (<strong class="source-inline">MenuViewController</strong>, <strong class="source-inline">PaymentViewController</strong>, and <strong class="source-inline">CreditCardViewController</strong>) and some extra views (<strong class="source-inline">MenuView</strong> and <strong class="source-inline">MenuItemButton</strong>). It only contains a single model file named <strong class="source-inline">Item</strong>, which helps us with the menu products. We also have other common files, such as <strong class="source-inline">AppDelegate</strong> and <strong class="source-inline">Assets</strong> – short and simple. However, it is important to have a snapshot of this in mind because when we start adding our App Clip, this architecture will evolve.</p>
			<p>Before we continue, ensure that you're using your own Apple Developer account settings in the project. In the <strong class="source-inline">AppClipExample</strong> target, do the following:</p>
			<ol>
				<li value="1">Select your own Development Team.</li>
				<li>Change the App ID to <strong class="source-inline">{yourDomain}.AppClipExample</strong>.</li>
			</ol>
			<p>In the next section, we'll create the App Clip for our coffee shop app. We will start by creating a new Target for the App Clip. Then, we will learn how to share code and images between our app and its App Clip (as well as how to create exceptions for when we don't want to share the exact same code). Finally, we will learn how to configure the App Clip's experiences <a id="_idIndexMarker732"/>in App Store Connect before testing it out.</p>
			<h2 id="_idParaDest-223"><a id="_idTextAnchor467"/>Creating the App Clip's Target</h2>
			<p>In order to create an<a id="_idIndexMarker733"/> App Clip, an Xcode project needs to have a target for it. Currently, our project has a single target: <strong class="source-inline">AppClipExample</strong>. Let's proceed and create a new target for the App Clip. Follow these steps:</p>
			<ol>
				<li value="1">In Xcode, click on <strong class="bold">File | New | Target</strong>.</li>
				<li>In the modal that appears, select <strong class="bold">iOS | Application | App Clip</strong>, as shown in the following screenshot:<div id="_idContainer134" class="IMG---Figure"><img src="image/Figure_14.05_B14717.jpg" alt="Figure 14.5 – Adding an App Clip target&#13;&#10;"/></div><p class="figure-caption">Figure 14.5 – Adding an App Clip target</p></li>
				<li>Press <strong class="bold">Next</strong>. Now, you can configure some of the initial values of the App Clip target. </li>
				<li>Enter the name <strong class="source-inline">MyAppClip</strong>, as follows:<div id="_idContainer135" class="IMG---Figure"><img src="image/Figure_14.06_B14717.jpg" alt="Figure 14.6 – App Clip target options&#13;&#10;"/></div><p class="figure-caption">Figure 14.6 – App Clip target options</p></li>
				<li>When you <a id="_idIndexMarker734"/>click <strong class="bold">Finish</strong>, you will see a new popup:<div id="_idContainer136" class="IMG---Figure"><img src="image/Figure_14.07_B14717.jpg" alt="Figure 14.7 – Activating the new scheme&#13;&#10;"/></div><p class="figure-caption">Figure 14.7 – Activating the new scheme</p></li>
				<li>Press <strong class="bold">Activate</strong> so that the scheme can used for building and debugging. Now, take a look at the project structure; you'll see that a new target has been added for the App Clip:</li>
			</ol>
			<div>
				<div id="_idContainer137" class="IMG---Figure">
					<img src="image/Figure_14.08_B14717.jpg" alt="Figure 14.8 – New target for the App Clip&#13;&#10;"/>
				</div>
			</div>
			<p class="figure-caption">Figure 14.8 – New target for the App Clip</p>
			<p>But this is not the only <a id="_idIndexMarker735"/>change that's been made to the project. Xcode did several things under the hood when it added the new App Clip target:</p>
			<ul>
				<li>It created a new scheme for building and running the App Clip and its tests.</li>
				<li>It added a new capability called <strong class="bold">On Demand Install Capable</strong> in the <strong class="bold">App Clip Target settings | Signing &amp; Capabilities</strong> tab. This capability identifies the bundle as an App Clip.</li>
				<li>In the same tab, you can also check how the Bundle identifier for the App Clip contains the same root as the full app's bundle identifier. So, if your app bundle identifie<a id="_idTextAnchor468"/><a id="_idTextAnchor469"/>r is <strong class="source-inline">{yourDomain}.AppClipExample</strong>, the App Clip will have <strong class="source-inline">{yourDomain}.AppClipExample.Clip</strong>. This is because an App Clip only corresponds to one parent app, so they share part of the bundle identifier.</li>
				<li>It also added <strong class="source-inline">_XCAppClipURL</strong>. If you edit the scheme of the App Clip, you will see an environment variable with that name. The default value is <strong class="source-inline">https://example.com</strong>. But in order to activate it, you need to activate the checkbox near the name of the variable. When activated, the App Clip will receive this URL as part of <strong class="source-inline">scene(_ scene: UIScene, continue userActivity: NSUserActivity)</strong> on launch so that you can test the flows that you want to trigger, depending on the URLs that are received.</li>
			</ul>
			<p>Apart from this, Xcode also created a new build phase for your main app target that embeds the App Clip<a id="_idIndexMarker736"/> inside it:</p>
			<div>
				<div id="_idContainer138" class="IMG---Figure">
					<img src="image/Figure_14.09_B14717.jpg" alt="Figure 14.9 – Embed App Clip build phase&#13;&#10;"/>
				</div>
			</div>
			<p class="figure-caption">Figure 14.9 – Embed App Clip build phase</p>
			<p>So, as you can see, even though creating the App Clip's target is relatively straightforward, there is a lot going on under the hood. Now you know all the bits. Let's launch the App Clip on the iOS simulator (remember to select the <strong class="source-inline">MyAppClip</strong> App Clip target when launching it). You will see a blank screen. This is fine – we still need to add some code and prepare our App Clip! We'll do this in the next section.</p>
			<h2 id="_idParaDest-224"><a id="_idTextAnchor470"/>Sharing resources and code with the App Clip</h2>
			<p>App Clips usually<a id="_idIndexMarker737"/> need to reuse code and resources from your main app. They typically consist of some of the features that conform to the entire app. In our case, we are going to create an App Clip that shows everything in our main app, but not the credit card screen. In order to provide a fast and easy App Clip experience, we will only allow our users to view the menu, review their order, and pay with Apple Pay; we don't want them to input any credit card details inside the App Clip.</p>
			<p>Let's consider every file and resource that we need from the main app and add them to the target of the App Clip. Let's start with the assets. Follow these steps:</p>
			<ol>
				<li value="1">From the project navigator, click on the <strong class="source-inline">Assets.xcassets</strong> file, and in the <strong class="bold">Options</strong> panel, add<a id="_idIndexMarker738"/> it to the App Clip target: <div id="_idContainer139" class="IMG---Figure"><img src="image/Figure_14.10_B14717.jpg" alt="Figure 14.10 – Adding assets to the App Clip target&#13;&#10;"/></div><p class="figure-caption">Figure 14.10 – Adding assets to the App Clip target</p><p>By doing this, our App Clip target will have access to all the images that we have in the main app. You can also create individual assets files and specify different images/resources for each target. For simplicity, in this example, we will share all of them.</p><p>If you opt to use a single <strong class="source-inline">Assets</strong> file for both the app and the App Clip, you can delete the <strong class="source-inline">Assets</strong> file inside the <strong class="source-inline">MyAppClip</strong> folder. Otherwise, you will have two <strong class="source-inline">AppIcon</strong> references (one inside each asset file), and you will get a compile error:</p><div id="_idContainer140" class="IMG---Figure"><img src="image/Figure_14.11_B14717.jpg" alt="Figure 14.11 – Deleting the second Assets file inside MyAppClip&#13;&#10;"/></div><p class="figure-caption">Figure 14.11 – Deleting the second Assets file inside MyAppClip</p><p>It is also a good practice to move the main app's <strong class="source-inline">Assets</strong> file to the top of the project and <a id="_idIndexMarker739"/>rename it <strong class="source-inline">SharedAssets</strong>. This lets other developers know that the file applies to both targets:</p><div id="_idContainer141" class="IMG---Figure"><img src="image/Figure_14.12_B14717.jpg" alt="Figure 14.12 – SharedAssets on top of the project&#13;&#10;"/></div><p class="figure-caption">Figure 14.12 – SharedAssets on top of the project</p><p>Once you've made these changes, make sure you can build and compile both targets; that is, the app and the App Clip.</p><p>Now, let's include the App Clip target, as well as the code that we need. Previously, we mentioned that we want to have the same functionalities that can be found in the main app, except for the credit card screen. </p></li>
				<li>In the project navigator, select the following files and add them to the App Clip target:<div id="_idContainer142" class="IMG---Figure"><img src="image/Figure_14.13_B14717.jpg" alt="Figure 14.13 – Sharing code files with the App Clip target&#13;&#10;"/></div><p class="figure-caption">Figure 14.13 – Sharing code files with the App Clip target</p><p>Notice how we<a id="_idIndexMarker740"/> shared all the files inside the <strong class="source-inline">ViewController</strong>, <strong class="source-inline">Views</strong>, and <strong class="source-inline">Model</strong> folders, except for <strong class="source-inline">CreditCardViewController</strong>.</p><p>You have now shared all the images and code that your App Clip will need. However, you still need to reuse some content: the storyboard flow. </p></li>
				<li>Go ahead and open the <strong class="source-inline">Main.storyboard</strong> file in your <strong class="source-inline">AppClipExample</strong> target. Zoom out a bit and select everything except for <strong class="source-inline">CreditCardViewController</strong> (we don't want that one in our App Clip):<div id="_idContainer143" class="IMG---Figure"><img src="image/Figure_14.14_B14717.jpg" alt="Figure 14.14 – Copying the contents of the Main.storyboard file of your App&#13;&#10;"/></div><p class="figure-caption">Figure 14.14 – Copying the contents of the Main.storyboard file of your App</p></li>
				<li>Once you've<a id="_idIndexMarker741"/> copied the elements highlighted in the previous screenshot, go ahead and paste them into the <strong class="source-inline">Main.storyboard</strong> file of your <strong class="bold">MyAppClip</strong> target. </li>
				<li>Now, select the <strong class="bold">Navigation Controller</strong> option and in the <strong class="bold">Options</strong> panel on the right, check the <strong class="bold">Is Initial View Controller</strong> option:<div id="_idContainer144" class="IMG---Figure"><img src="image/Figure_14.15_B14717.jpg" alt="Figure 14.15 – Assigning the entry point for your App Clip&#13;&#10;"/></div><p class="figure-caption">Figure 14.15 – Assigning the entry point for your App Clip</p><p>Now, you have enough code, resources, and flow in your App Clip to try it out. </p></li>
				<li>Select the <strong class="bold">MyAppClip</strong> target and launch it. It should compile and run without any issues at this point. </li>
			</ol>
			<p>However, there is a<a id="_idIndexMarker742"/> problem. If you launch the App Clip and order an item, you will notice that we are still showing the <strong class="bold">Pay with Credit Card</strong> button. Previously, we mentioned that we want our App Clip to just use Apple Pay in order to streamline the service, as per Apple's recommendations. In the next section, we will achieve this by learning how to conditionally use parts of our code, depending on which target is executing it, using Active Compilation Conditions. </p>
			<h2 id="_idParaDest-225"><a id="_idTextAnchor471"/>Using Active Compilation Conditions</h2>
			<p>In the previous<a id="_idIndexMarker743"/> section, we learned how to<a id="_idIndexMarker744"/> share code and assets between our app and App Clip. This time, we need to "remove" some pieces of code when the App Clip is executing specific files. Specifically, we want to hide the <strong class="bold">Pay with Credit Card</strong> button from our <strong class="source-inline">PaymentViewController</strong> when the App Clip executes it.</p>
			<p>To do this, we need to work with Active Compilation Conditions. Follow these steps:</p>
			<ol>
				<li value="1">In the <strong class="bold">Project Navigator</strong> window, go to <strong class="bold">Project | MyAppClip target | Build Settings | Active Compilation Conditions</strong>. In both <strong class="bold">Debug</strong> and <strong class="bold">Releas<a id="_idTextAnchor472"/><a id="_idTextAnchor473"/>e</strong>, add <strong class="source-inline">APPCLIP</strong> to the list, as shown in the following screenshot:<div id="_idContainer145" class="IMG---Figure"><img src="image/Figure_14.16_B14717.jpg" alt="Figure 14.16 – Adding Active Compilation Conditions&#13;&#10;"/></div><p class="figure-caption">Figure 14.16 – Adding Active Compilation Conditions</p></li>
				<li>With the <strong class="source-inline">APPCLIP</strong> flag set, go<a id="_idIndexMarker745"/> ahead and <a id="_idIndexMarker746"/>open the <strong class="source-inline">PaymentViewController</strong> file. Add the following code at the end of the <strong class="source-inline">viewDidLoad()</strong> method:<p class="source-code">#if APPCLIP</p><p class="source-code">  buttonPayByCard.isHidden = true</p><p class="source-code">#endif</p><p>With this piece of code, we are telling the compiler to only add this line when we are executing the App Clip target. </p></li>
				<li>Let's try this out. Execute the app and the App Clip and compare both screens. When the App Clip launches, you should not see the <strong class="bold">Pay with Credit Card</strong> button:</li>
			</ol>
			<div>
				<div id="_idContainer146" class="IMG---Figure">
					<img src="image/Figure_14.17_B14717.jpg" alt="Figure 14.17 – App Clip (left) versus app (right)&#13;&#10;"/>
				</div>
			</div>
			<p class="figure-caption">Figure 14.17 – App Clip (left) versus app (right)</p>
			<p>As you can see, we have achieved our goal of showing different parts of the UI by using Active <a id="_idIndexMarker747"/>Compilation<a id="_idIndexMarker748"/> Conditions.</p>
			<p>This is great! We have a perfectly configured App Clip that runs and shows the user what we wanted them to see. In the next section, we are going to jump into a critical part of this process: invoking the App Clip. </p>
			<h2 id="_idParaDest-226"><a id="_idTextAnchor474"/>Configuring, linking, and triggering your App Clip</h2>
			<p>In this <a id="_idIndexMarker749"/>section, and<a id="_idIndexMarker750"/> with the App Clip ready to roll, we are<a id="_idIndexMarker751"/> going to learn how to configure, link, and trigger the App Clip. </p>
			<p>Users can trigger an App Clip by using various invocations, some of which are as follows:</p>
			<ul>
				<li>Scanning an NFC tag or visual code at a physical location</li>
				<li>Tapping a location-based suggestion from Siri Suggestions</li>
				<li>Tapping a link in the Maps app</li>
				<li>Tapping a Smart App Banner on a website</li>
				<li>Tapping a link that someone shared in the Messages app (as a text message only)</li>
			</ul>
			<p>To ensure these invocations work, you must configure your App Clip for link handling and also <a id="_idIndexMarker752"/>configure the <a id="_idIndexMarker753"/>App Store's Connect App Clip Experiences. We will go <a id="_idIndexMarker754"/>through this now.</p>
			<p class="callout-heading">Important Note</p>
			<p class="callout">When users install an App Clip's corresponding app, the full app replaces the App Clip. Every invocation from that moment on launches the full app instead of the App Clip. As a result, your full app must handle all possible invocations and offer the App Clip's functionality.</p>
			<p>An App Clip needs an entry point for users to be able to discover and launch it. We are going to review three topics in this section:</p>
			<ul>
				<li>Configuring link handling</li>
				<li>Configuring App Clip experiences</li>
				<li>Configuring a Smart App Banner</li>
			</ul>
			<p>By the end of this section, our project will have a fully configured App Clip ready to go. Let's get started!</p>
			<h3>Configuring link handling</h3>
			<p>Our first step <a id="_idIndexMarker755"/>is to configure our web server and App Clip for link handling. You can use the project in the code bundle for this chapter named <strong class="source-inline">AppClipExample_configure_start</strong> to help with this.</p>
			<p>If you want to be able to display your App Clip on your website, you need to perform the following steps:</p>
			<ol>
				<li value="1">Configure the <strong class="source-inline">apple-app-site-association</strong> file on your web server.</li>
				<li>Add associated domains entitlement to your App Clip.</li>
				<li>Handle <strong class="source-inline">NSUserActivity</strong> in your App Clip.</li>
				<li>First, let's configure the <strong class="source-inline">apple-app-site-association</strong> file, as follows:<p class="source-code">{</p><p class="source-code">  <strong class="bold">"appclips" : {</strong></p><p class="source-code"><strong class="bold">    "apps" : ["&lt;Application Identifier Prefix&gt;.&lt;Bundle Identifier&gt;"]</strong></p><p class="source-code"><strong class="bold">  }</strong>,</p><p class="source-code">  …</p><p class="source-code">}</p><p>This file should <a id="_idIndexMarker756"/>be located in the root folder of your server. If you have set up universal links, you should have this file already. You need to add the highlighted code to it so that you can reference your App Clip. Remember to use your own Application Identifier Prefix and bundle identifier.</p></li>
				<li>Next, let's add the associated domains entitlement. In the <strong class="bold">Project Navigator</strong> window, select the project and the App Clip target and go to <strong class="bold">Signing &amp; Capabilities</strong>:<p class="figure-caption"> </p><div id="_idContainer147" class="IMG---Figure"><img src="image/Figure_14.18_B14717.jpg" alt="Figure 14.18 – Signing &amp; Capabilities&#13;&#10;"/></div><p class="figure-caption">Figure 14.18 – Signing &amp; Capabilities</p></li>
				<li>Next, add a new <a id="_idIndexMarker757"/>associated domain, as shown in the following screenshot:<div id="_idContainer148" class="IMG---Figure"><img src="image/Figure_14.19_B14717.jpg" alt="Figure 14.19 – Adding an associated domain&#13;&#10;"/></div><p class="figure-caption">Figure 14.19 – Adding an associated domain</p><p>Now that your server and App Clip have been configured, let's handle <strong class="source-inline">NSUserActivity</strong>. </p></li>
				<li>Go ahead and edit the App Clip scheme. Under <strong class="bold">Run | Argum<a id="_idTextAnchor475"/><a id="_idTextAnchor476"/>ents</strong>, check the <strong class="source-inline">_XCAppClipURL</strong> variable and assign it the following value: <strong class="source-inline">https://myappclip.com/test?param=value</strong>. <p>With this value set, let's learn how to process it. </p></li>
				<li>Inside the <strong class="bold">MyAppClip</strong> target, open the <strong class="source-inline">SceneDelegate.swift</strong> file. Add the following <a id="_idIndexMarker758"/>implementations:<p class="source-code">func scene(_ scene: UIScene, willConnectTo session: UISceneSession, options connectionOptions: UIScene.Connec<a id="_idTextAnchor477"/><a id="_idTextAnchor478"/>tionOptions) {</p><p class="source-code">  for activity in connectionOptions.userActivities {</p><p class="source-code">    self.scene(scene, continue: activity)</p><p class="source-code">  }</p><p class="source-code">}</p><p class="source-code">func scene(_ scene: UIScene, continue userActivity: NSU<a id="_idTextAnchor479"/><a id="_idTextAnchor480"/>serActivity) {</p><p class="source-code">  // 1</p><p class="source-code">  guard</p><p class="source-code">    userActivity.activityType == NSUserActivityTypeBrowsingWeb,</p><p class="source-code">    let url = userActivity.webpageURL,</p><p class="source-code">    let components = NSURLComponents(url: url, resolvingAgainstBaseURL: true) else { return }</p><p class="source-code">  print(url)</p><p class="source-code">  //2</p><p class="source-code">  guard</p><p class="source-code">    let path = components.path,</p><p class="source-code">    let params = components.queryItems else { return }</p><p class="source-code">  print(path)</p><p class="source-code">  print(params)</p><p class="source-code">  // Handle your own navigation based on p<a id="_idTextAnchor481"/>ath and params</p><p class="source-code">}</p><p>These two methods are handling the <strong class="source-inline">NSUserActivity</strong> information that your App Clip will receive when it is triggered by an URL-type element. See how, in the <strong class="source-inline">scene(…)</strong> method, we are checking that the activity is of the <strong class="source-inline">NSUserActivityTypeBrowsingWeb</strong> type and that we then examine the <strong class="source-inline">URL</strong>, <strong class="source-inline">path</strong>, and <strong class="source-inline">components</strong> elements. Here, you can navigate your App Clip to the correct<a id="_idIndexMarker759"/> element. If you launch the App Clip and check the console's output, you will see this:</p><p class="source-code"><strong class="bold">https://myappclip.com/test?param=value</strong></p><p class="source-code"><strong class="bold">/test</strong></p><p class="source-code"><strong class="bold">[param=value]</strong></p></li>
			</ol>
			<p>As you can see, we are handling the test URL that has been defined in the <strong class="source-inline">_XCAppClipURL</strong> target environment variable and extracting the required path and components from it. When you want to handle different flows in your App Clip based on the incoming URL, you can test it like this.</p>
			<p>If your app has been built with SwiftUI, then you can handle it like this:</p>
			<p class="source-code">var body: some Scene {</p>
			<p class="source-code">    WindowGroup {</p>
			<p class="source-code">        ContentView().onContinueUserActivity(NSUserActivityTypeBrowsingWeb) { activity in</p>
			<p class="source-code">            guard let url = activity.webpageURL else { return }</p>
			<p class="source-code">            // Navigate to proper flow based on the url</p>
			<p class="source-code">        }</p>
			<p class="source-code">    }</p>
			<p class="source-code">}</p>
			<p>By defining <strong class="source-inline">onContinueUserActivity(NSUserActivityTypeBrowsingWeb)</strong> via <strong class="source-inline">ContentView</strong>, you can use the <strong class="source-inline">activity</strong> object that is passed and extract the incoming URL from there. By analyzing the URL, you can link to the proper part of your App Clip.</p>
			<p>Now that we have<a id="_idIndexMarker760"/> configured our server and App Clip so that they handle links, let's continue by configuring our App Clip experiences.</p>
			<h3>Configuring our App Clip experiences</h3>
			<p>With the App Clip and<a id="_idIndexMarker761"/> your server ready to handle links, we can start configuring our App Clip experiences. App Clip experiences are defined in App Store Connect and define the App Clip Card and the links for different scenarios that you want to handle. An App Clip Card looks like this:</p>
			<div>
				<div id="_idContainer149" class="IMG---Figure">
					<img src="image/Figure_14.20_B14717.jpg" alt="Figure 14.20 – App Clip Card&#13;&#10;"/>
				</div>
			</div>
			<p class="figure-caption">Figure 14.20 – App Clip Card</p>
			<p>As shown in the preceding screenshot, the App Clip Card contains the following:</p>
			<ul>
				<li>A header <a id="_idIndexMarker762"/>image, describing your app or the App Clip's main feature: In this example we display someone preparing a coffee.</li>
				<li>A title, describing the App Clip name: <strong class="bold">Mamine Cafe.</strong></li>
				<li>A subtitle, describing what feature does the App Clip offer: <strong class="bold">Order coffee in 3 taps.</strong></li>
				<li>A button, describing the action to perform (like open-view the App Clip): <strong class="bold">View.</strong></li>
				<li>Extra info footer: The App Clip's main app and a link to the App Store to download it.</li>
			</ul>
			<p>This App Clip Card is what the device will display to the user so that they can launch your App Clip. We will configure it in App Store Connect.</p>
			<p>Once you have created the corresponding app via the App Store Connect website and uploaded a build with the App Clip included, you will be able to configure your App Clip Experience:</p>
			<div>
				<div id="_idContainer150" class="IMG---Figure">
					<img src="image/Figure_14.21_B14717.jpg" alt="Figure 14.21 – App Clip Experience configuration&#13;&#10;"/>
				</div>
			</div>
			<p class="figure-caption">Figure 14.21 – App Clip Experience configuration</p>
			<p>As you can see, there<a id="_idIndexMarker763"/> are three main things to configure in the default App Clip Experience:</p>
			<ul>
				<li><strong class="bold">A header image</strong>: Size = 3000 x 2000 px. Aspect Ratio = 3:2. Format = <strong class="source-inline">.png</strong>/<strong class="source-inline">.jpg</strong>. No transparency.</li>
				<li><strong class="bold">A copy of the subtitle</strong>: 43 characters maximum.</li>
				<li><strong class="bold">The call to action</strong>: Here, you can choose from Open, View, and Play.</li>
			</ul>
			<p>You can also click on <strong class="bold">Edit Advanced Experiences</strong> to configure different triggers and flows. If you want to launch your App Clip from NFC tags or visual codes, associate your App Clip with a physical location, or create an App Clip for multiple businesses to use, then you need Advanced Experiences. First, you will need to specify the URL that will trigger the App Clip Experience:</p>
			<div>
				<div id="_idContainer151" class="IMG---Figure">
					<img src="image/Figure_14.22_B14717.jpg" alt="Figure 14.22 – URL configuration to invoke an App Clip Experience&#13;&#10;"/>
				</div>
			</div>
			<p class="figure-caption">Figure 14.22 – URL configuration to invoke an App Clip Experience</p>
			<p>After pressing <strong class="bold">Next</strong>, you<a id="_idIndexMarker764"/> can configure the App Clip Card:</p>
			<p class="figure-caption"> </p>
			<div>
				<div id="_idContainer152" class="IMG---Figure">
					<img src="image/Figure_14.23_B14717.jpg" alt="Figure 14.23 – Configuring the advanced App Clip card&#13;&#10;"/>
				</div>
			</div>
			<p class="figure-caption">Figure 14.23 – Configuring the advanced App Clip card</p>
			<p>At this point, you<a id="_idIndexMarker765"/> can configure the language of the card, and even specify whether the experience is triggered at a specific location. </p>
			<p>Adding advanced App Clip Experiences allows your App to show different App Clips for different URLs. For example, is you have a coffee shop app, you can have an App Clip for showing the menu, an App Clip for ordering a coffee straight away, an App Clip for displaying your clients' points cards, and so on.</p>
			<p>In this section, we learned how to configure an App Clip and its experiences in App Store Connect. Now, let's learn how to configure the Smart App Banner so that you can trigger a banner on your website so that users can display your app and App Clip.</p>
			<h3>Configuring a Smart App Banner</h3>
			<p>By adding a Smart<a id="_idIndexMarker766"/> App Banner to your website, you're<a id="_idIndexMarker767"/> offering your users a fast and native way to discover and launch your app. You need to add the following meta tag to your website HTML files (where you want the banner to be displayed):</p>
			<p class="source-code">&lt;meta name="<strong class="bold">apple-itunes-app</strong>" content="<strong class="bold">app-id=myAppStoreID</strong>, app-clip-bundle-id=<strong class="bold">appClipBundleID</strong>, affiliate-data=<strong class="bold">myAffiliateData</strong>, app-argument=<strong class="bold">myAppArgument</strong>"&gt;</p>
			<p>You need to replace the highlighted values with your own. Also, note that <strong class="source-inline">app-argument</strong> is not available when you're launching an App Clip. Remember that you should add the domain of any page that displays this banner to the app and your App Clip's Associated Domains Entitlements.</p>
			<p>In this section, we learned how to configure link handling, App Clip Experiences, and Smart App Banners. In the next section, we'll how to test our App Clip while in development.</p>
			<h2 id="_idParaDest-227"><a id="_idTextAnchor482"/>Testing your App Clip Experiences</h2>
			<p>Once you have <a id="_idIndexMarker768"/>finished developing and configuring your App Clip, it is time to test everything to double-check that your App Clip Experiences work as expected. There are three ways to test your App Clip Experiences:</p>
			<ul>
				<li>By debugging the invocation URL in Xcode (we have seen this throughout this chapter, when using <strong class="source-inline">_XCAppClipURL</strong>).</li>
				<li>By creating an App Clip Experience for testers in TestFlight (so that your App is ready for launch and is complete).</li>
				<li>By creating a local experience on a device and testing invocations from NFC or visual codes during development.</li>
			</ul>
			<p>Let's dig deeper into this last point. Let's use the <strong class="source-inline">AppClipExample_test</strong> project in this book's code bundle so that we can test our App Clip Experiences on it.</p>
			<p>One advantage of testing your App Clip Experiences while in development with Local Experiences is that you don't need to configure your associated domains, make changes to your server, or deal with TestFlight. We can do everything locally. Let's get started:</p>
			<ol>
				<li value="1">First, build and run<a id="_idIndexMarker769"/> your app and App Clip on any device. Then, on the device, open <strong class="bold">Settings | Developer | Local Experiences</strong> and select <strong class="bold">Register Local Experience...</strong>:<div id="_idContainer153" class="IMG---Figure"><img src="image/Figure_14.24_B14717.jpg" alt="Figure 14.24 – Local Experiences setup&#13;&#10;"/></div><p class="figure-caption">Figure 14.24 – Local Experiences setup</p></li>
				<li>Now, you can configure the Local Experience, as shown in the following screenshot. Remember to use your own values for the app:</li>
			</ol>
			<div>
				<div id="_idContainer154" class="IMG---Figure">
					<img src="image/Figure_14.25_B14717.jpg" alt="Figure 14.25 – Local Experience data&#13;&#10;"/>
				</div>
			</div>
			<p class="figure-caption">Figure 14.25 – Local Experience data</p>
			<p>To launch the App <a id="_idIndexMarker770"/>Clip Card, you can use any tool that allows you to generate a QR code or NFC tag with the same URL you specified in the preceding screen (under <strong class="bold">URL PREFIX</strong>). Upon doing this, your App Clip Card should appear when you scan it with your device.</p>
			<p class="callout-heading">Important Note</p>
			<p class="callout">The bundle ID that's defined in Local Experience must match the bundle ID of your App Clip. </p>
			<p class="callout">The App Clip must be installed on the device.</p>
			<p class="callout">If the camera app doesn't open the App Clip, try using the QR Code Scanner from the Control Center of iOS (if you don't have it, you can add it by going to <strong class="bold">Settings | Control Center</strong>).</p>
			<p>In this section, we <a id="_idIndexMarker771"/>learned how to configure Local Experiences in order to test our App Clip Cards while they're in development. Now, let's wrap up this chapter.</p>
			<h1 id="_idParaDest-228"><a id="_idTextAnchor483"/>Summary</h1>
			<p>In this chapter, we reviewed one of the best new features of iOS 14: App Clips. We explained what an App Clip is, what the user journey is, which features we should focus on when developing an App Clip, and which options are available for invoking them.</p>
			<p>After learning the basics, we developed and configured our first App Clip for a coffee shop app. We refactored the project so that we could share code and resources between the app and the App Clip. We then learned how to use <strong class="bold">Active Compilation Conditions</strong> to trigger pieces of our code base, but only for the App Clip or the app itself, as well as how to configure our app and server for link handling.</p>
			<p>Finally, we learned how to configure the App Clip Experiences in App Store Connect and how to test them while in development.</p>
			<p>In the next chapter, you will learn about the Vision Framework.</p>
		</div>
		<div>
			<div id="_idContainer156">
			</div>
		</div>
	</body></html>