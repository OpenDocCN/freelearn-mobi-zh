# 13

# 自定义下标

在2012年，Objective-C中增加了自定义下标。当时，Chris Lattner已经开发了Swift两年了，并且像其他优秀特性一样，下标也被添加到了Swift语言中。我在许多其他语言中并没有使用过自定义下标；然而，当我用Swift进行开发时，我发现自己在广泛地使用下标。使用下标的语法看起来像是语言的自然组成部分，可能是因为它们在语言发布时就是语言的一部分，而不是后来添加的。一旦开始使用它们，可能会发现它们变得不可或缺。

在本章中，我们将涵盖以下主题：

+   什么是自定义下标？

+   将自定义下标添加到类、结构体或枚举中

+   创建读写和只读下标

+   使用自定义下标访问外部名称

+   使用多维下标

# 介绍下标

在Swift语言中，下标被用作访问集合、列表或序列元素的快捷方式。我们可以在自定义类型中使用它们，通过索引来设置或检索值，而不是使用getter和setter方法。如果正确使用，下标可以显著提高我们自定义类型的可用性和可读性。

我们可以为单个类型定义多个下标。当类型有多个下标时，将根据下标传递的索引类型选择合适的下标。我们还可以为我们的下标设置外部参数名称，这有助于区分具有相同类型的下标。

我们使用自定义下标的方式就像我们使用数组和大字典的下标一样。例如，要访问数组中的一个元素，我们使用`Array[index]`语法。当我们为自定义类型定义自定义下标时，我们也使用相同的`ourType[key]`语法。

在创建自定义下标时，我们应该努力使它们感觉像是类、结构体或枚举的自然部分。如前所述，下标可以显著提高我们代码的可用性和可读性，但如果我们过度使用它们，它们将不会感觉自然，并且难以使用和理解。

在本章中，我们将探讨几个示例，说明我们如何创建和使用自定义下标。然而，在我们了解如何使用自定义下标之前，让我们回顾一下如何在Swift数组中使用下标，以了解下标在Swift语言本身中的使用方式。我们应该以类似Apple在语言中使用下标的方式使用下标，使我们的自定义下标易于理解和使用。

# Swift数组中的下标

以下示例展示了如何使用下标来访问和更改数组的值：

[PRE0]

在先前的例子中，我们创建了一个整数数组，然后使用下标语法来显示和更改索引为三的元素。下标主要用于设置或从集合中检索信息。我们通常不使用下标来应用特定逻辑以确定要选择哪个项目。例如，我们不想使用下标向数组的末尾添加项目或检索数组中的项目数量。要向数组的末尾添加项目或获取数组中的项目数量，我们使用函数或属性，如下所示：

[PRE1]

我们自定义类型中的下标应遵循Swift语言本身设定的相同标准，这样其他使用我们类型的开发者就不会被实现方式所困惑。了解何时使用下标，何时不使用的关键在于理解它们将被如何使用。

## 创建和使用自定义下标

让我们看看如何定义一个用于读取和写入后端数组的下标。读取和写入后端存储类是自定义下标最常见的使用之一。然而，正如我们将在本章中看到的，我们不需要有一个后端存储类。以下代码展示了如何使用下标来读取和写入数组：

[PRE2]

如我们所见，下标的语法与我们使用`get`和`set`关键字在类中定义属性的方式相似。区别在于我们使用`subscript`关键字声明`subscript`。然后我们指定一个或多个输入和返回类型。

我们现在可以使用自定义下标，就像我们使用数组或字典中的下标一样。以下代码展示了如何在先前的示例中使用下标：

[PRE3]

在先前的代码中，我们创建了一个`MyNames`类的实例，并显示了索引`0`处的原始名称。然后我们更改索引`0`处的名称并重新显示它。在这个例子中，我们使用`MyNames`类中定义的下标来检索和设置类内`names`数组中的元素。

虽然我们可以使`names`数组对外部代码直接访问，但这会将我们的代码锁定在只能使用数组来存储数据。在未来，如果我们想将后端存储机制更改为字典对象，甚至是一个SQLite数据库，我们将很难做到，因为所有外部代码也必须进行更改。下标非常擅长隐藏我们在自定义类型中存储信息的方式；因此，使用这些自定义类型的外部代码不依赖于特定的存储实现。

如果我们直接访问 `names` 数组，我们也将无法验证外部代码是否正在将有效信息插入数组中。使用下标，我们可以在将数据添加到数组之前对其进行验证，以确保传递的数据是正确的。例如，在之前的例子中，我们可以在验证中添加一个验证，以确保名称只包含字母字符和某些在名称中有效的特殊字符。这在我们创建框架或库时非常有用。

## 只读自定义下标

我们也可以通过不在下标中声明设置器方法或显式声明获取器和设置器方法来使下标只读。以下代码展示了如何通过不声明获取器或设置器方法来声明只读属性：

[PRE4]

以下示例展示了如何仅通过声明获取器方法来声明只读属性：

[PRE5]

在第一个例子中，我们没有定义获取器或设置器方法；因此，Swift 将下标设置为只读，代码的行为就像是在获取器定义中一样。在第二个例子中，我们特别将代码设置在获取器定义中。这两个例子都是有效的只读下标。需要注意的是，Swift 中不允许存在只写下标。

## 计算下标

虽然前面的例子与在类或结构体中使用存储属性非常相似，但我们也可以以类似的方式使用下标来使用计算属性。让我们看看如何做到这一点：

[PRE6]

在前面的例子中，我们使用数组作为下标的后端存储机制。在这个例子中，我们使用下标的值来计算返回值。我们会这样使用这个下标：

[PRE7]

此示例显示了计算值 `5`（在初始化中定义的数字）乘以 `4`（下标值），等于 20。

## 下标值

在前面的下标示例中，所有下标都接受整数作为下标的值；然而，我们并不局限于整数。在以下示例中，我们将使用 `String` 类型作为下标的值。`subscript` 关键字也将返回 `String` 类型：

[PRE8]

在这个例子中，下标将字符串作为下标内的值，并返回一条消息说`Hello`。让我们看看如何使用这个下标：

[PRE9]

在之前的代码中，`greeting` 常量将包含字符串 `Hello Jon`。

## 静态下标

静态下标是在 Swift 5.1 中通过 SE-0254 引入的。此功能使我们能够在不创建类型实例的情况下使用下标。让我们看看它是如何工作的：

[PRE10]

在之前的代码中，我们创建了一个名为 `Hello` 的结构体，并在该结构体内部定义了一个 `subscript`。需要注意的是，在 `subscript` 声明之前有一个 `static` 关键字。我们现在能够像下一行代码所示那样使用这个下标：

[PRE11]

在之前的代码中，`greeting` 常量将包含字符串 `Hello Jon`。请注意，我们不需要创建 `Hello` 结构的实例来使用下标。

## 下标的外部名称

如本章前面所述，我们可以为我们的自定义类型有多个下标签名。合适的下标将根据传递给下标的索引类型来选择。然而，有时我们可能希望定义多个具有相同类型的下标。为此，我们可以使用与定义函数参数外部名称类似的方式使用外部名称。

让我们重写原始的 `MathTable` 结构，以包含两个下标，每个下标都接受整数作为下标类型。然而，一个将执行乘法操作，另一个将执行加法操作：

[PRE12]

如我们所见，在这个例子中，我们定义了两个下标，并且每个下标都接受整数类型。这两个下标之间的区别在于定义中的外部名称。在第一个下标中，我们定义了一个外部名称 `multiply`，因为我们在这个下标中将下标的值乘以下标内的 `num` 属性。在第二个 `subscript` 中，我们定义了一个外部名称 `add`，因为我们在这个下标中将下标的值加以下标内的 `num` 属性。

让我们看看如何使用这两个下标：

[PRE13]

如果我们运行这个示例，我们将看到根据下标内的外部名称使用了正确的下标。

在我们的下标中使用外部名称非常有用，如果我们需要多个相同类型的下标。除非需要区分多个下标，否则我不建议使用外部名称。

## 多维下标

虽然最常见的下标是只接受单个参数的，但下标并不局限于单个参数。它们可以接受任意数量的输入参数，并且这些参数可以是任何类型。

让我们看看如何使用多维下标来实现井字棋板。井字棋板看起来类似于以下图示：

![包含时钟的图片 描述自动生成](img/B16683_13_01.png)

图 13.1：空井字棋板

棋盘可以用一个二维数组来表示，其中每个维度有三个元素。棋盘的左上角方框将表示坐标 0,0，而棋盘的右下角方框将表示坐标 2,2。中间的方框将具有坐标 1,1。每个玩家将轮流将他们的棋子（通常是 `x` 或 `o`）放在棋盘上，直到一个玩家在一条线上有三个棋子或棋盘满了。

让我们看看如何使用多维数组和多维下标来实现井字棋板：

[PRE14]

我们从定义一个`3×3`数组（也称为矩阵）开始，该数组将表示游戏棋盘。然后我们定义一个可以用来设置和检索棋盘上玩家棋子的下标。下标将接受两个整数值。我们通过在括号中放置参数来定义我们的下标参数。在这个例子中，我们定义了下标，参数为`(x: Int, y: Int)`。我们可以在下标中使用`x`和`y`变量名来访问传递的值。

让我们看看如何使用这个下标在棋盘上设置用户的棋子：

[PRE15]

如果我们运行此代码，我们将看到我们在中心方格添加了`x`棋子，在左上方方格添加了`o`棋子，因此我们的游戏棋盘将类似于以下：

![包含时钟的图片 描述自动生成](img/B16683_13_02.png)

图13.2：带有两个玩家棋子的井字棋盘

我们不仅限于使用单一类型的多维下标。例如，我们可能有一个`(x: Int, y: Double, z: String)`的下标。

我们也可以为我们的多维下标类型添加外部名称，以帮助识别使用哪些值，并区分具有相同类型的下标。让我们通过创建一个基于下标值返回字符串实例数组的下标来查看如何使用多个类型和外部名称：

[PRE16]

在`SayHello`结构中，我们定义下标如下：

[PRE17]

这定义了一个包含三个元素的下标。每个元素都有一个外部名称（`messageText`、`messageName`和`number`）和一个内部名称（`message`、`name`和`number`）。前两个元素是`String`类型，最后一个元素是`Integer`类型。我们使用前两个元素为用户创建一个消息，该消息将根据最后一个（`number`）元素定义的次数重复。我们将如下使用这个下标：

[PRE18]

如果我们运行此代码，我们将看到`ret`变量包含一个包含五个字符串的数组，其中每个字符串等于`Bonjour Jon`。现在让我们看看Swift语言中最具争议的新增功能之一——动态成员查找。

# 动态成员查找

动态成员查找允许调用在运行时动态解析的属性。如果不看示例，这可能不太容易理解，所以让我们看看一个例子。假设我们有一个表示棒球队的结构的结构。这个结构有一个属性表示球队来自的城市，另一个属性表示球队的昵称。以下代码显示了此结构：

[PRE19]

在这个结构中，如果我们想检索棒球队的完整名称，包括`city`和`nickname`，我们可以轻松地创建一个如以下示例所示的方法：

[PRE20]

这是在大多数面向对象编程语言中通常会这样做的方式。然而，在我们的代码中，使用 `BaseballTeam` 结构体时，我们会用点符号检索城市和昵称作为属性，而全名作为一个方法。以下代码显示了我们会如何使用 `city` 属性和 `fullname` 方法：

[PRE21]

我们可以使用动态成员查找创建一个更干净的接口。要使用动态成员查找，我们首先需要在定义 `BaseballTeam` 结构体时添加 `@dynamicMemberLookup` 属性，如下面的代码所示：

[PRE22]

现在，我们需要将查找添加到 `BaseballTeam` 结构体中。这是通过实现 `subscript(dynamicMember:)` 下标来完成的。以下代码显示了我们将如何创建一个查找来检索 `BaseballTeam` 结构体的全名和胜率：

[PRE23]

此代码将检索传入的键，并使用 `switch` 语句，根据该键确定从下标返回什么信息。将此代码添加到 `BaseballTeam` 结构体后，我们可以使用以下示例中的查找方式：

[PRE24]

注意我们如何能够像访问正常属性一样访问 `BaseballTeam` 结构体实例的 `fullname` 和 `percent`。这使得我们的代码更加简洁且易于阅读。然而，在使用此类查找时，有一点需要注意：无法控制传递给查找的键。

在上一个示例中，我们调用了 `fullname` 和 `percent`；然而，我们同样可以轻松地调用 flower 或 dog，而无需编译器发出任何警告。这就是为什么动态成员查找存在很多争议，因为在编译时如果出现错误，不会有警告信息。

如果你使用动态成员查找，请确保验证键，并处理任何意外发送的情况，就像我们之前使用 `switch` 语句的默认情况所做的那样。

现在我们已经看到了如何使用下标，让我们快速看一下何时不应使用自定义下标。

# 现在我们已经看到了如何使用下标，让我们快速看一下何时不应使用自定义下标。

正如我们在本章中看到的，创建自定义下标可以真正增强我们的代码。然而，我们应该避免过度使用它们，或者以不符合标准下标使用方式的方式使用它们。避免过度使用下标的办法是检查 Swift 标准库中下标的使用情况。

让我们来看下面的示例：

[PRE25]

在前面的示例中，在 `MyNames` 类中，我们定义了一个用于我们应用程序中的名称数组。作为一个例子，假设在我们的应用程序中我们显示这个名称列表，并允许用户向其中添加名称。然后在 `MyNames` 类中，我们定义以下下标，允许我们向数组中添加新的名称：

[PRE26]

这样使用下标会是一个不好的选择，因为它的使用并不符合Swift语言本身对下标的用法——我们在这里使用它是为了接受一个参数并添加该值。当类被使用时，这可能会引起混淆。将这个下标重写为一个函数可能更合适，例如以下所示：

[PRE27]

记住，当你使用自定义下标时，确保你正在适当地使用它们。

# 摘要

正如我们在本章中看到的，为我们的自定义类型添加对下标的支持可以极大地增强它们的可读性和可用性。我们看到了下标可以用来在后台存储类和外部代码之间添加一个抽象层。下标也可以以类似的方式用于计算属性，其中下标用于计算一个值。正如我们指出的，使用下标的要点是适当地使用它们，并且与Swift语言中的下标用法保持一致。

在下一章中，我们将探讨闭包是什么以及如何使用它们。
