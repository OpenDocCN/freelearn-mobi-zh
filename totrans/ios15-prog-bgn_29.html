<html><head></head><body>
		<div><h1 id="_idParaDest-327"><em class="italic"><a id="_idTextAnchor483"/>Chapter 25</em>: Getting Started with SharePlay</h1>
			<p>Apple introduced <strong class="bold">SharePlay</strong> during WWDC 2021, which allows users to share experiences by integrating your apps into FaceTime using the <strong class="bold">Group Activities</strong> framework.</p>
			<p>In this chapter, you'll implement SharePlay for a sample app by adding Group Activities support to it. You'll begin by learning how SharePlay works. Next, you'll explore the app you'll be adding SharePlay support to using the Group Activities framework. After that, you'll learn how to create a custom group activity for this app, and how to manage a group activity session. Finally, you will test the SharePlay experience in the app using two iOS devices.</p>
			<p>By the end of this chapter, you'll have learned how SharePlay works, and how to update your own apps to use it.</p>
			<p>The following topics will be covered:</p>
			<ul>
				<li>Understanding SharePlay</li>
				<li>Exploring the <em class="italic">ShareOrder</em> app</li>
				<li>Creating a custom Group Activity</li>
				<li>Managing a group activity session</li>
				<li>Testing SharePlay in the <em class="italic">ShareOrder</em> app</li>
			</ul>
			<h1 id="_idParaDest-328"><a id="_idTextAnchor484"/>Technical requirements</h1>
			<p>You will implement and test the Group Activities framework in a sample app named <em class="italic">ShareOrder</em>. A paid Apple developer account and at least two iOS devices running iOS 15.1 or later with the <em class="italic">ShareOrder</em> app installed will be required. You can also use one Mac with macOS 12.1 or later installed and one iOS device with iOS 15.1 or later installed.</p>
			<p>The completed Xcode project for this chapter is in the <code>Chapter25</code> folder of the code bundle for this book, which can be downloaded here:</p>
			<p><a href="https://github.com/PacktPublishing/iOS-15-Programming-for-Beginners-Sixth-Edition">https://github.com/PacktPublishing/iOS-15-Programming-for-Beginners-Sixth-Edition</a></p>
			<p>Check out the following video to see the code in action:</p>
			<p><a href="https://bit.ly/3I9zb6Y">https://bit.ly/3I9zb6Y</a></p>
			<p>Let's start by learning about SharePlay in the next section.</p>
			<h1 id="_idParaDest-329"><a id="_idTextAnchor485"/>Understanding SharePlay</h1>
			<p>SharePlay was <a id="_idIndexMarker1414"/>introduced by Apple during WWDC 2021. It enables shared user experiences for participants in a FaceTime session. For example, a user may wish to watch a video together with another user. All the user needs to do is to FaceTime with the other user, launch the video app, and initiate SharePlay. The same app will launch for the other user and play the same video, and SharePlay ensures that the video stays in sync between both users. </p>
			<p>You can also create custom SharePlay experiences. An example of this is the <em class="italic">DrawTogether</em> app demonstrated during WWDC 2021. In the demonstration, three users initially joined a FaceTime session. One user launched the <em class="italic">DrawTogether</em> app, and initiated the SharePlay session in the app. The other users were presented with a SharePlay prompt containing a <strong class="bold">Join</strong> button. When the <strong class="bold">Join</strong> button was tapped, the <em class="italic">DrawTogether</em> app was launched for the other users, and whatever a user drew on their screen appeared on the screens of the other users.</p>
			<p class="callout-heading">Important Information</p>
			<p class="callout">You can see how the <em class="italic">DrawTogether</em> app works and how it is implemented here: <a href="https://developer.apple.com/videos/play/wwdc2021/10187">https://developer.apple.com/videos/play/wwdc2021/10187</a>.</p>
			<p class="callout">You can download the <em class="italic">DrawTogether</em> app here: <a href="https://developer.apple.com/documentation/groupactivities/drawing_content_in_a_group_session">https://developer.apple.com/documentation/groupactivities/drawing_content_in_a_group_session</a>. </p>
			<p>SharePlay is powered by the Group Activities framework. This framework uses FaceTime to synchronize your app's activities and to invite other participants to join those activities. Objects representing shared activities must conform to the <code>GroupActivity</code> protocol. After a group activity has started, a <code>GroupSession</code> object is used to synchronize app behavior between all participants.</p>
			<p class="callout-heading">Important Information</p>
			<p class="callout">You can find links to all of Apple's Group Activities-related videos during WWDC 2021 here:</p>
			<p class="callout"><a href="https://developer.apple.com/videos/wwdc2021/?q=group%20activities">https://developer.apple.com/videos/wwdc2021/?q=group%20activities</a></p>
			<p class="callout">You can read Apple's Group Activities documentation here:</p>
			<p class="callout"><a href="https://developer.apple.com/documentation/GroupActivities">https://developer.apple.com/documentation/GroupActivities</a></p>
			<p>In this<a id="_idIndexMarker1415"/> chapter, you will implement the Group Activities framework in a sample app named <em class="italic">ShareOrder</em> by following these steps:</p>
			<ol>
				<li>Add the Group Activities capability to the <em class="italic">ShareOrder</em> app.</li>
				<li>Create and configure a <em class="italic">ShareOrder</em> structure conforming to the <code>GroupActivity</code> protocol. This structure will contain metadata that describes the group activity.</li>
				<li>Configure the <em class="italic">ShareOrder</em> app's user interface with a button to activate the group activity.</li>
				<li>Implement a <code>GroupSession</code> object that allows your app to join a group activity session.</li>
				<li>Implement a <code>GroupSessionMessenger</code> object that allows your app to send and receive messages. These messages are used to synchronize what the users do in the app.</li>
			</ol>
			<p>Before you do so, let's see how the <em class="italic">ShareOrder</em> app works in the next section. </p>
			<h1 id="_idParaDest-330"><a id="_idTextAnchor486"/>Exploring the ShareOrder app</h1>
			<p>The app you <a id="_idIndexMarker1416"/>will be working on, <em class="italic">ShareOrder</em>, is a simple app that records and displays what you want to order at a restaurant. Let's build and run this app to see how it works. Follow these steps:</p>
			<ol>
				<li value="1">If you have not already done so, download the <code>Chapter25</code> folder of the code bundle for this book at this link: <a href="https://github.com/PacktPublishing/iOS-15-Programming-for-Beginners-Sixth-Edition">https://github.com/PacktPublishing/iOS-15-Programming-for-Beginners-Sixth-Edition</a>. </li>
				<li>Open the <code>Chapter25</code> folder, and you'll see two folders, <code>ShareOrder-start</code> and <code>ShareOrder-complete</code>. The first folder contains the app that you will be modifying for this lesson, and the second contains the completed app.</li>
				<li>Open the <code>ShareOrder-start</code> folder and open the <code>ShareOrder</code> Xcode project. Click on the <code>Main</code> storyboard file in the Project navigator. You should see a <strong class="bold">+</strong> button in the navigation bar and a table view filling the rest of the screen.<div><img src="img/Figure_25.01_B17469.jpg" alt="Figure 25.1: ShareOrder app with Main storyboard file displayed&#13;&#10;"/></div><p class="figure-caption">Figure 25.1: ShareOrder app with Main storyboard file displayed</p><p>The app will display a screen showing an empty table view upon launch. Tapping on the <strong class="bold">+</strong> button will present a dialog box, which allows you to enter an order, which will then appear in the table view.</p></li>
				<li>Click the <code>ViewController</code> file in the Project navigator. You should see the following <a id="_idIndexMarker1417"/>code in the Editor area:<pre>import UIKit
class ViewController: UIViewController {
   var orders: [String] = []
   @IBOutlet var tableView: UITableView!
   override func viewDidLoad() {
      super.viewDidLoad()
      title = "ShareOrder"
      tableView.register(UITableViewCell.self, 
      forCellReuseIdentifier: "orderCell")
   }
   @IBAction func addOrder(_ sender: UIBarButtonItem)
   {
      let alert = UIAlertController(title: "New
      Order", message: "Add a new order", 
      preferredStyle: .alert)
      let saveAction = UIAlertAction(title: "Save", 
      style: .default) {
         [unowned self] action in
         guard let textField = 
         alert.textFields?.first, 
         let orderToSave = textField.text else {
            return
         }
         self.orders.append(orderToSave)
         self.tableView.reloadData()
      }
      let cancelAction = UIAlertAction(title: 
      "Cancel", style: .cancel)
      alert.addTextField()
      alert.addAction(saveAction)
      alert.addAction(cancelAction)
      present(alert, animated: true)
   }
}
extension ViewController: UITableViewDataSource {
   func tableView(_ tableView: UITableView, 
   numberOfRowsInSection section: Int) -&gt; Int {
      orders.count
   }
   func tableView(_ tableView: UITableView, 
   cellForRowAt indexPath: IndexPath) -&gt; 
   UITableViewCell {
      let cell = tableView.dequeueReusableCell
      (withIdentifier: "orderCell", for: indexPath)
      cell.textLabel?.text = orders[indexPath.row]
      return cell
   }
}</pre><p>Let's break this down:</p><pre>var orders: [String] = []</pre><p>This property holds an array of orders, which are of type <code>String</code>. This array will be the data source for the table view in the app.</p><pre>@IBOutlet var tableView: UITableView!</pre><p>This outlet is connected to the table view in the view controller scene inside the <code>Main</code> storyboard file.</p><p><code>viewDidLoad()</code> method:</p><p>The code in<a id="_idIndexMarker1418"/> this method sets the title in the navigation bar to <code>ShareOrder</code>, and registers the reuse identifier <code>orderCell</code> for the table view cells.</p><p><code>addOrder(_:)</code> method:</p><p>This method is connected to the <code>orders</code> array and reload the table view. Tapping <code>orders</code> array. Each <a id="_idIndexMarker1419"/>cell in the table view will display the corresponding string in the <code>orders</code> array.</p><p class="callout-heading">Tip</p><p class="callout">You may wish to review <a href="B17469_15_Final_VK_ePub.xhtml#_idTextAnchor213"><em class="italic">Chapter 15</em></a><em class="italic">, Getting Started with Table Views</em>, which covers the table view data source methods in more detail.</p></li>
			</ol>
			<p>Build and run the app. Tap the <strong class="bold">+</strong> button, enter some text in the alert's text field, and tap <strong class="bold">Save</strong>. It will appear in the table view, as shown below:</p>
			<div><div><img src="img/Figure_25.02_B17469.jpg" alt="Figure 25.2: iOS Simulator running the ShareOrder app&#13;&#10;"/>
				</div>
			</div>
			<p class="figure-caption">Figure 25.2: iOS Simulator running the ShareOrder app</p>
			<p>Now that you are familiar with the <em class="italic">ShareOrder</em> app and how it works, you will add Group Activities support for it. After you have done so, adding an order during a SharePlay <a id="_idIndexMarker1420"/>session will make the order appear on the screen of all participants. You'll start by creating a custom Group Activity for the <em class="italic">ShareOrder</em> app in the next section.</p>
			<h1 id="_idParaDest-331"><a id="_idTextAnchor487"/>Creating a custom Group Activity</h1>
			<p>You have<a id="_idIndexMarker1421"/> seen that the <em class="italic">ShareOrder</em> app lets you add orders which will be displayed on the screen. You will add a group activity for this app that lets participants add orders during a SharePlay session which will appear on every participant's screen. A custom object is required to represent this activity. The steps required to implement this are as follows:</p>
			<ul>
				<li>Add the Group Activities entitlement to the <em class="italic">ShareOrder</em> app.</li>
				<li>Create a new structure named <code>ShareOrder</code> that conforms to the <code>GroupActivity</code> protocol, and configure the group activity metadata.</li>
				<li>Add a button to the <em class="italic">ShareOrder</em> app's user interface and add an action for this button to activate the group activity.<p class="callout-heading">Important Information</p><p class="callout">You can learn more about creating a custom Group Activity at this link: <a href="https://developer.apple.com/documentation/groupactivities/inviting-participants-to-share-an-activity">https://developer.apple.com/documentation/groupactivities/inviting-participants-to-share-an-activity</a>.</p></li>
			</ul>
			<p>Let's start by adding the Group Activities entitlement to the <em class="italic">ShareOrder</em> app in the next section. </p>
			<h2 id="_idParaDest-332"><a id="_idTextAnchor488"/>Adding the Group Activities entitlement</h2>
			<p>Because <a id="_idIndexMarker1422"/>your<a id="_idIndexMarker1423"/> app will have interactions between different devices, it must have the <code>com.apple.developer.group-session</code> entitlement. You'll use Xcode to add this entitlement to your app. Note that you need a paid Apple developer account for this. Follow these steps:</p>
			<ol>
				<li value="1">Click the <code>ShareOrder</code> project (the topmost item in the Project navigator) and click the <code>ShareOrder</code> target. Select the <strong class="bold">Signing &amp; Capabilities</strong> pane in the Editor area. Verify that<strong class="bold"> Team</strong> has been set to a paid Apple developer account.<div><img src="img/Figure_25.03_B17469.jpg" alt="Figure 25.3: Xcode Signing &amp; Capabilities pane with account set&#13;&#10;"/></div><p class="figure-caption">Figure 25.3: Xcode Signing &amp; Capabilities pane with account set</p><p class="callout-heading">Tip</p><p class="callout">Instructions on how to set a development team and how to run your app on an iOS device are provided in <a href="B17469_01_Final_VK_ePub.xhtml#_idTextAnchor016"><em class="italic">Chapter 1</em></a><em class="italic">, Getting Familiar with Xcode</em>. </p><p class="callout">Instructions<a id="_idIndexMarker1424"/> on how to get a paid<a id="_idIndexMarker1425"/> Apple Developer account are provided in <a href="B17469_26_Final_VK_ePub.xhtml#_idTextAnchor496"><em class="italic">Chapter 26</em></a><em class="italic">, Testing and Submitting Your App to the App Store</em>.</p></li>
				<li>Plug in one of your iOS devices running iOS 15 and verify that the <em class="italic">ShareOrder</em> app can run on your device.</li>
				<li>In the <strong class="bold">Signing and Capabilities</strong> pane, click the <strong class="bold">+</strong> button to add a capability to the <em class="italic">ShareOrder</em> app.<div><img src="img/Figure_25.04_B17469.jpg" alt="Figure 25.4: Xcode Signing and Capabilities pane with + button highlighted&#13;&#10;"/></div><p class="figure-caption">Figure 25.4: Xcode Signing and Capabilities pane with + button highlighted</p></li>
				<li>In the window that appears, search for and double-click the Group Activities capability to add it to the <em class="italic">ShareOrder</em> app:</li>
			</ol>
			<div><div><img src="img/Figure_25.05_B17469.jpg" alt="Figure 25.5: Group Activities capability added to ShareOrder app&#13;&#10;"/>
				</div>
			</div>
			<p class="figure-caption">Figure 25.5: Group Activities capability added to ShareOrder app</p>
			<p>You have<a id="_idIndexMarker1426"/> added the Group Activities<a id="_idIndexMarker1427"/> entitlement to the <em class="italic">ShareOrder </em>app. Next, you will create a <code>ShareOrder</code> structure to represent a group activity in the next section. </p>
			<h2 id="_idParaDest-333"><a id="_idTextAnchor489"/>Creating the ShareOrder structure</h2>
			<p>The activity<a id="_idIndexMarker1428"/> that you will implement <a id="_idIndexMarker1429"/>for the <em class="italic">ShareOrder</em> app will let orders added during a SharePlay session appear on the screen of all participants. You need an object to represent this activity. You will implement this object by creating a <code>ShareOrder</code> structure. This structure will conform the <code>GroupActivity</code> protocol, and will contain metadata describing the activity. To create and configure the <code>ShareOrder</code> structure, follow these steps:</p>
			<ol>
				<li value="1">Click the <code>ViewController</code> file in the Project navigator and import the <code>GroupActivities</code> framework as shown:<pre>import UIKit
<strong class="bold">import GroupActivities</strong></pre></li>
				<li>Add the following extension after the last curly brace to create and configure the <code>ShareOrder</code> structure:<pre>extension ViewController {
   struct ShareOrder: GroupActivity {
      var metadata: GroupActivityMetadata {
         var metadata = GroupActivityMetadata()
         metadata.title = NSLocalizedString("Share 
         Order", comment: "Title of group activity")
         metadata.type = .generic
         return metadata
      }
   }
}</pre></li>
			</ol>
			<p>This structure represents the <em class="italic">ShareOrder</em> app's shareable experience. It conforms to the <code>GroupActivity</code> protocol, which provides context and metadata to start an activity-related session. Here, you use a computed property named <code>metadata</code> to set the metadata title and the comment. For custom activities, the metadata type is set to <code>.generic</code>.</p>
			<p>You have <a id="_idIndexMarker1430"/>created and configured <a id="_idIndexMarker1431"/>the <code>ShareOrder</code> structure. In the next section, you will add a button to the <em class="italic">ShareOrder</em> app's user interface and configure this button to activate the group activity during a FaceTime session.</p>
			<h2 id="_idParaDest-334"><a id="_idTextAnchor490"/>Activating a custom group activity</h2>
			<p>You have <a id="_idIndexMarker1432"/>created and configured the <code>ShareOrder</code> structure used to represent a custom group activity for the <em class="italic">ShareOrder</em> app. Now you will add a button to the <em class="italic">ShareOrder</em> app's navigation bar to activate this group activity while you are in a FaceTime session with other participants. Follow these steps:</p>
			<ol>
				<li value="1">Click the <code>Main</code> storyboard file in the Project navigator and click the Library button.</li>
				<li>In the Library's filter field, search for a <strong class="bold">Bar Button Item</strong> object and drag it to the navigation bar next to the <strong class="bold">+</strong> button:<div><img src="img/Figure_25.06_B17469.jpg" alt="Figure 25.6: Library with Bar Button Item selected&#13;&#10;"/></div><p class="figure-caption">Figure 25.6: Library with Bar Button Item selected</p></li>
				<li>With the<a id="_idIndexMarker1433"/> bar button item selected, click the Attributes inspector button. Under <code>person.2.fill</code>:<div><img src="img/Figure_25.07_B17469.jpg" alt="Figure 25.7: Attributes inspector showing bar button item with Image set to person.2.fill&#13;&#10;"/></div><p class="figure-caption">Figure 25.7: Attributes inspector showing bar button item with Image set to person.2.fill</p><p>This sets the icon for the bar button item.</p></li>
				<li>Click the Adjust Editor Options button and choose <code>ViewController</code> file will appear in the assistant editor.</p></li>
				<li><em class="italic">Control + Drag</em> from the bar button item you just added to just before the <code>addOrder(_:)</code> method in the assistant editor.<p>A pop-up dialog box will appear.</p></li>
				<li>In the <code>activateGroupActivity</code> and click <strong class="bold">Connect</strong>:<div><img src="img/Figure_25.08_B17469.jpg" alt="Figure 25.8: Pop-up dialog box with Name set to activateGroupActivity&#13;&#10;"/></div><p class="figure-caption">Figure 25.8: Pop-up dialog box with Name set to activateGroupActivity</p></li>
				<li>Add the following code to the <code>activateGroupActivity(_:)</code> method to activate the group activity when the bar button item is tapped:<pre>@IBAction func activateGroupActivity(_ sender: Any) {
<strong class="bold">   Task {</strong>
<strong class="bold">      do {</strong>
<strong class="bold">         try await ShareOrder().activate()</strong>
<strong class="bold">      } catch {</strong>
<strong class="bold">         print("Unable to activate")</strong>
<strong class="bold">      }</strong>
<strong class="bold">   }</strong>
}</pre><p>This will display a SharePlay prompt with a <strong class="bold">Join</strong> button to all participants in the FaceTime session.</p></li>
				<li>Click the <strong class="bold">x</strong> button to close the assistant editor.</li>
			</ol>
			<p>You have just<a id="_idIndexMarker1435"/> added a button that will activate your group activity when tapped. In the next section, you'll learn how to manage a group activity session in the <em class="italic">ShareOrder</em> app.</p>
			<h1 id="_idParaDest-335"><a id="_idTextAnchor491"/>Managing a group activity session</h1>
			<p>You have <a id="_idIndexMarker1436"/>created the <code>ShareOrder</code> structure to represent a group activity for the <em class="italic">ShareOrder</em> app, and you have added a button to the app's navigation bar to activate the group activity during a FaceTime session. Now you need to add code to allow participants to join this group activity session and keep all participants in sync with one another. The steps required to implement this are as follows:</p>
			<ul>
				<li>Create a <code>GroupSession</code> object that lets the app join a group activity session.</li>
				<li>Create a <code>GroupSessionMessenger</code> object that lets the app send and receive messages to synchronize content.<p class="callout-heading">Important Information</p><p class="callout">You can learn more about session management at this link: <a href="https://developer.apple.com/documentation/groupactivities/joining-your-app-to-a-shared-activity">https://developer.apple.com/documentation/groupactivities/joining-your-app-to-a-shared-activity</a>.</p></li>
			</ul>
			<p>Let's see how to implement and configure a <code>GroupSession</code> object for the <em class="italic">ShareOrder</em> app in the next section.</p>
			<h2 id="_idParaDest-336"><a id="_idTextAnchor492"/>Implementing a GroupSession object</h2>
			<p>The <em class="italic">ShareOrder</em> app <a id="_idIndexMarker1437"/>currently has an object to represent <a id="_idIndexMarker1438"/>the group activity, and a button that is used to activate the group activity during a FaceTime session. You'll add code to your app to implement a <code>GroupSession</code> object, which will allow participants to join the group activity session. To implement and configure the <code>GroupSession</code> object for the <em class="italic">ShareOrder</em> app, follow these steps:</p>
			<ol>
				<li value="1">Click the <code>ViewController</code> file in the Project navigator. Add an optional property after the <code>orders</code> property to hold an instance of the group activity session:<pre>var orders: [String] = [] 
<strong class="bold">var groupSession: GroupSession&lt;ShareOrder&gt;?</strong></pre></li>
				<li>Add the following code to <code>viewDidLoad()</code> to create an asynchronous task to receive a group session:<pre>override func viewDidLoad() {
   super.viewDidLoad()
   title = "ShareOrder"
   tableView.register(UITableViewCell.self, 
   forCellReuseIdentifier: "orderCell")
<code>Task</code> is a unit of asynchronous work, and is covered in <a href="B17469_24_Final_VK_ePub.xhtml#_idTextAnchor469"><em class="italic">Chapter 24</em></a>,<em class="italic"> Getting Started with Swift Concurrency</em>.</p><p>You'll see an error because <code>configureGroupSession(_:)</code> has not yet been implemented.</p></li>
				<li>Add the following code to the extension after the <code>ShareOrder</code> structure definition to implement the <code>configureGroupSession(_:)</code> method:<pre>func configureGroupSession(_ groupSession: 
GroupSession&lt;ShareOrder&gt;) {
   orders.removeAll()
   self.groupSession = groupSession
}</pre><p>This <a id="_idIndexMarker1439"/>method<a id="_idIndexMarker1440"/> removes all the orders in the <code>orders</code> array, then assigns the received group activity session to the <code>groupSession</code> property.</p></li>
				<li>Modify the <code>configureGroupSession(_:)</code> method by adding code to join the group activity session:<pre>func configureGroupSession(_ groupSession: 
GroupSession&lt;ShareOrder&gt;){
   orders.removeAll()
   self.groupSession = groupSession
   <code>ShareOrder</code> project at this point.</p></li>
			</ol>
			<p>Now that you've implemented and configured the <code>GroupSession</code> object, you'll implement <a id="_idIndexMarker1441"/>and <a id="_idIndexMarker1442"/>configure a <code>GroupSessionMessenger</code> object for the <em class="italic">ShareOrder</em> app in the next section.</p>
			<h2 id="_idParaDest-337"><a id="_idTextAnchor493"/>Implementing a GroupSessionMessenger object</h2>
			<p>Once <a id="_idIndexMarker1443"/>the <a id="_idIndexMarker1444"/>users of the <em class="italic">ShareOrder</em> app have joined the SharePlay session, any orders they add to the app will appear on everyone's screen. This synchronization is handled by a <code>GroupSessionMessenger</code> object, which can send messages to and receive messages from other devices in the group activity session. Do note that it is important to keep the size of the messages small, as large message sizes may cause apps to crash. For this app, the messages will just hold the strings containing the orders submitted, which will be quite small. To implement the <code>GroupSessionMessenger</code> object for the <em class="italic">ShareOrder</em> app, follow these steps:</p>
			<ol>
				<li value="1">In the <code>ViewController</code> file, add a new optional property after the <code>groupSession</code> property to hold an instance of <code>GroupSessionMessenger</code>:<pre>var groupSession: GroupSession&lt;ShareOrder&gt;?
<strong class="bold">var messenger: GroupSessionMessenger?</strong></pre></li>
				<li>Modify the <code>configureGroupSession(_:)</code> method to create an instance of <code>GroupSessionMessenger</code> and assign it to the <code>messenger</code> property:<pre>func configureGroupSession(_ groupSession: 
GroupSession&lt;ShareOrder&gt;){
   orders.removeAll()
   self.groupSession = groupSession
<strong class="bold">   let messenger = GroupSessionMessenger(session: </strong>
<strong class="bold">   groupSession)</strong>
<strong class="bold">   self.messenger = messenger</strong>
   groupSession.join()
}</pre></li>
				<li>Add an asynchronous task to receive <code>GroupSessionMessenger</code> messages after the <code>messenger</code> property assignment:<pre>let messenger = GroupSessionMessenger(session: 
groupSession)
self.messenger = messenger
<code>GroupSessionMessenger</code> message<a id="_idIndexMarker1446"/> contains a string representing an order. You will implement a <code>handle(_:)</code> method and pass the message to this method to be processed. You'll see an error because the <code>handle(_:)</code> method has not yet been implemented.</p></li>
				<li>Implement the <code>handle(_:)</code> method after the <code>configureGroupSession(_:)</code> method as shown:<pre>func handle(_ message: String) {
   self.orders.append(message)
   self.tableView.reloadData()
}</pre><p>This method appends the string from the message to the <code>orders</code> array, and reloads the table view.</p></li>
				<li>Modify the <code>addOrder(_:)</code> method as follows to send a <code>GroupSessionMessenger</code> message when a participant taps the <strong class="bold">+</strong> button:<pre>self.orders.append(orderToSave)
<strong class="bold">if let messenger = messenger {</strong>
<strong class="bold">   Task {</strong>
<strong class="bold">      do {</strong>
<strong class="bold">         try await messenger.send(orderToSave)</strong>
<strong class="bold">      } catch {</strong>
<strong class="bold">         print("Failed to send")</strong>
<strong class="bold">      }</strong>
<strong class="bold">   }</strong>
<strong class="bold">}</strong>
self.tableView.reloadData()</pre></li>
			</ol>
			<p>The code you added to the <code>addOrder(_:)</code> method creates an asynchronous task that sends the message containing the order to all other participants in the FaceTime session. When the message is received, it will be processed by the <code>handle(_:)</code> method, which adds the order to the <code>orders</code> array and reloads the table view.</p>
			<p>Build and<a id="_idIndexMarker1447"/> run the <em class="italic">ShareOrder</em> app on <a id="_idIndexMarker1448"/>your iOS 15 device. It should work as it did before. In the next section, you'll test SharePlay in the <em class="italic">ShareOrder </em>app by using two iOS devices in a FaceTime session.</p>
			<h1 id="_idParaDest-338"><a id="_idTextAnchor494"/>Testing SharePlay in the ShareOrder app</h1>
			<p>You have <a id="_idIndexMarker1449"/>added <a id="_idIndexMarker1450"/>all the code required to implement SharePlay in the <em class="italic">ShareOrder</em> app. In order to test it, you'll need two iOS devices running iOS 15.1 or later with the <em class="italic">ShareOrder</em> app installed. You could also use a Mac running macOS 12.1 Monterey or later as one of the devices. You'll initiate a FaceTime session between both devices and initiate a SharePlay session. You should be able to add orders from either device, and any orders you add will appear on both screens. Follow these steps:</p>
			<ol>
				<li value="1">Install the <em class="italic">ShareOrder</em> app on your second iOS device. </li>
				<li>Start a FaceTime call between the two devices and launch the <em class="italic">ShareOrder</em> app on <a id="_idIndexMarker1451"/>the <a id="_idIndexMarker1452"/>first device. <div><img src="img/Figure_25.09_B17469.jpg" alt="Figure 25.9: ShareOrder running on first device during FaceTime call&#13;&#10;"/></div><p class="figure-caption">Figure 25.9: ShareOrder running on first device during FaceTime call</p></li>
				<li>Tap the button to activate the group activity. You should see a SharePlay prompt on the second device. <div><img src="img/Figure_25.10_B17469.jpg" alt="Figure 25.10: Tapping button on first device triggers SharePlay prompt on second device&#13;&#10;"/></div><p class="figure-caption">Figure 25.10: Tapping button on first device triggers SharePlay prompt on second device</p></li>
				<li>Tap <a id="_idIndexMarker1453"/>the <strong class="bold">Join</strong> button in the SharePlay <a id="_idIndexMarker1454"/>prompt, and the <em class="italic">ShareOrder</em> app will launch on the second device. Add an order using the <strong class="bold">+</strong> button, and it will appear on the screen of both devices.</li>
			</ol>
			<div><div><img src="img/Figure_25.11_B17469.jpg" alt="Figure 25.11: Same orders appear on both devices&#13;&#10;"/>
				</div>
			</div>
			<p class="figure-caption">Figure 25.11: Same orders appear on both devices</p>
			<p>Congratulations! You've<a id="_idIndexMarker1455"/> just implemented SharePlay<a id="_idIndexMarker1456"/> in the <em class="italic">ShareOrder</em> app!</p>
			<h1 id="_idParaDest-339"><a id="_idTextAnchor495"/>Summary</h1>
			<p>In this chapter, you implemented SharePlay for the <em class="italic">ShareOrder</em> app by adding Group Activities support to it. </p>
			<p>You started by learning how SharePlay works. Next, you explored the <em class="italic">ShareOrder</em> app to see how it works. After that, you created a custom group activity for this app, and added code to manage a group activity session. Finally, you tested the SharePlay experience in the app using two iOS devices.</p>
			<p>You now understand the basics of SharePlay and will now be able to add custom group activities into your own apps.</p>
			<p>In the next chapter, you will learn how to test and submit your app to the App Store.</p>
		</div>
	</body></html>