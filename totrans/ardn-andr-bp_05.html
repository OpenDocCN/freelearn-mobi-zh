<html><head></head><body><div class="chapter" title="Chapter&#xA0;5.&#xA0;Wi-Fi Remote Security Camera"><div class="titlepage"><div><div><h1 class="title"><a id="ch05"/>Chapter 5. Wi-Fi Remote Security Camera</h1></div></div></div><p>In this chapter, we <a id="id267" class="indexterm"/>will build a Wi-Fi remote security camera. The camera itself will be based on the Arduino Yùn and a standard USB webcam. The Arduino Yùn is a powerful Arduino board that has an onboard Linux machine and Wi-Fi connectivity. The Arduino Yùn will take the video coming from the camera and stream it on the local Wi-Fi network.</p><p>Then, we will be able to access the video stream from our physical Android device. This will give us the mobile flexibility to access our video stream from anywhere in our home.</p><p>From this chapter, you will learn how to:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">Use the Arduino Yùn and connect a USB camera to it</li><li class="listitem" style="list-style-type: disc">Configure the Yùn to stream the video over your local Wi-Fi network</li><li class="listitem" style="list-style-type: disc">Build an Android application to get the stream from the USB camera</li></ul></div><div class="section" title="Hardware and software requirements"><div class="titlepage"><div><div><h1 class="title"><a id="ch05lvl1sec26"/>Hardware and software requirements</h1></div></div></div><p>The Wi-Fi remote security camera project <a id="id268" class="indexterm"/>is based around the Arduino Yùn board. The Arduino Yùn is a powerful Arduino board <a id="id269" class="indexterm"/>with integrated Wi-Fi and an onboard Linux machine based on a very small Linux distribution called OpenWrt. It also has a USB port so that you can connect hard drives, cameras, or other USB devices. We will use all these features in this project.</p><p>The following is an image of the board that was used in this project:</p><div class="mediaobject"><img src="graphics/0389OS_05_01.jpg" alt="Hardware and software requirements"/></div><p>You will also need a USB camera to stream live video with the Yùn. You can basically get any camera that is compatible with <a id="id270" class="indexterm"/>
<span class="strong"><strong>USB Video Class</strong></span> (<span class="strong"><strong>UVC</strong></span>). For this project, I used a Logitech C270 HD camera.</p><p>If you plan to use <a id="id271" class="indexterm"/>the camera for other <a id="id272" class="indexterm"/>applications, such as recording still pictures on the Yùn, you will also need a microSD card to save the data. Finally, you will need a micro USB cable to power the Yùn. The following is a list of<a id="id273" class="indexterm"/> all <a id="id274" class="indexterm"/>hardware components that are required for this chapter:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">Arduino Yùn (<a class="ulink" href="https://www.adafruit.com/products/1498">https://www.adafruit.com/products/1498</a>)</li><li class="listitem" style="list-style-type: disc">A <a id="id275" class="indexterm"/>UVC compatible USB camera (<a class="ulink" href="http://en.wikipedia.org/wiki/List_of_USB_video_class_devices">http://en.wikipedia.org/wiki/List_of_USB_video_class_devices</a>)</li><li class="listitem" style="list-style-type: disc">A micro USB cable</li><li class="listitem" style="list-style-type: disc">A<a id="id276" class="indexterm"/> 4 GB microSD card, which is optional (<a class="ulink" href="https://www.adafruit.com/products/102">https://www.adafruit.com/products/102</a>)</li></ul></div><p>You will need to configure your Arduino Yùn by following the official guide so that it can connect to your <a id="id277" class="indexterm"/>Wi-Fi network:</p><p>
<a class="ulink" href="http://arduino.cc/en/Guide/ArduinoYùn">http://arduino.cc/en/Guide/ArduinoYùn</a>
</p><p>Note that you <a id="id278" class="indexterm"/>might have problems configuring your Arduino Yùn if you are behind a proxy. If this is the case, try disabling the proxy to see if it solves the problem.</p><p>If your Yùn is not <a id="id279" class="indexterm"/>recent, you might need to update OpenWrt (the Yùn's operating system) to the latest version. The<a id="id280" class="indexterm"/> procedure is described in the guide and can be found at <a class="ulink" href="http://arduino.cc/en/Tutorial/YùnSysupgrade">http://arduino.cc/en/Tutorial/YùnSysupgrade</a>.</p><p>After the Wi-Fi configuration is done, we will install the required packages to handle the camera and stream video on your local Wi-Fi network. Go to a terminal (use a terminal software, such as PuTTY or OpenSSH, if you are using Windows), and type the following command:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>ssh root@yourYùnName.local</strong></span>
</pre></div><p>Of course, you need to change the command with the name of your Arduino Yùn that you defined when configuring it. If you forgot the name of your board, you will need to reset the Yùn and configure it again.</p><p>You will then be prompted to enter your password that you defined during the Yùn's configuration step. You will then be greeted by a screen similar to the one shown in the following screenshot:</p><div class="mediaobject"><img src="graphics/0389OS_05_02.jpg" alt="Hardware and software requirements"/></div><p>You can are now logged into the Arduino Yùn. You can type the following command to update the list<a id="id281" class="indexterm"/> of available packages:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>opkg update</strong></span>
</pre></div><p>Then type <a id="id282" class="indexterm"/>this command to install the required packages for live video streaming:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>opkg install kmod-video-uvc mjpg-streamer</strong></span>
</pre></div><div class="section" title="Hardware configuration"><div class="titlepage"><div><div><h2 class="title"><a id="ch05lvl2sec38"/>Hardware configuration</h2></div></div></div><p>The hardware configuration<a id="id283" class="indexterm"/> for this project is really simple. First, insert the formatted microSD card into the Arduino Yùn SD card reader, as shown in the following screenshot:</p><div class="mediaobject"><img src="graphics/0389OS_05_03.jpg" alt="Hardware configuration"/></div><p>After this, you just <a id="id284" class="indexterm"/>have to connect the USB camera to the host USB port of the Yùn, as shown in the following screenshot:</p><div class="mediaobject"><img src="graphics/0389OS_05_04.jpg" alt="Hardware configuration"/></div><p>To finish the hardware configuration of the project, simply connect the board to power via the micro USB port (actually, you don't even need to connect it to your computer, the Arduino Yùn can<a id="id285" class="indexterm"/> work completely independently!).</p></div><div class="section" title="Setting up video streaming"><div class="titlepage"><div><div><h2 class="title"><a id="ch05lvl2sec39"/>Setting up video streaming</h2></div></div></div><p>We will <a id="id286" class="indexterm"/>now set up <a id="id287" class="indexterm"/>the Arduino Yùn so that it continuously streams video. Once more log in to your Arduino Yùn using the following command:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>ssh root@yourYùnName</strong></span>
</pre></div><p>Again, replace the command with the name of your Arduino Yùn. Then type the following command:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>mjpg_streamer -i "input_uvc.so -d /dev/video0 -r 640x480 -f 25" -o "output_http.so -p 8080 -w /www/webcam" &amp;</strong></span>
</pre></div><p>This basically <a id="id288" class="indexterm"/>means that it will start the streaming at a resolution of 640 x 480, at 25 frames per second, and on the <code class="literal">8080</code> port.</p><p>You should see a<a id="id289" class="indexterm"/> series of commands being printed inside the terminal, meaning that the Yùn is now streaming live video on your Wi-Fi network. Now, go to your favorite web browser and type <code class="literal">yourYùnName.local:8080</code>.</p><p>This will open the main streaming interface, where you can select the desired streaming type. To access the<a id="id290" class="indexterm"/> stream itself for a test, go to <code class="literal">http://arduinoYùn.local:8080/stream.html</code>.</p><p>Note that this link is only valid within your own local Wi-Fi network. You will be greeted with the live stream coming from your Arduino Yùn, as shown in the following screenshot:</p><div class="mediaobject"><img src="graphics/0389OS_05_05.jpg" alt="Setting up video streaming"/></div></div><div class="section" title="Implementing a fullscreen stream player on Android"><div class="titlepage"><div><div><h2 class="title"><a id="ch05lvl2sec40"/>Implementing a fullscreen stream player on Android</h2></div></div></div><p>In this project, we <a id="id291" class="indexterm"/>will implement a very simple Android app that will show the MJPEG stream from our Arduino Yùn. We<a id="id292" class="indexterm"/> will assume that you will have switched on the <code class="literal">Auto-Import</code> function within your Android Studio preferences. If not, kindly activate it by going to the <span class="strong"><strong>Auto-Import</strong></span> preferences and selecting all the available options. The <span class="strong"><strong>Auto-Import</strong></span> preferences<a id="id293" class="indexterm"/> are available on Mac and Windows as follows:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>Mac</strong></span>: <span class="strong"><strong>Android Studio</strong></span> &gt; <span class="strong"><strong>Preferences</strong></span> &gt; <span class="strong"><strong>Editor</strong></span> &gt; <span class="strong"><strong>Auto-Import</strong></span></li><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>Windows</strong></span>: <span class="strong"><strong>File</strong></span> &gt; <span class="strong"><strong>Settings</strong></span> &gt; <span class="strong"><strong>Editor</strong></span> &gt; <span class="strong"><strong>Auto-Import</strong></span></li></ul></div><p>With all the<a id="id294" class="indexterm"/> necessary settings in place, we will first start off by creating a new project where we will choose the following within the <span class="strong"><strong>New Project</strong></span> setup:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>Name</strong></span>: <code class="literal">Android Yùn Security</code></li><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>Minimum SDK</strong></span>: <code class="literal">15</code></li><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>Project</strong></span>: <code class="literal">Blank Activity</code></li><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>Activity Name</strong></span>: <code class="literal">StreamActivity</code></li></ul></div><p>In this project, we will be<a id="id295" class="indexterm"/> working with three Java classes and we will need to create two classes, namely <code class="literal">MjpegInputStream</code> and <code class="literal">MjpegView</code>. The<a id="id296" class="indexterm"/> Java classes are as follows:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><code class="literal">StreamActivity</code> (the main activity that is created upon the start of a new project)</li><li class="listitem" style="list-style-type: disc"><code class="literal">MjpegInputStream</code></li><li class="listitem" style="list-style-type: disc"><code class="literal">MjpegView</code></li></ul></div><p>To create a new class, you will need to go to <code class="literal">app</code> &gt; <code class="literal">src</code> &gt; <code class="literal">main</code> &gt; <code class="literal">java</code> &gt; <code class="literal">com.domainofyourchoice.androidYùnsecurity</code>.</p><p>Right-click on the package name and go on <span class="strong"><strong>New</strong></span> &gt; <span class="strong"><strong>Java Class</strong></span>, as shown in the following screenshot:</p><p> </p><div class="mediaobject"><img src="graphics/0389OS_05_06.jpg" alt="Implementing a fullscreen stream player on Android"/></div><p>
</p><p>First things first; this application won't be able to work if we don't declare the Internet user<a id="id297" class="indexterm"/> permission. So, we <a id="id298" class="indexterm"/>head off to <code class="literal">AndroidManifest.xml</code> and we add the following line of code below the package name:</p><div class="informalexample"><pre class="programlisting">&lt;uses-permission android:name="android.permission.INTERNET"/&gt;
&lt;uses-permission android:name="android.permission.ACCESS_WIFI_STATE"</pre></div><p>The Android manifest will look as follows when completed:</p><div class="informalexample"><pre class="programlisting">&lt;?xml version="1.0" encoding="utf-8"?&gt;
&lt;manifest 
    package="com.arduinoandroid.androidYùnsecurity" &gt;

    &lt;uses-permission android:name="android.permission.ACCESS_WIFI_STATE"/&gt;
    &lt;uses-permission android:name="android.permission.INTERNET"/&gt;

    &lt;application
        android:allowBackup="true"
        android:icon="@drawable/ic_launcher"
        android:label="@string/app_name"
        android:theme="@style/AppTheme" &gt;
        &lt;activity
            android:name=".StreamActivity"
            android:label="@string/app_name" &gt;
            &lt;intent-filter&gt;
                &lt;action android:name="android.intent.action.MAIN" /&gt;

                &lt;category android:name="android.intent.category.LAUNCHER" /&gt;
            &lt;/intent-filter&gt;
        &lt;/activity&gt;
    &lt;/application&gt;

&lt;/manifest&gt;</pre></div><p>Then we<a id="id299" class="indexterm"/> head off to <code class="literal">StreamActivity.java</code> where we will start off our main streaming activity. In this project, we will use ASync tasks to do our network activity.</p><p>We will first <a id="id300" class="indexterm"/>declare <code class="literal">String TAG</code> (which we will be using for logging) and <code class="literal">MjpegView</code> (which refers to an instance of class that we have already created):</p><div class="informalexample"><pre class="programlisting">public class StreamActivity extends Activity {
    private static final String TAG = "MjpegActivity";

    private MjpegView mv;</pre></div><p>In the <code class="literal">onCreate</code> method, we will declare our URL and also declare a number of parameters to set the video stream to fullscreen. It's important to replace <code class="literal">youripaddress</code> with the IP address that you can easily find out from the Arduino Yùn web panel:</p><div class="informalexample"><pre class="programlisting">    public void onCreate(Bundle savedInstanceState) {
        super.onCreate(savedInstanceState);

        //sample public ca
        String URL = "http://youripaddress:8080/?action=stream";

        requestWindowFeature(Window.FEATURE_NO_TITLE);
        getWindow().setFlags(WindowManager.LayoutParams.FLAG_FULLSCREEN,
                WindowManager.LayoutParams.FLAG_FULLSCREEN);

        mv = new MjpegView(this);
        setContentView(mv);

        new DoRead().execute(URL);
    }</pre></div><p>We will also need to declare the <code class="literal">onPause()</code> method that will be implemented when the Android <a id="id301" class="indexterm"/>application<a id="id302" class="indexterm"/> is closed, where this method will pause the live stream so as to not use the battery resources of the Android device:</p><div class="informalexample"><pre class="programlisting">    public void onPause() {
        super.onPause();
        mv.stopPlayback();
    }</pre></div><p>After this, we will implement <code class="literal">DoRead AsyncTask</code>, which will perform <code class="literal">HttpRequest</code> and communicate with the Arduino Yùn server:</p><div class="informalexample"><pre class="programlisting">    public class DoRead extends AsyncTask&lt;String, Void, MjpegInputStream&gt; {
        protected MjpegInputStream doInBackground(String... url) {
            
            HttpResponse res = null;
            DefaultHttpClient httpclient = new DefaultHttpClient();
            Log.d(TAG, "1. Sending http request");
            try {
                res = httpclient.execute(new HttpGet(URI.create(url[0])));
                Log.d(TAG, "2. Request finished, status = " + res.getStatusLine().getStatusCode());
                if(res.getStatusLine().getStatusCode()==401){
                    //You must turn off camera User Access Control before this will work
                    return null;
                }
                return new MjpegInputStream(res.getEntity().getContent());
            } catch (ClientProtocolException e) {
                e.printStackTrace();
                Log.d(TAG, "Request failed-ClientProtocolException", e);
                //Error connecting to camera
            } catch (IOException e) {
                e.printStackTrace();
                Log.d(TAG, "Request failed-IOException", e);
                //Error connecting to camera
            }

            return null;
        }</pre></div><p>Within the <code class="literal">StreamActivity.Java</code> class, we will implement <code class="literal">onPostExecute()</code>, which as part of the <code class="literal">AsyncTask</code> API will make sure that the video stream player shows up in the Main UI thread:</p><div class="informalexample"><pre class="programlisting">        protected void onPostExecute(MjpegInputStream result) {
            mv.setSource(result);
            mv.setDisplayMode(MjpegView.SIZE_BEST_FIT);
            mv.showFps(true);
        }
    }
}</pre></div><p>We will then<a id="id303" class="indexterm"/> open <code class="literal">MjpegInputStream.java</code>, where we will declare all the necessary code needed to <a id="id304" class="indexterm"/>parse the data that is streamed from the Arduino Yùn to the Android device:</p><div class="informalexample"><pre class="programlisting">public class MjpegInputStream extends DataInputStream {
    private static final String TAG = "MjpegInputStream";

    private final byte[] SOI_MARKER = { (byte) 0xFF, (byte) 0xD8 };
    private final byte[] EOF_MARKER = { (byte) 0xFF, (byte) 0xD9 };
    private final String CONTENT_LENGTH = "Content-Length";
    private final static int HEADER_MAX_LENGTH = 100;
    private final static int FRAME_MAX_LENGTH = 40000 + HEADER_MAX_LENGTH;
    private int mContentLength = -1;

    public MjpegInputStream(InputStream in) {
        super(new BufferedInputStream(in, FRAME_MAX_LENGTH));
    }

    private int getEndOfSeqeunce(DataInputStream in, byte[] sequence) throws IOException {
        int seqIndex = 0;
        byte c;
        for(int i=0; i &lt; FRAME_MAX_LENGTH; i++) {
            c = (byte) in.readUnsignedByte();
            if(c == sequence[seqIndex]) {
                seqIndex++;
                if(seqIndex == sequence.length) {
                    return i + 1;
                }
            } else {
                seqIndex = 0;
            }
        }
        return -1;
    }

    private int getStartOfSequence(DataInputStream in, byte[] sequence) throws IOException {
        int end = getEndOfSeqeunce(in, sequence);
        return (end &lt; 0) ? (-1) : (end - sequence.length);
    }

    private int parseContentLength(byte[] headerBytes) throws IOException, NumberFormatException {
        ByteArrayInputStream headerIn = new ByteArrayInputStream(headerBytes);
        Properties props = new Properties();
        props.load(headerIn);
        return Integer.parseInt(props.getProperty(CONTENT_LENGTH));
    }

    public Bitmap readMjpegFrame() throws IOException {
        mark(FRAME_MAX_LENGTH);
        int headerLen = getStartOfSequence(this, SOI_MARKER);
        reset();
        byte[] header = new byte[headerLen];
        readFully(header);
        try {
            mContentLength = parseContentLength(header);
        } catch (NumberFormatException nfe) {
            nfe.getStackTrace();
            Log.d(TAG, "catch NumberFormatException hit", nfe);
            mContentLength = getEndOfSeqeunce(this, EOF_MARKER);
        }
        reset();
        byte[] frameData = new byte[mContentLength];
        skipBytes(headerLen);
        readFully(frameData);
        return BitmapFactory.decodeStream(new ByteArrayInputStream(frameData));
    }
}</pre></div><p>Last but not least, we will head off to <code class="literal">MjpegView.java</code>, where we will be declaring a number of important methods to consolidate all of our application processes. The <code class="literal">MjpegView.java</code> class<a id="id305" class="indexterm"/> is available at <a class="ulink" href="http://git.io/_Mu_Gw">http://git.io/_Mu_Gw</a>.</p><p>Replace all the code<a id="id306" class="indexterm"/> within your version of the <code class="literal">MjpegView.java</code> class with the one from the online repository and ensure that the package name and other class references match the ones within your project.</p><p>Once you make sure <a id="id307" class="indexterm"/>that all your <code class="literal">import</code> statements are included within each class with the <code class="literal">Auto-Import</code> function, you could go ahead and build the app and test it on your physical device that is connected to the same Wi-Fi Network as your Arduino Yùn.</p><p>The final project should look something as follows:</p><div class="mediaobject"><img src="graphics/0389OS_05_07.jpg" alt="Implementing a fullscreen stream player on Android"/></div></div><div class="section" title="How to go further"><div class="titlepage"><div><div><h2 class="title"><a id="ch05lvl2sec41"/>How to go further</h2></div></div></div><p>An interesting implementation and<a id="id308" class="indexterm"/> further improvement on the basic Android app would be to include the ability to take a snapshot when motion is detected in front of the camera. This can be achieved through the <a id="id309" class="indexterm"/>OpenCV library for Android, which is available at <a class="ulink" href="http://opencv.org/platforms/android.html">http://opencv.org/platforms/android.html</a>.</p><p>Furthermore, the user interface could be improved to include the ability to take a picture of that particular scene. This project could also be combined with the mobile robot project, which we shall talk about later on, to have a live-streaming mobile robot that can be controlled from the same Android application. The use cases for modifying such a setup are endless, starting from remote baby monitors to medical monitoring devices.</p></div></div></div>
<div class="section" title="Summary"><div class="titlepage"><div><div><h1 class="title"><a id="ch05lvl1sec27"/>Summary</h1></div></div></div><p>Let's summarize what we did in this chapter. We learned how to connect a USB camera to the Arduino Yùn, and configure the Arduino board so that it streams video to our local Wi-Fi network. Then we created a new Android application to watch the video stream of the camera on our Android phone or tablet. Therefore, we created a simple Wi-Fi security camera based on Arduino and Android.</p><p>In the next chapter, we will do something different. We will use the gyroscope of the Android phone to control a servomotor connected to an Arduino board. We will be able to control the angle of rotation of the servomotor just by titling the Android phone.</p></div></body></html>