<html><head></head><body><div><div><div><div><h1 class="title"><a id="ch06"/>Chapter 6. Device Capability – Power Unleashed</h1></div></div></div><p>
<em>"Software will give you respect, but hardware will give you the Power."</em>
</p><p>
<em>- Akshat Paul</em>
</p><p>An iPhone is not only used for making calls, surfing the Internet, and playing music, but it is also the most advanced piece of hardware that can be used to take pictures, know your present location, comprehend gestures, and to do so many other things. So why not take advantage of these incredible device capabilities in your application. The beauty of these features is that just by tapping into the tools that the iPhone SDK provides, one can quickly import pictures, locations, and maps with minimal lines of code.</p><p>In this chapter we will focus on the following topics:</p><div><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">Camera</li><li class="listitem" style="list-style-type: disc">Location Manager (GPS)</li><li class="listitem" style="list-style-type: disc">Gestures</li><li class="listitem" style="list-style-type: disc">Core Data</li><li class="listitem" style="list-style-type: disc">Address Book</li></ul></div><div><div><div><div><h1 class="title"><a id="ch06lvl1sec37"/>Camera – smile please!</h1></div></div></div><p>The camera is <a id="id332" class="indexterm"/>probably the most widely used feature of an iOS device. In this section, we will cover the most frequently used Camera events by creating an application that will <a id="id333" class="indexterm"/>allow us to take a picture using the Camera device and to select a picture from the Gallery.</p><p>An iPhone implements image selection through a picker that allows us to get images from different sources, such as Camera Roll or Photo Library. The <code class="literal">UIImagePickerController</code> class<a id="id334" class="indexterm"/> provides basic, customizable user interfaces (UIs) for taking pictures and videos, also providing the user with some simple editing capabilities for newly captured media.</p><p>The role and appearance of a <code class="literal">UIImagePickerController</code> class depends on the value of <code class="literal">sourceType</code> assigned to it. There <a id="id335" class="indexterm"/>are three ways to choose the source of an image, as follows:</p><div><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">Choose from Camera:<div><pre class="programlisting">
<strong>imagePicker.sourceType = UIImagePickerControllerSourceTypeCamera;</strong>
</pre></div></li><li class="listitem" style="list-style-type: disc">Choose from any folder in Gallery:<div><pre class="programlisting">
<strong>imagePicker.sourceType = UIImagePickerControllerSourceTypePhotoLibrary;</strong>
</pre></div></li><li class="listitem" style="list-style-type: disc">Choose from Photo Album (Camera Roll):<div><pre class="programlisting">
<strong>imagePicker.sourceType = UIImagePickerControllerSourceTypeSavedPhotosAlbum;</strong>
</pre></div></li></ul></div><div><div><div><div><h2 class="title"><a id="ch06lvl2sec56"/>Camera example</h2></div></div></div><p>Let's create an application <a id="id336" class="indexterm"/>that will allow us to capture a photo from the camera and select an image from Photo Gallery. Perform the following steps:</p><div><ol class="orderedlist arabic"><li class="listitem">Create an application with the <code class="literal">motion</code> command<a id="id337" class="indexterm"/>:<div><pre class="programlisting">
<strong>motion create CameraExample</strong>
</pre></div></li><li class="listitem">Update <code class="literal">app_delegate.rb</code> and set the root controller to <code class="literal">CameraController</code>:<div><pre class="programlisting">class AppDelegate
  def application(application, didFinishLaunchingWithOptions:launchOptions)
     @window = UIWindow.alloc.initWithFrame(UIScreen.mainScreen.bounds)
     @window.rootViewController = CameraController.alloc.init
     @window.makeKeyAndVisible
     true
  end
end</pre></div></li><li class="listitem">Create a file named <code class="literal">camera_controller.rb</code> inside the <code class="literal">app</code> folder:<div><pre class="programlisting">class CameraController &lt; UIViewController

  def viewDidLoad
    view.backgroundColor = UIColor.underPageBackgroundColor
    load_view
  end

  def load_view
    @camera_button = UIButton.buttonWithType(UIButtonTypeRoundedRect)
    @camera_button.frame  = [[50, 20], [200, 50]]
    @camera_button.setTitle("Click from camera", forState:UIControlStateNormal)
    @camera_button.addTarget(self, action: :start_camera, forControlEvents:UIControlEventTouchUpInside)
    view.addSubview(@camera_button)

    @gallery_button = UIButton.buttonWithType(UIButtonTypeRoundedRect)
    @gallery_button.frame  = [[50, 100], [200, 50]]
    @gallery_button.setTitle("Chose from Gallery", forState:UIControlStateNormal)
    @gallery_button.addTarget(self, action: :open_gallery, forControlEvents:UIControlEventTouchUpInside)
    view.addSubview(@gallery_button)

    @image_picker = UIImagePickerController.alloc.init
    @image_picker.delegate = self 
  end

  def imagePickerController(picker, didFinishPickingImage:image, editingInfo:info)
    self.dismissModalViewControllerAnimated(true)
    @image_view.removeFromSuperview if @image_view
    @image_view = UIImageView.alloc.initWithImage(image)
    @image_view.frame = [[50, 200], [200, 180]]
    view.addSubview(@image_view)
  end

  def start_camera
    if camera_present?
      @image_picker.sourceType = UIImagePickerControllerSourceTypeCamera
      presentModalViewController(@image_picker, animated:true)
    else
      show_alert
    end
  end
  def open_gallery
    @image_picker.sourceType = UIImagePickerControllerSourceTypePhotoLibrary
    presentModalViewController(@image_picker, animated:true)
  end
  def show_alert
    alert = UIAlertView.new  
    alert.message = ‘No Camera in device'
    alert.show
  end
  def camera_present?
    UIImagePickerController.isSourceTypeAvailable(UIImagePickerControllerSourceTypeCamera)
  end
end</pre></div></li></ol></div><p>Let's see what we have <a id="id338" class="indexterm"/>done so far by testing our application on the simulator using the following command:</p><div><pre class="programlisting">
<strong>$rake</strong>
</pre></div><p>We can see the results as shown in the following screenshot:</p><div><img src="img/5220OT_06_01.jpg" alt="Camera example"/></div><p>As we are using an iPhone simulator, we cannot access the camera hardware. However, if we test our<a id="id339" class="indexterm"/> application with an iPhone device, we will be able to use the camera hardware and capture images from it. Now let's choose an image from Gallery by clicking on the <strong>Choose from Gallery</strong> button<a id="id340" class="indexterm"/>:</p><div><img src="img/5220OT_06_02.jpg" alt="Camera example"/></div></div><div><div><div><div><h2 class="title"><a id="ch06lvl2sec57"/>Understanding the Camera code</h2></div></div></div><p>First, we need to initiate two <a id="id341" class="indexterm"/>buttons for the photo-taking process and choose a picture from Gallery. We will also create an image picker:</p><div><pre class="programlisting">  def load_view
    @camera_button = UIButton.buttonWithType(UIButtonTypeRoundedRect)
    @camera_button.frame  = [[50, 20], [200, 50]]
    @camera_button.setTitle("Click from camera", forState:UIControlStateNormal)
    @camera_button.addTarget(self, action: :start_camera, forControlEvents:UIControlEventTouchUpInside)
    view.addSubview(@camera_button)
    @gallery_button = UIButton.buttonWithType(UIButtonTypeRoundedRect)
    @gallery_button.frame  = [[50, 100], [200, 50]]
    @gallery_button.setTitle("Choose from Gallery", forState:UIControlStateNormal)
    @gallery_button.addTarget(self, action: :open_gallery, forControlEvents:UIControlEventTouchUpInside)
    view.addSubview(@gallery_button)

    @image_picker = UIImagePickerController.alloc.init
    @image_picker.delegate = self 
  end</pre></div><p>So when we <a id="id342" class="indexterm"/>click on the <strong>Click from camera</strong> and <strong>Choose from Gallery</strong> buttons, the <code class="literal">start_camera</code> and <code class="literal">open_gallery</code> actions will be called, respectively:</p><div><pre class="programlisting">  def start_camera
    if camera_present?
      @image_picker.sourceType = UIImagePickerControllerSourceTypeCamera
      presentModalViewController(@image_picker, animated:true)
    else
      show_alert
    end
  end

  def open_gallery
    @image_picker.sourceType = UIImagePickerControllerSourceTypePhotoLibrary
    presentModalViewController(@image_picker, animated:true)
  end
  def show_alert
    alert = UIAlertView.new  
    alert.message = ‘No Camera in device'
    alert.show
  end</pre></div><p>So we have used <code class="literal">UIImagePickerControllerSourceTypeCamera</code> and <code class="literal">UIImagePickerControllerSourceTypePhotoLibrary</code> as source types; they will open the Camera and Photo Library tools, respectively.</p><div><div><h3 class="title"><a id="tip27"/>Tip</h3><p>As an iOS application can also be installed on devices such as an iPod, which does not have a camera, to check the device for a camera, the <code class="literal">UIImagePickerController.isSourceTypeAvailable(UIImagePickerControllerSourceTypeCamera)</code> method is used.</p></div></div><p>The following two camera picker delegates are available:</p><div><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><code class="literal">imagePickerController:didFinishPickingImage</code>: This is <a id="id343" class="indexterm"/>called when the image is selected</li><li class="listitem" style="list-style-type: disc"><code class="literal">imagePickerControllerDidCancel</code>: This is called when the <strong>Cancel</strong> button is clicked</li></ul></div><p>The following delegate will be called when an image is selected:</p><div><pre class="programlisting">  def imagePickerController(picker, didFinishPickingImage:image, editingInfo:info)
    self.dismissModalViewControllerAnimated(true)
    @image_view.removeFromSuperview if @image_view
    @image_view = UIImageView.alloc.initWithImage(image)
    @image_view.frame = [[50, 200], [200, 180]]
    view.addSubview(@image_view)
  end</pre></div><p>The <code class="literal">self.dismissModalViewControllerAnimated(true)</code> method<a id="id344" class="indexterm"/> is called explicitly to remove the pop-up, and then the image is displayed using <code class="literal">UIImageView</code>.</p></div></div></div>
<div><div><div><div><h1 class="title"><a id="ch06lvl1sec38"/>Location Manager – directions for apps</h1></div></div></div><p>You must have observed that in many iOS applications, your current location is spotted automatically. With RubyMotion, we can easily use the location capabilities of your device with our application. There are two parts to this: the first is to find the device location and the second is to display it in our application.</p><p>iOS SDK contains various layers; one of them is the<a id="id345" class="indexterm"/> <strong>Core Services</strong> layer and a part of this layer is the <a id="id346" class="indexterm"/>
<strong>Core Location</strong> framework. This framework uses the available hardware to determine a user's current position and where they are heading. Core Location provides us with coordinates, text strings, and number values instead of visual location information such as maps. Later in the chapter, we will also use Map Kit that will help us embed maps directly in our views using our knowledge of the Core Location framework.</p><div><div><div><div><h2 class="title"><a id="ch06lvl2sec58"/>Location Manager example</h2></div></div></div><p>Let's create an application <a id="id347" class="indexterm"/>to demonstrate how we can use Location Manager with the RubyMotion application. Perform the following steps:</p><div><ol class="orderedlist arabic"><li class="listitem">Create an application with the <code class="literal">motion</code> command:<div><pre class="programlisting">
<strong>$motion create LocationManager  </strong>
</pre></div></li><li class="listitem">Update the <code class="literal">app_delegate.rb</code> file:<div><pre class="programlisting">class AppDelegate
  def application(application, didFinishLaunchingWithOptions:launchOptions)
     @window = UIWindow.alloc.initWithFrame(UIScreen.mainScreen.bounds)
     @window.rootViewController = LocationController.alloc.init
     @window.makeKeyAndVisible
    true
  end
end</pre></div></li><li class="listitem">Update the <code class="literal">rake</code> file and add the following line of code:<div><pre class="programlisting">app.frameworks = [‘CoreLocation', ‘MapKit']</pre></div></li><li class="listitem">To use the Location service, we have to include the following two frameworks:<div><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><code class="literal">CoreLocation</code>: The <code class="literal">CoreLocation</code> framework lets you determine the current location. This framework uses the available hardware of the device to determine the device's current position and where it is heading.</li><li class="listitem" style="list-style-type: disc"><code class="literal">MapKit</code>: The <code class="literal">MapKit</code> framework provides an interface for embedding maps directly into your app's views.</li></ul></div></li><li class="listitem">Create the <code class="literal">location_controller.rb</code> controller<a id="id348" class="indexterm"/> in the <code class="literal">app</code> folder and add the following code:<div><pre class="programlisting">class LocationController &lt; UIViewController
  def viewDidLoad
    view.backgroundColor = UIColor.underPageBackgroundColor
    create_location_label
    check_location

  end 
  
  def check_location
    if (CLLocationManager.locationServicesEnabled)
     @location_manager = CLLocationManager.alloc.init
     @location_manager.desiredAccuracy = KCLLocationAccuracyKilometer
     @location_manager.delegate = self
     @location_manager.purpose = " Our applications functionality 
is based on your current location "
     @location_manager.startUpdatingLocation
    else
      show_error_message(‘Please enable the Location Services for this app in Settings.')
    end
  end
  def create_location_label
  @latitudeLabel =  UILabel.alloc.initWithFrame( [[25, 30], [250, 40]] )
  @latitudeLabel.backgroundColor = UIColor.clearColor
  
  @longitudeLabel =  UILabel.alloc.initWithFrame( [[25, 80], [250, 40]] )
  @longitudeLabel.backgroundColor = UIColor.clearColor
   
   @latitudeLabel.text = "Latitude:"
   @longitudeLabel.text = "Longitude:"
   view.addSubview(@latitudeLabel)
   view.addSubview(@longitudeLabel)
  end
  def locationManager(manager, didUpdateToLocation:newLocation, fromLocation:oldLocation)
   @latitudeLabel.text =  @latitudeLabel.text + newLocation.coordinate.latitude.to_s
   @longitudeLabel.text =  @longitudeLabel.text + newLocation.coordinate.longitude.to_s
  end

  def locationManager(manager, didFailWithError:error)

     show_error_message(‘Please enable the Location Services for this app in Settings.')
  end
  def show_error_message msg
    alert = UIAlertView.new
    alert.message =  msg
    alert.show
  end
  
end</pre></div></li></ol></div><p>In the preceding code, we configured the <code class="literal">CLLocationManager</code> object using the following steps:</p><div><ol class="orderedlist arabic"><li class="listitem">Always check<a id="id349" class="indexterm"/> to see whether the desired services are available before starting any service and abandon the operation if they are not. You can do so by triggering <code class="literal">CLLocationManager.locationServicesEnable</code>. If this returns <code class="literal">true</code>, the service has been enabled for your application.<div><div><h3 class="title"><a id="note32"/>Note</h3><p>The user has the option of denying applications the ability to access its Location service data. During the initial use by an application, the Core Location framework prompts the user to confirm that using the Location service is acceptable. If the user denies the request, the <code class="literal">CLLocationManager</code> object reports an appropriate error to the delegate in future requests.</p></div></div></li><li class="listitem">Then we created an instance of the <code class="literal">CLLocationManager</code> class:<div><pre class="programlisting">
<strong>@location_manager = CLLocationManager.alloc.init</strong>
</pre></div></li><li class="listitem">Next, we configured additional properties relevant to the Location service:<div><pre class="programlisting">
<strong>     @location_manager.desiredAccuracy = KCLLocationAccuracyKilometer</strong>
</pre></div><p>
<code class="literal">desiredAccuracy</code> supports a wide range of methods that provide different levels of accuracy. You can also use <code class="literal">KCLLocationAccuracyBest</code>; it will give you more accurate results but it will also drain the battery. <code class="literal">KCLLocationAccuracyKilometer</code> doesn't give an accurate location but is more effective in terms of performance.</p><div><pre class="programlisting">
<strong>       @location_manager.delegate = self</strong>
<strong>@location_manager.purpose = "Our application provides functionality based on your current location"</strong>
</pre></div><p>This message will appear when the application asks for permissions.</p></li><li class="listitem">Then we created a delegate to handle the latitude and longitude for our application:<div><pre class="programlisting">def locationManager(manager, didUpdateToLocation:newLocation, fromLocation:oldLocation)
   @latitudeLabel.text =  @latitudeLabel.text + newLocation.coordinate.latitude.to_s
   @longitudeLabel.text =  @longitudeLabel.text + newLocation.coordinate.longitude.to_s
  end</pre></div></li><li class="listitem">Lastly, we called the appropriate start method to begin the delivery of events:<div><pre class="programlisting">
<strong>@location_manager.startUpdatingLocation</strong>
</pre></div></li></ol></div><p>Let's fire up the<a id="id350" class="indexterm"/> terminal and test our app using the following command:</p><div><pre class="programlisting">
<strong>$rake</strong>
</pre></div><p>The output is as follows:</p><div><img src="img/5220OT_06_03.jpg" alt="Location Manager example"/></div><p>If your location is not set in your simulator, you will get a pop-up showing an error, as shown in the preceding screenshot.</p><p>As we are using the iOS<a id="id351" class="indexterm"/> simulator, we do not have physical GPS access for the iPhone device. However, iOS simulator does give us the option to mimic this by selecting or adding values via the emulator. From the toolbar, navigate to <strong>Debug</strong> | <strong>Location</strong> and either choose or add custom longitude and latitude values.</p><div><img src="img/5220OT_06_04.jpg" alt="Location Manager example"/></div><p>You can see a pop-up on the screen with a custom message, which we had described in our code:</p><div><img src="img/5220OT_06_05.jpg" alt="Location Manager example"/></div><p>Once we click on <strong>OK</strong>, we will see the longitude and latitude of our current location as shown in the following screenshot:</p><div><img src="img/5220OT_06_06.jpg" alt="Location Manager example"/></div><p>Now let's plot the <a id="id352" class="indexterm"/>current location on a map and display this on our screen.</p><div><ol class="orderedlist arabic"><li class="listitem">Add the following code to the <code class="literal">location_controller.rb</code> file in the <code class="literal">app</code> folder:<div><pre class="programlisting">  def show_map
     map= MKMapView.alloc.initWithFrame( [[20,190], [275, 150]] )
     map.mapType = MKMapTypeStandard
     self.view.addSubview(map)
  end</pre></div><p>We have chosen <code class="literal">MKMapTypeStandard</code>, but <code class="literal">MKMapView</code> provides the following three types of maps:</p><div><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><code class="literal">MKMapTypeStandard</code>: This shows a street and some road names</li><li class="listitem" style="list-style-type: disc"><code class="literal">MKMapTypeSatellite</code>: This shows satellite imagery</li><li class="listitem" style="list-style-type: disc"><code class="literal">MKMapTypeHybrid</code>: This shows a satellite image of the area with roads and their names along with other information superimposed</li></ul></div></li><li class="listitem">Then, add the<a id="id353" class="indexterm"/> following code in the <code class="literal">viewDidLoad</code> method<a id="id354" class="indexterm"/> in the <code class="literal">location_controller.rb</code> file:<div><pre class="programlisting">  def viewDidLoad
    view.backgroundColor = UIColor.underPageBackgroundColor
    location_label
    check_location
    <strong>show_map</strong>
  end</pre></div></li><li class="listitem">Now run the application in the simulator using the following command:<div><pre class="programlisting">
<strong>$rake</strong>
</pre></div><p>The output is as follows:</p><div><img src="img/5220OT_06_07.jpg" alt="Location Manager example"/></div><p>The preceding <a id="id355" class="indexterm"/>code will only show a map on the screen and not pinpoint the location. We are now going to add a pin—annotations in MapKit terms—to our map.</p></li><li class="listitem">Update the <code class="literal">show_map</code> method<a id="id356" class="indexterm"/> in the <code class="literal">location_controller.rb</code> file:<div><pre class="programlisting">  def show_map
     map= MKMapView.alloc.initWithFrame( [[20,190], [275, 150]] )
     map.mapType = MKMapTypeStandard
<strong>     location = CLLocationCoordinate2D.new(@latitude, @longitude) </strong>
<strong>     map.setRegion( MKCoordinateRegionMake(location, MKCoordinateSpanMake(1, 1)),animated:true )</strong>
<strong>     pointer = MyAnnotation.alloc.initWithCoordinate(location, title:"Title", andSubTitle:"Sub Title")</strong>
<strong>     map.addAnnotation(pointer)</strong>
     self.view.addSubview(map)
  end</pre></div><p>
<code class="literal">CLLocationCoordinate2D</code> is a structure that contains the geographical coordinate of a location.</p></li><li class="listitem">To add the pin (Annotation), you must create a class that explicitly implements the <code class="literal">MKAnnotation</code> protocol. We should define the following attributes in this class:<div><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><code class="literal">coordinate</code></li><li class="listitem" style="list-style-type: disc"><code class="literal">title</code></li><li class="listitem" style="list-style-type: disc"><code class="literal">subtitle</code></li></ul></div></li><li class="listitem">Let's create a file <a id="id357" class="indexterm"/>named <code class="literal">my_annotation.rb</code> inside the <code class="literal">app</code> folder. Create a class named <code class="literal">MyAnnotation</code> that has these attributes:<div><pre class="programlisting">class MyAnnotation 
  def initWithCoordinate(coordinate, title:title, andSubTitle:subtitle)
    @coordinate = coordinate
    @title = title
    @subtitle = subtitle
    self
  end

  def coordinate
    @coordinate
  end
  def title
    @title
  end
  def subtitle
    @subtitle
  end
end</pre></div></li><li class="listitem">Update the <code class="literal">location_controller.rb</code> file with the following code:<div><pre class="programlisting">  def locationManager(manager, didUpdateToLocation:newLocation, fromLocation:oldLocation)
<strong>    @latitude = newLocation.coordinate.latitude</strong>
<strong>    @longitude = newLocation.coordinate.longitude</strong>
    @latitudeLabel.text =  @latitudeLabel.text + newLocation.coordinate.latitude.to_s
    @longitudeLabel.text =  @longitudeLabel.text + newLocation.coordinate.longitude.to_s
<strong>    @location_manager.stopUpdatingLocation</strong>
<strong>    show_map</strong>
  end</pre></div></li><li class="listitem">Let's fire up the<a id="id358" class="indexterm"/> terminal and run our application using the following command:<div><pre class="programlisting">
<strong>$rake</strong>
</pre></div><p>The output is as follows:</p><div><img src="img/5220OT_06_08.jpg" alt="Location Manager example"/></div></li></ol></div><p>In the preceding screenshot, we can see a map with the current location and its description.</p><div><div><h3 class="title"><a id="tip28"/>Tip</h3><p>You can change the location in the simulator by navigating to <strong>Debug</strong> | <strong>Change Location</strong><a id="id359" class="indexterm"/>.</p></div></div></div></div>
<div><div><div><div><h1 class="title"><a id="ch06lvl1sec39"/>Gestures – non-verbal communication</h1></div></div></div><p>Gestures are a big part of iOS applications. For example, when we pinch on a picture, it gets zoomed, or when we rotate<a id="id360" class="indexterm"/> our device, the orientation of the picture changes. Detecting gestures in your application is very easy with the built-in <code class="literal">UIGestureRecognizer</code> classes.</p><p>There are a few subclasses of <code class="literal">UIGestureRecognizer</code>, each designed to detect a specific type of gesture. You can <a id="id361" class="indexterm"/>handle the most commonly used gestures with the following subclasses:</p><div><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><code class="literal">UITapGestureRecognizer</code>: This <a id="id362" class="indexterm"/>class detects the tapping gesture<a id="id363" class="indexterm"/> made on the device screen by the user.<a id="id364" class="indexterm"/></li><li class="listitem" style="list-style-type: disc"><code class="literal">UIPinchGestureRecognizer</code>: This class<a id="id365" class="indexterm"/> detects the pinching gesture made on screen by the user. This motion is usually used to <a id="id366" class="indexterm"/>zoom in or out of a view or to change the size of a visual component.</li><li class="listitem" style="list-style-type: disc"><code class="literal">UIPanGestureRecognizer</code>: This <a id="id367" class="indexterm"/>class detects the <a id="id368" class="indexterm"/>dragging or panning gesture that the user makes.</li><li class="listitem" style="list-style-type: disc"><code class="literal">UISwipeGestureRecognizer</code>: This<a id="id369" class="indexterm"/> class detects when the user makes a swiping gesture across the screen. <a id="id370" class="indexterm"/>Instances of this class may be configured to detect motion only in a specific direction.</li><li class="listitem" style="list-style-type: disc"><code class="literal">UIRotationGestureRecognizer</code>: This class identifies <a id="id371" class="indexterm"/>the rotation gesture that the user makes. (To make a<a id="id372" class="indexterm"/> rotation gesture, move two fingers located opposite each other in contact with the screen and move them in a circular motion.)</li><li class="listitem" style="list-style-type: disc"><code class="literal">UILongPressGestureRecognizer</code>: This class<a id="id373" class="indexterm"/> is used to identify when the user touches the screen with one or more fingers<a id="id374" class="indexterm"/> for a specified period of time.</li></ul></div><div><div><div><div><h2 class="title"><a id="ch06lvl2sec59"/>Gesture example</h2></div></div></div><p>The following is an example <a id="id375" class="indexterm"/>of how the gesture feature can be used:</p><div><ol class="orderedlist arabic"><li class="listitem">Create an application that will help us understand the various gestures we have discussed in the last section:<div><pre class="programlisting">
<strong>$motion create gesture</strong>
</pre></div></li><li class="listitem">Update the <code class="literal">app_delegate.rb</code> file in the <code class="literal">app</code> folder:<div><pre class="programlisting">class AppDelegate
  def application(application, didFinishLaunchingWithOptions:launchOptions)
  
       @window = UIWindow.alloc.initWithFrame(UIScreen.mainScreen.bounds)
       @window.rootViewController = UINavigationController.alloc.initWithRootViewController(GestureController.new)
       @window.makeKeyAndVisible 
    true
  end
end</pre></div></li><li class="listitem">Now, create a file named <code class="literal">gesture_controller.rb</code> in the <code class="literal">app</code> folder and add the following code:<div><pre class="programlisting">class GestureController &lt;  UIViewController
  def viewDidLoad
    view.backgroundColor = UIColor.whiteColor

    longPressRecognizer = UILongPressGestureRecognizer.alloc.initWithTarget(self, action:'longPressGestureRecognizer:')
    tap_gesture_recognizer = UITapGestureRecognizer.alloc.initWithTarget(self,action:'tabGestureRecognizer:')
    rotate_gesture_recognizer = UIRotationGestureRecognizer.alloc.initWithTarget(self, action:'rotationGestureRecognizer:')
    swipe_gesture_recognizer = UISwipeGestureRecognizer.alloc.initWithTarget(self, action:'swipeGestureRecognizer:')
    pan_gesture_recognizer = UIPanGestureRecognizer.alloc.initWithTarget(self, action:'panGestureRecognizer:')
    pinch_gesture_recognizer = UIPinchGestureRecognizer.alloc.initWithTarget(self, action:'pinchGestureRecognizer:')

    self.view.addGestureRecognizer(longPressRecognizer)
    self.view.addGestureRecognizer(tap_gesture_recognizer)
    self.view.addGestureRecognizer(rotate_gesture_recognizer) 
    self.view.addGestureRecognizer(swipe_gesture_recognizer)
    self.view.addGestureRecognizer(pan_gesture_recognizer)
    self.view.addGestureRecognizer(pinch_gesture_recognizer)
    load_labels
  end
    def longPressGestureRecognizer(longPressRecognizer)  
    show_alert("You've pressed the screen long enough!") if UIGestureRecognizerStateEnded == longPressRecognizer.state
  end
  def tabGestureRecognizer(tap_gesture_recognizer)
    show_alert("You've tapped the screen!")
  end
  def rotationGestureRecognizer(rotate_gesture_recognizer)
    show_alert("You've rotated the screen!") if UIGestureRecognizerStateEnded == rotate_gesture_recognizer.state
  end
  def swipeGestureRecognizer(swipe_gesture_recognizer)
    show_alert("You've just swiped!") if UIGestureRecognizerStateEnded == swipe_gesture_recognizer.state
  end
  def panGestureRecognizer(pan_gesture_recognizer)
    show_alert("You've Panned!") if UIGestureRecognizerStateEnded == pan_gesture_recognizer.state
  end
  def pinchGestureRecognizer(pinch_gesture_recognizer)
    show_alert("You've Pinched!") if UIGestureRecognizerStateEnded == pinch_gesture_recognizer.state
  end

  def load_labels
    label = UILabel.new
    label.frame = [[10,50],[300,100]]
    label.lineBreakMode = UILineBreakModeWordWrap;
    label.numberOfLines = 0
    label.text = " Try a different gesture such as tap, rotate, swipe, pan and pinch "
    view.addSubview(label) 
  end
  def show_alert(message)
    alert_box = UIAlertView.alloc.initWithTitle("Gesture Action",
    message:message,
    delegate: nil,
    cancelButtonTitle: "ok",
    otherButtonTitles:nil)

    alert_box.show
  end
end</pre></div></li><li class="listitem">Run the application<a id="id376" class="indexterm"/> using the following command:<div><pre class="programlisting">
<strong>$rake</strong>
</pre></div><p>The output is as follows:</p><div><img src="img/5220OT_06_09.jpg" alt="Gesture example"/></div><div><div><h3 class="title"><a id="tip29"/>Tip</h3><p>You must be wondering how we can use multi-touch on a simulator. To use this feature on a<a id="id377" class="indexterm"/> simulator, hold the <em>Option</em> key<a id="id378" class="indexterm"/>; doing this will display two circles on the simulator screen. You can move them in the desired direction.</p></div></div><div><img src="img/5220OT_06_10.jpg" alt="Gesture example"/></div></li></ol></div><p>Now let's understand the code. First, we created a different recognizer for each class:</p><div><pre class="programlisting">    longPressRecognizer = UILongPressGestureRecognizer.alloc.initWithTarget(self, action:'longPressGestureRecognizer:')
    tap_gesture_recognizer = UITapGestureRecognizer.alloc.initWithTarget(self,action:'tabGestureRecognizer:')
    rotate_gesture_recognizer = UIRotationGestureRecognizer.alloc.initWithTarget(self, action:'rotationGestureRecognizer:')
    swipe_gesture_recognizer = UISwipeGestureRecognizer.alloc.initWithTarget(self, action:'swipeGestureRecognizer:')
    pan_gesture_recognizer = UIPanGestureRecognizer.alloc.initWithTarget(self, action:'panGestureRecognizer:')
    pinch_gesture_recognizer = UIPinchGestureRecognizer.alloc.initWithTarget(self, action:'pinchGestureRecognizer:')</pre></div><p>For each <a id="id379" class="indexterm"/>recognizer, we'll call an action. This means that whenever the user creates a pattern or makes a gesture, such as a rotation, its corresponding action is called. For example, when a user tries to pinch the view, <code class="literal">pinchGestureRecognizer</code> gets called.</p><p>Remember that after we have created the recognizers, we need to add them to the view so that users can interact with them. We did this by adding them to the <code class="literal">addGestureRecognizer()</code> method<a id="id380" class="indexterm"/> by passing the recognizer object to the view:</p><div><pre class="programlisting">    self.view.addGestureRecognizer(longPressRecognizer)
    self.view.addGestureRecognizer(tap_gesture_recognizer)
    self.view.addGestureRecognizer(rotate_gesture_recognizer)
    self.view.addGestureRecognizer(swipe_gesture_recognizer)
    self.view.addGestureRecognizer(pan_gesture_recognizer)
    self.view.addGestureRecognizer(pinch_gesture_recognizer)</pre></div><p>Next,<a id="id381" class="indexterm"/> we created actions for each gesture. We are just showing a pop-up when the user shows any of the common gestures. For example, when we pinch, the following code is called:</p><div><pre class="programlisting">def pinchGestureRecognizer(pinch_gesture_recognizer)
    show_alert("You have Pinch") if UIGestureRecognizerStateEnded == pinch_gesture_recognizer.state
  end</pre></div><p>This action is called in several states, such as when pinching starts and when pinching stops. For discrete gestures, such as a tapping gesture, the gesture recognizer invokes the method once per recognition; for continuous gestures, the gesture recognizer invokes the method at repeated intervals until the gesture ends (that is, until the last finger is lifted from the gesture recognizer's view). So, there can be many states that you can find by <code class="literal">UIGestureRecognizerState</code>. Its value can be one of the following:</p><div><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><code class="literal">UIGestureRecognizerStatePossible</code></li><li class="listitem" style="list-style-type: disc"><code class="literal">UIGestureRecognizerStateBegan</code></li><li class="listitem" style="list-style-type: disc"><code class="literal">UIGestureRecognizerStateChanged</code></li><li class="listitem" style="list-style-type: disc"><code class="literal">UIGestureRecognizerStateEnded</code></li><li class="listitem" style="list-style-type: disc"><code class="literal">UIGestureRecognizerStateCancelled</code></li><li class="listitem" style="list-style-type: disc"><code class="literal">UIGestureRecognizerStateFailed</code></li><li class="listitem" style="list-style-type: disc"><code class="literal">UIGestureRecognizerStateRecognized</code> = <code class="literal">UIGestureRecognizerStateEnded</code><div><img src="img/5220OT_06_11.jpg" alt="Gesture example"/></div></li></ul></div><p>As shown in the preceding figure, when a gesture is recognized, every subsequent state transition <a id="id382" class="indexterm"/>causes an action message to be sent to the target. When a gesture recognizer reaches the <strong>Recognized</strong> or <strong>Ended</strong> state, it is asked to reset its internal state in preparation for a new attempt at recognizing the gesture.</p><div><div><h3 class="title"><a id="tip30"/>Tip</h3><p>Responses to the gestures should be in line with what the users expect. For example, a pinching gesture should scale a view, zooming it in and out; it should not be interpreted as, say, a selection request, for which a tap is more appropriate.</p></div></div></div><div><div><div><div><h2 class="title"><a id="ch06lvl2sec60"/>Do it yourself</h2></div></div></div><p>You can implement your own custom<a id="id383" class="indexterm"/> gesture recognizer. To implement this, first create a subclass of <code class="literal">UIGestureRecognizer</code>. Then you can override the following methods:</p><div><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><code class="literal">reset</code></li><li class="listitem" style="list-style-type: disc"><code class="literal">touchesBegan</code></li><li class="listitem" style="list-style-type: disc"><code class="literal">touchesMoved</code></li><li class="listitem" style="list-style-type: disc"><code class="literal">touchesEnded</code></li><li class="listitem" style="list-style-type: disc"><code class="literal">touchesCancelled</code></li></ul></div></div></div>
<div><div><div><div><h1 class="title"><a id="ch06lvl1sec40"/>Core Data – manage your data</h1></div></div></div><p>Sometimes applications are required to save and manipulate user data. iOS SDK provides a framework for this <a id="id384" class="indexterm"/>purpose known as Core Data.</p><p>The <strong>Core Data</strong> framework provides comprehensive and automated solutions related to an object's life cycle and its searching and persistence features. It can retrieve and manipulate data purely on an object level without having to worry about the details of storage and retrieval.</p><p>With Core Data, data can be handled using higher-level objects indicating entities and their relationships. Core Data interfaces directly with SQLite, separating the developer from the underlying SQL.</p><p>So does it mean Core Data is a database? No; Core Data is not a database and the best example of this is that Core Data can be used totally in memory without any form of persistence. Then is Core Data similar to an ORM such as Active Record or Hibernate? No; Core Data is an object graph manager with life cycle, searching, and persistence features. With Core Data, an app can define a database schema, create a database file, and create and manage record data.</p><div><div><div><div><h2 class="title"><a id="ch06lvl2sec61"/>Core Data example</h2></div></div></div><p>We will create a simple<a id="id385" class="indexterm"/> employee application that will allow us to add the name and age of an employee. This example is only used to demonstrate how Core Data works:</p><div><ol class="orderedlist arabic"><li class="listitem">Let's create an application using the <code class="literal">motion</code> command<a id="id386" class="indexterm"/>:<div><pre class="programlisting">
<strong>$motion create CoreDataExample</strong>
</pre></div></li><li class="listitem">Add the <code class="literal">CoreData</code> framework in the <code class="literal">rake.rb</code> file:<div><pre class="programlisting">app.frameworks += [‘CoreData']</pre></div></li><li class="listitem">This will be an MVC application, so let's create a model named <code class="literal">employee.rb</code> in the <code class="literal">app</code> folder:<div><pre class="programlisting">class Employee &lt; NSManagedObject
  #Attribute Name, Data Type, Default Value, Is Optional, Is Transient, Is Indexed
  @attributes ||= [
    [‘name', NSStringAttributeType, ‘', false, false, false],
    [‘age', NSInteger32AttributeType, 0, false, false, false]   
  ]
end</pre></div><p>You must have noticed that we have inherited the <code class="literal">Employee</code> class from <code class="literal">NSManagedObject</code>. We have created an array of arrays for attributes in the <code class="literal">employee</code> table with the attributes <code class="literal">name</code> and <code class="literal">age</code>. You must be wondering what other parameters there are in this array. To understand this, we will have to write a few helpers in our application.</p></li><li class="listitem">Let's create<a id="id387" class="indexterm"/> a folder named <code class="literal">helper</code> and add a file named <code class="literal">NSEntityDescription.rb</code> with the following code in it:<div><pre class="programlisting">class NSEntityDescription
  def self.newEntityDescriptionWithName(name, attributes:attributes)
    entity = self.alloc.init
    entity.name = name
    entity.managedObjectClassName = name
    
    attributes = attributes.each.map do |name, type, default, optional, transient, indexed|
      property = NSAttributeDescription.alloc.init
      property.name = name
      property.attributeType = type
      property.defaultValue = default if default != nil
      property.optional = optional
      property.transient = transient
      property.indexed = indexed
      property
    end
    entity.properties = attributes 
    entity
  end 
end</pre></div><p>The attributes that we have created in the employee model are defined through this class. For each attribute, the <code class="literal">NSAttributeDescription</code> class<a id="id388" class="indexterm"/> will be used to define them. The <code class="literal">NSAttributeDescription</code> class is used to describe attributes of an entity <a id="id389" class="indexterm"/>described by an instance of <code class="literal">NSEntityDescription</code>. It is inherited from <code class="literal">NSPropertyDescription</code>, which provides most of the basic behavior. Instances of <code class="literal">NSAttributeDescription</code> are used to describe attributes, as distinct from relationships. We can define many properties for an object of <code class="literal">NSAttributeDescription</code>; for example, we can put a validation on it, we can index the attribute, and much more.</p></li><li class="listitem">Next, create a file named <code class="literal">NSManagedObject.rb</code> in the <code class="literal">app</code> folder and add the following code:<div><pre class="programlisting">  def self.entity
    @entity ||= NSEntityDescription.newEntityDescriptionWithName(name, attributes:@attributes)
  end

  def self.objects
    # Use if you do not want any section in your table view
    @objects ||= NSFetchRequest.fetchObjectsForEntityForName(name, withSortKey:@sortKey, ascending:false, inManagedObjectContext:Store.shared.context)
  end

end

class NSManagedObject
  def self.entity
    @entity ||= NSEntityDescription.newEntityDescriptionWithName(name, attributes:@attributes)
  end
  def self.objects
    # Use if you do not want any section in your table view
    @objects ||= NSFetchRequest.fetchObjectsForEntityForName(name, withSortKey:@sortKey, ascending:false, inManagedObjectContext:Store.shared.context)
  end
end</pre></div><p>An <code class="literal">NSEntityDescription</code> object describes an entity in Core Data. An entity<a id="id390" class="indexterm"/> to a manage object is what a class is to an ID or, to use a database analogy, what tables are to rows. An <code class="literal">NSEntityDescription</code> object may have <code class="literal">NSAttributeDescription</code> and <code class="literal">NSRelationshipDescription</code> objects that represent the properties of the entity in the schema. An entity may also have fetched properties, represented by instances of <code class="literal">NSFetchedPropertyDescription</code>, and the model may have fetched request templates, represented by instances of <code class="literal">NSFetchRequest</code>.</p></li><li class="listitem">Now, add the following code to the <code class="literal">app_delegate.rb</code> file:<div><pre class="programlisting">class AppDelegate
  def application(application, didFinishLaunchingWithOptions:launchOptions)      
      setting_core_data
      true
  end 

  def setting_core_data

    # First we need to create the NSManagedObjectModel with all the entities and their relationships. 
    managed_object_model = NSManagedObjectModel.alloc.init
    managed_object_model.entities = [Employee.entity]
  

    # The next object needed is the NSPersistentStoreCoordinator which will allow Core Data to persist the information.
    persistent_store_coordinator = NSPersistentStoreCoordinator.alloc.initWithManagedObjectModel(managed_object_model)
    
    # Now lets get a URL for where we want Core Data to create the persist file, in this case a SQLite Database File
    persistent_store_file_url = NSURL.fileURLWithPath(File.join(NSHomeDirectory(), 
                                                                ‘Documents', 
                                                                ‘EmployeeStore.sqlite'))


    error_pointer = Pointer.new(:object)

    # Add a new Persistent Store to our Persistent Store Coordinator which means that we are telling the Persistent Store Coordinator where to perform the save of our objects.
    # In this case we are stating that our objects must be stored in a SQLite database in the path we already created previously
   unless persistent_store_coordinator.addPersistentStoreWithType(NSSQLiteStoreType,
configuration: nil,                                                                   URL: persistent_store_file_url,
options: nil,                                                                   error: error_pointer)
      # In case we can't initialize the Persistance Store File
 raise "Cannot initialize Core Data Persistance Store Coordinator: #{error_pointer[0].description}"
    end
    # Finally our most important object, the Managed Object Context, is responsible for creating, destroying, and fetching the objects

    @managed_object_context = NSManagedObjectContext.alloc.init
    @managed_object_context.persistentStoreCoordinator = persistent_store_coordinator
  end
end</pre></div><p>Till now we have done some basic settings that we are required to do before actually using database operations. In this case, we are stating that our objects must be stored in a SQLite database at a location we define in our code with the filename <code class="literal">EmployeeStore.sqlite</code>.</p><p>In the preceding code, we have created an object of <code class="literal">NSManagedObjectModel</code> with all the entities. You can think of this object as a reference of the objects to be used by Core Data. The next object<a id="id391" class="indexterm"/> needed is the <code class="literal">NSPersistentStoreCoordinator</code> object that will allow Core Data to persist the information. It is also responsible for choosing a location to save our objects.</p><p>In the last part of our code, we have used the most important class, which is the <code class="literal">NSManagedObjectContext</code> class<a id="id392" class="indexterm"/>. This class is responsible for creating, destroying, and fetching the objects. An instance of <code class="literal">NSManagedObjectContext</code> represents a single "object space" or scratch pad in an application. Its primary responsibility is to manage a collection of managed objects. These objects form a group of related model objects that represent an internally consistent view of one or more persistent stores. A single managed object instance exists in one and only one context, but multiple copies of an object can exist in different contexts.</p></li><li class="listitem">Let's fire up the terminal and run our application using the following command:<div><pre class="programlisting">
<strong>$rake</strong>
</pre></div><div><img src="img/5220OT_06_12.jpg" alt="Core Data example"/></div></li><li class="listitem">You will see <a id="id393" class="indexterm"/>a blank screen as we have not yet created the controller and view. We will create them in the next section, but before that, let's first update the <code class="literal">app_delegate</code> file to accommodate the controller and view with the following code:<div><pre class="programlisting">  def application(application, didFinishLaunchingWithOptions:launchOptions)   
      setting_core_data
      <strong>employee_view_controller = EmployeeViewController.alloc.init</strong>
<strong>      </strong>
<strong>      # We need to pass the Managed Object Context to the next controller so we can use it later for creating, fetching or deleting objects</strong>
<strong>      employee_view_controller.managed_object_context = @managed_object_context</strong>
<strong>      @window = UIWindow.alloc.initWithFrame(UIScreen.mainScreen.bounds)</strong>
<strong>      @window.rootViewController  = UINavigationController.alloc.initWithRootViewController(employee_view_controller)</strong>
<strong>      @window.makeKeyAndVisible</strong>

      true
  end</pre></div></li></ol></div><div><div><div><div><h3 class="title"><a id="ch06lvl3sec11"/>Creating an employee</h3></div></div></div><p>In the last part of the previous code snippet, we initialized <code class="literal">EmployeeViewController</code>. Next, we will pass the managed <a id="id394" class="indexterm"/>object context to the next controller that will later be used for either creating, fetching, or deleting objects. And in the end, we will create a window and assign <code class="literal">EmployeeViewController</code> as its root controller:</p><div><ol class="orderedlist arabic"><li class="listitem">Create a file named <code class="literal">employee_view_controller.rb</code> in the <code class="literal">app</code> folder with the following code in it:<div><pre class="programlisting">class EmployeeViewController &lt; UIViewController
 attr_accessor :managed_object_context
 def loadView
   # Set up the title for the View Controller
   self.title = ‘Employee'

   # Create a new Table View for showing the Text Fields
   table_view = UITableView.alloc.initWithFrame(UIScreen.mainScreen.bounds,
                                                style:UITableViewStyleGrouped)
   table_view.dataSource = self
   self.view = table_view

   # Create a new Bar Button Item with the Add System Default
   add_new_employee_item= UIBarButtonItem.alloc.initWithBarButtonSystemItem(UIBarButtonSystemItemAdd,
                                                                                 target: self,
                                                                                 action: ‘add_new_employee')
   # Add the Bar Button Item to the Navigation Bar
   self.navigationItem.rightBarButtonItem = add_new_employee_item
 end
 
 def viewWillAppear(animated)
   super
   reload_data
 end</pre></div></li><li class="listitem">Next, let's fetch specific objects using the <code class="literal">NSFetchRequest</code> object. We also need to tell<a id="id395" class="indexterm"/> Core Data which entity we want to retrieve. This can be done using <code class="literal">NSEntityDescription</code>:<div><pre class="programlisting">def reload_data
fetch_request = NSFetchRequest.alloc.init

entity = NSEntityDescription.entityForName(Employee.name, 
                                                       inManagedObjectContext:@managed_object_context)
   fetch_request.setEntity(entity)

   # Sort the Employee by employee name
   fetch_sort = NSSortDescriptor.alloc.initWithKey(‘name',
                                                   ascending: true)
   fetch_request.setSortDescriptors([fetch_sort])

   # Update the fetch employee array and reload the table view
   update_fetched_employee_with_fetch_request(fetch_request)
 end


 def update_fetched_employee_with_fetch_request(fetch_request)

   # Create a new pointer for managing the errors
   error_pointer = Pointer.new(:object)

   # Using the NSManagedObjectContext execute the fetch request
   @fetched_employee = @managed_object_context.executeFetchRequest(fetch_request,
                                                                 error: error_pointer)

   # If the returning array of the fetch request is nil
   # means that a problem has occurred
   unless @fetched_employee
     raise "Error fetching employee: #{error_pointer[0].description}"
   end
   # refresh table view to reload its data
   self.view.reloadData
 end


 # UITableView Data Source
 def tableView(tableView, numberOfRowsInSection: section)
   @fetched_employee.count
 end


 def tableView(tableView, cellForRowAtIndexPath: indexPath)
   cell_identifier = ‘EmployeeCell'
   cell = tableView.dequeueReusableCellWithIdentifier(cell_identifier)
   # If we are not cells to use we need to create one
   if cell == nil
     # Lets create a new UITableViewCell with the identifier
     cell = UITableViewCell.alloc.initWithStyle(UITableViewCellStyleValue1, reuseIdentifier:cell_identifier)
     cell.selectionStyle = UITableViewCellSelectionStyleNone
   end

   employee = @fetched_employee[indexPath.row]
   cell.textLabel.text = employee.name
   cell.detailTextLabel.text = employee.age.to_s
   cell
 end


 def add_new_employee
   add_employee_view_controller = AddEmployeeViewController.alloc.init

   # We need to pass the Managed Object Context to the next controller so we can use it later for creating, fetching or deleting objects
   add_employee_view_controller.managed_object_context = @managed_object_context
   self.navigationController.pushViewController(add_employee_view_controller, 
                                                animated:true)
 end

end</pre></div><p>That's a lot of code; let's try to understand it. First, we created a <code class="literal">tableView</code> to <a id="id396" class="indexterm"/>create a table as it's the best way to represent this type of data. Then, we created a <strong>+</strong> button at the top of the navigation bar with the <code class="literal">add_new_employee</code> action associated with it. When this button is pressed, it calls the <code class="literal">add_new_employee</code> action that, in turn, calls a new view, shows a form, and adds a new employee.</p><p>Then, we created a <code class="literal">reload_data</code> method<a id="id397" class="indexterm"/> that will be called to refresh the view with employee data. It will fetch the employee data using the <code class="literal">NSFetchRequest</code> object. Then, we declared <code class="literal">NSEntityDescription</code> for the <code class="literal">Employee</code> object so we can tell Core Data which entity we want to retrieve. We also sorted the result by name using <code class="literal">NSSortDescriptor</code>.</p><p>In the last part of our example, we created an <code class="literal">update_fetched_employee_with_fetch_request</code> method<a id="id398" class="indexterm"/> that will fetch the employee array and update the table to show all of the data. <code class="literal">NSManagedObjectContext</code> executes the fetch request that we created using the following code:</p><div><pre class="programlisting">@fetched_employee = @managed_object_context.executeFetchRequest(fetch_request,
                                                                 error: error_pointer)</pre></div></li><li class="listitem">Next, we will create the view that will be called when the <strong>+</strong> button is clicked on. Let's create a file<a id="id399" class="indexterm"/> named <code class="literal">add_employee_view_controller.rb</code> and add the following code to it:<div><pre class="programlisting">class AddEmployeeViewController &lt; UIViewController
  attr_accessor :managed_object_context

  def viewDidLoad
    self.view.backgroundColor = UIColor.whiteColor
    self.title = ‘Add Employee'
    save_bar_button_item = UIBarButtonItem.alloc.initWithTitle(‘Save',
    style: UIBarButtonItemStyleDone,
    target: self,
    action: ‘save_employee')
   self.navigationItem.rightBarButtonItem = save_bar_button_item
    load_form
  end

  def save_employee
    # Using Core Data create a new instance of the object employee
    employee = NSEntityDescription.insertNewObjectForEntityForName(Employee.name, 
    inManagedObjectContext: @managed_object_context)
    # Assign the text of the name text field to the employee
    employee.name = @name.text
    employee.age = @age.text.intValue

    # Create a new pointer for managing the errors
    error_pointer = Pointer.new(:object)

    # Lets persist the new Movie object, saving the managed object context that contains it
    unless @managed_object_context.save(error_pointer)
      raise "Error saving a new Director: #{error_pointer[0].description}"
    end

    # Pop the Director View Controller
    self.navigationController.popViewControllerAnimated(true)
  end
  
  def load_form 
    @name = UITextField.alloc.initWithFrame([[50,50],[200,30]])
    @name.borderStyle = UITextBorderStyleRoundedRect
    @name.placeholder = "Name"
    self.view.addSubview(@name)
    @age = UITextField.alloc.initWithFrame([[50,100],[200,30]])
    @age.borderStyle = UITextBorderStyleRoundedRect
    @age.placeholder = "Age"
    self.view.addSubview(@age)
  end
end</pre></div><p>With the preceding code, we created two text fields, one for name and the other for age and we first added a <strong>Save</strong> button on top of the view that will <a id="id400" class="indexterm"/>save the employee details by calling the <code class="literal">save_employee</code> action. In the <code class="literal">save_employee</code> action, we used Core Data to create a new instance of the <code class="literal">employee</code> object in the following way:</p><div><pre class="programlisting">employee = NSEntityDescription.insertNewObjectForEntityForName(Employee.name, 
                                                                inManagedObjectContext: @managed_object_context)</pre></div><p>Then, we assigned the value of the text field to the <code class="literal">employee</code> object and finally saved that object and navigated to <code class="literal">EmployeeViewController</code>.</p></li><li class="listitem">Let's fire up the terminal and run our application using the following command:<div><pre class="programlisting">
<strong>$ rake</strong>
</pre></div><p>The output is as follows:</p><div><img src="img/5220OT_06_13.jpg" alt="Creating an employee"/></div></li><li class="listitem">Now, let's add data to the <strong>Employee</strong> form using the view:<div><img src="img/5220OT_06_14.jpg" alt="Creating an employee"/></div></li></ol></div></div><div><div><div><div><h3 class="title"><a id="ch06lvl3sec12"/>Deleting the employee</h3></div></div></div><p>With the completion of the last section, our Core Data application is capable of adding new employee records. <a id="id401" class="indexterm"/>But there may be instances when we'll need to delete an employee record. In this section, we'll enhance our app to delete employee records. The use case for this feature will be such that when we slide any row, the system will ask for a confirmation. And once we confirm, the record will be deleted:</p><div><ol class="orderedlist arabic"><li class="listitem">Update the <code class="literal">employee_view_controller.rb</code> file with the following code:<div><pre class="programlisting">def tableView(tableView, canEditRowAtIndexPath: indexPath)
   true
 end

def tableView(tableView, commitEditingStyle: editingStyle, forRowAtIndexPath: indexPath)

   employee = @fetched_employee[indexPath.row]
   # Ask the NSManagedObjectContext to delete the object
   @managed_object_context.deleteObject(employee)

   # Create a new pointer for managing the errors
   error_pointer = Pointer.new(:object)

   # Lets persist the deleted employee object, saving the managed object context that contains it
   unless @managed_object_context.save(error_pointer)
     raise "Error deleting an Employee: #{error_pointer[0].description}"
   end   

   # Create a new mutable copy of the fetched_employee array
   mutable_fetched_employee = @fetched_employee.mutableCopy

   # Remove the employee from the array
   mutable_fetched_employee.delete(employee)

   # Assign the modified array to our fetched_employee property
   @fetched_employee = mutable_fetched_employee

   # Tell the table view to delete the row
   tableView.deleteRowsAtIndexPaths([indexPath], 
                                    withRowAnimation:UITableViewRowAnimationFade)
 end</pre></div><p>With the iOS <code class="literal">tableView</code>, we have a direct way of creating or deleting a row. In the preceding code, we first passed the value <code class="literal">true</code> to the <code class="literal">tableView(tableView, canEditRowAtIndexPath: indexPath)</code> delegate. Then in order to perform a delete action, we defined the <code class="literal">tableView(tableView, commitEditingStyle: editingStyle, forRowAtIndexPath: indexPath)</code> delegate.</p></li><li class="listitem">Once we fetch<a id="id402" class="indexterm"/> the row that we want to delete, we use <code class="literal">NSManagedObjectContext</code> to delete that object:<div><pre class="programlisting">   @managed_object_context.deleteObject(employee)</pre></div><div><div><h3 class="title"><a id="tip31"/>Tip</h3><p>Remember that we have to always call <code class="literal">save</code> to persist it to our database.</p></div></div></li><li class="listitem">Let's fire up the terminal and run the application using the following command:<div><pre class="programlisting">
<strong>$rake</strong>
</pre></div><p>The output is as follows:</p><div><img src="img/5220OT_06_15.jpg" alt="Deleting the employee"/></div></li></ol></div><p>As shown in the preceding screenshot, when we slide the row, we get a system prompt to delete the row. <a id="id403" class="indexterm"/> And once we click on <strong>Delete</strong>, the row gets deleted.</p></div></div></div>
<div><div><div><div><h1 class="title"><a id="ch06lvl1sec41"/>Address Book – manage your contacts</h1></div></div></div><p>Address Book for iOS provides a way to store the contact information and other personal information of people in a centralized database that can then be shared between various applications. In this <a id="id404" class="indexterm"/>section, we will perform basic operations related to the Address Book.</p><p>We will perform the following operations in this section:</p><div><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">Access the device's Address Book</li><li class="listitem" style="list-style-type: disc">Choose a desired user</li><li class="listitem" style="list-style-type: disc">Copy data from the Address Book into our application</li></ul></div><p>Perform the following steps to work with an Address Book:</p><div><ol class="orderedlist arabic"><li class="listitem">Let's first create a sample address book application with our favorite <code class="literal">motion</code> command:<div><pre class="programlisting">
<strong>$motion create AddressBook_example</strong>
</pre></div></li><li class="listitem">Next, let's create a controller named <code class="literal">addressbook_controller.rb</code> and replace the following code in <code class="literal">app_delegate.rb</code> so that our delegate points to our address book controller:<div><pre class="programlisting">class AppDelegate
  def application(application, didFinishLaunchingWithOptions:launchOptions)

  @window = UIWindow.alloc.initWithFrame(UIScreen.mainScreen.bounds)
  @window.rootViewController = AddressbookController.alloc.init
  @window.makeKeyAndVisible

  
    true
  end
end</pre></div></li><li class="listitem">Next, in our <code class="literal">addressbook_controller.rb</code> controller, which will initially be empty, we will add a<a id="id405" class="indexterm"/> button and two labels. With the button, we will access our Address Book and thereafter choose the desired contact. In the labels, we will display the data of the user that we had selected from the Address Book. Let's add the following code in our <code class="literal">addressbook_controller</code> controller<a id="id406" class="indexterm"/>:<div><pre class="programlisting">def viewDidLoad
    view.backgroundColor = UIColor.underPageBackgroundColor
    load_button
    load_labels
end

def load_button
        
       @phonebook_button = UIButton.buttonWithType(UIButtonTypeRoundedRect)
       @phonebook_button.frame = [[50, 20], [200, 50]]
       @phonebook_button.setTitle("Click from Contacts", forState:UIControlStateNormal)
	    @phonebook_button.addTarget(self, action: :phonebook_access, forControlEvents:UIControlEventTouchUpInside)
       view.addSubview(@phonebook_button)    
end


def load_labels

       @first_name = UILabel.new
       @first_name.text = ‘First Name'
       @first_name.frame = [[100,100],[150,50]]
     
       @phone_number = UILabel.new
       @phone_number.text = ‘Phone Number'
       @phone_number.frame = [[100,200],[150,50]]

       view.addSubview(@first_name)
       view.addSubview(@phone_number)

end</pre></div></li><li class="listitem">Let's <code class="literal">rake</code> and<a id="id407" class="indexterm"/> see the progress so far:<div><pre class="programlisting">
<strong>$rake</strong>
</pre></div><p>The output is as follows:</p><div><img src="img/5220OT_06_16.jpg" alt="Address Book – manage your contacts"/></div></li><li class="listitem">In the preceding step, we mentioned about a <code class="literal">phonebook_access</code> method<a id="id408" class="indexterm"/>; let's create it. <a id="id409" class="indexterm"/>This method will help us access our device's Address Book. Further, let's add the following code to our <code class="literal">addressbook_controller.rb</code> file:<div><pre class="programlisting">def addressbook_access
    @people_picker = ABPeoplePickerNavigationController.alloc.init
    @people_picker.peoplePickerDelegate = self
     presentModalViewController(@people_picker, animated:true)
end</pre></div></li><li class="listitem">Once again, let's execute the <code class="literal">rake</code> command and see if we are able to access the Address Book by clicking on the <strong>Click for contacts</strong> button<a id="id410" class="indexterm"/>:<div><img src="img/5220OT_06_17.jpg" alt="Address Book – manage your contacts"/></div></li><li class="listitem">With the last step, we are in our Address Book and can see the list of contacts. Next, we need to add a method that will copy the desired contact and navigate back<a id="id411" class="indexterm"/> to our application. This can be done with <code class="literal">peoplePickerNavigationController</code>. Further, we'll add the following code in <code class="literal">addressbook_controller</code>:<div><pre class="programlisting">def peoplePickerNavigationController(peoplePicker, shouldContinueAfterSelectingPerson:person)
   self.displayPerson(person)
   self.dismissModalViewControllerAnimated(true)

end</pre></div></li><li class="listitem">Now we need to display all of the data we have copied from the Address Book. This can be done using the <a id="id412" class="indexterm"/><code class="literal">displayPerson</code> method that will let us use the saved values. Add the following method to <code class="literal">addressbook_controller</code>:<div><pre class="programlisting">def displayPerson(person)
   firstname = ABRecordCopyValue(person, KABPersonFirstNameProperty)
   phoneNumbers = ABRecordCopyValue(person, KABPersonPhoneProperty)
   phone = ABMultiValueCopyValueAtIndex(phoneNumbers, 0)
   @phone_number.text = phone
   @first_name.text = firstname

end</pre></div><div><img src="img/5220OT_06_18.jpg" alt="Address Book – manage your contacts"/></div></li></ol></div><p>Great! But we have missed something. What if a user changes his mind and does not want any contact? We<a id="id413" class="indexterm"/> need to find a way to get back to the original application from the Address Book. This can be done by adding the following three-line method in <code class="literal">addressbook_controller</code>:</p><div><pre class="programlisting">def peoplePickerNavigationControllerDidCancel(peoplePicker)
    self.dismissModalViewControllerAnimated(true)
end</pre></div></div>
<div><div><div><div><h1 class="title"><a id="ch06lvl1sec42"/>Do it yourself</h1></div></div></div><p>So far we have learned a lot; now let's use our acquired knowledge and improvise our restro application by implementing the following changes:</p><div><div><div><div><h2 class="title"><a id="ch06lvl2sec62"/>Task 1 – show nearest restaurant</h2></div></div></div><p>To get data from the server, use the <code class="literal">http://restro.nalwaya.com/restaurants/find_restaurent_distance.json?latitude=#{latitude}&amp;&amp;longitude=#{longitude}</code> API.</p><p>You have to pass the<a id="id414" class="indexterm"/> latitude and longitude with this request, and in return, you will get a list of restaurants in the JSON format. Use this as input and create a view displaying the results.</p></div><div><div><div><div><h2 class="title"><a id="ch06lvl2sec63"/>Task 2 – mark each restaurant on a map with a pin</h2></div></div></div><p>Use the <code class="literal">http://restro.nalwaya.com/restaurants/search.json?city={city_name}</code> API that will give you a list of restaurants with their latitude and longitude in the JSON format. Use these coordinates to show their location on the map.</p><p>Once you are done with this exercise, compare your solution with the one available in the chapter code available with this book.</p></div></div>
<div><div><div><div><h1 class="title"><a id="ch06lvl1sec43"/>Summary</h1></div></div></div><p>The following is what we have learned in this chapter:</p><div><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">How to access Camera</li><li class="listitem" style="list-style-type: disc">How to use Core Location</li><li class="listitem" style="list-style-type: disc">How to use different device gestures</li><li class="listitem" style="list-style-type: disc">How to store data on a phone using Core Data</li><li class="listitem" style="list-style-type: disc">How to access the Address Book</li></ul></div><p>Now that we are acclimatized with the basics of RubyMotion, in the next chapter we will dig deep into the advanced features of iOS SDK with RubyMotion. iOS SDK is very powerful and has vast functionalities. In the next chapter, we will discuss how to use <code class="literal">.storyboard</code>, <code class="literal">.xib</code>, and <code class="literal">WebView</code> in detail, to create a truly interactive application.</p></div></body></html>