- en: Chapter 3. Payment Authorization Workflow
  id: totrans-0
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 第3章。支付授权工作流程
- en: The *payment sheet* is the most important user-facing aspect of the Apple Pay
    experience. Also, this is where the user should spend the least amount of time.
    Your app convinced the user to purchase the product. The payment sheet is where
    you will take the user from *desire* to *acquire* in as few taps as possible,
    two taps being the ideal.
  id: totrans-1
  prefs: []
  type: TYPE_NORMAL
  zh: '*支付表单*是Apple Pay体验中最重要的面向用户的部分。此外，这也是用户应该花费最少时间的地方。你的应用说服用户购买产品。支付表单是你将用户从*欲望*引导到*获取*的地方，尽可能减少点击次数，两个点击是最理想的。'
- en: In the previous chapter, you learned how to present information in the payment
    sheet, including a list of the shipping methods you can make available to your
    customers, and the total price of the order. With the payment sheet up, the user
    can change the shipping type (from delivery to store pickup, for example), the
    shipping address, and the payment method (the payment card that will be used to
    fund the transaction). For each change the user makes, you must update the payment
    request's summary items to reflect it. For example, when the user changes the
    shipping method, you must update the summary item that displays the price for
    shipping the item using the newly selected shipping method.
  id: totrans-2
  prefs: []
  type: TYPE_NORMAL
  zh: 在上一章中，你学习了如何在支付表单中展示信息，包括你可以提供给客户的发货方式列表以及订单的总价。当支付表单打开时，用户可以更改发货类型（例如，从送货到门店自提），发货地址和支付方式（将用于资助交易的支付卡）。对于用户所做的每个更改，你必须更新支付请求的摘要项以反映它。例如，当用户更改发货方式时，你必须更新显示使用新选定的发货方式发送商品价格的摘要项。
- en: This chapter shows how to respond to messages from the payment sheet to update
    the appropriate information on the payment request. It also shows how to start
    the payment processing workflow in response to the user authorizing the app to
    submit the payment request for approval by the selected card's issuing bank.
  id: totrans-3
  prefs: []
  type: TYPE_NORMAL
  zh: 本章将展示如何响应支付表单的消息来更新支付请求上的适当信息。它还展示了如何响应用户授权应用提交支付请求以供所选卡的发行银行审批而启动支付处理工作流程。
- en: 'This chapter will do the following:'
  id: totrans-4
  prefs: []
  type: TYPE_NORMAL
  zh: 本章将完成以下工作：
- en: Describe the payment authorization workflow
  id: totrans-5
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 描述支付授权工作流程
- en: Demonstrate the implementation of the methods (declared by the payment sheet
    delegate protocol) that respond to payment sheet messages to update appropriate
    information in the payment request
  id: totrans-6
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 展示实现方法（由支付表单代理协议声明）的示例，这些方法响应支付表单消息以更新支付请求中的适当信息
- en: Show you how to dismiss the payment sheet when the user authorizes the payment
    request or cancels the transaction by tapping the cancel button
  id: totrans-7
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 展示如何在用户授权支付请求或通过点击取消按钮取消交易时关闭支付表单
- en: Actors and operations in the authorization workflow
  id: totrans-8
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 授权工作流程中的参与者和操作
- en: The *payment authorization workflow* is a process by which the user confirms
    or enters the shipping information you provide or request in the payment sheet
    and authorizes the app to submit the payment request for approval by the issuing
    bank of the payment card specified in the payment request. The user may also change
    the payment card to use to fund the payment request, in which case you might need
    to update the payment request's summary items (by adding surcharges for specific
    cards, for example).
  id: totrans-9
  prefs: []
  type: TYPE_NORMAL
  zh: '*支付授权工作流程*是一个用户确认或输入你在支付表单中提供或请求的发货信息，并授权应用提交支付请求以供支付请求中指定的支付卡发行银行审批的过程。用户还可以更改用于资助支付请求的支付卡，在这种情况下，你可能需要更新支付请求的摘要项（例如，为特定卡片添加附加费）。'
- en: The payment authorization workflow starts when your app presents the payment
    sheet (a `PKPaymentAuthorizationViewController` object) and ends with the user
    authorizing the payment request. (The user may cancel the transaction by tapping
    the **Cancel** button on the payment sheet.)
  id: totrans-10
  prefs: []
  type: TYPE_NORMAL
  zh: 支付授权工作流程从你的应用展示支付表单（一个`PKPaymentAuthorizationViewController`对象）开始，并在用户授权支付请求时结束。（用户可以通过在支付表单上点击**取消**按钮来取消交易。）
- en: 'This diagram depicts the actors and operations that are part of the payment
    authorization workflow:'
  id: totrans-11
  prefs: []
  type: TYPE_NORMAL
  zh: 本图展示了支付授权工作流程中的参与者和操作：
- en: '![Actors and operations in the authorization workflow](img/B05093_03_01.png.jpg)'
  id: totrans-12
  prefs: []
  type: TYPE_IMG
  zh: '![授权工作流程中的参与者和操作](img/B05093_03_01.png.jpg)'
- en: 'The workflow comprises four steps, as follows:'
  id: totrans-13
  prefs: []
  type: TYPE_NORMAL
  zh: 工作流程包括以下四个步骤：
- en: The app presents the payment sheet.
  id: totrans-14
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 应用展示支付表单。
- en: The user enters or changes the information you present or require (the less
    the information shown on the payment sheet, the faster the authorization).
  id: totrans-15
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 用户输入或更改您展示或要求的信息（付款单上显示的信息越少，授权越快）。
- en: The app responds to changes in the payment sheet by updating payment summary
    items.
  id: totrans-16
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 应用通过更新支付摘要项来响应付款单的变化。
- en: The user approves the payment request.
  id: totrans-17
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 用户批准支付请求。
- en: 'These are the operations in more detail:'
  id: totrans-18
  prefs: []
  type: TYPE_NORMAL
  zh: 这些是更详细的操作：
- en: '**payment request** (`PKPaymentRequest`): This is the payment request you use
    to present the payment sheet.'
  id: totrans-19
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '**支付请求** (`PKPaymentRequest`): 这是您用来展示付款单的支付请求。'
- en: '**shipping type** (`PKShippingType`): This indicates how the customer will
    get the product being purchased. The available shipping types are delivery (for
    instance, for office supplies or pizza), store pickup (such as for Apple Watches
    or jewelry), and service pickup (for example, when you provide transportation
    or delivery services that offer home pickup). With the store pickup shipping type,
    you must manage the shipping addresses as they are not shipping addresses but
    pickup addresses, such as your store''s address. For example, in this case, you
    can set the *shipping* address to your store''s address or hide the shipping address
    by setting the `requiredShippingAddressFields` property of the payment request
    to `PKAddressFieldNone`.'
  id: totrans-20
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '**配送类型** (`PKShippingType`): 这表示客户将如何获得购买的产品。可用的配送类型包括送货（例如，办公用品或披萨）、门店自提（例如，苹果手表或珠宝）和服务自提（例如，当您提供提供家庭取货的运输或配送服务时）。使用门店自提配送类型时，您必须管理配送地址，因为它们不是配送地址，而是取货地址，例如您的门店地址。例如，在这种情况下，您可以设置*配送*地址为您的门店地址或通过将支付请求的
    `requiredShippingAddressFields` 属性设置为 `PKAddressFieldNone` 来隐藏配送地址。'
- en: '**payment summary items** and **shipping method** (`PKPaymentSummaryItem`,
    `PKShippingMethod`): This indicates the summary items displayed after the order''s
    subtotal, including the shipping method selected for the order.'
  id: totrans-21
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '**支付摘要项** 和 **配送方式** (`PKPaymentSummaryItem`, `PKShippingMethod`): 这表示在订单小计之后显示的摘要项，包括为订单选择的配送方式。'
- en: '**shipping methods** (`PKShippingMethod` objects): This indicates the shipping
    methods available to the customer for the order. This list may change if the user
    changes the shipping address.'
  id: totrans-22
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '**配送方式** (`PKShippingMethod` 对象): 这表示订单中客户可用的配送方式。如果用户更改了配送地址，此列表可能会发生变化。'
- en: '**payment sheet** (`PKPaymentAuthorizationViewController`): This is the sheet
    the app presents to let the user verify or enter the information you require before
    the user authorizes the payment request. The user authorizes the payment request
    on this sheet.'
  id: totrans-23
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '**付款单** (`PKPaymentAuthorizationViewController`): 这是应用向用户展示的界面，让用户在授权支付请求之前验证或输入所需的信息。用户将在该界面上授权支付请求。'
- en: '**payment sheet interaction protocol** (`PKPaymentAuthorizationViewControllerDelegate`):
    This is the API the app and the payment sheet use to communicate with each other.'
  id: totrans-24
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '**付款单交互协议** (`PKPaymentAuthorizationViewControllerDelegate`): 这是应用和付款单之间用来相互通信的API。'
- en: Implementing a shared method to compute summary items
  id: totrans-25
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 实现一个共享方法来计算摘要项
- en: 'To respond to the delegate method calls from the payment sheet, you should
    have a single method that computes the payment summary items based on the shipping
    information. Here''s a possible implementation of such a method:'
  id: totrans-26
  prefs: []
  type: TYPE_NORMAL
  zh: 要响应付款单的代理方法调用，您应该有一个单一的方法，根据配送信息计算支付摘要项。以下是一个此类方法的可能实现：
- en: '[PRE0]'
  id: totrans-27
  prefs: []
  type: TYPE_PRE
  zh: '[PRE0]'
- en: With this method in place, you can respond to different delegate method calls
    from the payment sheet and have a consistent algorithm for the computation of
    the payment summary items.
  id: totrans-28
  prefs: []
  type: TYPE_NORMAL
  zh: 使用此方法，您可以响应付款单的不同代理方法调用，并有一个一致的算法来计算支付摘要项。
- en: Responding to user interactions with the payment sheet
  id: totrans-29
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 响应用户与付款单的交互
- en: After identifying the main actors and operations involved in the payment authorization
    workflow and with a single method to compute payment summary items, we are ready
    to delve into your responses to payment sheet messages initiated by the changes
    the user makes to shipping information.
  id: totrans-30
  prefs: []
  type: TYPE_NORMAL
  zh: 在确定支付授权工作流程中的主要参与者和操作以及一个计算支付摘要项的单个方法后，我们准备深入了解您对用户更改配送信息所引发的付款单消息的响应。
- en: Note that the correct functionality of the payment sheet is essential to the
    payment authorization workflow; in particular, the payment sheet must call its
    delegate methods consistently so that you can correctly gauge when these methods
    are called as a result of user interaction with the payment sheet. If you use
    iOS simulators to test your code and notice that the payment sheet delegate methods
    are not being called, quit and restart the Simulator app.
  id: totrans-31
  prefs: []
  type: TYPE_NORMAL
  zh: 注意，支付表的正确功能对于支付授权工作流程至关重要；特别是，支付表必须一致地调用其代理方法，以便您能够正确判断这些方法何时被调用，这是由于用户与支付表的交互引起的。如果您使用iOS模拟器测试代码，并注意到支付表的代理方法没有被调用，请退出并重新启动模拟器应用。
- en: User changes shipping information
  id: totrans-32
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 用户更改运输信息
- en: When the user changes the shipping address or contact, your payment sheet delegate
    receives the `paymentAuthorizationViewController:didSelectShippingContact:completion:`
    message indicating that the user changed the shipping information for the order.
  id: totrans-33
  prefs: []
  type: TYPE_NORMAL
  zh: 当用户更改运输地址或联系人时，您的支付表代理会收到`paymentAuthorizationViewController:didSelectShippingContact:completion:`消息，表明用户已更改订单的运输信息。
- en: 'The new shipping details are encapsulated in a *contact* (a `PKContact` instance).
    This `contact` object contains only the shipping information you requested in
    the `requiredShippingAddressFields` property of the payment request. The properties
    of `contact` are `name`, `emailAddress`, `phoneNumber`, and `postalAddress`. So
    if you required only a postal address and name by setting the `requiredShippingAddressFields`
    payment request property to `PKAddressFieldPostalAddress|PKAddressFieldName`,
    the payment sheet ensures that the `name` and `postalAddress` properties of the
    contact are populated when it calls this `delegate` method. This is an implementation
    of this method:'
  id: totrans-34
  prefs: []
  type: TYPE_NORMAL
  zh: 新的运输详情被封装在一个*联系人*（一个`PKContact`实例）中。这个`contact`对象只包含您在支付请求的`requiredShippingAddressFields`属性中请求的运输信息。`contact`对象的属性有`name`、`emailAddress`、`phoneNumber`和`postalAddress`。所以，如果您通过将`requiredShippingAddressFields`支付请求属性设置为`PKAddressFieldPostalAddress|PKAddressFieldName`来仅请求邮政地址和姓名，支付表将确保在调用此`delegate`方法时，联系人的`name`和`postalAddress`属性被填充。这是此方法的实现：
- en: '[PRE1]'
  id: totrans-35
  prefs: []
  type: TYPE_PRE
  zh: '[PRE1]'
- en: All this method does is provide a success status, the standard shipping methods,
    and the computed payment summary items to the payment sheet through the method's
    completion block. In your app's case, you may need to tailor the returned shipping
    methods depending on the information contained in the `contact` argument of the
    completion block.
  id: totrans-36
  prefs: []
  type: TYPE_NORMAL
  zh: 此方法所做的只是通过方法的完成块向支付表提供成功状态、标准运输方法和计算出的支付摘要项。在您的应用中，您可能需要根据完成块中`contact`参数包含的信息调整返回的运输方法。
- en: User changes shipping method
  id: totrans-37
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 用户更改运输方法
- en: 'When the user changes the shipping method, the payment sheet calls the `paymentAuthorizationViewController:didSelectShippingMethod:completion:`
    method of its delegate. Similar to changes in shipping information, you recompute
    the payment summary items based on the shipping method the user selects. In the
    `completion` block, provide a success authorization status and the newly computed
    payment summary items, as shown in this example:'
  id: totrans-38
  prefs: []
  type: TYPE_NORMAL
  zh: 当用户更改运输方式时，支付表会调用其代理的`paymentAuthorizationViewController:didSelectShippingMethod:completion:`方法。类似于运输信息的更改，您根据用户选择的运输方式重新计算支付摘要项。在`completion`块中，提供成功授权状态和重新计算后的支付摘要项，如下例所示：
- en: '[PRE2]'
  id: totrans-39
  prefs: []
  type: TYPE_PRE
  zh: '[PRE2]'
- en: All this method does is store the index of the shipping method chosen, recompute
    the payment summary item array, and call the completion block with `PKPaymentAuthorizationStatusSuccess`
    as the `status` argument and the new payment summary items array as the `summary_items`
    argument.
  id: totrans-40
  prefs: []
  type: TYPE_NORMAL
  zh: 此方法所做的只是存储所选运输方法的索引，重新计算支付摘要项数组，并通过方法的完成块调用完成块，将`PKPaymentAuthorizationStatusSuccess`作为`status`参数，以及新的支付摘要项数组作为`summary_items`参数。
- en: User authorizes payment request
  id: totrans-41
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 用户授权支付请求
- en: 'When the user authorizes the payment request, the payment sheet calls the `paymentAuthorizationViewController:didAuthorizePayment:completion:`
    method in its delegate. In this method, you process the payment (the `PKPayment`
    instance) you get from the payment sheet, a process described in the next chapter.
    If the payment is processed successfully, you will call the `completion` block
    with `PKPaymentAuthorizationStatusSuccess` as the argument. If your validation
    checks determine that the payment request contains incorrect information, you
    can return values that specify this, such as:'
  id: totrans-42
  prefs: []
  type: TYPE_NORMAL
  zh: 当用户授权支付请求时，支付表单在其代理上调用`paymentAuthorizationViewController:didAuthorizePayment:completion:`方法。在这个方法中，你处理从支付表单获得的支付（`PKPayment`实例），这个过程将在下一章中描述。如果支付处理成功，你将使用`PKPaymentAuthorizationStatusSuccess`作为参数调用`completion`块。如果你的验证检查确定支付请求包含错误信息，你可以返回指定此信息的值，例如：
- en: '`PKPaymentAuthorizationStatusInvalidBillingPostalAddress`'
  id: totrans-43
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '`PKPaymentAuthorizationStatusInvalidBillingPostalAddress`'
- en: '`PKPaymentAuthorizationStatusInvalidShippingPostalAddress`'
  id: totrans-44
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '`PKPaymentAuthorizationStatusInvalidShippingPostalAddress`'
- en: '`PKPaymentAuthorizationStatusInvalidShippingContact`'
  id: totrans-45
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '`PKPaymentAuthorizationStatusInvalidShippingContact`'
- en: Otherwise, for a general failure, including that the issuing bank did not approve
    the transaction, you can return `PKPaymentAuthorizationStatusFailure`.
  id: totrans-46
  prefs: []
  type: TYPE_NORMAL
  zh: 否则，对于一般性失败，包括发行银行未批准交易的情况，你可以返回`PKPaymentAuthorizationStatusFailure`。
- en: 'Here is an with `payment sheet:payment request, authorizing"` example implementation
    of this method:'
  id: totrans-47
  prefs: []
  type: TYPE_NORMAL
  zh: 这里是一个`payment sheet:payment request, authorizing`方法的示例实现：
- en: '[PRE3]'
  id: totrans-48
  prefs: []
  type: TYPE_PRE
  zh: '[PRE3]'
- en: 'Here is an example of the payment sheet:'
  id: totrans-49
  prefs: []
  type: TYPE_NORMAL
  zh: 这里是支付表单的示例：
- en: '![User authorizes payment request](img/B05093_03_02.png.jpg)'
  id: totrans-50
  prefs: []
  type: TYPE_IMG
  zh: '![用户授权支付请求](img/B05093_03_02.png.jpg)'
- en: 'Whether the payment is processed successfully or the user canceled the transaction,
    it is your responsibility to dismiss the payment sheet when it calls the `paymentAuthorizationViewControllerDidFinish:`
    method on its delegate. This is an example of how to do this:'
  id: totrans-51
  prefs: []
  type: TYPE_NORMAL
  zh: 无论支付是否成功处理或用户取消了交易，当它在其代理上调用`paymentAuthorizationViewControllerDidFinish:`方法时，你有责任关闭支付表单。以下是如何做到这一点的示例：
- en: '[PRE4]'
  id: totrans-52
  prefs: []
  type: TYPE_PRE
  zh: '[PRE4]'
- en: In addition to dismissing the payment sheet, you can perform other state-restoring
    operations as needed.
  id: totrans-53
  prefs: []
  type: TYPE_NORMAL
  zh: 除了关闭支付表单之外，根据需要，你可以执行其他恢复状态的操作。
- en: Summary
  id: totrans-54
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 摘要
- en: In this chapter you learned how the actors in your app's payment authorization
    workflow work together to help the user provide the information you need to process
    the payment and order (if the payment is approved by the payment card's issuing
    bank). The chapter showed how to prepare the payment request with essential payment
    information, such as the payment networks you support. It described how to respond
    to changes the user makes to the order in the payment sheet. Finally, the chapter
    showed how to dismiss the payment sheet after the user authorizes or cancels the
    payment request.
  id: totrans-55
  prefs: []
  type: TYPE_NORMAL
  zh: 在本章中，你学习了你的应用程序支付授权工作流程中的参与者如何协同工作，以帮助用户提供你处理支付和订单（如果支付卡发行银行批准支付）所需的信息。本章展示了如何准备带有基本支付信息的支付请求，例如你支持的支付网络。它描述了如何响应用户在支付表单中对订单所做的更改。最后，本章展示了在用户授权或取消支付请求后如何关闭支付表单。
- en: The next chapter will describe the payment processing workflow, which is where
    you will process the information obtained here to process the payment through
    your payment gateway and fulfill the customer's order in your order processing
    web application. We will consider the payment information required to get the
    user's payment card's issuing bank to approve the transaction.
  id: totrans-56
  prefs: []
  type: TYPE_NORMAL
  zh: 下一章将描述支付处理工作流程，这是你将处理在此处获得的信息，通过你的支付网关处理支付并在你的订单处理Web应用程序中履行客户订单的地方。我们将考虑获取用户支付卡发行银行批准交易所需的支付信息。
