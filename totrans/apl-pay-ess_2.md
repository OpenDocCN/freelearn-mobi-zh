# 第二章. 支付请求工作流程

当您的客户决定购买您应用中提供的产品时，您的责任是给用户提供一个顺畅、快速且无痛苦的支付体验。幸运的是，苹果公司通过实施Apple Pay承担了这项工作的主要部分。用户无需翻找信用卡和输入送货地址即可完成订单，即使这是他们第一次使用您的应用。通过仅请求执行交易所必需的信息，您为您的客户提供了一种引人入胜的购物体验，这将鼓励他们从您的应用中进行后续购买。

本章描述了您的应用需要执行的操作，以给用户带来愉快的购物体验，在这个体验中，从渴望某物到将此产品送到您家门口的障碍被简化为轻轻触摸一个光滑、圆润的按钮。同时，您减少了或消除了请求和存储客户支付信息的需求，这在计算机系统信息泄露事件显著增加的背景下是一种明智的做法。您可能还会欢迎来自同一客户的显著增加的购买量，这些客户除了在其他应用中拥有更好的购物体验外，还对其支付信息的安全性有信心（因为他们的卡信息没有存储在他们的手机中）。无缝的支付体验将使您的应用在用户“喜爱”和“高度喜爱”的应用列表中名列前茅，并且他们愿意向家人和朋友推荐这些应用。

本章涵盖了以下主题：

+   提供一个简单库存网络服务的概述，该服务向其客户端提供库存信息

+   描述了一个产品卡片实现，该卡片显示必要的产品信息，并根据用户设备上Apple Pay的可用性显示**Apple Pay**按钮或常规**购买**按钮。

+   演示创建支付请求的过程，并显示带有订单信息的支付单，以便用户授权支付（当Apple Pay可用时）

# 从库存服务获取信息

如果您的应用用户可以通过它购买有形商品，那么应用必须获取有关此类产品可用性的信息。实现这一目标的一种方法是通过*网络服务*。网络服务是在网络服务器上运行的程序（网络应用或网络进程），客户端（桌面或移动应用）可以连接到它以访问资源，例如库存、产品图片、订单和支付。访问此类资源最网络化的方式是通过使用*RESTful API*。**表示状态转移**（**REST**）为计算机与其他计算机之间的通信提供了一种方式，类似于人们浏览网页的方式。

当您访问一个网页时，该网页可能会提供一些选项（链接），您可以使用这些选项访问与此页面或您参与的流程（交易）相关的页面。然后，您分析每个链接以决定下一步访问哪个相关页面。RESTful API为客户端提供了与由Web服务器托管资源进行有机交互的方式。客户端无需遵循由Web服务指定的严格API，而是可以请求资源的特定表示（浏览器可能请求其XHTML版本，而iOS应用可能请求JavaScript对象表示法或JSON）。资源中嵌入了对相关资源或修改资源状态的操作的链接。例如，在创建订单后，Web服务器可能会提供返回此订单状态、修改它或取消它的操作的链接。这种交互方式被称为*超媒体*。超媒体指的是分布式系统操作的方式，通过一组小的HTTP动词（如`POST`、`PUT`、`GET`和`DELETE`）通过其唯一标识符访问资源。这种简单的通信风格为分布式系统在建立专门的通信协议时提供了极大的灵活性。

本书（并可下载）中描述的示例解决方案（iOS应用和Web服务）使用RESTful API来提供对库存、订单和支付的访问。通过将应用与其Web服务的交互基于简单的RESTful API，我们可以将注意力集中在将Apple Pay集成到您的应用中以及处理Web服务器上的支付的主要方面。

在您的应用向客户展示产品信息之前，它必须从您的Web服务器获取这些信息。运输信息同样重要，因为您提供的运输方式可能会不时发生变化，应用也应该定期获取这些信息。应用将展示支付单上的可用运输方式，以便用户接受默认的运输方式或更改它。以下部分描述了示例解决方案如何从Web服务器获取库存和运输信息到用户的设备。

## 获取库存信息

示例应用非常简单。在启动时，它从Web服务器请求两件事：库存和可用的运输方式。然后，它以列表的形式显示库存，如下面的截图所示：

![获取库存信息](img/B05093_02_01.png.jpg)

为了获取库存信息，应用程序使用REST API从服务器请求资源的表示。通过访问`http://red:12345/inventory`**统一资源标识符**（**URI**）找到资源。在接收到数据后，应用程序使用`NSJSONSerialization`类将接收到的数据（以JSON编码）转换为`NSDictionary`实例，这是表格（`UITableView`实例）的数据源，其行显示库存中每个产品的名称。

此列表显示了由网络服务（用Node.js实现）使用的模型，定义相应iOS模型的Objective-C类，以及将JSON转换为产品字典的代码：

[PRE0]

需要注意的一个重要事项是，产品的价格以字符串形式存储，而不是数字。这是因为使用数字类型进行财务计算不会产生准确的结果。在进行财务计算时，尤其是涉及苹果支付交易的计算，必须使用`NSDecimalNumber`类的实例，这有助于在十进制数上进行准确的算术运算。`NSDecimalNumber`类还包含将数字字符串转换为十进制数的方法。

## 获取运输信息

为了在支付页面上向客户提供可用的运输方式，应用程序需要从服务器获取列表。在示例代码中，应用程序的`AppDelegate`对象在其`application:didFinishLaunchingWithOptions:`方法中获取此列表。

此列表显示了`ShippingService`类实例的Node.js和Objective-C模型类，以及从服务器获取运输服务的代码：

[PRE1]

与之前引入的`Product`类类似，`ShippingMethod`类使用字符串来存储每种运输方式的价格。这是因为运输方式的价格会被添加到支付请求中其他项目的价格中，并且所有这些添加都必须使用十进制数（`NSDecimalNumber`实例）来完成。

现在应用程序已经拥有了可用产品的库存和用户可用的运输方式，当用户从产品列表中选择产品时，它可以显示**产品信息卡片**；当用户点击**苹果支付**按钮时，它可以显示支付页面。

# 显示产品卡片

苹果支付的用户体验从**苹果支付**按钮的出现开始。当您的客户看到这个按钮时，他们会知道他们设备屏幕上显示的产品只需轻触两次即可送到家门口。实际上，根本不需要**第三步**。

*产品卡片*是一个显示产品信息的屏幕，例如产品的名称、描述和价格，以及当用户的设备上可用**Apple Pay**按钮时显示的**Apple Pay**按钮。当**Apple Pay**不可用（无论是由于客户的设备不支持它，还是因为客户未在该设备上设置Apple Pay），您的应用不应显示**Apple Pay**按钮。相反，它应显示**添加到购物车**按钮或常规**购买**按钮，并使用传统方式处理支付。

以下部分描述了如何设计产品卡片屏幕以及如何在可用时运行时布局**Apple Pay**按钮。

## 展示产品信息

产品卡片定义从应用的主要故事板文件开始，如下面的截图所示：

![展示产品信息](img/B05093_02_02.png.jpg)

产品场景布局构成产品卡片的元素。这主要是用于显示产品图像的一个图像视图，以及三个标签，用于显示产品描述、**价格**图例和产品价格（使用货币格式化器）。

此列表显示了`ProductCard`对象的`viewDidLoad`方法：

[PRE2]

`viewDidLoad`方法实例化了用于*购买*表格单元格的货币格式化器，该单元格显示产品的价格和**Apple Pay**按钮。然而，**Apple Pay**按钮不是在设计时布局的；它是在产品表格显示购买单元格时运行时布局的。此设置将在下一节中解释。

`viewDidLoad`方法通过获取产品的`image_uri`属性标识的资源来获取产品的图像。此方法使用REST API从服务器下载图像数据。当图像下载完成后，该方法创建一个`UIImage`对象，并将其分配给产品表格的`view`属性。

## 展示Apple Pay按钮

如前所述，如果用户无法在他们的设备上使用Apple Pay，则您的应用不显示**Apple Pay**按钮非常重要。您的应用使用`PKPaymentAuthorizationViewController`类的两个方法来确定Apple Pay是否可用：`canMakePayments`和`canMakePaymentsUsingNetworks`。

此列表显示了示例iOS应用如何使用这些方法确定要添加到购买单元格中的购买按钮：**Apple Pay**按钮，`PKPaymentButton`类的一个实例，或作为`UIButton`实例实现的**购买**按钮：

[PRE3]

此过程的结果是一个显示**Apple Pay**按钮的产品卡片（如果设备上可用Apple Pay），使用户能够快速满足购买美丽产品的冲动。您的任务是尽可能减少障碍，以促进这种冲动的满足。 

![展示Apple Pay按钮](img/B05093_02_03.png.jpg)

当用户点击**Apple** **Pay**按钮时，您的应用通过创建支付请求来启动Apple Pay交易。

# 创建支付请求

现在用户已经决定购买您的产品，我们的任务是帮助他们以尽可能少的干扰和中断来授权支付请求。用户的注意力，尤其是在iPhone这样的设备上，可能是短暂的；在他们确认账单地址的额外一秒钟（即使他们总是使用相同的地址），电话可能会打进来，然后，砰，交易就消失了。您能提供给用户的任何信息都能帮助加快授权过程。Apple Pay使这一点变得非常方便。

![创建支付请求](img/B05093_02_04.png.jpg)

## 指定支付详情

支付请求（`PKPaymentRequest`的一个实例）的基本组件包括：国家代码和货币代码、您的商户标识符和能力，以及您支持的支付网络。您必须在创建的每个支付请求中指定所有这些属性。

## 国家和货币代码

您通过支付请求的`countryCode`和`currencyCode`属性来指定这些项。指定这些项非常重要，因为它们确定了支付的处理地点和处理方式。国家代码是支付处理所在国家的两位字母代码（参考ISO 3166，见[http://www.iso.org/iso/country_codes](http://www.iso.org/iso/country_codes)）。货币代码是用于资助交易的货币的三位字母代码（参考ISO 4217，见[http://www.iso.org/iso/home/standards/currency_codes](http://www.iso.org/iso/home/standards/currency_codes)）。

## 商户标识符和能力

苹果商户标识符是您从苹果会员中心网站上的“证书、标识符和配置文件”部分获得的标识符（或者您现在就可以获得！）它们是反向DNS标识符，以`merchant.com`开头。商户能力标识了支付协议、3-D Secure和EMV（欧付宝、万事达卡和维萨）。3-D Secure支持是必需的；EMV支持是可选的。您通过支付请求的`merchantIdentifier`和`merchantCapabilities`属性来指定这些组件。

此列表显示了指定支付请求支付详情的代码：

[PRE4]

# 要求提供运输和账单信息

Apple Pay 提供了你完成交易所需的所有信息。然而，可能存在需要用户在授权支付请求之前存储在 Apple Pay 中但之前无法获取的信息的情况。例如，尽管 Apple Pay 提供了运输和账单信息，但你可能仍然需要在用户授权支付请求之前要求他们输入或确认运输目的地，以便在支付单中计算运输成本。但请记住，由于客户的账单和运输细节很可能在 Apple Pay 中是最新的，因此依赖 Apple Pay 获取这些信息通常是最佳方法。更不用说，如果不要求用户确认此类详细信息，你将使他们快速进入那神奇的*授权触摸*。

## 要求运输或账单地址

如果你需要用户输入运输或账单信息（因为你的系统与其他需要这些信息的系统接口），你可以使用支付请求的 `requiredBillingAddressFields` 和 `requiredShippingAddressFields` 属性来指定这些要求。例如，为了使账单地址成为必填字段，将此属性设置为 `PKAddressFieldPostalAddress`。如果你需要一个电子邮件地址，将其设置为 `PKAddressFieldEmail`。最后，为了请求姓名，将属性设置为 `PKAddressFieldName`。由于这些属性接受的值是位字段常量，你可以将它们聚合起来以要求多个项目。以下列表展示了如何要求运输地址和电子邮件，以及账单电子邮件：

[PRE5]

## 指定运输或账单地址

如果你的客户之前已经从你的业务中购买了商品，并且你有他们的账单和运输地址，你可以使用支付请求的 `billingAddress` 和 `shippingAddress` 属性在支付单上预先填充这些信息。

以下列表展示了如何使运输和账单信息成为必填字段：

[PRE6]

## 指定运输方式

如果你向客户发货产品，你可以提供一种或多种运输方式。前面提到的示例 iOS 应用和 Web 服务展示了这样一个系统的基本实现。根据你企业的规模，你可能需要为特定产品或目的地提供运输方式。无论设置有多复杂，你提供的支付单上都应该有一个简单的运输方式列表，用户可以选择对他们最方便的一种。下一章将讨论当用户在支付单中更改运输方式时如何做出反应。目前，你的重点是创建一个运输方式数组（`PKShippingMethod` 实例），并将其分配给 `shippingMethods` 支付请求属性。以下列表展示了如何创建这样一个数组以及如何在支付请求中包含它：

[PRE7]

如果除了使用运输服务运输商品外，您还支持店内取货或特殊递送方式，例如披萨或家具，那么您可以指定一个替代递送方式的列表。要指定这些运输类型，请使用支付请求的`shippingType`属性。

# 指定摘要项

摘要项是支付单中的元素，用于指定用户购买的商品的价格、运费、税费、折扣和总价。每个摘要项都有一个标签，例如`SHIPPING`或`TAX`。最后一个项目代表总价，并带有标签，例如`PAY ACME`。此项目的标签必须能识别您的公司，以便客户可以将购买与他们的支付卡账单相匹配。您通过将`PKPaymentSummaryItem`实例数组分配给支付请求的`paymentSummaryItems`属性来指定支付请求的摘要项。每个摘要项都有一个`amount`属性，表示项目的成本。

此列表显示了如何定义支付请求的摘要项：

[PRE8]

要指定表示从产品价格中折扣的摘要项，请为摘要项的金额使用负值。当您不知道金额的值，因为该值是作为订单处理的一部分生成时，您可以通过将摘要项的`type`属性设置为`PKPaymentSummaryItemTypePending`来向用户表明这一事实。这会在项目的标签中添加适当的说明。

# 指定与订单相关的自定义信息

如果您的订单系统在发行银行批准支付后需要额外的信息，您可以在支付请求的`applicationData`属性中指定它。然而，Apple Pay不会将此信息发送给您。您的应用必须单独将此信息发送到您的系统。

作为处理支付的一部分，您的支付处理器会获取支付请求中`applicationData`属性设置的值的哈希。您可以使用这个哈希来验证应用单独发送的值与初始值是否相同。

# 摘要

本章展示了您的应用如何使用REST API获取数据以执行其功能，该API使用标准的HTTP惯用语（如`PUT`、`GET`、`UPDATE`和`DELETE`等HTTP动词）提供灵活的功能。它还向您展示了如何将此数据转换为用户可以采取行动的信息，例如产品名称、描述和图片。特别是，本章讨论了何时向用户展示**Apple Pay**按钮（只有当用户的设备上可用Apple Pay时）。最后，本章向您介绍了创建支付请求的过程，这包括指定支付信息，例如Apple商户标识和商户能力、运输和账单信息，以及包含订单总价格并标注您公司名称的摘要项，以便于与支付卡对账单进行轻松验证。

现在用户正在查看付款单，您的应用需要有效地响应用户在运输方式或账单和运输地址上的变化。然而，最终的用户操作是授权支付请求。这是下一章的主题。
