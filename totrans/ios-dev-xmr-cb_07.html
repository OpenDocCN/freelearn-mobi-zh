<html><head></head><body><div class="chapter" title="Chapter&#xA0;7.&#xA0;Multimedia Resources"><div class="titlepage"><div><div><h1 class="title"><a id="ch07"/>Chapter 7. Multimedia Resources</h1></div></div></div><p>In this chapter, we will cover the following topics:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">Selecting images and videos</li><li class="listitem" style="list-style-type: disc">Capturing media with the camera</li><li class="listitem" style="list-style-type: disc">Playing videos</li><li class="listitem" style="list-style-type: disc">Playing music and sounds</li><li class="listitem" style="list-style-type: disc">Recording with the microphone</li><li class="listitem" style="list-style-type: disc">Managing album items directly</li></ul></div><div class="section" title="Introduction"><div class="titlepage"><div><div><h1 class="title"><a id="ch07lvl1sec59"/>Introduction</h1></div></div></div><p>One of the most important features of today's smartphones and tablets is their ability to capture and manage multimedia resources. Be it photos, videos, or audio, an app targeted at these devices that can handle multimedia effectively is very important.</p><p>In this chapter, we will see how to manage media stored on the device. We will also learn how to use the device's multimedia capturing devices (a camera and microphone) to capture content and create an app that will provide a rich experience to the user.</p><p>More specifically, we will discuss the following topics:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><code class="literal">UIImagePickerController</code>: This is a controller that provides access to the saved photos<a id="id421" class="indexterm"/> and videos on the device through a user interface, but also a camera interface for capturing photos through the device's camera hardware.</li><li class="listitem" style="list-style-type: disc"><code class="literal">MPMoviePlayerController</code>: This is a controller that allows us to play and stream <a id="id422" class="indexterm"/>video files.</li><li class="listitem" style="list-style-type: disc"><code class="literal">MPMediaPickerController</code>: This is the default user interface to access the saved <a id="id423" class="indexterm"/>content managed by the native iPod app.</li><li class="listitem" style="list-style-type: disc"><code class="literal">MPMusicPlayerController</code>: This is the object that is responsible for playing<a id="id424" class="indexterm"/> the iPod content.</li><li class="listitem" style="list-style-type: disc"><code class="literal">AVAudioPlayer</code>: This<a id="id425" class="indexterm"/> is the class that allows us to play sound files.</li><li class="listitem" style="list-style-type: disc"><code class="literal">AVAudioRecorder</code>: This<a id="id426" class="indexterm"/> is the class that allows us to use the microphone to record audio.</li><li class="listitem" style="list-style-type: disc"><code class="literal">ALAssetsLibrary</code>: This<a id="id427" class="indexterm"/> is the class that provides access to the device's available assets and their metadata.</li></ul></div></div></div>
<div class="section" title="Selecting images and videos"><div class="titlepage"><div><div><h1 class="title"><a id="ch07lvl1sec60"/>Selecting images and videos</h1></div></div></div><p>In this recipe, we will learn how to provide the user with the ability to import images and videos from the device album.</p><div class="section" title="Getting ready"><div class="titlepage"><div><div><h2 class="title"><a id="ch07lvl2sec230"/>Getting ready</h2></div></div></div><p>Create a new <span class="strong"><strong>Single View Application</strong></span> in Xamarin Studio and name it <code class="literal">ImagePickerApp</code>. For this recipe, we will need some images to be stored in the simulator's<a id="id428" class="indexterm"/> photo albums.</p><p>An easy way <a id="id429" class="indexterm"/>to add images to the simulator is by navigating to a web page with Safari. Long-tapping (click + hold) on any image in Safari will show us an action sheet with a <span class="strong"><strong>Save</strong></span> option. Tapping the option saves the image to the photo albums.</p></div><div class="section" title="How to do it..."><div class="titlepage"><div><div><h2 class="title"><a id="ch07lvl2sec231"/>How to do it...</h2></div></div></div><p>Perform the following steps:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Open the <code class="literal">ImagePickerAppViewController.xib</code> file in Interface Builder and add <code class="literal">UIImageView</code> and <code class="literal">UIButton</code> to it.</li><li class="listitem">Enter the following code in the <code class="literal">ViewDidLoad</code> method:<div class="informalexample"><pre class="programlisting">this.imagePicker = new UIImagePickerController();
this.imagePicker.FinishedPickingMedia += this.ImagePicker_FinishedPickingMedia;
this.imagePicker.Canceled += this.ImagePicker_Cancelled;
this.imagePicker.SourceType = UIImagePickerControllerSourceType.PhotoLibrary;
this.btnSelect.TouchUpInside += async (s, e) =&gt; {
  await this.PresentViewControllerAsync(this.imagePicker, true);
};</pre></div></li><li class="listitem">Implement the handler methods for the <code class="literal">FinishedPickingMedia</code> and <code class="literal">Canceled</code> events as shown in the following code:<div class="informalexample"><pre class="programlisting">private async void ImagePicker_FinishedPickingMedia (object sender, UIImagePickerMediaPickedEventArgs e)
{
  UIImage pickedImage = e.Info[UIImagePickerController.OriginalImage] as UIImage;
  this.imageView.Image = pickedImage;
  await this.imagePicker.DismissViewControllerAsync(true);
}
private async void ImagePicker_Cancelled (object sender, EventArgs e)
{
  await this.imagePicker.DismissViewControllerAsync(true);
}</pre></div></li><li class="listitem">Compile <a id="id430" class="indexterm"/>and run the app on the simulator. Tap on the button you added in the initial steps to <a id="id431" class="indexterm"/>present the image picker and select an image by tapping on its thumbnail. The image will be displayed in the image view. The <code class="literal">UIImagePickerController</code> is shown in the following screenshot:<div class="mediaobject"><img src="graphics/8924OT_07_01.jpg" alt="How to do it..."/></div></li></ol></div><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="note41"/>Note</h3><p>Just before the first time <code class="literal">UIImagePickerController</code> is shown in an app, iOS will display an alert, asking the user for permission to access the photo albums. Handling this situation is described in the <span class="emphasis"><em>Managing album items directly</em></span> recipe later in this chapter.</p></div></div></div><div class="section" title="How it works..."><div class="titlepage"><div><div><h2 class="title"><a id="ch07lvl2sec232"/>How it works...</h2></div></div></div><p>
<code class="literal">UIImagePickerController</code> is a special view controller that iOS provides to select images and <a id="id432" class="indexterm"/>videos that are saved on the device album or even to capture new <a id="id433" class="indexterm"/>media from the camera.</p><p>After initializing the image picker object, we need to subscribe to its <code class="literal">FinishedPickingMedia</code> event, which provides us with the media that the user has selected. In the handler we assign to it, we get the selected image:</p><div class="informalexample"><pre class="programlisting">UIImage pickedImage = e.Info[UIImagePickerController.OriginalImage] as UIImage;</pre></div><p>The <code class="literal">Info</code> property returns an <code class="literal">NSDictionary</code> object that contains various kinds of information about the picked media. We retrieve the image, passing the <code class="literal">UIImagePickerController.OriginalImage</code> constant as key. As the values of the dictionary are of the <code class="literal">NSObject</code> type, we cast the return value to <code class="literal">UIImage</code>. After we assign the image to the <code class="literal">UIImageView</code> to be displayed, we dismiss the controller by using the following code:</p><div class="informalexample"><pre class="programlisting">await this.imagePicker.DismissViewControllerAsync(true);</pre></div><p>The <code class="literal">Canceled</code> event is triggered when the user taps on the controller's <span class="strong"><strong>Cancel</strong></span> button. We must subscribe to it to dismiss the controller, because it will not be dismissed automatically when the user taps on the <span class="strong"><strong>Cancel</strong></span> button.</p></div><div class="section" title="There's more..."><div class="titlepage"><div><div><h2 class="title"><a id="ch07lvl2sec233"/>There's more...</h2></div></div></div><p>We can define the source of the images/videos the image picker will read from through its <code class="literal">SourceType</code> property. In this example, we use <code class="literal">UIImagePickerController.PhotoLibrary</code> because the simulator does not support the camera hardware.</p><div class="section" title="Picking videos"><div class="titlepage"><div><div><h3 class="title"><a id="ch07lvl3sec59"/>Picking videos</h3></div></div></div><p>
<code class="literal">UIImagePickerController</code> displays only images by default. To support videos, its <code class="literal">MediaType</code> property <a id="id434" class="indexterm"/>must be set. It accepts a <code class="literal">string[]</code> parameter, with the specified media names as shown in the following code:</p><div class="informalexample"><pre class="programlisting">this.imagePicker.MediaTypes = new string[] { "public.image", "public.movie" };</pre></div><p>To <a id="id435" class="indexterm"/>determine the media type the user has picked, we check the <code class="literal">MediaType</code> key of the dictionary in the <code class="literal">FinishedPickingMedia</code> handler. If it is a video, we get its URL with the <code class="literal">MediaUrl</code> key, as shown in the following code:</p><div class="informalexample"><pre class="programlisting">if (e.Info[UIImagePickerController.MediaType].ToString() == "public.movie")
{
  NSUrl mediaUrl = e.Info[UIImagePickerController.MediaURL] as NSUrl;
  // Do something useful with the media url.
}</pre></div></div></div><div class="section" title="See also"><div class="titlepage"><div><div><h2 class="title"><a id="ch07lvl2sec234"/>See also</h2></div></div></div><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">The <span class="emphasis"><em>Capturing media with the camera</em></span> recipe</li><li class="listitem" style="list-style-type: disc">The <span class="emphasis"><em>Managing album items directly</em></span> recipe</li></ul></div></div></div>
<div class="section" title="Capturing media with the camera"><div class="titlepage"><div><div><h1 class="title"><a id="ch07lvl1sec61"/>Capturing media with the camera</h1></div></div></div><p>In this recipe, we will learn how to use the device camera to capture the media.</p><div class="section" title="Getting ready"><div class="titlepage"><div><div><h2 class="title"><a id="ch07lvl2sec235"/>Getting ready</h2></div></div></div><p>Open<a id="id436" class="indexterm"/> the <code class="literal">ImagePickerApp</code> project that we created<a id="id437" class="indexterm"/> in the previous recipe.</p><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="note42"/>Note</h3><p>The camera functionality is not available on iOS Simulator. This example can only run on the device. Refer to <a class="link" href="ch14.html" title="Chapter 14. Deploying">Chapter 14</a>, <span class="emphasis"><em>Deploying</em></span>, for more information.</p></div></div></div><div class="section" title="How to do it..."><div class="titlepage"><div><div><h2 class="title"><a id="ch07lvl2sec236"/>How to do it...</h2></div></div></div><p>Perform the following steps:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">In the ViewDidLoad method of the controller class, replace <code class="literal">this.imagePicker.SourceType = UIImagePickerControllerSourceType.PhotoLibrary;</code> with the following code block:<div class="informalexample"><pre class="programlisting">if (UIImagePickerController.IsSourceTypeAvailable(UIImagePickerControllerSourceType.Camera))
{
  this.imagePicker.SourceType = UIImagePickerControllerSourceType.Camera;
}  else
{
  this.imagePicker.SourceType = UIImagePickerControllerSourceType.PhotoLibrary;
}</pre></div></li><li class="listitem">In<a id="id438" class="indexterm"/> the <code class="literal">FinishedPickingMedia</code> handler, add<a id="id439" class="indexterm"/> the following code before the dismissal of the image picker:<div class="informalexample"><pre class="programlisting">pickedImage.SaveToPhotosAlbum((s, error) =&gt; {
  if (null != error)
  {
    Console.WriteLine("Image not saved! Message: {0}", error.LocalizedDescription);
  }
} );</pre></div></li><li class="listitem">Compile and run the app on the device. Tap the button to open the camera and take a picture. The picture will be saved to the device album.</li></ol></div></div><div class="section" title="How it works..."><div class="titlepage"><div><div><h2 class="title"><a id="ch07lvl2sec237"/>How it works...</h2></div></div></div><p>Before presenting the camera viewfinder, we have to make sure that the device that the app is running on actually has the appropriate hardware. We do this by calling the static <code class="literal">IsSourceTypeAvailable</code> method of the <code class="literal">UIImagePickerController</code> class as follows:</p><div class="informalexample"><pre class="programlisting">if (UIImagePickerController.IsSourceTypeAvailable(UIImagePickerControllerSourceType.Camera))</pre></div><p>If this returns <code class="literal">true</code>, we set the source type to <code class="literal">Camera</code> by using the following code:</p><div class="informalexample"><pre class="programlisting">this.imagePicker.SourceType = UIImagePickerControllerSourceType.Camera;</pre></div><p>This will cause the image picker controller to start the camera device instead of loading the device albums.</p><p>When the user takes a photo (or video) through our application, it is not automatically saved on the device. To save it, we use the <code class="literal">SaveToPhotosAlbum</code> method of the <code class="literal">UIImage</code> class. This method accepts a delegate of the <code class="literal">UIImage.SaveStatus</code> type, which will report an error if something goes wrong:</p><div class="informalexample"><pre class="programlisting">if (null != error)
{
  Console.WriteLine("Image not saved! Message: {0}", error.LocalizedDescription);
}</pre></div></div><div class="section" title="There's more..."><div class="titlepage"><div><div><h2 class="title"><a id="ch07lvl2sec238"/>There's more...</h2></div></div></div><p>The camera view can also be customized. To disable the default camera controls, set the <code class="literal">ShowsCameraControls</code> property to <code class="literal">false</code>. Then, pass a custom view with the controls you want to the <code class="literal">CameraOverlayView</code> property. To trigger the shutter of the camera, call the <code class="literal">TakePicture</code> method.</p><div class="section" title="Image editing"><div class="titlepage"><div><div><h3 class="title"><a id="ch07lvl3sec60"/>Image editing</h3></div></div></div><p>The camera supports a simple editing function after capturing an image. This editing function<a id="id440" class="indexterm"/> allows the user to select a specific part of the<a id="id441" class="indexterm"/> image and even zoom to a specific area. To present the editing controls, set the <code class="literal">AllowsEditing</code> property to <code class="literal">true</code>. The edited image can be retrieved from the dictionary in the <code class="literal">FinishedPickingMedia</code> handler, passing the <code class="literal">UIImagePickerController.EditedImage</code> key. The editing interface is shown in the following screenshot:</p><div class="mediaobject"><img src="graphics/8924OT_07_02.jpg" alt="Image editing"/></div></div></div><div class="section" title="See also"><div class="titlepage"><div><div><h2 class="title"><a id="ch07lvl2sec239"/>See also</h2></div></div></div><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">The <span class="emphasis"><em>Selecting images and videos</em></span> recipe</li></ul></div></div></div>
<div class="section" title="Playing videos"><div class="titlepage"><div><div><h1 class="title"><a id="ch07lvl1sec62"/>Playing videos</h1></div></div></div><p>In this recipe, we will learn how to display a video player interface and play video files.</p><div class="section" title="Getting ready"><div class="titlepage"><div><div><h2 class="title"><a id="ch07lvl2sec240"/>Getting ready</h2></div></div></div><p>Create a <a id="id442" class="indexterm"/>new <span class="strong"><strong>Single View Application</strong></span> in Xamarin Studio and name it <code class="literal">PlayVideoApp</code>.</p></div><div class="section" title="How to do it..."><div class="titlepage"><div><div><h2 class="title"><a id="ch07lvl2sec241"/>How to do it...</h2></div></div></div><p>Perform the following steps:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Add a button to the main view of the controller.</li><li class="listitem">Add a video file to the project and set its <span class="strong"><strong>Build Action</strong></span> to <span class="strong"><strong>Content</strong></span>.</li><li class="listitem">Add the following code to the <code class="literal">ViewDidLoad</code> method of the controller class:<div class="informalexample"><pre class="programlisting">this.moviePlayer = new MPMoviePlayerController(NSUrl.FromFilename("video.mov"));
this.moviePlayer.View.Frame = new RectangleF(0f, 20f, this.View.Frame.Width, 320f);
this.View.AddSubview(this.moviePlayer.View);
this.playbackStateChanged = MPMoviePlaybackController.Notifications.ObservePlaybackStateDidChange(this.MoviePlayer_PlaybackStateChanged);
this.finishedPlaying = MPMoviePlaybackController.Notifications.ObservePlaybackDidFinish(this.MoviePlayer_FinishedPlayback);
this.btnPlayVideo.TouchUpInside += delegate {
  this.moviePlayer.Play();
} ;</pre></div></li><li class="listitem">Enter the following methods in the <code class="literal">MainController</code> class:<div class="informalexample"><pre class="programlisting">private void MoviePlayer_PlaybackStateChanged(object sender, NSNotificationEventArgs e)
{
  Console.WriteLine("Movie player load state changed: {0}", this.moviePlayer.PlaybackState);
}
private void MoviePlayer_FinishedPlayback(object sender, 
  NSNotificationEventArgs e)
{
  Console.WriteLine("Movie player finished playing.");
}</pre></div></li><li class="listitem">Compile <a id="id443" class="indexterm"/>and run the app on the simulator. Tap on the button and the video will load and start playing. Watch the messages displayed in the <span class="strong"><strong>Application Output</strong></span> pad in Xamarin Studio. The following screenshot shows us the video that is playing on the simulator:<div class="mediaobject"><img src="graphics/8924OT_07_03.jpg" alt="How to do it..."/></div></li></ol></div></div><div class="section" title="How it works..."><div class="titlepage"><div><div><h2 class="title"><a id="ch07lvl2sec242"/>How it works...</h2></div></div></div><p>The <code class="literal">MPMoviePlayerController</code> controller plays video files stored locally or streamed from the network. We initialize the controller with the constructor that accepts an <code class="literal">NSUrl</code> parameter, as<a id="id444" class="indexterm"/> shown in the following code:</p><div class="informalexample"><pre class="programlisting">this.moviePlayer = new MPMoviePlayerController(NSUrl.FromFilename("video.mov"));</pre></div><p>The <code class="literal">NSUrl</code> class is the standard iOS class for URLs.</p><p>After creating the instance, we define a frame for its view and add it to our view by using the following code:</p><div class="informalexample"><pre class="programlisting">this.moviePlayer.View.Frame = new RectangleF(0f, 20f, this.View.Frame.Width, 320f);
this.View.AddSubview(this.moviePlayer.View);</pre></div><p>The highlighted code in the preceding section adds observers to the default notification center so that we will be notified when the state of the playback changes or finishes. Then, we call its <code class="literal">Play</code> method and the <code class="literal">MPMoviePlayerController</code> controller's view is displayed, and the video starts playing.</p><p>Inside the <code class="literal">MoviePlayer_PlaybackStateChanged</code> method, we output the <code class="literal">PlaybackState</code> property by using the following code:</p><div class="informalexample"><pre class="programlisting">Console.WriteLine("Movie player load state changed: {0}", this.moviePlayer.PlaybackState);</pre></div><p>This property informs us about the status of the playback, for example, <code class="literal">Paused</code>, <code class="literal">Playing</code>, <code class="literal">SeekingForward</code>, and <code class="literal">SeekingBackward</code>.</p></div><div class="section" title="There's more..."><div class="titlepage"><div><div><h2 class="title"><a id="ch07lvl2sec243"/>There's more...</h2></div></div></div><p>Apart from the <a id="id445" class="indexterm"/>ones used in this example, we can add observers for more notifications of an <code class="literal">MPMoviePlayerController</code> controller, some of which are as follows:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><code class="literal">DidEnterFullscreenNotification</code>: This notifies us that the user has tapped the<a id="id446" class="indexterm"/> fullscreen control and the controller has entered the fullscreen mode</li><li class="listitem" style="list-style-type: disc"><code class="literal">DidExitFullscreenNotification</code>: It notifies that the controller has left fullscreen<a id="id447" class="indexterm"/> mode</li><li class="listitem" style="list-style-type: disc"><code class="literal">DurationAvailableNotification</code>: This notifies us that the controller has received<a id="id448" class="indexterm"/> information on the duration of the video</li><li class="listitem" style="list-style-type: disc"><code class="literal">LoadStateDidChangeNotification</code>: This is useful for network playback; it is <a id="id449" class="indexterm"/>triggered when the controller has finished preloading the media in the buffer</li><li class="listitem" style="list-style-type: disc"><code class="literal">NaturalSizeAvailableNotification</code>: This is triggered when the dimensions <a id="id450" class="indexterm"/>of the movie frame are made available. The size can be retrieved through <a id="id451" class="indexterm"/>the player's <code class="literal">NaturalSize</code> property</li><li class="listitem" style="list-style-type: disc"><code class="literal">NowPlayingMovieDidChangeNotification</code>: This is triggered when the video <a id="id452" class="indexterm"/>content of the player has changed. The current content is available through its <code class="literal">ContentUrl</code> property</li></ul></div><div class="section" title="Wireless streaming"><div class="titlepage"><div><div><h3 class="title"><a id="ch07lvl3sec61"/>Wireless streaming</h3></div></div></div><p>Starting <a id="id453" class="indexterm"/>from iOS Version 4.3, <code class="literal">MPMoviePlayerController</code> can be used to stream video to Apple's AirPlay-enabled devices. To enable wireless streaming, set the <code class="literal">MPMoviePlayerController</code> instance's <code class="literal">AllowsAirPlay</code> property to <code class="literal">true</code>. When <code class="literal">controller</code> is displayed, it will present an interface that will allow the user to select the devices it detects.</p></div></div><div class="section" title="See also"><div class="titlepage"><div><div><h2 class="title"><a id="ch07lvl2sec244"/>See also</h2></div></div></div><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">The <span class="emphasis"><em>Playing music and sounds</em></span> recipe</li></ul></div></div></div>
<div class="section" title="Playing music and sounds"><div class="titlepage"><div><div><h1 class="title"><a id="ch07lvl1sec63"/>Playing music and sounds</h1></div></div></div><p>In this recipe, we <a id="id454" class="indexterm"/>will learn how to play both simple audio files and songs stored on the device.</p><div class="section" title="Getting ready"><div class="titlepage"><div><div><h2 class="title"><a id="ch07lvl2sec245"/>Getting ready</h2></div></div></div><p>Create a new <span class="strong"><strong>Single View Application</strong></span> in Xamarin Studio and name it <code class="literal">PlayMusicApp</code>.</p><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="note43"/>Note</h3><p>This example will not work on the simulator. You will also need at least one song stored on the device's iTunes library.</p></div></div></div><div class="section" title="How to do it..."><div class="titlepage"><div><div><h2 class="title"><a id="ch07lvl2sec246"/>How to do it...</h2></div></div></div><p>Perform the following steps:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Add three buttons to the view of the controller.</li><li class="listitem">Add the following <code class="literal">using</code> directive in the <code class="literal">PlayMusicAppViewController.cs</code> file:<div class="informalexample"><pre class="programlisting">using MonoTouch.MediaPlayer;</pre></div></li><li class="listitem">Add the following two fields in the class:<div class="informalexample"><pre class="programlisting">private MPMusicPlayerController musicPlayer;
private MPMediaPickerController mediaPicker;</pre></div></li><li class="listitem">Add the following code in the <code class="literal">ViewDidLoad</code> method:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>this.mediaPicker = new MPMediaPickerController(MPMediaType.Music);</strong></span>
<span class="strong"><strong>this.mediaPicker.ItemsPicked += MediaPicker_ItemsPicked;</strong></span>
<span class="strong"><strong>this.mediaPicker.DidCancel += MediaPicker_DidCancel;</strong></span>
<span class="strong"><strong>this.musicPlayer = </strong></span>
<span class="strong"><strong>  MPMusicPlayerController.ApplicationMusicPlayer;</strong></span>
this.btnSelect.TouchUpInside += async (s, e) =&gt; {
  await this.PresentViewControllerAsync(this.mediaPicker, true);
} ;
this.btnPlay.TouchUpInside += (s, e) =&gt; {
  this.musicPlayer.Play();
} ;
this.btnStop.TouchUpInside += (s, e) =&gt; {
  this.musicPlayer.Stop();
} ;</pre></div></li><li class="listitem">Add the<a id="id455" class="indexterm"/> following methods in the class:<div class="informalexample"><pre class="programlisting">private async void MediaPicker_ItemsPicked (object sender, ItemsPickedEventArgs e)
{
  this.musicPlayer.SetQueue(e.MediaItemCollection);
  await this.DismissViewControllerAsync(true);
}
private async void MediaPicker_DidCancel (object sender, EventArgs e)
{
  await this.mediaPicker.DismissViewControllerAsync(true);
}</pre></div></li><li class="listitem">Compile and run the app on the device. Tap the <span class="strong"><strong>Select songs</strong></span> button and select one or more songs.</li></ol></div></div><div class="section" title="How it works..."><div class="titlepage"><div><div><h2 class="title"><a id="ch07lvl2sec247"/>How it works...</h2></div></div></div><p>The <code class="literal">MPMediaPickerController</code> controller provides the same user interface as the native <span class="emphasis"><em>Music</em></span> app for selecting songs. The <code class="literal">MPMusicPlayerController</code> controller is responsible for playing the songs stored on the device.</p><p>We first initialize the media picker, passing the type of media we want it to look for in its constructor by using the following code:</p><div class="informalexample"><pre class="programlisting">this.mediaPicker = new MPMediaPickerController(MPMediaType.Music);</pre></div><p>After this, we subscribe to its <code class="literal">ItemsPicked</code> and <code class="literal">DidCancel</code> events so that we can capture the feedback from the user by using the following code:</p><div class="informalexample"><pre class="programlisting">this.mediaPicker.ItemsPicked += MediaPicker_ItemsPicked;
this.mediaPicker.DidCancel += MediaPicker_DidCancel;</pre></div><p>The highlighted code in the preceding section shows us how to initialize the music player object. The option demonstrated here, <code class="literal">MPMusicPlayerController.ApplicationMusicPlayer</code>, creates an<a id="id456" class="indexterm"/> instance that is specific only to the app. The other option that is available, <code class="literal">MPMusicPlayerController.iPodMusicPlayer</code>, creates an instance that allows the media to be played even if the app is in the background, similar to the native <span class="emphasis"><em>Music</em></span> app.</p><p>In the <code class="literal">MediaPicker_ItemsPicked</code> handler, we set the songs that were picked by the user to the music player through its <code class="literal">SetQueue</code> method, as shown in the following code:</p><div class="informalexample"><pre class="programlisting">this.musicPlayer.SetQueue(e.MediaItemCollection);</pre></div><p>After this, we dismiss the modal media picker controller. Playing and stopping songs is achieved through the <code class="literal">Play()</code> and <code class="literal">Stop()</code> methods of <code class="literal">MPMusicPlayerController</code>, respectively.</p></div><div class="section" title="There's more..."><div class="titlepage"><div><div><h2 class="title"><a id="ch07lvl2sec248"/>There's more...</h2></div></div></div><p>
<code class="literal">MPMusicPlayerController</code> holds information on the item that is being played currently. This information can be accessed through its <code class="literal">NowPlayingItem</code> property. It is of the <code class="literal">MPMediaItem</code> type and holds various types of information of the media that is being played currently. The following example outputs the title of the song that is being played:</p><div class="informalexample"><pre class="programlisting">Console.WriteLine(this.musicPlayerController.NowPlayingItem.ValueForProperty(MPMediaItem.TitleProperty));</pre></div><div class="section" title="Playing sound files"><div class="titlepage"><div><div><h3 class="title"><a id="ch07lvl3sec62"/>Playing sound files</h3></div></div></div><p>The <code class="literal">MPMusicPlayerController</code> controller is an object that is specifically designed to manage and <a id="id457" class="indexterm"/>play items and playlists stored on the device's music library.</p><p>To play simple sound files, Xamarin.iOS provides another wrapper to the iOS's class, <code class="literal">AVAudioPlayer</code>. The following code is an example of its most simple usage:</p><div class="informalexample"><pre class="programlisting">using MonoTouch.AVFoundation;
//...
AVAudioPlayer audioPlayer = AVAudioPlayer.FromUrl(new NSUrl("path/to/sound file"));
audioPlayer.Play();</pre></div></div></div><div class="section" title="See also"><div class="titlepage"><div><div><h2 class="title"><a id="ch07lvl2sec249"/>See also</h2></div></div></div><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">The <span class="emphasis"><em>Playing videos</em></span> recipe</li></ul></div></div></div>
<div class="section" title="Recording with the microphone"><div class="titlepage"><div><div><h1 class="title"><a id="ch07lvl1sec64"/>Recording with the microphone</h1></div></div></div><p>In this recipe, we will learn how to use the device's microphone to record sounds.</p><div class="section" title="Getting ready"><div class="titlepage"><div><div><h2 class="title"><a id="ch07lvl2sec250"/>Getting ready</h2></div></div></div><p>Create a <a id="id458" class="indexterm"/>new project in Xamarin Studio and name it <code class="literal">RecordSoundApp</code>.</p><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="note44"/>Note</h3><p>This <a id="id459" class="indexterm"/>example will not work on the simulator.</p></div></div></div><div class="section" title="How to do it..."><div class="titlepage"><div><div><h2 class="title"><a id="ch07lvl2sec251"/>How to do it...</h2></div></div></div><p>Perform the following steps:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Add two buttons and a label to the view of the controller. </li><li class="listitem">Enter the following <code class="literal">using</code> directives in the <code class="literal">RecordSoundAppViewController.cs</code> file:<div class="informalexample"><pre class="programlisting">using System.IO;
using MonoTouch.AVFoundation;
using MonoTouch.AudioToolbox;</pre></div></li><li class="listitem">Override the <code class="literal">ViewDidLoad</code> method and add the following code to it:<div class="informalexample"><pre class="programlisting">NSUrl soundFileUrl = null;
NSError error = null;
AVAudioSession session = AVAudioSession.SharedInstance();
session.SetCategory(AVAudioSession.CategoryPlayAndRecord, out error);
session.SetActive(true, out error);
bool grantedPermission = false;
session.RequestRecordPermission((granted) =&gt; {
  if (granted) {
    grantedPermission = true;
    string soundFile = Path.Combine(Environment.GetFolderPath(Environment.SpecialFolder.Personal), "sound.wav");
    soundFileUrl = new NSUrl(soundFile);
    NSDictionary recordingSettings = NSDictionary.FromObjectAndKey(AVAudioSettings.AVFormatIDKey, NSNumber.FromInt32((int)AudioFileType.Wave));
    this.audioRecorder = AVAudioRecorder.ToUrl(soundFileUrl, recordingSettings, out error);
  } else {
    this.lblStatus.Text = "Permission to microphone refused";
  }
});

this.btnStart.TouchUpInside += (s, e) =&gt; {
  if (grantedPermission) {
    this.audioRecorder.Record();
    this.lblStatus.Text = "Recording…";
  }
};
this.btnStop.TouchUpInside += (s, e) =&gt; {
  if (grantedPermission) {
    this.audioRecorder.Stop();
   this.lblStatus.Text = "Idle";
    AVAudioPlayer player = AVAudioPlayer.FromUrl(soundFileUrl);
    player.Play();
  }
};</pre></div></li><li class="listitem">Compile <a id="id460" class="indexterm"/>and run the app on the device. Tap <a id="id461" class="indexterm"/>the <span class="strong"><strong>Start</strong></span> recording button to start recording the audio, for example, say something in order to record your voice. Tap the <span class="strong"><strong>Stop</strong></span> <span class="strong"><strong>recording</strong></span> button to stop recording and listen to the playback.</li></ol></div></div><div class="section" title="How it works..."><div class="titlepage"><div><div><h2 class="title"><a id="ch07lvl2sec252"/>How it works...</h2></div></div></div><p>The <code class="literal">AVAudioRecorder</code> class provides the recording functionality. It does this by streaming the captured audio directly to the filesystem. Prior to starting the actual recording, we need to prepare the shared audio session by using the following code:</p><div class="informalexample"><pre class="programlisting">NSError error = null;
AVAudioSession session = AVAudioSession.SharedInstance();
session.SetCategory(AVAudioSession.CategoryPlayAndRecord, out error);
session.SetActive(true, out error);</pre></div><p>We need to adjust the audio session according to our app's needs so that the system <span class="emphasis"><em>knows</em></span> how to handle the audio from other sources. By setting the category to <code class="literal">AVAudioSession.CategoryPlayAndRecord</code>, we state that our app will be able to play back the audio while it is getting recorded.</p><p>The first time we set the shared audio session's category to any value that requires the usage of the microphone, iOS automatically prompts the user to give permission to the app. By calling the <code class="literal">RequestRecordPermission</code> method, we can determine whether the user has granted microphone access to our app, as shown in the following code:</p><div class="informalexample"><pre class="programlisting">session.RequestRecordPermission((granted) =&gt; {
  if (granted) {
    grantedPermission = true;
    //..</pre></div><p>Now that <a id="id462" class="indexterm"/>we have prepared the shared audio session, it's<a id="id463" class="indexterm"/> time to initialize an instance of <code class="literal">AVAudioRecorder</code> by using the following code:</p><div class="informalexample"><pre class="programlisting">this.audioRecorder = AVAudioRecorder.ToUrl(soundFileUrl, recordingSettings, out error);</pre></div><p>If the file that corresponds to the <code class="literal">NSUrl</code> variable already exists, it will be overwritten.</p><p>The <code class="literal">recordingSettings</code> variable is of the <code class="literal">NSDictionary</code> type and contains the settings for the output sound file. We must provide at least some minimal settings to the <code class="literal">AVAudioRecorder</code> upon the initialization. Here, we set the sound format to plain WAV by using the following code:</p><div class="informalexample"><pre class="programlisting">NSDictionary recordingSettings = NSDictionary.FromObjectAndKey(AVAudioSettings.AVFormatIDKey, NSNumber.FromInt32((int)AudioFileType.WAVE));</pre></div><p>To instruct the recorder to start recording, we just call its <code class="literal">Record()</code> method by using the following line of code:</p><div class="informalexample"><pre class="programlisting">this.audioRecorder.Record();</pre></div><p>When the user taps on the <span class="strong"><strong>Stop recording</strong></span> button, the recording stops and the saved sound starts playing with the <code class="literal">AVAudioPlayer</code>:</p><div class="informalexample"><pre class="programlisting">this.audioRecorder.Stop();
AVAudioPlayer player = AVAudioPlayer.FromUrl(soundFileUrl);
player.Play();</pre></div></div><div class="section" title="There's more..."><div class="titlepage"><div><div><h2 class="title"><a id="ch07lvl2sec253"/>There's more...</h2></div></div></div><p>The <code class="literal">AVAudioRecorder</code> class provides sound metering options as well. To enable the sound metering, set its <code class="literal">MeteringEnabled</code> property to <code class="literal">true</code>. We can then output the peak power in decibels on a specific channel. To do this for the first channel of our recording, add the following code right after the <code class="literal">Record()</code> method call:</p><div class="informalexample"><pre class="programlisting">ThreadPool.QueueUserWorkItem(delegate {
  while (this.audioRecorder.Recording)
  {
    this.audioRecorder.UpdateMeters();
    Console.WriteLine(this.audioRecorder.PeakPower(0));
  }
} );</pre></div><p>The <code class="literal">PeakPower</code> method accepts the zero-based index of the channel and returns the peak of the <a id="id464" class="indexterm"/>channel in decibels. Call <code class="literal">UpdateMeters()</code> right<a id="id465" class="indexterm"/> before calling the <code class="literal">PeakPower</code> method to get the most recent reading.</p><p>Note that enabling the metering on the recorder requires using the CPU resources. Do not enable it if you do not intend on using the metering values.</p><div class="section" title="Recording for a predefined amount of time"><div class="titlepage"><div><div><h3 class="title"><a id="ch07lvl3sec63"/>Recording for a predefined amount of time</h3></div></div></div><p>To record <a id="id466" class="indexterm"/>the audio for a predefined amount of time without the need for the user to stop the recording, call the <code class="literal">RecordFor(double)</code> method. Its parameter is the amount of time in seconds for which we want to record.</p></div></div><div class="section" title="See also"><div class="titlepage"><div><div><h2 class="title"><a id="ch07lvl2sec254"/>See also</h2></div></div></div><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">The <span class="emphasis"><em>Playing music and sounds</em></span> recipe</li></ul></div></div></div>
<div class="section" title="Managing album items directly"><div class="titlepage"><div><div><h1 class="title"><a id="ch07lvl1sec65"/>Managing album items directly</h1></div></div></div><p>In this recipe, we will discuss how to programmatically access the device's photo album.</p><div class="section" title="Getting ready"><div class="titlepage"><div><div><h2 class="title"><a id="ch07lvl2sec255"/>Getting ready</h2></div></div></div><p>Create a <a id="id467" class="indexterm"/>new <span class="strong"><strong>Single View Application</strong></span> in Xamarin Studio and name it <code class="literal">ManageAlbumApp</code>.</p><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="note45"/>Note</h3><p>This example works on the simulator. At least one image must exist in the simulator's photo album.</p></div></div></div><div class="section" title="How to do it..."><div class="titlepage"><div><div><h2 class="title"><a id="ch07lvl2sec256"/>How to do it...</h2></div></div></div><p>Perform the following steps:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Add a button on the main view of the controller. </li><li class="listitem">Enter the following <code class="literal">using</code> directive in the <code class="literal">MainController.cs</code> file:<div class="informalexample"><pre class="programlisting">using MonoTouch.AssetsLibrary;</pre></div></li><li class="listitem">Add the following code in the <code class="literal">ViewDidLoad</code> method:<div class="informalexample"><pre class="programlisting">this.btnEnumerate.TouchUpInside += (s, e) =&gt; {
  if (ALAssetsLibrary.AuthorizationStatus == ALAuthorizationStatus.Authorized ||
    ALAssetsLibrary.AuthorizationStatus == ALAuthorizationStatus.NotDetermined) {
    this.assetsLibrary = new ALAssetsLibrary();
    this.assetsLibrary.Enumerate(ALAssetsGroupType.All, this.GroupsEnumeration, this.GroupsEnumerationFailure);
  }
} ;</pre></div></li><li class="listitem">Add the <a id="id468" class="indexterm"/>following methods in the class:<div class="informalexample"><pre class="programlisting">private void GroupsEnumeration(ALAssetsGroup assetGroup, ref bool stop)
{
  if (null != assetGroup)
  {
    stop = false;
    assetGroup.SetAssetsFilter(ALAssetsFilter.AllPhotos);
    assetGroup.Enumerate(this.AssetEnumeration);
  }
}
private void AssetEnumeration(ALAsset asset, int index, ref bool stop)
{
  if (null != asset)
  {
    stop = false;
    Console.WriteLine("Asset url: {0}", asset.DefaultRepresentation.Url.AbsoluteString);
  }
}
private void GroupsEnumerationFailure(NSError error)
{
  if (null != error)
  {
    Console.WriteLine("Error enumerating asset groups! Message: {0}", error.LocalizedDescription);
  }
}</pre></div></li><li class="listitem">Compile and run the app. Tap the <span class="strong"><strong>Enumerate</strong></span> button and watch the URLs of the saved photos get displayed in the <span class="strong"><strong>Application Output </strong></span>pad.</li></ol></div></div><div class="section" title="How it works..."><div class="titlepage"><div><div><h2 class="title"><a id="ch07lvl2sec257"/>How it works...</h2></div></div></div><p>The <code class="literal">ALAssetsLibrary</code> class provides access to the album items of the device. These items are represented by the <code class="literal">ALAsset</code> class and are divided into groups, represented by the <code class="literal">ALAssetGroup</code> class.</p><p>The first thing we need to do is enumerate the asset groups. To do this, call the <code class="literal">Enumerate</code> method by using the following code:</p><div class="informalexample"><pre class="programlisting">this.assetsLibrary.Enumerate(ALAssetsGroupType.All, this.GroupsEnumeration, this.GroupsEnumerationFailure);</pre></div><p>The first <a id="id469" class="indexterm"/>parameter is of the <code class="literal">ALAssetGroupTypes</code> type, and it instructs the assets library on the asset groups to be enumerated. Passing <code class="literal">ALAssetGroupTypes.All</code> means that we want to enumerate all the asset groups. The other two parameters are delegate types. The <code class="literal">GroupsEnumeration</code> method is where we read the group's data, while the <code class="literal">GroupsEnumerationFailure</code> method will be triggered if an error occurs. When the <code class="literal">Enumerate</code> method is called for the first time, the user is asked to grant access to the app to access the device's assets. If the user denies the access, the failure method will be triggered. The next time the <code class="literal">Enumerate</code> method gets called, the access message appears again.</p><p>The signature of the <code class="literal">GroupsEnumeration</code> method is as follows:</p><div class="informalexample"><pre class="programlisting">private void GroupsEnumeration(ALAssetsGroup assetGroup, ref bool stop)</pre></div><p>The <code class="literal">assetGroup</code> parameter contains the group's information.</p><p>Note the <code class="literal">stop</code> parameter, which is declared as a <code class="literal">ref</code> parameter. When the enumeration occurs, the method is being triggered once to return the first group and does not get called for the second time, no matter how many more groups exist. To force it to keep getting called to enumerate all the groups, we have to set the <code class="literal">stop</code> variable to <code class="literal">false</code>. When all groups have been enumerated, the method gets called one last time, with the <code class="literal">assetGroup</code> variable set to <code class="literal">null</code>. So we need to check this. To put all this in code, take a look at the following example:</p><div class="informalexample"><pre class="programlisting">if (null != assetGroup)
{
  // Continue enumerating
  stop = false;
  // Determine what assets to enumerate
  assetGroup.SetAssetsFilter(ALAssetsFilter.AllPhotos);
  // Enumerate assets
  assetGroup.Enumerate(this.AssetEnumeration);
}</pre></div><p>After calling the <code class="literal">SetAssetsFilter</code> method on the instance of the <code class="literal">ALAssetGroup</code> class, we instruct it to filter what types of assets we want it to look for. After this, the process becomes similar to the group's enumeration. The <code class="literal">ALAssetGroup</code> class also contains an <code class="literal">Enumerate</code> method. It accepts a parameter of a delegate type, represented here by the <code class="literal">AssetsEnumeration</code> method. Its implementation is similar to the <code class="literal">GroupsEnumeration</code> method, as <a id="id470" class="indexterm"/>shown in the following code:</p><div class="informalexample"><pre class="programlisting">if (null != asset)
{
  // Continue enumerating assets
  stop = false;
  // Output the asset url
  Console.WriteLine("Asset url: {0}", asset.DefaultRepresentation.Url.AbsoluteString);
}</pre></div><p>The <code class="literal">ALAsset</code> class contains various kinds of information and properties. Most of the information is stored in its <code class="literal">DefaultRepresentation</code> property, which is of the <code class="literal">ALAssetRepresentation</code> type.</p></div><div class="section" title="There's more..."><div class="titlepage"><div><div><h2 class="title"><a id="ch07lvl2sec258"/>There's more...</h2></div></div></div><p>If the asset we are interested in is an image, we can get the actual image through the <code class="literal">DefaultRepresentation</code> property by using the following code:</p><div class="informalexample"><pre class="programlisting">CGImage image = asset.DefaultRepresentation.GetImage();</pre></div><div class="section" title="Reading EXIF data"><div class="titlepage"><div><div><h3 class="title"><a id="ch07lvl3sec64"/>Reading EXIF data</h3></div></div></div><p>We can<a id="id471" class="indexterm"/> read a photo's <span class="strong"><strong>EXchangeable Image File</strong></span> (<span class="strong"><strong>EXIF</strong></span>) format<a id="id472" class="indexterm"/> metadata through the <code class="literal">Metadata</code> property of <code class="literal">ALAssetRepresentation</code>, which is of the <code class="literal">NSDictionary</code> type, as shown in the following code:</p><div class="informalexample"><pre class="programlisting">NSDictionary metaData = asset.DefaultRepresentation.Metadata;
if (null != metaData)
{
  NSDictionary exifData = (NSDictionary)metaData[new NSString("{Exif}")];
}</pre></div></div><div class="section" title="Retrieving individual assets"><div class="titlepage"><div><div><h3 class="title"><a id="ch07lvl3sec65"/>Retrieving individual assets</h3></div></div></div><p>We can<a id="id473" class="indexterm"/> also retrieve an individual asset, if we know the asset's URL, through the <code class="literal">AssetForUrl</code> method of <code class="literal">ALAssetLibrary</code>.</p></div><div class="section" title="Checking for permission"><div class="titlepage"><div><div><h3 class="title"><a id="ch07lvl3sec66"/>Checking for permission</h3></div></div></div><p>We can check <a id="id474" class="indexterm"/>whether the user has granted access to the asset library through the <code class="literal">ALAssetsLibrary.AuthorizationStatus</code> static property. The possible values of the <code class="literal">ALAuthorizationStatus</code> enumeration are the following:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><code class="literal">Authorized</code>: This means that the user has authorized our app.</li><li class="listitem" style="list-style-type: disc"><code class="literal">Denied</code>: This means that the user has denied access to the albums.</li><li class="listitem" style="list-style-type: disc"><code class="literal">NotDetermined</code>: This means that our app never requested access to the albums.</li><li class="listitem" style="list-style-type: disc"><code class="literal">Restricted</code>: This means that the app is not authorized to access the albums and the user cannot grant access, possibly due to parental restrictions.</li></ul></div><p>Note that accessing the <code class="literal">AuthorizationStatus</code> property does not prompt the user for permission. When we actually try to access the library in this example, by calling the <code class="literal">Enumerate</code> method, is when iOS prompts the user for permission.</p></div></div><div class="section" title="See also"><div class="titlepage"><div><div><h2 class="title"><a id="ch07lvl2sec259"/>See also</h2></div></div></div><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">The <span class="emphasis"><em>Selecting images and videos</em></span> recipe</li></ul></div></div></div></body></html>