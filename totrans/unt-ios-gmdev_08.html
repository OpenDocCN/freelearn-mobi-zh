<html><head></head><body><div class="chapter" title="Chapter&#xA0;8.&#xA0;Multimedia"><div class="titlepage"><div><div><h1 class="title"><a id="ch08"/>Chapter 8. Multimedia</h1></div></div></div><div class="blockquote"><blockquote class="blockquote"><p>Now that we have spent some time exploring the gameplay components of our game and building systems for control, we need to spend some time examining the components of the game that deal with video and audio. Things such as background music, the sounds of enemies, and playing movies are important parts that our game needs.<a id="id371" class="indexterm"/>
</p></blockquote></div><p>In this chapter we shall:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">Learn to play background music</li><li class="listitem" style="list-style-type: disc">Learn how to add ambient sounds</li><li class="listitem" style="list-style-type: disc">Learn how to play movies that are embedded in the application</li><li class="listitem" style="list-style-type: disc">Learn how to stream movies from remote locations</li></ul></div><p>So let's get on with it...</p><div class="section" title="Important preliminary points"><div class="titlepage"><div><div><h1 class="title"><a id="ch08lvl1sec01"/>Important preliminary points</h1></div></div></div><p>This chapter assumes that you have some understanding of compressed audio formats such as MP3 and OGG, as well as video formats such as MP4. Further, it assumes that you know how to create this content using your favorite tools.<a id="id372" class="indexterm"/>
</p></div></div>
<div class="section" title="Audio capabilities"><div class="titlepage"><div><div><h1 class="title"><a id="ch08lvl1sec02"/>Audio capabilities</h1></div></div></div><p>Our game is very quiet right now. Even though we can see the actions of our player, we cannot hear what the player is doing — nor do we have a feel for the environment itself. We want to add some sounds that will exist in the environment and we want to provide some feedback when things happen in the game.<a id="id373" class="indexterm"/>
</p><div class="section" title="Playing sounds"><div class="titlepage"><div><div><h2 class="title"><a id="ch08lvl2sec01"/>Playing sounds</h2></div></div></div><p>As discussed in the Unity Fundamentals, all audio that is played is done so from the perspective of the AudioListener. So, if we want to have something in our game make noise, we simply need to add an AudioSource to that GameObject and we will get a sound. In our design we call for having ambient sounds in the environment.<a id="id374" class="indexterm"/>
</p></div></div>
<div class="section" title="Time for action &#x2014; Adding ambient sounds"><div class="titlepage"><div><div><h1 class="title"><a id="ch08lvl1sec03"/>Time for action —  Adding ambient sounds</h1></div></div></div><p>While we're in our town we want it to sound like a town that is in the middle of the forest. To accomplish this we should have some ambient sound that is low volume that just blends in to the environment. A good source of Creative Commons licensed sounds is The Freesound Project which can be found at<a class="ulink" href="http://www.freesound.org"> http://www.freesound.org</a>. There are a number of good candidates on the site and I have picked up one from user reinsamba for this test. You will find a copy of it in the assets folder of the project called<code class="literal"> evening in the forest.wav</code>.<a id="id375" class="indexterm"/>
</p><div class="orderedlist"><ol class="orderedlist"><li class="listitem">To keep your assets organized create an<code class="literal"> Ambient Audio</code> folder in your project.</li><li class="listitem">Simply drag the asset, an<code class="literal"> evening in the forest.wav</code> file in this case, into the project and Unity will perform the necessary conversion:<div class="mediaobject"><img src="graphics/978-1-84969-040-9_8_1.jpg" alt="Time for action — Adding ambient sounds"/></div><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: none">Now you have a usable AudioSource that can be added to other GameObjects in the scene. But remember, Unity will not distort the assets unless we tell it to by changing some properties of the original audio file. We brought in a fairly sizable AudioSource as a <code class="literal">.wav
</code> file.<a id="id376" class="indexterm"/></li></ul></div></li><li class="listitem">Tell Unity to compress this asset by selecting<span class="strong"><strong> Compressed</strong></span> from the<span class="strong"><strong> Audio Format</strong></span> option so that the file doesn't take up as much space. Also, check the<span class="strong"><strong> Hardware decoding</strong></span> checkbox so that Unity will use the iOS hardware built into an iOS device:<div class="mediaobject"><img src="graphics/978-1-84969-040-9_8_2.jpg" alt="Time for action — Adding ambient sounds"/></div><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: none">If hardware isn't available, Unity will automatically fall back to software decoding. In our case here we are going from a 26.2MB Wav file to a 0.6MB compressed MP3 file. If you want a higher quality sample you can adjust the Compression slider to a higher value, but in our case this is simple ambient noise so we don't need an excessive amount of fidelity.<p>Now that we have created the AudioSource we need to attach it to a GameObject so that it will play. Since this is the sound of the environment, we can attach this to the ground that the player will walk around on.
</p></li></ul></div></li><li class="listitem">Simply drag the Audio source onto the ground in the<span class="strong"><strong> Scene</strong></span> view, or drag it over to the ground in the<span class="strong"><strong> Hierarchy</strong></span> view. Either will result in an AudioSource Component being added to the ground.</li><li class="listitem">Ensure that the audio continues to play by selecting the<span class="strong"><strong> Loop</strong></span> option from the<span class="strong"><strong> Audio Source properties</strong></span> in the<span class="strong"><strong> Inspector:</strong></span></li></ol></div><div class="mediaobject"><img src="graphics/978-1-84969-040-9_8_3.jpg" alt="Time for action — Adding ambient sounds"/></div><p>We have told this AudioSource to loop its audio so we should hear this audio clip for the duration of the game while we're on this ground GameObject. One special note about compressed audio in iOS is that the compression process may tweak the beginning or end of your audio data, so you will want to listen to it after compressing it to make sure that it still loops properly.<a id="id377" class="indexterm"/>
</p><p>We didn't necessarily have to attach the sound to the ground, we could have attached it to a different object. For example, if we wanted to give a marketplace the sounds of marketplace chatter we could attach that directly to the GameObject that represents the marketplace and when the player walks away from it, the sound would diminish.</p><div class="section" title="What just happened?"><div class="titlepage"><div><div><h2 class="title"><a id="ch08lvl2sec02"/>What just happened?</h2></div></div></div><p>We just created an ambient sound track for our world. By importing a<code class="literal"> .wav</code> file and compressing it we have integrated an asset that is suitable for use on our mobile platform and can use the iOS device hardware to decompress the audio stream. Since we've attached this AudioSource to the ground of our world, we can be certain that it will be audible as we move through our environment. With this we have created some atmosphere for our world and given this area of the world a personality.<a id="id378" class="indexterm"/>
</p></div></div>
<div class="section" title="Time for action &#x2014; Adding sounds to actions"><div class="titlepage"><div><div><h1 class="title"><a id="ch08lvl1sec04"/>Time for action —  Adding sounds to actions</h1></div></div></div><p>While we have created some background ambient sounds, we still don't have any sounds for actions that take place in the game. For example, if we use our ranged attack swipe gesture and throw something, our player should make some sound as he is going through the throw animation and the thrown object should make a sound if it hits the ground — or some other object.<a id="id379" class="indexterm"/>
</p><p>Let's import a simple sound that we will play when the player is going to throw something for their range attack. Once again I have utilized a Creative Commons Licensed sound from<a class="ulink" href="http://www.freesound.org"> www.freesound.org</a>. The author of this sound is Sruddi1 and I have sampled the sound to contain a single grunt that will be the sound our character makes when they perform a ranged attack. I have compressed this sound similar to the steps used when importing our ambient sound:</p><div class="mediaobject"><img src="graphics/978-1-84969-040-9_8_4.jpg" alt="Time for action — Adding sounds to actions"/></div><p>Now all we need to do is associate this grunt sound with a scripted action that would be the user throwing something. Accomplishing this is a simple extension of some of the skills we learned earlier in the book. Remember, from the scripting section that we can pass variables to scripts and those objects can be references to things from Unity. We need to create a simple script that represents the action and expose a variable that will contain the sound.<a id="id380" class="indexterm"/>
</p><div class="informalexample"><pre class="programlisting">using UnityEngine;
using System.Collections;
public class ThrowSomething : MonoBehavior {
public AudioClip audioClip;
// Update is called once per frame
void Update () {
// perform the animation for throwing
animation.Play("throw", AnimationPlayMode.Mix);
// play the audio clip one time
//
audio.PlayOneShot( audioClip );
}
}
</pre></div><p>This script will now play the desired<code class="literal"> AudioClip</code> whenever it is invoked. All you have to do is drag an<code class="literal"> AudioClip</code> onto the component that you've attached this script to and that is what will be played:<a id="id381" class="indexterm"/>
</p><div class="mediaobject"><img src="graphics/978-1-84969-040-9_8_5.jpg" alt="Time for action — Adding sounds to actions"/></div><p>It is important to note that you don't necessarily have to attach an<code class="literal"> AudioClip</code> to an in-game object in order to play a sound. You can create a<code class="literal"> GameObject</code> on the fly when you want to play an<code class="literal"> AudioClip</code>. In fact, this is very useful if you want to create sounds on the fly as a result of detecting some event.</p><div class="informalexample"><pre class="programlisting">using UnityEngine;
using System.Collections;
public class AudioEngine
{
public AudioEngine ()
{
}
public AudioSource Play( AudioClip clip, Transform position )
{
return Play( clip, position, 1f, 1f );
}
public AudioSource Play(AudioClip clip, Vector3 point, float volume, float pitch)
{
//Create an empty game object
GameObject go = new GameObject("Audio: " + clip.name);
go.transform.position = point;
soundadding, to actions//Create the source
//
AudioSource source = go.AddComponent&lt;AudioSource&gt;();
source.clip = clip;
source.volume = volume;
source.pitch = pitch;
source.Play();
Destroy(go, clip.length);
return source;
}
}
</pre></div><p>So if we have installed this<code class="literal"> AudioEngine</code> to a<code class="literal"> GameObject</code> in the scene we can simply reference it and tell it to play the specific<code class="literal"> AudioClip</code> that we want to play and tell it where we want it to sound like it is positioned.</p><div class="section" title="What just happened?"><div class="titlepage"><div><div><h2 class="title"><a id="ch08lvl2sec03"/>What just happened?</h2></div></div></div><p>We have created a sound that will play whenever a user performs the ranged attack gesture. By updating our script which animates a player when the ranged attack gesture is detected, we have specified a new<code class="literal"> AudioClip</code> that we can play in our script by performing a simple scripting call. We can perform similar actions now when a player swings a sword, hits an enemy, and so on. We only need to expose an<code class="literal"> AudioClip</code> variable in those scripts and pass along the sound that we want to play.<a id="id383" class="indexterm"/>
</p></div><div class="section" title="Playing music"><div class="titlepage"><div><div><h2 class="title"><a id="ch08lvl2sec04"/>Playing music</h2></div></div></div><p>Playing music in Unity has some particular nuances to get it working properly. While it is true that music is just like any other sound, just that it has a relationship to the player's position in the scene.</p></div></div>
<div class="section" title="Time for action &#x2014; The sound of music"><div class="titlepage"><div><div><h1 class="title"><a id="ch08lvl1sec05"/>Time for action —  The sound of music</h1></div></div></div><p>In our application we want to have music playing constantly. We can accomplish this by attaching a<code class="literal"> GameObject</code> to the player or camera object and having the music play from there. If you attempt this, your sound system will play music just fine until the scene changes. As such, the primary difference between playing sound and building a music system is making sure that the music keeps playing.<a id="id384" class="indexterm"/>
</p><div class="orderedlist"><ol class="orderedlist"><li class="listitem">Create a folder called<code class="literal"> Music</code>.</li><li class="listitem">Import your favorite<code class="literal"> .mp3</code> file into the game project. In the project's sample files you will find the track Orc March by basematic. You can find other creative commons music at<a class="ulink" href="http://www.ccmixter.org/"> http://www.ccmixter.org/:</a><a id="id385" class="indexterm"/><div class="mediaobject"><img src="graphics/978-1-84969-040-9_8_12.jpg" alt="Time for action — The sound of music"/></div></li><li class="listitem">Create an empty Game Object called<span class="strong"><strong> MusicPlayer</strong></span> and make it the child of the<span class="strong"><strong> Main Camera:</strong></span><div class="mediaobject"><img src="graphics/978-1-84969-040-9_8_13.jpg" alt="Time for action — The sound of music"/></div></li><li class="listitem">Add an<span class="strong"><strong> Audio Source</strong></span> component to the<span class="strong"><strong> MusicPlayer</strong></span> Game Object.<a id="id386" class="indexterm"/></li><li class="listitem">Next, we need to ensure that our<span class="strong"><strong> MusicPlayer</strong></span> object does not get destroyed as we move between scenes, by creating a script in Unity that is attached to the next scene. To do this create a second scene in the game called<code class="literal"> scene_2</code>.</li><li class="listitem">Create a script called<code class="literal"> MusicPreserver</code> and fill it with the following code:<div class="informalexample"><pre class="programlisting">function Awake()
{
// find the music player object
var musicObject : GameObject = GameObject.Find("MusicPlayer");
// make sure we survive going to different scenes
DontDestroyOnLoad(musicObject);
}
</pre></div></li><li class="listitem">Attach the MusicPreserver script to the new scene.</li></ol></div><div class="section" title="What just happened?"><div class="titlepage"><div><div><h2 class="title"><a id="ch08lvl2sec05"/>What just happened?</h2></div></div></div><p>We can now play music in our game and have that music active as we move across scenes. This will give us the ability to set moods for areas of our game, yet give the flexibility of being able to change the scene data while the music continues to play.</p><p>By default, when Unity loads a new level or scene, all of the objects in the previous scene are destroyed (which would normally stop our music). The key to preserving the music is the<code class="literal"> DontDestroyOnLoad</code> method which will tell Unity to leave this Game Object alone when it is disposing of objects from the original scene. Now we can have real music sound tracks that span our entire game.<a id="id387" class="indexterm"/>
</p></div></div>
<div class="section" title="Video capabilities"><div class="titlepage"><div><div><h1 class="title"><a id="ch08lvl1sec06"/>Video capabilities</h1></div></div></div><p>iOS devices have standard hardware accelerated playback for H.264 encoded video. Apple exposes interfaces to play this content using the<code class="literal"> MPMoviePlayerController</code> class in the SDK. This class permits one to play a movie that is located on the device, or to stream one that is located at some arbitrary URL on the Internet. Unity exposes both of these methods in<code class="literal"> iPhoneUtils</code> using the<code class="literal"> PlayMovie</code> or<code class="literal"> PlayMovieURL</code> methods.<a id="id388" class="indexterm"/>
</p><p>iOS device video encoding is very specific, regardless of whether you are streaming video in the WebKit web browser using a UIWebView or doing it in Unity. The video must be compressed using the following compression standards:<a id="id389" class="indexterm"/>
</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">H.264 Baseline Profile Level 3.0 video</li><li class="listitem" style="list-style-type: disc">Support resolutions up to 640x480 at 30fps</li><li class="listitem" style="list-style-type: disc">B Frames are not supported in the Baseline Profile</li><li class="listitem" style="list-style-type: disc">MPEG-4 Part 2 video (Simple Profile)</li></ul></div><p>If you need some tools to help you create video that will work with iOS devices, you can examine the Quicktime Player itself and its video export options, as well as Handbrake. Handbrake (<a class="ulink" href="http://www.handbrake.fr">  http://www.handbrake.fr</a>) has specific profiles for encoding video for the iOS platform devices.</p></div>
<div class="section" title="Time for action &#x2014; Playing embedded video"><div class="titlepage"><div><div><h1 class="title"><a id="ch08lvl1sec07"/>Time for action —  Playing embedded video</h1></div></div></div><p>For our application design we are supposed to play an introduction movie when the application first starts. This video is normally some animated logo or similar and in our case it will be the Sojourner Mobile intro movie (sometimes referred to as an interstitial).<a id="id390" class="indexterm"/>
</p><p>I'm going to assume that you aren't a video engineer and don't know a lot about MPEG-4, H.264, or B Frames, but you have some content that you want to get into your iOS project. This is one thing that gives a lot of new developers trouble and results in video not displaying on the device.</p><p>We can avoid all of this drama by simply using a tool that was designed for producing content for iOS devices. One such tool that you can use for this is iMovie. It has functionality for exporting iOS device compliant video that you can use with your projects.</p><div class="orderedlist"><ol class="orderedlist"><li class="listitem">Import your content into iMovie and export it using the<span class="strong"><strong> Share</strong></span> menu:<div class="mediaobject"><img src="graphics/978-1-84969-040-9_8_7.jpg" alt="Time for action — Playing embedded video"/></div></li><li class="listitem">When prompted for the video type that you want to export to, choose the Mobile size and press the<span class="strong"><strong> Export</strong></span> button:<a id="id391" class="indexterm"/><div class="mediaobject"><img src="graphics/978-1-84969-040-9_8_8.jpg" alt="Time for action — Playing embedded video"/></div><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: none">Note that you can choose the Medium size as well, but since this is media that is being embedded into our game, and will count against our maximum application size, it is best to keep this content as small as possible so that you can keep it for other things such as game assets.<a id="id392" class="indexterm"/></li></ul></div></li><li class="listitem">Next we need to move the video into a special Unity assets folder called<code class="literal"> StreamingAssets</code>. Unity will copy the files in this directory into our application bundle and put them in the appropriate location on the device so we can play them back at runtime:<a id="id393" class="indexterm"/><div class="mediaobject"><img src="graphics/978-1-84969-040-9_8_6.jpg" alt="Time for action — Playing embedded video"/></div><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: none">Now that we have our asset in the game we need to play it. The best way to do this is to have a single scene that does nothing other than display our movie and then loads the IntroCity scene.</li></ul></div></li><li class="listitem">Let's create a new scene called<span class="strong"><strong> GameIntro</strong></span> that will serve this purpose:<div class="mediaobject"><img src="graphics/978-1-84969-040-9_8_9.jpg" alt="Time for action — Playing embedded video"/></div></li><li class="listitem">Now that we have our<span class="strong"><strong> GameIntro</strong></span> scene we can create an empty<span class="strong"><strong> GameObject</strong></span> and attach a script to it that will play our movie and load the next level after it's over.<a id="id394" class="indexterm"/></li><li class="listitem">Now, all we need is a simple script that we can attach to this<span class="strong"><strong> GameObject</strong></span> and have start in the<code class="literal"> Start()</code> of the script. We need to use the C# co-routine version of the<code class="literal"> Start()</code> method as opposed to our normal version.<a id="id395" class="indexterm"/><div class="informalexample"><pre class="programlisting">using UnityEngine;
using System.Collections;
public class PlayIntroMovie : MonoBehaviour {
// Use this for initialization
IEnumerator Start () {
iPhoneUtils.PlayMovie("Snowpocalypse2011.m4v", Color.black, iPhoneMovieControlMode. CancelOnTouch, iPhoneMovieScalingMode.AspectFill );
yield return null;
Application.LoadLevel("IntroCity");
}
}
</pre></div></li><li class="listitem">With this script attached to our empty<span class="strong"><strong> GameObject</strong></span> we now have a complete intro movie system and when we start the game we will be greeted with the Interstitial of our company.<a id="id396" class="indexterm"/></li></ol></div><div class="section" title="What just happened?"><div class="titlepage"><div><div><h2 class="title"><a id="ch08lvl2sec06"/>What just happened?</h2></div></div></div><p>We have just finished our introduction scene by playing a movie to display our studio intro movie and then loading the level that we had been working on, which is the beginning town-level. Now our content is beginning to feel like the content that we would find on the App Store.</p></div></div>
<div class="section" title="Time for action &#x2014; Streaming video"><div class="titlepage"><div><div><h1 class="title"><a id="ch08lvl1sec08"/>Time for action —  Streaming video</h1></div></div></div><p>The first thing we need to do is make sure that an Internet connection is available. Once we know that the Internet is available we can start to stream our video. We need to check for a network connection because we want to respect the fact that our user may deactivate the network connection for Airplane Mode, trying to preserve battery life, or because our device may not be in an area of network connectivity.<a id="id397" class="indexterm"/>
</p><p>We can determine whether or not the iOS device can reach the network by using the iPhoneSettings'<code class="literal"> internetReachability</code> class variable. This will be updated as the network status changes and will also tell you what type of Internet connection you have available. For our purposes we simply need to check whether or not there is a connection of any kind. We can resolve this with a simple condition check:<a id="id398" class="indexterm"/>
</p><div class="informalexample"><pre class="programlisting">if ( iPhoneSettings.internetReachability != iPhoneNetworkReachability.NotReachable )
{
}
</pre></div><p>It is very important that you perform this check for Internet connectivity. If your application tries to reach out to the Internet and fails and you do not deal with this gracefully, by either showing an error that is visible to the user or not performing the functionality that requires network access, Apple will reject the application. You should be prepared to test your game in Airplane Mode exclusively to know whether or not it is going to behave properly if there is no network connectivity.</p><p>Now we know that we can reach the Internet, we want to stream some video to the device. I have stored a video online that the iOS device can stream from our server:<a id="id399" class="indexterm"/>
</p><div class="informalexample"><pre class="programlisting">if ( iPhoneSettings.internetReachability != iPhoneNetworkReachability.NotReachable )
{
iPhoneUtils.PlayMovieURL(http://www.sojournermobile.com/assets/unitybook/commercial.m4v, Color.black, iPhoneMovieControlMode.Hidden )
}
</pre></div><p>As you can see this isn't much different from playing back content that is stored on the device. As we want this to behave like a commercial we want to remove the player's ability to cancel this video or skip through it so we use the<code class="literal"> iPhoneMovieControlMode.Hidden</code> enumeration to ensure that the player will have to watch the movie.</p><div class="section" title="What just happened?"><div class="titlepage"><div><div><h2 class="title"><a id="ch08lvl2sec07"/>What just happened?</h2></div></div></div><p>We have performed network detection to determine whether or not an Internet connection is available. After ensuring that a network connection was available we connected to a stream on the Internet and began playing our commercial.<a id="id400" class="indexterm"/>
</p></div></div>
<div class="section" title="Summary"><div class="titlepage"><div><div><h1 class="title"><a id="ch08lvl1sec09"/>Summary</h1></div></div></div><p>In this chapter we performed all of the steps necessary to handle multimedia in our project. We've given more of a soul to our game by providing the expected environmental cues of video and audio that people have come to expect in games, to make our games as professionally built as those already in the App Store.</p><p>Specifically, we covered:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">How to add ambient sound to the environment</li><li class="listitem" style="list-style-type: disc">How to add background music to the game</li><li class="listitem" style="list-style-type: disc">How to play sound based upon actions in a script</li><li class="listitem" style="list-style-type: disc">How to play video embedded in the Unity project</li><li class="listitem" style="list-style-type: disc">How to detect whether or not our network connection is active</li><li class="listitem" style="list-style-type: disc">How to play video hosted on an external website</li></ul></div><p>Now that we've learned about these and formed the core of our game, it's time to take a step back and begin looking at how we can check for performance issues and debug our application.</p></div></body></html>