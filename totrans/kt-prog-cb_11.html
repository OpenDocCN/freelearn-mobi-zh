<html><head></head><body><div id="sbo-rt-content"><section>

                            <header>
                    <h1 class="header-title">Networking and Concurrency</h1>
                </header>
            
            <article>
                
<p>The following recipes will be covered in this chapter:</p>
<ul>
<li style="font-weight: 400">How to fetch data over network</li>
</ul>
<ul>
<li style="font-weight: 400">How to create data class</li>
</ul>
<ul>
<li style="font-weight: 400">How to copy data class with modifications</li>
</ul>
<ul>
<li style="font-weight: 400">How to parse JSON data from network to data class</li>
</ul>
<ul>
<li style="font-weight: 400">How to download a file in Kotlin</li>
</ul>
<ul>
<li style="font-weight: 400">How to use RxJava and Retrofit with Kotlin</li>
</ul>
<ul>
<li style="font-weight: 400">How to make an endless list using RecyclerView</li>
</ul>
<ul>
<li style="font-weight: 400">How to use Anko to run background tasks with Kotlin in Android</li>
</ul>
<ul>
<li style="font-weight: 400">How to use coroutines to achieve multithreading</li>
</ul>


            </article>

            
        </section>
    </div>



  
<div id="sbo-rt-content"><section>

                            <header>
                    <h1 class="header-title">Introduction</h1>
                </header>
            
            <article>
                
<p>You will probably find it hard to get an app that doesn't communicate over the network. Communication with the internet is used in almost all the apps, be it a file-sharing app, streaming app, social network apps, or something else, the list goes on and on. There are many variables that you need to think about when you want to add network communication features to your Android apps. For example, you can't run it on the main thread, and network requests are always performed on background threads. Apart from that, you also need to detect when the network request fails, so as to give feedback to the user about what went wrong. In this chapter, we will address how to <span>efficiently </span>make network requests in Kotlin.</p>


            </article>

            
        </section>
    </div>



  
<div id="sbo-rt-content"><section>

                            <header>
                    <h1 class="header-title">How to fetch data over network</h1>
                </header>
            
            <article>
                
<p>Making a network request in Android is very cumbersome unless you use any third-party library. For example, let's take a look at how network requests in Android used to be:</p>
<pre>try {
    URL url = new URL("&lt;api call&gt;");

    urlConnection = (HttpURLConnection) url.openConnection();
    urlConnection.setRequestMethod("GET");
    urlConnection.connect();

    InputStream inputStream = urlConnection.getInputStream();
    StringBuffer buffer = new StringBuffer();
    if (inputStream == null) {
        // Nothing to do.
        return null;
    }
    reader = new BufferedReader(new InputStreamReader(inputStream));

    String line;
    while ((line = reader.readLine()) != null) {
        buffer.append(line + "\n");
    }

    if (buffer.length() == 0) {
        return null;
    }
    result = buffer.toString();
} catch (IOException e) {
    Log.e("Request", "Error ", e);
    return null;
} finally{
    if (urlConnection != null) {
        urlConnection.disconnect();
    }
    if (reader != null) {
        try {
            reader.close();
        } catch (final IOException e) {
            Log.e("Request", "Error closing stream", e);
        }
    }
}</pre>
<p>Of course, the preceding code is ugly. Kotlin eases out our pain to make a network request. In this recipe, we will learn how to make network requests in Kotlin.</p>


            </article>

            
        </section>
    </div>



  
<div id="sbo-rt-content"><section>

                            <header>
                    <h1 class="header-title">Getting ready</h1>
                </header>
            
            <article>
                
<p>We will be using Android Studio 3.0. Ensure that you have its latest version.</p>


            </article>

            
        </section>
    </div>



  
<div id="sbo-rt-content"><section>

                            <header>
                    <h1 class="header-title">How to do it…</h1>
                </header>
            
            <article>
                
<p>Let's take look at the following steps required to make network requests in Kotlin:</p>
<ol>
<li>Remember the huge pile of code we saw at the start of this recipe, just for performing a network request? All that can be replaced by just one line of Kotlin code. Let's take a look at the following code:</li>
</ol>
<pre style="padding-left: 60px"><span>var </span>response= URL(<span>"&lt;url&gt;"</span>).<span>readText</span>()</pre>
<p style="padding-left: 60px">This will just return the <kbd>response</kbd> fetched from the network request that you made. You just need to provide your URL as the parameter.</p>
<p style="padding-left: 60px">While using this on Android, ensure that you have pushed this task in the background, or else you will get a <kbd>NetworkOnMainThread</kbd> exception.</p>
<ol start="2">
<li>The code that we want to execute asynchronously is wrapped under the <kbd>doAsync</kbd> block. Wrapping the code inside an async task is also very simple. Let's take a look at the following code:</li>
</ol>
<pre style="padding-left: 60px">doAsync <span>{<br/></span><span>    </span><span>val </span>result= URL(<span>"https://api.instagram.com/319bad89407ffd7082"</span>).readText()<br/>    uiThread <span>{<br/></span><span>        </span>toast(result)<br/>    <span>}<br/></span><span>}</span></pre>
<p style="padding-left: 60px">We have wrapped the network request into an async block, and then we have a <kbd>uiThread</kbd> method from where we can touch the UI elements of the app.</p>
<ol start="3">
<li>The <kbd>uiThread</kbd> method is provided by Anko library, which you can include in your project by adding these lines in your <kbd>build.gradle</kbd>:</li>
</ol>
<p class="mce-root"/>
<pre style="padding-left: 60px">implementation <span>"org.jetbrains.anko:anko:1.0"</span></pre>


            </article>

            
        </section>
    </div>



  
<div id="sbo-rt-content"><section>

                            <header>
                    <h1 class="header-title">There's more…</h1>
                </header>
            
            <article>
                
<p>Check out the <em>How to use Anko to run background tasks with Kotlin in Android</em> recipe of this chapter to learn more about how to create background tasks in Kotlin.</p>


            </article>

            
        </section>
    </div>



  
<div id="sbo-rt-content"><section>

                            <header>
                    <h1 class="header-title">How to create data class in Kotlin</h1>
                </header>
            
            <article>
                
<p>Are you sick and tired of creating long boilerplate code just for storing data? Do you feel that the following code is too much just to define a <kbd>Student</kbd> model?:</p>
<pre><span>public class </span>Student {<br/>    <br/>    <span>private </span>String <span>name</span>;<br/>    <span>private </span>String <span>roll_number</span>;<br/>    <span>private int </span><span>age</span>;<br/><br/>    <span>public </span>String getName() {<br/>        <span>return </span><span>name</span>;<br/>    }<br/><br/>    <span>public void </span>setName(String name) {<br/>        <span>this</span>.<span>name </span>= name;<br/>    }<br/><br/>    <span>public </span>String getRoll_number() {<br/>        <span>return </span><span>roll_number</span>;<br/>    }<br/><br/>    <span>public void </span>setRoll_number(String roll_number) {<br/>        <span>this</span>.<span>roll_number </span>= roll_number;<br/>    }<br/><br/>    <span>public int </span>getAge() {<br/>        <span>return </span><span>age</span>;<br/>    }<br/><br/>    <span>public void </span>setAge(<span>int </span>age) {<br/>        <span>this</span>.<span>age </span>= age;<br/>    }<br/>    <br/>    <span>@Override<br/></span><span>    </span><span>public int </span>hashCode() {<br/>        <span>return super</span>.hashCode();<br/>    }<br/><br/>    <span>@Override<br/></span><span>    </span><span>public </span>String toString() {<br/>        <span>return super</span>.toString();<br/>    }<br/>}</pre>
<p>If you agree, then Kotlin's data class is just for you. So let's dive into it in this recipe and get to know it more.</p>


            </article>

            
        </section>
    </div>



  
<div id="sbo-rt-content"><section>

                            <header>
                    <h1 class="header-title">Getting ready</h1>
                </header>
            
            <article>
                
<p>We will be using IntelliJ IDEA to write our code. You can use any IDE that is capable of executing Kotlin code.</p>


            </article>

            
        </section>
    </div>



  
<div id="sbo-rt-content"><section>

                            <header>
                    <h1 class="header-title">How to do it…</h1>
                </header>
            
            <article>
                
<p>In every real-world project, you create classes that don't have any use except for storing data, like in the case of the <kbd>Student</kbd> class we described earlier. The number of these types of classes can be way too high in a complex project having many roles and models. This results in a lot of boilerplate code. Kotlin has a great solution for it:</p>
<ol>
<li>The code mentioned at the start of the recipe can be reduced to just one line:</li>
</ol>
<pre style="padding-left: 60px"><span>data class </span>Student(<span>var </span><span>name</span>:String,<span>var </span><span>roll_number</span>:String,<span>var </span><span>age</span>:Int)</pre>
<p style="padding-left: 60px">That's it!</p>
<ol start="2">
<li>Now, let's try to use the data class we just created:</li>
</ol>
<pre style="padding-left: 60px"><span>fun </span>main(args: Array&lt;String&gt;) {<br/>    <span>val </span>student=Student(<span>"Aanand"</span>,<span>"2013001"</span>,<span>21</span>)<br/>    <span>println</span>(<span>"Student: name- </span><span>${</span>student.<span>name</span><span>}</span><span>, roll_number:</span><span>${</span>student.<span>roll_number</span><span>}</span><span>, age:</span><span>${</span>student.<span>age</span><span>}</span><span>"</span>)<br/>}<br/><br/>//Output: <strong>Student: name- Aanand, roll_number:2013001, age:21</strong></pre>
<p style="padding-left: 60px">As you can see, we didn't need any getter setter, which saved us a lot of boilerplate code. The getter setters are already included in the Kotlin property.</p>
<ol start="3">
<li>Let's check the <kbd>toString()</kbd> method (which we haven't even defined):</li>
</ol>
<pre style="padding-left: 60px"><span>println</span>(<span>"</span><span>${</span>student.<span>toString()</span><span>}</span><span>"</span>)<br/><br/>//Output:<strong> Student(name=Aanand, roll_number=2013001, age=21)</strong></pre>
<p style="padding-left: 60px">This is better than what you'd get from Java's <kbd>toString()</kbd> method.</p>
<ol start="4">
<li>Data class also offers a lot of flexibility. For example, if you don't want setter for a property, you can make the property <kbd>val</kbd>. This will make the property read-only:</li>
</ol>
<pre style="padding-left: 60px"><span>data class </span>Student(<span>val </span><span>name</span>:String,<span>val </span><span>roll_number</span>:String,<span>var </span><span>age</span>:Int)</pre>
<ol start="5">
<li>One of the cool things that you can do with data class is that you can destructure the object to obtain the property. Check out the following code to understand more:</li>
</ol>
<pre style="padding-left: 60px"><span>fun </span>main(args: Array&lt;String&gt;) {<br/>    <span>val </span>student= Student(<span>"Aanand"</span>, <span>"2013001"</span>, <span>21</span>)<br/>    <span>val </span>(name, roll_number,age)=student<br/>    <span>println</span>(<span>"Student: name- </span><span>$</span>name<span>, roll_number:</span><span>$</span>roll_number<span>, age:</span><span>$</span>age<span>"</span>)<br/>}<br/><br/>//Output: <strong>Student: name- Aanand, roll_number:2013001, age:21</strong></pre>
<ol start="6">
<li>You can also have default values of property in the class. Let's take a look at the next example:</li>
</ol>
<pre style="padding-left: 60px"><span>data class </span>Student(<span>val </span><span>name</span>:String=<span>"Aanand"</span>,<span>val </span><span>roll_number</span>:String,<span>var </span><span>age</span>:Int)<br/><span>var </span>studentA= Student(<span>roll_number =  </span><span>"2013001"</span>, <span>age = </span><span>21</span>)<br/><span>println</span>(studentA.toString())<br/><br/>//Output:<strong> Student(name=Aanand, roll_number=2013001, age=21)</strong></pre>


            </article>

            
        </section>
    </div>



  
<div id="sbo-rt-content"><section>

                            <header>
                    <h1 class="header-title">There's more…</h1>
                </header>
            
            <article>
                
<p>Data class has a few restrictions. According to Kotlin documentation, those are as follows:</p>
<ul>
<li>The primary constructor needs to have at least one parameter</li>
<li>All primary constructor parameters need to be marked as <kbd>val</kbd> or <kbd>var</kbd></li>
<li>Data classes cannot be abstract, open, sealed, or inner</li>
<li>Data classes may not extend other classes (but may implement interfaces)</li>
</ul>


            </article>

            
        </section>
    </div>



  
<div id="sbo-rt-content"><section>

                            <header>
                    <h1 class="header-title">How to copy data class with modifications</h1>
                </header>
            
            <article>
                
<p>In the last recipe, we learned how to use data class and how it reduces a lot of boilerplate code. In this recipe, we will see how data class makes it easy to copy another data class, even if you have to modify the property.</p>
<p>A brute-force mechanism to copy a data class can be to just create a data class by duplicating all the properties, but using the <kbd>copy</kbd> method will make it much easier.</p>


            </article>

            
        </section>
    </div>



  
<div id="sbo-rt-content"><section>

                            <header>
                    <h1 class="header-title">Getting ready</h1>
                </header>
            
            <article>
                
<p>We will be using IntelliJ IDEA to write our code. You can use any IDE that is capable of executing Kotlin code.</p>


            </article>

            
        </section>
    </div>



  
<div id="sbo-rt-content"><section>

                            <header>
                    <h1 class="header-title">How to do it…</h1>
                </header>
            
            <article>
                
<p>We will be using the <kbd>copy</kbd> method, which takes in named arguments and creates a copy of the object with changed values of named arguments. Let's look at an example:</p>
<pre><span>data class </span>Student(<span>val </span><span>name</span>:String,<span>val </span><span>roll_number</span>:String,<span>var </span><span>age</span>:Int)<br/><span>fun </span>main(args: Array&lt;String&gt;) {<br/>    <span>var </span>studentA= Student(<span>"Aanand Roy"</span>, <span>"2013001"</span>, <span>21</span>)<br/>    <span>var </span>olderStudentA=studentA.copy(<span>age = </span><span>25</span>)<br/>    <span>println</span>(olderStudentA.toString())<br/>}<br/><br/>//Output:<strong> Student(name=Aanand Roy, roll_number=2013001, age=25)</strong></pre>


            </article>

            
        </section>
    </div>



  
<div id="sbo-rt-content"><section>

                            <header>
                    <h1 class="header-title">There's more…</h1>
                </header>
            
            <article>
                
<p>People usually get confused between the <kbd>copy()</kbd> and <kbd>apply()</kbd> functions:</p>
<ul>
<li><kbd>apply()</kbd>: It accepts a function and sets its scope to that of the object on which it has been invoked. It is a transformation function that can also be used to evaluate complex logic before returning. At the end, it just returns the same object with changes (if performed).</li>
<li class="mce-root"><kbd>copy()</kbd>: The <kbd>apply</kbd> function is not thread-safe and mutates the object. The <kbd>copy()</kbd> function, on the other hand, returns a new object (without modifying the original object).</li>
</ul>


            </article>

            
        </section>
    </div>



  
<div id="sbo-rt-content"><section>

                            <header>
                    <h1 class="header-title">How to parse JSON data from network to data class</h1>
                </header>
            
            <article>
                
<p>JSON is one of the most widely used formats of response. Usually, the APIs provide outputs in the form of JSON response and in Android development also they are used widely as we communicate with network. Parsing JSON response to a data class helps us work with them as a Java object. You can also parse it using JSONObject, but it results in dirty code. In this recipe, we will learn how to parse JSON data into data class. We are using data class because they are preferred when the sole purpose of class is to save data. So let's get started!</p>


            </article>

            
        </section>
    </div>



  
<div id="sbo-rt-content"><section>

                            <header>
                    <h1 class="header-title">Getting ready</h1>
                </header>
            
            <article>
                
<p>We will be using Android Studio 3.0; ensure that you have its latest version. We will be using the GSON library, an open source library by Google for parsing the JSON response. GSON is very easy to use and is one of the most popular JSON parsing libraries out there. To include GSON in your project, just add the following lines to your <kbd>build.gradle</kbd> file:</p>
<pre>compile <span>'com.google.code.gson:gson:2.8.2'<br/></span></pre>


            </article>

            
        </section>
    </div>



  
<div id="sbo-rt-content"><section>

                            <header>
                    <h1 class="header-title">How to do it…</h1>
                </header>
            
            <article>
                
<p>Follow these steps to understand how to parse JSON data from network:</p>
<ol>
<li>Usually, we get a JSON response after making a network request, so for simplifying, we will assume that we get the given JSON response after making some network request:</li>
</ol>
<pre style="padding-left: 60px">{<br/> "data": [{<br/>             "id": "17867282641151111",<br/>             "from": {<br/>                 "id": "1391934316",<br/>                 "username": "aanandshekharroy",<br/>                 "full_name": "Aanand Shekhar Roy",<br/>                 "profile_picture": "https://scontent.cdninstagram.com/t51.2885-19/10475071_605790259527941_865730435_a.jpg"<br/>                 },<br/>             "text": "Testing api",<br/>             "created_time": "1501571384"<br/>         }, {<br/>             "id": "17892289033060177",<br/>             "from": {<br/>                 "id": "1391934316",<br/>                 "username": "aanandshekharroy",<br/>                 "full_name": "Aanand Shekhar Roy",<br/>                 "profile_picture": "https://scontent.cdninstagram.com/t51.2885-19/10475071_605790259527941_865730435_a.jpg"<br/> },<br/>                 "text": "My second test",<br/>                 "created_time": "1501571390"<br/>             }],<br/>         "meta": {<br/>         "code": 200<br/>     }<br/>}</pre>
<p style="padding-left: 60px">IntelliJ IDEA provides a plugin that can help convert JSON response into Kotlin object. We will be using the <kbd>RoboPojoGenerator</kbd> plugin. Carry out the following steps to install it:</p>
<ol start="2">
<li>Go to <span class="packt_screen">Settings</span> | <span class="packt_screen">Plugins</span>:</li>
</ol>
<div class="CDPAlignCenter CDPAlign"><img src="Images/426ea480-ff4a-4664-bade-7018ccdcd6d9.png" width="1297" height="739"/></div>
<ol start="3">
<li>Click on <span class="packt_screen">Install JetBrains plugin</span>; it will open a dialog. Search Robopojo in it, and you will see a <span class="packt_screen">RoboPOJOGenerator</span> <span>plugin</span>. Click on <span class="packt_screen">Install</span> and restart the Android Studio.</li>
</ol>
<div class="CDPAlignCenter CDPAlign"><img height="768" width="1366" src="Images/5d4fe4d1-1143-4ad4-9d5a-058f8af4abd7.png"/></div>
<ol start="4">
<li>Once you've done that, to generate classes based on JSON response, first create an empty package where you would want to keep the classes. I have created it by the name <kbd>InstagramCommentsResponse</kbd> (because we have used Instagram API for fetching latest comments).</li>
<li>Now, right-click on the package, and select <span class="packt_screen"><span class="packt_screen">New</span> | Generate POJO from JSON</span>. You will then see a dialog by the RoboPOJO generator, where you need to paste your JSON response. After you've done that, check the <span class="packt_screen">Kotlin</span> and <span class="packt_screen">Gson</span> box and click on <span class="packt_screen">Generate</span>.</li>
<li>Now you will see a bunch of classes created inside that package, as illustrated:</li>
</ol>
<div class="CDPAlignCenter CDPAlign"><img height="111" width="264" src="Images/f19590a3-2b85-455e-8e66-f9fb04d3bdf0.png"/></div>
<ol start="7">
<li>Let's take a look at these classes. The first class is the outer holder of JSON response:</li>
</ol>
<pre style="padding-left: 60px"><span>@Generated</span>(<span>"com.robohorse.robopojogenerator"</span>)<br/><span>data class </span>Response(<br/><br/>   <span>@field:SerializedName</span>(<span>"data"</span>)<br/>   <span>val </span><span>data</span>: List&lt;DataItem?&gt;? = <span>null</span>,<br/><br/>   <span>@field:SerializedName</span>(<span>"meta"</span>)<br/>   <span>val </span><span>meta</span>: Meta? = <span>null<br/></span>)</pre>
<pre style="padding-left: 60px"><span>// DataItem -  Class that will hold comments<br/>@Generated</span>(<span>"com.robohorse.robopojogenerator"</span>)<br/><span>data class </span>DataItem(<br/><br/>   <span>@field:SerializedName</span>(<span>"created_time"</span>)<br/>   <span>val </span><span>createdTime</span>: String? = <span>null</span>,<br/><br/>   <span>@field:SerializedName</span>(<span>"from"</span>)<br/>   <span>val </span><span>from</span>: From? = <span>null</span>,<br/><br/>   <span>@field:SerializedName</span>(<span>"id"</span>)<br/>   <span>val </span><span>id</span>: String? = <span>null</span>,<br/><br/>   <span>@field:SerializedName</span>(<span>"text"</span>)<br/>   <span>val </span><span>text</span>: String? = <span>null<br/></span>)</pre>
<ol start="8">
<li>Now, let's try to parse the JSON received from the network call. We will try to get the first comment received and access it as we do in Kotlin:</li>
</ol>
<pre style="padding-left: 60px"><span>fun </span>main(args:Array&lt;String&gt;){<br/>    <span>var </span>response= URL(<span>"https://api.instagram.com/v1/media/1571595528561539504_5812999640/comments?access_token=5812999640.42ee6f0.9441d5bd909f40319bad89407ffd7082"</span>).<span>readText</span>()<br/>    <span>var </span>gson= Gson()<br/>    <span>val </span>comments=gson.fromJson(response,Response::<span>class</span>.<span>java</span>)<br/>    println(comments.data?.get(0))<br/>}<br/><br/>//Output:<strong> DataItem(createdTime=1501571384, from=From(fullName=Aanand Shekhar Roy, profilePicture=https://scontent.cdninstagram.com/t51.2885-19/10475071_605790259527941_865730435_a.jpg, id=1391934316, username=aanandshekharroy), id=17867282641151111, text=Testing api)</strong><br/><br/></pre>
<p>As you can see, we can use it as a plain Kotlin object, without needing to use <kbd>JSONObject</kbd> to parse it using keys, which makes JSON parsing very easy.</p>


            </article>

            
        </section>
    </div>



  
<div id="sbo-rt-content"><section>

                            <header>
                    <h1 class="header-title">How to download a file in Kotlin</h1>
                </header>
            
            <article>
                
<p>We often need to download files in our Android application. The most basic way of doing this will be opening a URL connection and using <kbd>InputStream</kbd> to read the content of the file and storing it in a local file using <kbd>FileOutputStream</kbd>; all this is in a background thread using <kbd>AsyncTask</kbd>. However, we don’t want to reinvent the wheel. There are a lot of libraries out there that handle all this stuff very nicely for us and make our work super easy, helping us create clean code.</p>
<p>We can use <strong>Volley</strong> (<a href="https://developer.android.com/training/volley/index.html">https://developer.android.com/training/volley/index.html</a>), a networking library by developers at Google, which makes network communication very easy and fast. Another one we can use is <strong>OkHttp</strong> (by <em>Square</em>), which is very efficient, and we can use it along with <strong>Retrofit</strong> (for HTTP API).</p>
<p>For this recipe, we will be using a networking library called <strong>Fuel</strong>, which is written in Kotlin.</p>


            </article>

            
        </section>
    </div>



  
<div id="sbo-rt-content"><section>

                            <header>
                    <h1 class="header-title">Getting ready</h1>
                </header>
            
            <article>
                
<p>Create a new Android project and add an activity. Now, add fuel dependencies to your project dependencies by adding the following lines in your <kbd>build.gradle</kbd> and syncing the project:</p>
<pre>//Fuel - Networking in Kotlin<br/>compile 'com.github.kittinunf.fuel:fuel:$fuel_version' //for JVM</pre>
<p>Here, <kbd>$fuel_version</kbd> is the latest version of fuel library.</p>


            </article>

            
        </section>
    </div>



  
<div id="sbo-rt-content"><section>

                            <header>
                    <h1 class="header-title">How to do it…</h1>
                </header>
            
            <article>
                
<p>Follow these steps to download a file in Kotlin:</p>
<ol>
<li>Let's start with a button in our view with an <kbd>onClickListener</kbd> attached to it. I am also adding a <kbd>progressBar</kbd> to the view to be able to see the progress of our download. This is my view:</li>
</ol>
<pre style="padding-left: 60px">&lt;?xml version="1.0" encoding="utf-8"?&gt;<br/>&lt;android.support.constraint.ConstraintLayout <br/>    <br/>    <br/>    android:layout_width="match_parent"<br/>    android:layout_height="match_parent"<br/>    app:layout_behavior="@string/appbar_scrolling_view_behavior"<br/>    tools:context="android.my_company.com.helloworldapp.DownloadFileActivity"<br/>    tools:showIn="@layout/activity_download_file"&gt;<br/><br/>    &lt;Button<br/>        android:id="@+id/btn_download_file"<br/>        android:layout_width="wrap_content"<br/>        android:layout_height="wrap_content"<br/>        android:layout_marginBottom="32dp"<br/>        android:layout_marginTop="32dp"<br/>        android:text="@string/download_file"<br/>        app:layout_constraintBottom_toBottomOf="parent"<br/>        app:layout_constraintLeft_toLeftOf="parent"<br/>        app:layout_constraintRight_toRightOf="parent"<br/>        app:layout_constraintTop_toTopOf="parent" /&gt;<br/><br/>    &lt;ProgressBar<br/>        android:id="@+id/progressBar"<br/>        style="?android:attr/progressBarStyleHorizontal"<br/>        android:layout_width="0dp"<br/>        android:layout_height="wrap_content"<br/>        app:layout_constraintLeft_toLeftOf="parent"<br/>        app:layout_constraintRight_toRightOf="parent"<br/>        app:layout_constraintTop_toTopOf="parent"<br/>        android:progress="0"/&gt;<br/>&lt;/android.support.constraint.ConstraintLayout&gt;</pre>
<ol start="2">
<li>Let's start by downloading a temporary file. We will be using <a href="https://httpbin.org/">https://httpbin.org/</a> for mocking download file API. The following is the code for downloading a temporary file:</li>
</ol>
<pre style="padding-left: 60px">class DownloadFileActivity : AppCompatActivity() {<br/><br/>    override fun onCreate(savedInstanceState: Bundle?) {<br/>        super.onCreate(savedInstanceState)<br/>        setContentView(R.layout.activity_download_file)<br/>        setSupportActionBar(toolbar)<br/>        Log.d("ya", filesDir.absolutePath + " " + filesDir.canonicalPath)<br/><br/>        btn_download_file.onClick {<br/>            progressBar.progress = 0<br/>           <strong> Fuel.download("http://httpbin.org/bytes/32768").destination { response, url -&gt;</strong><br/><strong>                File.createTempFile("abcd", ".tmp")</strong><br/><strong>            }.progress { readBytes, totalBytes -&gt;</strong><br/><strong>                val progress = readBytes.toFloat() / totalBytes.toFloat()</strong><br/><strong>                Log.d("progress", progress.toString())</strong><br/><strong>                progressBar.progress = progress.toInt()*100</strong><br/><strong>            }.response { req, res, result -&gt;</strong><br/><strong>                Log.d("status result", result.component1().toString())</strong><br/><strong>                Log.d("status res", res.responseMessage)</strong><br/><strong>                Log.d("status req", req.url.toString())</strong><br/><strong>            }</strong><br/><br/>        }<br/>    }<br/><br/>}</pre>
<p>This is how our UI looks:</p>
<div class="CDPAlignCenter CDPAlign"><img height="1316" width="1516" src="Images/4a22aefa-a71f-4f98-b73f-52fa9b93ab7d.jpg"/>  </div>
<p>Now, as we mentioned earlier, we will be using the <kbd>Fuel</kbd> library to download the file; here's how the code looks:</p>
<pre>btn_download_file.onClick {<br/>            progressBar.progress = 0<br/>            <strong>Fuel.download("http://httpbin.org/bytes/32768").destination { response, url -&gt;</strong><br/><strong>                File(filesDir , "abcd.txt")</strong><br/><strong>            }.progress { readBytes, totalBytes -&gt;</strong><br/><strong>                val progress = readBytes.toFloat() / totalBytes.toFloat()</strong><br/><strong>                Log.d("ya", progress.toString())</strong><br/><strong>                progressBar.progress = progress.toInt()*100</strong><br/><strong>            }.response { req, res, result -&gt;</strong><br/><strong>                Log.d("status result", result.component1().toString())</strong><br/><strong>                Log.d("status res", res.responseMessage)</strong><br/><strong>                Log.d("status req", req.url.toString())</strong><br/><strong>            }</strong><br/>        }</pre>
<p>I suggest that you play around with downloading files in Fuel, with and without progress, to get a better grasp of this. You can read all the other functionalities that Fuel provides at <a href="https://github.com/kittinunf/Fuel">https://github.com/kittinunf/Fuel</a>.</p>
<p>Also, try to use Volley and other networking libraries in Android to get an understanding of what are the differentiating points and use cases of each.</p>


            </article>

            
        </section>
    </div>



  
<div id="sbo-rt-content"><section>

                            <header>
                    <h1 class="header-title">How to use RxJava and Retrofit with Kotlin</h1>
                </header>
            
            <article>
                
<p><strong>Retrofit</strong> is one of the most widely used networking libraries in Android. It is an open source library created by <em>Jake Wharton</em>. RxJava is the open source implementation of ReactiveX in Java. RxJava is a great way to do reactive-programming or event-driven programming. This recipe won't teach you about reactive programming ( <a href="https://en.wikipedia.org/wiki/Reactive_programming">https://en.wikipedia.org/wiki/Reactive_programming</a> ), so if you aren't comfortable with it, you can learn about it through the documentation (<a href="https://github.com/ReactiveX/RxJava">https://github.com/ReactiveX/RxJava</a>). Rather, in this recipe, you will learn how to use Retrofit and RxJava together.</p>


            </article>

            
        </section>
    </div>



  
<div id="sbo-rt-content"><section>

                            <header>
                    <h1 class="header-title">Getting ready</h1>
                </header>
            
            <article>
                
<p>We will be using Android Studio 3.0. Ensure that you have its latest version. We also need to add the following dependencies:</p>
<pre>compile <span>"com.squareup.retrofit2:retrofit:</span>$retrofit_version<span>"<br/></span>compile <span>"com.squareup.retrofit2:adapter-rxjava2:</span>$retrofit_version<span>"<br/></span>compile <span>"com.squareup.retrofit2:converter-gson:</span>$retrofit_version<span>"<br/>// RxKotlin - Kotlin version of RxJava<br/>compile "io.reactivex.rxjava2:rxkotlin:$rxKotlinVersion"<br/></span></pre>
<p>The <kbd>adapter-rxjava2</kbd> library helps us return observables as response, which can be subscribed by observers.</p>


            </article>

            
        </section>
    </div>



  
<div id="sbo-rt-content"><section>

                            <header>
                    <h1 class="header-title">How to do it…</h1>
                </header>
            
            <article>
                
<p>Using RxJava with Retrofit is quite simple; let's take a look at the following steps:</p>
<ol>
<li>An instance of Retrofit (which is used to communicate with network) will be created as follows:</li>
</ol>
<pre style="padding-left: 60px">Retrofit.Builder()<br/>        .addCallAdapterFactory(RxJava2CallAdapterFactory.create())<br/>        .addConverterFactory(GsonConverterFactory.create())<br/>        .client(okHttpClient)<br/>        .baseUrl(AppConstants.<span>INSTAGRAM_BASE_URL</span>)<br/>        .build()</pre>
<ol start="2">
<li>The following is an example of interface where we define all of our Retrofit calls. You may note, we are returning the <kbd>Observable</kbd>, and that's the only thing that has changed:</li>
</ol>
<pre style="padding-left: 60px">interface InstagramApiService {<br/><br/>    @FormUrlEncoded<br/>    @POST("oauth/authorize")<br/>    fun getRedirectCode(@Field("client_id") client_id: String,<br/>                       @Field("redirect_uri") redirect_uri: String,<br/>                       @Field("response_type") response_type: String): Call&lt;String&gt;<br/><br/><br/>    @FormUrlEncoded<br/>    @POST("oauth/access_token")<br/>    fun getAccessToken(@Field("client_id") client_id: String,<br/>                       @Field("client_secret") client_secret: String,<br/>                       @Field("redirect_uri") redirect_uri: String,<br/>                       @Field("grant_type") grant_type: String<br/>                       , @Field("code") code: String)<br/>                        :Observable&lt;InstagramLoginResponse&gt;<br/><br/>    @GET("v1/users/{user_id}/media/recent/")<br/>    fun getInstagramPosts(@Path("user_id") user_id: String?, @Query("access_token") access_token: String?)<br/>                                                        :Observable&lt;InstagramPostsResponse&gt;<br/><br/>    @GET("v1/media/{media_id}/comments")<br/>    fun getCommentsForInstagramPost(@Path("media_id") media_id: String?<br/>                                    , @Query("access_token") access_token: String?)<br/>            :Observable&lt;InstagramCommentsResponse&gt;<br/>}</pre>
<ol start="3">
<li>Then, you need to create an instance of your aforementioned service, as shown:</li>
</ol>
<pre style="padding-left: 60px">retrofit.create&lt;InstagramApiService&gt;(InstagramApiService::<span>class</span>.<span>java</span>)</pre>
<ol start="4">
<li>Now you just need to call the method, and you need a subscriber object that will subscribe to it:</li>
</ol>
<pre style="padding-left: 60px"><span>instagramApiService</span>.getCommentsForInstagramPost(instagramId)<br/>                .subscribeOn(Schedulers.io())<br/>                .observeOn(AndroidSchedulers.mainThread())<br/>                .<span>subscribeBy</span>(<span>onNext=</span><span>{<br/></span><span>                    response: InstagramCommentsResponse</span><span> -&gt;<br/>                   // Do something with response</span><br/><br/>                <span>}</span>,<span>onError = </span><span>{<br/></span><span>                    // Do something with error</span><br/>                <span>}</span>))</pre>
<ol start="5">
<li>We have pushed the network call on a separate thread in the background. When the call/task is complete, the result will be observed on the main thread.</li>
</ol>


            </article>

            
        </section>
    </div>



  
<div id="sbo-rt-content"><section>

                            <header>
                    <h1 class="header-title">How to make an endless list using RecyclerView</h1>
                </header>
            
            <article>
                
<p>What do the Facebook, Instagram, and Twitter feeds have in common? They all have virtually infinite content to show you while you keep on scrolling down and down for more. There's no doubt that this is a great way to engage users on your platform.</p>
<p>In this recipe, we will see how to make an endless list using <kbd>RecyclerView</kbd>. There are many use cases of it, for example, social media, e-commerce application, or any content-based apps.</p>
<p>We will create a simple app, which will load a small set of data in the beginning, but once the user scrolls to the bottom of the content, we will fetch another set of data and append to it, giving an illusion of infinite content to the user. So let's get started!</p>


            </article>

            
        </section>
    </div>



  
<div id="sbo-rt-content"><section>

                            <header>
                    <h1 class="header-title">Getting ready</h1>
                </header>
            
            <article>
                
<p>We will be using Android Studio 3.0; ensure that you have its latest version.</p>
<p>You'll also need to include <kbd>RecyclerView</kbd> in your <kbd>build.gradle</kbd> file, which you can add as follows:</p>
<pre>compile <span>'com.android.support:recyclerview-v7:26.1.0'<br/></span></pre>
<p>You can also find the source code in the <kbd>https://gitlab.com/aanandshekharroy/Anko-examples/</kbd> <span>repository </span>by checking out the <kbd>6-endless-list-using-recycler-view</kbd> <span>branch.</span></p>


            </article>

            
        </section>
    </div>



  
<div id="sbo-rt-content"><section>

                            <header>
                    <h1 class="header-title">How to do it…</h1>
                </header>
            
            <article>
                
<p>We will be creating a simple app that will show numbers in the list. As you scroll down, the list will keep growing infinitely:</p>
<div class="CDPAlignCenter CDPAlign"><img height="1280" width="720" src="Images/25f505db-92e4-4404-b9d6-f0acc60b40e8.jpeg"/></div>
<p>Here's how the list is created:</p>
<ol>
<li>First, we will create an item that will be placed inside the list. The following is the code for that row item <kbd><span>recycler_row.xml</span></kbd>:</li>
</ol>
<pre style="padding-left: 60px"><span>&lt;?</span><span>xml version=</span><span>"1.0" </span><span>encoding=</span><span>"utf-8"</span><span>?&gt;<br/></span>&lt;<span>LinearLayout </span><span>xmlns:</span><span>android</span><span>=</span><span>"http://schemas.android.com/apk/res/android"<br/></span><span>    </span><span>android</span><span>:layout_width=</span><span>"match_parent"<br/></span><span>    </span><span>android</span><span>:orientation=</span><span>"vertical"<br/></span><span>    </span><span>android</span><span>:layout_height=</span><span>"wrap_content"</span>&gt;<br/><br/>    &lt;<span>TextView<br/></span><span>        </span><span>android</span><span>:id=</span><span>"@+id/recycler_row_text_view"<br/></span><span>        </span><span>android</span><span>:layout_width=</span><span>"match_parent"<br/></span><span>        </span><span>android</span><span>:layout_height=</span><span>"wrap_content"<br/></span><span>        </span><span>android</span><span>:padding=</span><span>"16dp" </span>/&gt;<br/><br/>    &lt;<span>View<br/></span><span>        </span><span>android</span><span>:layout_width=</span><span>"match_parent"<br/></span><span>        </span><span>android</span><span>:layout_height=</span><span>"1dp"<br/></span><span>        </span><span>android</span><span>:layout_alignParentBottom=</span><span>"true"<br/></span><span>        </span><span>android</span><span>:alpha=</span><span>"0.1"<br/></span><span>        </span><span>android</span><span>:background=</span><span>"@android:color/black" </span>/&gt;<br/>&lt;/<span>LinearLayout</span>&gt;</pre>
<ol start="2">
<li>Next, we will create a <kbd>RecyclerView</kbd> in the main activity layout file:</li>
</ol>
<pre style="padding-left: 60px"><span>&lt;?</span><span>xml version=</span><span>"1.0" </span><span>encoding=</span><span>"utf-8"</span><span>?&gt;<br/></span>&lt;<span>android.support.constraint.ConstraintLayout </span><span>xmlns:</span><span>android</span><span>=</span><span>"http://schemas.android.com/apk/res/android"<br/></span><span>    </span><span>xmlns:</span><span>app</span><span>=</span><span>"http://schemas.android.com/apk/res-auto"<br/></span><span>    </span><span>xmlns:</span><span>tools</span><span>=</span><span>"http://schemas.android.com/tools"<br/></span><span>    </span><span>android</span><span>:layout_width=</span><span>"match_parent"<br/></span><span>    </span><span>android</span><span>:layout_height=</span><span>"match_parent"<br/></span><span>    </span><span>tools</span><span>:context=</span><span>".MainActivity"</span>&gt;<br/><br/>    &lt;<span>android.support.v7.widget.RecyclerView<br/></span><span>        </span><span>android</span><span>:id=</span><span>"@+id/recyclerView"<br/></span><span>        </span><span>android</span><span>:scrollbars=</span><span>"vertical"<br/></span><span>        </span><span>android</span><span>:layout_width=</span><span>"match_parent"<br/></span><span>        </span><span>android</span><span>:layout_height=</span><span>"match_parent"</span>/&gt;<br/><br/>&lt;/<span>android.support.constraint.ConstraintLayout</span>&gt;</pre>
<ol start="3">
<li>Now we will create a simple <kbd>RecyclerView</kbd> adapter:</li>
</ol>
<pre style="padding-left: 60px"><span>class </span>RecyclerAdapter(<span>val </span><span>recyclerList</span>: List&lt;Int&gt;) : RecyclerView.Adapter&lt;RecyclerAdapter.ViewHolder&gt;() {<br/>    <span>override fun </span>onBindViewHolder(viewHolder: RecyclerAdapter.ViewHolder, position: Int) {<br/>        viewHolder.bind(<span>recyclerList</span>[position])<br/>    }<br/><br/>    <span>override fun </span>onCreateViewHolder(viewGroup: ViewGroup, position: Int): RecyclerAdapter.ViewHolder {<br/>        <span>val </span>view = LayoutInflater.from(viewGroup.<span>context</span>).inflate(R.layout.<span>recycler_row</span>, viewGroup, <span>false</span>)<br/>        <span>return </span>ViewHolder(view)<br/>    }<br/><br/>    <span>override fun </span>getItemCount(): Int {<br/>        <span>return </span><span>recyclerList</span>.<span>count</span>()<br/>    }<br/><br/>    <span>class </span>ViewHolder(itemView: View) : RecyclerView.ViewHolder(itemView) {<br/>        <span>val </span><span>itemTextView </span>:TextView= itemView.findViewById(R.id.<span>recycler_row_text_view</span>)<br/><br/>        <span>fun </span>bind(recyclerItemText: Int) {<br/>            <span>itemTextView</span>.<span>text </span>= recyclerItemText.toString()<br/>        }<br/>    }<br/><br/>}</pre>
<ol start="4">
<li>Now, let's create a simple function, which when called, will append 30 data items to the list. This is essentially what is done in apps. Once the user reaches the bottom of the list, a network call is made, which appends data to the previous list:</li>
</ol>
<pre style="padding-left: 60px"><span>fun </span>updateDataList(dataList: MutableList&lt;Int&gt;) : List&lt;Int&gt; {<br/>    kotlin.<span>repeat</span>(<span>30</span>) <span>{<br/></span><span>        </span>dataList.add(dataList.<span>size </span>+ <span>1</span>)<br/>    <span>}<br/></span><span>    </span><span>return </span>dataList<br/>}</pre>
<ol start="5">
<li>Now, let's set up the recycler view in the activity:</li>
</ol>
<pre style="padding-left: 60px"><span>class </span>MainActivity : AppCompatActivity() {<br/>    <span>val </span><span>dataList </span>= <span>mutableListOf</span>&lt;Int&gt;()<br/><br/>    <span>override fun </span>onCreate(savedInstanceState: Bundle?) {<br/>        <span>super</span>.onCreate(savedInstanceState)<br/>        setContentView(R.layout.<span>activity_main</span>)<br/><br/>        <span>val </span>layoutManager = LinearLayoutManager(<span>this</span>)<br/>        <span>val </span>adapter = RecyclerAdapter(<span>recyclerList = </span>updateDataList(<span>dataList</span>))<br/><br/>        recyclerView.<span>layoutManager </span>= layoutManager<br/>        recyclerView.<span>adapter </span>= adapter<br/>        recyclerView.addOnScrollListener(<span>object </span>:                              RecyclerView.OnScrollListener() {<br/>            <span>override fun </span>onScrolled(recyclerView: RecyclerView, dx: Int, dy: Int) {<br/>                <span>super</span>.onScrolled(recyclerView, dx, dy)<br/>                <span>if </span>(!recyclerView.canScrollVertically(<span>1</span>)) {<br/>                    onScrolledToBottom();<br/>                }<br/>        }<br/>        <span>fun </span>onScrolledToBottom() {<br/>            <span>val </span>initialSize = <span>dataList</span>.<span>size<br/></span><span>            </span>updateDataList(<span>dataList</span>)<br/>            <span>val </span>updatedSize = <span>dataList</span>.<span>size<br/></span><span>            </span>adapter.notifyItemRangeInserted(initialSize,updatedSize)<br/>        }<br/>})<br/>}</pre>


            </article>

            
        </section>
    </div>



  
<div id="sbo-rt-content"><section>

                            <header>
                    <h1 class="header-title">How it works…</h1>
                </header>
            
            <article>
                
<p class="mce-root">Since we have to intercept when the user has reached the bottom of the list, we have added a <kbd>ScrollListener</kbd>. We have overridden the <kbd>onScroll</kbd> method, and we are using the <kbd>canScrollVertically</kbd> method. The <kbd>canScrollVertically</kbd> method was added in API level 14, and it is used to check whether this view can be scrolled vertically in a certain direction. It takes an integer argument (negative to check scrolling up and positive to check scrolling down) and returns a boolean (<kbd>true</kbd> if possible, <kbd>false</kbd> if not). In our example, we have supplied a positive integer, which will return <kbd>true</kbd> if the view can be scrolled down and false if it can't be. If it can't be further scrolled down (meaning that the data is exhausted), we will add data to the list and update the list by calling the <kbd>notifyItemRangeInserted</kbd> method of the adapter.</p>


            </article>

            
        </section>
    </div>



  
<div id="sbo-rt-content"><section>

                            <header>
                    <h1 class="header-title">How to use Anko to run background tasks with Kotlin in Android</h1>
                </header>
            
            <article>
                
<p><strong>Anko</strong> is a library created by the JetBrains team, which makes Android development quite easy with the help of many helper functions that abstract a lot of complexity and provides you easy-to-use methods. One such thing is to deal with background tasks. Using Anko, we can work with background tasks very easily. In this recipe, we will learn how to work with background tasks using Anko.</p>


            </article>

            
        </section>
    </div>



  
<div id="sbo-rt-content"><section>

                            <header>
                    <h1 class="header-title">Getting ready</h1>
                </header>
            
            <article>
                
<p>We will be using Android Studio 3.0 for coding purposes; ensure that you have its latest version. You need to add Anko to your <kbd>build.gradle</kbd> file, as shown:</p>
<pre>implementation <span>"org.jetbrains.anko:anko:</span>$anko_version<span>"</span></pre>


            </article>

            
        </section>
    </div>



  
<div id="sbo-rt-content"><section>

                            <header>
                    <h1 class="header-title">How to do it…</h1>
                </header>
            
            <article>
                
<p>Doing a task in the background is very easy in Kotlin. Let's take a look at the next example. In this example, we will make a network request (which is required to do in the background or else you will get a <kbd>NetworkOnMainThread</kbd> exception); once the network request is complete, we will show the <span class="packt_screen">Success</span> message<span> </span>using toast. Since we can't touch the UI element from a background thread, we need to come to UI thread in order to do it. We will use the <kbd>uiThread</kbd> method provided by Anko, which will be called once the background task is over:</p>
<pre><span>class </span>MainActivity : AppCompatActivity() {<br/>    <span>override fun </span>onCreate(savedInstanceState: Bundle?) {<br/>        <span>super</span>.onCreate(savedInstanceState)<br/>        setContentView(R.layout.<span>activity_main</span>)<br/>        <strong>doAsync {<br/>            val result= URL</strong>("https://api.instagram.com/v1/media/1571595528561539504_5812999640/comments?access_token=5812999640.42ee6f0.9441d5bd909f40319bad89407ffd7082")<strong>.readText()</strong><br/><strong>            uiThread {<br/>                toast(result)</strong><br/><strong>            }<br/></strong><span><strong>        }</strong><br/></span><span>    </span>}<br/>}</pre>
<p>As you can see, <kbd>URL().readText()</kbd> is a long processing task, hence we've put it in the background task.</p>


            </article>

            
        </section>
    </div>



  
<div id="sbo-rt-content"><section>

                            <header>
                    <h1 class="header-title">How it works…</h1>
                </header>
            
            <article>
                
<p>You must have used async tasks for executing tasks in the background, but it wasn't a very efficient way to do it. It has its problem of handling them when the screen rotates, because it doesn't pay attention to the activity's lifecycle.</p>
<p>The <kbd>doAsync</kbd> method was called by an activity,  and if the activity is destroying, the <kbd>uiThread</kbd> will not be executed. This ensures that you get to touch the UI only till it is present.</p>


            </article>

            
        </section>
    </div>



  
<div id="sbo-rt-content"><section>

                            <header>
                    <h1 class="header-title">How to use coroutines to achieve multithreading</h1>
                </header>
            
            <article>
                
<p><strong>Coroutines</strong> are a great language feature in Kotlin. Here's an apt definition of coroutines according to the documentation:</p>
<div class="packt_quote">"Coroutines are a new way of writing asynchronous, non-blocking code (and much more)."</div>
<p>It's not just the ease of use, it's much more powerful than threads, especially in the case of a mobile environment where even milliseconds of performance gain is appreciated. Spawning multiple threads can cause performance issues, which isn't the case with coroutines since there can be thousands of those running without much drop in performance levels.</p>
<p>The following is what the official documentation of Kotlin says:</p>
<div class="packt_quote">"One can think of a coroutine as a lightweight thread. Like threads, coroutines can run in parallel, wait for each other, and communicate. The biggest difference is that coroutines are very cheap, almost free; we can create thousands of them, and pay very little in terms of performance. True threads, on the other hand, are expensive to start and keep around. A thousand threads can be a serious challenge for a modern machine."</div>
<p>This fact makes it very powerful, and Kotlin's team has provided easy syntax to make it easy to use. In this recipe, we will learn how to use coroutines. So let's get started!</p>


            </article>

            
        </section>
    </div>



  
<div id="sbo-rt-content"><section>

                            <header>
                    <h1 class="header-title">Getting ready</h1>
                </header>
            
            <article>
                
<p class="mce-root">We will be using Android Studio 3.0 for coding purposes. Coroutines are provided as a library that abstracts all the complexities and lets the library handle it. You need to add the library to the <kbd>build.gradle</kbd> file, like this:</p>
<pre><span class="cm-variable">dependencies</span><span> </span><span>{</span><span> </span><span> <br/>    </span><span>.</span><span>.</span><span>.</span><span> </span><span> <br/></span><span class="cm-property">    compile</span><span> </span><span class="cm-string">"org.jetbrains.kotlinx:kotlinx-coroutines-core:0.19.2"</span><span> <br/></span><span>}</span></pre>
<p>This library is published to the Bintray JCenter repository, so you need to add <kbd>jcenter()</kbd> in your repositories, as shown:</p>
<pre class="mce-root">repositories {<br/> jcenter()<br/>}</pre>
<p>One thing to note is that coroutines are experimental in Kotlin 1.1, so you need to explicitly tell the compiler that you know it and you are game for it. To do so, you need to add the following lines to your <kbd>build.gradle</kbd> file:</p>
<pre class="mce-root">apply plugin: 'kotlin'<br/> kotlin {<br/>    experimental {<br/>    coroutines 'enable'<br/> }<br/>}</pre>
<p>Now that everything is set up, you can start using coroutines in your project.</p>


            </article>

            
        </section>
    </div>



  
<div id="sbo-rt-content"><section>

                            <header>
                    <h1 class="header-title">How to do it…</h1>
                </header>
            
            <article>
                
<p>Let's follow the given steps to understand how coroutines work in Kotlin:</p>
<ol>
<li>There are two functions to start the coroutine:
<ul>
<li><kbd>launch{}</kbd></li>
<li><kbd>async{}</kbd></li>
</ul>
</li>
<li>Let's try to write our first simple coroutine function:</li>
</ol>
<pre style="padding-left: 60px"><span>class </span>MainActivity : AppCompatActivity() {<br/>    <span>override fun </span>onCreate(savedInstanceState: Bundle?) {<br/>        <span>super</span>.onCreate(savedInstanceState)<br/>        setContentView(R.layout.<span>activity_main</span>)<br/>        <strong>launch {<br/>            delay(10000)</strong><br/><strong>            println("Hello")</strong><br/>        <span><strong>}</strong><br/></span><span>    </span>}<br/>}</pre>
<p style="padding-left: 60px">The preceding function will print "Hello" in the Android Studio console after a duration of 10 seconds. Note that we have used the <kbd>launch</kbd> function to start a coroutine, which returns a Job, but it does not carry any resulting value. It starts a new coroutine on a given thread pool (by default, coroutines are run on a shared pool of threads). Threads still exist in a program based on coroutines, but one thread can run on many coroutines, hence we don't need too many threads.</p>
<ol start="3">
<li>The key to coroutines are suspending functions. We can create a suspending function just by adding the <kbd>suspend</kbd> modifier on the function. Consider this example:</li>
</ol>
<pre style="padding-left: 60px">suspend fun timeConsumingMethod(arg: String): Boolean {<br/>     //...<br/>}</pre>
<ol start="4">
<li>Suspend functions are only allowed to be called from a coroutine or another suspend function. If you try to call them from somewhere else, your code won't even compile.</li>
</ol>
<p style="padding-left: 60px">Antonio Leiva explains a suspending function as follows:</p>
<div style="padding-left: 60px" class="packt_quote"><strong>"...functions that can stop the execution</strong><span> when they are called and make it continue once it has finished running their own task."</span></div>
<p style="padding-left: 60px">Coroutines needs to have at least one suspending function (in the last example, <kbd>delay</kbd> was a suspending function).</p>
<ol start="5">
<li>Next, we will see the <kbd>async</kbd> function. Conceptually, it is quite similar to the launch function, except the fact that <kbd>async</kbd> returns a deferred—a lightweight non-blocking future that represents a promise to provide a result later (much like Java's <kbd>Future</kbd>). To get the result from that deferred, you use <kbd>.await()</kbd> and since a deferred is also a <kbd>Job</kbd>,  you can cancel it if needed. Let's check out an example of <kbd>async</kbd>.</li>
</ol>
<ol start="6">
<li>First, we will create two suspending functions and execute them concurrently, then will add the results from both functions:</li>
</ol>
<pre style="padding-left: 60px"><span>suspend fun </span>longOperationOne(): Int {<br/>    <span>delay</span>(<span>1000L</span>) <br/>    <span>return </span><span>10<br/></span>}<br/><br/><span>suspend fun </span>longOperationTwo(): Int {<br/>    <span>delay</span>(<span>1000L</span>) <br/>    <span>return </span><span>20<br/></span>}</pre>
<pre style="padding-left: 60px"><span>val </span>one = <span>async </span><span>{ </span>longOperationOne() <span>}<br/></span><span>val </span>two = <span>async </span><span>{ </span>longOperationTwo() <span>}<br/></span><span>async </span><span>{<br/></span><span>    </span><span>println</span>(<span>"The answer is </span><span>${</span>one.await() + two.await()<span>}</span><span>"</span>)<br/><span>}</span></pre>
<ol start="7">
<li>In the preceding example, we got the deferred objects, which is a <kbd>Future</kbd> object. To get the result out of it, we have used the <kbd>await</kbd> function. The <kbd>await</kbd> function is itself a suspending function; that's why we have wrapped it inside an <kbd>async</kbd> block.</li>
<li>A key thing to note is that both the jobs have run asynchronously and concurrently and hence are non-blocking.</li>
<li>If you want to run it in a blocking way, you need to use the <kbd>runBlocking</kbd> method. Here's the same example, but it will block the main thread while it gets the result:</li>
</ol>
<pre style="padding-left: 60px"><span>val </span>one = <span>async </span><span>{ </span>longOperationOne() <span>}<br/></span><span>val </span>two = <span>async </span><span>{ </span>longOperationTwo() <span>}<br/></span><strong>runBlocking </strong><span>{<br/></span><span>    </span><span>println</span>(<span>"The answer is </span><span>${</span>one.await() + two.await()<span>}</span><span>"</span>)<br/><span>}</span></pre>


            </article>

            
        </section>
    </div>



  
<div id="sbo-rt-content"><section>

                            <header>
                    <h1 class="header-title">There's more…</h1>
                </header>
            
            <article>
                
<p>Whenever in doubt, whether using thread or coroutines, remember these lines by Roman (an engineer from the JetBrains team):</p>
<div class="packt_quote">"Coroutines are for asynchronous tasks that <strong>wait</strong> for something most of the time. Threads are for CPU-intensive tasks."</div>
<p>In Android's context, you always want to update the UI, but you can't do it from background thread. Coroutines have a solution for this. Let's take a look at the next example:</p>
<pre>launch(UI) {<br/>     val sum = lengthyJobOne.await() +<span>lengthyJobTwo</span>.await()<br/>     myTextView.text = "Sum of results is $sum."<br/>}</pre>
<p>In the preceding code, not only can we compute two jobs in the background without blocking the main thread, we can also touch the UI thread for updating views.</p>


            </article>

            
        </section>
    </div>



  </body></html>