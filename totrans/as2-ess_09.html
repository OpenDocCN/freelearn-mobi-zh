<html><head></head><body><div><div><div><div><h1 class="title"><a id="ch09"/>Chapter 9. Preparing for Release</h1></div></div></div><p>In the previous chapter, you learned enough to test and debug your application. What do you need to do to prepare your application for its release? How can you do this using Android Studio?</p><p>This chapter describes the necessary steps to prepare your application for release using Android Studio. First of all, you will learn about <strong>application packages</strong> (<strong>APK</strong>) files—a variation of the JAR files in<a class="indexterm" id="id443"/> which Android applications are packed. You will then learn how you need to change your application after fully testing it. Finally, we will sign our APK file, leaving it ready to upload to Google Play.</p><p>These are the topics we'll be covering in this chapter:</p><div><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">APK files</li><li class="listitem" style="list-style-type: disc">Build types</li><li class="listitem" style="list-style-type: disc">Preparing for release</li><li class="listitem" style="list-style-type: disc">Generating a signed APK</li><li class="listitem" style="list-style-type: disc">Signing in release mode</li></ul></div><div><div><div><div><h1 class="title"><a id="ch09lvl1sec56"/>Understanding an APK file</h1></div></div></div><p>Android applications are packed in a file with the <code class="literal">.apk</code> extension. These files are just compressed ZIP files, so their content can easily be explored. An APK file usually contains the following:</p><div><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><code class="literal">assets/</code>: This is<a class="indexterm" id="id444"/> a folder that contains the asset files of the application. This is the same <code class="literal">assets</code> folder that exists in our project.</li><li class="listitem" style="list-style-type: disc"><code class="literal">META-INF/</code>: This<a class="indexterm" id="id445"/> is a folder that contains our certificates.</li><li class="listitem" style="list-style-type: disc"><code class="literal">lib/</code>: This is <a class="indexterm" id="id446"/>a folder that contains compiled code, in case it is needed for a processor.</li><li class="listitem" style="list-style-type: disc"><code class="literal">res/</code>: This is<a class="indexterm" id="id447"/> a folder that contains the application resources such as images, strings, and so on.</li><li class="listitem" style="list-style-type: disc"><code class="literal">AndroidManifest.xml</code>: This<a class="indexterm" id="id448"/> is the application manifest file.</li><li class="listitem" style="list-style-type: disc"><code class="literal">classes.dex</code>: This is <a class="indexterm" id="id449"/>a file that contains the application's compiled code.</li><li class="listitem" style="list-style-type: disc"><code class="literal">resources.arsc</code>: This is <a class="indexterm" id="id450"/>a file that contains some precompiled resources, such as binary XML files.</li></ul></div><p>Having the <a class="indexterm" id="id451"/>APK file allows the application to be distributed and installed on the Android operating system. Android applications can be distributed as you prefer: through app markets such as Google Play, Amazon App store, or Opera Mobile Store; through your own website; or even via an e-mail to your users. If you choose one of the two last options, take into account that Android, by default, blocks installations from locations other than Google Play. You should inform your users that they need to disable this restriction in their devices to be able to install your application. They have to check the <strong>Unknown sources</strong> option by navigating to <strong>Settings</strong> | <strong>Security</strong> in their Android devices.</p></div></div>
<div><div><div><div><h1 class="title"><a id="ch09lvl1sec57"/>Build types</h1></div></div></div><p>Applications<a class="indexterm" id="id452"/> have to be signed with a private key when they are built. An application can't be installed in a device or even in the emulator if it is not signed. To build our application, there are two types: <strong>debug</strong> and <strong>release</strong>. Both APK versions contain the same folders and compiled files; the difference is in the key used to sign them. Both modes are explained as follows:</p><div><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><strong>Debug</strong>: When <a class="indexterm" id="id453"/>we ran and tested our application in the <a class="indexterm" id="id454"/>previous chapters, we were in debug mode, but we didn't have a key nor did we do anything to sign our application. The Android SDK tools automatically create a debug key, an alias, and their passwords to sign the APK. This process occurs when we are running or debugging our application with Android Studio without us realizing. We can't publish an APK signed with the debug key created by the SDK tools.</li><li class="listitem" style="list-style-type: disc"><strong>Release</strong>: When <a class="indexterm" id="id455"/>we distribute our application, we<a class="indexterm" id="id456"/> have to build a release version. Google Play requires the APK file to be signed with a certificate, for which the developer keeps the private key. In this case, we need our own private key, alias, and password and need to provide them to the build tools. The certificate identifies the developer of the application and can be a self-signed certificate. It is not necessary for<a class="indexterm" id="id457"/> a certificate<a class="indexterm" id="id458"/> authority to sign the certificate.</li></ul></div><p>Keep the key<a class="indexterm" id="id459"/> store with your certificate in a secure place. To upgrade your application, you have to use the same key in order to upload the new version. If you lose the key store, you won't be able to update your application. You will have to create a new application with a different package name.</p></div>
<div><div><div><div><h1 class="title"><a id="ch09lvl1sec58"/>Steps prior to releasing your app</h1></div></div></div><p>Before you <a class="indexterm" id="id460"/>generate the APK file, it is necessary to prepare your application to build it in release mode. Perform the following steps:</p><div><ol class="orderedlist arabic"><li class="listitem">Firstly, make sure you have completely tested your application. We recommend testing your application in the following ways:<div><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">On a device using the minimum required platform</li><li class="listitem" style="list-style-type: disc">On a device using the target platform</li><li class="listitem" style="list-style-type: disc">On a device using the latest available platform</li><li class="listitem" style="list-style-type: disc">On a real device and not just the emulator</li><li class="listitem" style="list-style-type: disc">On a variety of screen resolutions and sizes</li><li class="listitem" style="list-style-type: disc">On a tablet if your application supports it</li><li class="listitem" style="list-style-type: disc">By switching to landscape mode if you allow it, both in a mobile device and in a tablet</li><li class="listitem" style="list-style-type: disc">On different network conditions, such as with no Internet connectivity or low coverage</li><li class="listitem" style="list-style-type: disc">When the GPS or other location service is not activated on your device (if your application uses GPS or any location service)</li><li class="listitem" style="list-style-type: disc">When the back button is pressed</li></ul></div></li><li class="listitem">Secondly, we have to check the log messages that are printed from our application. Printing some log messages can be considered a security vulnerability. Logs generated by the Android system can be captured and analyzed, so we should avoid showing critical information about the application's internal working. You should also remove the <code class="literal">android:debuggable</code> property from the application manifest file. You can also set this property to <code class="literal">false</code>.</li><li class="listitem">Thirdly, if your application communicates with a server, check that the configured URL is the production URL. It is possible that, during the debug phase, you referenced an URL of a server in a prerelease environment.</li><li class="listitem">Finally, set the correct value for the <code class="literal">android:versionCode</code> and <code class="literal">android:versionName</code> properties from the application manifest file. The version code is a number (integer) that represents the application version. New versions should have greater version codes. This code is used to determine whether an application installed on a device is the latest version or whether there is a newer version.</li></ol></div><p>The version<a class="indexterm" id="id461"/> name is a string that represents the application version. Unlike the version code, the version name is visible to the user and appears in the public information about the application. It is just an informative version name to the user and is not used for any internal purpose.</p><p>Specify a value of <code class="literal">1</code> for the version code and <code class="literal">1.0</code> for the version name. The <code class="literal">manifest</code> tag should look like the following:</p><div><pre class="programlisting">&lt;manifest 
    package="com.example.myapplication"
    <strong>android:versionCode="1"</strong>
    <strong>android:versionName="1.0"</strong> &gt;</pre></div><p>A new version of our application will have a value of <code class="literal">2</code> for the version code and could have <code class="literal">1.1</code> for the version name:</p><div><pre class="programlisting">&lt;manifest 
    package="com.example.myapplication"
    <strong>android:versionCode="2"</strong>
    android:versionName="1.1" &gt;</pre></div></div>
<div><div><div><div><h1 class="title"><a id="ch09lvl1sec59"/>Generating a signed APK</h1></div></div></div><p>To generate the signed APK, navigate to <strong>Build</strong> | <strong>Generate Signed APK</strong>. Select the <strong>app</strong> module and click on the <strong>Next</strong> button. In the dialog to generate the signed APK, we are asked for a <a class="indexterm" id="id462"/>certificate. The APK is signed by this certificate, which indicates that it belongs to us.</p><p>If this is our first application, we might not have any certificates. Click on the <strong>Create new...</strong> button to open the <strong>New Key Store</strong> dialog. Now, fill in the following information:</p><div><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><strong>Key store path</strong>: This is the path in your system to create the key store. The key store is a file with the <code class="literal">.jks</code> extension, for example, <code class="literal">release_keystore.jks</code>.</li><li class="listitem" style="list-style-type: disc"><strong>Password</strong>: This is the key store password. You have to confirm it.</li><li class="listitem" style="list-style-type: disc"><strong>Alias</strong>: This is the alias for your certificate and is a pair of public and private keys. Let's name it <code class="literal">releasekey</code>.</li><li class="listitem" style="list-style-type: disc"><strong>Password</strong>: This is the certificate password. You have to confirm it.</li><li class="listitem" style="list-style-type: disc"><strong>Validity (years)</strong>: This is the certificate that will be valid until the validity date. A value of 25 years or more is recommended.</li><li class="listitem" style="list-style-type: disc"><strong>Certificate</strong>: This is the personal information contained in the certificate. Type your first and last name, organizational unit, organization, city or locality, state or province, and country code; for example, <code class="literal">AS</code> as <strong>Organizational Unit</strong>, <code class="literal">packtpub</code> as <strong>Organization</strong>, and <code class="literal">ES</code> as <strong>Country Code</strong>.</li></ul></div><p>You can see <a class="indexterm" id="id463"/>the <strong>New Key Store</strong> dialog in the next screenshot:</p><div><img alt="Generating a signed APK" src="img/B05459_09_01.jpg"/></div><p>Click on <strong>OK</strong>. The dialog to create the signed APK is now loaded with the key store data. The next time we create a signed APK, we will already have a certificate, so we will select the <strong>Choose existing</strong> button. Click on the <strong>Next</strong> button. In the next step, select the path to save the APK file, select the release build type, and click on <strong>Finish</strong>. When the APK is completely generated, you will be informed by a message on the bottom bar of Android Studio and by the following notification on the top part of Android Studio:</p><div><img alt="Generating a signed APK" src="img/B05459_09_02.jpg"/></div><p>We should have<a class="indexterm" id="id464"/> the APK file created in the selected path. Now that you have the APK file ready for release, it is recommended that you test it again in a device before distributing it.</p></div>
<div><div><div><div><h1 class="title"><a id="ch09lvl1sec60"/>Sign automatically in release mode</h1></div></div></div><p>Apps are<a class="indexterm" id="id465"/> signed automatically when<a class="indexterm" id="id466"/> running in debug mode, since the debug key is automatically generated. If we try to run our app in release mode, the following error will be displayed because Android Studio does not know how to sign our app: <em>Error: The apk for your currently selected variant (app-release-unsigned.apk) is not signed. Please specify a signing configuration for this variant (release)</em>.</p><p>We need to configure our build settings if we want to run our app in release mode.</p><p>Open the <strong>Project Structure</strong> settings by navigating to <strong>File</strong> | <strong>Project Structure...</strong>. Select your app in the <strong>Modules</strong> section and open the <strong>Signing</strong> tab. Click on the plus button to create a new signing configuration. Rename the configuration and type the data of your key store, as shown in the following screenshot:</p><div><img alt="Sign automatically in release mode" src="img/B05459_09_03.jpg"/></div><p>Switch to<a class="indexterm" id="id467"/> the <strong>Build Types</strong> tab, in which<a class="indexterm" id="id468"/> the default two build types are listed: debug and release. Select <strong>release</strong> and choose the recently created configuration (<strong>releaseConfig</strong>) in the <strong>Signing Config</strong> selector:</p><div><img alt="Sign automatically in release mode" src="img/B05459_09_04.jpg"/></div><p>Press <strong>Ok</strong> to finish the configuration. Now, your app will automatically be signed in release mode using your release key.</p><p>This signing configuration has actually modified the <code class="literal">build.gradle</code> file of your app module. Open this file to observe the changes:</p><div><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">The new signing configuration has been added using the following code:<div><pre class="programlisting">signingConfigs {
   releaseConfig {
      keyAlias 'releaseKey'
      keyPassword 'password'
      storeFile
         file('/Users/belen/release_keystore.jks')
      storePassword 'password'
   }
}</pre></div></li><li class="listitem" style="list-style-type: disc">The release build type now points to the previous signing configuration:<div><pre class="programlisting">buildTypes {
   release {
      minifyEnabled false
      proguardFiles 
         getDefaultProguardFile('proguard-android.txt'),
         'proguard-rules.pro'
      <strong>signingConfig signingConfigs.releaseConfig</strong>
   }
}</pre></div></li></ul></div><p>There are<a class="indexterm" id="id469"/> some alternatives if you do not <a class="indexterm" id="id470"/>want to expose your password in the <code class="literal">build.gradle</code> file, for example, saving your password in a <code class="literal">properties</code> file that you can read from the <code class="literal">build.gradle</code> file.</p><div><div><div><div><h2 class="title"><a id="ch09lvl2sec35"/>Running your app in release mode</h2></div></div></div><p>Now that <a class="indexterm" id="id471"/>our app will be signed automatically<a class="indexterm" id="id472"/> for release, we can run and test our application using the release mode. To run an app in release mode, open the <strong>Build Variants</strong> panel, which is located in the left-side bar of Android Studio, as you can see in the following screenshot:</p><div><img alt="Running your app in release mode" src="img/B05459_09_05.jpg"/></div><p>Your app <a class="indexterm" id="id473"/>module is displayed in the <strong>Build Variants</strong> panel, along with the current build variant, which by default is <strong>debug</strong>. Change the <a class="indexterm" id="id474"/>build variant value to <strong>release</strong> and then your app is ready to run in release mode.</p></div><div><div><div><div><h2 class="title"><a id="ch09lvl2sec36"/>APK Analyzer</h2></div></div></div><p>Android Studio 2.2 introduced a new feature—the <strong>APK Analyzer</strong>. This tool analyzes the content of a<a class="indexterm" id="id475"/> selected APK file. You can review the sizes of the<a class="indexterm" id="id476"/> components, the final <code class="literal">AndroidManifest.xml</code> file, and the compiled resources.</p><p>Navigate to <strong>Build</strong> | <strong>APK Analyzer</strong> and select your APK file. A new tab will open with the APK file details, as shown in the next screenshot:</p><div><img alt="APK Analyzer" src="img/B05459_09_06.jpg"/></div><p>All the files in<a class="indexterm" id="id477"/> the APK are listed along with their file sizes: <strong>Raw File Size</strong> and <strong>Download Size</strong>. The download size is the estimation of the file size <a class="indexterm" id="id478"/>when the user downloads the<a class="indexterm" id="id479"/> APK.</p><p>When you<a class="indexterm" id="id480"/> select a file, you can see its details in the bottom part. Select the <code class="literal">classes.dex</code> file to see the list of all the classes in the APK file, like in the following screenshot:</p><div><img alt="APK Analyzer" src="img/B05459_09_07.jpg"/></div><p>For each<a class="indexterm" id="id481"/> class, the number of methods is displayed and a summary is<a class="indexterm" id="id482"/> also provided. This information is useful to avoid the 64k referenced method limit issue. There is a limit in the total number of methods that can be referenced within a <strong>Dalvix Executable</strong> (<strong>dex</strong>) bytecode file: 65536. Using the APK analyzer, you<a class="indexterm" id="id483"/> can keep track of the number of methods in your APK.</p><p>If your app is over the limit and refactoring or code cleaning are not enough, you can enable a multidex configuration for your app. A multidex configuration will create different <code class="literal">dex</code> files. Add the following line in the <code class="literal">defaultConfig</code> of your <code class="literal">build.gradle</code> file to enable multidex:</p><div><pre class="programlisting">multiDexEnabled true</pre></div><p>You also need to add the <code class="literal">MultiDexApplication</code> class to your application in the manifest file:</p><div><pre class="programlisting">android:name="android.support.multidex.MultiDexApplication"</pre></div></div></div>
<div><div><div><div><h1 class="title"><a id="ch09lvl1sec61"/>Summary</h1></div></div></div><p>You learned how to make an APK file and how to modify your application to make it ready for release. You also learned how to sign our application using the developer certificate. By the end of this chapter, you should have generated a signed APK prepared for its release.</p><p>In <a class="link" href="apa.html" title="Appendix A. Getting Help">Appendix</a>, <em>Getting Help</em>, you will learn how to get help using Android Studio. We will access the Android Studio online documentation and go through the help topics. Finally, you will learn about keeping your Android Studio instance updated using the inbuilt feature for updates.</p></div></body></html>