<html><head></head><body>
      
      <section>
         
         
         <header>
            
            <h1 class="header-title">iMessages</h1>
            
         </header>
         
         
         <article>
            
            
            <p>Text messaging started with just simple text and the creation of faces using special
               characters. As smartphones began to become more and more commonplace, so did text
               messaging. Messages are now a significant form of communication for the vast majority
               of people. People find it easier to respond to a text message than to answer a phone
               call.
            </p>
            
            <p>When Apple announced iMessage apps and stickers, it took messaging to another level.
               We had stickers before this announcement, but now we had a fully integrated system.
               iMessages does not only allow you to send a sticker to express a feeling or an emotion
               more effectively than words; you can now use messages to send the score of a game
               or even play games through text messages.
            </p>
            
            <p>In this chapter, we are going to create an <em>iMessage</em> app. This app will allow the user to look for restaurants and send reservations to
               others. We will build our UI to look similar to what our phone looks like. To create
               the <em>iMessages</em> app, we need to add a message extension to our app.
            </p>
            
            <p>We will cover the following in this chapter:</p>
            
            <ul>
               
               <li>Building a custom message app UI</li>
               
               <li>Creating a framework</li>
               
               <li>Sharing code between multiple targets</li>
               
               <li>Learning how to send a reservation to others</li>
               
            </ul>
            
            
            
         </article>
         
         
         
      </section>
      
   

      
      <section>
         
         
         <header>
            
            <h1 class="header-title">Understanding iMessages</h1>
            
         </header>
         
         
         <article>
            
            
            <p>Starting with the UI is always my preferred way to begin building an app, because
               you can get a feel for what you need to code. We are going to implement a single screen
               that will be a list of restaurants (accessible by hitting the sticker icon next to
               where a user writes his or her message). The user can choose a restaurant for which
               he or she has a reservation and send it via messages to another person. Once that
               other person receives the message, that person will be able to tap on the reservation
               and see all of the details.
            </p>
            
            <p>In a message View Controller, there are two types of presentation styles: compact
               and expanded.
            </p>
            
            <div class="CDPAlignCenter CDPAlign"><img height="396" src="assets/0e3711b0-279d-4a7c-9818-3e81ea6cd7b8.png" width="399"/></div>
            
            <p>Apple recommends that you have two different View Controllers for each style. However,
               since our screen is simple, we will use just one. Keep in mind, however, that, if
               you want to do a more complicated layout, you should use two controllers.
            </p>
            
            
            
         </article>
         
         
         
      </section>
      
   

      
      <section>
         
         
         <header>
            
            <h1 class="header-title">Creating our extension  </h1>
            
         </header>
         
         
         <article>
            
            
            <p>Let's get started by working on the UI now:</p>
            
            <ol>
               
               <li>In the Navigator panel, select the Project navigator and, then, your project:</li>
               
            </ol>
            
            <div class="CDPAlignCenter CDPAlign"><img src="assets/bf191e45-2546-4133-b07e-bb4b6da46723.png"/></div>
            
            <ol start="2">
               
               <li>In the Standard Editor, locate the <span class="packt_screen">TARGETS</span> area and then the <span class="packt_screen">+</span> (plus button) at the bottom of the <span class="packt_screen">TARGETS</span> area. (If your <span class="packt_screen">TARGETS</span> area is not displaying, hit the icon highlighted in blue to the left of <span class="packt_screen">General</span> in the following screenshot):
               </li>
               
            </ol>
            
            <div class="CDPAlignCenter CDPAlign"><img src="assets/d18ab2c2-9349-44c6-9e7b-ae6e29d8a6d1.png"/></div>
            
            <ol start="3">
               
               <li>Click the <span class="packt_screen">+</span> (plus button) and, then, select <span class="packt_screen">iMessage Extension</span>:
               </li>
               
            </ol>
            
            <div class="CDPAlignCenter CDPAlign"><img height="422" src="assets/e38c0f34-8bfa-4e38-852a-82324ec263e7.png" width="594"/></div>
            
            <ol start="4">
               
               <li>Click <span class="packt_screen">Next</span> and, then, you will see the following screen:
               </li>
               
            </ol>
            
            <div class="CDPAlignCenter CDPAlign"><img height="368" src="assets/49b45f75-def3-4ab9-bce8-0b42579e4220.png" width="511"/></div>
            
            <ol start="5">
               
               <li>Set the <span class="packt_screen">Product Name</span> to <kbd>MessageApp</kbd> and click <span class="packt_screen">Finish</span>.
               </li>
               
               <li>You will receive the following message after you click <span class="packt_screen">Finish</span>. Select <span class="packt_screen">Activate</span>:
               </li>
               
            </ol>
            
            <div class="CDPAlignCenter CDPAlign"><img height="149" src="assets/97be1e2d-2fc2-4d9c-b0b1-9dd4fc81bf0e.png" width="340"/></div>
            
            <p>By activating the <kbd>MessageApp</kbd> scheme, we will be able to build and run iMessages from the simulator. Now, you will
               have the choice of running either our <em>Let's Eat</em> app or our <em>iMessages</em> app.
            </p>
            
            
            
         </article>
         
         
         
      </section>
      
   

      
      <section>
         
         
         <header>
            
            <h1 class="header-title">Updating our assets </h1>
            
         </header>
         
         
         <article>
            
            
            <p>Next, we need to add assets that are necessary for our <em>iMessages</em> app:
            </p>
            
            <ol>
               
               <li>In the <kbd>MessageApp</kbd> folder in the Navigator panel, select the <kbd>Assets.xcassets</kbd> folder.
               </li>
               
               <li>Hit the <em>Delete</em> button and, then, select <span class="packt_screen">Move to Trash</span> in the screen that appears.
               </li>
               
               <li>Then, open the project's <kbd>assets</kbd> folder downloaded from Packt's website (<a href="https://www.packtpub.com/">https://www.packtpub.com/</a>).
               </li>
               
               <li>Open <kbd>Chapter24</kbd> and drag the <kbd>Assets.xcassets</kbd> folder into your <kbd>MessageApp</kbd> folder inside the Navigator panel. Do not do this in Xcode; you will need to open
                  this up in finder just like we did at the beginning of the book.
               </li>
               
               <li>In the options screen that appears, ensure that <span class="packt_screen">Copy items if needed</span> and <span class="packt_screen">Create groups</span> are both selected and then select <span class="packt_screen">Finish</span>.
               </li>
               
            </ol>
            
            <p>If you open the <kbd>Assets.xcassets</kbd> folder, you will see that you now have an icon and two other image assets that we
               will need for our <em>iMessages</em> app.
            </p>
            
            
            
         </article>
         
         
         
      </section>
      
   

      
      <section>
         
         
         <header>
            
            <h1 class="header-title">Implementing our Messages UI </h1>
            
         </header>
         
         
         <article>
            
            
            <p>Next, we need to set up our UI. In our <em>iMessages</em> app, we will have a single screen; in this screen, we will show a list of restaurants
               using a Collection View. When you tap on the restaurant, you will be able to send
               a reservation message to someone else. Let's get started:
            </p>
            
            <ol>
               
               <li>In your <kbd>MessageApp</kbd> project, select your <kbd>MainInterface.storyboard</kbd>. You will see a single storyboard with a label that says <span class="packt_screen">Hello World</span>:
               </li>
               
            </ol>
            
            <div class="CDPAlignCenter CDPAlign"><img height="470" src="assets/d74bfeac-413f-467b-9524-2cbaf6d51928.png" width="351"/></div>
            
            <ol start="2">
               
               <li>Delete the label that says <span class="packt_screen">Hello World</span> by selecting it in the Outline view and, then, hitting <em>Delete</em>.
               </li>
               
               <li>Select the Messages View Controller and, then, the Attributes inspector in the Utilities
                  panel and change the status bar under <span class="packt_screen">Simulated Metrics</span> from <span class="packt_screen">Inferred</span> to <span class="packt_screen">None</span>.
               </li>
               
               <li>Next, in the Object library of the Utilities panel, type <kbd>collectionview</kbd> in the filter and then drag a Collection View into the View Controller in the scene.
               </li>
               
               <li>With the Collection View selected, select the Pin icon and enter the following values:</li>
               
            </ol>
            
            <ul>
               
               <li style="list-style-type: none">
                  
                  <ul>
                     
                     <li>All values under <span class="packt_screen">Add New Constraints</span> are set to <kbd>0</kbd></li>
                     
                     <li><span class="packt_screen">Constrain to margins</span> is unchecked
                     </li>
                     
                     <li><span class="packt_screen">Update Frames</span> is set to <span class="packt_screen">Items of New Constraints</span></li>
                     
                  </ul>
                  
               </li>
               
            </ul>
            
            <ol start="6">
               
               <li>Click <span class="packt_screen">Add 4 Constraints</span>.
               </li>
               
               <li>Next, with the Collection View still selected, open the Attributes inspector in the
                  Utilities panel.
               </li>
               
               <li>Select Background in the Attributes inspector and, under the <span class="packt_screen">Color Sliders</span> tab, set the <span class="packt_screen">Hex Color #</span> to <kbd>ECECEC</kbd> under <span class="packt_screen">RGB Sliders</span> in the drop-down menu.
               </li>
               
               <li>Next, select the Collection View cell and, then, the Size inspector in the Utilities
                  panel.
               </li>
               
               <li>Change the <span class="packt_screen">Size</span> from <span class="packt_screen">Default</span> to <span class="packt_screen">Custom</span>. Then, set the <span class="packt_screen">Width</span> to <kbd>320</kbd> and the <span class="packt_screen">Height</span> to <kbd>78</kbd>.
               </li>
               
               <li>Then, select <span class="packt_screen">Background</span> in the Attributes inspector and, under the <span class="packt_screen">Color Sliders</span> tab, set the <span class="packt_screen">Hex Color #</span> to <kbd>FFFFF</kbd> under <span class="packt_screen">RGB Sliders</span> in the drop-down menu.
               </li>
               
               <li>In the Utilities panel, select the <span class="packt_screen">Media Library</span> and type restaurant-list into the filter field.
               </li>
               
               <li>Drag a <kbd>restaurant-list-img</kbd> into your Collection View cell.
               </li>
               
               <li>With the image still selected, go to the Size inspector in the Utilities panel and
                  update the following values:
               </li>
               
            </ol>
            
            <ul>
               
               <li style="list-style-type: none">
                  
                  <ul>
                     
                     <li><span class="packt_screen">X</span>: <kbd>8</kbd></li>
                     
                     <li><span class="packt_screen">Y</span>: <kbd>9</kbd></li>
                     
                     <li><span class="packt_screen">Width</span>: <kbd>60</kbd></li>
                     
                     <li><span class="packt_screen">Height</span>: <kbd><kbd>60</kbd></kbd></li>
                     
                  </ul>
                  
               </li>
               
            </ul>
            
            <ol start="15">
               
               <li>Next, select the object library in the Utilities panel and type <kbd>label</kbd> into the filter.
               </li>
               
               <li>Drag three labels into the cell.</li>
               
               <li>Select the first label and, in the Size inspector, update the following values:</li>
               
            </ol>
            
            <ul>
               
               <li style="list-style-type: none">
                  
                  <ul>
                     
                     <li><span class="packt_screen">X</span>: <kbd>76</kbd></li>
                     
                     <li><span class="packt_screen">Y</span>: <kbd>10</kbd></li>
                     
                     <li><span class="packt_screen">Width</span>: <kbd>236</kbd></li>
                     
                     <li><span class="packt_screen">Height</span>: <kbd>21</kbd></li>
                     
                  </ul>
                  
               </li>
               
            </ul>
            
            <ol start="18">
               
               <li>Next, select the Attributes inspector; update the <span class="packt_screen">Font</span> to <span class="packt_screen">Bold</span> and verify that the <span class="packt_screen">Font size</span> is <kbd>17</kbd>.
               </li>
               
               <li>Select the second label and, in the Size inspector, update the following values:</li>
               
            </ol>
            
            <ul>
               
               <li style="list-style-type: none">
                  
                  <ul>
                     
                     <li><span class="packt_screen">X</span>: <kbd>76</kbd></li>
                     
                     <li><span class="packt_screen">Y</span>: <kbd>35</kbd></li>
                     
                     <li><span class="packt_screen">Width</span>: <kbd>236</kbd></li>
                     
                     <li><span class="packt_screen">Height</span>: <kbd>16</kbd></li>
                     
                  </ul>
                  
               </li>
               
            </ul>
            
            <ol start="20">
               
               <li>Then, in the Attributes inspector, update the <span class="packt_screen">Font</span> to <span class="packt_screen">Light</span>, size <kbd>14</kbd>.
               </li>
               
               <li>Select the last label and, in the Size inspector, update the following values:</li>
               
            </ol>
            
            <ul>
               
               <li style="list-style-type: none">
                  
                  <ul>
                     
                     <li><span class="packt_screen">X</span>: <kbd>76</kbd></li>
                     
                     <li><span class="packt_screen">Y</span>: <kbd>53</kbd></li>
                     
                     <li><span class="packt_screen">Width</span>: <kbd>236</kbd></li>
                     
                     <li><span class="packt_screen">Height</span>: <kbd>16</kbd></li>
                     
                  </ul>
                  
               </li>
               
            </ul>
            
            <ol start="22">
               
               <li>Lastly, in the Attributes inspector, update the <span class="packt_screen">Font</span> to <span class="packt_screen">Light</span>, size <kbd>14</kbd>.
               </li>
               
            </ol>
            
            <p>When you are done, your cell should look like the following:</p>
            
            <div class="CDPAlignCenter CDPAlign"><img height="513" src="assets/0710a3eb-886f-44b8-82d9-332b816ad4af.png" width="378"/></div>
            
            <p>Now that we have our items in place, we need to add some Auto Layout to our elements.</p>
            
            
            
         </article>
         
         
         
      </section>
      
   

      
      <section>
         
         
         <header>
            
            <h1 class="header-title">Adding Auto Layout to our  cell</h1>
            
         </header>
         
         
         <article>
            
            
            <p>Let's see how to add Auto Layout to our cell.</p>
            
            <p>Auto Layout will allow our layout to adjust to all devices. Let's get started:</p>
            
            <ol>
               
               <li>Select the image in our cell and then select the Pin icon. Enter the following values
                  under <span>the </span><span class="packt_screen">Add New Constraints</span> section:
                  
                  <ul>
                     
                     <li><span class="packt_screen">Top</span>: <kbd>9</kbd></li>
                     
                     <li><span class="packt_screen">Left</span>: <kbd>8</kbd></li>
                     
                     <li><span class="packt_screen">Constrain to margins</span>: unchecked
                     </li>
                     
                     <li><span class="packt_screen">Width</span>: <kbd>60</kbd> (checked)
                     </li>
                     
                     <li><span class="packt_screen">Height</span>: <kbd>60</kbd> (checked)
                     </li>
                     
                  </ul>
                  
               </li>
               
               <li>Click <span class="packt_screen">Add 4 Constraints</span>.
               </li>
               
               <li>Next, select the first label in our cell and, then, the Pin icon. Enter the following
                  values under the <span class="packt_screen">Add New Constraints</span> section:
                  
                  <ul>
                     
                     <li><span class="packt_screen">Top</span>: <kbd>10</kbd></li>
                     
                     <li><span class="packt_screen">Left</span>: <kbd>8</kbd></li>
                     
                     <li><span class="packt_screen">Right</span>: <kbd>8</kbd></li>
                     
                     <li><span class="packt_screen">Constrain to margins</span>: unchecked
                     </li>
                     
                     <li><span class="packt_screen">Height</span>: <kbd>21</kbd> (checked)
                     </li>
                     
                  </ul>
                  
               </li>
               
               <li>Click <span class="packt_screen">Add 4 Constraints</span>.
               </li>
               
               <li>Next, select the second label in our cell and, then, the Pin icon. Enter the following
                  values under the <span class="packt_screen">Add New Constraints</span> section:
                  
                  <ul>
                     
                     <li><span class="packt_screen">Top</span>: <kbd>4</kbd></li>
                     
                     <li><span class="packt_screen">Left</span>: <kbd>8</kbd></li>
                     
                     <li><span class="packt_screen">Right</span>: <kbd>8</kbd></li>
                     
                     <li><span class="packt_screen">Constrain to margins</span>: unchecked
                     </li>
                     
                     <li><span class="packt_screen">Height</span>: <kbd>16</kbd> (checked)
                     </li>
                     
                  </ul>
                  
               </li>
               
               <li>Click <span class="packt_screen">Add 4 Constraints</span>.
               </li>
               
            </ol>
            
            <p> </p>
            
            <ol start="7">
               
               <li>Finally, select the last label in our cell and, then, the Pin icon. Enter the following
                  values under the <span class="packt_screen">Add New Constraints</span> section:
                  
                  <ul>
                     
                     <li><span class="packt_screen">Top</span>: <kbd>2</kbd></li>
                     
                     <li><span class="packt_screen">Left</span>: <kbd>8</kbd></li>
                     
                     <li><span class="packt_screen">Right</span>: <kbd>8</kbd></li>
                     
                     <li><span class="packt_screen">Constrain to margins</span>: unchecked
                     </li>
                     
                     <li><span class="packt_screen">Height</span>: <kbd>16</kbd> (checked)
                     </li>
                     
                  </ul>
                  
               </li>
               
               <li>Click <span class="packt_screen">Add 4 Constraints</span>.
               </li>
               
            </ol>
            
            <p>We have completed setting up our UI and can now proceed to get data into our app and
               display it.
            </p>
            
            
            
         </article>
         
         
         
      </section>
      
   

      
      <section>
         
         
         <header>
            
            <h1 class="header-title">Creating a framework </h1>
            
         </header>
         
         
         <article>
            
            
            <p>Since all of our code for data is created in our iOS app, it does not make sense to
               rewrite our code for our <em>iMessages</em> app. We can create what is known as a framework to share our data between our iOS
               and iMessage apps.
            </p>
            
            <p>Using frameworks along with app extensions allows us to put shared code in one place.
               That means less code and more efficiency, because you will not need to update code
               in multiple places when you have to make a change. Let's get started creating our
               framework:
            </p>
            
            <ol>
               
               <li>In the Navigator panel, select the Project navigator and, then, your project again
                  as we did earlier.
               </li>
               
               <li>Find the <span class="packt_screen">TARGETS</span> area and click on the <span class="packt_screen">+</span> button at the bottom of that area.
               </li>
               
            </ol>
            
            <p> </p>
            
            <ol start="3">
               
               <li>Under the <span class="packt_screen">iOS</span> tab, scroll to the bottom to <span class="packt_screen">Framework &amp; Library</span>, select <span class="packt_screen">Cocoa Touch Framework</span>, and then hit <span class="packt_screen">Next</span>:
               </li>
               
            </ol>
            
            <div class="CDPAlignCenter CDPAlign"><img height="439" src="assets/b100cfc4-5af7-4fa8-9ff3-e0d8c87c4cd6.png" width="609"/></div>
            
            <ol start="4">
               
               <li>Under <span class="packt_screen">Product Name</span>, type <kbd>LetsEatDataKit</kbd> and then hit <span class="packt_screen">Finish</span>.
               </li>
               
            </ol>
            
            <p style="padding-left: 60px">You should now see the following folder and files in the <kbd>Products</kbd> folder in your Navigator panel:
            </p>
            
            <div class="CDPAlignCenter CDPAlign"><img height="198" src="assets/0f7e6feb-30b5-4397-a297-fa2783d27c2a.png" width="322"/></div>
            
            <ol start="5">
               
               <li>Select the <kbd>LetsEatDataKit</kbd> target and ensure that, under <span class="packt_screen">Deployment Info</span>, your <span class="packt_screen">Deployment Target</span> is set to <kbd>10.0</kbd> and <span class="packt_screen">App Extensions</span> is checked:
               </li>
               
            </ol>
            
            <div class="CDPAlignCenter CDPAlign"><img height="421" src="assets/19f98c5a-92dd-4e61-b9d2-d39a05385026.png" width="756"/></div>
            
            <ol start="6">
               
               <li>Right-click the <kbd>LetsEatDataKit</kbd> folder in the Navigator panel and create a new group named <kbd>Restaurant</kbd>.
               </li>
               
               <li>Now, from your <em>Let's Eat</em> app, please drag the <kbd>RestaurantDataManager.swift</kbd> file from the <kbd>Restaurant</kbd> folder inside of the <kbd>Controllers</kbd> folder into the newly created <kbd>LetsEatDataKit</kbd> folder's <kbd>Restaurant</kbd> folder.
               </li>
               
               <li>Next, drag the <kbd>RestaurantItem.swift</kbd> file from the <kbd>Map</kbd> folder inside of the <kbd>Controllers</kbd> folder into the <kbd>LetsEatDataKit</kbd> folder's <kbd>Restaurant</kbd> folder.
               </li>
               
               <li>Then, drag the <kbd>RestaurantAPIManager.swift</kbd> file from the <kbd>Restaurant</kbd> folder inside of the <kbd>Controllers</kbd> folder into the <kbd>LetsEatDataKit</kbd> folder's <kbd>Restaurant</kbd> folder.
               </li>
               
               <li>Finally, drag the entire <kbd>JSON</kbd> folder from inside of the <kbd>Misc</kbd> folder into the <kbd>LetsEatDataKit</kbd> folder's <kbd>Restaurant</kbd> folder.
               </li>
               
            </ol>
            
            <p style="padding-left: 60px">When you have completed these steps, you should have the following files in your <kbd>LetsEatDataKit</kbd> folder:
            </p>
            
            <div class="CDPAlignCenter CDPAlign"><img height="362" src="assets/8d6ac127-e58b-42c6-b439-dcc3f52f0ee2.png" width="206"/></div>
            
            <ol start="11">
               
               <li>Next, open the <kbd>API Manager</kbd> folder we just moved and, in the <kbd>json</kbd> subfolder, select the <kbd>Aspen.json</kbd> file.
               </li>
               
               <li>In the Utilities panel, select the File inspector and locate the <span class="packt_screen">Target Membership</span> section:
               </li>
               
            </ol>
            
            <div class="CDPAlignCenter CDPAlign"><img src="assets/94379625-408d-4431-9ee9-396b21314b55.png"/></div>
            
            <ol start="13">
               
               <li>To set the target of this file not only to our app but also to our <kbd>MessageApp</kbd> and <kbd>LetsEatDataKit</kbd>, check <span class="packt_screen">MessageApp</span> and <span class="packt_screen">LetsEatDataKit</span> under <span class="packt_screen">Target Membership</span>. Therefore, our <em>Let's Eat</em> app, <span class="packt_screen">MessageApp</span>, and <span class="packt_screen">LetsEatDataKit</span> should all be checked:
               </li>
               
            </ol>
            
            <div class="CDPAlignCenter CDPAlign"><img height="481" src="assets/51353fa9-01bf-40c0-9789-3815ceb8acfe.png" width="530"/></div>
            
            <ol start="14">
               
               <li>Next, select each JSON file inside of the <kbd>json</kbd> folder and update all of the files so that they are all targeted to <kbd>LetsEat</kbd>, <kbd>MessageApp</kbd>, and <kbd>LetsEatDataKit</kbd>.
               </li>
               
            </ol>
            
            <p> </p>
            
            <ol start="15">
               
               <li>Then, select each of the remaining three files inside of the <kbd>LetsEatDataKit</kbd> folder's <kbd>Restaurant</kbd> folder and update them so that each one is targeted to <kbd>LetsEatDataKit</kbd> only.
               </li>
               
               <li>Now, change your target from <kbd>MessageApp</kbd> to <kbd>LetsEatDataKit</kbd>:
               </li>
               
            </ol>
            
            <div class="CDPAlignCenter CDPAlign"><img height="262" src="assets/e9c7afb3-62c0-47d6-86fd-920c10bfe29f.png" width="629"/></div>
            
            <p>Hit ⌘ + <em>B</em> to build the app without running it and your build should be successful as long as
               you updated the target of all of your files.
            </p>
            
            <p>Now, switch back to the <em>Let's Eat</em> app and hit ⌘ + <em>B</em>. You will notice some errors. These errors are expected and are easy to fix:
            </p>
            
            <ol>
               
               <li>Inside of the <kbd>MapViewController.swift</kbd> file, add the following <kbd>import</kbd> at the top of the file:
               </li>
               
            </ol>
            <pre style="padding-left: 60px">import LetsEatDataKit</pre>
            <ol start="2">
               
               <li>Then, continue by updating your <kbd>RestaurantItem</kbd>. We need to make this file public so that it is seen by other files. Therefore, inside
                  of the <kbd>RestaurantItem.swift</kbd> file, update our struct declaration to add <kbd>public</kbd> before the class so that it looks like the following:
               </li>
               
            </ol>
            <pre style="padding-left: 60px">public class RestaurantItem</pre>
            <p style="padding-left: 60px">Similarly, we need to make each of our variables <kbd>public</kbd>, since we are using them all as data. Update all variables by adding the keyword
               <kbd>public</kbd> in front of them and then save the file. When you add <kbd>public</kbd> to the annotation variable, you will see another error occur. This error is complaining
               because we are trying to make the variable <kbd>public</kbd> while the class is not <kbd>public</kbd>.
            </p>
            
            <ol start="3">
               
               <li>Therefore, open your <kbd>RestaurantItem</kbd> class and update the class, each of the following variables, and the <kbd>init()</kbd> method with <kbd>public</kbd> access:
               </li>
               
            </ol>
            <pre style="padding-left: 60px">public class RestaurantItem: NSObject, MKAnnotation<br/>public var name: String?<br/>public var cuisines:[String] = []<br/>public var latitude: Double?<br/>public var longitude:Double?<br/>public var address:String?<br/>public var postalCode:String?<br/>public var state:String?<br/>public var imageURL:String?<br/>public var restaurantID:Int?<br/>public var title: String?<br/>public var subtitle: String?<br/>public var coordinate: CLLocationCoordinate2D<br/>public enum CodingKeys: String, CodingKey</pre>
            <ol start="4">
               
               <li>Save the file and now your <kbd>RestaurantItem</kbd> errors will disappear.
               </li>
               
            </ol>
            
            <p>We still have more minor updates to make. We need to make both our <kbd>RestaurantAPIDataManager</kbd> and <kbd>RestaurantDataManager</kbd> public as well. Let's start with the <kbd>RestaurantAPIDataManager</kbd> and update the following <kbd>struct</kbd> and method with <kbd>public</kbd> access:
            </p>
            <pre>public struct RestaurantAPIManager<br/>public static func loadJSON(file name:String) -&gt; [[String:AnyObject]]</pre>
            <p>Next, update the class and each of the following methods inside of <kbd>RestaurantDataManager</kbd> with <kbd>public</kbd> access:
            </p>
            <pre>public class RestaurantDataManager<br/>public func fetch(by location:String, withFilter:String="All",  completionHandler:() -&gt; Swift.Void)<br/>public func numberOfItems() -&gt; Int<br/>public func restaurantItem(at index:IndexPath) -&gt; RestaurantItem</pre>
            <p>We also need to make our <kbd>init()</kbd> method for our <kbd>RestaurantDataManager</kbd> class <kbd>public</kbd>; so, after the class declaration, add the following:
            </p>
            <pre>public init() {}</pre>
            <p>Having this <kbd>init()</kbd> method allows us to write the following:
            </p>
            <pre>let manager = RestaurantDataManager()</pre>
            <p>When we make it <kbd>public</kbd>, we are calling the <kbd>init()</kbd> method when we have <kbd>RestaurantDataManager()</kbd>.
            </p>
            
            <p>Now, change the target to the <kbd>LetsEatDataKit</kbd> and build it again by hitting ⌘ + <em>B</em>. The build should be successful again at this point. If you, open the <kbd>MapViewController</kbd> file, you should see that all of the errors are fixed in this file.
            </p>
            
            <p>However, we still have more errors to address inside of <kbd>MapDataManager</kbd>, <kbd>LocationViewController</kbd>, <kbd>RestaurantViewController</kbd>, <kbd>ExploreViewController</kbd>, <kbd>RestaurantDetailViewController</kbd>, and <kbd>MessagesViewController</kbd>. Therefore, inside of each of these three files, add the following at the top of
               each file in the <kbd>import</kbd> statement section:
            </p>
            <pre>import LetsEatDataKit</pre>
            <p>Next, hit ⌘ + <em>B</em> again, and there should be no errors inside of any of these three files or in your
               entire project.
            </p>
            
            <p>Now, if you switch the target back to our <em>Let's Eat</em> app and build and run it by hitting the Play button (or using ⌘ + <em>R</em>), you should see that everything is working as expected. We can now start using this
               data in our <em>iMessages</em> app.
            </p>
            
            
            
         </article>
         
         
         
      </section>
      
   

      
      <section>
         
         
         <header>
            
            <h1 class="header-title">Connecting our message cell </h1>
            
         </header>
         
         
         <article>
            
            
            <p>Now that we have our files in order, we can start connecting everything. Earlier,
               we created our cell and now we need to create a cell class with which to connect it:
            </p>
            
            <ol>
               
               <li>Right-click the <kbd>MessageApp</kbd> folder in the Navigator panel and select <span class="packt_screen">New File</span>.
               </li>
               
               <li>Inside of the <span class="packt_screen">Choose a template for your new file screen</span>, select <span class="packt_screen">iOS</span> at the top and, then, <span class="packt_screen">Cocoa Touch Class</span>. Then, hit <span class="packt_screen">Next</span>.
               </li>
               
            </ol>
            
            <p> </p>
            
            <ol start="3">
               
               <li>You will now see an options screen. Please add the following in the new file section:</li>
               
            </ol>
            
            <ul>
               
               <li style="list-style-type: none">
                  
                  <ul>
                     
                     <li><span class="packt_screen">Class</span>: <kbd>RestaurantMessageCell</kbd></li>
                     
                     <li><span class="packt_screen">Subclass</span>: <kbd>UICollectionViewCell</kbd></li>
                     
                     <li><span class="packt_screen">Also create XIB</span>: Unchecked
                     </li>
                     
                     <li><span class="packt_screen">Language</span>: <kbd>Swift</kbd></li>
                     
                  </ul>
                  
               </li>
               
            </ul>
            
            <ol start="4">
               
               <li>Click <span class="packt_screen">Next</span> and, then, <span class="packt_screen">Create</span>.
               </li>
               
               <li>In the new file, add the following inside of the class declaration:</li>
               
            </ol>
            
            <div>
               <pre style="padding-left: 60px">@IBOutlet var lblTitle:UILabel!<br/>@IBOutlet var lblCity:UILabel!<br/>@IBOutlet var lblCuisine:UILabel!</pre></div>
            
            <ol start="6">
               
               <li>Save the file and then open <kbd>MainInterface.storyboard</kbd> in the <kbd>MessageApp</kbd> folder in the Navigator panel.
               </li>
               
               <li>In the Outline view, select the <span class="packt_screen">Collection View Cell</span>.
               </li>
               
               <li>Then, select the Identity inspector in the Utilities panel; and, under <span class="packt_screen">Custom Class</span> in the <span class="packt_screen">Class</span> drop-down menu, select <span class="packt_screen">RestaurantMessageCell</span> and hit <em>Enter</em>.
               </li>
               
               <li>Next, switch to the Attributes inspector in the Utilities panel and update the identifier
                  to <kbd>restaurantCell</kbd> and then hit <em>Enter</em>.
               </li>
               
               <li>Now, switch to the Connections inspector in the Utilities panel, and click and drag
                  from the empty circle next to each outlet listed to the corresponding <kbd>UILabel</kbd> in the screen shown in the following screenshot:
               </li>
               
            </ol>
            <pre style="padding-left: 60px">lblTitle<br/>lblCity<br/>lblCuisine</pre>
            <div class="CDPAlignCenter CDPAlign"><img height="121" src="assets/65332a26-2c94-452d-aa8c-22fa4f14f2d8.png" width="311"/></div>
            
            <p>We now have our cell set up. Let's continue getting our <em>iMessages</em> app working.
            </p>
            
            
            
         </article>
         
         
         
      </section>
      
   

      
      <section>
         
         
         <header>
            
            <h1 class="header-title">Showing restaurants </h1>
            
         </header>
         
         
         <article>
            
            
            <p>We will be showing a list of restaurants just like in our app, but we will not be
               doing the entire interface. Most of this code will be familiar to you as we have done
               it before.
            </p>
            
            <ol>
               
               <li>Open up the <kbd>MessagesViewController.swift</kbd> file in the Navigator panel and add the following code inside of the class declaration:
               </li>
               
            </ol>
            <pre style="padding-left: 60px">@IBOutlet var collectionView: UICollectionView!<br/>let manager = RestaurantDataManager()<br/>var selectedRestaurant:RestaurantItem?</pre>
            <ol start="2">
               
               <li>Next, we need to set up our Collection View defaults. Add the following method inside
                  of a <kbd>private</kbd> extension:
               </li>
               
            </ol>
            <pre style="padding-left: 60px">private extension MessagesViewController {<br/>    func setupCollectionView() {<br/>        let flow = UICollectionViewFlowLayout()<br/>        flow.sectionInset = UIEdgeInsets(top: 7, left: 7, bottom: 7, right: 7)<br/>        flow.minimumInteritemSpacing = 0<br/>        flow.minimumLineSpacing = 7<br/>        collectionView.collectionViewLayout = flow<br/>        collectionView.delegate = self<br/>        collectionView.dataSource = self<br/>    }<br/>}</pre>
            <p style="padding-left: 60px">You will see errors once you add the preceding code. Ignore them for now as we will
               fix them shortly. Now, we will create an <kbd>initialize()</kbd> method that will set up the Collection View and fetch our data.
            </p>
            
            <ol start="3">
               
               <li>Add the following method above the <kbd>createMessage()</kbd> method:
               </li>
               
            </ol>
            <pre style="padding-left: 60px">func initialize() {<br/>   setupCollectionView()<br/>   manager.fetch(by: "Chicago", completionHandler: {<br/>         self.collectionView.reloadData()<br/>   })<br/>}</pre>
            <p style="padding-left: 60px">Since this tab does not contain a location list, we will just pass a city in manually.
               Here, we use Chicago, but you can change it to any city of your choice.
            </p>
            
            <ol start="4">
               
               <li>Next, call the <kbd>initialize()</kbd> method inside of the <kbd>viewDidLoad()</kbd> method, so that your <kbd>viewDidLoad()</kbd> method now looks as follows:
               </li>
               
            </ol>
            <pre style="padding-left: 60px">override func viewDidLoad() {<br/>    super.viewDidLoad()<br/>    initialize()<br/>}</pre>
            <ol start="5">
               
               <li>Then, let's create another extension for our Collection View delegates and data source.
                  After the last curly brace in the <kbd>MessagesViewController.swift</kbd> file, add the following <kbd>extension</kbd> declaration:
               </li>
               
            </ol>
            <pre style="padding-left: 60px">extension MessagesViewController:UICollectionViewDelegate, UICollectionViewDataSource, UICollectionViewDelegateFlowLayout {<br/>}</pre>
            <ol start="6">
               
               <li>Now that we have our <kbd>extension</kbd> set up, let's add all of the methods we need to get our Collection View showing data.
                  Please add the following inside of our extension (which will get rid of our earlier
                  errors):
               </li>
               
            </ol>
            <pre style="padding-left: 60px">func numberOfSections(in collectionView: UICollectionView) -&gt; Int {<br/>    return 1<br/>}<br/><br/>func collectionView(_ collectionView: UICollectionView, numberOfItemsInSection section: Int) -&gt; Int {<br/>    return manager.numberOfItems()<br/>}<br/><br/>func collectionView(_ collectionView: UICollectionView, cellForItemAt indexPath: IndexPath) -&gt; UICollectionViewCell {</pre>
            <pre style="padding-left: 60px">    let cell = collectionView.dequeueReusableCell(withReuseIdentifier: "restaurantCell", for: indexPath) as! RestaurantMessageCell<br/>    let item = manager.restaurantItem(at: indexPath)<br/>    if let name = item.name { cell.lblTitle.text = name }<br/>    if let address = item.address { cell.lblCity.text = address }<br/>    if let cuisine = item.subtitle { cell.lblCuisine.text = cuisine }<br/>    return cell<br/>}<br/><br/>func collectionView(_ collectionView: UICollectionView, layout collectionViewLayout: UICollectionViewLayout, sizeForItemAt indexPath: IndexPath) -&gt; CGSize {<br/>    let cellWidth = self.collectionView.frame.size.width - 14<br/>    return CGSize(width: cellWidth, height: 78)<br/>}<br/><br/>func collectionView(_ collectionView: UICollectionView, didSelectItemAt indexPath: IndexPath) {<br/>    selectedRestaurant = manager.restaurantItem(at: indexPath)<br/>    guard let restaurant = selectedRestaurant else { return }<br/>    createMessage(with: restaurant)<br/>}</pre>
            <p>You should be very familiar with what we just added. We are setting up our Collection
               View data source as well as making sure our cells have a spacing of 14 pixels (7 on
               each side).
            </p>
            
            <p>Lastly, before we build our app, we need to connect our Collection View in the storyboard:</p>
            
            <ol>
               
               <li>Open up <kbd>MainInterface.storyboard</kbd> in the <kbd>MessageApp</kbd> folder in the Navigator panel.
               </li>
               
               <li>Select the <span class="packt_screen">Message View Controller</span> and, then, the Connections inspector in the Utilities panel.
               </li>
               
               <li>Then, under <span class="packt_screen">Outlets</span>, click and drag from the empty circle next to <kbd>collectionView</kbd> to the <span class="packt_screen">Collection View</span> in our scene.
               </li>
               
            </ol>
            
            <p>Let's change the target <em>Message App</em> and build and run our <em>iMessages</em> app by hitting the Play button (or using ⌘ + <em>R</em>). Your app should look similar to the following after clicking the stickers button:
            </p>
            
            <div class="CDPAlignCenter CDPAlign"><img height="477" src="assets/6cec8c83-ea99-41bc-b8a2-854a81c82eee.png" width="537"/></div>
            
            <p>Hitting the arrow (highlighted by the red boxes) will expand the screen to expanded
               mode from compact mode and back again. Now that we have our restaurants displaying,
               we need to be able to send the restaurant reservation to other people. Let's add that
               next.
            </p>
            
            
            
         </article>
         
         
         
      </section>
      
   

      
      <section>
         
         
         <header>
            
            <h1 class="header-title">iMessage crashing </h1>
            
         </header>
         
         
         <article>
            
            
            <p>If you just tried to launch the app and it crashed, there is a fix for this. </p>
            
            <ol>
               
               <li>In the simulator, open the <kbd>Messages</kbd> app.
               </li>
               
               <li>Select <span class="packt_screen">Kate</span>.
               </li>
               
               <li>Then click on the icon with the three dots:</li>
               
            </ol>
            
            <div class="CDPAlignCenter CDPAlign"><img height="509" src="assets/4eb7f125-5898-448d-a709-aff84e6b1712.png" width="290"/></div>
            
            <ol start="4">
               
               <li>Then click <span class="packt_screen">Edit</span>:
               </li>
               
            </ol>
            
            <div class="CDPAlignCenter CDPAlign"><img height="597" src="assets/35081487-1388-47c4-b0f3-fc89dd841a47.png" width="340"/></div>
            
            <ol start="5">
               
               <li>Click the switch for <kbd>MessageApp</kbd>:
               </li>
               
            </ol>
            
            <div class="mce-root CDPAlignCenter CDPAlign"><img height="564" src="assets/41e13e1e-7cae-471b-813f-437fea21e687.png" width="321"/></div>
            
            <ol start="6">
               
               <li>Click <span class="packt_screen">Done</span>.
               </li>
               
            </ol>
            
            <p>Build and rerun the app, and you should be fine. This error is an Apple bug and performing
               these steps is the only way to fix this issue. Let's move on to sending reservations.
            </p>
            
            
            
         </article>
         
         
         
      </section>
      
   

      
      <section>
         
         
         <header>
            
            <h1 class="header-title">Sending reservations  </h1>
            
         </header>
         
         
         <article>
            
            
            <p>We need to set up our Collection View so that, when the user taps on a cell, it will
               add the reservation to the conversation in iMessages. When creating a message to send,
               we have the following things we can set:
            </p>
            
            <div class="CDPAlignCenter CDPAlign"><img height="200" src="assets/7ec4f400-dcb4-41cc-962c-5b5f78df5fb9.png" width="256"/></div>
            
            <p>We will use everything but the <span class="packt_screen">Trailing Caption</span> and <span class="packt_screen">Trailing Subcaption</span>.
            </p>
            
            <ol>
               
               <li>Open up <kbd>MessagesViewController</kbd> in the <kbd>MessageApp</kbd> folder in the Navigator panel.
               </li>
               
               <li>Then, in our main class declaration, add the following method after the <kbd>setupCollectionView()</kbd> method in the <kbd>private</kbd> extension:
               </li>
               
            </ol>
            <pre style="padding-left: 60px">func createMessage(with restaurant:RestaurantItem) {<br/>   if let conversation = activeConversation {<br/>         let layout = MSMessageTemplateLayout()<br/>         layout.image = UIImage(named: "restaurant-detail")<br/>         layout.caption = "Table for 7, tonight at 10:00 PM"<br/>         layout.imageTitle = restaurant.name<br/>         layout.imageSubtitle = restaurant.cuisine<br/>         let message = MSMessage()<br/>         message.layout = layout<br/>         message.url = URL(string: "emptyURL")<br/>         conversation.insert(message, completionHandler: { (error: Error?)  in<br/>               if error != nil {<br/>                     print("there was an error \(error)")<br/>               }<br/>               else {<br/>                     self.requestPresentationStyle(.compact)<br/>               }<br/>         })<br/>   }<br/>}</pre>
            <p>In this method, we are setting up an <kbd>MSMessage</kbd>. We check for an active conversation first. If <kbd>true</kbd>, we then set up our layout. Here, we are just using an image from our assets to create
               an image background (we could have also used a video, for example). Also, we set the
               caption <kbd>Table for 7, tonight at 10:00PM</kbd>. This allows the receiver to see all of the relevant information for the reservation.
               Next, we set the restaurant name as the image title and the restaurant's cuisine as
               the image subtitle. Then, we create an instance of the <kbd>MSMessage</kbd>, pass it the layout we created, and give it a URL (which, in our case, is just an
               empty string, since we do not have an URL). Finally, we insert the message into the
               conversation. We need to make sure that, when we want to send a message, we are in
               compact mode; otherwise, the user will think that the app does not work.
            </p>
            
            <p>Lastly, we just need to add the code that calls our <kbd>createMessage()</kbd> method. Add the following method in our extension, but before the last curly brace:
            </p>
            <pre>func collectionView(_ collectionView: UICollectionView, didSelectItemAt indexPath: IndexPath) {<br/>   selectedRestaurant = manager.restaurantItem(at: indexPath)<br/>   guard let restaurant = selectedRestaurant else { return }<br/>   createMessage(with: restaurant)<br/>}</pre>
            <p>Here, we are checking for when the user taps a cell; then, we get <kbd>selectedRestaurant</kbd> and pass it to our <kbd>createMessage()</kbd> method.
            </p>
            
            <p>Let's build and run the project by hitting the Play button (or using ⌘ + <em>R</em>). Select a restaurant and you will now see a message with the selected restaurant
               in the message area:
            </p>
            
            <div class="CDPAlignCenter CDPAlign"><img height="561" src="assets/9bf8e31f-6c0a-4829-95bb-f5c61c0c1135.png" width="319"/></div>
            
            <p>You can see that, with a little bit of work, you can add a nice <em>iMessages</em> app to your app. 
            </p>
            
            
            
         </article>
         
         
         
      </section>
      
   

      
      <section>
         
         
         <header>
            
            <h1 class="header-title">Summary</h1>
            
         </header>
         
         
         <article>
            
            
            <p>In this chapter, we looked at how to add an <em>iMessage</em> app to our app. We also created a framework that allowed us to use data in both our
               apps without having to duplicate code. We looked at what is involved with creating
               an <kbd>MSMessage</kbd> and how we can pass an <kbd>MSMessageTemplateLayout</kbd> to an <kbd>MSMessage</kbd>. We now know that we can also send embedded videos as well as images when we send
               messages. Also, we can now send reservations through the <em>iMessages</em> app with relevant data for a reservation.
            </p>
            
            <p>In the next chapter, we will go back to our <em>Let's Eat</em> app and we will learn how to work with notifications in our app.
            </p>
            
            
            
         </article>
         
         
         
      </section>
      
   </body></html>