<html><head></head><body><div class="chapter" title="Chapter&#xA0;13.&#xA0;Getting Location and Using Geofencing"><div class="titlepage"><div><div><h1 class="title"><a id="ch13"/>Chapter 13. Getting Location and Using Geofencing</h1></div></div></div><p>In this chapter, we will cover the following topics:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">How to get the last location</li><li class="listitem" style="list-style-type: disc">Resolving problems reported with the GoogleApiClient OnConnectionFailedListener</li><li class="listitem" style="list-style-type: disc">How to receive location updates</li><li class="listitem" style="list-style-type: disc">Create and monitor a Geofence</li></ul></div><div class="section" title="Introduction"><div class="titlepage"><div><div><h1 class="title"><a id="ch13lvl1sec103"/>Introduction</h1></div></div></div><p>Location awareness <a id="id831" class="indexterm"/>offers many benefits to an app, so many in fact that even desktop apps now attempt to get the user's location. Location uses ranges from turn-by-turn directions, "find the nearest" applications, alerts based on location, and there are now even location-based games that get you out exploring with your device.</p><p>The Google APIs<a id="id832" class="indexterm"/> offer many rich features for creating location-aware applications and mapping features. Our first recipe <span class="emphasis"><em>How to get the last location</em></span> will look at obtaining the last known location as stored on the device. If your app is not location intensive, this may provide an ideal way to get the user's location without a large resource overhead. If you need constant updates, then turn to the <span class="emphasis"><em>How to receive location updates</em></span> recipe. Though constant location updates requires more resources, users are likely to understand when you're giving them turn-by-turn directions. If you are requesting location updates for a proximity location, take a look at using the Geofence option instead, in the <span class="emphasis"><em>Create and monitor a Geofence</em></span> recipe.</p><p>All the recipes in this chapter use the Google Libraries. If you have not already downloaded the SDK Packages, follow the instructions from Google.</p><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="tip33"/>Tip</h3><p>Add SDK Packages<a id="id833" class="indexterm"/> from <a class="ulink" href="http://developer.android.com/sdk/installing/adding-packages.html">http://developer.android.com/sdk/installing/adding-packages.html</a>.</p></div></div><p>Now that you have the location, there's a good chance you'll want to map it as well. This is another area where Google makes this very easy on Android using the Google Maps API. To get started with Google Maps, take a look at the <span class="strong"><strong>Google Maps Activity</strong></span> option when creating a new project in Android Studio. Instead of selecting <span class="strong"><strong>Blank Activity</strong></span>, as we normally do for these recipes, choose <span class="strong"><strong>Google Maps Activity</strong></span>, as shown in this screenshot:</p><div class="mediaobject"><img src="graphics/B05057_13_1.jpg" alt="Introduction"/></div></div></div>
<div class="section" title="How to get the last location"><div class="titlepage"><div><div><h1 class="title"><a id="ch13lvl1sec104"/>How to get the last location</h1></div></div></div><p>We'll start this chapter<a id="id834" class="indexterm"/> with a simple recipe that is commonly needed: how to get the last known location. This is an easy way to use APIs with very little overhead resource drain. (This means, your app won't be responsible for killing the battery.)</p><p>This recipe also provides a good introduction to setting up the Google Location APIs.</p><div class="section" title="Getting ready"><div class="titlepage"><div><div><h2 class="title"><a id="ch13lvl2sec387"/>Getting ready</h2></div></div></div><p>Create a new<a id="id835" class="indexterm"/> project in Android Studio and call it: <code class="literal">GetLastLocation</code>. Use the default <span class="strong"><strong>Phone &amp; Tablet </strong></span>options, and select <span class="strong"><strong>Empty Activity</strong></span> when prompted for <span class="strong"><strong>Activity Type</strong></span>.</p></div><div class="section" title="How to do it..."><div class="titlepage"><div><div><h2 class="title"><a id="ch13lvl2sec388"/>How to do it...</h2></div></div></div><p>First, we'll add the necessary permissions to the Android Manifest, then we'll create a layout with a <code class="literal">Button</code> and a <code class="literal">TextView</code> element. Finally, we'll create a <code class="literal">GoogleAPIClient</code> API to access the last location. Open the Android Manifest and follow these steps:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Add the following permission:<div class="informalexample"><pre class="programlisting">&lt;uses-permission android:name="android.permission.ACCESS_COARSE_LOCATION"/&gt;</pre></div></li><li class="listitem">Under the <span class="strong"><strong>Gradle Scripts</strong></span> section, open the <span class="strong"><strong>build.gradle (Module: app)</strong></span> file, as shown in this screenshot:<div class="mediaobject"><img src="graphics/B05057_13_2.jpg" alt="How to do it..."/></div></li><li class="listitem">Add the following statement to the <code class="literal">dependencies</code> section:<div class="informalexample"><pre class="programlisting">compile 'com.google.android.gms:play-services:8.4.0'</pre></div></li><li class="listitem">Open<a id="id836" class="indexterm"/> <code class="literal">activity_main.xml</code> and replace the existing <code class="literal">TextView</code> with the following XML:<div class="informalexample"><pre class="programlisting">&lt;TextView
    android:id="@+id/textView"
    android:layout_width="wrap_content"
    android:layout_height="wrap_content" /&gt;
&lt;Button
    android:id="@+id/button"
    android:layout_width="wrap_content"
    android:layout_height="wrap_content"
    android:text="Get Location"
    android:layout_centerInParent="true"
    android:onClick="getLocation"/&gt;</pre></div></li><li class="listitem">Open <code class="literal">MainActivity.java</code> and add the following global variables:<div class="informalexample"><pre class="programlisting">GoogleApiClient mGoogleApiClient;
TextView mTextView;
Button mButton;</pre></div></li><li class="listitem">Add the class for <code class="literal">ConnectionCallbacks</code>:<div class="informalexample"><pre class="programlisting">GoogleApiClient.ConnectionCallbacks mConnectionCallbacks = new GoogleApiClient.ConnectionCallbacks() {
    @Override
    public void onConnected(Bundle bundle) {
        mButton.setEnabled(true);
    }
    @Override
    public void onConnectionSuspended(int i) {}
};</pre></div></li><li class="listitem">Add the class to handle the <code class="literal">OnConnectionFailedListener</code> callback:<div class="informalexample"><pre class="programlisting">GoogleApiClient.OnConnectionFailedListener mOnConnectionFailedListener = new GoogleApiClient.OnConnectionFailedListener() {
    @Override
    public void onConnectionFailed(ConnectionResult connectionResult) {
        Toast.makeText(MainActivity.this, connectionResult.toString(), Toast.LENGTH_LONG).show();
    }
};</pre></div></li><li class="listitem">Add the following code to the existing <code class="literal">onCreate()</code> method:<div class="informalexample"><pre class="programlisting">mTextView = (TextView) findViewById(R.id.textView);
mButton = (Button) findViewById(R.id.button);
mButton.setEnabled(false);
setupGoogleApiClient();</pre></div></li><li class="listitem">Add <a id="id837" class="indexterm"/>the method to set up <code class="literal">GoogleAPIClient</code>:<div class="informalexample"><pre class="programlisting">protected synchronized void setupGoogleApiClient() {
    mGoogleApiClient = new GoogleApiClient.Builder(this)
        .addConnectionCallbacks(mConnectionCallbacks)
        .addOnConnectionFailedListener(mOnConnectionFailedListener)
        .addApi(LocationServices.API)
        .build();
    mGoogleApiClient.connect();
}</pre></div></li><li class="listitem">Add the following method for the button click:<div class="informalexample"><pre class="programlisting">public void getLocation(View view) {
    try {
        Location lastLocation = LocationServices.FusedLocationApi.getLastLocation(
            mGoogleApiClient);
        if (lastLocation != null) {
            mTextView.setText(
                DateFormat.getTimeInstance().format(lastLocation.getTime()) + "\n" + "Latitude="+lastLocation.getLatitude() + "\n" + "Longitude=" + lastLocation.getLongitude());
        } else {
            Toast.makeText(MainActivity.this, "null", Toast.LENGTH_LONG).show();
        }
    }
    catch (SecurityException e) {e.printStackTrace();}
}</pre></div></li><li class="listitem">You're ready to run the application on a device or emulator.</li></ol></div></div><div class="section" title="How it works..."><div class="titlepage"><div><div><h2 class="title"><a id="ch13lvl2sec389"/>How it works...</h2></div></div></div><p>Before we can call the <code class="literal">getLastLocation()</code> method, we need to set up <code class="literal">GoogleApiClient</code>. We call the <code class="literal">GoogleApiClient.Builder</code> method in our <code class="literal">setupGoogleApiClient()</code> method, then connect to the library. When the library is ready, it calls our <code class="literal">ConnectionCallbacks.onConnected()</code> method. For demonstration purposes, this is where we enable the button. (We'll use this callback in later recipes to start additional features.)</p><p>We used a<a id="id838" class="indexterm"/> button to show we can call <code class="literal">getLastLocation()</code> on demand; it's not a one-time call. The system is responsible for updating the location and may return the same last location on repeated calls. (This can be seen in the timestamp—it's the location timestamp, not the timestamp when the button is pressed.)</p><p>This approach of calling the location on demand can be useful in situations where you only need the location when something happens in your app (such as geocoding an object). Since the system is responsible for the location updates, your app will not be responsible for a battery drain from location updates.</p><p>The accuracy of the location object we receive is based on our permission setting. We used <code class="literal">ACCESS_COARSE_LOCATION</code>, but if we want higher accuracy, we can request <code class="literal">ACCESS_FINE_LOCATION</code> instead, with the following permission:</p><div class="informalexample"><pre class="programlisting">&lt;uses-permission android:name="android.permission.ACCESS_FINE_LOCATION"/&gt;</pre></div><p>Lastly, to keep the code focused on <code class="literal">GoogleApiClient</code>, we just wrap the <code class="literal">getLastLocation()</code> with <code class="literal">SecurityException</code>. In a production application, you should check and request the permission as shown in the previous chapter. (See <span class="emphasis"><em>The new run-time permission model</em></span>.)</p></div><div class="section" title="There's more..."><div class="titlepage"><div><div><h2 class="title"><a id="ch13lvl2sec390"/>There's more...</h2></div></div></div><p>If a problem occurs when connecting to the <code class="literal">GoogleApiClient</code>, the <code class="literal">OnConnectionFailedListener</code> is called. In this example, we display a Toast. The next recipe, <span class="emphasis"><em>Resolving problems reported with the GoogleApiClient OnConnectionFailedListener</em></span>, will show a more robust way to handle this situation.</p><p>Testing the location can be a challenge since it's difficult to actually move the device when testing and debugging. Fortunately, we have the ability to simulate GPS data with the emulator. (It is possible to create mock locations on a physical device as well, but it's not as easy.)</p><div class="section" title="Mock locations"><div class="titlepage"><div><div><h3 class="title"><a id="ch13lvl3sec54"/>Mock locations</h3></div></div></div><p>There are three ways to simulate locations<a id="id839" class="indexterm"/> with the<a id="id840" class="indexterm"/> emulator:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">Android Studio</li><li class="listitem" style="list-style-type: disc">DDMS</li><li class="listitem" style="list-style-type: disc">The <code class="literal">Geo</code> command through Telnet</li></ul></div><p>To set a<a id="id841" class="indexterm"/> mock location in <a id="id842" class="indexterm"/>Android Studio, follow these steps:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Navigate to <span class="strong"><strong>Tools</strong></span> | <span class="strong"><strong>Android</strong></span> | <span class="strong"><strong>Android Device Monitor</strong></span>.</li><li class="listitem">Select the <span class="strong"><strong>Emulator Control</strong></span> tab in the device window.</li><li class="listitem">Enter GPS coordinates under <span class="strong"><strong>Location Controls</strong></span>.</li></ol></div><p>Here's a <a id="id843" class="indexterm"/>screenshot showing the <span class="strong"><strong>Location</strong></span>
<a id="id844" class="indexterm"/>
<span class="strong"><strong> Controls</strong></span>:</p><div class="mediaobject"><img src="graphics/B05057_13_3.jpg" alt="Mock locations"/></div><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="tip34"/>Tip</h3><p>Not that simulating the location works by sending GPS data. Therefore, for your app to receive the mock location, it will need to be receiving GPS data. Testing <code class="literal">lastLocation()</code> may not send the mock GPS data since it doesn't rely solely on the GPS for determining the device location. Try the mock location with the recipe <span class="emphasis"><em>How to receive Location Updates</em></span> where we can request the priority. (We can't force the system to use any specific location sensor, we can only make a request. The system will choose the optimum solution to deliver the results.)</p></div></div></div></div><div class="section" title="See also"><div class="titlepage"><div><div><h2 class="title"><a id="ch13lvl2sec391"/>See also</h2></div></div></div><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">The <span class="emphasis"><em>The new Android 6.0 run-time permission model</em></span> recipe in <a class="link" href="ch14.html" title="Chapter 14. Getting your app ready for the Play Store">Chapter 14</a>, <span class="emphasis"><em>Getting Your App Ready for the Play Store</em></span></li><li class="listitem" style="list-style-type: disc">Setting up <a id="id845" class="indexterm"/>Google Play Services: <a class="ulink" href="https://developers.google.com/android/guides/setup">https://developers.google.com/android/guides/setup</a></li><li class="listitem" style="list-style-type: disc">The <a id="id846" class="indexterm"/><span class="strong"><strong>FusedLocationProviderApi</strong></span> interface: <a class="ulink" href="https://developers.google.com/android/reference/com/google/android/gms/location/FusedLocationProviderApi">https://developers.google.com/android/reference/com/google/android/gms/location/FusedLocationProviderApi</a></li></ul></div></div></div>
<div class="section" title="Resolving problems reported with the GoogleApiClient OnConnectionFailedListener"><div class="titlepage"><div><div><h1 class="title"><a id="ch13lvl1sec105"/>Resolving problems reported with the GoogleApiClient OnConnectionFailedListener</h1></div></div></div><p>With the constantly <a id="id847" class="indexterm"/>changing nature of Google APIs, your users are likely to attempt to use your application, but not be able to because their files are out of date. In the previous example, we just show a Toast, but we can do better. We can use the <code class="literal">GoogleApiAvailability</code> library to display a dialog to help the user resolve the problem.</p><p>We'll continue with the previous recipe and add code to the <code class="literal">onConnectionFailed()</code> callback. We'll use the error result to display additional information to the user to resolve their problem.</p><div class="section" title="Getting ready"><div class="titlepage"><div><div><h2 class="title"><a id="ch13lvl2sec392"/>Getting ready</h2></div></div></div><p>This recipe will continue from the previous recipe, <span class="emphasis"><em>How to get the last location</em></span>. If you are loading the project from the downloaded source files, it is called <code class="literal">HandleGoogleAPIError</code>.</p></div><div class="section" title="How to do it..."><div class="titlepage"><div><div><h2 class="title"><a id="ch13lvl2sec393"/>How to do it...</h2></div></div></div><p>Since we are continuing from the previous recipe, we'll only cover the steps necessary to update the previous code. Open <code class="literal">ActivityMain.java</code> and follow these steps:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Add the following lines to the global class variables:<div class="informalexample"><pre class="programlisting">private final int REQUEST_RESOLVE_GOOGLE_CLIENT_ERROR=1;
boolean mResolvingError;</pre></div></li><li class="listitem">Add the following method to show the Google API error dialog:<div class="informalexample"><pre class="programlisting">private void showGoogleAPIErrorDialog(int errorCode) {
  GoogleApiAvailability googleApiAvailability = GoogleApiAvailability.getInstance();
  Dialog errorDialog = googleApiAvailability.getErrorDialog(this, errorCode, REQUEST_RESOLVE_GOOGLE_CLIENT_ERROR);
  errorDialog.show();
}</pre></div></li><li class="listitem">Add the <a id="id848" class="indexterm"/>following code to override <code class="literal">onActivityResult()</code>:<div class="informalexample"><pre class="programlisting">@Override
protected void onActivityResult(int requestCode, int resultCode, Intent data) {
  if (requestCode == REQUEST_RESOLVE_GOOGLE_CLIENT_ERROR) {
    mResolvingError = false;
    if (resultCode == RESULT_OK &amp;&amp; !mGoogleApiClient.isConnecting() &amp;&amp; !mGoogleApiClient.isConnected()) {
        mGoogleApiClient.connect();
    }
  }
}</pre></div></li><li class="listitem">In <code class="literal">onConnectionFailed()</code>, replace the existing line of code calling Toast, using the following code:<div class="informalexample"><pre class="programlisting">if (mResolvingError) {
  return;
} else if (connectionResult.hasResolution()) {
  mResolvingError = true;
  try {
    connectionResult.startResolutionForResult(MainActivity.this, REQUEST_RESOLVE_GOOGLE_CLIENT_ERROR);
  } catch (IntentSender.SendIntentException e) {
    mGoogleApiClient.connect();
  }
} else {
  showGoogleAPIErrorDialog(connectionResult.getErrorCode());
}</pre></div></li><li class="listitem">You're ready to run the application on a device or emulator.</li></ol></div></div><div class="section" title="How it works..."><div class="titlepage"><div><div><h2 class="title"><a id="ch13lvl2sec394"/>How it works...</h2></div></div></div><p>Instead of displaying the error message with a Toast as we did before, we now check <code class="literal">connectionResult</code> to see what we can do. The <code class="literal">GoogleAPIClient</code> uses the <code class="literal">connectionResult</code> to indicate possible courses of action. We can call the <code class="literal">hasResolution()</code> method, as follows:</p><div class="informalexample"><pre class="programlisting">connectionResult.hasResolution()</pre></div><p>If the response is <a id="id849" class="indexterm"/>
<code class="literal">true</code>, then it's something the user can resolve, such as enabling the location service. If the response is <code class="literal">false</code>, we get an instance of the <code class="literal">GoogleApiAvailability</code> and call the <code class="literal">getErrorDialog()</code> method. When finished, our <code class="literal">onActivityResult()</code> callback is called, where we reset <code class="literal">mResolvingError</code> and, if successful, attempt to reconnect.</p><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="tip35"/>Tip</h3><p>If you do not have a device with an older Google API for testing, you can try testing on an emulator with an older Google API version.</p></div></div></div><div class="section" title="There's more..."><div class="titlepage"><div><div><h2 class="title"><a id="ch13lvl2sec395"/>There's more...</h2></div></div></div><p>If your application is using fragments, you can get a dialog fragment instead, using this code:</p><div class="informalexample"><pre class="programlisting">ErrorDialogFragment errorFragment = new ErrorDialogFragment();
Bundle args = new Bundle();
args.putInt("dialog_error", errorCode);
errorFragment.setArguments(args);
errorFragment.show(getSupportFragmentManager(), "errordialog");</pre></div></div><div class="section" title="See also"><div class="titlepage"><div><div><h2 class="title"><a id="ch13lvl2sec396"/>See also</h2></div></div></div><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">Accessing <a id="id850" class="indexterm"/>Google APIs: <a class="ulink" href="https://developers.google.com/android/guides/api-client">https://developers.google.com/android/guides/api-client</a></li></ul></div></div></div>
<div class="section" title="How to receive location updates"><div class="titlepage"><div><div><h1 class="title"><a id="ch13lvl1sec106"/>How to receive location updates</h1></div></div></div><p>If your application needs frequent<a id="id851" class="indexterm"/> location updates, your application can request periodic updates. This recipe will demonstrate this using the <code class="literal">requestLocationUpdates()</code> method from <code class="literal">GoogleApiClient</code>.</p><div class="section" title="Getting ready"><div class="titlepage"><div><div><h2 class="title"><a id="ch13lvl2sec397"/>Getting ready</h2></div></div></div><p>Create a new project in Android Studio and call it: <code class="literal">LocationUpdates</code>. Use the default <span class="strong"><strong>Phone &amp; Tablet </strong></span>options and select <span class="strong"><strong>Empty Activity</strong></span> when prompted for <span class="strong"><strong>Activity Type</strong></span>.</p></div><div class="section" title="How to do it..."><div class="titlepage"><div><div><h2 class="title"><a id="ch13lvl2sec398"/>How to do it...</h2></div></div></div><p>Since we are receiving <a id="id852" class="indexterm"/>updates from the system, we won't need a button for this recipe. Our layout will consist of just the <code class="literal">TextView</code> to see the location data. Open the Android Manifest and follow these steps:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Add the following permission:<div class="informalexample"><pre class="programlisting">&lt;uses-permission android:name="android.permission.ACCESS_FINE_LOCATION"/&gt;</pre></div></li><li class="listitem">Open the file <code class="literal">build.gradle (Module: app)</code> and add the following statement to the <code class="literal">dependencies</code> section:<div class="informalexample"><pre class="programlisting">compile 'com.google.android.gms:play-services:8.4.0'</pre></div></li><li class="listitem">Open <code class="literal">activity_main.xml</code> and replace the existing <code class="literal">TextView</code> with the following XML:<div class="informalexample"><pre class="programlisting">&lt;TextView
    android:id="@+id/textView"
    android:layout_width="wrap_content"
    android:layout_height="wrap_content" /&gt;</pre></div></li><li class="listitem">Open <code class="literal">MainActivity.java</code> and add the following global variables:<div class="informalexample"><pre class="programlisting">GoogleApiClient mGoogleApiClient;
LocationRequest mLocationRequest;
TextView mTextView;</pre></div></li><li class="listitem">Create the following <code class="literal">LocationListener</code> class:<div class="informalexample"><pre class="programlisting">LocationListener  mLocationListener = new LocationListener() {
    @Override
    public void onLocationChanged(Location location) {
        if (location != null) {
            mTextView.setText(
                DateFormat.getTimeInstance().format(location.getTime()) + "\n" + "Latitude="+location.getLatitude()+"\n" + "Longitude="+location.getLongitude());
        }
    }
};</pre></div></li><li class="listitem">Create a <code class="literal">ConnectionCallbacks</code> class to receive the location updates:<div class="informalexample"><pre class="programlisting">GoogleApiClient.ConnectionCallbacks mConnectionCallbacks = new GoogleApiClient.ConnectionCallbacks() {
    @Override
    public void onConnected(Bundle bundle) {
        Log.i("onConnected()", "start");
        try {
            LocationServices.FusedLocationApi.requestLocationUpdates(
                mGoogleApiClient, mLocationRequest, mLocationListener);
        } catch (SecurityException e) {
            Log.i("onConnected()","SecurityException: "+e.getMessage());
        }
    }
    @Override
    public void onConnectionSuspended(int i) {}
};</pre></div></li><li class="listitem">Create <a id="id853" class="indexterm"/>an <code class="literal">OnConnectionFailedListener</code> class:<div class="informalexample"><pre class="programlisting">GoogleApiClient.OnConnectionFailedListener mOnConnectionFailedListener = new GoogleApiClient.OnConnectionFailedListener() {
    @Override
    public void onConnectionFailed(ConnectionResult connectionResult) {
        Toast.makeText(MainActivity.this, connectionResult.toString(), Toast.LENGTH_LONG).show();
        Log.i("onConnected()", "SecurityException: " +connectionResult.toString());
    }
};</pre></div></li><li class="listitem">Add the following code to the existing <code class="literal">onCreate()</code> callback:<div class="informalexample"><pre class="programlisting">mTextView = (TextView) findViewById(R.id.textView);
setupLocationRequest();</pre></div></li><li class="listitem">Create the <code class="literal">setupLocationRequest()</code> method:<div class="informalexample"><pre class="programlisting">protected synchronized void setupLocationRequest() {
    mLocationRequest = new LocationRequest();
    mLocationRequest.setInterval(10000);
    mLocationRequest.setFastestInterval(10000);
    mLocationRequest.setPriority(LocationRequest.PRIORITY_HIGH_ACCURACY);
    mGoogleApiClient = new GoogleApiClient.Builder(this)
            .addConnectionCallbacks(mConnectionCallbacks)
            .addOnConnectionFailedListener(mOnConnectionFailedListener)
            .addApi(LocationServices.API)
            .build();
    mGoogleApiClient.connect();
}</pre></div></li><li class="listitem">You're ready to run the application on a device or emulator.</li></ol></div></div><div class="section" title="How it works..."><div class="titlepage"><div><div><h2 class="title"><a id="ch13lvl2sec399"/>How it works...</h2></div></div></div><p>This recipe is<a id="id854" class="indexterm"/> similar to the <span class="emphasis"><em>How to get the last location</em></span> recipe, as we need to set up the <code class="literal">GoogleApiClient</code> as we did before. But, instead of calling the <code class="literal">lastLocation()</code> method on demand, we call the <code class="literal">requestLocationUpdates()</code> method to receive periodic location updates through the <code class="literal">LocationListener</code> class.</p><p>The <code class="literal">requestLocationUpdates()</code> method requires three parameters:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><code class="literal">GoogleApiClient</code></li><li class="listitem" style="list-style-type: disc"><code class="literal">LocationRequest</code></li><li class="listitem" style="list-style-type: disc"><code class="literal">LocationListener</code></li></ul></div><p>We create the <code class="literal">GoogleApiClient</code> as we did before. This is the code to create our <code class="literal">LocationRequest</code>:</p><div class="informalexample"><pre class="programlisting">mLocationRequest = new LocationRequest();
mLocationRequest.setInterval(10000);
mLocationRequest.setFastestInterval(10000);
mLocationRequest.setPriority(LocationRequest.PRIORITY_HIGH_ACCURACY)</pre></div><p>When calling <code class="literal">setInterval()</code>, it's generally best to use the slowest delay that works for your purposes, as it requires less device resources. The same idea applies when calling <code class="literal">setPriority()</code>. The third parameter, the <code class="literal">LocationListener</code>, is where we define the callback method <code class="literal">onLocationChanged()</code>. Here we just display the location data along with the location timestamp.</p></div><div class="section" title="There's more..."><div class="titlepage"><div><div><h2 class="title"><a id="ch13lvl2sec400"/>There's more...</h2></div></div></div><p>Unlike the previous Android APIs, the <code class="literal">GoogleApiClient</code> API does not allow the selection of specific sensors for the location updates. As mentioned in the <span class="emphasis"><em>Mock Locations</em></span> section of <span class="emphasis"><em>How to get the last Location</em></span>, using <code class="literal">LocationRequest.PRIORITY_HIGH_ACCURACY</code> along with the <code class="literal">ACCESS_FINE_LOCATION</code> permission should use the GPS sensor. Refer to the <span class="emphasis"><em>Mock Locations</em></span> section for instructions on simulating your location.</p><div class="section" title="Stop receiving location updates"><div class="titlepage"><div><div><h3 class="title"><a id="ch13lvl3sec55"/>Stop receiving location updates</h3></div></div></div><p>When your<a id="id855" class="indexterm"/> application no longer needs location updates, call the <code class="literal">removeLocationUpdates()</code> method, as shown here:</p><div class="informalexample"><pre class="programlisting">LocationServices.FusedLocationApi.removeLocationUpdates(
    mGoogleApiClient, mLocationListener);</pre></div><p>Generally, you would want to disable updates when your application is no longer in the foreground, but this depends on your specific application requirements. If your application needs constant updates, it <a id="id856" class="indexterm"/>may be more desirable to create a background service to handle the callbacks.</p></div></div><div class="section" title="See also"><div class="titlepage"><div><div><h2 class="title"><a id="ch13lvl2sec401"/>See also</h2></div></div></div><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>Developer Docs: onLocationChanged</strong></span> <a id="id857" class="indexterm"/>at <a class="ulink" href="https://developer.android.com/reference/com/google/android/gms/location/LocationRequest.html">https://developer.android.com/reference/com/google/android/gms/location/LocationRequest.html</a></li></ul></div></div></div>
<div class="section" title="Create and monitor a Geofence"><div class="titlepage"><div><div><h1 class="title"><a id="ch13lvl1sec107"/>Create and monitor a Geofence</h1></div></div></div><p>If your application needs to know when the user enters a certain location, there's an alternative to having to continuously check the user location: Geofencing. A Geofence is a location (latitude and longitude) along with a radius. You can create a Geofence and let the system notify you when the user enters the location proximity you specified. (Android currently allows up to 100 Geofences per user.)</p><p>Geofence<a id="id858" class="indexterm"/> properties include:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>Location</strong></span>: The <a id="id859" class="indexterm"/>longitude and latitude</li><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>Radius</strong></span>: The <a id="id860" class="indexterm"/>size of the circle (in meters)</li><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>Loitering delay</strong></span> : How long <a id="id861" class="indexterm"/>the user may remain within the radius before sending notifications</li><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>Expiration</strong></span>: <a id="id862" class="indexterm"/>How long until the Geofence automatically expires</li><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>Transition</strong></span><a id="id863" class="indexterm"/><span class="strong"><strong> type</strong></span>: <a id="id864" class="indexterm"/>These are <a id="id865" class="indexterm"/>listed as follows:<div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><code class="literal">GEOFENCE_TRANSITION_ENTER</code></li><li class="listitem" style="list-style-type: disc"><code class="literal">GEOFENCE_TRANSITION_EXIT</code></li><li class="listitem" style="list-style-type: disc"><code class="literal">INITIAL_TRIGGER_DWELL</code></li></ul></div></li></ul></div><p>This recipe will show you how to create a Geofence object and use it to create an instance of <code class="literal">GeofencingRequest</code>.</p><div class="section" title="Getting ready"><div class="titlepage"><div><div><h2 class="title"><a id="ch13lvl2sec402"/>Getting ready</h2></div></div></div><p>Create a new project in Android Studio and call it: <code class="literal">Geofence</code>. Use the default <span class="strong"><strong>Phone &amp; Tablet </strong></span>options and select <span class="strong"><strong>Empty Activity</strong></span> when prompted for <span class="strong"><strong>Activity Type</strong></span>.</p></div><div class="section" title="How to do it..."><div class="titlepage"><div><div><h2 class="title"><a id="ch13lvl2sec403"/>How to do it...</h2></div></div></div><p>We won't need a layout for this recipe as we'll use Toasts and Notifications for the user interaction. We will need to create an additional Java class for <code class="literal">IntentService</code>, which handles the Geofence alerts. Open the Android Manifest and follow these steps:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Add the following permission:<div class="informalexample"><pre class="programlisting">&lt;uses-permission android:name="android.permission.ACCESS_FINE_LOCATION"/&gt;</pre></div></li><li class="listitem">Open the file <code class="literal">build.gradle (Module: app)</code> and add the following statement to the <code class="literal">dependencies</code> section:<div class="informalexample"><pre class="programlisting">compile 'com.google.android.gms:play-services:8.4.0'</pre></div></li><li class="listitem">Create a new <a id="id866" class="indexterm"/>Java class called <code class="literal">GeofenceIntentService</code> and <a id="id867" class="indexterm"/>extend the <code class="literal">IntentService</code> class. The declaration will look as follows:<div class="informalexample"><pre class="programlisting">public class GeofenceIntentService extends IntentService {</pre></div></li><li class="listitem">Add the following constructor:<div class="informalexample"><pre class="programlisting">public GeofenceIntentService() {
    super("GeofenceIntentService");
}</pre></div></li><li class="listitem">Add <code class="literal">onHandleIntent()</code> to receive the Geofence alert:<div class="informalexample"><pre class="programlisting">protected void onHandleIntent(Intent intent) {
    GeofencingEvent geofencingEvent = GeofencingEvent.fromIntent(intent);
    if (geofencingEvent.hasError()) {
        Toast.makeText(getApplicationContext(), "Geofence error code= " + geofencingEvent.getErrorCode(), Toast.LENGTH_SHORT).show();
        return;
    }
    int geofenceTransition = geofencingEvent.getGeofenceTransition();
    if (geofenceTransition == Geofence.GEOFENCE_TRANSITION_DWELL) {
        sendNotification();
    }
}</pre></div></li><li class="listitem">Add the <code class="literal">sendNotification()</code> method to display the message to the user:<div class="informalexample"><pre class="programlisting">private void sendNotification() {
    Log.i("GeofenceIntentService", "sendNotification()");
    Uri notificationSoundUri = RingtoneManager.getDefaultUri(RingtoneManager.TYPE_NOTIFICATION);
    NotificationCompat.Builder notificationBuilder = new NotificationCompat.Builder(this)
            .setSmallIcon(R.mipmap.ic_launcher)
            .setContentTitle("Geofence Alert")
            .setContentText("GEOFENCE_TRANSITION_DWELL")
            .setSound(notificationSoundUri)
            .setLights(Color.BLUE, 500, 500);
    NotificationManager notificationManager = (NotificationManager) getApplicationContext().getSystemService(Context.NOTIFICATION_SERVICE);
    notificationManager.notify(0, notificationBuilder.build());
}</pre></div></li><li class="listitem">Open the Android manifest and add the following within the <code class="literal">&lt;application&gt;</code> element, at the same level as the <code class="literal">&lt;activity&gt;</code> element:<div class="informalexample"><pre class="programlisting">&lt;service android:name=".GeofenceIntentService"/&gt;</pre></div></li><li class="listitem">Open <code class="literal">MainActivity.java</code> and add the following global variables:<div class="informalexample"><pre class="programlisting">private final int MINIMUM_RECOMENDED_RADIUS=100;
GoogleApiClient mGoogleApiClient;
PendingIntent mGeofencePendingIntent;</pre></div></li><li class="listitem">Create <a id="id868" class="indexterm"/>the <a id="id869" class="indexterm"/>following <code class="literal">ResultCallback</code> class:<div class="informalexample"><pre class="programlisting">ResultCallback mResultCallback = new ResultCallback() {
    @Override
    public void onResult(Result result) {
        Log.i("onResult()", "result: " + result.getStatus().toString());
    }
};</pre></div></li><li class="listitem">Create a <code class="literal">ConnectionCallbacks</code> class:<div class="informalexample"><pre class="programlisting">GoogleApiClient.ConnectionCallbacks mConnectionCallbacks = new GoogleApiClient.ConnectionCallbacks() {
    @Override
    public void onConnected(Bundle bundle) {
        try {
          LocationServices.GeofencingApi.addGeofences(
              mGoogleApiClient,
              createGeofencingRequest(),
              getGeofencePendingIntent()
          ).setResultCallback(mResultCallback);
        } catch (SecurityException e) {
            Log.i("onConnected()", "SecurityException: " + e.getMessage());
        }
    }
    @Override
    public void onConnectionSuspended(int i) {}
};</pre></div></li><li class="listitem">Create an <code class="literal">OnConnectionFailedListener</code> class:<div class="informalexample"><pre class="programlisting">GoogleApiClient.OnConnectionFailedListener mOnConnectionFailedListener = new GoogleApiClient.OnConnectionFailedListener() {
    @Override
    public void onConnectionFailed(ConnectionResult connectionResult) {
        Log.i("onConnectionFailed()", "connectionResult: " +connectionResult.toString());
    }
};</pre></div></li><li class="listitem">Add the<a id="id870" class="indexterm"/> following code to the existing <code class="literal">onCreate()</code> <a id="id871" class="indexterm"/>callback:<div class="informalexample"><pre class="programlisting">  setupGoogleApiClient();</pre></div></li><li class="listitem">Add the method to setup the <code class="literal">GoogleAPIClient</code>:<div class="informalexample"><pre class="programlisting">protected synchronized void setupGoogleApiClient() {
    mGoogleApiClient = new GoogleApiClient.Builder(this)
        .addConnectionCallbacks(mConnectionCallbacks)
        .addOnConnectionFailedListener(mOnConnectionFailedListener)
        .addApi(LocationServices.API)
        .build();
    mGoogleApiClient.connect();
}</pre></div></li><li class="listitem">Create the <code class="literal">setupGoogleApiClient()</code> method:<div class="informalexample"><pre class="programlisting">protected synchronized void setupGoogleApiClient() {
    mGoogleApiClient = new GoogleApiClient.Builder(this)
        .addConnectionCallbacks(mConnectionCallbacks)
        .addOnConnectionFailedListener(mOnConnectionFailedListener)
        .addApi(LocationServices.API)
        .build();
    mGoogleApiClient.connect();
}</pre></div></li><li class="listitem">Create a pending intent with the following method:<div class="informalexample"><pre class="programlisting">private PendingIntent getGeofencePendingIntent() {
    if (mGeofencePendingIntent != null) {
        return mGeofencePendingIntent;
    }
    Intent intent = new Intent(this, GeofenceIntentService.class);
    return PendingIntent.getService(this, 0, intent, PendingIntent.FLAG_UPDATE_CURRENT);
}</pre></div></li><li class="listitem">Create the <code class="literal">geofence</code> object and add it to a list for the request:<div class="informalexample"><pre class="programlisting">private List createGeofenceList() {
    List&lt;Geofence&gt; geofenceList = new ArrayList&lt;Geofence&gt;();
    geofenceList.add(new Geofence.Builder()
            .setRequestId("GeofenceLocation")
            .setCircularRegion(
                    37.422006, //Latitude
                    -122.084095, //Longitude
                    MINIMUM_RECOMENDED_RADIUS)
            .setLoiteringDelay(30000)
            .setExpirationDuration(Geofence.NEVER_EXPIRE)
            .setTransitionTypes(Geofence.GEOFENCE_TRANSITION_DWELL)
    .build());
    return geofenceList;
}</pre></div></li><li class="listitem">Create the<a id="id872" class="indexterm"/> <code class="literal">createGeofencingRequest()</code> method as follows:<div class="informalexample"><pre class="programlisting">private GeofencingRequest createGeofencingRequest() {
    GeofencingRequest.Builder builder = new GeofencingRequest.Builder();
    builder.setInitialTrigger(GeofencingRequest.INITIAL_TRIGGER_DWELL);
    builder.addGeofences(createGeofenceList());
    return builder.build();
}</pre></div></li><li class="listitem">You're ready<a id="id873" class="indexterm"/> to run the application on a device or emulator.</li></ol></div></div><div class="section" title="How it works..."><div class="titlepage"><div><div><h2 class="title"><a id="ch13lvl2sec404"/>How it works...</h2></div></div></div><p>First, we add the <code class="literal">ACCESS_FINE_LOCATION</code> permission as this is required for Geofencing. We set up the <code class="literal">GoogleApiClient</code> as we've done in previous recipes and wait until <code class="literal">onConnected()</code> is called to set up the <code class="literal">GeofencingApi</code>.</p><p>Before we can call the <code class="literal">GeofencingApi.addGeofences()</code> method, we have to prepare three objects:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><code class="literal">GoogleApiClient</code></li><li class="listitem" style="list-style-type: disc">Geofence Request</li><li class="listitem" style="list-style-type: disc">Pending Intent</li></ul></div><p>We already <a id="id874" class="indexterm"/>created the <code class="literal">GoogleApiClient</code>, which we saved in the <code class="literal">mGoogleApiClient</code>.</p><p>To create the <a id="id875" class="indexterm"/>Geofence Request, we use the <code class="literal">GeofencingRequest.Builder</code>. The builder requires the list of Geofence objects, which are created in the <code class="literal">createGeofenceList()</code> method. (Even though we are only creating a single Geofence object, the builder requires a list, so we just add our single Geofence to an <code class="literal">ArrayList</code>.) Here is where we set the Geofence properties:</p><div class="informalexample"><pre class="programlisting">.setRequestId("GeofenceLocation")
.setCircularRegion(
        37.422006, //Latitude
        -122.084095, //Longitude
        MINIMUM_RECOMENDED_RADIUS)
.setLoiteringDelay(30000)
.setExpirationDuration(Geofence.NEVER_EXPIRE)
.setTransitionTypes(Geofence.GEOFENCE_TRANSITION_DWELL)</pre></div><p>Only the Loitering delay is optional, but we need it since we are using the <code class="literal">DWELL</code> transition. When calling <code class="literal">setTransitionTypes()</code>, we can combine multiple transition types using the <code class="literal">OR</code> operator, shown with the pipe. Here's an example using <code class="literal">ENTER</code> and <code class="literal">EXIT</code> instead:</p><div class="informalexample"><pre class="programlisting">.setTransitionTypes(Geofence.GEOFENCE_TRANSITION_ENTER | Geofence.GEOFENCE_TRANSITION_EXIT)</pre></div><p>For this example, we used the same default latitude and longitude as the emulator. Change these values as needed.</p><p>Our call to <code class="literal">Geofence.Builder()</code> creates the Geofence object. With the Geofence list ready, we call the <code class="literal">GeofencingRequest.Builder</code> and set our initial trigger to <code class="literal">INITIAL_TRIGGER_DWELL</code>. (If you change the preceding transition types, you may want to change the initial trigger as well.)</p><p>The last object we need is a Pending Intent, which is how the system will notify our app when the Geofence criteria are met. We created the <code class="literal">GeofenceIntentService</code> to handle the Geofence intent by sending a notification to the user. (For more information on notifications, refer to the <span class="emphasis"><em>Lights, Action, and Sound Redux using Notifications</em></span> recipe in <a class="link" href="ch07.html" title="Chapter 7. Alerts and Notifications">Chapter 7</a>, <span class="emphasis"><em>Alerts and Notifications</em></span>.)</p><p>With all three objects<a id="id876" class="indexterm"/> created, we <a id="id877" class="indexterm"/>just call <code class="literal">LocationServices.GeofencingApi.addGeofences()</code> and wait for the notification to arrive.</p></div><div class="section" title="There's more..."><div class="titlepage"><div><div><h2 class="title"><a id="ch13lvl2sec405"/>There's more...</h2></div></div></div><p>To stop receiving Geofence notifications, you can call the <code class="literal">removeGeofences()</code> method with either the <code class="literal">RequestID</code> parameter or <code class="literal">PendingIntent</code>. The following example uses the same <code class="literal">PendingIntent</code> method we used for the notification:</p><div class="informalexample"><pre class="programlisting">LocationServices.GeofencingApi.removeGeofences(
    mGoogleApiClient,
    getGeofencePendingIntent()
).setResultCallback(mResultCallback);</pre></div></div><div class="section" title="See also"><div class="titlepage"><div><div><h2 class="title"><a id="ch13lvl2sec406"/>See also</h2></div></div></div><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">The <code class="literal">Geofence.Builder</code> class<a id="id878" class="indexterm"/> at: <a class="ulink" href="https://developers.google.com/android/reference/com/google/android/gms/location/Geofence.Builder.html">https://developers.google.com/android/reference/com/google/android/gms/location/Geofence.Builder.html</a></li><li class="listitem" style="list-style-type: disc">The <code class="literal">GeofencingRequest.Builder</code> class<a id="id879" class="indexterm"/> at: <a class="ulink" href="https://developers.google.com/android/reference/com/google/android/gms/location/GeofencingRequest.Builder">https://developers.google.com/android/reference/com/google/android/gms/location/GeofencingRequest.Builder</a></li></ul></div></div></div></body></html>