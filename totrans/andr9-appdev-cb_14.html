<html><head></head><body>
        <section>

                            <header>
                    <h1 class="header-title">Location and Using Geofencing</h1>
                </header>
            
            <article>
                
<p>In this chapter, we will cover the following topics:</p>
<ul>
<li>How to get the device location</li>
<li>Resolving problems reported with the <kbd>GoogleApiClient</kbd> <kbd>OnConnectionFailedListener</kbd></li>
<li>Creating and monitoring a Geofence</li>
</ul>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Introduction</h1>
                </header>
            
            <article>
                
<p>Location awareness offers many benefits to an app, so many in fact that even desktop apps now attempt to get the user's location. Location uses ranges from turn-by-turn directions, "find the nearest" applications, alerts based on location, and there are now even location-based games that get you out exploring with your device.</p>
<p>The Google APIs offer many rich features for creating location-aware applications and mapping features. Our first recipe will look at obtaining the last known location on the device along with receiving updates as the location changes. If you are requesting location updates for a proximity location, take a look at using the Geofence option instead in the <em>Create and monitor a Geofence</em> recipe.</p>
<p>All the recipes in this chapter use the Google Libraries. If you have not already downloaded the SDK Packages, follow the instructions from Google.</p>
<div class="packt_tip">Add SDK Packages from <a href="http://developer.android.com/sdk/installing/adding-packages.html"><span class="URLPACKT">http://developer.android.com/sdk/installing/adding-packages.html</span></a>.</div>
<p>Now that you have the location, there's a good chance you'll want to map it as well. This is another area where Google makes this very easy on Android using the Google Maps API. When working with Google Maps, take a look at the <span class="packt_screen">Google Maps Activity</span> option when creating a new project in Android Studio. Instead of selecting <span class="packt_screen">Empty </span><span class="packt_screen">Activity</span>, as we normally do for these recipes, choose <span class="packt_screen">Google Maps Activity</span>, as shown in this screenshot:</p>
<p class="CDPAlignCenter CDPAlign"><img src="assets/b640cd9c-d765-4293-b587-5bea1f5c7110.png" style="width:39.50em;height:49.33em;"/></p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">How to get the device location</h1>
                </header>
            
            <article>
                
<p>This first recipe will show you how to get the last known location. If you've worked with the Google Location APIs in the past, then you may notice things have changed. This recipe shows you the latest API for getting both the last location and updates as the location changes.</p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Getting ready</h1>
                </header>
            
            <article>
                
<p>Create a new project in Android Studio and call it <kbd>GetLocation</kbd>. Use the default <span class="packt_screen">Phone &amp; Tablet</span> options, and select <span class="packt_screen">Empty Activity</span> when prompted for <span class="packt_screen">Activity Type</span>.</p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">How to do it...</h1>
                </header>
            
            <article>
                
<p>First, we'll add the necessary permissions to the Android Manifest, then we'll modify the <kbd>TextView</kbd> element to include an ID. Finally, we'll add a method to receive the last known location callback. Open the Android Manifest and follow these steps:</p>
<ol>
<li>Add the following permission:</li>
</ol>
<pre style="padding-left: 60px"><span>&lt;uses-permission </span><span>android</span><span>:name=</span><span>"android.permission.ACCESS_COARSE_LOCATION"</span><span>/&gt;</span></pre>
<ol start="2">
<li>Under the <span class="packt_screen">Gradle Scripts</span> section, open the <span class="packt_screen">build.gradle (Module: app)</span> file, as shown in this screenshot:</li>
</ol>
<p class="CDPAlignCenter CDPAlign"><img src="assets/0007bab5-d893-4324-9909-477d610f6440.png" style="width:28.58em;height:22.33em;"/></p>
<ol start="3">
<li>Add the following statement to the <kbd>dependencies</kbd> section:</li>
</ol>
<pre style="padding-left: 60px">implementation <span>'com.google.android.gms:play-services:12.0.1'</span></pre>
<ol start="4">
<li>Open <kbd>activity_main.xml</kbd> and update the existing <kbd>TextView</kbd> with the following XML:</li>
</ol>
<pre style="padding-left: 60px"><span>&lt;TextView<br/></span><span>    </span><span>android</span><span>:id=</span><span>"@+id/textView"<br/></span><span>    </span><span>android</span><span>:layout_width=</span><span>"wrap_content"<br/></span><span>    </span><span>android</span><span>:layout_height=</span><span>"wrap_content"<br/></span><span>    </span><span>app</span><span>:layout_constraintBottom_toBottomOf=</span><span>"parent"<br/></span><span>    </span><span>app</span><span>:layout_constraintEnd_toEndOf=</span><span>"parent"<br/></span><span>    </span><span>app</span><span>:layout_constraintStart_toStartOf=</span><span>"parent"<br/></span><span>    </span><span>app</span><span>:layout_constraintTop_toTopOf=</span><span>"parent" </span><span>/&gt;</span></pre>
<ol start="5">
<li>Add the following code to the existing <kbd>onCreate()</kbd> method:</li>
</ol>
<pre style="padding-left: 60px"><span>if </span>(ActivityCompat.<span>checkSelfPermission</span>(<span>this, </span><span>ACCESS_COARSE_LOCATION</span>)<br/>        == PackageManager.<span>PERMISSION_GRANTED</span>) {<br/>    getLocation()<span>;<br/></span>} <span>else </span>{<br/>    ActivityCompat.<span>requestPermissions</span>(<span>this, new </span>String[] {<span>ACCESS_COARSE_LOCATION</span>}<span>,</span><span>1</span>)<span>;<br/></span>}</pre>
<p style="padding-left: 60px">6. Create the <kbd>getLocation()</kbd> method as follows:</p>
<pre style="padding-left: 60px"><span>private void </span><span>getLocation</span>() <span>throws </span>SecurityException {<br/>    LocationServices.<span>getFusedLocationProviderClient</span>(<span>this</span>).getLastLocation()<br/>            .addOnSuccessListener(<span>this, new </span>OnSuccessListener&lt;Location&gt;() {<br/>                <span>@Override<br/></span><span>                </span><span>public void </span><span>onSuccess</span>(Location location) {<br/>                    <span>final </span>TextView textView = findViewById(R.id.<span>textView</span>)<span>;<br/></span><span>                    if </span>(location != <span>null</span>) {<br/>                        textView.setText(DateFormat.<span>getTimeInstance</span>()<br/>                                .format(location.getTime()) + <span>"</span><span>\n</span><span>"<br/></span><span>                                </span>+ <span>"Latitude=" </span>+ location.getLatitude() + <span>"</span><span>\n</span><span>"<br/></span><span>                                </span>+ <span>"Longitude=" </span>+ location.getLongitude())<span>;<br/></span><span>                    </span>} <span>else </span>{<br/>                        Toast.<span>makeText</span>(MainActivity.<span>this, </span><span>"Location null"</span><span>, </span>Toast.<span>LENGTH_LONG</span>)<br/>                                .show()<span>;<br/></span><span>                    </span>}<br/>                }<br/>            })<span>;<br/></span>}</pre>
<p style="padding-left: 60px">7. <span>You're ready to run the application on a device or emulator.</span></p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">How it works...</h1>
                </header>
            
            <article>
                
<p>This code example uses the latest version (12.0.1, as of this writing) of the Google Play service's <kbd>getLastLocation()</kbd> method. If you've ever used it in the past, you may notice significant changes in how this API works. It's actually much simpler now as all we have to do is call the <kbd>getFusedLocationProviderClient()</kbd> and pass our listener. Make sure we check the location in the callback to make sure it's not null. (There are several scenarios that can result in a null location, such as the device not having a location yet, the user disabled the location feature, and factory reset.)</p>
<p>The accuracy of the location object we receive is based on our permission setting. We used <kbd>ACCESS_COARSE_LOCATION</kbd>, but if we want higher accuracy, we can request <kbd>ACCESS_FINE_LOCATION</kbd> instead, with the following permission:</p>
<pre>&lt;uses-permission android:name="android.permission.ACCESS_FINE_LOCATION"/&gt;</pre>
<p>Make sure to check for the appropriate permission in the <kbd>checkSelfPermission()</kbd> call.</p>
<p>Lastly, to keep the code focused on the Location feature, we just do a simple permission check. In a production application, you should check and request permission as shown in <em>The Android 6.0 Runtime Permission Model</em> recipe in <a href="98c7bc7b-43e2-43de-aed4-fe2fb6dc72f3.xhtml">Chapter 15</a>, <span class="cdp-organizer-chapter-title"><span class="cdp-organize-title-label"><em>Getting Your App Ready for the Play Store.</em></span></span></p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">There's more...</h1>
                </header>
            
            <article>
                
<p>Testing the location can be a challenge since it's difficult to actually move the device when testing and debugging. Fortunately, we have the ability to simulate GPS data with the emulator. (It is possible to create mock locations on a physical device as well, but that's not as easy.)</p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Mock locations</h1>
                </header>
            
            <article>
                
<p>There are several ways to simulate locations with the emulator:</p>
<ul>
<li>Location setting through the emulator</li>
<li>The <kbd>Geo</kbd> command through the ADB shell</li>
</ul>
<p>To set a mock location in the emulator, follow these steps:</p>
<ol>
<li>Click the <span class="packt_screen">more</span> options button (the one with <span class="packt_screen">...</span> at the bottom of the emulator control options)</li>
<li>Select the <span class="packt_screen">Location</span> tab in the device window</li>
<li>Enter the GPS coordinates in the <span class="packt_screen">Longitude</span> and <span class="packt_screen">Latitude</span> boxes</li>
</ol>
<p>Here's a screenshot showing the <span class="packt_screen">Location </span>tab:</p>
<p class="CDPAlignCenter CDPAlign"><img src="assets/f876152f-a34e-4e64-9d68-84f1bb91267f.png"/></p>
<div class="packt_tip">Note that simulating the location works by sending GPS data. Therefore, for your app to receive the mock location, it will need to be receiving GPS data. Testing <kbd>lastLocation()</kbd> may not send the mock GPS data since it doesn't rely solely on the GPS for determining the device location. Try the mock location with the <em>How to get the device location</em> recipe<span> where we can request the priority. (We can't force the system to use any specific location sensor, we can only make a request. The system will choose the optimum solution to deliver the results.)</span></div>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">See also</h1>
                </header>
            
            <article>
                
<ul>
<li><em>The new Android 6.0 run-time permission model</em> recipe in <a href="98c7bc7b-43e2-43de-aed4-fe2fb6dc72f3.xhtml"><span class="ChapterrefPACKT">Chapter 15</span></a>, <em>Getting Your App Ready for the Play Store</em></li>
<li>Setting up Google Play Services: <a href="https://developers.google.com/android/guides/setup"><span class="URLPACKT">https://developers.google.com/android/guides/setup</span></a></li>
<li>The <span class="packt_screen">FusedLocationProviderClient</span> interface: <a href="https://developers.google.com/android/reference/com/google/android/gms/location/FusedLocationProviderClient">https://developers.google.com/android/reference/com/google/android/gms/location/FusedLocationProviderClient</a></li>
</ul>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Resolving problems reported with the GoogleApiClient OnConnectionFailedListener</h1>
                </header>
            
            <article>
                
<p>With the constantly changing nature of Google APIs, your users are likely to attempt to use your application, but not be able to because their files are out of date. We can use the <kbd>GoogleApiAvailability</kbd> library to display a dialog to help the user resolve the problem.</p>
<p>We'll continue with the previous recipe and add code to the <kbd>onConnectionFailed()</kbd> callback. We'll use the error result to display additional information to the user to resolve their problem.</p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Getting ready</h1>
                </header>
            
            <article>
                
<p><span>Create a new project in Android Studio and call it <kbd>HandleGoogleAPIError</kbd></span><span>. Use the default </span><span class="packt_screen">Phone &amp; Tablet</span><span> options, and select </span><span class="packt_screen">Empty Activity</span><span> when prompted for </span><span class="packt_screen">Activity Type</span><span>. Once you've created the project, add the Google Play library reference to the project dependencies. (See the previous recipe steps.)</span></p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">How to do it...</h1>
                </header>
            
            <article>
                
<p>The first step for this recipe is to add the Google Play Services library to the project. From there, we'll create the classes to handle the Google Client callbacks and use toasts to give feedback. To start, open<span> the </span><span class="packt_screen">build.gradle (Module: app)</span><span> file and follow these steps (if you're not sure which file to open, see the screenshot in the previous recipe steps):</span></p>
<ol>
<li>Add the following statement to the<span> </span><kbd>dependencies</kbd><span> </span>section:</li>
</ol>
<ol start="3"/>
<pre style="padding-left: 60px">implementation <span>'com.google.android.gms:play-services:12.0.1'</span></pre>
<ol start="2">
<li>O<span>pen </span><kbd>ActivityMain.java</kbd> <span>and a</span><span>dd the following lines to the global class variables:</span></li>
</ol>
<pre style="padding-left: 60px"><span>private final int </span><span>REQUEST_RESOLVE_GOOGLE_CLIENT_ERROR</span>=<span>1</span><span>;<br/></span><span>boolean </span><span>mResolvingError</span><span>;<br/></span>GoogleApiClient <span>mGoogleApiClient</span><span>;</span></pre>
<p class="mce-root"/>
<ol start="3">
<li>Add the following two classes to handle the callbacks:</li>
</ol>
<pre style="padding-left: 60px">GoogleApiClient.ConnectionCallbacks <span>mConnectionCallbacks </span>=<br/>        <span>new </span>GoogleApiClient.ConnectionCallbacks() {<br/>    <span>@Override<br/></span><span>    </span><span>public void </span><span>onConnected</span>(Bundle bundle) {<br/>        Toast.<span>makeText</span>(MainActivity.<span>this, </span><span>"onConnected()"</span><span>, </span>Toast.<span>LENGTH_LONG</span>).show()<span>;<br/></span><span>    </span>}<br/>    <span>@Override<br/></span><span>    </span><span>public void </span><span>onConnectionSuspended</span>(<span>int </span>i) {}<br/>}<span>;<br/></span><span><br/></span>GoogleApiClient.OnConnectionFailedListener <span>mOnConnectionFailedListener </span>= <br/>        <span>new </span>GoogleApiClient.OnConnectionFailedListener() {<br/>    <span>@Override<br/></span><span>    </span><span>public void </span><span>onConnectionFailed</span>(ConnectionResult connectionResult) {<br/>        Toast.<span>makeText</span>(MainActivity.<span>this, </span>connectionResult.toString()<span>, </span>Toast.<span>LENGTH_LONG</span>).show()<span>;<br/></span><span>        if </span>(<span>mResolvingError</span>) {<br/>            <span>return;<br/></span><span>        </span>} <span>else if </span>(connectionResult.hasResolution()) {<br/>            <span>mResolvingError </span>= <span>true;<br/></span><span>            try </span>{<br/>                connectionResult.startResolutionForResult(MainActivity.<span>this, <br/></span><span>                        </span><span>REQUEST_RESOLVE_GOOGLE_CLIENT_ERROR</span>)<span>;<br/></span><span>            </span>} <span>catch </span>(IntentSender.SendIntentException e) {<br/>                <span>mGoogleApiClient</span>.connect()<span>;<br/></span><span>            </span>}<br/>        } <span>else </span>{<br/>            showGoogleAPIErrorDialog(connectionResult.getErrorCode())<span>;<br/></span><span>        </span>}<br/>    }<br/>}<span>;</span></pre>
<ol start="4">
<li class="mce-root"><span>Add the following method to the MainActivity class to show the Google API error dialog:</span></li>
</ol>
<pre style="padding-left: 60px"><span>private void </span><span>showGoogleAPIErrorDialog</span>(<span>int </span>errorCode) {<br/>    GoogleApiAvailability googleApiAvailability = GoogleApiAvailability.<span>getInstance</span>()<span>;<br/></span><span>    </span>Dialog errorDialog = googleApiAvailability.getErrorDialog(<br/>            <span>this, </span>errorCode<span>, </span><span>REQUEST_RESOLVE_GOOGLE_CLIENT_ERROR</span>)<span>;<br/></span><span>    </span>errorDialog.show()<span>;<br/></span>}</pre>
<ol start="5">
<li>Add the following code to override <kbd>onActivityResult()</kbd>:</li>
</ol>
<pre style="padding-left: 60px"><span>@Override<br/></span><span>protected void </span><span>onActivityResult</span>(<span>int </span>requestCode<span>, int </span>resultCode<span>, </span>Intent data) {<br/>    <span>if </span>(requestCode == <span>REQUEST_RESOLVE_GOOGLE_CLIENT_ERROR</span>) {<br/>        <span>mResolvingError </span>= <span>false;<br/></span><span>        if </span>(resultCode == <span>RESULT_OK<br/></span><span>                </span>&amp;&amp; !<span>mGoogleApiClient</span>.isConnecting()<br/>                &amp;&amp; !<span>mGoogleApiClient</span>.isConnected()) {<br/>            <span>mGoogleApiClient</span>.connect()<span>;<br/></span><span>        </span>}<br/>    }<br/>}</pre>
<ol start="6">
<li>Add the following method to set up the <kbd>GoogleApiClient</kbd>: </li>
</ol>
<pre style="padding-left: 60px"><span>protected void </span><span>setupGoogleApiClient</span>() {<br/>    <span>mGoogleApiClient </span>= <span>new </span>GoogleApiClient.Builder(<span>this</span>)<br/>            .addConnectionCallbacks(<span>mConnectionCallbacks</span>)<br/>            .addOnConnectionFailedListener(<span>mOnConnectionFailedListener</span>)<br/>            .addApi(LocationServices.<span>API</span>)<br/>            .build()<span>;<br/></span><span>    </span><span>mGoogleApiClient</span>.connect()<span>;<br/></span>}</pre>
<p class="mce-root"/>
<p class="mce-root"/>
<ol start="7">
<li>Finally, add this line of code to the end of the existing <kbd>onCreate()</kbd> method:</li>
</ol>
<pre style="padding-left: 60px">setupGoogleApiClient()<span>;</span></pre>
<ol start="8">
<li>You're ready to run the application on a device or emulator.</li>
</ol>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">How it works...</h1>
                </header>
            
            <article>
                
<p>Most of the code here is standard setup for the <kbd>GoogleApiClient</kbd> with the main addition of setting up the <kbd>OnConnectionFailedListener</kbd> callback. This is where the app goes from simply failing, to actually helping the end user get it working. Fortunately for us, Google does most of the work for us by checking the conditions that are causing it to fail, as well as presenting the UI to the user. We just have to make sure to check the status Google reports back to us.</p>
<p>The <kbd>GoogleAPIClient</kbd> uses the <kbd>connectionResult</kbd> to indicate possible courses of action. We can call the <kbd>hasResolution()</kbd> method, as follows:</p>
<pre>connectionResult.hasResolution() </pre>
<p>If the response is <kbd>true</kbd>, then it's something the user can resolve, such as enabling the location service. If the response is <kbd>false</kbd>, we get an instance of the <kbd>GoogleApiAvailability</kbd> and call the <kbd>getErrorDialog()</kbd> method. When finished, our <kbd>onActivityResult()</kbd> callback is called, where we reset <kbd>mResolvingError</kbd> and, if successful, attempt to reconnect.</p>
<div class="packt_tip">If you do not have a device with an older Google API for testing, you can try testing on an emulator with an older Google API version.</div>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">There's more...</h1>
                </header>
            
            <article>
                
<p>If your application is using fragments, you can get a dialog fragment instead, using this code:</p>
<pre>ErrorDialogFragment errorFragment = new ErrorDialogFragment(); 
Bundle args = new Bundle(); 
args.putInt("dialog_error", errorCode); 
errorFragment.setArguments(args); 
errorFragment.show(getSupportFragmentManager(), "errordialog"); </pre>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">See also</h1>
                </header>
            
            <article>
                
<ul>
<li>Accessing Google APIs: <a href="https://developers.google.com/android/guides/api-client"><span class="URLPACKT">https://developers.google.com/android/guides/api-client</span></a></li>
</ul>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Creating and monitoring a Geofence</h1>
                </header>
            
            <article>
                
<p>If your application needs to know when the user enters or exits a certain location, there's an alternative to continuously checking the user location: Geofencing. A Geofence is a location (latitude and longitude) along with a radius. You can create a Geofence and let the system notify you when the user enters the location proximity you specified. (Android currently allows up to 100 Geofences per user.)</p>
<p>Geofence properties include:</p>
<ul>
<li><strong>Location</strong>: The longitude and latitude</li>
<li><strong>Radius</strong>: The size of the circle (in meters)</li>
<li>Loitering delay: How long the user may remain within the radius before sending notifications</li>
<li><strong>Expiration</strong>: How long until the Geofence automatically expires</li>
<li><strong>Transition</strong> <strong>type</strong>:
<ul>
<li><kbd>GEOFENCE_TRANSITION_ENTER</kbd></li>
<li><kbd>GEOFENCE_TRANSITION_EXIT</kbd></li>
<li><kbd>INITIAL_TRIGGER_DWELL</kbd></li>
</ul>
</li>
</ul>
<p>This recipe will show you how to create a Geofence object and use it to create an instance of <kbd>GeofencingRequest</kbd>.</p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Getting ready</h1>
                </header>
            
            <article>
                
<p>Create a new project in Android Studio and call it <kbd>Geofence</kbd>. Use the default <span class="packt_screen">Phone &amp; Tablet</span> options and select <span class="packt_screen">Empty Activity</span> when prompted for <span class="packt_screen">Activity Type</span>.</p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">How to do it...</h1>
                </header>
            
            <article>
                
<p>We won't need a layout for this recipe as we'll use Toasts and Notifications for the user interaction. We will need to create an additional Java class for <kbd>IntentService</kbd>, which handles the Geofence alerts. Open the Android Manifest and follow these steps:</p>
<ol>
<li>Add the following permission:</li>
</ol>
<pre style="padding-left: 60px"><span>&lt;uses-permission </span><span>android</span><span>:name=</span><span>"android.permission.ACCESS_FINE_LOCATION"</span><span>/&gt;</span></pre>
<ol start="2">
<li>Open the <kbd>build.gradle (Module: app)</kbd> file and add the following statement to the <kbd>dependencies</kbd> section:</li>
</ol>
<pre style="padding-left: 60px">implementation <span>'com.google.android.gms:play-services:12.0.1'</span></pre>
<ol start="3">
<li>Create a new Java class called <kbd>GeofenceIntentService</kbd> and extend the <kbd>IntentService</kbd> class. The declaration will look as follows:</li>
</ol>
<pre style="padding-left: 60px">public class GeofenceIntentService extends IntentService { </pre>
<ol start="4">
<li>Add the following constructor:</li>
</ol>
<pre style="padding-left: 60px">public GeofenceIntentService() { 
    super("GeofenceIntentService"); 
} </pre>
<ol start="5">
<li>Add <kbd>onHandleIntent()</kbd> to receive the Geofence alert:</li>
</ol>
<pre style="padding-left: 60px"><span>@Override<br/></span><span>protected void </span><span>onHandleIntent</span>(Intent intent) {<br/>    GeofencingEvent geofencingEvent = GeofencingEvent.<span>fromIntent</span>(intent)<span>;<br/></span><span>    if </span>(geofencingEvent.hasError()) {<br/>        Toast.<span>makeText</span>(getApplicationContext()<span>, </span><span>"Geofence error code= "<br/></span><span>                        </span>+ geofencingEvent.getErrorCode()<span>, </span>Toast.<span>LENGTH_SHORT</span>).show()<span>;<br/></span><span>        return;<br/></span><span>    </span>}<br/>    <span>int </span>geofenceTransition = geofencingEvent.getGeofenceTransition()<span>;<br/></span><span>    if </span>(geofenceTransition == Geofence.<span>GEOFENCE_TRANSITION_DWELL</span>) {<br/>        Toast.<span>makeText</span>(getApplicationContext()<span>, </span><span>"GEOFENCE_TRANSITION_DWELL"</span><span>,<br/></span><span>                </span>Toast.<span>LENGTH_SHORT</span>).show()<span>;<br/></span><span>    </span>}<br/>}</pre>
<ol start="6">
<li>Open the Android manifest and add the following within the <kbd>&lt;application&gt;</kbd> element, at the same level as the <kbd>&lt;activity&gt;</kbd> element:</li>
</ol>
<pre style="padding-left: 60px">&lt;service android:name=".GeofenceIntentService"/&gt; </pre>
<ol start="7">
<li> Open <kbd>MainActivity.java</kbd> and add the following global variable:</li>
</ol>
<pre style="padding-left: 60px">private final int MINIMUM_RECOMENDED_RADIUS=100;</pre>
<ol start="8">
<li>Create a <kbd>PendingIntent</kbd> with the following method:</li>
</ol>
<pre style="padding-left: 60px"><span>private </span>PendingIntent <span>createGeofencePendingIntent</span>() {<br/>    Intent intent = <span>new </span>Intent(<span>this, </span>GeofenceIntentService.<span>class</span>)<span>;<br/></span><span>    return </span>PendingIntent.<span>getService</span>(<span>this, </span><span>0</span><span>, </span>intent<span>, </span>PendingIntent.<span>FLAG_UPDATE_CURRENT</span>)<span>;<br/></span>}</pre>
<ol start="9">
<li>Create the Geofence item with the following method:</li>
</ol>
<pre style="padding-left: 60px"><span>private </span>List <span>createGeofenceList</span>() {<br/>    List&lt;Geofence&gt; geofenceList = <span>new </span>ArrayList&lt;&gt;()<span>;<br/></span><span>    </span>geofenceList.add(<span>new </span>Geofence.Builder()<br/>            .setRequestId(<span>"GeofenceLocation"</span>)<br/>            .setCircularRegion(<br/>                    <span>47.6062</span><span>,  </span><span>//Latitude<br/></span><span>                    </span><span>122.3321</span><span>, </span><span>//Longitude<br/></span><span>                    </span><span>MINIMUM_RECOMENDED_RADIUS</span>)<br/>            .setLoiteringDelay(<span>30000</span>)<br/>            .setExpirationDuration(Geofence.<span>NEVER_EXPIRE</span>)<br/>            .setTransitionTypes(Geofence.<span>GEOFENCE_TRANSITION_DWELL</span>)<br/>            .build())<span>;<br/></span><span>    return </span>geofenceList<span>;<br/></span>}</pre>
<ol start="10">
<li>Create the Geofence Request with the following method:</li>
</ol>
<pre style="padding-left: 60px"><span>private </span>GeofencingRequest <span>createGeofencingRequest</span>() {<br/>    GeofencingRequest.Builder builder = <span>new </span>GeofencingRequest.Builder()<span>;<br/></span><span>    </span>builder.setInitialTrigger(GeofencingRequest.<span>INITIAL_TRIGGER_DWELL</span>)<span>;<br/></span><span>    </span>builder.addGeofences(createGeofenceList())<span>;<br/></span><span>    return </span>builder.build()<span>;<br/></span>}</pre>
<ol start="11">
<li> Add the following code to the existing <kbd>onCreate()</kbd> callback:</li>
</ol>
<pre style="padding-left: 60px"><span>if </span>(ActivityCompat.<span>checkSelfPermission</span>(<span>this, </span>android.Manifest.permission.<span>ACCESS_FINE_LOCATION</span>) == PackageManager.<span>PERMISSION_GRANTED</span>) {<br/>    GeofencingClient geofencingClient = LocationServices.<span>getGeofencingClient</span>(<span>this</span>)<span>;<br/></span><span>    </span>geofencingClient.addGeofences(createGeofencingRequest()<span>, </span>createGeofencePendingIntent())<br/>            .addOnSuccessListener(<span>this, new </span>OnSuccessListener&lt;Void&gt;() {<br/>                <span>@Override<br/></span><span>                </span><span>public void </span><span>onSuccess</span>(Void aVoid) {<br/>                    Toast.<span>makeText</span>(MainActivity.<span>this, </span><span>"onSuccess()"</span><span>, </span>Toast.<span>LENGTH_SHORT</span>).show()<span>;<br/></span><span>                </span>}<br/>            })<br/>            .addOnFailureListener(<span>this, new </span>OnFailureListener() {<br/>                <span>@Override<br/></span><span>                </span><span>public void </span><span>onFailure</span>(<span>@NonNull </span>Exception e) {<br/>                    Toast.<span>makeText</span>(MainActivity.<span>this,<br/></span><span>                            </span><span>"onFailure(): " </span>+ e.getMessage()<span>, </span>Toast.<span>LENGTH_SHORT</span>).show()<span>;<br/></span><span>                </span>}<br/>            })<span>;<br/></span>} <span>else </span>{<br/>    ActivityCompat.<span>requestPermissions</span>(<span>this, <br/></span><span>            new </span>String[] {android.Manifest.permission.<span>ACCESS_FINE_LOCATION</span>}<span>,</span><span>1</span>)<span>;<br/></span>}</pre>
<ol start="12">
<li>You're ready to run the application on a device or emulator.</li>
</ol>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">How it works...</h1>
                </header>
            
            <article>
                
<p>First, we add <kbd>ACCESS_FINE_LOCATION</kbd> permission as this is required for Geofencing.</p>
<p>Before we can call the <kbd>GeofencingApi.addGeofences()</kbd> method, we have to prepare two objects:</p>
<ul>
<li>Geofence Request</li>
<li>Geofence Pending Intent</li>
</ul>
<p>To create the Geofence Request, we use the <kbd>GeofencingRequest.Builder</kbd>. The builder requires the list of Geofence objects, which are created in the <kbd>createGeofenceList()</kbd> method. (Even though we are only creating a single Geofence object, the builder requires a list, so we just add our single Geofence to an <kbd>ArrayList</kbd>.) Here is where we set the Geofence properties:</p>
<pre>.setRequestId(<span>"GeofenceLocation"</span>)<br/>.setCircularRegion(<br/>        <span>47.6062</span><span>,  </span><span>//Latitude<br/></span><span>        </span><span>122.3321</span><span>, </span><span>//Longitude<br/></span><span>        </span><span>MINIMUM_RECOMENDED_RADIUS</span>)<br/>.setLoiteringDelay(<span>30000</span>)<br/>.setExpirationDuration(Geofence.<span>NEVER_EXPIRE</span>)<br/>.setTransitionTypes(Geofence.<span>GEOFENCE_TRANSITION_DWELL</span>)</pre>
<p>Only the Loitering delay is optional, but we need it since we are using the <kbd>DWELL</kbd> transition. When calling <kbd>setTransitionTypes()</kbd>, we can combine multiple transition types using the <kbd>OR</kbd> operator (using the pipe character). Here's an example using <kbd>ENTER</kbd> and <kbd>EXIT</kbd> instead:</p>
<pre>.setTransitionTypes(Geofence.GEOFENCE_TRANSITION_ENTER | Geofence.GEOFENCE_TRANSITION_EXIT)</pre>
<p>For this example, we used the same default latitude and longitude as the emulator. Change these values as needed.</p>
<p>Our call to <kbd>Geofence.Builder()</kbd> creates the Geofence object. With the Geofence list ready, we call the <kbd>GeofencingRequest.Builder</kbd> and set our initial trigger to <kbd>INITIAL_TRIGGER_DWELL</kbd>. (If you change the preceding transition types, you may want to change the initial trigger as well or the creation of our Geofence may fail.)</p>
<p>The second object we need is a Pending Intent, which is how the system will notify our app when the Geofence criteria are met. (<span>Strictly speaking, the Intent service is not required and if your app will only be monitoring Geofence responses while in the foreground, you may not even need it.) Our example displays a toast in response to the Geofence trigger, but this is where you would customize the response for your app.</span></p>
<p>With both objects created, we get a reference to <kbd>GeofencingClient</kbd> after checking for the proper permission. Our example only checks for the necessary permission so you need to manually enable location permission through the app settings. A production app should prompt the user as needed. (See <em>The Android 6.0 Runtime Permission Model</em> recipe in <a href="98c7bc7b-43e2-43de-aed4-fe2fb6dc72f3.xhtml" target="_blank">Chapter 15</a>, <em><span class="cdp-organizer-chapter-title"><span class="cdp-organize-title-label">Getting Your App Ready for the Play Store</span></span></em> for a complete example.)</p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">There's more...</h1>
                </header>
            
            <article>
                
<p>To stop receiving Geofence notifications, you can call the <kbd>removeGeofences()</kbd> method with either the <kbd>RequestID</kbd> parameter or <kbd>PendingIntent</kbd>. The following example uses the same <kbd>PendingIntent</kbd> method we used for the notification:</p>
<pre>geofencingClient.removeGeofences(createGeofencePendingIntent())<br/>        .addOnSuccessListener(<span>this, new </span>OnSuccessListener&lt;Void&gt;() {<br/>            <span>@Override<br/></span><span>            </span><span>public void </span><span>onSuccess</span>(Void aVoid) {<br/>                <span>//Success<br/></span><span>            </span>}<br/>        })<br/>        .addOnFailureListener(<span>this, new </span>OnFailureListener() {<br/>            <span>@Override<br/></span><span>            </span><span>public void </span><span>onFailure</span>(<span>@NonNull </span>Exception e) {<br/>                <span>//Failuare<br/></span><span>            </span>}<br/>        })<span>;</span></pre>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">See also</h1>
                </header>
            
            <article>
                
<ul>
<li>The <kbd>GeofencingClient</kbd> class at: <a href="https://developers.google.com/android/reference/com/google/android/gms/location/GeofencingClient">https://developers.google.com/android/reference/com/google/android/gms/location/GeofencingClient</a></li>
<li>The <kbd>Geofence.Builder</kbd> class at: <a href="https://developers.google.com/android/reference/com/google/android/gms/location/Geofence.Builder.html"><span class="URLPACKT">https://developers.google.com/android/reference/com/google/android/gms/location/Geofence.Builder.html</span></a></li>
<li>The <kbd>GeofencingRequest.Builder</kbd> class at: <a href="https://developers.google.com/android/reference/com/google/android/gms/location/GeofencingRequest.Builder"><span class="URLPACKT">https://developers.google.com/android/reference/com/google/android/gms/location/GeofencingRequest.Builder</span></a></li>
</ul>


            </article>

            
        </section>
    </body></html>