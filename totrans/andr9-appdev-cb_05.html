<html><head></head><body>
        <section>

                            <header>
                    <h1 class="header-title">Fragments</h1>
                </header>
            
            <article>
                
<p>In this chapter, we will cover the following topics:</p>
<ul>
<li>Creating and using a Fragment</li>
<li>Adding and removing Fragments during runtime</li>
<li>Passing data between Fragments</li>
<li>Handling the Fragment back stack</li>
</ul>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Introduction</h1>
                </header>
            
            <article>
                
<p><span>With a firm understanding of layouts from <a href="0b95f21f-496a-48ca-900c-32d887d3a3fe.xhtml" target="_blank"><span class="ChapterrefPACKT">Chapter 2</span></a>, <em><span class="ItalicsPACKT">Layouts</span></em>, we'll dig deeper into UI development with Fragments. Fragments are a way to separate your UI into smaller sections that can easily be reused. Think of Fragments as mini-activities, complete with their own classes, layouts, and life cycle. Instead of designing your screen in one Activity Layout, possibly duplicating functionality across multiple layouts, you can break the screen into smaller, logical sections and turn them into Fragments. Your Activity Layout can then reference one or multiple Fragments, as needed.</span></p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Creating and using a Fragment</h1>
                </header>
            
            <article>
                
<p>Android didn't always support Fragments. The early versions of Android were designed for phones when screens had relatively small displays. It wasn't until Android started being used on tablets that there was a need to split the screen into smaller sections. Android 3.0 introduced the <kbd><span class="CodeInTextPACKT">Fragments</span></kbd> class and the Fragment Manager.</p>
<p><span>Along with a new class, also came the Fragment Lifecycle. The Fragment Lifecycle is similar to the Activity Lifecycle introduced in <a href="ef2fe8b4-1320-45f5-b0d5-fb9fd1d35e07.xhtml" target="_blank"><span class="ChapterrefPACKT">Chapter 1</span></a>, <em><span class="ItalicsPACKT">Activities</span></em>, as most events parallel the Activity Lifecycle.</span></p>
<p>Here's a brief overview of the main callbacks:</p>
<ul>
<li><kbd><span class="CodeInTextPACKT">onAttach()</span></kbd>: It's called when the Fragment is associated with an Activity.</li>
<li><kbd><span class="CodeInTextPACKT">onCreate()</span></kbd>: It's called when the Fragment is first created.</li>
<li><kbd><span class="CodeInTextPACKT">onCreateView()</span></kbd>: It's <span>called when the Fragment is about to be displayed for the first time.</span></li>
<li><kbd><span class="CodeInTextPACKT">onActivityCreated()</span></kbd>: It's called when the associated Activity is created.</li>
<li><kbd><span class="CodeInTextPACKT">onStart()</span></kbd>: It's called when the Fragment will become visible to the user.</li>
<li><kbd><span class="CodeInTextPACKT">onResume()</span></kbd>: It's called just before a Fragment is displayed.</li>
<li><kbd><span class="CodeInTextPACKT">onPause()</span></kbd>: It's <span>called when the Fragment is first suspended. The user may return to the Fragment, but this is where you should persist any user data.</span></li>
<li><kbd><span class="CodeInTextPACKT">onStop()</span></kbd>: It's called when the Fragment is no longer visible to the user.</li>
<li><kbd><span class="CodeInTextPACKT">onDestroyView()</span></kbd>: It's called to allow final cleanup.</li>
<li><kbd><span class="CodeInTextPACKT">onDetach()</span></kbd>: It's called when the Fragment is no longer associated with the Activity.</li>
</ul>
<p>For our first exercise, we will create a new Fragment derived from the standard <kbd><span class="CodeInTextPACKT">Fragment</span></kbd> class. But there are several other <span class="CodeInTextPACKT">Fragment</span> classes we could derive from, including the following:</p>
<ul>
<li><kbd><span class="CodeInTextPACKT">DialogFragment</span></kbd>: It's used for creating a floating dialog</li>
<li><kbd><span class="CodeInTextPACKT">ListFragment</span></kbd>: It creates a <kbd><span class="CodeInTextPACKT">ListView</span></kbd> in a Fragment, similar to <span class="CodeInTextPACKT"><kbd>ListActivity</kbd></span></li>
<li><kbd><span class="CodeInTextPACKT">PreferenceFragment</span></kbd>: It creates a list of <kbd>Preference</kbd> objects, commonly used for a <span class="packt_screen">Settings</span> page</li>
</ul>
<p>In this recipe, we will walk through creating a basic Fragment derived from the <kbd><span class="CodeInTextPACKT">Fragment</span></kbd> class and include it in an Activity Layout.</p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Getting ready</h1>
                </header>
            
            <article>
                
<p>Create a new project in Android Studio and call it <kbd><span class="CodeInTextPACKT">CreateFragment</span></kbd>. <span>Use the default </span><span class="packt_screen">Phone &amp; Tablet</span><span> option and select </span><span class="packt_screen">Empty Activity</span><span> on the </span><span class="packt_screen">Add an Activity to Mobile</span><span> dialog.</span></p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">How to do it...</h1>
                </header>
            
            <article>
                
<p>In this recipe, we will create a new <kbd><span class="CodeInTextPACKT">Fragment</span></kbd> class with an accompanying layout file. We will then add the Fragment to the Activity Layout so it will be visible when the activity starts.</p>
<p>Here are the steps to create and display a new Fragment:</p>
<ol>
<li>Create a new layout called <kbd><span class="CodeInTextPACKT">fragment_one.xml</span></kbd> using the following XML:</li>
</ol>
<pre style="padding-left: 60px"><span>&lt;?</span><span>xml version=</span><span>"1.0" </span><span>encoding=</span><span>"utf-8"</span><span>?&gt;<br/></span><span>&lt;RelativeLayout </span><span>xmlns:</span><span>android</span><span>=</span><span>"http://schemas.android.com/apk/res/android"<br/></span><span>    </span><span>android</span><span>:layout_height=</span><span>"match_parent"<br/></span><span>    </span><span>android</span><span>:layout_width=</span><span>"match_parent"</span><span>&gt;<br/></span><span>    &lt;TextView<br/></span><span>        </span><span>android</span><span>:layout_width=</span><span>"wrap_content"<br/></span><span>        </span><span>android</span><span>:layout_height=</span><span>"wrap_content"<br/></span><span>        </span><span>android</span><span>:text=</span><span>"Fragment One"<br/></span><span>        </span><span>android</span><span>:id=</span><span>"@+id/textView"<br/></span><span>        </span><span>android</span><span>:layout_centerVertical=</span><span>"true"<br/></span><span>        </span><span>android</span><span>:layout_centerHorizontal=</span><span>"true" </span><span>/&gt;<br/></span><span>&lt;/RelativeLayout&gt; </span></pre>
<ol start="2">
<li>Create a new Java class called <kbd><span class="CodeInTextPACKT">FragmentOne.java</span></kbd> with the following code:</li>
</ol>
<pre style="padding-left: 60px"><span>public class </span>FragmentOne <span>extends </span>Fragment {<br/>    <span>@Override<br/></span><span>    </span><span>public </span>View <span>onCreateView</span>(LayoutInflater inflater<span>, </span>ViewGroup container<span>,<br/></span><span>                             </span>Bundle savedInstanceState) {<br/>        <span>return </span>inflater.inflate(R.layout.<span>fragment_one</span><span>, </span>container<span>, false</span>)<span>;<br/></span><span>    </span>}<br/>}</pre>
<ol start="3">
<li>Open the <kbd><span class="CodeInTextPACKT">activity_main.xml</span></kbd> file and replace the existing <kbd><span class="CodeInTextPACKT">&lt;TextView&gt;</span></kbd> element with the following <kbd><span class="CodeInTextPACKT">&lt;fragment&gt;</span></kbd> element:</li>
</ol>
<pre style="padding-left: 60px"><span>&lt;fragment<br/></span><span>    </span><span>android</span><span>:name=</span><span>"com.packtpub.createfragment.FragmentOne"<br/></span><span>    </span><span>android</span><span>:id=</span><span>"@+id/fragment"<br/></span><span>    </span><span>android</span><span>:layout_width=</span><span>"wrap_content"<br/></span><span>    </span><span>android</span><span>:layout_height=</span><span>"wrap_content"<br/></span><span>    </span><span>android</span><span>:layout_centerVertical=</span><span>"true"<br/></span><span>    </span><span>android</span><span>:layout_centerHorizontal=</span><span>"true" <br/></span><span>    </span><span>app</span><span>:layout_constraintBottom_toBottomOf=</span><span>"parent"<br/></span><span>    </span><span>app</span><span>:layout_constraintLeft_toLeftOf=</span><span>"parent"<br/></span><span>    </span><span>app</span><span>:layout_constraintRight_toRightOf=</span><span>"parent"<br/></span><span>    </span><span>app</span><span>:layout_constraintTop_toTopOf=</span><span>"parent" </span><span>/&gt;</span></pre>
<ol start="4">
<li>Run the program on a device or emulator.</li>
</ol>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">How it works...</h1>
                </header>
            
            <article>
                
<p>We start by creating a new class, the same as we do for an Activity. In this recipe, we only create an overwrite for the <kbd><span class="CodeInTextPACKT">onCreateView()</span></kbd> method to load our Fragment layout. But, just like with the Activity events, we can override the other events as we need them. Once the new Fragment is created, we then add it to the Activity Layout. Since the original <kbd><span class="CodeInTextPACKT">Activity</span></kbd> class was created before <span class="CodeInTextPACKT">Fragments</span> existed, they do not support <span class="CodeInTextPACKT">Fragments</span>. That's why, unless otherwise indicated, all the examples for this book extend from <kbd>AppCompatActivity</kbd>. (If you used the Android Studio New Project Wizard, then by default <kbd><span class="CodeInTextPACKT">MainActivity</span></kbd> extends <kbd><span class="CodeInTextPACKT">AppCompatActivity</span></kbd>.)</p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">There's more...</h1>
                </header>
            
            <article>
                
<p>We're only creating a single, simple Fragment in this recipe to teach the fundamentals of Fragments. But this is a good time to point out the power of Fragments. If we are creating multiple Fragments (and usually we are, as that's the point of using Fragments), when creating the Activity Layouts as we did in step 4, we could create different layout configurations using the Android Resource Folders. The portrait layout may have only a single Fragment while the landscape may have two or more. The Master/Detail layout typically uses Fragments, thus only requiring each screen section to be designed and coded once, then included in the layout as appropriate.</p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">See also</h1>
                </header>
            
            <article>
                
<ul>
<li><span>For more information on the Master/Detail pattern, see the</span> <em>Passing data between Fragments</em> <span>recipe later in this chapter.</span></li>
</ul>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Adding and removing Fragments during runtime</h1>
                </header>
            
            <article>
                
<p>Defining a Fragment in the layout, as we did in the previous recipe, is known as a static Fragment, which doesn't allow the fragment to be changed during runtime. Rather than using the <kbd><span class="CodeInTextPACKT">&lt;fragment&gt;</span></kbd> element, we will create a container to hold the Fragment, then create the Fragment dynamically in the Activity's <kbd><span class="CodeInTextPACKT">onCreate()</span></kbd> method.</p>
<p>The <span class="CodeInTextPACKT">FragmentManager</span> provides the APIs for adding, removing, and changing Fragments during runtime using a <span class="CodeInTextPACKT">FragmentTransaction</span>. A Fragment transaction consists of the following:</p>
<ol>
<li>Starting a transaction</li>
<li>Performing one or multiple actions</li>
<li>Committing the transaction</li>
</ol>
<p>This recipe will demonstrate the <span class="CodeInTextPACKT">Fragment Manager</span> by adding and removing Fragments during runtime.</p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Getting ready</h1>
                </header>
            
            <article>
                
<p>Create a new project in Android Studio and call it: <kbd><span class="CodeInTextPACKT">RuntimeFragments</span></kbd>. <span>Use the default </span><span class="packt_screen">Phone &amp; Tablet</span><span> option and select </span><span class="packt_screen">Empty Activity</span><span> on the </span><span class="packt_screen">Add an Activity to Mobile</span><span> dialog.</span></p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">How to do it...</h1>
                </header>
            
            <article>
                
<p>To demonstrate adding and removing Fragments, we first need to create the Fragments, which we will do by extending the <kbd><span class="CodeInTextPACKT">Fragment</span></kbd> class. After creating the new Fragments, we need to alter the layout for the Main Activity to include the <span class="CodeInTextPACKT">Fragment</span> container. From there, we just add the code to handle the Fragment transactions. Here are the steps:</p>
<ol>
<li>Create a new layout file called <kbd><span class="CodeInTextPACKT">fragment_one.xml</span></kbd> and include the following XML:</li>
</ol>
<pre style="padding-left: 60px"><span>&lt;?</span><span>xml version=</span><span>"1.0" </span><span>encoding=</span><span>"utf-8"</span><span>?&gt;<br/></span><span>&lt;RelativeLayout </span><span>xmlns:</span><span>android</span><span>=</span><span>"http://schemas.android.com/apk/res/android"<br/></span><span>    </span><span>android</span><span>:layout_height=</span><span>"match_parent"<br/></span><span>    </span><span>android</span><span>:layout_width=</span><span>"match_parent"</span><span>&gt;<br/></span><span>    &lt;TextView<br/></span><span>        </span><span>android</span><span>:layout_width=</span><span>"wrap_content"<br/></span><span>        </span><span>android</span><span>:layout_height=</span><span>"wrap_content"<br/></span><span>        </span><span>android</span><span>:text=</span><span>"Fragment One"<br/></span><span>        </span><span>android</span><span>:id=</span><span>"@+id/textView"<br/></span><span>        </span><span>android</span><span>:layout_centerVertical=</span><span>"true"<br/></span><span>        </span><span>android</span><span>:layout_centerHorizontal=</span><span>"true" </span><span>/&gt;<br/></span><span>&lt;/RelativeLayout&gt; </span></pre>
<ol start="2">
<li>The second layout file called <kbd><span class="CodeInTextPACKT">fragment_two.xml</span></kbd> is almost identical, with the only difference being the text:</li>
</ol>
<pre style="padding-left: 60px">android:text="Fragment Two" </pre>
<ol start="3">
<li>Create a new Java class called <kbd><span class="CodeInTextPACKT">FragmentOne.java</span></kbd> with the following code:</li>
</ol>
<pre style="padding-left: 60px"><span>public class </span>FragmentOne <span>extends </span>Fragment {<br/>    <span>@Override<br/></span><span>    </span><span>public </span>View <span>onCreateView</span>(LayoutInflater inflater<span>,<br/></span><span>                             </span>ViewGroup container<span>, </span>Bundle savedInstanceState) {<br/>        <span>return </span>inflater.inflate(R.layout.<span>fragment_one</span><span>,<br/></span><span>                </span>container<span>, false</span>)<span>;<br/></span><span>    </span>}<br/>} </pre>
<ul>
<li>Import from the support library as follows:</li>
</ul>
<pre style="padding-left: 120px"><span>import </span>android.support.v4.app.Fragment<span>;</span></pre>
<ol start="4">
<li>Create the second Java class called <kbd><span class="CodeInTextPACKT">FragmentTwo</span></kbd> with the following code:</li>
</ol>
<pre style="padding-left: 60px"><span>public class </span>FragmentTwo <span>extends </span>Fragment {<br/>    <span>@Override<br/></span><span>    </span><span>public </span>View <span>onCreateView</span>(LayoutInflater inflater<span>,<br/></span><span>                             </span>ViewGroup container<span>, </span>Bundle savedInstanceState) {<br/>        <span>return </span>inflater.inflate(R.layout.<span>fragment_two</span><span>,<br/></span><span>                </span>container<span>, false</span>)<span>;<br/></span><span>    </span>}<br/>}</pre>
<ul>
<li>As before, import from the support library:</li>
</ul>
<pre style="padding-left: 120px"><span>import </span>android.support.v4.app.Fragment<span>;</span></pre>
<ol start="5">
<li>Now we need to add a container and a button to the Main Activity layout. Change <kbd><span class="CodeInTextPACKT">activity_main.xml</span></kbd> as follows:</li>
</ol>
<pre style="padding-left: 60px"><span>&lt;?</span><span>xml version=</span><span>"1.0" </span><span>encoding=</span><span>"utf-8"</span><span>?&gt;<br/></span><span>&lt;RelativeLayout </span><span>xmlns:</span><span>android</span><span>=</span><span>"http://schemas.android.com/apk/res/android"<br/></span><span>    </span><span>android</span><span>:layout_width=</span><span>"match_parent"<br/></span><span>    </span><span>android</span><span>:layout_height=</span><span>"match_parent"</span><span>&gt;<br/></span><span>    &lt;FrameLayout<br/></span><span>        </span><span>android</span><span>:id=</span><span>"@+id/frameLayout"<br/></span><span>        </span><span>android</span><span>:layout_width=</span><span>"match_parent"<br/></span><span>        </span><span>android</span><span>:layout_height=</span><span>"wrap_content"<br/></span><span>        </span><span>android</span><span>:layout_above=</span><span>"@+id/buttonSwitch"<br/></span><span>        </span><span>android</span><span>:layout_alignParentTop=</span><span>"true"</span><span>&gt;<br/></span><span>    &lt;/FrameLayout&gt;</span><span><br/></span><span>    &lt;Button<br/></span><span>        </span><span>android</span><span>:id=</span><span>"@+id/buttonSwitch"<br/></span><span>        </span><span>android</span><span>:layout_width=</span><span>"wrap_content"<br/></span><span>        </span><span>android</span><span>:layout_height=</span><span>"wrap_content"<br/></span><span>        </span><span>android</span><span>:text=</span><span>"Switch"<br/></span><span>        </span><span>android</span><span>:layout_alignParentBottom=</span><span>"true"<br/></span><span>        </span><span>android</span><span>:layout_centerInParent=</span><span>"true"<br/></span><span>        </span><span>android</span><span>:onClick=</span><span>"switchFragment"</span><span>/&gt;<br/></span><span>&lt;/RelativeLayout&gt;</span></pre>
<ol start="6">
<li>With the Fragments created and the container added to the layout, we are now ready to write the code to manipulate the Fragments. Open <kbd><span class="CodeInTextPACKT">MainActivity.java</span></kbd> and add the following code below the class constructor:</li>
</ol>
<pre style="padding-left: 60px">FragmentOne <span>mFragmentOne</span><span>;<br/></span>FragmentTwo <span>mFragmentTwo</span><span>;<br/></span><span>int </span><span>showingFragment</span>=<span>0</span><span>;</span></pre>
<ol start="7">
<li>Add the following code to the existing <kbd><span class="CodeInTextPACKT">onCreate()</span></kbd> method, below <kbd><span class="CodeInTextPACKT">setContentView()</span></kbd>:</li>
</ol>
<pre style="padding-left: 60px"><span>mFragmentOne </span>= <span>new </span>FragmentOne()<span>;<br/></span><span>mFragmentTwo </span>= <span>new </span>FragmentTwo()<span>;<br/></span>FragmentManager fragmentManager = getSupportFragmentManager()<span>;<br/></span>FragmentTransaction fragmentTransaction =<br/>        fragmentManager.beginTransaction()<span>;<br/></span>fragmentTransaction.add(R.id.<span>frameLayout</span><span>, </span><span>mFragmentOne</span>)<span>;<br/></span>fragmentTransaction.commit()<span>;<br/></span><span>showingFragment</span>=<span>1</span><span>;</span></pre>
<ul>
<li>Import from the support libraries:</li>
</ul>
<pre style="padding-left: 120px"><span>import </span>android.support.v4.app.FragmentManager<span>;<br/></span><span>import </span>android.support.v4.app.FragmentTransaction<span>;</span></pre>
<ol start="8">
<li>The last code we need to add handles the Fragment switching, called by the button:</li>
</ol>
<pre style="padding-left: 60px"><span>public void </span><span>switchFragment</span>(View view) {<br/>    FragmentManager fragmentManager = getSupportFragmentManager()<span>;<br/></span><span>    </span>FragmentTransaction fragmentTransaction = fragmentManager.beginTransaction()<span>;<br/></span><span>    if </span>(<span>showingFragment</span>==<span>1</span>) {<br/>        fragmentTransaction.replace(R.id.<span>frameLayout</span><span>, </span><span>mFragmentTwo</span>)<span>;<br/></span><span>        </span><span>showingFragment </span>= <span>2</span><span>;<br/></span><span>    </span>} <span>else </span>{<br/>        fragmentTransaction.replace(R.id.<span>frameLayout</span><span>, </span><span>mFragmentOne</span>)<span>;<br/></span><span>        </span><span>showingFragment</span>=<span>1</span><span>;<br/></span><span>    </span>}<br/>    fragmentTransaction.commit()<span>;<br/></span>}</pre>
<ol start="9">
<li>Run the program on a device or emulator.</li>
</ol>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">How it works...</h1>
                </header>
            
            <article>
                
<p>Most of the steps for this recipe involve setting up the Fragments. Once the Fragments are declared, we create them in the <kbd><span class="CodeInTextPACKT">onCreate()</span></kbd> <span>method. Though the code can be condensed to a single line, it's shown in the long form as it makes it easier to read and understand.</span></p>
<p>First, we get <kbd><span class="CodeInTextPACKT">FragmentManager</span></kbd> so we can begin <kbd><span class="CodeInTextPACKT">FragmentTransaction</span></kbd><span>. Once we have</span> <kbd><span class="CodeInTextPACKT">FragmentTransaction</span></kbd>, we start the transaction with <kbd><span class="CodeInTextPACKT">beginTransaction()</span></kbd>. Multiple actions can occur within the transaction, but all we need here is to <kbd><span class="CodeInTextPACKT">add()</span></kbd> our initial Fragment. We call the <kbd><span class="CodeInTextPACKT">commit()</span></kbd> method to finalize the transaction.</p>
<p>Now that you understand the Fragment transaction, here is the succinct version for <kbd><span class="CodeInTextPACKT">onCreate()</span></kbd>:</p>
<pre>getSupportFragmentManager().beginTransaction().add(R.id.<span>frameLayout</span><span>, </span><span>mFragmentOne</span>).commit()<span>;</span></pre>
<p><span class="CodeInTextPACKT">Our <kbd>switchFragment()</kbd></span> <span>method</span><span> </span><span>does basically the same type of Fragment transaction. Instead of calling the</span> <kbd><span class="CodeInTextPACKT">add()</span></kbd> <span>method, we call the</span> <kbd><span class="CodeInTextPACKT">replace()</span></kbd> <span>method with the existing Fragment. We keep track of the current Fragment with the</span> <kbd><span class="CodeInTextPACKT">showingFragment</span></kbd> <span>variable so we know which Fragment to show next. We are not limited to switching between two Fragments either. If we needed additional Fragments, we just need to create them.</span></p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">There's more...</h1>
                </header>
            
            <article>
                
<p><span>In the <em><span class="ItalicsPACKT">Switching between activities</span></em> recipe from <a href="ef2fe8b4-1320-45f5-b0d5-fb9fd1d35e07.xhtml" target="_blank"><span class="ChapterrefPACKT">Chapter 1</span></a>, <em><span class="ItalicsPACKT">Activities</span></em>, we discussed the back stack. Most users would expect the back key to move backward through the "screens" and they don't know or care if those screens are activities or Fragments. Fortunately, Android makes it very easy to add Fragments to the back stack just by adding a call to</span> <kbd><span class="CodeInTextPACKT">addToBackStack()</span></kbd> before calling <kbd><span class="CodeInTextPACKT">commit()</span></kbd>.</p>
<div class="packt_tip">When a Fragment is removed or replaced without adding it to the back stack, it is immediately destroyed. If it is added to the back stack, it is stopped and, if the user returns to the Fragment, it is restarted, instead of recreated.</div>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">See also</h1>
                </header>
            
            <article>
                
<ul>
<li><span>For more information on managing the Fragment back stack, see the </span><em>Handling the Fragment back stack</em> recipe later in this chapter.</li>
</ul>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Passing data between Fragments</h1>
                </header>
            
            <article>
                
<p>Often, the need arises to pass information between Fragments. An <span>email application serves as a classic example. It's common to have the list of emails in one Fragment and show the email details in another Fragment (this is commonly referred to as a Master/Detail pattern). Fragments make creating this pattern easier because we only have to code each Fragment once, then include them in different layouts. We can easily have a single Fragment in a portrait layout with the ability to swap out the master Fragment with the detail Fragment when an email is selected. We can also create a two-panel layout where both the list and detail Fragments are side by side. Either way, when the user clicks the email in the list, the email opens up in the detail panel. This is when we need to communicate between two Fragments.</span></p>
<p>Since one of the primary goals of Fragments is that they be completely self-contained, direct communication between Fragments is discouraged, and for good reason. If Fragments had to rely on other Fragments, your code would likely break when the layouts changed and only one Fragment was available. Fortunately, direct communication is not required for this scenario either. All Fragment communication should pass through the host activity. The host activity is responsible for managing the Fragments and can properly route the messages.</p>
<p>Now the question becomes: How do Fragments communicate with the activity? The answer is with an <span class="CodeInTextPACKT">interface</span>. You're probably already familiar with an interface, as that's how a view communicates an event back to an activity. One of the most common examples is the button <kbd>onClick()</kbd> interface.</p>
<p>In this recipe, we will create two Fragments to demonstrate passing data from one Fragment to another via the host activity. We'll also build on what we learned from the previous recipe by including two different Activity Layouts-one for portrait and one for landscape. When in portrait mode, the activity will swap the Fragments as needed. Here is a screenshot of when the application first runs in portrait mode:</p>
<div class="CDPAlignCenter CDPAlign"><img src="assets/61791176-99c3-4df2-abf1-952d0bf12877.png" style="width:20.42em;height:38.33em;"/></div>
<p>This is the screen showing the detail Fragment when you click on a country name:</p>
<div class="CDPAlignCenter CDPAlign"><img src="assets/b9284ade-ae65-4094-95fa-e3daa5e4124d.png" style="width:23.58em;height:43.58em;"/></div>
<p>When in landscape, both Fragments will be side by side, as shown in the landscape screenshot:</p>
<div class="CDPAlignCenter CDPAlign"><img src="assets/8b2e7654-2324-4dac-933b-62c32b833286.png" style="width:43.58em;height:23.00em;"/></div>
<p>Since the Master/Detail pattern generally involves a list for the master, we'll take advantage of <kbd><span class="CodeInTextPACKT">ListFragment</span></kbd> <span>(mentioned in the <em><span class="ItalicsPACKT">Creating and using a Fragment</span></em> section). When an item in the list is selected, the item text (country name in our example) will be sent to the detail Fragment via the host activity.</span></p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Getting ready</h1>
                </header>
            
            <article>
                
<p>Create a new project in Android Studio and call it <kbd><span class="CodeInTextPACKT">FragmentCommunication</span></kbd>. <span>Use the default </span><span class="packt_screen">Phone &amp; Tablet</span><span> option and select </span><span class="packt_screen">Empty Activity</span><span> on the </span><span class="packt_screen">Add an Activity to Mobile</span><span> dialog.</span></p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">How to do it...</h1>
                </header>
            
            <article>
                
<p>To fully demonstrate working Fragments, we'll need to create two Fragments. The first Fragment will extend from <kbd><span class="CodeInTextPACKT">ListFragment</span></kbd> so it will not need a layout. We're going to go one step further by creating both portrait and landscape layouts for our Activity. For portrait mode, we'll swap Fragments and for landscape mode, we'll show both Fragments side by side.</p>
<div class="packt_infobox">When typing this code, Android Studio will offer two different library import options. Since the New Project Wizard automatically references the <span class="CodeInTextPACKT">AppCompat</span> library, we need to use the support library APIs instead of the framework APIs. Though very similar, the following code uses the support Fragment APIs.</div>
<p>Here are the steps, starting with the first Fragment:</p>
<ol>
<li>Create a new Java class called <kbd><span class="CodeInTextPACKT">MasterFragment</span></kbd> and change it so it extends <kbd><span class="CodeInTextPACKT">ListFragment</span></kbd> as shown:</li>
</ol>
<pre style="padding-left: 60px">public class MasterFragment extends ListFragment </pre>
<ul>
<li style="padding-left: 60px">Import from the following library:</li>
</ul>
<pre style="padding-left: 120px">android.support.v4.app.ListFragment </pre>
<ol start="2">
<li>Create the following <span class="CodeInTextPACKT">interface</span> inside the <kbd><span class="CodeInTextPACKT">MasterFragment</span></kbd> class:</li>
</ol>
<pre style="padding-left: 60px"><span>public interface </span>OnMasterSelectedListener {<br/>    <span>public void </span><span>onItemSelected</span>(String countryName)<span>;<br/></span>}</pre>
<ol start="3">
<li>Set up the interface callback listener with the following code:</li>
</ol>
<pre style="padding-left: 60px"><span>private </span>OnMasterSelectedListener <span>mOnMasterSelectedListener</span>=<span>null;<br/></span><span><br/></span><span>public void </span><span>setOnMasterSelectedListener</span>(OnMasterSelectedListener listener) {<br/>    <span>mOnMasterSelectedListener</span>=listener<span>;<br/></span>}</pre>
<ol start="4">
<li>The last step for the <kbd><span class="CodeInTextPACKT">MasterFragment</span></kbd> is to create <kbd><span class="CodeInTextPACKT">ListAdapter</span></kbd> to populate <kbd><span class="CodeInTextPACKT">ListView</span></kbd>, which we do in the <kbd><span class="CodeInTextPACKT">onViewCreated()</span></kbd> method. W<span>hen a country name is selected, w</span>e'll use <kbd><span class="CodeInTextPACKT">setOnItemClickListener()</span></kbd> to call our <kbd><span class="CodeInTextPACKT">OnMasterSelectedListener</span></kbd> <span>interface with the following code:</span></li>
</ol>
<pre style="padding-left: 60px"><span>public void </span><span>onViewCreated</span>(View view<span>, </span>Bundle savedInstanceState) {<br/>    <span>super</span>.onViewCreated(view<span>, </span>savedInstanceState)<span>;<br/></span><span><br/></span><span>    </span>String[] countries = <span>new </span>String[]{<span>"China"</span><span>, </span><span>"France"</span><span>,<br/></span><span>            </span><span>"Germany"</span><span>, </span><span>"India"</span><span>, </span><span>"Russia"</span><span>, </span><span>"United Kingdom"</span><span>,<br/></span><span>            </span><span>"United States"</span>}<span>;<br/></span><span><br/></span><span>    </span>ListAdapter countryAdapter = <span>new </span>ArrayAdapter&lt;String&gt;(<br/>            getActivity()<span>, </span>android.R.layout.<span>simple_list_item_1</span><span>,<br/></span><span>            </span>countries)<span>;<br/></span><span><br/></span><span>    </span>setListAdapter(countryAdapter)<span>;<br/></span><span><br/></span><span>    </span>getListView().setChoiceMode(ListView.<span>CHOICE_MODE_SINGLE</span>)<span>;<br/></span><span><br/></span><span>    </span>getListView().setOnItemClickListener(<span>new </span>AdapterView.OnItemClickListener() {<br/>        <span>@Override<br/></span><span>        </span><span>public void </span><span>onItemClick</span>(AdapterView&lt;?&gt; parent<span>, </span>View<br/>                view<span>, int </span>position<span>, long </span>id) {<br/>            <span>if </span>(<span>mOnMasterSelectedListener </span>!= <span>null</span>) {<br/>                <span>mOnMasterSelectedListener</span>.onItemSelected(((<br/>                        TextView) view).getText().toString())<span>;<br/></span><span>            </span>}<br/>        }<br/>    })<span>;<br/></span>}</pre>
<ol start="5">
<li>Next, we need to create <kbd><span class="CodeInTextPACKT">DetailFragment</span></kbd>, starting with the layout. Create a new layout file called <kbd><span class="CodeInTextPACKT">fragment_detail.xml</span></kbd> with the following XML:</li>
</ol>
<pre style="padding-left: 60px"><span>&lt;?</span><span>xml version=</span><span>"1.0" </span><span>encoding=</span><span>"utf-8"</span><span>?&gt;<br/></span><span>&lt;RelativeLayout<br/></span><span>    </span><span>xmlns:</span><span>android</span><span>=</span><span>"http://schemas.android.com/apk/res/android"<br/></span><span>    </span><span>android</span><span>:layout_width=</span><span>"match_parent"<br/></span><span>    </span><span>android</span><span>:layout_height=</span><span>"match_parent"</span><span>&gt;<br/></span><span>    &lt;TextView<br/></span><span>        </span><span>android</span><span>:id=</span><span>"@+id/textViewCountryName"<br/></span><span>        </span><span>android</span><span>:layout_width=</span><span>"wrap_content"<br/></span><span>        </span><span>android</span><span>:layout_height=</span><span>"wrap_content"<br/></span><span>        </span><span>android</span><span>:layout_centerVertical=</span><span>"true"<br/></span><span>        </span><span>android</span><span>:layout_centerHorizontal=</span><span>"true" </span><span>/&gt;<br/></span><span>&lt;/RelativeLayout&gt;</span></pre>
<ol start="6">
<li>Create a new Java class called <kbd><span class="CodeInTextPACKT">DetailFragment</span></kbd> extending from <kbd><span class="CodeInTextPACKT">Fragment</span></kbd> <span>as follows:</span></li>
</ol>
<pre style="padding-left: 60px">public class DetailFragment extends Fragment </pre>
<ul>
<li>Import from the following library:</li>
</ul>
<pre style="padding-left: 120px">android.support.v4.app.Fragment </pre>
<ol start="7">
<li>Add the following constant to the class:</li>
</ol>
<pre style="padding-left: 60px">public static String KEY_COUNTRY_NAME="KEY_COUNTRY_NAME"; </pre>
<ol start="8">
<li>Override <kbd><span class="CodeInTextPACKT">onCreateView()</span></kbd> as follows:</li>
</ol>
<pre style="padding-left: 60px"><span>@Override<br/></span><span>public </span>View <span>onCreateView</span>(LayoutInflater inflater<span>, <br/></span><span>                         </span>ViewGroup container<span>, <br/></span><span>                         </span>Bundle savedInstanceState) {<br/>    <span>return </span>inflater.inflate(R.layout.<span>fragment_detail</span><span>, </span>container<span>, false</span>)<span>;<br/></span>}</pre>
<ol start="9">
<li>Code <kbd><span class="CodeInTextPACKT">onViewCreated()</span></kbd> as follows:</li>
</ol>
<pre style="padding-left: 60px"><span>@Override<br/></span><span>public void </span><span>onViewCreated</span>(<span>@NonNull </span>View view<span>, </span><span>@Nullable </span>Bundle savedInstanceState) {<br/>    <span>super</span>.onViewCreated(view<span>, </span>savedInstanceState)<span>;<br/></span><span><br/></span><span>    </span>Bundle bundle = getArguments()<span>;<br/></span><span><br/></span><span>    if </span>(bundle != <span>null </span>&amp;&amp; bundle.containsKey(<span>KEY_COUNTRY_NAME</span>)) {<br/>        showSelectedCountry(bundle.getString(<span>KEY_COUNTRY_NAME</span>))<span>;<br/></span><span>    </span>}<br/>}</pre>
<ol start="10">
<li>The last step for this Fragment is to update <kbd>TextView</kbd> when we receive the selected country name. Add the following method to the class:</li>
</ol>
<pre style="padding-left: 60px"><span>public void </span><span>showSelectedCountry</span>(String countryName) {<br/>    ((TextView)getView().findViewById(R.id.<span>textViewCountryName</span>)).setText(countryName)<span>;<br/></span>}</pre>
<ol start="11">
<li>The existing <kbd><span class="CodeInTextPACKT">activity_main.xml</span></kbd> layout will handle the portrait mode layout. Remove the existing <kbd><span class="CodeInTextPACKT">&lt;TextView&gt;</span></kbd> and replace with the following <kbd><span class="CodeInTextPACKT">&lt;FrameLayout&gt;</span></kbd>:</li>
</ol>
<pre style="padding-left: 60px"><span>&lt;FrameLayout<br/></span><span>    </span><span>android</span><span>:id=</span><span>"@+id/frameLayout"<br/></span><span>    </span><span>android</span><span>:layout_width=</span><span>"match_parent"<br/></span><span>    </span><span>android</span><span>:layout_height=</span><span>"match_parent"<br/></span><span>    </span><span>android</span><span>:layout_marginTop=</span><span>"8dp"<br/></span><span>    </span><span>app</span><span>:layout_constraintBottom_toBottomOf=</span><span>"parent"<br/></span><span>    </span><span>app</span><span>:layout_constraintLeft_toLeftOf=</span><span>"parent"<br/></span><span>    </span><span>app</span><span>:layout_constraintRight_toRightOf=</span><span>"parent"<br/></span><span>    </span><span>app</span><span>:layout_constraintTop_toTopOf=</span><span>"parent" </span><span>/&gt;</span></pre>
<ol start="12">
<li><span>For the landscape layout, c</span>reate a new directory called <span><kbd>layout-land</kbd> </span>in the <kbd><span class="ScreenTextPACKT">res</span></kbd> <span>folder. The final result will be </span><kbd><span class="CodeInTextPACKT">res/layout-land</span></kbd>.</li>
</ol>
<div class="packt_tip">If you do not see the new <kbd>res/layout-land</kbd> directory, change from <span class="KeyWordPACKT">Android</span> <span class="KeyWordPACKT">view</span> to p<span class="KeyWordPACKT">roject</span> <span class="KeyWordPACKT">view</span>.</div>
<ol start="13">
<li>Create a new <kbd><span class="CodeInTextPACKT">activity_main.xml</span></kbd> layout in <kbd><span class="CodeInTextPACKT">res/layout-land</span></kbd> as follows:</li>
</ol>
<pre style="padding-left: 60px"><span>&lt;?</span><span>xml version=</span><span>"1.0" </span><span>encoding=</span><span>"utf-8"</span><span>?&gt;<br/></span><span>&lt;LinearLayout </span><span>xmlns:</span><span>android</span><span>=</span><span>"http://schemas.android.com/apk/res/android"<br/></span><span>    </span><span>xmlns:</span><span>tools</span><span>=</span><span>"http://schemas.android.com/tools"<br/></span><span>    </span><span>android</span><span>:layout_width=</span><span>"match_parent"<br/></span><span>    </span><span>android</span><span>:layout_height=</span><span>"match_parent"<br/></span><span>    </span><span>android</span><span>:orientation=</span><span>"horizontal"</span><span>&gt;<br/></span><span>    &lt;FrameLayout<br/></span><span>        </span><span>android</span><span>:id=</span><span>"@+id/frameLayoutMaster"<br/></span><span>        </span><span>android</span><span>:layout_width=</span><span>"0dp"<br/></span><span>        </span><span>android</span><span>:layout_weight=</span><span>"1"<br/></span><span>        </span><span>android</span><span>:layout_height=</span><span>"match_parent"</span><span>/&gt;<br/></span><span>    &lt;FrameLayout<br/></span><span>        </span><span>android</span><span>:id=</span><span>"@+id/frameLayoutDetail"<br/></span><span>        </span><span>android</span><span>:layout_width=</span><span>"0dp"<br/></span><span>        </span><span>android</span><span>:layout_weight=</span><span>"1"<br/></span><span>        </span><span>android</span><span>:layout_height=</span><span>"match_parent"</span><span>/&gt;<br/></span><span>&lt;/LinearLayout&gt;</span></pre>
<ol start="14">
<li>The final steps are to set up <kbd><span class="CodeInTextPACKT">MainActivity</span></kbd> to handle the Fragments. Open the <kbd><span class="CodeInTextPACKT">MainActivity.java</span></kbd> file and add the following class variable to track single/dual pane:</li>
</ol>
<pre style="padding-left: 60px">boolean mDualPane;</pre>
<ol start="15">
<li>Next, change <kbd><span class="CodeInTextPACKT">onCreate()</span></kbd> as follows:</li>
</ol>
<pre style="padding-left: 60px"><span>@Override<br/></span><span>protected void </span><span>onCreate</span>(Bundle savedInstanceState) {<br/>    <span>super</span>.onCreate(savedInstanceState)<span>;<br/></span><span><br/></span><span>    </span>setContentView(R.layout.<span>activity_main</span>)<span>;<br/></span><span><br/></span><span>    </span>MasterFragment masterFragment = <span>null;<br/></span><span>    </span>FrameLayout frameLayout = findViewById(R.id.<span>frameLayout</span>)<span>;<br/></span><span>    if </span>(frameLayout != <span>null</span>) {<br/>        <span>mDualPane </span>= <span>false;<br/></span><span>        </span>FragmentTransaction fragmentTransaction = getSupportFragmentManager().beginTransaction()<span>;<br/></span><span>        </span>masterFragment = (MasterFragment) getSupportFragmentManager()<br/>                .findFragmentByTag(<span>"MASTER"</span>)<span>;<br/></span><span>        if </span>(masterFragment == <span>null</span>) {<br/>            masterFragment = <span>new </span>MasterFragment()<span>;<br/></span><span>            </span>fragmentTransaction.add(R.id.<span>frameLayout</span><span>, </span>masterFragment<span>, </span><span>"MASTER"</span>)<span>;<br/></span><span>        </span>}<br/>        DetailFragment detailFragment = (DetailFragment)<br/>                getSupportFragmentManager().findFragmentById(R.id.<span>frameLayoutDetail</span>)<span>;<br/></span><span>        if </span>(detailFragment != <span>null</span>) {<br/>            fragmentTransaction.remove(detailFragment)<span>;<br/></span><span>        </span>}<br/>        fragmentTransaction.commit()<span>;<br/></span><span>    </span>} <span>else </span>{<br/>        <span>mDualPane </span>= <span>true;<br/></span><span>        </span>FragmentTransaction fragmentTransaction = getSupportFragmentManager().beginTransaction()<span>;<br/></span><span>        </span>masterFragment = (MasterFragment) getSupportFragmentManager()<br/>                .findFragmentById(R.id.<span>frameLayoutMaster</span>)<span>;<br/></span><span>        if </span>(masterFragment == <span>null</span>) {<br/>            masterFragment = <span>new </span>MasterFragment()<span>;<br/></span><span>            </span>fragmentTransaction.add(R.id.<span>frameLayoutMaster</span><span>, </span>masterFragment)<span>;<br/></span><span>        </span>}<br/>        DetailFragment detailFragment = (DetailFragment) getSupportFragmentManager()<br/>                .findFragmentById(R.id.<span>frameLayoutDetail</span>)<span>;<br/></span><span>        if </span>(detailFragment == <span>null</span>) {<br/>            detailFragment = <span>new </span>DetailFragment()<span>;<br/></span><span>            </span>fragmentTransaction.add(R.id.<span>frameLayoutDetail</span><span>, </span>detailFragment)<span>;<br/></span><span>        </span>}<br/>        fragmentTransaction.commit()<span>;<br/></span><span>    </span>}<br/>    masterFragment.setOnMasterSelectedListener(<span>new </span>MasterFragment.OnMasterSelectedListener() {<br/>        <span>@Override<br/></span><span>        </span><span>public void </span><span>onItemSelected</span>(String countryName) {<br/>            sendCountryName(countryName)<span>;<br/></span><span>        </span>}<br/>    })<span>;<br/></span>}</pre>
<ol start="16">
<li>The last code to add is the <kbd><span class="CodeInTextPACKT">sendCountryName()</span></kbd> method, which handles sending the country name to <kbd><span class="CodeInTextPACKT">DetailFragment</span></kbd>:</li>
</ol>
<pre style="padding-left: 60px"><span>private void </span><span>sendCountryName</span>(String countryName) {<br/>    DetailFragment detailFragment<span>;<br/></span><span>    if </span>(<span>mDualPane</span>) {<br/>        <span>//Two pane layout<br/></span><span>        </span>detailFragment = (DetailFragment) getSupportFragmentManager().findFragmentById(R.id.<span>frameLayoutDetail</span>)<span>;<br/></span><span>        </span>detailFragment.showSelectedCountry(countryName)<span>;<br/></span><span>    </span>} <span>else </span>{<br/>        <span>// Single pane layout<br/></span><span>        </span>detailFragment = <span>new </span>DetailFragment()<span>;<br/></span><span>        </span>Bundle bundle = <span>new </span>Bundle()<span>;<br/></span><span>        </span>bundle.putString(DetailFragment.<span>KEY_COUNTRY_NAME</span><span>, </span>countryName)<span>;<br/></span><span>        </span>detailFragment.setArguments(bundle)<span>;<br/></span><span>        </span>FragmentTransaction fragmentTransaction = getSupportFragmentManager().beginTransaction()<span>;<br/></span><span>        </span>fragmentTransaction.replace(R.id.<span>frameLayout</span><span>, </span>detailFragment)<span>;<br/></span><span>        </span>fragmentTransaction.addToBackStack(<span>null</span>)<span>;<br/></span><span>        </span>fragmentTransaction.commit()<span>;<br/></span><span>    </span>}<br/>}</pre>
<ol start="17">
<li>Run the program on a device or emulator.</li>
</ol>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">How it works...</h1>
                </header>
            
            <article>
                
<p>We start by creating <kbd><span class="CodeInTextPACKT">MasterFragment</span></kbd>. In the Master/Detail pattern we are using, this usually represents a list, so we create a list by extending <kbd><span class="CodeInTextPACKT">ListFragment</span></kbd>. <kbd><span class="CodeInTextPACKT">ListFragment</span></kbd> is the Fragment equivalent of <kbd><span class="CodeInTextPACKT">ListActivity</span></kbd>. Other than <span>extending from a Fragment, it's basically the same.</span></p>
<p><span>As stated in the recipe introduction, we shouldn't attempt to communicate directly with other Fragments.</span></p>
<p>To provide a means to communicate the list item selection, we expose the interface: <kbd><span class="CodeInTextPACKT">OnMasterSelectedListener</span></kbd>. We call <kbd><span class="CodeInTextPACKT">onItemSelected()</span></kbd> <span>every time an item is selected in the list.</span></p>
<p>Most of the work for passing data between Fragments is done in the host activity but, ultimately, the receiving Fragment needs a way to receive the data. <kbd><span class="CodeInTextPACKT">DetailFragment</span></kbd> supports this in two ways:</p>
<ul>
<li>Passing the country name in the argument bundle, available at creation time</li>
<li>A public method for the activity to call directly.</li>
</ul>
<p>When the activity creates the Fragment, it also creates a <span class="CodeInTextPACKT">bundle</span> to hold the data we want to send. Here we add the country name using <kbd><span class="CodeInTextPACKT">KEY_COUNTRY_NAME</span></kbd> defined in step 7. We retrieve this bundle with <kbd><span class="CodeInTextPACKT">getArguments()</span></kbd> in <kbd><span class="CodeInTextPACKT">onViewCreated()</span></kbd>. If the key is found in the bundle, it is extracted and displayed using the <kbd><span class="CodeInTextPACKT">showSelectedCountry()</span></kbd> method. This is the same method the activity will call directly if the Fragment is already visible (in the two-panel layout).</p>
<p>Most of the work for this recipe is in the activity. We created two layouts: one for portrait and one for landscape. When in landscape orientation, Android will choose the landscape layout from the <kbd><span class="CodeInTextPACKT">res/layout-land</span></kbd> <span>directory created in s<span class="ItalicsPACKT">tep 12</span>. Both layouts use a</span> <kbd><span class="CodeInTextPACKT">&lt;FrameLayout&gt;</span></kbd> placeholder, similar to the previous exercise. We manage the Fragments in both <kbd><span class="CodeInTextPACKT">onCreate()</span></kbd> and <kbd><span class="CodeInTextPACKT">sendCountryName()</span></kbd>.</p>
<p>In <kbd><span class="CodeInTextPACKT">onCreate()</span></kbd>, we set the <kbd>mD<span class="CodeInTextPACKT">ualPane</span></kbd> flag by checking whether the current layout includes the <kbd><span class="CodeInTextPACKT">frameLayout</span></kbd> view. If <kbd><span class="CodeInTextPACKT">frameLayout</span></kbd> is found (meaning it's not null), then we have only a single panel because <kbd><span class="CodeInTextPACKT">frameLayout</span></kbd> is only defined in the portrait layout. If <kbd>frameLayout</kbd> is not found, then we have two <kbd><span class="CodeInTextPACKT">&lt;FrameLayout&gt;</span></kbd> elements instead: one for <kbd><span class="CodeInTextPACKT">MasterFragment</span></kbd> and another for <kbd><span class="CodeInTextPACKT">DetailFragment</span></kbd>.</p>
<p>The last thing we do in <kbd><span class="CodeInTextPACKT">onCreate()</span></kbd> is to set up the <kbd><span class="CodeInTextPACKT">MasterFragment</span></kbd> listener by creating an anonymous callback, which passes the country name to the <kbd><span class="CodeInTextPACKT">sendCountryName()</span></kbd> method. The <kbd><span class="CodeInTextPACKT">sendCountryName()</span></kbd> method is where the data is actually passed to <kbd><span class="CodeInTextPACKT">DetailFragment</span></kbd>. If we are in portrait (or single-pane) mode, we need to create <kbd><span class="CodeInTextPACKT">DetailFragment</span></kbd> and replace the existing <kbd><span class="CodeInTextPACKT">MasterFragment</span></kbd>. This is where we create the bundle with the country name and call <kbd><span class="CodeInTextPACKT">setArguments()</span></kbd>. Notice how we call <kbd><span class="CodeInTextPACKT">addToBackStack()</span></kbd> before committing the transaction? This allows the back key to bring the user back to the list (<kbd><span class="CodeInTextPACKT">MasterFragment</span></kbd>). If we are in landscape mode, <kbd><span class="CodeInTextPACKT">DetailFragment</span></kbd> is already visible so we call the <kbd><span class="CodeInTextPACKT">howSelectedCountry()</span></kbd> public method directly.</p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">There's more...</h1>
                </header>
            
            <article>
                
<p>In <kbd><span class="CodeInTextPACKT">MasterFragment</span></kbd>, before sending the <kbd><span class="CodeInTextPACKT">onItemSelected()</span></kbd> event, we check to make sure the listener is not null with the following code:</p>
<pre>if (mOnMasterSelectedListener != null) </pre>
<p>Though it's the job of the activity to set up the callback to receive the events, we don't want this code to crash if there's no listener. An alternative approach would be to verify the activity extends our interface in the Fragment's <kbd><span class="CodeInTextPACKT">onAttach()</span></kbd> callback.</p>
<p>The objective for this recipe was to demonstrate the proper pattern for communicating between fragments (by using an interface) and how to pass data. We used the <kbd>ListView</kbd> fragment because it made typing this example easier, but for real-world applications, it's probably better to use <kbd>RecyclerView</kbd>. <kbd>RecyclerView</kbd> does not have a pre-made <kbd>Fragment</kbd> class (or <kbd>Activity</kbd> class) so you need to roll your own but it's no different than the examples shown in earlier chapters.</p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">See also</h1>
                </header>
            
            <article>
                
<ul>
<li>For <kbd>RecyclerView</kbd> examples, refer to the <em>RecyclerView replaces ListView</em> section in <a href="0b95f21f-496a-48ca-900c-32d887d3a3fe.xhtml" target="_blank">Chapter 2</a>, <em>Layouts</em> and the <em>Using Contextual Batch Mode with RecyclerView</em> section in <a href="271b832c-648f-4a10-967e-aac99272e9a9.xhtml" target="_blank">Chapter 4</a>, <em>Menus and Action Mode</em>.</li>
<li><span>For more information on resource directories, see the <em><span class="ItalicsPACKT">Selecting themes based on the Android version</span></em> section in <a href="3adebbef-b8f1-41ca-ba6c-c56329c9ea53.xhtml" target="_blank"><span class="ChapterrefPACKT">Chapter 3</span></a>, <em><span class="ItalicsPACKT">Views, Widgets, and Styles</span></em>.</span></li>
</ul>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Handling the Fragment back stack</h1>
                </header>
            
            <article>
                
<p>In several of the previous recipes, it was mentioned that you should call the <kbd>addToBackStack()</kbd> method in the Fragment transaction to enable Android to maintain a Fragment back stack. This is the first step, but may not be enough to provide a rich user experience. In this recipe, we'll explore two other callbacks: <kbd>onBackPressed()</kbd> and <kbd>onBackStackChanged()</kbd>. As you'll see, by implementing these callbacks, your application can provide specific behavior for the Fragment back stack. The <kbd>onBackPressed()</kbd> callback allows the app to check the back stack state and provide custom behavior, such as closing the app when appropriate.</p>
<p>The <span><kbd>onBackStackChanged()</kbd> callback is called whenever the actual back stack changes - such as when a Fragment is popped from the back stack. By overriding this callback, your app can check the current Fragment and update the UI (such as the <em>Home</em> key back arrow) as appropriate.</span></p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Getting ready</h1>
                </header>
            
            <article>
                
<p>Create a new project in Android Studio and call it<span> </span><kbd><span class="CodeInTextPACKT">FragmentBackStack</span></kbd>. <span>Use the default </span><span class="packt_screen">Phone &amp; Tablet</span><span> option and select </span><span class="packt_screen">Empty Activity</span><span> on the </span><span class="packt_screen">Add an Activity to Mobile</span><span> dialog.</span></p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">How to do it...</h1>
                </header>
            
            <article>
                
<p><span>To demonstrate handling the Fragment back stack, we'll create two fragments with a </span><span class="packt_screen">Next</span><span> button to create a back stack. With that setup, we'll implement the <kbd>onBackPressed()</kbd> callback to exit the app when the user reaches the top Fragment. We'll be using the Fragment Manager from the support library, so be sure to choose the support library version when prompted for the import library. We'll need two layout files - one for each fragment - along with two fragment classes. Here are the steps in detail:</span></p>
<ol>
<li>Create a new layout file called<span> </span><kbd><span class="CodeInTextPACKT">fragment_one.xml</span></kbd><span> with</span> the following XML:</li>
</ol>
<pre style="padding-left: 60px"><span>&lt;?</span><span>xml version=</span><span>"1.0" </span><span>encoding=</span><span>"utf-8"</span><span>?&gt;<br/></span><span>&lt;RelativeLayout </span><span>xmlns:</span><span>android</span><span>=</span><span>"http://schemas.android.com/apk/res/android"<br/></span><span>    </span><span>android</span><span>:layout_height=</span><span>"match_parent"<br/></span><span>    </span><span>android</span><span>:layout_width=</span><span>"match_parent"</span><span>&gt;<br/></span><span>    &lt;TextView<br/></span><span>        </span><span>android</span><span>:id=</span><span>"@+id/textView"<br/></span><span>        </span><span>android</span><span>:layout_width=</span><span>"wrap_content"<br/></span><span>        </span><span>android</span><span>:layout_height=</span><span>"wrap_content"<br/></span><span>        </span><span>android</span><span>:text=</span><span>"Fragment One"<br/></span><span>        </span><span>android</span><span>:layout_centerVertical=</span><span>"true"<br/></span><span>        </span><span>android</span><span>:layout_centerHorizontal=</span><span>"true" </span><span>/&gt;<br/></span><span>&lt;/RelativeLayout&gt;</span></pre>
<ol start="2">
<li>Create the second fragment layout file called<span> </span><span class="CodeInTextPACKT"><kbd>fragment_two.xml</kbd> with the same XML as above, changing the following text property:</span></li>
</ol>
<pre style="padding-left: 60px"><span>android</span><span>:text=</span><span>"Fragment Two"</span></pre>
<ol start="3">
<li>With the layout files created, it's time to create the classes for the fragments. Create a new Java class called<span> </span><kbd><span class="CodeInTextPACKT">FragmentOne.java</span></kbd><span> </span>with the following code:</li>
</ol>
<pre style="padding-left: 60px"><span>public class </span>FragmentOne <span>extends </span>Fragment {<br/>    <span>@Override<br/></span><span>    </span><span>public </span>View <span>onCreateView</span>(LayoutInflater inflater<span>,<br/></span><span>                             </span>ViewGroup container<span>, </span>Bundle savedInstanceState) {<br/>        <span>return </span>inflater.inflate(R.layout.<span>fragment_one</span><span>,<br/></span><span>                </span>container<span>, false</span>)<span>;<br/></span><span>    </span>}<br/>} </pre>
<ol start="4">
<li>Create the second Java class called<span> </span><kbd><span class="CodeInTextPACKT">FragmentTwo</span></kbd><span> </span>with the following code:</li>
</ol>
<pre style="padding-left: 60px"><span>public class </span>FragmentTwo <span>extends </span>Fragment {<br/>    <span>@Override<br/></span><span>    </span><span>public </span>View <span>onCreateView</span>(LayoutInflater inflater<span>,<br/></span><span>                             </span>ViewGroup container<span>, </span>Bundle savedInstanceState) {<br/>        <span>return </span>inflater.inflate(R.layout.<span>fragment_two</span><span>,<br/></span><span>                </span>container<span>, false</span>)<span>;<br/></span><span>    </span>}<br/>}</pre>
<ol start="5">
<li>Now we need to add a container and a button to the Main Activity layout. Change<span> </span><kbd><span class="CodeInTextPACKT">activity_main.xml</span></kbd><span> </span>as follows:</li>
</ol>
<pre style="padding-left: 60px"><span>&lt;?</span><span>xml version=</span><span>"1.0" </span><span>encoding=</span><span>"utf-8"</span><span>?&gt;<br/></span><span>&lt;RelativeLayout </span><span>xmlns:</span><span>android</span><span>=</span><span>"http://schemas.android.com/apk/res/android"<br/></span><span>    </span><span>android</span><span>:layout_width=</span><span>"match_parent"<br/></span><span>    </span><span>android</span><span>:layout_height=</span><span>"match_parent"</span><span>&gt;<br/></span><span>    &lt;FrameLayout<br/></span><span>        </span><span>android</span><span>:id=</span><span>"@+id/frameLayout"<br/></span><span>        </span><span>android</span><span>:layout_width=</span><span>"match_parent"<br/></span><span>        </span><span>android</span><span>:layout_height=</span><span>"wrap_content"<br/></span><span>        </span><span>android</span><span>:layout_above=</span><span>"@+id/buttonNext"<br/></span><span>        </span><span>android</span><span>:layout_alignParentTop=</span><span>"true"</span><span>&gt;<br/></span><span>    &lt;/FrameLayout&gt;<br/></span><span>    &lt;Button<br/></span><span>        </span><span>android</span><span>:id=</span><span>"@+id/buttonNext"<br/></span><span>        </span><span>android</span><span>:layout_width=</span><span>"wrap_content"<br/></span><span>        </span><span>android</span><span>:layout_height=</span><span>"wrap_content"<br/></span><span>        </span><span>android</span><span>:text=</span><span>"Next"<br/></span><span>        </span><span>android</span><span>:layout_alignParentBottom=</span><span>"true"<br/></span><span>        </span><span>android</span><span>:layout_centerInParent=</span><span>"true"</span><span>/&gt;<br/></span><span>&lt;/RelativeLayout&gt;</span></pre>
<ol start="6">
<li>With the Fragments created and the container added to the layout, we are now ready to write the code to manipulate the Fragments. Open<span> </span><kbd><span class="CodeInTextPACKT">MainActivity.java</span></kbd><span> </span>and add the following code below the class constructor:</li>
</ol>
<pre style="padding-left: 60px">Button <span>mButtonNext</span><span>;</span></pre>
<ol start="7">
<li>Add the following code to the existing<span> </span><kbd><span class="CodeInTextPACKT">onCreate()</span><span> </span></kbd>method, below<span> </span><kbd><span class="CodeInTextPACKT">setContentView()</span></kbd>:</li>
</ol>
<pre style="padding-left: 60px"><span>mButtonNext </span>= findViewById(R.id.<span>buttonNext</span>)<span>;<br/></span><span>mButtonNext</span>.setOnClickListener(<span>new </span>View.OnClickListener() {<br/>    <span>@Override<br/></span><span>    </span><span>public void </span><span>onClick</span>(View view) {<br/>        FragmentManager fragmentManager = getSupportFragmentManager()<span>;<br/></span><span>        </span>FragmentTransaction fragmentTransaction =<br/>                fragmentManager.beginTransaction()<span>;<br/></span><span>        </span>fragmentTransaction.replace(R.id.<span>frameLayout</span><span>,  new </span>FragmentTwo())<span>;<br/></span><span>        </span>fragmentTransaction.addToBackStack(<span>null</span>)<span>;<br/></span><span>        </span>fragmentTransaction.commit()<span>;<br/></span><span>        </span><span>mButtonNext</span>.setVisibility(View.<span>INVISIBLE</span>)<span>;<br/></span><span>    </span>}<br/>})<span>;<br/></span><span><br/></span>FragmentManager fragmentManager = getSupportFragmentManager()<span>;<br/></span>FragmentTransaction fragmentTransaction =<br/>        fragmentManager.beginTransaction()<span>;<br/></span>fragmentTransaction.add(R.id.<span>frameLayout</span><span>,  new </span>FragmentOne())<span>;<br/></span>fragmentTransaction.addToBackStack(<span>null</span>)<span>;<br/></span>fragmentTransaction.commit()<span>;</span></pre>
<ol start="8">
<li>The last method to implement is the <kbd>onBackPressed()</kbd> callback:</li>
</ol>
<pre style="padding-left: 60px"><span>@Override<br/></span><span>public void </span><span>onBackPressed</span>() {<br/>    <span>if</span>(getSupportFragmentManager().getBackStackEntryCount() == <span>2 </span>) {<br/>        <span>super</span>.onBackPressed()<span>;<br/></span><span>        </span><span>mButtonNext</span>.setVisibility(View.<span>VISIBLE</span>)<span>;<br/></span><span>    </span>} <span>else </span>{<br/>        finish()<span>;<br/></span><span>    </span>}<br/>}</pre>
<ol start="9">
<li>Run the program on a device or emulator.</li>
</ol>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">How it works...</h1>
                </header>
            
            <article>
                
<p>Most of the steps are similar to the <em>Adding and removing Fragments during runtime </em>recipe discussed previously, until step 8. The first seven steps just set up the app to create the fragments for our demonstration. In step 8, we implement the <kbd>onBackPressed()</kbd> callback. This is where we code for our specific situation. For this sample, all we need to do is make the <span class="packt_screen">Next</span> button visible again.</p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">There's more...</h1>
                </header>
            
            <article>
                
<p>With the basics covered for handling the back stack, it's time to discuss the other callback: <kbd>onBackStackChanged()</kbd>. This is where you can implement custom behavior when the stack changes. One common example is changing the Home icon to a back arrow. We get this behavior automatically with an Activity when we set the parent property (in AndroidManifest), but Android doesn't do this for fragments. What if we wanted to have a back arrow on <kbd>FragmentTwo</kbd>? Add this line of code to the NextButton <kbd>onClick()</kbd>:</p>
<pre>getSupportActionBar().setDisplayHomeAsUpEnabled(<span>true</span>)<span>;</span></pre>
<p>If you run the app now, you'll see the back arrow when you go to <kbd>FragmentTwo</kbd>. The problem is, the back arrow doesn't actually do anything. The next problem you may notice is that if you use the back key, you still see the back arrow when you return to <kbd>FragmentOne</kbd>.</p>
<p>To make the back arrow work, add the following code to <kbd>MainActivity</kbd>:</p>
<pre><span>@Override<br/></span><span>public boolean </span><span>onOptionsItemSelected</span>(MenuItem menuItem) {<br/>    <span>if </span>(menuItem.getItemId() == android.R.id.<span>home</span>) {<br/>            onBackPressed()<span>;<br/></span><span>            return true;<br/></span><span>    </span>} <span>else </span>{<br/>        <span>return super</span>.onOptionsItemSelected(menuItem)<span>;<br/></span><span>    </span>}<br/>}</pre>
<p>Now the app will respond to the back arrow and treat it the same as the back key. What about the second issue? The Home icon still shows the back arrow. This is where we can use the <span><kbd>onBackStackChanged()</kbd> callback. Instead of modifying the NextButton <kbd>onClick()</kbd> as we did earlier, we can put all our code in <kbd>onBackStackChanged()</kbd>.</span></p>
<p>To do this, we need to implement the <kbd>OnBackStackChangedListener</kbd> interface in the class definition. Change the <kbd>MainActivity</kbd> declaration as follows:</p>
<pre><span>public class </span>MainActivity <span>extends </span>AppCompatActivity<br/>        <span>implements </span>FragmentManager.OnBackStackChangedListener {</pre>
<p>Then add this line to the <kbd>onCreate()</kbd> method (below <kbd>setContentView()</kbd>) to add the listener:</p>
<pre>getSupportFragmentManager().addOnBackStackChangedListener(<span>this</span>)<span>;</span></pre>
<p>Now we can implement the <span><kbd>onBackStackChanged()</kbd> callback:</span></p>
<pre><span>@Override<br/></span><span>public void </span><span>onBackStackChanged</span>() {<br/>    Fragment fragment = getSupportFragmentManager().findFragmentById(R.id.<span>frameLayout</span>)<span>;<br/></span><span>    if </span>(fragment <span>instanceof </span>FragmentOne) {<br/>        getSupportActionBar().setDisplayHomeAsUpEnabled(<span>false</span>)<span>;<br/></span><span>    </span>} <span>else if </span>(fragment <span>instanceof </span>FragmentTwo) {<br/>        getSupportActionBar().setDisplayHomeAsUpEnabled(<span>true</span>)<span>;<br/></span><span>    </span>}<br/>}</pre>
<p>Now when you run the app, you'll see the back arrow when you go to <kbd>FragmentTwo</kbd>. You can press the back arrow icon or use the back key to return to the first screen. Thanks to the <kbd>onBackStackChanged()</kbd> callback, you won't see the back arrow when you're on <kbd>FragmentOne</kbd>.</p>


            </article>

            
        </section>
    </body></html>