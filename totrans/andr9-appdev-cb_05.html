<html><head></head><body>
        

                            
                    <h1 class="header-title">Fragments</h1>
                
            
            
                
<p>In this chapter, we will cover the following topics:</p>
<ul>
<li>Creating and using a Fragment</li>
<li>Adding and removing Fragments during runtime</li>
<li>Passing data between Fragments</li>
<li>Handling the Fragment back stack</li>
</ul>


            

            
        
    

        

                            
                    <h1 class="header-title">Introduction</h1>
                
            
            
                
<p>With a firm understanding of layouts from <a href="0b95f21f-496a-48ca-900c-32d887d3a3fe.xhtml" target="_blank">Chapter 2</a>, <em>Layouts</em>, we'll dig deeper into UI development with Fragments. Fragments are a way to separate your UI into smaller sections that can easily be reused. Think of Fragments as mini-activities, complete with their own classes, layouts, and life cycle. Instead of designing your screen in one Activity Layout, possibly duplicating functionality across multiple layouts, you can break the screen into smaller, logical sections and turn them into Fragments. Your Activity Layout can then reference one or multiple Fragments, as needed.</p>


            

            
        
    

        

                            
                    <h1 class="header-title">Creating and using a Fragment</h1>
                
            
            
                
<p>Android didn't always support Fragments. The early versions of Android were designed for phones when screens had relatively small displays. It wasn't until Android started being used on tablets that there was a need to split the screen into smaller sections. Android 3.0 introduced the <kbd>Fragments</kbd> class and the Fragment Manager.</p>
<p>Along with a new class, also came the Fragment Lifecycle. The Fragment Lifecycle is similar to the Activity Lifecycle introduced in <a href="ef2fe8b4-1320-45f5-b0d5-fb9fd1d35e07.xhtml" target="_blank">Chapter 1</a>, <em>Activities</em>, as most events parallel the Activity Lifecycle.</p>
<p>Here's a brief overview of the main callbacks:</p>
<ul>
<li><kbd>onAttach()</kbd>: It's called when the Fragment is associated with an Activity.</li>
<li><kbd>onCreate()</kbd>: It's called when the Fragment is first created.</li>
<li><kbd>onCreateView()</kbd>: It's called when the Fragment is about to be displayed for the first time.</li>
<li><kbd>onActivityCreated()</kbd>: It's called when the associated Activity is created.</li>
<li><kbd>onStart()</kbd>: It's called when the Fragment will become visible to the user.</li>
<li><kbd>onResume()</kbd>: It's called just before a Fragment is displayed.</li>
<li><kbd>onPause()</kbd>: It's called when the Fragment is first suspended. The user may return to the Fragment, but this is where you should persist any user data.</li>
<li><kbd>onStop()</kbd>: It's called when the Fragment is no longer visible to the user.</li>
<li><kbd>onDestroyView()</kbd>: It's called to allow final cleanup.</li>
<li><kbd>onDetach()</kbd>: It's called when the Fragment is no longer associated with the Activity.</li>
</ul>
<p>For our first exercise, we will create a new Fragment derived from the standard <kbd>Fragment</kbd> class. But there are several other Fragment classes we could derive from, including the following:</p>
<ul>
<li><kbd>DialogFragment</kbd>: It's used for creating a floating dialog</li>
<li><kbd>ListFragment</kbd>: It creates a <kbd>ListView</kbd> in a Fragment, similar to <kbd>ListActivity</kbd></li>
<li><kbd>PreferenceFragment</kbd>: It creates a list of <kbd>Preference</kbd> objects, commonly used for a Settings page</li>
</ul>
<p>In this recipe, we will walk through creating a basic Fragment derived from the <kbd>Fragment</kbd> class and include it in an Activity Layout.</p>


            

            
        
    

        

                            
                    <h1 class="header-title">Getting ready</h1>
                
            
            
                
<p>Create a new project in Android Studio and call it <kbd>CreateFragment</kbd>. Use the default Phone &amp; Tablet option and select Empty Activity on the Add an Activity to Mobile dialog.</p>


            

            
        
    

        

                            
                    <h1 class="header-title">How to do it...</h1>
                
            
            
                
<p>In this recipe, we will create a new <kbd>Fragment</kbd> class with an accompanying layout file. We will then add the Fragment to the Activity Layout so it will be visible when the activity starts.</p>
<p>Here are the steps to create and display a new Fragment:</p>
<ol>
<li>Create a new layout called <kbd>fragment_one.xml</kbd> using the following XML:</li>
</ol>
<pre style="padding-left: 60px">&lt;?xml version="1.0" encoding="utf-8"?&gt;<br/>&lt;RelativeLayout xmlns:android="http://schemas.android.com/apk/res/android"<br/>    android:layout_height="match_parent"<br/>    android:layout_width="match_parent"&gt;<br/>    &lt;TextView<br/>        android:layout_width="wrap_content"<br/>        android:layout_height="wrap_content"<br/>        android:text="Fragment One"<br/>        android:id="@+id/textView"<br/>        android:layout_centerVertical="true"<br/>        android:layout_centerHorizontal="true" /&gt;<br/>&lt;/RelativeLayout&gt; </pre>
<ol start="2">
<li>Create a new Java class called <kbd>FragmentOne.java</kbd> with the following code:</li>
</ol>
<pre style="padding-left: 60px">public class FragmentOne extends Fragment {<br/>    @Override<br/>    public View onCreateView(LayoutInflater inflater, ViewGroup container,<br/>                             Bundle savedInstanceState) {<br/>        return inflater.inflate(R.layout.fragment_one, container, false);<br/>    }<br/>}</pre>
<ol start="3">
<li>Open the <kbd>activity_main.xml</kbd> file and replace the existing <kbd>&lt;TextView&gt;</kbd> element with the following <kbd>&lt;fragment&gt;</kbd> element:</li>
</ol>
<pre style="padding-left: 60px">&lt;fragment<br/>    android:name="com.packtpub.createfragment.FragmentOne"<br/>    android:id="@+id/fragment"<br/>    android:layout_width="wrap_content"<br/>    android:layout_height="wrap_content"<br/>    android:layout_centerVertical="true"<br/>    android:layout_centerHorizontal="true" <br/>    app:layout_constraintBottom_toBottomOf="parent"<br/>    app:layout_constraintLeft_toLeftOf="parent"<br/>    app:layout_constraintRight_toRightOf="parent"<br/>    app:layout_constraintTop_toTopOf="parent" /&gt;</pre>
<ol start="4">
<li>Run the program on a device or emulator.</li>
</ol>


            

            
        
    

        

                            
                    <h1 class="header-title">How it works...</h1>
                
            
            
                
<p>We start by creating a new class, the same as we do for an Activity. In this recipe, we only create an overwrite for the <kbd>onCreateView()</kbd> method to load our Fragment layout. But, just like with the Activity events, we can override the other events as we need them. Once the new Fragment is created, we then add it to the Activity Layout. Since the original <kbd>Activity</kbd> class was created before Fragments existed, they do not support Fragments. That's why, unless otherwise indicated, all the examples for this book extend from <kbd>AppCompatActivity</kbd>. (If you used the Android Studio New Project Wizard, then by default <kbd>MainActivity</kbd> extends <kbd>AppCompatActivity</kbd>.)</p>


            

            
        
    

        

                            
                    <h1 class="header-title">There's more...</h1>
                
            
            
                
<p>We're only creating a single, simple Fragment in this recipe to teach the fundamentals of Fragments. But this is a good time to point out the power of Fragments. If we are creating multiple Fragments (and usually we are, as that's the point of using Fragments), when creating the Activity Layouts as we did in step 4, we could create different layout configurations using the Android Resource Folders. The portrait layout may have only a single Fragment while the landscape may have two or more. The Master/Detail layout typically uses Fragments, thus only requiring each screen section to be designed and coded once, then included in the layout as appropriate.</p>


            

            
        
    

        

                            
                    <h1 class="header-title">See also</h1>
                
            
            
                
<ul>
<li>For more information on the Master/Detail pattern, see the <em>Passing data between Fragments</em> recipe later in this chapter.</li>
</ul>


            

            
        
    

        

                            
                    <h1 class="header-title">Adding and removing Fragments during runtime</h1>
                
            
            
                
<p>Defining a Fragment in the layout, as we did in the previous recipe, is known as a static Fragment, which doesn't allow the fragment to be changed during runtime. Rather than using the <kbd>&lt;fragment&gt;</kbd> element, we will create a container to hold the Fragment, then create the Fragment dynamically in the Activity's <kbd>onCreate()</kbd> method.</p>
<p>The FragmentManager provides the APIs for adding, removing, and changing Fragments during runtime using a FragmentTransaction. A Fragment transaction consists of the following:</p>
<ol>
<li>Starting a transaction</li>
<li>Performing one or multiple actions</li>
<li>Committing the transaction</li>
</ol>
<p>This recipe will demonstrate the Fragment Manager by adding and removing Fragments during runtime.</p>


            

            
        
    

        

                            
                    <h1 class="header-title">Getting ready</h1>
                
            
            
                
<p>Create a new project in Android Studio and call it: <kbd>RuntimeFragments</kbd>. Use the default Phone &amp; Tablet option and select Empty Activity on the Add an Activity to Mobile dialog.</p>


            

            
        
    

        

                            
                    <h1 class="header-title">How to do it...</h1>
                
            
            
                
<p>To demonstrate adding and removing Fragments, we first need to create the Fragments, which we will do by extending the <kbd>Fragment</kbd> class. After creating the new Fragments, we need to alter the layout for the Main Activity to include the Fragment container. From there, we just add the code to handle the Fragment transactions. Here are the steps:</p>
<ol>
<li>Create a new layout file called <kbd>fragment_one.xml</kbd> and include the following XML:</li>
</ol>
<pre style="padding-left: 60px">&lt;?xml version="1.0" encoding="utf-8"?&gt;<br/>&lt;RelativeLayout xmlns:android="http://schemas.android.com/apk/res/android"<br/>    android:layout_height="match_parent"<br/>    android:layout_width="match_parent"&gt;<br/>    &lt;TextView<br/>        android:layout_width="wrap_content"<br/>        android:layout_height="wrap_content"<br/>        android:text="Fragment One"<br/>        android:id="@+id/textView"<br/>        android:layout_centerVertical="true"<br/>        android:layout_centerHorizontal="true" /&gt;<br/>&lt;/RelativeLayout&gt; </pre>
<ol start="2">
<li>The second layout file called <kbd>fragment_two.xml</kbd> is almost identical, with the only difference being the text:</li>
</ol>
<pre style="padding-left: 60px">android:text="Fragment Two" </pre>
<ol start="3">
<li>Create a new Java class called <kbd>FragmentOne.java</kbd> with the following code:</li>
</ol>
<pre style="padding-left: 60px">public class FragmentOne extends Fragment {<br/>    @Override<br/>    public View onCreateView(LayoutInflater inflater,<br/>                             ViewGroup container, Bundle savedInstanceState) {<br/>        return inflater.inflate(R.layout.fragment_one,<br/>                container, false);<br/>    }<br/>} </pre>
<ul>
<li>Import from the support library as follows:</li>
</ul>
<pre style="padding-left: 120px">import android.support.v4.app.Fragment;</pre>
<ol start="4">
<li>Create the second Java class called <kbd>FragmentTwo</kbd> with the following code:</li>
</ol>
<pre style="padding-left: 60px">public class FragmentTwo extends Fragment {<br/>    @Override<br/>    public View onCreateView(LayoutInflater inflater,<br/>                             ViewGroup container, Bundle savedInstanceState) {<br/>        return inflater.inflate(R.layout.fragment_two,<br/>                container, false);<br/>    }<br/>}</pre>
<ul>
<li>As before, import from the support library:</li>
</ul>
<pre style="padding-left: 120px">import android.support.v4.app.Fragment;</pre>
<ol start="5">
<li>Now we need to add a container and a button to the Main Activity layout. Change <kbd>activity_main.xml</kbd> as follows:</li>
</ol>
<pre style="padding-left: 60px">&lt;?xml version="1.0" encoding="utf-8"?&gt;<br/>&lt;RelativeLayout xmlns:android="http://schemas.android.com/apk/res/android"<br/>    android:layout_width="match_parent"<br/>    android:layout_height="match_parent"&gt;<br/>    &lt;FrameLayout<br/>        android:id="@+id/frameLayout"<br/>        android:layout_width="match_parent"<br/>        android:layout_height="wrap_content"<br/>        android:layout_above="@+id/buttonSwitch"<br/>        android:layout_alignParentTop="true"&gt;<br/>    &lt;/FrameLayout&gt;<br/>    &lt;Button<br/>        android:id="@+id/buttonSwitch"<br/>        android:layout_width="wrap_content"<br/>        android:layout_height="wrap_content"<br/>        android:text="Switch"<br/>        android:layout_alignParentBottom="true"<br/>        android:layout_centerInParent="true"<br/>        android:onClick="switchFragment"/&gt;<br/>&lt;/RelativeLayout&gt;</pre>
<ol start="6">
<li>With the Fragments created and the container added to the layout, we are now ready to write the code to manipulate the Fragments. Open <kbd>MainActivity.java</kbd> and add the following code below the class constructor:</li>
</ol>
<pre style="padding-left: 60px">FragmentOne mFragmentOne;<br/>FragmentTwo mFragmentTwo;<br/>int showingFragment=0;</pre>
<ol start="7">
<li>Add the following code to the existing <kbd>onCreate()</kbd> method, below <kbd>setContentView()</kbd>:</li>
</ol>
<pre style="padding-left: 60px">mFragmentOne = new FragmentOne();<br/>mFragmentTwo = new FragmentTwo();<br/>FragmentManager fragmentManager = getSupportFragmentManager();<br/>FragmentTransaction fragmentTransaction =<br/>        fragmentManager.beginTransaction();<br/>fragmentTransaction.add(R.id.frameLayout, mFragmentOne);<br/>fragmentTransaction.commit();<br/>showingFragment=1;</pre>
<ul>
<li>Import from the support libraries:</li>
</ul>
<pre style="padding-left: 120px">import android.support.v4.app.FragmentManager;<br/>import android.support.v4.app.FragmentTransaction;</pre>
<ol start="8">
<li>The last code we need to add handles the Fragment switching, called by the button:</li>
</ol>
<pre style="padding-left: 60px">public void switchFragment(View view) {<br/>    FragmentManager fragmentManager = getSupportFragmentManager();<br/>    FragmentTransaction fragmentTransaction = fragmentManager.beginTransaction();<br/>    if (showingFragment==1) {<br/>        fragmentTransaction.replace(R.id.frameLayout, mFragmentTwo);<br/>        showingFragment = 2;<br/>    } else {<br/>        fragmentTransaction.replace(R.id.frameLayout, mFragmentOne);<br/>        showingFragment=1;<br/>    }<br/>    fragmentTransaction.commit();<br/>}</pre>
<ol start="9">
<li>Run the program on a device or emulator.</li>
</ol>


            

            
        
    

        

                            
                    <h1 class="header-title">How it works...</h1>
                
            
            
                
<p>Most of the steps for this recipe involve setting up the Fragments. Once the Fragments are declared, we create them in the <kbd>onCreate()</kbd> method. Though the code can be condensed to a single line, it's shown in the long form as it makes it easier to read and understand.</p>
<p>First, we get <kbd>FragmentManager</kbd> so we can begin <kbd>FragmentTransaction</kbd>. Once we have <kbd>FragmentTransaction</kbd>, we start the transaction with <kbd>beginTransaction()</kbd>. Multiple actions can occur within the transaction, but all we need here is to <kbd>add()</kbd> our initial Fragment. We call the <kbd>commit()</kbd> method to finalize the transaction.</p>
<p>Now that you understand the Fragment transaction, here is the succinct version for <kbd>onCreate()</kbd>:</p>
<pre>getSupportFragmentManager().beginTransaction().add(R.id.frameLayout, mFragmentOne).commit();</pre>
<p>Our <kbd>switchFragment()</kbd> method does basically the same type of Fragment transaction. Instead of calling the <kbd>add()</kbd> method, we call the <kbd>replace()</kbd> method with the existing Fragment. We keep track of the current Fragment with the <kbd>showingFragment</kbd> variable so we know which Fragment to show next. We are not limited to switching between two Fragments either. If we needed additional Fragments, we just need to create them.</p>


            

            
        
    

        

                            
                    <h1 class="header-title">There's more...</h1>
                
            
            
                
<p>In the <em>Switching between activities</em> recipe from <a href="ef2fe8b4-1320-45f5-b0d5-fb9fd1d35e07.xhtml" target="_blank">Chapter 1</a>, <em>Activities</em>, we discussed the back stack. Most users would expect the back key to move backward through the "screens" and they don't know or care if those screens are activities or Fragments. Fortunately, Android makes it very easy to add Fragments to the back stack just by adding a call to <kbd>addToBackStack()</kbd> before calling <kbd>commit()</kbd>.</p>
<p>When a Fragment is removed or replaced without adding it to the back stack, it is immediately destroyed. If it is added to the back stack, it is stopped and, if the user returns to the Fragment, it is restarted, instead of recreated.</p>


            

            
        
    

        

                            
                    <h1 class="header-title">See also</h1>
                
            
            
                
<ul>
<li>For more information on managing the Fragment back stack, see the <em>Handling the Fragment back stack</em> recipe later in this chapter.</li>
</ul>


            

            
        
    

        

                            
                    <h1 class="header-title">Passing data between Fragments</h1>
                
            
            
                
<p>Often, the need arises to pass information between Fragments. An email application serves as a classic example. It's common to have the list of emails in one Fragment and show the email details in another Fragment (this is commonly referred to as a Master/Detail pattern). Fragments make creating this pattern easier because we only have to code each Fragment once, then include them in different layouts. We can easily have a single Fragment in a portrait layout with the ability to swap out the master Fragment with the detail Fragment when an email is selected. We can also create a two-panel layout where both the list and detail Fragments are side by side. Either way, when the user clicks the email in the list, the email opens up in the detail panel. This is when we need to communicate between two Fragments.</p>
<p>Since one of the primary goals of Fragments is that they be completely self-contained, direct communication between Fragments is discouraged, and for good reason. If Fragments had to rely on other Fragments, your code would likely break when the layouts changed and only one Fragment was available. Fortunately, direct communication is not required for this scenario either. All Fragment communication should pass through the host activity. The host activity is responsible for managing the Fragments and can properly route the messages.</p>
<p>Now the question becomes: How do Fragments communicate with the activity? The answer is with an interface. You're probably already familiar with an interface, as that's how a view communicates an event back to an activity. One of the most common examples is the button <kbd>onClick()</kbd> interface.</p>
<p>In this recipe, we will create two Fragments to demonstrate passing data from one Fragment to another via the host activity. We'll also build on what we learned from the previous recipe by including two different Activity Layouts-one for portrait and one for landscape. When in portrait mode, the activity will swap the Fragments as needed. Here is a screenshot of when the application first runs in portrait mode:</p>
<div><img src="img/61791176-99c3-4df2-abf1-952d0bf12877.png" style="width:20.42em;height:38.33em;"/></div>
<p>This is the screen showing the detail Fragment when you click on a country name:</p>
<div><img src="img/b9284ade-ae65-4094-95fa-e3daa5e4124d.png" style="width:23.58em;height:43.58em;"/></div>
<p>When in landscape, both Fragments will be side by side, as shown in the landscape screenshot:</p>
<div><img src="img/8b2e7654-2324-4dac-933b-62c32b833286.png" style="width:43.58em;height:23.00em;"/></div>
<p>Since the Master/Detail pattern generally involves a list for the master, we'll take advantage of <kbd>ListFragment</kbd> (mentioned in the <em>Creating and using a Fragment</em> section). When an item in the list is selected, the item text (country name in our example) will be sent to the detail Fragment via the host activity.</p>


            

            
        
    

        

                            
                    <h1 class="header-title">Getting ready</h1>
                
            
            
                
<p>Create a new project in Android Studio and call it <kbd>FragmentCommunication</kbd>. Use the default Phone &amp; Tablet option and select Empty Activity on the Add an Activity to Mobile dialog.</p>


            

            
        
    

        

                            
                    <h1 class="header-title">How to do it...</h1>
                
            
            
                
<p>To fully demonstrate working Fragments, we'll need to create two Fragments. The first Fragment will extend from <kbd>ListFragment</kbd> so it will not need a layout. We're going to go one step further by creating both portrait and landscape layouts for our Activity. For portrait mode, we'll swap Fragments and for landscape mode, we'll show both Fragments side by side.</p>
<p>When typing this code, Android Studio will offer two different library import options. Since the New Project Wizard automatically references the AppCompat library, we need to use the support library APIs instead of the framework APIs. Though very similar, the following code uses the support Fragment APIs.</p>
<p>Here are the steps, starting with the first Fragment:</p>
<ol>
<li>Create a new Java class called <kbd>MasterFragment</kbd> and change it so it extends <kbd>ListFragment</kbd> as shown:</li>
</ol>
<pre style="padding-left: 60px">public class MasterFragment extends ListFragment </pre>
<ul>
<li style="padding-left: 60px">Import from the following library:</li>
</ul>
<pre style="padding-left: 120px">android.support.v4.app.ListFragment </pre>
<ol start="2">
<li>Create the following interface inside the <kbd>MasterFragment</kbd> class:</li>
</ol>
<pre style="padding-left: 60px">public interface OnMasterSelectedListener {<br/>    public void onItemSelected(String countryName);<br/>}</pre>
<ol start="3">
<li>Set up the interface callback listener with the following code:</li>
</ol>
<pre style="padding-left: 60px">private OnMasterSelectedListener mOnMasterSelectedListener=null;<br/><br/>public void setOnMasterSelectedListener(OnMasterSelectedListener listener) {<br/>    mOnMasterSelectedListener=listener;<br/>}</pre>
<ol start="4">
<li>The last step for the <kbd>MasterFragment</kbd> is to create <kbd>ListAdapter</kbd> to populate <kbd>ListView</kbd>, which we do in the <kbd>onViewCreated()</kbd> method. When a country name is selected, we'll use <kbd>setOnItemClickListener()</kbd> to call our <kbd>OnMasterSelectedListener</kbd> interface with the following code:</li>
</ol>
<pre style="padding-left: 60px">public void onViewCreated(View view, Bundle savedInstanceState) {<br/>    super.onViewCreated(view, savedInstanceState);<br/><br/>    String[] countries = new String[]{"China", "France",<br/>            "Germany", "India", "Russia", "United Kingdom",<br/>            "United States"};<br/><br/>    ListAdapter countryAdapter = new ArrayAdapter&lt;String&gt;(<br/>            getActivity(), android.R.layout.simple_list_item_1,<br/>            countries);<br/><br/>    setListAdapter(countryAdapter);<br/><br/>    getListView().setChoiceMode(ListView.CHOICE_MODE_SINGLE);<br/><br/>    getListView().setOnItemClickListener(new AdapterView.OnItemClickListener() {<br/>        @Override<br/>        public void onItemClick(AdapterView&lt;?&gt; parent, View<br/>                view, int position, long id) {<br/>            if (mOnMasterSelectedListener != null) {<br/>                mOnMasterSelectedListener.onItemSelected(((<br/>                        TextView) view).getText().toString());<br/>            }<br/>        }<br/>    });<br/>}</pre>
<ol start="5">
<li>Next, we need to create <kbd>DetailFragment</kbd>, starting with the layout. Create a new layout file called <kbd>fragment_detail.xml</kbd> with the following XML:</li>
</ol>
<pre style="padding-left: 60px">&lt;?xml version="1.0" encoding="utf-8"?&gt;<br/>&lt;RelativeLayout<br/>    xmlns:android="http://schemas.android.com/apk/res/android"<br/>    android:layout_width="match_parent"<br/>    android:layout_height="match_parent"&gt;<br/>    &lt;TextView<br/>        android:id="@+id/textViewCountryName"<br/>        android:layout_width="wrap_content"<br/>        android:layout_height="wrap_content"<br/>        android:layout_centerVertical="true"<br/>        android:layout_centerHorizontal="true" /&gt;<br/>&lt;/RelativeLayout&gt;</pre>
<ol start="6">
<li>Create a new Java class called <kbd>DetailFragment</kbd> extending from <kbd>Fragment</kbd> as follows:</li>
</ol>
<pre style="padding-left: 60px">public class DetailFragment extends Fragment </pre>
<ul>
<li>Import from the following library:</li>
</ul>
<pre style="padding-left: 120px">android.support.v4.app.Fragment </pre>
<ol start="7">
<li>Add the following constant to the class:</li>
</ol>
<pre style="padding-left: 60px">public static String KEY_COUNTRY_NAME="KEY_COUNTRY_NAME"; </pre>
<ol start="8">
<li>Override <kbd>onCreateView()</kbd> as follows:</li>
</ol>
<pre style="padding-left: 60px">@Override<br/>public View onCreateView(LayoutInflater inflater, <br/>                         ViewGroup container, <br/>                         Bundle savedInstanceState) {<br/>    return inflater.inflate(R.layout.fragment_detail, container, false);<br/>}</pre>
<ol start="9">
<li>Code <kbd>onViewCreated()</kbd> as follows:</li>
</ol>
<pre style="padding-left: 60px">@Override<br/>public void onViewCreated(@NonNull View view, @Nullable Bundle savedInstanceState) {<br/>    super.onViewCreated(view, savedInstanceState);<br/><br/>    Bundle bundle = getArguments();<br/><br/>    if (bundle != null &amp;&amp; bundle.containsKey(KEY_COUNTRY_NAME)) {<br/>        showSelectedCountry(bundle.getString(KEY_COUNTRY_NAME));<br/>    }<br/>}</pre>
<ol start="10">
<li>The last step for this Fragment is to update <kbd>TextView</kbd> when we receive the selected country name. Add the following method to the class:</li>
</ol>
<pre style="padding-left: 60px">public void showSelectedCountry(String countryName) {<br/>    ((TextView)getView().findViewById(R.id.textViewCountryName)).setText(countryName);<br/>}</pre>
<ol start="11">
<li>The existing <kbd>activity_main.xml</kbd> layout will handle the portrait mode layout. Remove the existing <kbd>&lt;TextView&gt;</kbd> and replace with the following <kbd>&lt;FrameLayout&gt;</kbd>:</li>
</ol>
<pre style="padding-left: 60px">&lt;FrameLayout<br/>    android:id="@+id/frameLayout"<br/>    android:layout_width="match_parent"<br/>    android:layout_height="match_parent"<br/>    android:layout_marginTop="8dp"<br/>    app:layout_constraintBottom_toBottomOf="parent"<br/>    app:layout_constraintLeft_toLeftOf="parent"<br/>    app:layout_constraintRight_toRightOf="parent"<br/>    app:layout_constraintTop_toTopOf="parent" /&gt;</pre>
<ol start="12">
<li>For the landscape layout, create a new directory called <kbd>layout-land</kbd> in the <kbd>res</kbd> folder. The final result will be <kbd>res/layout-land</kbd>.</li>
</ol>
<p>If you do not see the new <kbd>res/layout-land</kbd> directory, change from Android view to project view.</p>
<ol start="13">
<li>Create a new <kbd>activity_main.xml</kbd> layout in <kbd>res/layout-land</kbd> as follows:</li>
</ol>
<pre style="padding-left: 60px">&lt;?xml version="1.0" encoding="utf-8"?&gt;<br/>&lt;LinearLayout xmlns:android="http://schemas.android.com/apk/res/android"<br/>    xmlns:tools="http://schemas.android.com/tools"<br/>    android:layout_width="match_parent"<br/>    android:layout_height="match_parent"<br/>    android:orientation="horizontal"&gt;<br/>    &lt;FrameLayout<br/>        android:id="@+id/frameLayoutMaster"<br/>        android:layout_width="0dp"<br/>        android:layout_weight="1"<br/>        android:layout_height="match_parent"/&gt;<br/>    &lt;FrameLayout<br/>        android:id="@+id/frameLayoutDetail"<br/>        android:layout_width="0dp"<br/>        android:layout_weight="1"<br/>        android:layout_height="match_parent"/&gt;<br/>&lt;/LinearLayout&gt;</pre>
<ol start="14">
<li>The final steps are to set up <kbd>MainActivity</kbd> to handle the Fragments. Open the <kbd>MainActivity.java</kbd> file and add the following class variable to track single/dual pane:</li>
</ol>
<pre style="padding-left: 60px">boolean mDualPane;</pre>
<ol start="15">
<li>Next, change <kbd>onCreate()</kbd> as follows:</li>
</ol>
<pre style="padding-left: 60px">@Override<br/>protected void onCreate(Bundle savedInstanceState) {<br/>    super.onCreate(savedInstanceState);<br/><br/>    setContentView(R.layout.activity_main);<br/><br/>    MasterFragment masterFragment = null;<br/>    FrameLayout frameLayout = findViewById(R.id.frameLayout);<br/>    if (frameLayout != null) {<br/>        mDualPane = false;<br/>        FragmentTransaction fragmentTransaction = getSupportFragmentManager().beginTransaction();<br/>        masterFragment = (MasterFragment) getSupportFragmentManager()<br/>                .findFragmentByTag("MASTER");<br/>        if (masterFragment == null) {<br/>            masterFragment = new MasterFragment();<br/>            fragmentTransaction.add(R.id.frameLayout, masterFragment, "MASTER");<br/>        }<br/>        DetailFragment detailFragment = (DetailFragment)<br/>                getSupportFragmentManager().findFragmentById(R.id.frameLayoutDetail);<br/>        if (detailFragment != null) {<br/>            fragmentTransaction.remove(detailFragment);<br/>        }<br/>        fragmentTransaction.commit();<br/>    } else {<br/>        mDualPane = true;<br/>        FragmentTransaction fragmentTransaction = getSupportFragmentManager().beginTransaction();<br/>        masterFragment = (MasterFragment) getSupportFragmentManager()<br/>                .findFragmentById(R.id.frameLayoutMaster);<br/>        if (masterFragment == null) {<br/>            masterFragment = new MasterFragment();<br/>            fragmentTransaction.add(R.id.frameLayoutMaster, masterFragment);<br/>        }<br/>        DetailFragment detailFragment = (DetailFragment) getSupportFragmentManager()<br/>                .findFragmentById(R.id.frameLayoutDetail);<br/>        if (detailFragment == null) {<br/>            detailFragment = new DetailFragment();<br/>            fragmentTransaction.add(R.id.frameLayoutDetail, detailFragment);<br/>        }<br/>        fragmentTransaction.commit();<br/>    }<br/>    masterFragment.setOnMasterSelectedListener(new MasterFragment.OnMasterSelectedListener() {<br/>        @Override<br/>        public void onItemSelected(String countryName) {<br/>            sendCountryName(countryName);<br/>        }<br/>    });<br/>}</pre>
<ol start="16">
<li>The last code to add is the <kbd>sendCountryName()</kbd> method, which handles sending the country name to <kbd>DetailFragment</kbd>:</li>
</ol>
<pre style="padding-left: 60px">private void sendCountryName(String countryName) {<br/>    DetailFragment detailFragment;<br/>    if (mDualPane) {<br/>        //Two pane layout<br/>        detailFragment = (DetailFragment) getSupportFragmentManager().findFragmentById(R.id.frameLayoutDetail);<br/>        detailFragment.showSelectedCountry(countryName);<br/>    } else {<br/>        // Single pane layout<br/>        detailFragment = new DetailFragment();<br/>        Bundle bundle = new Bundle();<br/>        bundle.putString(DetailFragment.KEY_COUNTRY_NAME, countryName);<br/>        detailFragment.setArguments(bundle);<br/>        FragmentTransaction fragmentTransaction = getSupportFragmentManager().beginTransaction();<br/>        fragmentTransaction.replace(R.id.frameLayout, detailFragment);<br/>        fragmentTransaction.addToBackStack(null);<br/>        fragmentTransaction.commit();<br/>    }<br/>}</pre>
<ol start="17">
<li>Run the program on a device or emulator.</li>
</ol>


            

            
        
    

        

                            
                    <h1 class="header-title">How it works...</h1>
                
            
            
                
<p>We start by creating <kbd>MasterFragment</kbd>. In the Master/Detail pattern we are using, this usually represents a list, so we create a list by extending <kbd>ListFragment</kbd>. <kbd>ListFragment</kbd> is the Fragment equivalent of <kbd>ListActivity</kbd>. Other than extending from a Fragment, it's basically the same.</p>
<p>As stated in the recipe introduction, we shouldn't attempt to communicate directly with other Fragments.</p>
<p>To provide a means to communicate the list item selection, we expose the interface: <kbd>OnMasterSelectedListener</kbd>. We call <kbd>onItemSelected()</kbd> every time an item is selected in the list.</p>
<p>Most of the work for passing data between Fragments is done in the host activity but, ultimately, the receiving Fragment needs a way to receive the data. <kbd>DetailFragment</kbd> supports this in two ways:</p>
<ul>
<li>Passing the country name in the argument bundle, available at creation time</li>
<li>A public method for the activity to call directly.</li>
</ul>
<p>When the activity creates the Fragment, it also creates a bundle to hold the data we want to send. Here we add the country name using <kbd>KEY_COUNTRY_NAME</kbd> defined in step 7. We retrieve this bundle with <kbd>getArguments()</kbd> in <kbd>onViewCreated()</kbd>. If the key is found in the bundle, it is extracted and displayed using the <kbd>showSelectedCountry()</kbd> method. This is the same method the activity will call directly if the Fragment is already visible (in the two-panel layout).</p>
<p>Most of the work for this recipe is in the activity. We created two layouts: one for portrait and one for landscape. When in landscape orientation, Android will choose the landscape layout from the <kbd>res/layout-land</kbd> directory created in step 12. Both layouts use a <kbd>&lt;FrameLayout&gt;</kbd> placeholder, similar to the previous exercise. We manage the Fragments in both <kbd>onCreate()</kbd> and <kbd>sendCountryName()</kbd>.</p>
<p>In <kbd>onCreate()</kbd>, we set the <kbd>mDualPane</kbd> flag by checking whether the current layout includes the <kbd>frameLayout</kbd> view. If <kbd>frameLayout</kbd> is found (meaning it's not null), then we have only a single panel because <kbd>frameLayout</kbd> is only defined in the portrait layout. If <kbd>frameLayout</kbd> is not found, then we have two <kbd>&lt;FrameLayout&gt;</kbd> elements instead: one for <kbd>MasterFragment</kbd> and another for <kbd>DetailFragment</kbd>.</p>
<p>The last thing we do in <kbd>onCreate()</kbd> is to set up the <kbd>MasterFragment</kbd> listener by creating an anonymous callback, which passes the country name to the <kbd>sendCountryName()</kbd> method. The <kbd>sendCountryName()</kbd> method is where the data is actually passed to <kbd>DetailFragment</kbd>. If we are in portrait (or single-pane) mode, we need to create <kbd>DetailFragment</kbd> and replace the existing <kbd>MasterFragment</kbd>. This is where we create the bundle with the country name and call <kbd>setArguments()</kbd>. Notice how we call <kbd>addToBackStack()</kbd> before committing the transaction? This allows the back key to bring the user back to the list (<kbd>MasterFragment</kbd>). If we are in landscape mode, <kbd>DetailFragment</kbd> is already visible so we call the <kbd>howSelectedCountry()</kbd> public method directly.</p>


            

            
        
    

        

                            
                    <h1 class="header-title">There's more...</h1>
                
            
            
                
<p>In <kbd>MasterFragment</kbd>, before sending the <kbd>onItemSelected()</kbd> event, we check to make sure the listener is not null with the following code:</p>
<pre>if (mOnMasterSelectedListener != null) </pre>
<p>Though it's the job of the activity to set up the callback to receive the events, we don't want this code to crash if there's no listener. An alternative approach would be to verify the activity extends our interface in the Fragment's <kbd>onAttach()</kbd> callback.</p>
<p>The objective for this recipe was to demonstrate the proper pattern for communicating between fragments (by using an interface) and how to pass data. We used the <kbd>ListView</kbd> fragment because it made typing this example easier, but for real-world applications, it's probably better to use <kbd>RecyclerView</kbd>. <kbd>RecyclerView</kbd> does not have a pre-made <kbd>Fragment</kbd> class (or <kbd>Activity</kbd> class) so you need to roll your own but it's no different than the examples shown in earlier chapters.</p>


            

            
        
    

        

                            
                    <h1 class="header-title">See also</h1>
                
            
            
                
<ul>
<li>For <kbd>RecyclerView</kbd> examples, refer to the <em>RecyclerView replaces ListView</em> section in <a href="0b95f21f-496a-48ca-900c-32d887d3a3fe.xhtml" target="_blank">Chapter 2</a>, <em>Layouts</em> and the <em>Using Contextual Batch Mode with RecyclerView</em> section in <a href="271b832c-648f-4a10-967e-aac99272e9a9.xhtml" target="_blank">Chapter 4</a>, <em>Menus and Action Mode</em>.</li>
<li>For more information on resource directories, see the <em>Selecting themes based on the Android version</em> section in <a href="3adebbef-b8f1-41ca-ba6c-c56329c9ea53.xhtml" target="_blank">Chapter 3</a>, <em>Views, Widgets, and Styles</em>.</li>
</ul>


            

            
        
    

        

                            
                    <h1 class="header-title">Handling the Fragment back stack</h1>
                
            
            
                
<p>In several of the previous recipes, it was mentioned that you should call the <kbd>addToBackStack()</kbd> method in the Fragment transaction to enable Android to maintain a Fragment back stack. This is the first step, but may not be enough to provide a rich user experience. In this recipe, we'll explore two other callbacks: <kbd>onBackPressed()</kbd> and <kbd>onBackStackChanged()</kbd>. As you'll see, by implementing these callbacks, your application can provide specific behavior for the Fragment back stack. The <kbd>onBackPressed()</kbd> callback allows the app to check the back stack state and provide custom behavior, such as closing the app when appropriate.</p>
<p>The <kbd>onBackStackChanged()</kbd> callback is called whenever the actual back stack changes - such as when a Fragment is popped from the back stack. By overriding this callback, your app can check the current Fragment and update the UI (such as the <em>Home</em> key back arrow) as appropriate.</p>


            

            
        
    

        

                            
                    <h1 class="header-title">Getting ready</h1>
                
            
            
                
<p>Create a new project in Android Studio and call it <kbd>FragmentBackStack</kbd>. Use the default Phone &amp; Tablet option and select Empty Activity on the Add an Activity to Mobile dialog.</p>


            

            
        
    

        

                            
                    <h1 class="header-title">How to do it...</h1>
                
            
            
                
<p>To demonstrate handling the Fragment back stack, we'll create two fragments with a Next button to create a back stack. With that setup, we'll implement the <kbd>onBackPressed()</kbd> callback to exit the app when the user reaches the top Fragment. We'll be using the Fragment Manager from the support library, so be sure to choose the support library version when prompted for the import library. We'll need two layout files - one for each fragment - along with two fragment classes. Here are the steps in detail:</p>
<ol>
<li>Create a new layout file called <kbd>fragment_one.xml</kbd> with the following XML:</li>
</ol>
<pre style="padding-left: 60px">&lt;?xml version="1.0" encoding="utf-8"?&gt;<br/>&lt;RelativeLayout xmlns:android="http://schemas.android.com/apk/res/android"<br/>    android:layout_height="match_parent"<br/>    android:layout_width="match_parent"&gt;<br/>    &lt;TextView<br/>        android:id="@+id/textView"<br/>        android:layout_width="wrap_content"<br/>        android:layout_height="wrap_content"<br/>        android:text="Fragment One"<br/>        android:layout_centerVertical="true"<br/>        android:layout_centerHorizontal="true" /&gt;<br/>&lt;/RelativeLayout&gt;</pre>
<ol start="2">
<li>Create the second fragment layout file called <kbd>fragment_two.xml</kbd> with the same XML as above, changing the following text property:</li>
</ol>
<pre style="padding-left: 60px">android:text="Fragment Two"</pre>
<ol start="3">
<li>With the layout files created, it's time to create the classes for the fragments. Create a new Java class called <kbd>FragmentOne.java</kbd> with the following code:</li>
</ol>
<pre style="padding-left: 60px">public class FragmentOne extends Fragment {<br/>    @Override<br/>    public View onCreateView(LayoutInflater inflater,<br/>                             ViewGroup container, Bundle savedInstanceState) {<br/>        return inflater.inflate(R.layout.fragment_one,<br/>                container, false);<br/>    }<br/>} </pre>
<ol start="4">
<li>Create the second Java class called <kbd>FragmentTwo</kbd> with the following code:</li>
</ol>
<pre style="padding-left: 60px">public class FragmentTwo extends Fragment {<br/>    @Override<br/>    public View onCreateView(LayoutInflater inflater,<br/>                             ViewGroup container, Bundle savedInstanceState) {<br/>        return inflater.inflate(R.layout.fragment_two,<br/>                container, false);<br/>    }<br/>}</pre>
<ol start="5">
<li>Now we need to add a container and a button to the Main Activity layout. Change <kbd>activity_main.xml</kbd> as follows:</li>
</ol>
<pre style="padding-left: 60px">&lt;?xml version="1.0" encoding="utf-8"?&gt;<br/>&lt;RelativeLayout xmlns:android="http://schemas.android.com/apk/res/android"<br/>    android:layout_width="match_parent"<br/>    android:layout_height="match_parent"&gt;<br/>    &lt;FrameLayout<br/>        android:id="@+id/frameLayout"<br/>        android:layout_width="match_parent"<br/>        android:layout_height="wrap_content"<br/>        android:layout_above="@+id/buttonNext"<br/>        android:layout_alignParentTop="true"&gt;<br/>    &lt;/FrameLayout&gt;<br/>    &lt;Button<br/>        android:id="@+id/buttonNext"<br/>        android:layout_width="wrap_content"<br/>        android:layout_height="wrap_content"<br/>        android:text="Next"<br/>        android:layout_alignParentBottom="true"<br/>        android:layout_centerInParent="true"/&gt;<br/>&lt;/RelativeLayout&gt;</pre>
<ol start="6">
<li>With the Fragments created and the container added to the layout, we are now ready to write the code to manipulate the Fragments. Open <kbd>MainActivity.java</kbd> and add the following code below the class constructor:</li>
</ol>
<pre style="padding-left: 60px">Button mButtonNext;</pre>
<ol start="7">
<li>Add the following code to the existing <kbd>onCreate() </kbd>method, below <kbd>setContentView()</kbd>:</li>
</ol>
<pre style="padding-left: 60px">mButtonNext = findViewById(R.id.buttonNext);<br/>mButtonNext.setOnClickListener(new View.OnClickListener() {<br/>    @Override<br/>    public void onClick(View view) {<br/>        FragmentManager fragmentManager = getSupportFragmentManager();<br/>        FragmentTransaction fragmentTransaction =<br/>                fragmentManager.beginTransaction();<br/>        fragmentTransaction.replace(R.id.frameLayout,  new FragmentTwo());<br/>        fragmentTransaction.addToBackStack(null);<br/>        fragmentTransaction.commit();<br/>        mButtonNext.setVisibility(View.INVISIBLE);<br/>    }<br/>});<br/><br/>FragmentManager fragmentManager = getSupportFragmentManager();<br/>FragmentTransaction fragmentTransaction =<br/>        fragmentManager.beginTransaction();<br/>fragmentTransaction.add(R.id.frameLayout,  new FragmentOne());<br/>fragmentTransaction.addToBackStack(null);<br/>fragmentTransaction.commit();</pre>
<ol start="8">
<li>The last method to implement is the <kbd>onBackPressed()</kbd> callback:</li>
</ol>
<pre style="padding-left: 60px">@Override<br/>public void onBackPressed() {<br/>    if(getSupportFragmentManager().getBackStackEntryCount() == 2 ) {<br/>        super.onBackPressed();<br/>        mButtonNext.setVisibility(View.VISIBLE);<br/>    } else {<br/>        finish();<br/>    }<br/>}</pre>
<ol start="9">
<li>Run the program on a device or emulator.</li>
</ol>


            

            
        
    

        

                            
                    <h1 class="header-title">How it works...</h1>
                
            
            
                
<p>Most of the steps are similar to the <em>Adding and removing Fragments during runtime </em>recipe discussed previously, until step 8. The first seven steps just set up the app to create the fragments for our demonstration. In step 8, we implement the <kbd>onBackPressed()</kbd> callback. This is where we code for our specific situation. For this sample, all we need to do is make the Next button visible again.</p>


            

            
        
    

        

                            
                    <h1 class="header-title">There's more...</h1>
                
            
            
                
<p>With the basics covered for handling the back stack, it's time to discuss the other callback: <kbd>onBackStackChanged()</kbd>. This is where you can implement custom behavior when the stack changes. One common example is changing the Home icon to a back arrow. We get this behavior automatically with an Activity when we set the parent property (in AndroidManifest), but Android doesn't do this for fragments. What if we wanted to have a back arrow on <kbd>FragmentTwo</kbd>? Add this line of code to the NextButton <kbd>onClick()</kbd>:</p>
<pre>getSupportActionBar().setDisplayHomeAsUpEnabled(true);</pre>
<p>If you run the app now, you'll see the back arrow when you go to <kbd>FragmentTwo</kbd>. The problem is, the back arrow doesn't actually do anything. The next problem you may notice is that if you use the back key, you still see the back arrow when you return to <kbd>FragmentOne</kbd>.</p>
<p>To make the back arrow work, add the following code to <kbd>MainActivity</kbd>:</p>
<pre>@Override<br/>public boolean onOptionsItemSelected(MenuItem menuItem) {<br/>    if (menuItem.getItemId() == android.R.id.home) {<br/>            onBackPressed();<br/>            return true;<br/>    } else {<br/>        return super.onOptionsItemSelected(menuItem);<br/>    }<br/>}</pre>
<p>Now the app will respond to the back arrow and treat it the same as the back key. What about the second issue? The Home icon still shows the back arrow. This is where we can use the <kbd>onBackStackChanged()</kbd> callback. Instead of modifying the NextButton <kbd>onClick()</kbd> as we did earlier, we can put all our code in <kbd>onBackStackChanged()</kbd>.</p>
<p>To do this, we need to implement the <kbd>OnBackStackChangedListener</kbd> interface in the class definition. Change the <kbd>MainActivity</kbd> declaration as follows:</p>
<pre>public class MainActivity extends AppCompatActivity<br/>        implements FragmentManager.OnBackStackChangedListener {</pre>
<p>Then add this line to the <kbd>onCreate()</kbd> method (below <kbd>setContentView()</kbd>) to add the listener:</p>
<pre>getSupportFragmentManager().addOnBackStackChangedListener(this);</pre>
<p>Now we can implement the <kbd>onBackStackChanged()</kbd> callback:</p>
<pre>@Override<br/>public void onBackStackChanged() {<br/>    Fragment fragment = getSupportFragmentManager().findFragmentById(R.id.frameLayout);<br/>    if (fragment instanceof FragmentOne) {<br/>        getSupportActionBar().setDisplayHomeAsUpEnabled(false);<br/>    } else if (fragment instanceof FragmentTwo) {<br/>        getSupportActionBar().setDisplayHomeAsUpEnabled(true);<br/>    }<br/>}</pre>
<p>Now when you run the app, you'll see the back arrow when you go to <kbd>FragmentTwo</kbd>. You can press the back arrow icon or use the back key to return to the first screen. Thanks to the <kbd>onBackStackChanged()</kbd> callback, you won't see the back arrow when you're on <kbd>FragmentOne</kbd>.</p>


            

            
        
    </body></html>