<html><head></head><body>
        <section>

                            <header>
                    <h1 class="header-title">Using a Platform to Power Flutter Apps</h1>
                </header>
            
            <article>
                
<p>With the use of Flutter, you can build for both Android as well as iOS. It uses the Dart programming language to do so. However, Dart does not compile to Android's Dalvik bytecode or Objective C bindings on iOS. This indicates that Dart code, by default, does not have direct access to platform-specific APIs. </p>
<p>Here are a few sets of examples where deeper integration with the host environment might be needed:</p>
<ul>
<li>Applications using camera capabilities and geo-tagging features </li>
<li class="mce-root">Reading device information, such as an OS version and device specifications</li>
<li class="mce-root">Reading folders and files from the device </li>
<li class="mce-root">Pushing notifications to the app  </li>
<li class="mce-root"><span>Sharing information with other applications</span></li>
<li class="mce-root">Location tracking</li>
<li class="mce-root">Using sensors</li>
<li class="mce-root">Using persisted preferences</li>
</ul>
<p>The list continues as per the support provided by the environment. Using Flutter, enabling the calling of platform-specific APIs, which are available in Java/Kotlin code on Android, Objective C, or Swift on iOS, is not a difficult task.</p>
<p>In this chapter, we will learn how to include packages, followed by learning how to make platform-specific calls. We will learn about how to publish our own plugins. </p>
<p>We will cover the following topics in this chapter:</p>
<ul>
<li class="h1">Using Flutter packages</li>
<li class="h1">Using platform channels</li>
<li class="h1">Building and publishing your own plugin</li>
</ul>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Using Flutter packages</h1>
                </header>
            
            <article>
                
<p>Flutter's package website lists many packages that help us develop applications faster by avoiding the need for developing some features from scratch. These packages are either contributed to by the Flutter team or by developers across the globe who contribute to the Flutter and Dart ecosystems. You can either use the existing packages by visiting the publishing site (<a href="https://pub.dartlang.org/" target="_blank">https://pub.dartlang.org/</a><a href="https://pub.dartlang.org/" target="_blank">https://pub.dartlang.org/</a>), or you can develop and publish your own packages. We will learn about building our own packages in the <em>Building your own packages</em> section of this chapter. </p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Searching for the package</h1>
                </header>
            
            <article>
                
<p>Visit the publishing site to search for the packages you want to use in your app. The home page displays some of the popular packages that are used by developers. You can search by keyword to display the results. You may want to look at the weighted score before you opt to choose a plugin. Searching for either <kbd>email:@dartlang.org</kbd> or <kbd>email:flutter-dev@googlegroups.com</kbd> will give the results of the official Flutter packages:</p>
<p class="CDPAlignCenter CDPAlign"><img class="aligncenter size-full wp-image-440 image-border" src="assets/4a066a6e-6a1e-4f4d-b340-f7329bddc936.png" style="width:60.17em;height:39.67em;"/></p>
<p>Clicking on any of the result items will open the extended preview for the package. In this case, we are using the <span class="packt_screen">url_launcher</span> package, which is an official Dart package that was developed by the Flutter team. This plugin is used for launching a URL on a mobile platform such as Android and iOS-supporting web, phone, SMS, and email schemes:</p>
<p class="CDPAlignCenter CDPAlign"><img class="aligncenter size-full wp-image-441 image-border" src="assets/22b672b7-c6e0-4aa6-a533-67688df7d9a5.png" style="width:62.42em;height:40.00em;"/></p>
<p>When you click on any of the packages, you will see the name of the plugin, along with its latest version and its published date. Following that, you will find five tab options, namely the following: </p>
<ul>
<li><kbd>README.md</kbd>: Detailed information about the plugin</li>
<li><kbd>CHANGELOG.md</kbd>: Information on the Changelog versions of this plugin with details of each plugin version</li>
<li><kbd>Example</kbd>: Demonstrates how to use the plugin</li>
<li><kbd>Installing</kbd>: Shows the steps to follow to set up the plugin</li>
<li><kbd>Versions</kbd>: Shows the different versions of the plugin, along with the following options: <kbd>Version</kbd> name ( such as 5.0.1<em>),</em> <kbd>Uploaded</kbd> date (such as Feb 8, 2019), <kbd>Documentation</kbd>, and <kbd>Archive</kbd></li>
</ul>
<p>The Flutter plugin for launching a URL on Android and iOS supports web, phone, SMS, and email schemes.</p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Adding a package dependency to an app</h1>
                </header>
            
            <article>
                
<p>Once you have decided on the package you want to use, you have to make the program depend on it. In this case, we are using the <kbd>url_launcher 5.0.1</kbd> package:</p>
<ol>
<li>Open the <kbd>pubspec.yaml</kbd> file located inside your <kbd>app</kbd> folder.</li>
<li>Check out the <span class="packt_screen">Installing</span> tab on the package's page, and where you will have the option of adding dependencies. In this example, we are adding<span> </span><kbd><span class="hljs-attr">url_launcher:</span> <span class="hljs-string">^5.0.1</span></kbd> <span class="hljs-string">under dependencies.</span></li>
<li class="mce-root"><span>Next, from the Terminal, run the following command, which will install packages from the command line:</span></li>
</ol>
<pre style="color: black;padding-left: 60px"><strong>flutter packages get</strong></pre>
<p class="mce-root" style="padding-left: 60px"><span>If you are using an editor such as </span><span>Android Studio/IntelliJ, click <span class="packt_screen">Packages</span></span> <span class="packt_screen">get</span><span> on the top of <kbd>pubspec.yaml</kbd>. In the case of VS code, click <strong><span class="packt_screen">Get Packages</span></strong> at the top of <kbd>Pubspec<strong>.</strong>yaml</kbd></span>:</p>
<p class="CDPAlignCenter CDPAlign"><img class="aligncenter size-full wp-image-442 image-border" src="assets/6ac349c1-8717-4282-9fe6-4b3a9b49545a.png" style="width:71.58em;height:25.67em;"/></p>
<ol start="4">
<li>The next step is to add the correspondent <kbd>import</kbd> snippet to your Dart code:</li>
</ol>
<pre style="padding-left: 60px">import 'package:url_launcher/url_launcher.dart';</pre>
<p>If you want to upgrade to a new version of the package, use the <span class="packt_screen">Packages upgrade</span> option. It could be used in the case where there are new features available in that package you wish to include in the project. In the case of IntelliJ, the option to choose is <span class="packt_screen">Upgrade dependencies</span>. </p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Ways to specify package dependencies</h1>
                </header>
            
            <article>
                
<p>There are two ways to specify package dependencies. As we discussed earlier, the package is added to <kbd>pubspec.yaml</kbd> using the shorthand form <kbd>plugin1:</kbd>. This means <strong><kbd>plugin1:any_version</kbd>. </strong>As a developer, you can always look at <kbd>CHANGELOG.md</kbd> or the recent version of the package's name to add the correct value. To ensure an app does not break, it is essential to specify a version, which can be done in one of two ways:</p>
<ol>
<li>Specify the version using range constraints, as follows, in which you specify the minimum and maximum versions:</li>
</ol>
<pre style="padding-left: 60px">dependencies: <br/>url_launcher: '&gt;=0.4.1 &lt;5.0.1'</pre>
<ol start="2">
<li>Range constraints using <kbd>Carat Syntax</kbd>:</li>
</ol>
<pre style="padding-left: 60px">dependencies:<br/>url_launcher: '^5.0.1'</pre>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Adding the code to the file </h1>
                </header>
            
            <article>
                
<p>Most of the packages give insights on how to include the package components into the code. <span>The package's</span> <span class="packt_screen">Example</span><span> tab has more information about the code's execution. </span>In our example, we are using one gradient button to open the URL specified in the code:</p>
<pre><span>import </span><span>'package:flutter/material.dart'</span><span>;<br/></span><span>import </span><span>'package:url_launcher/url_launcher.dart'</span><span>;<br/></span><span><br/></span><span>void </span><span>main</span>() =&gt; runApp(<span>MyApp</span>())<span>;</span><span><br/></span><span><br/></span><span>class </span>MyApp <span>extends </span>StatelessWidget {<br/>  <span>@override<br/></span><span><br/></span><span>  </span>Widget <span>build</span>(BuildContext context) {<br/>    <span>return </span><span>MaterialApp</span>(<br/>      title: <span>'Flutter Packages'</span><span>,<br/></span><span>      </span>theme: <span>ThemeData</span>(<br/>        primarySwatch: Colors.<span>deepOrange</span><span>,<br/></span><span>      </span>)<span>,<br/></span><span>      </span>home: <span>MyStatelessWidget</span>()<span>,<br/></span><span>    </span>)<span>;<br/></span><span>  </span>}<br/>}<br/><br/><span>class </span>MyStatelessWidget <span>extends </span>StatelessWidget {<br/>  MyStatelessWidget({Key key}) : <span>super</span>(key: key)<span>;<br/></span><span><br/></span><span>  </span><span>@override<br/></span><span>  </span>Widget <span>build</span>(BuildContext context) {<br/>    <span>return </span><span>Scaffold</span>(<br/>      appBar: <span>AppBar</span>(<br/>        title: <span>const </span><span>Text</span>(<span>'Packages in Flutter'</span>)<span>,<br/></span><span>      </span>)<span>,<br/></span><span>      </span>body: <span>Center</span>(<br/>        child: <span>Column</span>(<br/>          mainAxisSize: MainAxisSize.<span>min</span><span>,<br/></span><span>          </span>children: &lt;Widget&gt;[<br/><br/>            <span>RaisedButton</span>(<br/>              onPressed: _initiateURL<span>,<br/></span><span>              </span>textColor: Colors.<span>black</span><span>,<br/></span><span>              </span>padding: <span>const </span><span>EdgeInsets</span>.<span>all</span>(<span>0.0</span>)<span>,<br/></span><span>              </span>child: <span>Container</span>(<br/>                decoration: <span>const </span><span>BoxDecoration</span>(<br/>                  gradient: <span>LinearGradient</span>(<br/>                    colors: &lt;Color&gt;[<br/>                      Colors.<span>green</span><span>, </span>Colors.<span>yellow</span><span>, </span>Colors.<span>yellowAccent</span>]<span>,<br/></span><span><br/></span><span>                  </span>)<span>,<br/></span><span>                </span>)<span>,<br/></span><span><br/></span><span>                </span>padding: <span>const </span><span>EdgeInsets</span>.<span>all</span>(<span>10.0</span>)<span>,<br/></span><span>                </span>child: <span>Text</span>(<span>'Open Flutter Website'</span>)<span>,<br/></span><span>              </span>)<span>,<br/></span><span>            </span>)<span>,<br/></span><span>          </span>]<span>,<br/></span><span>        </span>)<span>,<br/></span><span>      </span>)<span>,<br/></span><span>    </span>)<span>;<br/></span><span><br/></span><span>  </span>}<br/><br/>  <span>_initiateURL</span>() <span>async </span>{<br/>    <span>const </span>url = <span>'https://flutter.dev'</span><span>;<br/></span><span>    </span><span>if </span>(<span>await </span>canLaunch(url)) {<br/>      <span>await </span>launch(url)<span>;<br/></span><span>    </span>} <span>else </span>{<br/>      <span>throw </span><span>'Sorry, We could not launch the URL </span>$url<span>'</span><span>;<br/></span><span>    </span>}<br/>  }<br/><br/>}</pre>
<p>The previous code allows users to simply click on the button and open the Flutter Dev official website. As you may have noticed, we use the <kbd>RaisedButton</kbd> widget and specify the child property, which allows us to provide gradient to the button. The <kbd>_initiateURL()</kbd> method has a launch function that accepts the URL defined and acts to parse the specified URL. It also delegates the handling to the underlying system:</p>
<p class="CDPAlignCenter CDPAlign"><img class="aligncenter size-full wp-image-443 image-border" src="assets/ce0f917b-a2bf-4812-a7c9-06356f3c1b63.png" style="width:19.58em;height:37.92em;"/></p>
<p class="CDPAlignLeft CDPAlign"><span>Once you have successfully executed the code and clicked on the button, <span class="packt_screen">Open Flutter Website</span> will open the URL specified in the parameter URL. You will see the result on the screen on the phone's default browser, as follows: </span></p>
<p class="CDPAlignCenter CDPAlign"><img class="aligncenter size-full wp-image-444 image-border" src="assets/6b254ffb-7c7c-449f-b205-8ee9dc8d353a.png" style="width:16.33em;height:31.58em;"/></p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Using platform channels</h1>
                </header>
            
            <article>
                
<p>As mentioned at the start of the chapter, Flutter is a cross-platform framework, and in order to get access to native APIs, you have to get access to native platform functions. In the case of Flutter, it does this by creating a platform channel to the native platform. Using these platform channels, the developers can call the native functions such as device information, files and folder access, sensor access, camera, shared preferences, and much more.  </p>
<p>As shown in the following screenshot, platform channels can be simply imagined to be a communicating mechanism between your Dart code in Flutter and the platform-specific code of your host app. This ensures that the host services are invoked by Flutter's Dart code:</p>
<p class="CDPAlignCenter CDPAlign"><img class="aligncenter size-full wp-image-445 image-border" src="assets/8590f163-d1d7-428e-9d6a-6915d4b8edcc.png" style="width:23.67em;height:18.67em;"/></p>
<p>At this point, it is worth noting that you have to set a platform channel for each platform. In the case of Android, they are called <kbd>MethodChannels</kbd> and in iOS, they are known as <kbd>FlutterMethodChannels</kbd><strong>. </strong></p>
<p>At this point, it is important to know the platform data type support and codecs. The standard platform channels adopt a standard message codec that supports efficient binary serialization. They are JSON-lookalike. When you send values to and from them, the serialization and deserialization happen automatically. </p>
<p>The Flutter team at Google has listed (source: <a href="https://flutter.dev/docs/development/platform-integration/platform-channels" target="_blank">https://flutter.dev/docs/development/platform-integration/platform-channels</a>) the following table, which shows how Dart values are received on the host platform side, and vice versa:</p>
<table border="1" style="border-collapse: collapse;width: 100%">
<tbody>
<tr>
<td class="CDPAlignCenter CDPAlign" style="width: 17%"><strong>Dart</strong></td>
<td class="CDPAlignCenter CDPAlign" style="width: 41.9685%"><strong>Android</strong></td>
<td class="CDPAlignCenter CDPAlign" style="width: 38.0315%">
<p class="mce-root"><strong>                                           iOS</strong></p>
</td>
</tr>
<tr>
<td class="CDPAlignCenter CDPAlign" style="width: 17%"><kbd><span>null</span></kbd></td>
<td class="CDPAlignCenter CDPAlign" style="width: 41.9685%"><kbd><span>null</span></kbd></td>
<td class="CDPAlignCenter CDPAlign" style="width: 38.0315%">
<p class="mce-root">                      <kbd>nil</kbd> (NSNull when nested)</p>
</td>
</tr>
<tr>
<td class="CDPAlignCenter CDPAlign" style="width: 17%"><kbd><span>bool</span></kbd></td>
<td class="CDPAlignCenter CDPAlign" style="width: 41.9685%"><kbd>java.lang.Boolean</kbd></td>
<td class="CDPAlignCenter CDPAlign" style="width: 38.0315%"><kbd>NSNumber numberWithBool:</kbd></td>
</tr>
<tr>
<td class="CDPAlignCenter CDPAlign" style="width: 17%"><kbd><span>int</span></kbd></td>
<td class="CDPAlignCenter CDPAlign" style="width: 41.9685%"><kbd>java.lang.Integer</kbd></td>
<td class="CDPAlignCenter CDPAlign" style="width: 38.0315%"><kbd>NSNumber numberWithInt:</kbd></td>
</tr>
<tr>
<td class="CDPAlignCenter CDPAlign" style="width: 17%"><kbd>int</kbd>, <kbd>if 32 bits</kbd>, <kbd>not enough</kbd></td>
<td class="CDPAlignCenter CDPAlign" style="width: 41.9685%"><kbd>java.lang.Long</kbd></td>
<td class="CDPAlignCenter CDPAlign" style="width: 38.0315%"><kbd>NSNumber numberWithLong:</kbd></td>
</tr>
<tr>
<td class="CDPAlignCenter CDPAlign" style="width: 17%"><kbd>double</kbd></td>
<td class="CDPAlignCenter CDPAlign" style="width: 41.9685%"><kbd>java.lang.Double</kbd></td>
<td class="CDPAlignCenter CDPAlign" style="width: 38.0315%"><kbd>NSNumber numberWithDouble:</kbd></td>
</tr>
<tr>
<td class="CDPAlignCenter CDPAlign" style="width: 17%"><kbd>String</kbd></td>
<td class="CDPAlignCenter CDPAlign" style="width: 41.9685%"><kbd>java.lang.String</kbd></td>
<td class="CDPAlignCenter CDPAlign" style="width: 38.0315%"><kbd>NSString</kbd></td>
</tr>
<tr>
<td class="CDPAlignCenter CDPAlign" style="width: 17%"><kbd>Uint8List</kbd></td>
<td class="CDPAlignCenter CDPAlign" style="width: 41.9685%"><kbd>byte[]</kbd></td>
<td class="CDPAlignCenter CDPAlign" style="width: 38.0315%"><kbd>FlutterStandardTypedData typedDataWithBytes:</kbd></td>
</tr>
<tr>
<td class="CDPAlignCenter CDPAlign" style="width: 17%"><kbd>Int32List</kbd></td>
<td class="CDPAlignCenter CDPAlign" style="width: 41.9685%"><kbd>int[]</kbd></td>
<td class="CDPAlignCenter CDPAlign" style="width: 38.0315%"><kbd>FlutterStandardTypedData typedDataWithInt32:</kbd></td>
</tr>
<tr>
<td class="CDPAlignCenter CDPAlign" style="width: 17%"><kbd>Int64List</kbd></td>
<td class="CDPAlignCenter CDPAlign" style="width: 41.9685%"><kbd>long[]</kbd></td>
<td class="CDPAlignCenter CDPAlign" style="width: 38.0315%"><kbd>FlutterStandardTypedData typedDataWithInt64:</kbd></td>
</tr>
<tr>
<td class="CDPAlignCenter CDPAlign" style="width: 17%"><kbd>Float64List</kbd></td>
<td class="CDPAlignCenter CDPAlign" style="width: 41.9685%"><kbd>double[]</kbd></td>
<td class="CDPAlignCenter CDPAlign" style="width: 38.0315%"><kbd>FlutterStandardTypedData typedDataWithFloat64:</kbd></td>
</tr>
<tr>
<td class="CDPAlignCenter CDPAlign" style="width: 17%"><kbd>List</kbd></td>
<td class="CDPAlignCenter CDPAlign" style="width: 41.9685%"><kbd>java.util.ArrayList</kbd></td>
<td class="CDPAlignCenter CDPAlign" style="width: 38.0315%"><kbd><span>NSArray</span></kbd></td>
</tr>
<tr>
<td class="CDPAlignCenter CDPAlign" style="width: 17%"><kbd>Map</kbd></td>
<td class="CDPAlignCenter CDPAlign" style="width: 41.9685%"><kbd>java.util.HashMap</kbd></td>
<td class="CDPAlignCenter CDPAlign" style="width: 38.0315%"><kbd><span>NSDictionary</span></kbd></td>
</tr>
</tbody>
</table>
<p> </p>
<p><span>In the following example, we will learn how to use platform channel in Android to calculate the battery percentage of an Android phone using the Android <kbd>BatteryManager</kbd> API<strong>.</strong> You can<strong> </strong>read more about the API here: <a href="https://developer.android.com/reference/android/os/BatteryManager" target="_blank">https://developer.android.com/reference/android/os/BatteryManager</a></span></p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Creating a new Flutter project</h1>
                </header>
            
            <article>
                
<p>Please create a new Flutter project. Ensure that the Android SDK path has been set up properly and included in the project settings. </p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Creating a Flutter platform client </h1>
                </header>
            
            <article>
                
<p>For understanding the battery level, Android code be written and then passed on to the Dart code. The applications' state class holds the current state of the app, and we need to extend it to ensure the current battery state is captured. </p>
<p>For this reason, we will use <kbd>MethodChannel</kbd> as the channel comprising of a single platform method that will return the battery level of the Android phone. The client and the host side communicate by a unique channel name passed in the channel constructor. In our case, we have named it <kbd>call.flutter.io/battery</kbd>:</p>
<pre>import 'dart:async';<br/>import 'package:flutter/material.dart';<br/>import 'package:flutter/services.dart';<br/><br/>...<br/>class _MyHomePageState extends State&lt;MyHomePage&gt; {<br/>  static const platform = const MethodChannel('call.flutter.io/battery');<br/><br/>  // Get Android battery level.<br/>}</pre>
<p>The next step is to invoke a method on the method channel, and we will use the returned result (the battery level) to update the value inside <kbd>setState</kbd>:</p>
<pre>String <span>_batteryLevel </span>= <span>'Battery Levels are Unknown'</span><span>;<br/></span><span><br/></span>Future&lt;<span>void</span>&gt; <span>_getPhoneBatteryLevel</span>() <span>async </span>{<br/>  String batteryLevel<span>;<br/></span><span>  </span><span>try </span>{<br/>    <span>final </span>int result = <span>await </span><span>platform</span>.invokeMethod(<span>'getBatteryLevel'</span>)<span>;<br/></span><span>    </span>batteryLevel = <span>'Battery level at </span>$result<span> % .'</span><span>;<br/></span><span>  </span>} <span>on </span>PlatformException <span>catch </span>(e) {<br/>    batteryLevel = <span>"Failed to get battery level: '</span>${e.<span>message</span>}<span>'."</span><span>;<br/></span><span>  </span>}<br/><br/>  setState(() {<br/>    <span>_batteryLevel </span>= _getBatteryLevel() asyncbatteryLevel<span>;<br/></span><span>  </span>})<span>;<br/></span>}</pre>
<p>Finally, replace the build method to have a <kbd>Button</kbd> to have the action, <kbd>onPressed</kbd><strong>, </strong>of which the result of the battery level would be shown as a <kbd>Text</kbd> value. </p>
<p>The complete<span> </span><kbd>Main.Dart</kbd> code is shown here:</p>
<pre><span>import </span><span>'package:flutter/material.dart'</span><span>;<br/></span><span>import </span><span>'package:flutter/services.dart'</span><span>;<br/></span><span><br/></span><span><br/></span><span>import </span><span>'dart:async'</span><span>;<br/></span><span><br/></span><span>void </span><span>main</span>() =&gt; runApp(<span>MyApp</span>())<span>;<br/></span><span><br/></span><span>class </span>MyApp <span>extends </span>StatelessWidget {<br/>  <span>@override<br/></span><span>  </span>Widget <span>build</span>(BuildContext context) {<br/>    <span>return </span><span>MaterialApp</span>(<br/>      title: <span>'Flutter Platform Channel API'</span><span>,<br/></span><span>      </span>theme: <span>ThemeData</span>(<br/><br/>        primarySwatch: Colors.<span>yellow</span><span>,<br/></span><span>      </span>)<span>,<br/></span><span><br/></span><span><br/></span><span>      </span>home: <span>MyHomePage</span>(title: <span>'Flutter Platform Channel API'</span>)<span>,<br/></span><span>    </span>)<span>;<br/></span><span>  </span>}<br/>}<br/><br/><span>class </span>MyHomePage <span>extends </span>StatefulWidget {<br/>  MyHomePage({Key key<span>, </span><span>this</span>.<span>title</span>}) : <span>super</span>(key: key)<span>;<br/></span><span><br/></span><span><br/></span><span>  </span><span>final </span>String <span>title</span><span>;<br/></span><span><br/></span><span>  </span><span>@override<br/></span><span>  </span>_MyHomePageState <span>createState</span>() =&gt; <span>_MyHomePageState</span>()<span>;<br/></span>}<br/><br/><span>class </span>_MyHomePageState <span>extends </span>State&lt;MyHomePage&gt; {<br/><br/>  <span>static const </span><span>platform </span>= <span>const </span><span>MethodChannel</span>(<span>'call.flutter.io/battery'</span>)<span>;<br/></span><span>  </span>String <span>_batteryLevel </span>= <span>'Battery Levels are Unknown'</span><span>;<br/></span><span><br/></span><span>  </span>Future&lt;<span>void</span>&gt; <span>_getPhoneBatteryLevel</span>() <span>async </span>{<br/>    String batteryLevel<span>;<br/></span><span>    </span><span>try </span>{<br/>     <span>final </span>int result = <span>await </span><span>platform</span>.invokeMethod(<span>'getBatteryLevel'</span>)<span>;</span><span><br/></span><span>      </span>batteryLevel = <span>'Battery level at </span>$result<span> % .'</span><span>;<br/></span><span>    </span>} <span>on </span>PlatformException <span>catch </span>(e) {<br/>      batteryLevel = <span>"Failed to get battery level: '</span>${e.<span>message</span>}<span>'."</span><span>;<br/></span><span>    </span>}<br/><br/>    setState(() {<br/>      <span>_batteryLevel </span>= batteryLevel<span>;<br/></span><span>    </span>})<span>;<br/></span><span>  </span>}<br/><br/><br/>  <span>@override<br/></span><span>  </span>Widget <span>build</span>(BuildContext context) {<br/>    <span>return </span><span>Material</span>(<br/>      child: <span>Center</span>(<br/>        child: <span>Column</span>(<br/>          mainAxisAlignment: MainAxisAlignment.<span>center</span><span>,<br/></span><span>          </span>children: [   <br/><br/>            <span>Text </span>(<span>"Click the button to know your phone battery levels"</span>)<span>,<br/></span><span>            </span><span>RaisedButton</span>(<br/>              child: <span>Container</span>(<br/>                decoration: <span>const </span><span>BoxDecoration</span>(<br/>                  gradient: <span>LinearGradient</span>(<br/>                    colors: &lt;Color&gt;[Colors.<span>red</span><span>, </span>Colors.<span>green</span><span>, </span>Colors.<span>brown</span>]<span>,<br/></span><span>                  </span>)<span>,<br/></span><span>                </span>)<span>,<br/></span><span>                </span>padding: <span>const </span><span>EdgeInsets</span>.<span>all</span>(<span>10.0</span>)<span>,<br/></span><span>                </span>child: <span>Text</span>(<span>'Get Phone Battery Level'</span>)<span>,<br/></span><span>              </span>)<span>,<br/></span><span>              </span>onPressed: _getPhoneBatteryLevel<span>,<br/></span><span>              </span>textColor: Colors.<span>white</span><span>,<br/></span><span>              </span>padding: <span>const </span><span>EdgeInsets</span>.<span>all</span>(<span>0.0</span>)<span>,<br/></span><span><br/></span><span>            </span>)<span>,<br/></span><span>            </span><span>Text</span>(<span>_batteryLevel</span>)<span>,<br/></span><span><br/></span><span>          </span>]<span>,<br/></span><span>        </span>)<span>,<br/></span><span>      </span>)<span>,<br/></span><span>    </span>)<span>;<br/></span><span>  </span>}<br/>}</pre>
<p>Next, we will make changes to the Android code. </p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Making changes to MainActivity.Java </h1>
                </header>
            
            <article>
                
<p>Navigate to the Android folder inside your project, and locate the <kbd>MainActivity.java</kbd> file in the Java folder in the project view. Next, inside the <kbd>onCreate</kbd> method in this file, we create a <kbd>MethodChannel</kbd> and a set a <kbd>MethodCallHandler</kbd> inside. Note that the channel name used should be the same on the Flutter client side, as in our case: <kbd>call.flutter.io/battery</kbd>. </p>
<p>Include the following imports:</p>
<pre><span>package </span>androcid.flutterapp1<span>;<br/></span><span><br/></span><span>import </span>android.os.Bundle<span>;<br/></span><span>import </span>io.flutter.app.FlutterActivity<span>;<br/></span><span>import </span>io.flutter.plugins.GeneratedPluginRegistrant<span>;<br/></span><span>import </span>io.flutter.plugin.common.MethodCall<span>;<br/></span><span>import </span>io.flutter.plugin.common.MethodChannel<span>;<br/></span><span>import </span>io.flutter.plugin.common.MethodChannel.MethodCallHandler<span>;<br/></span><span>import </span>io.flutter.plugin.common.MethodChannel.Result<span>;<br/><br/></span><span>import </span>android.content.ContextWrapper<span>;<br/></span><span>import </span>android.content.Intent<span>;<br/></span><span>import </span>android.content.IntentFilter<span>;<br/></span><span>import </span>android.os.BatteryManager<span>;<br/></span><span>import </span>android.os.Build.VERSION<span>;<br/></span><span>import </span>android.os.Build.VERSION_CODES<span>;</span></pre>
<p>Next, create a <kbd>String</kbd> to hold the channel name:</p>
<pre>private static final String CHANNEL = "call.flutter.io/battery";</pre>
<p>And, finally, add the <kbd>MethodChannel</kbd> method:</p>
<pre>new MethodChannel(getFlutterView(), CHANNEL).setMethodCallHandler(<br/>                new MethodCallHandler() {<br/>                    @Override<br/>               public void onMethodCall(MethodCall call, Result result) {<br/>                        // TODO<br/>                    }<br/>                }); </pre>
<p>In the next step, we have to write the Android <kbd>onCreate</kbd> method: </p>
<pre><span>private int </span><span>getBatteryLevel</span>() {<br/>    <span>int </span>phoneBatteryLevel = -<span>1</span><span>;<br/></span><span>    if </span>(VERSION.<span>SDK_INT </span>&gt;= VERSION_CODES.<span>LOLLIPOP</span>) {<br/>      BatteryManager batteryManager = (BatteryManager) getSystemService(<span>BATTERY_SERVICE</span>)<span>;<br/></span><span>      </span>phoneBatteryLevel = batteryManager.getIntProperty(BatteryManager.<span>BATTERY_PROPERTY_CAPACITY</span>)<span>;<br/></span><span>    </span>} <span>else </span>{<br/>      Intent intent = <span>new </span>ContextWrapper(getApplicationContext()).<br/>              registerReceiver(<span>null, new </span>IntentFilter(Intent.<span>ACTION_BATTERY_CHANGED</span>))<span>;<br/></span><span>      </span>phoneBatteryLevel = (intent.getIntExtra(BatteryManager.<span>EXTRA_LEVEL</span><span>, </span>-<span>1</span>) * <span>100</span>) /<br/>              intent.getIntExtra(BatteryManager.<span>EXTRA_SCALE</span><span>, </span>-<span>1</span>)<span>;<br/></span><span>    </span>}<br/><br/>    <span>return </span>phoneBatteryLevel<span>;<br/></span><span>  </span>}<br/>}</pre>
<p>To use <kbd>BatteryManager</kbd>, the minimum API is 21, and hence we use <kbd>VERSION_CODES.LOLLIPOP</kbd><strong>.</strong></p>
<p>Our final step is to complete the <kbd>onMethodCall</kbd> method added earlier. Using a single platform method, <kbd>getbatteryLevel</kbd><strong>, </strong>you can simply call the Android code written in the previous step, and revert back the response, both in success as well as error cases using the response argument, as follows:</p>
<pre><span>protected void </span><span>onCreate</span>(Bundle savedInstanceState) {<br/>  <span>super</span>.onCreate(savedInstanceState)<span>;<br/></span><span>  </span>GeneratedPluginRegistrant.<span>registerWith</span>(<span>this</span>)<span>;<br/></span><span>  new </span>MethodChannel(getFlutterView()<span>, </span><span>CHANNEL</span>).setMethodCallHandler(<br/>          <span>new </span>MethodCallHandler() {<br/>            <span>@Override<br/></span><span>            </span><span>public void </span><span>onMethodCall</span>(MethodCall call<span>, </span>Result result) {<br/><br/>                <span>if </span>(call.<span>method</span>.equals(<span>"getBatteryLevel"</span>)) {<br/>                  <span>int </span>batteryLevel = getBatteryLevel()<span>;<br/></span><span><br/></span><span>                  if </span>(batteryLevel != -<span>1</span>) {<br/>                    result.success(batteryLevel)<span>;<br/></span><span>                  </span>} <span>else </span>{<br/>              result.error(<span>"Currently unavailable"</span><span>, </span><span>"Battery level not <br/>              available currently."</span><span>, null</span>)<span>;<br/></span><span>                  </span>}<br/>                } <span>else </span>{<br/>                  result.notImplemented()<span>;<br/></span><span>                </span>}<br/><br/>            }<br/>          })<span>;<br/></span>}</pre>
<p><span>The following is the complete Android code: </span></p>
<pre><span>package </span>androcid.flutterapp1<span>;<br/></span><span><br/></span><span>import </span>android.os.Bundle<span>;<br/></span><span>import </span>io.flutter.app.FlutterActivity<span>;<br/></span><span>import </span>io.flutter.plugins.GeneratedPluginRegistrant<span>;<br/></span><span>import </span>io.flutter.plugin.common.MethodCall<span>;<br/></span><span>import </span>io.flutter.plugin.common.MethodChannel<span>;<br/></span><span>import </span>io.flutter.plugin.common.MethodChannel.MethodCallHandler<span>;<br/></span><span>import </span>io.flutter.plugin.common.MethodChannel.Result<span>;<br/></span><span>import </span>android.content.ContextWrapper<span>;<br/></span><span>import </span>android.content.Intent<span>;<br/></span><span>import </span>android.content.IntentFilter<span>;<br/></span><span>import </span>android.os.BatteryManager<span>;<br/></span><span>import </span>android.os.Build.VERSION<span>;<br/></span><span>import </span>android.os.Build.VERSION_CODES<span>;<br/></span><span><br/></span><span>public class </span>MainActivity <span>extends </span>FlutterActivity {<br/>  <span>private static final </span>String <span>CHANNEL </span>= <span>"call.flutter.io/battery"</span><span>;<br/></span><span>  </span><span>@Override<br/></span><span><br/></span><span>  </span><span>protected void </span><span>onCreate</span>(Bundle savedInstanceState) {<br/>    <span>super</span>.onCreate(savedInstanceState)<span>;<br/></span><span>    </span>GeneratedPluginRegistrant.<span>registerWith</span>(<span>this</span>)<span>;<br/></span><span>    new </span>MethodChannel(getFlutterView()<span>, </span><span>CHANNEL</span>).setMethodCallHandler(<br/>            <span>new </span>MethodCallHandler() {<br/>              <span>@Override<br/></span><span>              </span><span>public void </span><span>onMethodCall</span>(MethodCall call<span>, </span>Result result) {<br/><br/>                  <span>if </span>(call.<span>method</span>.equals(<span>"getBatteryLevel"</span>)) {<br/>                    <span>int </span>batteryLevel = getBatteryLevel()<span>;<br/></span><span><br/></span><span>                    if </span>(batteryLevel != -<span>1</span>) {<br/>                      result.success(batteryLevel)<span>;<br/></span><span>                    </span>} <span>else </span>{<br/>                result.error(<span>"Currently unavailable"</span><span>, </span><span>"Battery level not available currently."</span><span>, null</span>)<span>;<br/></span><span>                    </span>}<br/>                  } <span>else </span>{<br/>                    result.notImplemented()<span>;<br/></span><span>                  </span>}<br/><br/>              }<br/>            })<span>;<br/></span><span>  </span>}<br/><br/>  <span>private int </span><span>getBatteryLevel</span>() {<br/>    <span>int </span>phoneBatteryLevel = -<span>1</span><span>;<br/></span><span>    if </span>(VERSION.<span>SDK_INT </span>&gt;= VERSION_CODES.<span>LOLLIPOP</span>) {<br/>      BatteryManager batteryManager = (BatteryManager) getSystemService(<span>BATTERY_SERVICE</span>)<span>;<br/></span><span>      </span>phoneBatteryLevel = batteryManager.getIntProperty(BatteryManager.<span>BATTERY_PROPERTY_CAPACITY</span>)<span>;<br/></span><span>    </span>} <span>else </span>{<br/>      Intent intent = <span>new </span>ContextWrapper(getApplicationContext()).<br/>              registerReceiver(<span>null, new </span>IntentFilter(Intent.<span>ACTION_BATTERY_CHANGED</span>))<span>;<br/></span><span>      </span>phoneBatteryLevel = (intent.getIntExtra(BatteryManager.<span>EXTRA_LEVEL</span><span>, </span>-<span>1</span>) * <span>100</span>) /<br/>              intent.getIntExtra(BatteryManager.<span>EXTRA_SCALE</span><span>, </span>-<span>1</span>)<span>;<br/></span><span>    </span>}<br/><br/>    <span>return </span>phoneBatteryLevel<span>;<br/></span><span>  </span>}<br/>}</pre>
<p>After running the code successfully, you will see the following output:</p>
<p class="CDPAlignCenter CDPAlign"><img class="aligncenter size-full wp-image-446 image-border" src="assets/66fd0f98-e554-41e4-82c4-ba4f2d31335d.png" style="width:20.33em;height:39.25em;"/></p>
<p>When clicking on the button, the <span class="packt_screen">Battery Level</span> of the phone will be displayed: </p>
<p class="CDPAlignCenter CDPAlign"><img class="aligncenter size-full wp-image-447 image-border" src="assets/6825914f-1ef9-4a0c-b04c-387782731345.png" style="width:20.33em;height:39.33em;"/></p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Building and publishing your own plugin </h1>
                </header>
            
            <article>
                
<p>Plugins play an important role in the Flutter ecosystem. Google developers and open source contributors have contributed to several published plugins. We have seen in the <a href="c29724b0-6438-41da-9d91-64881a6be71e.xhtml" target="_blank">Chapter 5</a>, <em>Widening our Flutter Horizons</em>, show to include the plugins in the code. When building a plugin, here are some of the tips to keep in mind:</p>
<ol>
<li><strong>Check for existing plugin availability</strong>: See whether there are existing plugins available that function the same/similar way, before you code from fresh. </li>
<li><strong>Think Dart</strong>:<strong> </strong>Since Flutter code is written in Dart, it's ideal if the major logic is crafted in Dart, which not only makes it easy to navigate but also processing the code is easier, across the platform. </li>
<li><strong>Avoid a building platform-specific plugin that is only supports</strong>: The developer might be tempted to start building a plugin including every feature they might desire, but thinking solo-platform might not be such a good idea. Not only will it confuse the users about its use cases on a specific platform, it will also make the app behave in an unexpected way. </li>
<li><strong>Avoid building platform-specific API methods</strong>:<strong> </strong>As a developer, you might be tempted to build a platform-specific method, but this can go into overkill. Try including the platform-specific logic to the plugin itself. </li>
<li><strong>Build for features</strong>:<strong> </strong>Ensure that the plugin you are planning to build has a specific use case providing features, rather than just calling existing APIs. There is nothing wrong with using an existing native library, but the problem arises when these APIs don't work as expected across different platforms. Focusing on features more than on API could help you build better plugins. </li>
<li><strong>Detail out the features and installation properly</strong>:<strong> </strong>When your plugin is published, support the community by giving out more details about the plugin's features and how they seamlessly include this plugin into their code. The visibility of the plugin matters, as if the community loves the plugin, they will rate the plugin higher, thus increasing the visibility. Use examples so that there are no problems regarding including your plugin. </li>
</ol>
<p>To publish your own plugin, use the following command:</p>
<pre><strong>flutter packages pub publish --dry-run</strong></pre>
<p>If there are no errors in the execution, you can execute the following command to publish the plugin and your plugin will be live in a few minutes: </p>
<pre><span><strong>flutter packages pub publish</strong><br/></span></pre>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Summary </h1>
                </header>
            
            <article>
                
<p>At the start of the chapter, we learned how to include packages in the Flutter code, followed by how to include platform-specific channels to support Flutter code. We also used the <kbd>BatteryManager</kbd> API to understand the battery state of the Android phone. In the last section, we covered some of the best tips to consider you build your our own plugin, followed by how to publish your own plugin. </p>
<p>In the next chapter, we will take a look at how to use <strong>Firebase</strong> with Flutter.</p>


            </article>

            
        </section>
    </body></html>