<html><head></head><body><div class="chapter" title="Chapter&#xA0;5.&#xA0;Push Notifications"><div class="titlepage"><div><div><h1 class="title"><a id="ch05"/>Chapter 5. Push Notifications</h1></div></div></div><p>Push notifications<a id="id99" class="indexterm"/> allow you to send messages even when the application is in the background or not running at all. Push notifications increase the user's engagement with the application and keep all the users informed about the application through messages, which in turn generates revenue. Additionally, by having your data and push services interconnected allows you to send push notifications in a selective way, such as <span class="emphasis"><em>Congrats on completing one year with Packt Publishing</em></span>. It's the easiest way to reach all your users. Parse provides you with the push notification services. This chapter will help you to configure push notifications for your application.</p><div class="section" title="Setting up push notifications"><div class="titlepage"><div><div><h1 class="title"><a id="ch05lvl1sec30"/>Setting up push notifications</h1></div></div></div><p>Notification helps<a id="id100" class="indexterm"/> you in adding real-time messaging to your application. For this, you need to create an SSL certificate and then associate the created certificate with your <span class="strong"><strong>App ID</strong></span> and <span class="strong"><strong>Provisioning Profile</strong></span>.</p><div class="section" title="Creating an SSL certificate"><div class="titlepage"><div><div><h2 class="title"><a id="ch05lvl2sec31"/>Creating an SSL certificate</h2></div></div></div><p>You <a id="id101" class="indexterm"/>need to<a id="id102" class="indexterm"/> create your <span class="strong"><strong>App ID</strong></span> and associated SSL certificate on the Apple developer portal. The Parse server will use this certificate to send push notifications to the application identified by that <span class="strong"><strong>App ID</strong></span>.</p></div><div class="section" title="Generating certificate requests"><div class="titlepage"><div><div><h2 class="title"><a id="ch05lvl2sec32"/>Generating certificate requests</h2></div></div></div><p>Perform<a id="id103" class="indexterm"/> the <a id="id104" class="indexterm"/>following steps to generate the certificate and save it to your disk:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Open the <span class="strong"><strong>Keychain Access</strong></span> application on your Mac.</li><li class="listitem">Navigate to <span class="strong"><strong>Keychain Access</strong></span> | <span class="strong"><strong>Certificate Assistant</strong></span> | <span class="strong"><strong>Request a Certificate From a Certificate Authority…</strong></span>.</li><li class="listitem">In the <span class="strong"><strong>Certificate Information</strong></span> window, enter your e-mail address and name.</li><li class="listitem">Select <span class="strong"><strong>Save to disk</strong></span> to download the <span class="strong"><strong>.certSigningRequest</strong></span> file to your desktop.</li></ol></div></div><div class="section" title="Setting up your App ID"><div class="titlepage"><div><div><h2 class="title"><a id="ch05lvl2sec33"/>Setting up your App ID</h2></div></div></div><p>An App ID is<a id="id105" class="indexterm"/> required for all the iOS applications <a id="id106" class="indexterm"/>installed on your developer device. You can use your existing App ID, but make sure that it does not have a wildcard character. You can create a new App ID by performing the following steps:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Log in to the <a id="id107" class="indexterm"/>Apple developer portal (<a class="ulink" href="https://developer.apple.com/membercenter/index.action">https://developer.apple.com/membercenter/index.action</a>) and navigate to <span class="strong"><strong>Certificates, Identifiers &amp; Profiles</strong></span> (<a class="ulink" href="https://developer.apple.com/account/overview.action">https://developer.apple.com/account/overview.action</a>).</li><li class="listitem">Click on <span class="strong"><strong>Identifiers</strong></span> from the left panel of the portal.</li><li class="listitem">Click on the <span class="strong"><strong>+</strong></span> button on the top right-hand side to create a new App ID.</li><li class="listitem">Enter the name of the new App ID and select the <span class="strong"><strong>Push Notifications</strong></span> checkbox under the <span class="strong"><strong>App Services</strong></span> section.</li><li class="listitem">In the <span class="strong"><strong>App ID suffix</strong></span> section, select <span class="strong"><strong>Explicit App ID</strong></span>. Enter your iOS apps <span class="strong"><strong>Bundle ID</strong></span>. This string should match the Bundle identifier in your iOS app's <code class="literal">info.plist</code> file.</li><li class="listitem">Click on <span class="strong"><strong>Continue</strong></span> followed by <span class="strong"><strong>Submit</strong></span> to finalize your registration.</li><li class="listitem">Select your newly created App ID from the list of <span class="strong"><strong>iOS App IDs</strong></span>, then click on <span class="strong"><strong>Settings</strong></span>.</li><li class="listitem">Navigate to the <span class="strong"><strong>Push Notifications</strong></span> section. You can download both <span class="strong"><strong>Development</strong></span> and <span class="strong"><strong>Production SSL certificate</strong></span>.</li><li class="listitem">Click on <span class="strong"><strong>Create Certificate...</strong></span>, then click on <span class="strong"><strong>Continue</strong></span>.</li><li class="listitem">Now you can upload your certificate that you have generated in the previous section and then click on <span class="strong"><strong>Generate</strong></span>.</li><li class="listitem">After uploading your certificate, click on <span class="strong"><strong>Done</strong></span> and then download the generated SSL certificate from the <span class="strong"><strong>iOS App ID Settings</strong></span> screen.</li><li class="listitem">Install the downloaded certificate in your Keychain by double-clicking on the SSL certificate.</li><li class="listitem">In <span class="strong"><strong>Keychain Access</strong></span>, under the <span class="strong"><strong>My Certificates</strong></span> section, select your installed certificate, it should have <span class="strong"><strong>Apple Development IOS Push Services:</strong></span> as a prefix.</li><li class="listitem">Right-click on the selected certificate and save it as the <code class="literal">.p12</code> file format. Do not give any password when prompted.</li></ol></div></div></div></div>
<div class="section" title="Creating your provisioning profile"><div class="titlepage"><div><div><h1 class="title"><a id="ch05lvl1sec31"/>Creating your provisioning profile</h1></div></div></div><p>To authenticate your<a id="id108" class="indexterm"/> device for the application you need to create a provisioning profile. You need to regenerate your provisioning profile every time you update your App ID. Perform the following steps to create a provisioning profile:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Log in to the Apple developer portal and navigate to the <span class="strong"><strong>Certificates, Identifiers &amp; Profiles</strong></span> section.</li><li class="listitem">Select <span class="strong"><strong>Provisioning Profiles</strong></span> from the <span class="strong"><strong>iOS Apps</strong></span> section.</li><li class="listitem">Click on the <span class="strong"><strong>+</strong></span> button on the top right-hand side of the section, to add a new provisioning profile.</li><li class="listitem">Choose <span class="strong"><strong>iOS App Development</strong></span> as the type of your provisioning profile and click on <span class="strong"><strong>Continue</strong></span>.</li><li class="listitem">Select the App ID created in the previous section and click on <span class="strong"><strong>Continue</strong></span>.</li><li class="listitem">Select your certificate and click on <span class="strong"><strong>Continue</strong></span>.</li><li class="listitem">Select the devices from the list of devices on which you want to install and test your application and click on <span class="strong"><strong>Continue</strong></span>.</li><li class="listitem">Provide a name to your provisioning profile and click on <span class="strong"><strong>Generate</strong></span>.</li><li class="listitem">Download the generated profile and double-click to install it.</li></ol></div><p>This should launch your Xcode's <span class="strong"><strong>Organizer</strong></span> in the <span class="strong"><strong>Devices</strong></span> panel. Your new provisioning profile should appear in the <span class="strong"><strong>Provisioning Profile</strong></span> section of <span class="strong"><strong>LIBRARY</strong></span>. Make sure that the <span class="strong"><strong>Status</strong></span> of the profile is <span class="strong"><strong>Valid</strong></span>.</p><div class="section" title="Configuring your Parse app"><div class="titlepage"><div><div><h2 class="title"><a id="ch05lvl2sec34"/>Configuring your Parse app</h2></div></div></div><p>To make use<a id="id109" class="indexterm"/> of push notification services with Parse, you would have to enable this feature in your Parse app by uploading the Push SSL certificate you generated in the previous sections:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Navigate to your Parse app on the Parse <span class="strong"><strong>Dashboard</strong></span> and select the <span class="strong"><strong>Settings</strong></span> tab.</li><li class="listitem">On the left-hand side of the settings panel, you will have <span class="strong"><strong>Push notifications</strong></span>. Under the <span class="strong"><strong>Apple Push Certificate</strong></span> header, click on <span class="strong"><strong>Select your certificate</strong></span> and locate your <code class="literal">.p12</code> certificate you exported from the Keychain in the previous section.</li></ol></div></div><div class="section" title="Configuring an iOS application for push notifications"><div class="titlepage"><div><div><h2 class="title"><a id="ch05lvl2sec35"/>Configuring an iOS application for push notifications</h2></div></div></div><p>You need<a id="id110" class="indexterm"/> to update the following application settings to configure push notifications:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Your application bundle identifier should be exactly the same as you have provided on the Apple developer portal while creating the App ID.</li><li class="listitem">Update <a id="id111" class="indexterm"/>your <span class="strong"><strong>Code Signing Identity</strong></span> field to match the provisioning profile we created in the previous section.</li></ol></div></div><div class="section" title="Installation"><div class="titlepage"><div><div><h2 class="title"><a id="ch05lvl2sec36"/>Installation</h2></div></div></div><p>In all the <a id="id112" class="indexterm"/>previous sections, we have configured all that is required to get started with the push notifications. In this section, we will add some code to receive push notifications in our application.</p><p>You need to register your device to get the push notifications, add the following code in the app's delegate <code class="literal">[application:didFinishLaunchingWithOptions:]</code> method.</p><div class="informalexample"><pre class="programlisting">- (BOOL)application:(UIApplication *)application
 didFinishLaunchingWithOptions:(NSDictionary *)launchOptions {
    ...
    // Register for push notifications
    [application registerForRemoteNotificationTypes:
                                 UIRemoteNotificationTypeBadge |
                                 UIRemoteNotificationTypeAlert |             
                                 UIRemoteNotificationTypeSound];
    ...
}</pre></div><p>On successful registration, your callback method <code class="literal">[application:didRegisterForRemoteNotificationsWithDeviceToken:]</code> in the app delegate will be executed. We need to configure this method to inform Parse about the new device:</p><div class="informalexample"><pre class="programlisting">- (void)application:(UIApplication *)application
didRegisterForRemoteNotificationsWithDeviceToken:(NSData *)newDeviceToken {
    // Store the deviceToken in the current installation and save it to Parse.
    PFInstallation *currentInstallation = [PFInstallation currentInstallation];
    [currentInstallation setDeviceTokenFromData:newDeviceToken];
    [currentInstallation saveInBackground];
}</pre></div><p>You can update the <code class="literal">PFInstallation</code> just like your <code class="literal">PFObject</code>. You can add variety of special fields which will help you to manage your devices on Parse. The following are some of the fields and their uses:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><code class="literal">badges</code>: You <a id="id113" class="indexterm"/>can change this value in <code class="literal">PFInstallation</code> to update the badge on the app icon. It's recommended to save the changes of badges on the server for future badge increment notifications.</li><li class="listitem" style="list-style-type: disc"><code class="literal">channels</code>: This <a id="id114" class="indexterm"/>will store the array of channels that are subscribed to thecurrent device.</li><li class="listitem" style="list-style-type: disc"><code class="literal">timeZone</code>: This <a id="id115" class="indexterm"/>property is for the current location of the device. It's updated automatically when we update the <code class="literal">Installation</code> object on the server. This is a read-only property.</li><li class="listitem" style="list-style-type: disc"><code class="literal">deviceType</code>: This<a id="id116" class="indexterm"/> property is for any device type, that can be iOS, Android, winrt, winphone, or dotnet. This is a read-only property.</li><li class="listitem" style="list-style-type: disc"><code class="literal">installationId</code>: This<a id="id117" class="indexterm"/> is a unique ID property for the device used by Parse. This is a read-only property.</li><li class="listitem" style="list-style-type: disc"><code class="literal">deviceToken</code>: This is the <a id="id118" class="indexterm"/>Apple-generated token used for iOS devices. This is a read-only property.</li><li class="listitem" style="list-style-type: disc"><code class="literal">channelUris</code>: This<a id="id119" class="indexterm"/> is the Microsoft-generated push URI for Windows devices. This is a read-only property.</li><li class="listitem" style="list-style-type: disc"><code class="literal">appName</code>: This is the <a id="id120" class="indexterm"/>display name of the client application to which this installation belongs. This is a read-only property.</li><li class="listitem" style="list-style-type: disc"><code class="literal">appVersion</code>: This<a id="id121" class="indexterm"/> is the version of string of the client application to which the current installation belongs. This is a read-only property.</li><li class="listitem" style="list-style-type: disc"><code class="literal">parseVersion</code>: This is the <a id="id122" class="indexterm"/>version of the Parse SDK that uses this installation. This is a read-only property.</li><li class="listitem" style="list-style-type: disc"><code class="literal">appIdentifier</code>: This is a unique<a id="id123" class="indexterm"/> identifier for this installation's client application. In iOS, this is the <code class="literal">Bundle Identifier</code>. This is a read-only property.</li></ul></div><p>When your <a id="id124" class="indexterm"/>application receives notification in foreground mode, you can handle the notification using the following code:</p><div class="informalexample"><pre class="programlisting">- (void)application:(UIApplication *)application
didReceiveRemoteNotification:(NSDictionary *)userInfo {
    [PFPush handlePush:userInfo];
}</pre></div><p>After receiving notification, we can pass the notification over to Parse to handle it. It will automatically create a modal alert and will display it with the push message content.</p><p>You can now execute your application on your device to make sure that everything is set up correctly. If you are running the app for the first time on your device, you will receive a modal box requesting the permission for sending push notifications to the user.</p></div></div>
<div class="section" title="Sending push notifications"><div class="titlepage"><div><div><h1 class="title"><a id="ch05lvl1sec32"/>Sending push notifications</h1></div></div></div><p>You can<a id="id125" class="indexterm"/> send push notifications to devices using the following ways.</p><div class="section" title="Parse websites"><div class="titlepage"><div><div><h2 class="title"><a id="ch05lvl2sec37"/>Parse websites</h2></div></div></div><p>Perform <a id="id126" class="indexterm"/>the following steps to send<a id="id127" class="indexterm"/> notifications through the Parse website:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Navigate to your Parse application on Parse.com.</li><li class="listitem">Click on the <span class="strong"><strong>Push Notifications</strong></span> tab.</li><li class="listitem">You can click on <span class="strong"><strong>Send a push</strong></span> on the top right-hand side of the box.</li><li class="listitem">Compose a message in the message box, and broadcast it to <span class="strong"><strong>Everyone</strong></span>. You have other options available to select the device type.</li><li class="listitem">Parse allows you to schedule the notifications as well. You can configure this schedule and click on <span class="strong"><strong>Send notification</strong></span> to send the notification.</li></ol></div></div><div class="section" title="Parse apps"><div class="titlepage"><div><div><h2 class="title"><a id="ch05lvl2sec38"/>Parse apps</h2></div></div></div><p>Usually<a id="id128" class="indexterm"/> you can send push notifications <a id="id129" class="indexterm"/>through a web console, or by using the REST API, or Cloud Code. However, Parse also allows you to send push notifications from your mobile application as well. Remember, you have enabled the <span class="strong"><strong>Client push</strong></span> as <span class="strong"><strong>Yes</strong></span>. The enabled <span class="strong"><strong>Client push</strong></span> setting allows you to send a notification from one device to another. There are lots of methods available in the <code class="literal">PFPush</code> class, which allow you to send push notifications through your mobile. You can access all the methods in the API documentation. Here is the example code to demonstrate the push notifications generated from an iOS device:</p><div class="informalexample"><pre class="programlisting">// Create our Installation query
PFQuery *pushQuery = [PFInstallation query];
[pushQuery whereKey:@"deviceType" equalTo:@"ios"];
 
// Send push notifications to query
[PFPush sendPushMessageToQueryInBackground:pushQuery	
                               withMessage:@"Hello World!"];</pre></div></div><div class="section" title="Cloud Code"><div class="titlepage"><div><div><h2 class="title"><a id="ch05lvl2sec39"/>Cloud Code</h2></div></div></div><p>Cloud Code <a id="id130" class="indexterm"/>also <a id="id131" class="indexterm"/>allows you to send push <a id="id132" class="indexterm"/>notifications using the <code class="literal">Parse.Cloud.afterSave</code> method, which will be executed after the object is saved successfully on Parse. Cloud can be written in JavaScript. You should be<a id="id133" class="indexterm"/> familiar with JavaScript to write Cloud Code. Let's take an example of how to send push notifications after each comment:</p><div class="informalexample"><pre class="programlisting">Parse.Cloud.afterSave("Comment", function(request) {
  // Our "Comment" class has a "text" key with the body of the comment itself
  var commentText = request.object.get('text');
 
  var pushQuery = new Parse.Query(Parse.Installation);
  pushQuery.equalTo('deviceType', 'ios');
    
  Parse.Push.send({
    where: pushQuery, // Set our Installation query
    data: {
      alert: "New comment: " + commentText
    }
  }, {
    success: function() {
      // Push was successful
    },
    error: function(error) {
      throw "Got an error " + error.code + " : " + error.message;
    }
  });
});</pre></div></div></div>
<div class="section" title="Sending notifications"><div class="titlepage"><div><div><h1 class="title"><a id="ch05lvl1sec33"/>Sending notifications</h1></div></div></div><p>There are two<a id="id134" class="indexterm"/> ways to send push notifications to devices using Parse. They are as follows.</p><div class="section" title="Channels"><div class="titlepage"><div><div><h2 class="title"><a id="ch05lvl2sec40"/>Channels</h2></div></div></div><p>It's the<a id="id135" class="indexterm"/> easiest way to start sending notifications. It's based on the Publish/Subscribe model. For example, if you want to send a notification to the user on <a id="id136" class="indexterm"/>every comment on the post he/she created, then you have to create a channel and subscribe the user to that channel, and over every comment you need to send a push for that channel. This will let the user know when anyone comments on his/her post even when the application is not running or is in the background. So for sending the push notifications you need to allow the user to create a channel. A device can subscribe for one or more channels to receive notifications that can be sent to such subscribers. The subscribed channels for Installation are stored in the <code class="literal">channels</code> fields of the <code class="literal">Installation</code> object.</p><div class="section" title="Subscribing to channels"><div class="titlepage"><div><div><h3 class="title"><a id="ch05lvl3sec01"/>Subscribing to channels</h3></div></div></div><p>You can<a id="id137" class="indexterm"/> identify a channel by string, which can be a combination of alphanumeric characters, underscores, and dashes. Each installation can subscribe to any number of channels at any time. You can add a channel by using the following code in the <code class="literal">Installation</code> object:</p><div class="informalexample"><pre class="programlisting">// When users Comment, we subscribe them to that channel.
PFInstallation *currentInstallation = [PFInstallation currentInstallation];
[currentInstallation addUniqueObject:@"Comments" forKey:@"channels"];
[currentInstallation saveInBackground];</pre></div><p>After subscribing to comments, your <code class="literal">Installation</code> object should look something like this:</p><div class="informalexample"><pre class="programlisting">objectId:yvoZDtAxUR channels:["Comments"]</pre></div><p>To unsubscribe users from the channel, you can add the following code:</p><div class="informalexample"><pre class="programlisting">// When users indicate they are no longer Giants fans, we unsubscribe them.
PFInstallation *currentInstallation = [PFInstallation currentInstallation];
[currentInstallation removeObject:@"Comments" forKey:@"channels"];
[currentInstallation saveInBackground];</pre></div><p>To get a list of channels as an array for caching purposes, you can use the following code:</p><div class="informalexample"><pre class="programlisting">NSArray *subscribedChannels = [PFInstallation currentInstallation].channels;</pre></div></div><div class="section" title="Sending push notifications to channels"><div class="titlepage"><div><div><h3 class="title"><a id="ch05lvl3sec02"/>Sending push notifications to channels</h3></div></div></div><p>To send push notifications<a id="id138" class="indexterm"/> to all the users who are subscribed with the <code class="literal">Comments</code> channel, the following code will send a push to all the subscribed users:</p><div class="informalexample"><pre class="programlisting">// Send a notification to all devices subscribed to the "Giants" channel.
PFPush *push = [[PFPush alloc] init];
[push setChannel:@"Comments"];
[push setMessage:@"Thats the new comment!"];
[push sendPushInBackground];</pre></div><p>If you want to send a push to multiple channels at the same time, you can use the following code:</p><div class="informalexample"><pre class="programlisting">NSArray *channels = [NSArray arrayWithObjects:@"Comments", @"Mets", nil];
PFPush *push = [[PFPush alloc] init];
 
// Be sure to use the plural 'setChannels'.
[push setChannels:channels];
[push setMessage:@"Multiple channel comments."];
[push sendPushInBackground];</pre></div></div></div></div>
<div class="section" title="Using advanced targeting"><div class="titlepage"><div><div><h1 class="title"><a id="ch05lvl1sec34"/>Using advanced targeting</h1></div></div></div><p>In<a id="id139" class="indexterm"/> advanced push notifications, Parse allows you to embed <a id="id140" class="indexterm"/>a query and you can send the result of the query as push notifications to the users. This will help you to send pushes to customize a dynamic segment of users.</p><p>You can save the data to the <code class="literal">Installation</code> object just as any <code class="literal">PFObject</code>. Let's say in your application you allow users to like, comment, and post. The following piece of code will help you achieve that:</p><div class="informalexample"><pre class="programlisting">// Store app language and version
PFInstallation *installation = [PFInstallation currentInstallation];
[installation setObject:[NSNumber numberWithBool:YES] forKey:@"Like"];
[installation setObject:[NSNumber numberWithBool:YES] forKey:@"Comment"];
[installation setObject:[NSNumber numberWithBool:YES] forKey:@"Posts"];
[installation saveInBackground];</pre></div><div class="section" title="Sending pushes to queries"><div class="titlepage"><div><div><h2 class="title"><a id="ch05lvl2sec41"/>Sending pushes to queries</h2></div></div></div><p>You can<a id="id141" class="indexterm"/> filter the <code class="literal">Installation</code> objects by applying queries to the target devices for notifications. This can be achieved using the following code:</p><div class="informalexample"><pre class="programlisting">// Create our Installation query
PFQuery *pushQuery = [PFInstallation query];
[pushQuery whereKey:@"Comments" equalTo:[NSNumber numberWithBool:YES]];
 
// Send push notifications to query
PFPush *push = [[PFPush alloc] init];
[push setQuery:pushQuery]; // Set our Installation query
[push setMessage:@"This is the test comment."];
[push sendPushInBackground];</pre></div><p>We can set the query to <code class="literal">PFPush</code> before sending the notification. You can also store the data in <a id="id142" class="indexterm"/>relationships. Those relationships can also be used in query:</p><div class="informalexample"><pre class="programlisting">// Find users near a given location
PFQuery *userQuery = [PFUser query];
[userQuery whereKey:@"location"
        nearGeoPoint:partyLocation
         withinMiles:[NSNumber numberWithInt:1]]
 
// Find devices associated with these users
PFQuery *pushQuery = [PFInstallation query];
[pushQuery whereKey:@"user" matchesQuery:userQuery];
 
// Send push notifications to query
PFPush *push = [[PFPush alloc] init];
[push setQuery:pushQuery]; // Set our Installation query
[push setMessage:@"Party tickets free to all nearby users!"];
[push sendPushInBackground];</pre></div></div><div class="section" title="Customizing notifications"><div class="titlepage"><div><div><h2 class="title"><a id="ch05lvl2sec42"/>Customizing notifications</h2></div></div></div><p>You<a id="id143" class="indexterm"/> can customize the push notifications data such as sound played, badge number, custom data to send, and expiration of notification.</p><p>You can also customize the notification by wrapping all settings in a <code class="literal">NSDictionary</code> method. Let's take an example of incrementing the badge by one with custom sound and message in the notification:</p><div class="informalexample"><pre class="programlisting">NSDictionary *data = [NSDictionary dictionaryWithObjectsAndKeys:
    @"New comment!", @"alert",
    @"Increment", @"badge",
    @"demo.caf", @"sound",
    nil];
PFPush *push = [[PFPush alloc] init];
[push setChannels:[NSArray arrayWithObjects:@"Mets", nil]];
[push setData:data];
[push sendPushInBackground];</pre></div><p>To set the expiration date of the notification, you can use the following example code:</p><div class="informalexample"><pre class="programlisting">// Create date object for tomorrow
NSDateComponents *comps = [[NSDateComponents alloc] init];
[comps setYear:2013];
[comps setMonth:8];
[comps setDay:27];
NSCalendar *gregorian =[[NSCalendar alloc] initWithCalendarIdentifier:NSGregorianCalendar];
NSDate *date = [gregorian dateFromComponents:comps];
 
// Send push notifications with expiration date
PFPush *push = [[PFPush alloc] init];
[push expireAtDate:date];
[push setQuery:everyoneQuery];
[push setMessage:@"Movie tickets on sale until August 27th"];
[push sendPushInBackground];</pre></div></div><div class="section" title="Platform-based targeting"><div class="titlepage"><div><div><h2 class="title"><a id="ch05lvl2sec43"/>Platform-based targeting</h2></div></div></div><p>You can<a id="id144" class="indexterm"/> have the application working on various platforms. If you want to target the push to a specific platform device or operating system, then you can use the following code. This code will send a separate notification for iOS, Android, and Windows apps:</p><div class="informalexample"><pre class="programlisting">PFQuery *query = [PFInstallation query];
[query whereKey:@"channels" equalTo:@"suitcaseOwners"];
 
// Notification for Android users
[query whereKey:@"deviceType" equalTo:@"android"];
PFPush *androidPush = [[PFPush alloc] init];
[androidPush setMessage:@"Your suitcase has been filled with tiny robots!"];
[androidPush setQuery:query];
[androidPush sendPushInBackground];
 
// Notification for iOS users
[query whereKey:@"deviceType" equalTo:@"ios"];
PFPush *iOSPush = [[PFPush alloc] init];
[iOSPush setMessage:@"Your suitcase has been filled with tiny apples!"];
[iOSPush setChannel:@"suitcaseOwners"];
[iOSPush setQuery:query];
[iOSPush sendPushInBackground];
 
// Notification for Windows 8 users
[query whereKey:@"deviceType" equalTo:@"winrt"];
PFPush *winPush = [[PFPush alloc] init];
[winPush setMessage:@"Your suitcase has been filled with tiny glass!"];
[winPush setQuery:query];
[winPush sendPushInBackground];
 
// Notification for Windows 8 users
[query whereKey:@"deviceType" equalTo:@"winphone"];
PFPush *winPush = [[PFPush alloc] init];
[wpPush setMessage:@"Your suitcase is very hip; very metro."];
[wpPush setQuery:query];
[wpPush sendPushInBackground];</pre></div></div></div>
<div class="section" title="Receiving push notifications"><div class="titlepage"><div><div><h1 class="title"><a id="ch05lvl1sec35"/>Receiving push notifications</h1></div></div></div><p>When<a id="id145" class="indexterm"/> you receive a customized notification, you can retrieve the associated data from your notification. This data can help in modifying the behavior of the application as per the notification. For example, if the notification is sent because of the comment on the post, you can directly open the post for that comment by reading the push notification data.</p><p>Apple has a package size restriction, so it is recommended to keep your data size as small as possible:</p><div class="informalexample"><pre class="programlisting">NSDictionary *data = @{
  @"alert": @"James commented on your photo!",
  @"p": @"vmRZXZ1Dvo" // Photo's object id
};
PFPush *push = [[PFPush alloc] init];
[push setQuery:photoOwnerQuery];
[push setData:data];
[push sendPushInBackground];</pre></div></div>
<div class="section" title="Responding to payload"><div class="titlepage"><div><div><h1 class="title"><a id="ch05lvl1sec36"/>Responding to payload</h1></div></div></div><p>If<a id="id146" class="indexterm"/> your application is launched using the notification, you can access the data from the <code class="literal">[application:didFinishLaunchingWithOptions:]</code> method through the <code class="literal">launchOptions</code> dictionary:</p><div class="informalexample"><pre class="programlisting">- (BOOL)application:(UIApplication *)application didFinishLaunchingWithOptions:(NSDictionary *)launchOptions {
  . . .
  // Extract the notification data
  NSDictionary *notificationPayload = launchOptions[UIApplicationLaunchOptionsRemoteNotificationKey];
 
  // Create a pointer to the Post object
  NSString *postId = [notificationPayload objectForKey:@"p"];
  PFObject *targetPost = [PFObject objectWithoutDataWithClassName:@"Post"objectId:postId];
 
  // Fetch photo object
  [targetPhoto fetchIfNeededInBackgroundWithBlock:^(PFObject *object, NSError *error) {
    // Show post view controller
    if (!error &amp;&amp; [PFUser currentUser]) {
      PostVC *viewController = [[PostVC alloc] initWithPost:object];
      [self.navController pushViewController:viewController animated:YES];
    }
  }];
}</pre></div><p>If your <a id="id147" class="indexterm"/>application is already running in foreground mode, the data can be fetched from the <code class="literal">[application:didRegisterForRemoteNotificationsWithDeviceToken:]</code> method in the <code class="literal">userInfo</code> dictionary:</p><div class="informalexample"><pre class="programlisting">- (void)application:(UIApplication *)application didReceiveRemoteNotification:(NSDictionary *)userInfo {
  // Create empty post object
  NSString *postId = [userInfo objectForKey:@"p"];
  PFObject *targetPost = [PFObject objectWithoutDataWithClassName:@"Post"objectId:postId];
 
  // Fetch photo object
  [targetPhoto fetchIfNeededInBackgroundWithBlock:^(PFObject *object, NSError *error) {
    // Show photo view controller
    if (!error &amp;&amp; [PFUser currentUser]) {
      PostVC *viewController = [[PostVC alloc] initWithPost:object];
      [self.navController pushViewController:viewController animated:YES];
    }
  }];
}</pre></div></div>
<div class="section" title="Summary"><div class="titlepage"><div><div><h1 class="title"><a id="ch05lvl1sec37"/>Summary</h1></div></div></div><p>In this chapter, we explored the setup and installation of push notifications in our application.</p><p>We started by setting up push notifications on the Apple developer portal and necessary installation in codebase.</p><p>Then, we learned about sending the push notifications and their scheduling.</p><p>Finally, we saw the ways to receive payload from the notifications.</p><p>In the next chapter, we will learn about Parse users and their roles.</p></div></body></html>