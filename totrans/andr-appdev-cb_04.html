<html><head></head><body><div><div><div><div><h1 class="title"><a id="ch04"/>Chapter 4. Menus</h1></div></div></div><p>In this chapter, we will cover the following topics:</p><div><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">Creating an Options menu</li><li class="listitem" style="list-style-type: disc">Modifying menus and menu items during runtime</li><li class="listitem" style="list-style-type: disc">Enabling Contextual Action Mode for a view</li><li class="listitem" style="list-style-type: disc">Using Contextual Batch Mode with a ListView</li><li class="listitem" style="list-style-type: disc">Creating a pop-up menu</li></ul></div><div><div><div><div><h1 class="title"><a id="ch04lvl1sec34"/>Introduction</h1></div></div></div><p>The Android OS is an ever-changing environment. The earliest Android devices (prior to Android 3.0), were required to have a hardware menu button. Though a hardware button is no longer required, menus are no less important. In fact, the <strong>Menu</strong> API<a id="id178" class="indexterm"/> has expanded to now support three different types of menus:</p><div><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><strong>Options Menu and Action Bar</strong>: This is the standard menu, which is used for global options <a id="id179" class="indexterm"/>of your application. Use this for additional features <a id="id180" class="indexterm"/>such as search, settings, and so on.</li><li class="listitem" style="list-style-type: disc"><strong>Contextual</strong> <strong>Mode</strong> (<strong>Contextual Action Mode</strong>): This is <a id="id181" class="indexterm"/>generally activated by long press. (Think of this as similar to a right-click on the desktop.) This is used to take an action on the pressed item, such as replying to an e-mail or deleting a file.</li><li class="listitem" style="list-style-type: disc"><strong>Pop-up</strong> <strong>Menu</strong>: This <a id="id182" class="indexterm"/>provides a pop-up selection (like a spinner) for an additional action. The menu options are not meant to affect the item pressed, instead use Contextual Mode as described previously. An example would be hitting the share button and getting an additional list of share options.</li></ul></div><p>Menu resources are similar to other Android UI components; they are generally created in XML, but can be created in code as well. Our first recipe, as shown in the following section, will show the XML menu format and how to inflate it.</p></div></div>
<div><div><div><div><h1 class="title"><a id="ch04lvl1sec35"/>Creating an Options menu</h1></div></div></div><p>Before<a id="id183" class="indexterm"/> we actually create and display a menu, let's look at a menu to see the end result. The following is a screenshot showing the menu section of Chrome:</p><div><img src="img/B05057_04_01.jpg" alt="Creating an Options menu"/></div><p>The most obvious feature to note is that the menu will look different based on the screen size. By default, menu items will be added to the Overflow menu—that's the menu you see when you press the three dots at the far right edge. </p><p>Menus are typically created in resource files using <code class="literal">XML</code> (like many other Android resources) but they are stored in the <code class="literal">res/menu</code> directory though they can also be created in code. To create a menu resource, use the <code class="literal">&lt;menu&gt;</code> element as shown:</p><div><pre class="programlisting">&lt;menu &gt;
&lt;/menu&gt;</pre></div><p>The <code class="literal">&lt;item&gt;</code> element defines each individual menu item and is enclosed in the <code class="literal">&lt;menu&gt;</code> element. A basic menu item looks as follows:</p><div><pre class="programlisting">&lt;item 
    android:id="@+id/settings"
    android:title="@string/settings" /&gt;</pre></div><p>The most common <code class="literal">&lt;item&gt;</code> attributes are the following:</p><div><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><code class="literal">id</code>: This is the standard resource identifier</li><li class="listitem" style="list-style-type: disc"><code class="literal">title</code>: This indicates the text to display</li><li class="listitem" style="list-style-type: disc"><code class="literal">icon</code>: This is a draw-able resource</li><li class="listitem" style="list-style-type: disc"><code class="literal">showAsAction</code>: This has been explained as follows (<em>see the following paragraph</em>)</li><li class="listitem" style="list-style-type: disc"><code class="literal">enabled</code>: This is enabled by default</li></ul></div><p>Let's look at <code class="literal">showAsAction</code> in more detail.</p><p>The <code class="literal">showAsAction</code> attribute controls how the menu item is shown. The options include the following:</p><div><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><code class="literal">ifRoom</code>: This menu item should be included in the Action Bar if there's enough space</li><li class="listitem" style="list-style-type: disc"><code class="literal">withText</code>: This indicates that both the title and the icon should be shown</li><li class="listitem" style="list-style-type: disc"><code class="literal">never</code>: This indicates that the menu item should never be included in the Action Bar; always show in the overflow menu</li><li class="listitem" style="list-style-type: disc"><code class="literal">always</code>: This indicates that the menu item should be always included in the Action Bar (use sparingly as space is limited)<div><div><h3 class="title"><a id="note10"/>Note</h3><p>Multiple options can be combined using the pipe (|) separator, such as <code class="literal">showAsAction="ifRoom|withText"</code>.</p></div></div></li></ul></div><p>With<a id="id184" class="indexterm"/> the fundamentals of the menu resource covered, we are now ready to create a standard Options menu and inflate it.</p><div><div><div><div><h2 class="title"><a id="ch04lvl2sec108"/>Getting ready</h2></div></div></div><p>Use Android Studio to create a new project called <code class="literal">OptionsMenu</code>. Use the default <strong>Phone &amp; Tablet </strong>option and select the <strong>Empty Activity</strong> option when prompted for the Activity Type. Since the wizard does not create the <code class="literal">res/menu</code> folder by default, navigate to <strong>File</strong> | <strong>New | Directory</strong> to create it before continuing.</p></div><div><div><div><div><h2 class="title"><a id="ch04lvl2sec109"/>How to do it... </h2></div></div></div><p>With the new project created as described in the preceding section, you are ready to create a menu. However, first, we will add a string resource to the <code class="literal">strings.xml</code> file for the menu title. We will use the new string for the menu title when we create the XML for the menu. Here are the steps:</p><div><ol class="orderedlist arabic"><li class="listitem">Start by opening the <code class="literal">strings.xml</code> file and add the following <code class="literal">&lt;string&gt;</code> element to the <code class="literal">&lt;resources&gt;</code> element:<div><pre class="programlisting">&lt;string name="menu_settings"&gt;Settings&lt;/string&gt;</pre></div></li><li class="listitem">Create a new file in the <code class="literal">res/menu</code> directory and call it <code class="literal">menu_main.xml</code>.</li><li class="listitem">Open the <code class="literal">menu_main.xml</code> file and add the following XML to define the menu:<div><pre class="programlisting">&lt;?xml version="1.0" encoding="utf-8"?&gt;
&lt;menu
    
    &gt;
    &lt;item android:id="@+id/menu_settings"
        android:title="@string/menu_settings"
        app:showAsAction="never"&gt;
    &lt;/item&gt;
&lt;/menu&gt;</pre></div></li><li class="listitem">With the menu now created, we just have to override the <code class="literal">onCreateOptionsMenu()</code> method in <code class="literal">ActivityMain.java</code> to inflate the menu:<div><pre class="programlisting">@Override
public boolean onCreateOptionsMenu(Menu menu) {
    getMenuInflater().inflate(R.menu.menu_main, menu);
    return true;
}</pre></div></li><li class="listitem">Run the program on a device or emulator to see the menu in the Action Bar.</li></ol></div></div><div><div><div><div><h2 class="title"><a id="ch04lvl2sec110"/>How it works...</h2></div></div></div><p>There<a id="id185" class="indexterm"/> are two basic steps here:</p><div><ol class="orderedlist arabic"><li class="listitem">Define the menu in XML.</li><li class="listitem">Inflate the menu when the activity is created.</li></ol></div><p>As a good programming habit, we define the string in the <code class="literal">strings.xml</code> file rather than hardcoding it in the <code class="literal">XML</code>. We then use the standard Android string identifier to set the title for the menu in Step 3. Since this is a "Settings" menu item, we don't want this to be shown in the Action Bar. To make sure it is never shown, use <code class="literal">showAsAction="never"</code>.</p><p>With the menu defined, we will use the menu inflater in Step 4 to load the menu during the Activity creation. Notice the <code class="literal">R.menu.menu_main</code> menu resource syntax? This is why we create the XML in the <code class="literal">res/menu</code> directory — so the system will know this is a menu resource.</p><p>In Step 4, we used <code class="literal">app:showAsAction</code> rather than Android: <code class="literal">android:showAsAction</code>. This is because we are using the <code class="literal">AppCompat</code> library (also referred to as the Android Support Library). By default, the Android Studio new project wizard includes the support library in the project.</p></div><div><div><div><div><h2 class="title"><a id="ch04lvl2sec111"/>There's more...</h2></div></div></div><p>If you ran the program in Step 5, then you must have seen the <strong>Settings</strong> menu item when you pressed the menu overflow button. But that was it. Nothing else happened. Obviously, menu items aren't very useful if the application doesn't respond to them. Responding to the <strong>Options</strong> menu is done through the <code class="literal">onOptionsItemSelected()</code> callback. </p><p>Add the following method to the application to see a Toast when the Settings menu is selected:</p><div><pre class="programlisting">@Override
public boolean onOptionsItemSelected(MenuItem item) {
    if (item.getItemId() == R.id.menu_settings) {
        Toast.makeText(this, "Settings", Toast.LENGTH_LONG).show();
    } else {
        return super.onContextItemSelected(item);
    }
    return true;
}</pre></div><p>That's it. You now have a working menu!</p><div><div><h3 class="title"><a id="tip11"/>Tip</h3><p>As shown in the preceding example, return <code class="literal">true</code> when you've handled the callback; otherwise, call the super class as shown in the <code class="literal">else</code> statement.</p></div></div><div><div><div><div><h3 class="title"><a id="ch04lvl3sec04"/>Using a menu item to launch an activity</h3></div></div></div><p>In this example, we show a Toast so we<a id="id186" class="indexterm"/> can see a working example; however, we could<a id="id187" class="indexterm"/> just as easily launch a new activity if needed. As you did in the <em>Starting a new activity with an Intent object</em> recipe of <a class="link" href="ch01.html" title="Chapter 1. Activities">Chapter 1</a>, <em>Activities</em>, create an Intent and call it with <code class="literal">startActivity()</code>.</p></div><div><div><div><div><h3 class="title"><a id="ch04lvl3sec05"/>Creating sub menus</h3></div></div></div><p>
<strong>Sub menus</strong> <a id="id188" class="indexterm"/>are created and accessed in almost exactly the same manner as other menu elements and can be placed in any of the provided menus, although they cannot be placed within other sub menus. To define a sub menu, include a <code class="literal">&lt;menu&gt;</code> element within an <code class="literal">&lt;item&gt;</code> element. Here is the XML form this recipe with two sub menu items added:</p><div><pre class="programlisting">&lt;?xml version="1.0" encoding="utf-8"?&gt;
&lt;menu
    
    &gt;
    &lt;item android:id="@+id/menu_settings
        android:title="@string/menu_settings"
        app:showAsAction="never"&gt;
        &lt;menu&gt;
            &lt;item android:id="@+id/menu_sub1"
                android:title="Storage Settings" /&gt;
            &lt;item android:id="@+id/menu_sub2"
                android:title="Screen Settings" /&gt;
        &lt;/menu&gt;
    &lt;/item&gt;
&lt;/menu&gt;</pre></div></div><div><div><div><div><h3 class="title"><a id="ch04lvl3sec06"/>Grouping menu items</h3></div></div></div><p>Another menu<a id="id189" class="indexterm"/> feature that Android supports is grouping menu items. Android provides several methods for groups, including the following:</p><div><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><code class="literal">setGroupVisible()</code>: Show or hide all items</li><li class="listitem" style="list-style-type: disc"><code class="literal">setGroupEnabled()</code>: Enable or disable all items</li><li class="listitem" style="list-style-type: disc"><code class="literal">setGroupCheckable()</code>: Set the checkable behavior</li></ul></div><div><div><h3 class="title"><a id="tip12"/>Tip</h3><p>Android will keep all grouped items with <code class="literal">showAsAction="ifRoom"</code> together. This means all items in the group with <code class="literal">showAsAction="ifRoom" </code>will be in the Action Bar or all items will be in the overflow.</p></div></div><p>To create a group, add the <code class="literal">&lt;item&gt;</code> menu elements to a <code class="literal">&lt;group&gt;</code> element. Here is an example using the menu XML from this recipe with two additional items in a group:</p><div><pre class="programlisting">&lt;?xml version="1.0" encoding="utf-8"?&gt;
&lt;menu
    
    &gt;

    &lt;group android:id="@+id/group_one" &gt;
        &lt;item android:id="@+id/menu_item1"
            android:title="Item 1"
            app:showAsAction="ifRoom"/&gt;
        &lt;item android:id="@+id/menu_item2"
            android:title="Item 2"
            app:showAsAction="ifRoom"/&gt;
    &lt;/group&gt;
    &lt;item android:id="@+id/menu_settings"
        android:title="@string/menu_settings"
        app:showAsAction="never"/&gt;
&lt;/menu&gt;</pre></div></div></div><div><div><div><div><h2 class="title"><a id="ch04lvl2sec112"/>See also</h2></div></div></div><div><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">For complete details on the menu, visit the Android Developer Menu Resources site<a id="id190" class="indexterm"/> at <a class="ulink" href="http://developer.android.com/guide/topics/resources/menu-resource.html">http://developer.android.com/guide/topics/resources/menu-resource.html</a></li></ul></div></div></div>
<div><div><div><div><h1 class="title"><a id="ch04lvl1sec36"/>Modifying menus and menu items during runtime</h1></div></div></div><p>Though it's<a id="id191" class="indexterm"/> been stated many times, it's considered the "best" programming <a id="id192" class="indexterm"/>practice to create UI in XML rather than in Java. There are still times when you may need to do it in code. This is especially true if you wanted a menu item to be visible (or enabled) based on some external criteria. Menus can also be included in resource folders, but there are times when you need code to perform the logic. One example might be if you wanted to offer an upload menu item only if the user is logged in to your app.</p><p>In this recipe, we will create and modify the menu only through code.</p><div><div><div><div><h2 class="title"><a id="ch04lvl2sec113"/>Getting ready</h2></div></div></div><p>Create a new project in Android Studio and call it <code class="literal">RuntimeMenu</code> using the default <strong>Phone &amp; Tablet</strong> option. Select the <strong>Empty Activity</strong> option when prompted to add an Activity. Since we will create and modify the menu completely in code, we will not need to create a <code class="literal">res/menu</code> directory.</p></div><div><div><div><div><h2 class="title"><a id="ch04lvl2sec114"/>How to do it...</h2></div></div></div><p>To start, we will add string resources for our menu items and a button to toggle the menu visibility. Open the <code class="literal">res/strings.xml</code> file and follow these steps:</p><div><ol class="orderedlist arabic"><li class="listitem">Add the following two strings to the existing <code class="literal">&lt;resources&gt;</code> element:<div><pre class="programlisting">&lt;string name="menu_download"&gt;Download&lt;/string&gt;
&lt;string name="menu_settings"&gt;Settings&lt;/string&gt;</pre></div></li><li class="listitem">Add a button to <code class="literal">activity_main.xml</code> with <code class="literal">onClick()</code> set to <code class="literal">toggleMenu</code> as shown here:<div><pre class="programlisting">&lt;Button
    android:id="@+id/buttonToggleMenu"
    android:layout_width="wrap_content"
    android:layout_height="wrap_content"
    android:text="Toggle Menu"
    android:layout_centerVertical="true"
    android:layout_centerHorizontal="true"
    android:onClick="toggleMenu"/&gt;</pre></div></li><li class="listitem">Open <code class="literal">ActivityMain.java</code> and add the following three lines of code just below the class declaration:<div><pre class="programlisting">private final int MENU_DOWNLOAD = 1;
private final int MENU_SETTINGS = 2;
private boolean showDownloadMenu = false;</pre></div></li><li class="listitem">Add the following method for the button to call:<div><pre class="programlisting">public void toggleMenu(View view) {
    showDownloadMenu=!showDownloadMenu;
}</pre></div></li><li class="listitem">When the activity is first created, Android calls <code class="literal">onCreateOptionsMenu()</code> to create the menu. Here is the code to dynamically build the menu:<div><pre class="programlisting">@Override
public boolean onCreateOptionsMenu(Menu menu) {
    menu.add(0, MENU_DOWNLOAD, 0, R.string.menu_download);
    menu.add(0, MENU_SETTINGS, 0, R.string.menu_settings);
    return true;
}</pre></div></li><li class="listitem">For best <a id="id193" class="indexterm"/>programming <a id="id194" class="indexterm"/>practice, don't use <code class="literal">onCreateOptionsMenu()</code> to update or change your menu; instead, use <code class="literal">onPrepareOptionsMenu()</code>. Here is the code to change the visibility of the <strong>Download</strong> menu item based on our flag:<div><pre class="programlisting">@Override
public boolean onPrepareOptionsMenu(Menu menu) {
    MenuItem menuItem = menu.findItem(MENU_DOWNLOAD);
    menuItem.setVisible(showDownloadMenu);
    return true;
}</pre></div></li><li class="listitem">Though not technically required for this recipe, this <code class="literal">onOptionsItemSelected()</code> code shows how to respond to each menu item:<div><pre class="programlisting">@Override
public boolean onOptionsItemSelected(MenuItem item) {
    switch (item.getItemId()) {
        case MENU_DOWNLOAD:
            Toast.makeText(this, R.string.menu_download, Toast.LENGTH_LONG).show();
            break;
        case MENU_SETTINGS:
            Toast.makeText(this, R.string.menu_settings, Toast.LENGTH_LONG).show();
            break;
        default:
            return super.onContextItemSelected(item);
    }
    return true;
}</pre></div></li><li class="listitem">Run the program on a device or emulator to see the menu changes.</li></ol></div></div><div><div><div><div><h2 class="title"><a id="ch04lvl2sec115"/>How it works...</h2></div></div></div><p>We created an override for <code class="literal">onCreateOptionsMenu()</code>, just like we did in the previous recipe, <em>Creating an Options Menu</em>. But instead of inflating an existing menu resource, we created the menu using the <code class="literal">Menu.add()</code> method. Since we want to modify the menu items later as well as respond to the menu item events, we have defined our own menu IDs and passed them to the <code class="literal">add()</code> method. </p><p>
<code class="literal">onOptionsItemSelected()</code> is called for all the menu items, so we get the menu ID and use a <code class="literal">switch</code> statement based on the IDs we created. We return <code class="literal">true</code> if we are handling the menu event, otherwise we pass the event to the super class.</p><p>Changing the <a id="id195" class="indexterm"/>menu occurs in the <code class="literal">onPrepareOptionsMenu()</code> method. To <a id="id196" class="indexterm"/>simulate an external event, we created a button to toggle a Boolean flag. The visibility of the <strong>Download</strong> menu is determined by the flag. This is where you would want to create your custom code based on whatever criteria you set. Your flag could be set using the current player level or maybe when a new level is ready for release; you send a Push message, which enables the menu item.</p></div><div><div><div><div><h2 class="title"><a id="ch04lvl2sec116"/>There's more...</h2></div></div></div><p>What if we wanted this <strong>Download</strong> option to be easily noticed to indicate whether it's available? We could tell Android we want the menu in the Action Bar by adding the following code to <code class="literal">onPrepareOptionsMenu()</code> (before the return statement):</p><div><pre class="programlisting">menuItem.setShowAsAction(MenuItem.SHOW_AS_ACTION_ALWAYS);</pre></div><p>Now if you run the code, you will see the <strong>Download</strong> menu item in the Action Bar, but the behavior isn't correct.</p><p>Earlier, when we didn't have a menu item in the Action Bar, Android called <code class="literal">onPrepareOptionsMenu()</code> each time we opened the overflow menu so the visibility was always updated. To correct this behavior, add the following line of code to the <code class="literal">toggleMenu()</code> method called by the button:</p><div><pre class="programlisting">invalidateOptionsMenu();</pre></div><p>The <code class="literal">invalidateOptionsMenu()</code> call tells Android that our option menu is no longer valid, which then forces a call to <code class="literal">onPrepareOptionsMenu()</code> giving us the behavior we expect.</p><div><div><h3 class="title"><a id="note11"/>Note</h3><p>Android considers the menu as always open if a menu item is displayed in the Action Bar.</p></div></div></div></div>
<div><div><div><div><h1 class="title"><a id="ch04lvl1sec37"/>Enabling Contextual Action Mode for a view</h1></div></div></div><p>A Context Menu <a id="id197" class="indexterm"/>provides additional options related to <a id="id198" class="indexterm"/>a specific view—the same concept as a right-click on the desktop. Android currently supports two different approaches: the floating Context Menu and Contextual Mode. Contextual Action Mode was introduced in Android 3.0. The older floating Context Menu could lead to confusion since there was no indication of the currently selected item and it didn't support actions on multiple items—such as selecting multiple emails to delete in one action.</p><div><div><div><div><h2 class="title"><a id="ch04lvl2sec117"/>Creating a Floating Context Menu</h2></div></div></div><p>If you need to use <a id="id199" class="indexterm"/>the old style Context Menu, for example, to support preAndroid 3.0 devices, it's very similar to the Option Menu API, just different method names. To create the menu, use <code class="literal">onCreateContextMenu()</code> instead of <code class="literal">onCreateOptionsMenu()</code>. To handle the menu item selection, use <code class="literal">onContextItemSelected()</code> instead of <code class="literal">onOptionsItemSelected()</code>. Finally, call <code class="literal">registerForContextMenu()</code> to let the system know you want Context Menu events for the view.</p><p>Since Contextual Mode is considered the preferred way to display context options, this recipe will focus on the newer API. Contextual Mode offers the same features as the floating Context Menu, but also adds additional functionality by allowing multiple item selection when using batch mode.</p><p>This recipe will demonstrate the setup of Contextual Mode for a single view. Once activated, with a long press, a <strong>Contextual Action Bar</strong> (<strong>CAB</strong>)<a id="id200" class="indexterm"/> will replace the Action Bar until Contextual Mode is finished.</p><div><div><h3 class="title"><a id="note12"/>Note</h3><p>The Contextual Action Bar is not the same as the Action Bar and your activity does not need to include an Action Bar.</p></div></div></div><div><div><div><div><h2 class="title"><a id="ch04lvl2sec118"/>Getting ready</h2></div></div></div><p>Use Android Studio to create a new project and call it <code class="literal">ContextualMode</code>. Use the default <strong>Phone &amp; Tablet </strong>option and select <strong>Empty Activity</strong> when prompted to add an Activity. Create a menu directory (<code class="literal">res/menu</code>) as we did in the first recipe, <em>Creating an Options menu</em>, to store the XML for the contextual menu.</p></div><div><div><div><div><h2 class="title"><a id="ch04lvl2sec119"/>How to do it...</h2></div></div></div><p>We will create an <strong>ImageView</strong>
<a id="id201" class="indexterm"/> to serve as the host view to initialize Contextual Mode. Since Contextual Mode is usually triggered with a long press, we will set up a long click listener in <code class="literal">onCreate()</code> for the <code class="literal">ImageView</code>. When called, we will start Contextual Mode and pass an <code class="literal">ActionMode</code> callback to handle the Contextual Mode events. Here are the steps:</p><div><ol class="orderedlist arabic"><li class="listitem">We will start by<a id="id202" class="indexterm"/> adding two new string <a id="id203" class="indexterm"/>resources. Open the <code class="literal">strings.xml</code> file and add the following:<div><pre class="programlisting">&lt;string name="menu_cast"&gt;Cast&lt;/string&gt;
&lt;string name="menu_print"&gt;Print&lt;/string&gt;</pre></div></li><li class="listitem">With the strings created, we can now create the menu by creating a new file in <code class="literal">res/menu</code> called <code class="literal">context_menu.xml</code> using the following XML:<div><pre class="programlisting">&lt;?xml version="1.0" encoding="utf-8"?&gt;
&lt;menu
    
    &gt;
&lt;item android:id="@+id/menu_cast"
    android:title="@string/menu_cast" /&gt;
&lt;item android:id="@+id/menu_print"
    android:title="@string/menu_print" /&gt; &lt;/menu&gt;</pre></div></li><li class="listitem">Now add an <code class="literal">ImageView</code> to <code class="literal">activity_main.xml</code> to serve as the source for initiating Contextual Mode. Here is the XML for the ImageView:<div><pre class="programlisting">&lt;ImageView
    android:id="@+id/imageView"
    android:layout_width="wrap_content"
    android:layout_height="wrap_content"
    android:layout_centerVertical="true"
    android:layout_centerHorizontal="true"
    android:src="img/ic_launcher"/&gt;</pre></div></li><li class="listitem">With the UI now set up, we can add the code for Contextual Mode. First, we need a global variable to store the <code class="literal">ActionMode</code> instance returned when we call <code class="literal">startActionMode()</code>. Add the following line of code to <code class="literal">MainActivity.java</code> below the class constructor:<div><pre class="programlisting">ActionMode mActionMode;</pre></div></li><li class="listitem">Next, create an <code class="literal">ActionMode</code> callback to pass to <code class="literal">startActionMode().</code> Add the following code to the <code class="literal">MainActivity</code> class below the code in the previous step:<div><pre class="programlisting">private ActionMode.Callback mActionModeCallback = new ActionMode.Callback() {
    @Override
    public boolean onCreateActionMode(ActionMode mode, Menu menu) {
        mode.getMenuInflater().inflate(R.menu.context_menu, menu);
        return true;
    }
    @Override
    public boolean onPrepareActionMode(ActionMode mode, Menu menu) {
        return false;
    }
    @Override
    public boolean onActionItemClicked(ActionMode mode, MenuItem item) {
        switch (item.getItemId()) {
            case R.id. menu_cast:
                Toast.makeText(MainActivity.this, "Cast", Toast.LENGTH_SHORT).show();
                mode.finish();
                return true;
            case R.id. menu_print:
                Toast.makeText(MainActivity.this, "Print", Toast.LENGTH_SHORT).show();
                mode.finish();
                return true;
            default:
                return false;
        }
    }
    @Override
    public void onDestroyActionMode(ActionMode mode) {
        mActionMode = null;
    }
};</pre></div></li><li class="listitem">With<a id="id204" class="indexterm"/> the <code class="literal">ActionMode</code> callback created, we <a id="id205" class="indexterm"/>just need to call <code class="literal">startActionMode()</code> to begin Contextual Mode. Add the following code to the <code class="literal">onCreate()</code> method to set up the long click listener:<div><pre class="programlisting">ImageView imageView = (ImageView)findViewById(R.id.imageView);
imageView.setOnLongClickListener(new View.OnLongClickListener() {
    public boolean onLongClick(View view) {
        if (mActionMode != null) return false;
        mActionMode = startActionMode(mActionModeCallback);
        return true;
    }
});</pre></div></li><li class="listitem">Run the program on a device or emulator to see the CAB in action.</li></ol></div></div><div><div><div><div><h2 class="title"><a id="ch04lvl2sec120"/>How it works...</h2></div></div></div><p>As you saw in <a id="id206" class="indexterm"/>Step 2, we have used the same menu XML to define the contextual menu as the other menus.</p><p>The main piece of code to understand is the <code class="literal">ActionMode</code> callback. This is where we handle the Contextual Mode events: initializing the menu, handling menu item selections, and cleaning up. We start Contextual Mode in the long press event with a call to <code class="literal">startActionMode()</code> by passing in the <code class="literal">ActionMode</code> callback created in Step 5.</p><p>When action mode is<a id="id207" class="indexterm"/> triggered, the system calls the <code class="literal">onCreateActionMode()</code> callback, which inflates the menu and displays it in the Contextual Action Bar. The user can dismiss the Contextual Action Bar by pressing the back arrow or the back key. The CAB is also dismissed when the user makes a menu selection. We show a Toast to give a visual feedback for this recipe but this is where you would implement your functionality.</p></div><div><div><div><div><h2 class="title"><a id="ch04lvl2sec121"/>There's more...</h2></div></div></div><p>In this example, we store the <code class="literal">ActionMode</code> returned from the <code class="literal">startActionMode()</code> call. We use it to prevent a new instance from being created when the Action Mode is already active. We could also use this instance to make changes to the Contextual Action Bar itself, such as changing the title with the following:</p><div><pre class="programlisting">mActionMode.setTitle("New Title");</pre></div><p>This is particularly useful when working with multiple item selections as we'll see in the next recipe.</p></div><div><div><div><div><h2 class="title"><a id="ch04lvl2sec122"/>See also</h2></div></div></div><div><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">See the next recipe, <em>Using Contextual Batch Mode with a ListView</em>, to work with multiple items selection</li></ul></div></div></div>
<div><div><div><div><h1 class="title"><a id="ch04lvl1sec38"/>Using Contextual Batch Mode with a ListView</h1></div></div></div><p>As discussed<a id="id208" class="indexterm"/> in the previous recipe, Contextual<a id="id209" class="indexterm"/> Mode supports two forms of use: single View mode (as demonstrated) and multiple selection (or batch) mode. Batch mode is where Contextual Mode outperforms the old style Context Menu as multiple selections were not supported.</p><p>If you've ever used an e-mail app such as Gmail or a file browser, you've probably seen Contextual Mode when selecting multiple items. Here is a screenshot from Solid Explorer, which shows an excellent implementation of Material Theme and Contextual Mode:</p><div><img src="img/B05057_04_02.jpg" alt="Using Contextual Batch Mode with a ListView"/></div><p>In this recipe, we <a id="id210" class="indexterm"/>will create a <code class="literal">ListView</code> populated with <a id="id211" class="indexterm"/>multiple country names to demonstrate multiple selections or batch mode. This example will use the normal long press event and also the item click event to start Contextual Mode.</p><div><div><div><div><h2 class="title"><a id="ch04lvl2sec123"/>Getting ready</h2></div></div></div><p>Create a new project in Android Studio and call it <code class="literal">ContextualBatchMode</code>. Use the default <strong>Phone &amp; Tablet </strong>option and select <strong>Empty Activity</strong> when prompted to add an Activity. Create a menu directory (<code class="literal">res/menu</code>) for the contextual menu.</p></div><div><div><div><div><h2 class="title"><a id="ch04lvl2sec124"/>How to do it...</h2></div></div></div><p>Similar to the<a id="id212" class="indexterm"/> previous recipe, we start by creating a<a id="id213" class="indexterm"/> menu in XML to inflate when Contextual Mode begins. We need to define <code class="literal">MultiChoiceModeListener</code> to handle batch mode with the <code class="literal">ListView</code>. We then set up the <code class="literal">ListView</code> to allow multiple selections and pass in the <code class="literal">MultiChoiceModeListener</code>. Here are the steps:</p><div><ol class="orderedlist arabic"><li class="listitem">Open the <code class="literal">strings.xml</code> file and add two new string resources for the menu items as follows:<div><pre class="programlisting">&lt;string name="menu_move"&gt;Move&lt;/string&gt;
&lt;string name="menu_delete"&gt;Delete&lt;/string&gt;</pre></div></li><li class="listitem">Create a new file called <code class="literal">contextual_menu.xml</code> in the <code class="literal">res/menu</code> folder with the following XML:<div><pre class="programlisting">&lt;?xml version="1.0" encoding="utf-8"?&gt;
&lt;menu
    
    &gt;
    &lt;item android:id="@+id/menu_move"
        android:title="@string/menu_move" /&gt;
    &lt;item android:id="@+id/menu_delete
        android:title="@string/menu_delete" /&gt;
&lt;/menu&gt;</pre></div></li><li class="listitem">Since we need a <code class="literal">ListView</code>, we will change <code class="literal">MainActivity</code> to extend from <code class="literal">ListActivity</code> as follows:<div><pre class="programlisting">public class MainActivity extends ListActivity</pre></div></li><li class="listitem">Create a <code class="literal">MultiChoiceModeListener</code> to handle the Contextual Action Bar events. Add the following code to <code class="literal">MainActivity.java</code> below the class constructor:<div><pre class="programlisting">AbsListView.MultiChoiceModeListener mMultiChoiceModeListener = new AbsListView.MultiChoiceModeListener() {
    @Override
    public void onItemCheckedStateChanged(ActionMode mode, int position, long id, boolean checked) {
    }

    @Override
    public boolean onCreateActionMode(ActionMode mode, Menu menu) {
        // Inflate the menu for the CAB
        MenuInflater inflater = mode.getMenuInflater();
        inflater.inflate(R.menu.contextual_menu, menu);
        return true;
    }

    @Override
    public boolean onPrepareActionMode(ActionMode mode, Menu menu) {
        return false;
    }

    @Override
    public boolean onActionItemClicked(ActionMode mode, MenuItem item) {
        // Handle menu selections
        switch (item.getItemId()) {
            case R.id.menu_move
                Toast.makeText(MainActivity.this, "Move", Toast.LENGTH_SHORT).show();
                mode.finish();
                return true;
            case R.id.menu_delete
                Toast.makeText(MainActivity.this, "Delete", Toast.LENGTH_SHORT).show();
                mode.finish();
                return true;
            default:
                return false;
        }
    }

    @Override
    public void onDestroyActionMode(ActionMode mode) {
    }
};</pre></div></li><li class="listitem">Next, we <a id="id214" class="indexterm"/>will change the <code class="literal">onCreate()</code> to set<a id="id215" class="indexterm"/> up the <code class="literal">ListView</code> and populate a <code class="literal">ListAdapter</code> using a string array of country names, as follows:<div><pre class="programlisting">@Override
protected void onCreate(Bundle savedInstanceState) {
    super.onCreate(savedInstanceState);

    String[] countries = new String[]{"China", "France", "Germany", "India", "Russia", "United Kingdom", "United States"};
    ListAdapter countryAdapter = new ArrayAdapter&lt;String&gt;(this, android.R.layout.simple_list_item_checked, countries);
    setListAdapter(countryAdapter);
    getListView().setChoiceMode(ListView.CHOICE_MODE_MULTIPLE_MODAL);
    getListView().setMultiChoiceModeListener(mMultiChoiceModeListener);

    getListView().setOnItemClickListener(new AdapterView.OnItemClickListener() {
        @Override
        public void onItemClick(AdapterView&lt;?&gt; parent, View view, int position, long id) {
            ((ListView)parent).setItemChecked(position, true);
        }
    });
}</pre></div></li><li class="listitem">Run the program on a device or emulator to see the CAB in action.</li></ol></div></div><div><div><div><div><h2 class="title"><a id="ch04lvl2sec125"/>How it works...</h2></div></div></div><p>The three key <a id="id216" class="indexterm"/>elements to make Action Mode work in <a id="id217" class="indexterm"/>batch mode are:</p><div><ol class="orderedlist arabic"><li class="listitem">Creating a Contextual Menu to inflate</li><li class="listitem">Defining <code class="literal">MultiChoiceModeListener</code> to pass to <code class="literal">setMultiChoiceModeListener()</code></li><li class="listitem">Set <code class="literal">ChoiceMode</code> of the <code class="literal">ListView</code> to <code class="literal">CHOICE_MODE_MULTIPLE_MODAL</code>.</li></ol></div><p>
<code class="literal">MultiChoiceModeListener</code> serves the same purpose as the <code class="literal">ActionMode</code> callback used in single-view Contextual Mode, and in fact, implements <code class="literal">ActionMode.Callback</code>. As with <code class="literal">ActionMode.Callback</code>, the menu is inflated when <code class="literal">MultiChoiceModeListener</code> calls <code class="literal">onCreateActionMode()</code>.</p><p>By default, Context Mode is initiated with a long press on an item in the <code class="literal">ListView</code>. We will go a step further by starting Contextual Mode when the item is checked using the <code class="literal">onItemClick()</code> event. If we don't do this, the only way to initiate the Contextual Mode would be with a long click, which may leave many users unaware of the additional functionality.</p></div><div><div><div><div><h2 class="title"><a id="ch04lvl2sec126"/>There's more...</h2></div></div></div><p>As mentioned in the introduction to this chapter, your activity does not need to include an Action Bar to use a Contextual Action Bar. If you do have an Action Bar and it's visible, it will be overlaid with the CAB. If you do not have an Action Bar as the default with this recipe, the layout will be redrawn to include the CAB (and redrawn again when the CAB is dismissed). If you want the Action Bar to be visible, either change the theme for the Activity or change the base class and set up the <code class="literal">ListView</code> manually.</p></div><div><div><div><div><h2 class="title"><a id="ch04lvl2sec127"/>See also</h2></div></div></div><div><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">For more information on the <code class="literal">ListView</code>, refer to <a class="link" href="ch02.html" title="Chapter 2. Layouts">Chapter 2</a>, <em>Layouts</em></li></ul></div></div></div>
<div><div><div><div><h1 class="title"><a id="ch04lvl1sec39"/>Creating a pop-up menu</h1></div></div></div><p>A pop-up menu<a id="id218" class="indexterm"/> is attached to a view similar to the dropdown on a spinner. The idea of a pop-up menu is to provide additional options to complete an action. A common example might be a <strong>Reply</strong> button in an e-mail app. When pressed, several reply options are shown, such as: <strong>Reply</strong>, <strong>Reply All</strong>, and <strong>Forward</strong>.</p><p>Here is an example of the pop-up menu from the recipe:</p><div><img src="img/B05057_04_03.jpg" alt="Creating a pop-up menu"/></div><p>Android will show the menu options below the anchor view if there is room; otherwise, it will show them above the view.</p><div><div><h3 class="title"><a id="tip13"/>Tip</h3><p>A pop-up menu is <em>not</em> meant to affect the view itself. That is the purpose of a Context Menu. Instead refer to the Floating Menu/Context Mode described in the <em>Enabling Contextual Action Mode for a view</em> recipe.</p></div></div><p>In this recipe, we will create the pop-up menu shown previously, using an <code class="literal">ImageButton</code> as the anchor view.</p><div><div><div><div><h2 class="title"><a id="ch04lvl2sec128"/>Getting ready</h2></div></div></div><p>Create a new<a id="id219" class="indexterm"/> project in Android Studio and call it <code class="literal">PopupMenu</code>. Use the default <strong>Phone &amp; Tablet </strong>option and select <strong>Empty Activity</strong> when prompted to add an Activity. As before, create a menu directory (<code class="literal">res/menu</code>) to store the menu XML.</p></div><div><div><div><div><h2 class="title"><a id="ch04lvl2sec129"/>How to do it...</h2></div></div></div><p>We start by creating the XML menu to inflate on the button press. After inflating the pop-up menu, we call <code class="literal">setOnMenuItemClickListener()</code> by passing in the callback to handle the menu item selection. Here are the steps:</p><div><ol class="orderedlist arabic"><li class="listitem">Add the following strings to <code class="literal">strings.xml</code>:<div><pre class="programlisting">&lt;string name="menu_reply"&gt;Reply&lt;/string&gt;
&lt;string name="menu_reply_all"&gt;Reply All&lt;/string&gt;
&lt;string name="menu_forward"&gt;Forward&lt;/string&gt;</pre></div></li><li class="listitem">Create a new file in the <code class="literal">res/menu</code> directory called <code class="literal">menu_popup.xml</code> using the following XML:<div><pre class="programlisting">&lt;?xml version="1.0" encoding="utf-8"?&gt;
&lt;menu
    
    &gt;
    &lt;item android:id="@+id/menu_reply
        android:title="@string/menu_reply" /&gt;
    &lt;item android:id="@+id/menu_reply_all
        android:title="@string/menu_reply_all" /&gt;
    &lt;item android:id="@+id/menu_forward
        android:title="@string/menu_forward" /&gt;
&lt;/menu&gt;</pre></div></li><li class="listitem">Create an <code class="literal">ImageButton</code> in <code class="literal">activity_main.xml</code> to provide the anchor view for the pop-up menu. Create it as shown in the following XML code:<div><pre class="programlisting">&lt;ImageButton
    android:id="@+id/imageButtonReply"
    android:layout_width="wrap_content"
    android:layout_height="wrap_content"
    android:layout_centerVertical="true"
    android:layout_centerHorizontal="true"
    android:src="img/ic_menu_revert"
    android:onClick="showPopupMenu"/&gt;</pre></div></li><li class="listitem">Open <code class="literal">MainActivity.java</code> and add the following <code class="literal">OnMenuItemClickListener</code> below the class constructor:<div><pre class="programlisting">private PopupMenu.OnMenuItemClickListener mOnMenuItemClickListener = new PopupMenu.OnMenuItemClickListener() {
    @Override
    public boolean onMenuItemClick(MenuItem item) {
        // Handle menu selections
        switch (item.getItemId()) {
            case R.id.menu_reply
                Toast.makeText(MainActivity.this, "Reply", Toast.LENGTH_SHORT).show();
                return true;
            case R.id.menu_reply_all
                Toast.makeText(MainActivity.this,"Reply All",Toast.LENGTH_SHORT).show();
                return true;
            case R.id.menu_forward
                Toast.makeText(MainActivity.this, "Forward", Toast.LENGTH_SHORT).show();
                return true;
            default:
                return false;
        }
    }
};</pre></div></li><li class="listitem">The final <a id="id220" class="indexterm"/>code is to handle the button <code class="literal">onClick()</code> event, as follows:<div><pre class="programlisting">public void showPopupMenu(View view) {
    PopupMenu popupMenu = new PopupMenu(MainActivity.this,view);
    popupMenu.inflate(R.menu.menu_popup);
    popupMenu.setOnMenuItemClickListener(mOnMenuItemClickListener);
    popupMenu.show();
}</pre></div></li><li class="listitem">Run the program on a device or emulator to see the pop-up menu.</li></ol></div></div><div><div><div><div><h2 class="title"><a id="ch04lvl2sec130"/>How it works...</h2></div></div></div><p>If you have read the previous menu recipes, this will probably look very familiar. Basically, we just inflate a pop-up menu when the <code class="literal">ImageButton</code> is pressed. We set up a menu item listener to respond to the menu selection.</p><p>The key is to understand each of the menu options available in Android so you can use the correct menu type for a given scenario. This will help your application by providing a consistent user experience and<a id="id221" class="indexterm"/> reducing the learning curve.</p></div></div></body></html>